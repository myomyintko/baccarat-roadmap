window.Laya=function(e){"use strict";class ClassUtils{static regClass(e,t){ClassUtils._classMap[e]=t}static getClass(e){return ClassUtils._classMap[e]}static getInstance(e){var t=ClassUtils.getClass(e);return t?new t:(console.warn("[error] Undefined class:",e),null)}}function dummy(){}ClassUtils._classMap={};class Config{}Config.isAntialias=!0,Config.useWebGL2=!0,Config.FPS=60,Config.useRetinalCanvas=!1,Config.animationInterval=50,Config.webGL2D_MeshAllocMaxMem=!0,Config.defaultFontSize=12,Config.defaultFont="Arial",Config.isAlpha=!1,Config.isDepth=!1,Config.isfailIfMajorPerformanceCaveat=!1,Config.powerPreference="default",Config.premultipliedAlpha=!0,Config.isStencil=!1,Config.preserveDrawingBuffer=!1,Config.printWebglOrder=!1,Config.fontFamilyMap={"报隶":"报隶-简","黑体":"黑体-简","楷体":"楷体-简","兰亭黑":"兰亭黑-简","隶变":"隶变-简","凌慧体":"凌慧体-简","翩翩体":"翩翩体-简","苹方":"苹方-简","手札体":"手札体-简","宋体":"宋体-简","娃娃体":"娃娃体-简","魏碑":"魏碑-简","行楷":"行楷-简","雅痞":"雅痞-简","圆体":"圆体-简"},Config.fixedFrames=!0,Config.destroyResourceImmediatelyDefault=!0,Config._enableWindowRAFFunction=!0;class Const{}Const.ENUM_TEXTALIGN_DEFAULT=0,Const.ENUM_TEXTALIGN_CENTER=1,Const.ENUM_TEXTALIGN_RIGHT=2,Const.BYTES_PE=4,Const.BYTES_PIDX=2,Const.MAX_CLIP_SIZE=99999999;class NodeFlags{}NodeFlags.NOT_ACTIVE=1,NodeFlags.ACTIVE_INHIERARCHY=2,NodeFlags.AWAKED=4,NodeFlags.NOT_READY=8,NodeFlags.DISPLAY=16,NodeFlags.HAS_ZORDER=32,NodeFlags.HAS_MOUSE=64,NodeFlags.DISPLAYED_INSTAGE=128,NodeFlags.DRAWCALL_OPTIMIZE=256,NodeFlags.PROCESS_COLLISIONS=512,NodeFlags.PROCESS_TRIGGERS=1024,NodeFlags.HAS_SCRIPT=2048,NodeFlags.ESCAPE_DRAWING_TO_TEXTURE=4096,NodeFlags.DISABLE_INNER_CLIPPING=8192,NodeFlags.DISABLE_OUTER_CLIPPING=16384,NodeFlags.DISABLE_VISIBILITY=32768,NodeFlags.EDITING_NODE=65536,NodeFlags.HIDE_BY_EDITOR=131072,NodeFlags.LOCK_BY_EDITOR=262144;class HideFlags{}HideFlags.HideInHierarchy=1,HideFlags.HideInInspector=2,HideFlags.DontSave=4,HideFlags.HideAndDontSave=7;class ILaya{}ILaya.Loader=null,ILaya.Context=null,ILaya.Browser=null,ILaya.Laya=null,ILaya.loader=null,ILaya.timer=null,ILaya.systemTimer=null,ILaya.physicsTimer=null,ILaya.stage=null;class LayaEnv{}LayaEnv.version="3.1.3",LayaEnv.isPlaying=!0,LayaEnv.isPreview=!1,LayaEnv.isConch=null!=window.conch;class Pool{static getPoolBySign(e){return Pool._poolDic[e]||(Pool._poolDic[e]=[])}static clearBySign(e){Pool._poolDic[e]&&(Pool._poolDic[e].length=0)}static recover(e,t){!1===t[Pool.POOLSIGN]&&(t[Pool.POOLSIGN]=!0,Pool.getPoolBySign(e).push(t))}static recoverByClass(e){if(e){var t=e.__className||e.constructor._$gid;t&&Pool.recover(t,e)}}static _getClassSign(e){var t=e.__className||e._$gid;return t||(e._$gid=t=Pool._CLSID+"",Pool._CLSID++),t}static createByClass(e){return Pool.getItemByClass(Pool._getClassSign(e),e)}static getItemByClass(e,t){let r,a=Pool.getPoolBySign(e);return r=a.length?a.pop():new t,r[Pool.POOLSIGN]=!1,r}static getItemByCreateFun(e,t,r=null){var a=Pool.getPoolBySign(e),i=a.length?a.pop():t.call(r);return i[Pool.POOLSIGN]=!1,i}static getItem(e){var t=Pool.getPoolBySign(e),r=t.length?t.pop():null;return r&&(r[Pool.POOLSIGN]=!1),r}}Pool._CLSID=0,Pool.POOLSIGN="__InPool",Pool._poolDic={};var t=1;const r=180/Math.PI,a=Math.PI/180;class Utils{static toRadian(e){return e*a}static toAngle(e){return e*r}static toHexColor(e){if(e<0||isNaN(e))return null;for(var t=e.toString(16);t.length<6;)t="0"+t;return"#"+t}static fromStringColor(e){if(!e)return 0;if(e.indexOf("rgba(")>=0||e.indexOf("rgb(")>=0){let t=e.indexOf("("),r=e.indexOf(")");if(-1==t||-1==r)return 0;let a=(e=e.substring(t+1,r)).split(","),i=a.length;for(let e=0;e<i;e++)a[e]=parseFloat(a[e]),isNaN(a[e])&&(a[e]=0);return 4==a.length?(a[0]<<24)+(a[1]<<16)+(a[2]<<8)+Math.round(255*a[3]):(a[0]<<16)+(a[1]<<8)+a[2]}{"#"===e.charAt(0)&&(e=e.substring(1));let t=e.length;if(3===t||4===t){let r="";for(let a=0;a<t;a++)r+=e[a]+e[a];e=r}return parseInt(e,16)}}static getGID(){return t++}static copyArray(e,t){if(e||(e=[]),!t)return e;e.length=t.length;var r=t.length;for(let a=0;a<r;a++)e[a]=t[a];return e}static transPointList(e,t,r){var a,i=e.length;for(a=0;a<i;a+=2)e[a]+=t,e[a+1]+=r}static parseInt(e,t=0){var r=parseInt(e,t);return isNaN(r)?0:r}static getBaseName(e){let t=e.lastIndexOf("/");return-1!=t&&(e=e.substring(t+1)),t=e.indexOf("?"),-1!=t&&(e=e.substring(0,t)),e}static getFileExtension(e){let t=e.lastIndexOf(".");if(-1!=t){let r=e.substring(t+1).toLowerCase(),a=r.indexOf("?");if(-1!=a&&(r=r.substring(0,a)),"ls"===r){let a=e.lastIndexOf(".",t-1);if(-1!=a){let i=e.substring(a+1,t+1)+r;if("lanit.ls"===i||"ltcb.ls"===i)return i}}return r}return""}static replaceFileExtension(e,t,r){if(!e)return e;let a=e.lastIndexOf(".");if(t.length>0&&!r&&(t="."+t),-1!=a){let r=e.indexOf("?",a);return-1!=r?e.substring(0,a)+t+e.substring(r):e.substring(0,a)+t}return e+t}}class Component{get hideFlags(){return this._hideFlags}set hideFlags(e){this._hideFlags=e}constructor(){this._hideFlags=0,this._status=0,this._enabled=!0,this._singleton=!0,this._id=Utils.getGID(),this._initialize()}_initialize(){this._extra={}}hasHideFlag(e){return 0!=(this._hideFlags&e)}get id(){return this._id}get enabled(){return this._enabled}set enabled(e){this._enabled!=e&&(this._enabled=e,this.owner&&this._setActive(e&&this.owner.activeInHierarchy))}get awaked(){return this._status>0}get destroyed(){return 4==this._status}_isScript(){return!1}_resetComp(){this._enabled=!0,this._status=0,this._enableState=!1,this.owner=null}_setOwner(e){if(0!=this._status)throw"reuse a destroyed component";this.owner=e,this._isScript()&&e._setBit(NodeFlags.HAS_SCRIPT,!0),this._onAdded(),this.onAdded()}_onAdded(){}_onAwake(){}_onEnable(){this.onEnable()}_onDisable(){this.onDisable()}_onDestroy(){}_parse(e,t=null){}_parseInteractive(e=null,t=null){}_cloneTo(e){}_setActive(e){var t,r;if(e){if(0==this._status&&(this._status=1,(LayaEnv.isPlaying||this.runInEditor)&&(this._onAwake(),this.onAwake())),this._enabled&&!this._enableState&&(this._enableState=!0,LayaEnv.isPlaying||this.runInEditor)){((null===(t=this.owner._is3D&&this.owner._scene)||void 0===t?void 0:t._componentDriver)||ILaya.stage._componentDriver).add(this),LayaEnv.isPlaying&&this._isScript()&&this.setupScript(),this._onEnable()}}else if(this._enableState&&(this._enableState=!1,LayaEnv.isPlaying||this.runInEditor)){((null===(r=this.owner._is3D&&this.owner._scene)||void 0===r?void 0:r._componentDriver)||ILaya.stage._componentDriver).remove(this),ILaya.stage.offAllCaller(this),this._onDisable()}}setupScript(){}destroy(){4!=this._status&&(this.owner?this.owner._destroyComponent(this):this.destroyed||this._destroy(!0))}_destroy(e){var t;if(e)(LayaEnv.isPlaying||this.runInEditor)&&(this._onDestroy(),this.onDestroy(),this.onReset&&(this.onReset(),this._resetComp(),Pool.recoverByClass(this)));else if(this._setActive(!1),this._status=4,LayaEnv.isPlaying||this.runInEditor){((null===(t=this.owner._is3D&&this.owner._scene)||void 0===t?void 0:t._componentDriver)||ILaya.stage._componentDriver)._toDestroys.add(this)}}onAdded(){}onAwake(){}onEnable(){}onDisable(){}onDestroy(){}}class Matrix{constructor(e=1,t=0,r=0,a=1,i=0,s=0,n=0){if(this._bTransform=!1,null!=Matrix._createFun)return Matrix._createFun(e,t,r,a,i,s,n);this.a=e,this.b=t,this.c=r,this.d=a,this.tx=i,this.ty=s,this._checkTransform()}identity(){return this.a=this.d=1,this.b=this.tx=this.ty=this.c=0,this._bTransform=!1,this}_checkTransform(){return this._bTransform=1!==this.a||0!==this.b||0!==this.c||1!==this.d}setTranslate(e,t){return this.tx=e,this.ty=t,this}translate(e,t){return this.tx+=e,this.ty+=t,this}scale(e,t){return this.a*=e,this.d*=t,this.c*=e,this.b*=t,this.tx*=e,this.ty*=t,this._bTransform=!0,this}rotate(e){var t=Math.cos(e),r=Math.sin(e),a=this.a,i=this.c,s=this.tx;return this.a=a*t-this.b*r,this.b=a*r+this.b*t,this.c=i*t-this.d*r,this.d=i*r+this.d*t,this.tx=s*t-this.ty*r,this.ty=s*r+this.ty*t,this._bTransform=!0,this}skew(e,t){var r=Math.tan(e),a=Math.tan(t),i=this.a,s=this.b;return this.a+=a*this.c,this.b+=a*this.d,this.c+=r*i,this.d+=r*s,this}invertTransformPoint(e){var t=this.a,r=this.b,a=this.c,i=this.d,s=this.tx,n=t*i-r*a,o=i/n,l=-r/n,h=-a/n,u=t/n,d=(a*this.ty-i*s)/n,_=-(t*this.ty-r*s)/n;return e.setTo(o*e.x+h*e.y+d,l*e.x+u*e.y+_)}transformPoint(e){return e.setTo(this.a*e.x+this.c*e.y+this.tx,this.b*e.x+this.d*e.y+this.ty)}transformPointN(e){return e.setTo(this.a*e.x+this.c*e.y,this.b*e.x+this.d*e.y)}getScaleX(){return 0===this.b?this.a:Math.sqrt(this.a*this.a+this.b*this.b)}getScaleY(){return 0===this.c?this.d:Math.sqrt(this.c*this.c+this.d*this.d)}invert(){var e=this.a,t=this.b,r=this.c,a=this.d,i=this.tx,s=e*a-t*r;return this.a=a/s,this.b=-t/s,this.c=-r/s,this.d=e/s,this.tx=(r*this.ty-a*i)/s,this.ty=-(e*this.ty-t*i)/s,this}setTo(e,t,r,a,i,s){return this.a=e,this.b=t,this.c=r,this.d=a,this.tx=i,this.ty=s,this}concat(e){var t=this.a,r=this.c,a=this.tx;return this.a=t*e.a+this.b*e.c,this.b=t*e.b+this.b*e.d,this.c=r*e.a+this.d*e.c,this.d=r*e.b+this.d*e.d,this.tx=a*e.a+this.ty*e.c+e.tx,this.ty=a*e.b+this.ty*e.d+e.ty,this}static mul(e,t,r){var a=e.a,i=e.b,s=e.c,n=e.d,o=e.tx,l=e.ty,h=t.a,u=t.b,d=t.c,_=t.d,c=t.tx,p=t.ty;return 0!==u||0!==d?(r.a=a*h+i*d,r.b=a*u+i*_,r.c=s*h+n*d,r.d=s*u+n*_,r.tx=h*o+d*l+c,r.ty=u*o+_*l+p):(r.a=a*h,r.b=i*_,r.c=s*h,r.d=n*_,r.tx=h*o+c,r.ty=_*l+p),r}static mul16(e,t,r){var a=e.a,i=e.b,s=e.c,n=e.d,o=e.tx,l=e.ty,h=t.a,u=t.b,d=t.c,_=t.d,c=t.tx,p=t.ty;return 0!==u||0!==d?(r[0]=a*h+i*d,r[1]=a*u+i*_,r[4]=s*h+n*d,r[5]=s*u+n*_,r[12]=h*o+d*l+c,r[13]=u*o+_*l+p):(r[0]=a*h,r[1]=i*_,r[4]=s*h,r[5]=n*_,r[12]=h*o+c,r[13]=_*l+p),r}scaleEx(e,t){var r=this.a,a=this.b,i=this.c,s=this.d;0!==a||0!==i?(this.a=e*r,this.b=e*a,this.c=t*i,this.d=t*s):(this.a=e*r,this.b=0*s,this.c=0*r,this.d=t*s),this._bTransform=!0}rotateEx(e){var t=Math.cos(e),r=Math.sin(e),a=this.a,i=this.b,s=this.c,n=this.d;0!==i||0!==s?(this.a=t*a+r*s,this.b=t*i+r*n,this.c=-r*a+t*s,this.d=-r*i+t*n):(this.a=t*a,this.b=r*n,this.c=-r*a,this.d=t*n),this._bTransform=!0}clone(){var e=Matrix.create();return e.a=this.a,e.b=this.b,e.c=this.c,e.d=this.d,e.tx=this.tx,e.ty=this.ty,e._bTransform=this._bTransform,e}copyTo(e){return e.a=this.a,e.b=this.b,e.c=this.c,e.d=this.d,e.tx=this.tx,e.ty=this.ty,e._bTransform=this._bTransform,e}toString(){return this.a+","+this.b+","+this.c+","+this.d+","+this.tx+","+this.ty}destroy(){this.recover()}recover(){Pool.recover("Matrix",this.identity())}static create(){return Pool.getItemByClass("Matrix",Matrix)}}Matrix.EMPTY=new Matrix,Matrix.TEMP=new Matrix,Matrix._createFun=null;class Point{constructor(e=0,t=0){this.x=e,this.y=t}static create(){return Pool.getItemByClass("Point",Point)}setTo(e,t){return this.x=e,this.y=t,this}reset(){return this.x=this.y=0,this}recover(){Pool.recover("Point",this.reset())}distance(e,t){return Math.sqrt((this.x-e)*(this.x-e)+(this.y-t)*(this.y-t))}toString(){return this.x+","+this.y}normalize(){var e=Math.sqrt(this.x*this.x+this.y*this.y);if(e>0){var t=1/e;this.x*=t,this.y*=t}}copy(e){return this.setTo(e.x,e.y)}}Point.TEMP=new Point,Point.EMPTY=new Point;class Rectangle{constructor(e=0,t=0,r=0,a=0){this.x=e,this.y=t,this.width=r,this.height=a}get right(){return this.x+this.width}get bottom(){return this.y+this.height}setTo(e,t,r,a){return this.x=e,this.y=t,this.width=r,this.height=a,this}reset(){return this.x=this.y=this.width=this.height=0,this}recover(){this!=Rectangle.TEMP&&this!=Rectangle.EMPTY&&Pool.recover("Rectangle",this.reset())}static create(){return Pool.getItemByClass("Rectangle",Rectangle)}copyFrom(e){return this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this}contains(e,t){return!(this.width<=0||this.height<=0)&&(e>=this.x&&e<this.right&&t>=this.y&&t<this.bottom)}intersects(e){return!(e.x>this.x+this.width||e.x+e.width<this.x||e.y>this.y+this.height||e.y+e.height<this.y)}intersection(e,t=null){return this.intersects(e)?(t||(t=new Rectangle),t.x=Math.max(this.x,e.x),t.y=Math.max(this.y,e.y),t.width=Math.min(this.right,e.right)-t.x,t.height=Math.min(this.bottom,e.bottom)-t.y,t):null}union(e,t=null){return t||(t=new Rectangle),this.clone(t),e.width<=0||e.height<=0?t:(t.addPoint(e.x,e.y),t.addPoint(e.right,e.bottom),this)}clone(e=null){return e||(e=new Rectangle),e.x=this.x,e.y=this.y,e.width=this.width,e.height=this.height,e}toString(){return this.x+","+this.y+","+this.width+","+this.height}equals(e){return!(!e||e.x!==this.x||e.y!==this.y||e.width!==this.width||e.height!==this.height)}addPoint(e,t){return this.x>e&&(this.width+=this.x-e,this.x=e),this.y>t&&(this.height+=this.y-t,this.y=t),this.width<e-this.x&&(this.width=e-this.x),this.height<t-this.y&&(this.height=t-this.y),this}_getBoundPoints(){var e=Rectangle._temB;return e.length=0,0==this.width||0==this.height||e.push(this.x,this.y,this.x+this.width,this.y,this.x,this.y+this.height,this.x+this.width,this.y+this.height),e}static _getBoundPointS(e,t,r,a,i){var s=Rectangle._temA;return s.length=0,0==r||0==a||(i&&(e*=i.width,t*=i.height,r*=i.width,a*=i.height),s.push(e,t,e+r,t,e,t+a,e+r,t+a)),s}static _getWrapRec(e,t=null){if(!e||e.length<1)return t?t.setTo(0,0,0,0):Rectangle.TEMP.setTo(0,0,0,0);t=t||Rectangle.create();var r,a,i,s,n,o=e.length,l=Point.TEMP;for(i=n=-(a=s=99999),r=0;r<o;r+=2)l.x=e[r],l.y=e[r+1],a=a<l.x?a:l.x,s=s<l.y?s:l.y,i=i>l.x?i:l.x,n=n>l.y?n:l.y;return t.setTo(a,s,i-a,n-s)}isEmpty(){return this.width<=0||this.height<=0}}var i,s;Rectangle.EMPTY=new Rectangle,Rectangle.TEMP=new Rectangle,Rectangle._temB=[],Rectangle._temA=[],e.HDREncodeFormat=void 0,(i=e.HDREncodeFormat||(e.HDREncodeFormat={}))[i.NONE=0]="NONE",i[i.RGBM=1]="RGBM",i[i.RGBD=2]="RGBD",e.TextureFormat=void 0,(s=e.TextureFormat||(e.TextureFormat={}))[s.R8G8B8=0]="R8G8B8",s[s.R8G8B8A8=1]="R8G8B8A8",s[s.R5G6B5=16]="R5G6B5",s[s.Alpha8=2]="Alpha8",s[s.DXT1=3]="DXT1",s[s.DXT3=29]="DXT3",s[s.DXT5=4]="DXT5",s[s.ETC1RGB=5]="ETC1RGB",s[s.ETC2RGB=6]="ETC2RGB",s[s.ETC2RGBA=7]="ETC2RGBA",s[s.ETC2SRGB_Alpha8=8]="ETC2SRGB_Alpha8",s[s.ETC2SRGB=28]="ETC2SRGB",s[s.PVRTCRGB_2BPPV=9]="PVRTCRGB_2BPPV",s[s.PVRTCRGBA_2BPPV=10]="PVRTCRGBA_2BPPV",s[s.PVRTCRGB_4BPPV=11]="PVRTCRGB_4BPPV",s[s.PVRTCRGBA_4BPPV=12]="PVRTCRGBA_4BPPV",s[s.R32G32B32A32=15]="R32G32B32A32",s[s.R32G32B32=30]="R32G32B32",s[s.R16G16B16A16=17]="R16G16B16A16",s[s.R16G16B16=31]="R16G16B16",s[s.ASTC4x4=18]="ASTC4x4",s[s.ASTC4x4SRGB=23]="ASTC4x4SRGB",s[s.ASTC6x6=19]="ASTC6x6",s[s.ASTC6x6SRGB=24]="ASTC6x6SRGB",s[s.ASTC8x8=20]="ASTC8x8",s[s.ASTC8x8SRGB=25]="ASTC8x8SRGB",s[s.ASTC10x10=21]="ASTC10x10",s[s.ASTC10x10SRGB=26]="ASTC10x10SRGB",s[s.ASTC12x12=22]="ASTC12x12",s[s.ASTC12x12SRGB=27]="ASTC12x12SRGB",s[s.KTXTEXTURE=-1]="KTXTEXTURE",s[s.PVRTEXTURE=-2]="PVRTEXTURE";class LayaGL{}class Delegate{constructor(){this._flag=0,this._items=[]}add(e,t,r){let a=this._items,i=a.findIndex(((r,a,i)=>r==e&&i[a+1]==t));-1!=i?(a[i+2]=r,a[i+3]=1):a.push(e,t,r,1)}once(e,t,r){let a=this._items,i=a.findIndex(((r,a,i)=>r==e&&i[a+1]==t));-1!=i?(a[i+2]=r,a[i+3]=2):a.push(e,t,r,2)}remove(e,t){let r=this._items,a=r.findIndex(((r,a,i)=>r==e&&i[a+1]==t));-1!=a&&(0!=this._flag?(r[a+3]=0,this._flag=2):r.splice(a,4))}clear(){let e=this._items;0!=this._flag?(e.forEach(((e,t,r)=>{t%4==3&&(r[t]=0)})),this._flag=2):e.length=0}clearForTarget(e){if(!e)return;let t=this._items;if(0!=this._flag)t.forEach(((t,r,a)=>{r%4==1&&a[r]==e&&(a[r+2]=0)})),this._flag=2;else{let r=t.length-4;for(;r>=0;)t[r+1]==e&&t.splice(r,4),r-=4}}get count(){return this._items.length/4}invoke(...e){if(0!=this._flag)return;this._flag=1;let t=this._items,r=t.length;for(let a=0;a<r;a+=4){if(0==t[a+3])continue;let r=t[a+2];try{null!=r?t[a].call(t[a+1],...r,...e):t[a].call(t[a+1],...e)}catch(e){console.error(e)}2==t[a+3]&&(t[a+3]=0,this._flag=2)}if(2==this._flag){let e=t.length,r=0;for(;r<e;)0!=t[r+3]?r+=4:(t.splice(r,4),e-=4)}this._flag=0}}class Event{static isMouseEvent(e){return n.has(e)}constructor(){this.touchId=0,this.delta=0,this.button=0,this.touchPos=new Point}setTo(e,t,r){return this.type=e,this.currentTarget=t,this.target=r,this}stopPropagation(){this._stopped=!0}get touches(){return this._touches}get altKey(){var e;return null===(e=this.nativeEvent)||void 0===e?void 0:e.altKey}get ctrlKey(){var e;return null===(e=this.nativeEvent)||void 0===e?void 0:e.ctrlKey}get shiftKey(){var e;return null===(e=this.nativeEvent)||void 0===e?void 0:e.shiftKey}get metaKey(){var e;return null===(e=this.nativeEvent)||void 0===e?void 0:e.metaKey}get key(){return this.nativeEvent.key}get keyCode(){return this.nativeEvent.keyCode}get charCode(){var e;return null===(e=this.nativeEvent)||void 0===e?void 0:e.code}get keyLocation(){return this.nativeEvent?this.nativeEvent.location||this.nativeEvent.keyLocation:0}get stageX(){return this.touchPos.x}get stageY(){return this.touchPos.y}}Event.EMPTY=new Event,Event.MOUSE_DOWN="mousedown",Event.MOUSE_UP="mouseup",Event.RIGHT_MOUSE_DOWN="rightmousedown",Event.RIGHT_MOUSE_UP="rightmouseup",Event.CLICK="click",Event.RIGHT_CLICK="rightclick",Event.MOUSE_MOVE="mousemove",Event.MOUSE_OVER="mouseover",Event.MOUSE_OUT="mouseout",Event.MOUSE_WHEEL="mousewheel",Event.ROLL_OVER="mouseover",Event.ROLL_OUT="mouseout",Event.DOUBLE_CLICK="doubleclick",Event.MOUSE_DRAG="mousedrag",Event.MOUSE_DRAG_END="mousedragend",Event.DRAG_START="dragstart",Event.DRAG_MOVE="dragmove",Event.DRAG_END="dragend",Event.KEY_DOWN="keydown",Event.KEY_PRESS="keypress",Event.KEY_UP="keyup",Event.CHANGE="change",Event.CHANGED="changed",Event.WILL_RESIZE="willResize",Event.RESIZE="resize",Event.ADDED="added",Event.REMOVED="removed",Event.DISPLAY="display",Event.UNDISPLAY="undisplay",Event.ERROR="error",Event.COMPLETE="complete",Event.LOADED="loaded",Event.READY="ready",Event.PROGRESS="progress",Event.INPUT="input",Event.RENDER="render",Event.OPEN="open",Event.MESSAGE="message",Event.CLOSE="close",Event.FRAME="enterframe",Event.ENTER="enter",Event.SELECT="select",Event.BLUR="blur",Event.FOCUS="focus",Event.VISIBILITY_CHANGE="visibilitychange",Event.FOCUS_CHANGE="focuschange",Event.PLAYED="played",Event.PAUSED="paused",Event.STOPPED="stopped",Event.START="start",Event.END="end",Event.LINK="link",Event.LABEL="label",Event.FULL_SCREEN_CHANGE="fullscreenchange",Event.DEVICE_LOST="devicelost",Event.TRANSFORM_CHANGED="transformchanged",Event.LAYERCHANGE="layerChange",Event.staticMask="staticMask",Event.TRIGGER_ENTER="triggerenter",Event.TRIGGER_STAY="triggerstay",Event.TRIGGER_EXIT="triggerexit",Event.COLLISION_ENTER="collisionenter",Event.COLLISION_STAY="collisionstay",Event.COLLISION_EXIT="collisionexit",Event.JOINT_BREAK="jointbreak",Event._Add_Script="addscript";const n=new Set([Event.MOUSE_DOWN,Event.MOUSE_UP,Event.MOUSE_MOVE,Event.CLICK,Event.DOUBLE_CLICK,Event.RIGHT_CLICK,Event.RIGHT_MOUSE_DOWN,Event.RIGHT_MOUSE_UP,Event.MOUSE_OVER,Event.MOUSE_OUT,Event.MOUSE_WHEEL,Event.MOUSE_DRAG,Event.MOUSE_DRAG_END]),o=[];class EventDispatcher{onStartListeningToType(e){}hasListener(e){let t=this._events&&this._events[e];return!!t&&t.count>0}event(e,t){let r=this._events&&this._events[e];if(!r)return!1;let a=r.count>0;if(Array.isArray(t))r.invoke(...t);else if(void 0!==t)r.invoke(t);else if(t===Event.EMPTY){let t=o.length>0?o.pop():new Event;r.invoke(t.setTo(e,this,this)),t.target=t.currentTarget=null,o.push(t)}else r.invoke();return a}on(e,t,r,a){2==arguments.length&&(r=t,t=null),this._events||(this._events={});let i=this._events[e];return i||(this.onStartListeningToType(e),this._events[e]=i=new Delegate),i.add(r,t,a),this}once(e,t,r,a){2==arguments.length&&(r=t,t=null),this._events||(this._events={});let i=this._events[e];return i||(this.onStartListeningToType(e),this._events[e]=i=new Delegate),i.once(r,t,a),this}off(e,t,r){2==arguments.length&&(r=t,t=null);let a=this._events&&this._events[e];return a&&a.remove(r,t),this}offAll(e){if(null==e)this._events=null;else{let t=this._events&&this._events[e];t&&t.clear()}return this}offAllCaller(e){if(e&&this._events)for(let t in this._events)this._events[t].clearForTarget(e);return this}}var l,h,u=0,d=0,_=0;class Resource extends EventDispatcher{static get cpuMemory(){return Resource._cpuMemory}static get gpuMemory(){return Resource._gpuMemory}static _addCPUMemory(e){Resource._cpuMemory+=e}static _addGPUMemory(e){Resource._gpuMemory+=e}static _addMemory(e,t){Resource._cpuMemory+=e,Resource._gpuMemory+=t}static destroyUnusedResources(){d=0,_=0,ILaya.loader.loading?ILaya.timer.frameLoop(1,Resource,Resource._destroyUnusedResources):Resource._destroyUnusedResources(!0)}static _destroyUnusedResources(e){if(!e&&ILaya.loader.loading)return;ILaya.timer.clear(Resource,Resource._destroyUnusedResources);let t=0;for(let e in Resource._idResourcesMap){let r=Resource._idResourcesMap[e];r.lock||0!==r._referenceCount||(r.destroy(),t++)}Resource.DEBUG&&t>0&&console.debug(`destroyUnusedResources(${t})`),t>0&&_<5&&(_++,ILaya.timer.frameLoop(1,Resource,Resource._destroyUnusedResources))}get id(){return this._id}get cpuMemory(){return this._cpuMemory}get gpuMemory(){return this._gpuMemory}get destroyed(){return this._destroyed}get obsolute(){return this._obsolute}set obsolute(e){this._obsolute=e}get referenceCount(){return this._referenceCount}constructor(e){super(),this._cpuMemory=0,this._gpuMemory=0,this._id=0,this._referenceCount=0,this._id=++u,this._destroyed=!1,this._referenceCount=0,(null==e||e)&&(Resource._idResourcesMap[this._id]=this),this.lock=!1,this.destroyedImmediately=!0}_setCPUMemory(e){var t=e-this._cpuMemory;this._cpuMemory=e,Resource._addCPUMemory(t)}_setGPUMemory(e){var t=e-this._gpuMemory;this._gpuMemory=e,Resource._addGPUMemory(t)}_setCreateURL(e,t){this.url=e,this.uuid=t}isCreateFromURL(e){return this.uuid&&e.length===this.uuid.length+6&&e.endsWith(this.uuid)||this.url===e}_addReference(e=1){this._referenceCount+=e}_removeReference(e=1){this._referenceCount-=e,d>0&&this._referenceCount<=0&&!this.lock&&this.destroyedImmediately&&this.destroy()}_clearReference(){this._referenceCount=0}_recoverResource(){}_disposeResource(){}_activeResource(){}destroy(){this._destroyed||(this._destroyed=!0,this.lock=!1,d++,this._disposeResource(),d--,this.offAll(),delete Resource._idResourcesMap[this.id],this.url&&(Resource.DEBUG&&console.debug(`destroy ${Object.getPrototypeOf(this).constructor.name} ${this.url}`),ILaya.loader.clearRes(this.url,this)))}}Resource._idResourcesMap={},Resource._cpuMemory=0,Resource._gpuMemory=0,Resource.DEBUG=!1;class BaseTexture extends Resource{get width(){return this._width}set width(e){this._width=e}get height(){return this._height}set height(e){this._height=e}get dimension(){return this._dimension}get format(){return this._format}get mipmap(){return this._texture.mipmap}get mipmapCount(){return this._texture.mipmapCount}get anisoLevel(){return this._texture.anisoLevel}set anisoLevel(e){this._texture.anisoLevel=e}get filterMode(){return this._texture.filterMode}set filterMode(e){this._texture.filterMode=e}get wrapModeU(){return this._texture.wrapU}set wrapModeU(e){this._texture.wrapU=e}get wrapModeV(){return this._texture.wrapV}set wrapModeV(e){this._texture.wrapV=e}get wrapModeW(){return this._texture.wrapW}set wrapModeW(e){this._texture.wrapW=e}get compareMode(){return this._texture.compareMode}set compareMode(e){this._texture.compareMode=LayaGL.textureContext.setTextureCompareMode(this._texture,e)}get gammaCorrection(){return this._texture.gammaCorrection}set baseMipmapLevel(e){this._texture.baseMipmapLevel=e}get baseMipmapLevel(){return this._texture.baseMipmapLevel}set maxMipmapLevel(e){this._texture.maxMipmapLevel=e}get maxMipmapLevel(){return this._texture.maxMipmapLevel}get gammaSpace(){return this._texture.useSRGBLoad||this._texture.gammaCorrection>1}constructor(t,r,a){super(),this._gammaSpace=!1,this._width=t,this._height=r,this._format=a,this.destroyedImmediately=Config.destroyResourceImmediatelyDefault,this.hdrEncodeFormat=e.HDREncodeFormat.NONE}gpuCompressFormat(){switch(this._format){case e.TextureFormat.R8G8B8:case e.TextureFormat.R8G8B8A8:case e.TextureFormat.R16G16B16:case e.TextureFormat.R16G16B16A16:case e.TextureFormat.R32G32B32:case e.TextureFormat.R32G32B32A32:case e.TextureFormat.R5G6B5:case e.TextureFormat.Alpha8:return!1;case e.TextureFormat.DXT1:case e.TextureFormat.DXT3:case e.TextureFormat.DXT5:case e.TextureFormat.ETC1RGB:case e.TextureFormat.ETC2RGB:case e.TextureFormat.ETC2RGBA:case e.TextureFormat.ETC2SRGB_Alpha8:case e.TextureFormat.ETC2SRGB:case e.TextureFormat.PVRTCRGB_2BPPV:case e.TextureFormat.PVRTCRGBA_2BPPV:case e.TextureFormat.PVRTCRGB_4BPPV:case e.TextureFormat.PVRTCRGBA_4BPPV:case e.TextureFormat.ASTC4x4:case e.TextureFormat.ASTC4x4SRGB:case e.TextureFormat.ASTC6x6:case e.TextureFormat.ASTC6x6SRGB:case e.TextureFormat.ASTC8x8:case e.TextureFormat.ASTC8x8SRGB:case e.TextureFormat.ASTC10x10:case e.TextureFormat.ASTC10x10SRGB:case e.TextureFormat.ASTC12x12:case e.TextureFormat.ASTC12x12SRGB:return!0;default:return!1}}_getFormatByteCount(){switch(this._format){case e.TextureFormat.R8G8B8:return 3;case e.TextureFormat.R8G8B8A8:return 4;case e.TextureFormat.R5G6B5:case e.TextureFormat.Alpha8:return 1;case e.TextureFormat.R16G16B16A16:return 2;case e.TextureFormat.R32G32B32A32:return 4;default:throw"Texture2D: unknown format."}}_getSource(){return this._texture.resource}get defaultTexture(){throw"defaulte"}_disposeResource(){this._texture.dispose()}}class Byte{static getSystemEndian(){if(!Byte._sysEndian){var e=new ArrayBuffer(2);new DataView(e).setInt16(0,256,!0),Byte._sysEndian=256===new Int16Array(e)[0]?Byte.LITTLE_ENDIAN:Byte.BIG_ENDIAN}return Byte._sysEndian}constructor(e=null){this._xd_=!0,this._allocated_=8,this._pos_=0,this._length=0,e?(this._u8d_=new Uint8Array(e),this._d_=new DataView(this._u8d_.buffer),this._length=this._d_.byteLength):this._resizeBuffer(this._allocated_)}get buffer(){var e=this._d_.buffer;return e.byteLength===this._length?e:e.slice(0,this._length)}get endian(){return this._xd_?Byte.LITTLE_ENDIAN:Byte.BIG_ENDIAN}set endian(e){this._xd_=e===Byte.LITTLE_ENDIAN}set length(e){this._allocated_<e?this._resizeBuffer(this._allocated_=Math.floor(Math.max(e,2*this._allocated_))):this._allocated_>e&&this._resizeBuffer(this._allocated_=e),this._length=e}get length(){return this._length}_resizeBuffer(e){try{var t=new Uint8Array(e);null!=this._u8d_&&(this._u8d_.length<=e?t.set(this._u8d_):t.set(this._u8d_.subarray(0,e))),this._u8d_=t,this._d_=new DataView(t.buffer)}catch(t){throw"Invalid typed array length:"+e}}getString(){return this.readString()}readString(){return this._rUTF(this.getUint16())}getFloat32Array(e,t){return this.readFloat32Array(e,t)}readFloat32Array(e,t){var r=e+t;r=r>this._length?this._length:r;var a=new Float32Array(this._d_.buffer.slice(e,r));return this._pos_=r,a}getUint8Array(e,t){return this.readUint8Array(e,t)}readUint8Array(e,t){var r=e+t;r=r>this._length?this._length:r;var a=new Uint8Array(this._d_.buffer.slice(e,r));return this._pos_=r,a}getInt16Array(e,t){return this.readInt16Array(e,t)}readInt16Array(e,t){var r=e+t;r=r>this._length?this._length:r;var a=new Int16Array(this._d_.buffer.slice(e,r));return this._pos_=r,a}getFloat32(){return this.readFloat32()}readFloat32(){if(this._pos_+4>this._length)throw"getFloat32 error - Out of bounds";var e=this._d_.getFloat32(this._pos_,this._xd_);return this._pos_+=4,e}getFloat64(){return this.readFloat64()}readFloat64(){if(this._pos_+8>this._length)throw"getFloat64 error - Out of bounds";var e=this._d_.getFloat64(this._pos_,this._xd_);return this._pos_+=8,e}writeFloat32(e){this._ensureWrite(this._pos_+4),this._d_.setFloat32(this._pos_,e,this._xd_),this._pos_+=4}writeFloat64(e){this._ensureWrite(this._pos_+8),this._d_.setFloat64(this._pos_,e,this._xd_),this._pos_+=8}getInt32(){return this.readInt32()}readInt32(){if(this._pos_+4>this._length)throw"getInt32 error - Out of bounds";var e=this._d_.getInt32(this._pos_,this._xd_);return this._pos_+=4,e}getUint32(){return this.readUint32()}readUint32(){if(this._pos_+4>this._length)throw"getUint32 error - Out of bounds";var e=this._d_.getUint32(this._pos_,this._xd_);return this._pos_+=4,e}writeInt32(e){this._ensureWrite(this._pos_+4),this._d_.setInt32(this._pos_,e,this._xd_),this._pos_+=4}writeUint32(e){this._ensureWrite(this._pos_+4),this._d_.setUint32(this._pos_,e,this._xd_),this._pos_+=4}getInt16(){return this.readInt16()}readInt16(){if(this._pos_+2>this._length)throw"getInt16 error - Out of bounds";var e=this._d_.getInt16(this._pos_,this._xd_);return this._pos_+=2,e}getUint16(){return this.readUint16()}readUint16(){if(this._pos_+2>this._length)throw"getUint16 error - Out of bounds";var e=this._d_.getUint16(this._pos_,this._xd_);return this._pos_+=2,e}writeUint16(e){this._ensureWrite(this._pos_+2),this._d_.setUint16(this._pos_,e,this._xd_),this._pos_+=2}writeInt16(e){this._ensureWrite(this._pos_+2),this._d_.setInt16(this._pos_,e,this._xd_),this._pos_+=2}getUint8(){return this.readUint8()}readUint8(){if(this._pos_+1>this._length)throw"getUint8 error - Out of bounds";return this._u8d_[this._pos_++]}writeUint8(e){this._ensureWrite(this._pos_+1),this._d_.setUint8(this._pos_,e),this._pos_++}_getUInt8(e){return this._readUInt8(e)}_readUInt8(e){return this._d_.getUint8(e)}_getUint16(e){return this._readUint16(e)}_readUint16(e){return this._d_.getUint16(e,this._xd_)}_getMatrix(){return this._readMatrix()}_readMatrix(){return new Matrix(this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32(),this.getFloat32())}_rUTF(e){var t,r,a=this._pos_+e,i=String.fromCharCode,s=this._u8d_,n=[],o=0;for(n.length=1e3;this._pos_<a;)if((t=s[this._pos_++])<128)0!=t&&(n[o++]=i(t));else if(t<224)n[o++]=i((63&t)<<6|127&s[this._pos_++]);else if(t<240)r=s[this._pos_++],n[o++]=i((31&t)<<12|(127&r)<<6|127&s[this._pos_++]);else{const e=(15&t)<<18|(127&(r=s[this._pos_++]))<<12|(127&s[this._pos_++])<<6|127&s[this._pos_++];if(e>=65536){const t=e-65536,r=55296|t>>10,a=56320|1023&t;n[o++]=i(r),n[o++]=i(a)}else n[o++]=i(e)}return n.length=o,n.join("")}getCustomString(e){return this.readCustomString(e)}readCustomString(e){for(var t,r="",a=0,i=String.fromCharCode,s=this._u8d_;e>0;)if((t=s[this._pos_])<128)r+=i(t),this._pos_++,e--;else for(a=t-128,this._pos_++,e-=a;a>0;)t=s[this._pos_++],r+=i(s[this._pos_++]<<8|t),a--;return r}get pos(){return this._pos_}set pos(e){this._pos_=e}get bytesAvailable(){return this._length-this._pos_}clear(){this._pos_=0,this.length=0}__getBuffer(){return this._d_.buffer}writeUTFBytes(e){for(var t=0,r=(e+="").length;t<r;t++){var a=e.charCodeAt(t);if(a<=127)this.writeByte(a);else if(a<=2047)this._ensureWrite(this._pos_+2),this._u8d_.set([192|a>>6,128|63&a],this._pos_),this._pos_+=2;else if(a>=55296&&a<=56319){t++;const r=e.charCodeAt(t);if(!Number.isNaN(r)&&r>=56320&&r<=57343){const e=64+(1023&a),t=1023&r,i=240|e>>8&63,s=128|e>>2&63,n=128|(3&e)<<4|t>>6&15,o=128|63&t;this._ensureWrite(this._pos_+4),this._u8d_.set([i,s,n,o],this._pos_),this._pos_+=4}}else a<=65535?(this._ensureWrite(this._pos_+3),this._u8d_.set([224|a>>12,128|a>>6&63,128|63&a],this._pos_),this._pos_+=3):(this._ensureWrite(this._pos_+4),this._u8d_.set([240|a>>18,128|a>>12&63,128|a>>6&63,128|63&a],this._pos_),this._pos_+=4)}}writeUTFString(e){var t=this.pos;this.writeUint16(1),this.writeUTFBytes(e);var r=this.pos-t-2;this._d_.setUint16(t,r,this._xd_)}writeUTFString32(e){var t=this.pos;this.writeUint32(1),this.writeUTFBytes(e);var r=this.pos-t-4;this._d_.setUint32(t,r,this._xd_)}readUTFString(){return this.readUTFBytes(this.getUint16())}readUTFString32(){return this.readUTFBytes(this.getUint32())}getUTFString(){return this.readUTFString()}readUTFBytes(e=-1){if(0===e)return"";var t=this.bytesAvailable;if(e>t)throw"readUTFBytes error - Out of bounds";return e=e>0?e:t,this._rUTF(e)}getUTFBytes(e=-1){return this.readUTFBytes(e)}writeByte(e){this._ensureWrite(this._pos_+1),this._d_.setInt8(this._pos_,e),this._pos_+=1}readByte(){if(this._pos_+1>this._length)throw"readByte error - Out of bounds";return this._d_.getInt8(this._pos_++)}getByte(){return this.readByte()}_ensureWrite(e){this._length<e&&(this._length=e),this._allocated_<e&&(this.length=e)}writeArrayBuffer(e,t=0,r=0){if(t<0||r<0)throw"writeArrayBuffer error - Out of bounds";0==r&&(r=e.byteLength-t),this._ensureWrite(this._pos_+r);var a=new Uint8Array(e);this._u8d_.set(a.subarray(t,t+r),this._pos_),this._pos_+=r}readArrayBuffer(e){var t;return t=this._u8d_.buffer.slice(this._pos_,this._pos_+e),this._pos_=this._pos_+e,t}}Byte.BIG_ENDIAN="bigEndian",Byte.LITTLE_ENDIAN="littleEndian",Byte._sysEndian=null;class HalfFloatUtils{static __init__(){for(var e=0;e<256;++e){var t=e-127;t<-27?(HalfFloatUtils._baseTable[0|e]=0,HalfFloatUtils._baseTable[256|e]=32768,HalfFloatUtils._shiftTable[0|e]=24,HalfFloatUtils._shiftTable[256|e]=24):t<-14?(HalfFloatUtils._baseTable[0|e]=1024>>-t-14,HalfFloatUtils._baseTable[256|e]=1024>>-t-14|32768,HalfFloatUtils._shiftTable[0|e]=-t-1,HalfFloatUtils._shiftTable[256|e]=-t-1):t<=15?(HalfFloatUtils._baseTable[0|e]=t+15<<10,HalfFloatUtils._baseTable[256|e]=t+15<<10|32768,HalfFloatUtils._shiftTable[0|e]=13,HalfFloatUtils._shiftTable[256|e]=13):t<128?(HalfFloatUtils._baseTable[0|e]=31744,HalfFloatUtils._baseTable[256|e]=64512,HalfFloatUtils._shiftTable[0|e]=24,HalfFloatUtils._shiftTable[256|e]=24):(HalfFloatUtils._baseTable[0|e]=31744,HalfFloatUtils._baseTable[256|e]=64512,HalfFloatUtils._shiftTable[0|e]=13,HalfFloatUtils._shiftTable[256|e]=13)}for(HalfFloatUtils._mantissaTable[0]=0,e=1;e<1024;++e){var r=e<<13;for(t=0;0==(8388608&r);)t-=8388608,r<<=1;r&=-8388609,t+=947912704,HalfFloatUtils._mantissaTable[e]=r|t}for(e=1024;e<2048;++e)HalfFloatUtils._mantissaTable[e]=939524096+(e-1024<<13);for(HalfFloatUtils._exponentTable[0]=0,e=1;e<31;++e)HalfFloatUtils._exponentTable[e]=e<<23;for(HalfFloatUtils._exponentTable[31]=1199570944,HalfFloatUtils._exponentTable[32]=2147483648,e=33;e<63;++e)HalfFloatUtils._exponentTable[e]=2147483648+(e-32<<23);for(HalfFloatUtils._exponentTable[63]=3347054592,HalfFloatUtils._offsetTable[0]=0,e=1;e<64;++e)HalfFloatUtils._offsetTable[e]=32===e?0:1024}static roundToFloat16Bits(e){HalfFloatUtils._floatView[0]=e;var t=HalfFloatUtils._uint32View[0],r=t>>23&511;return HalfFloatUtils._baseTable[r]+((8388607&t)>>HalfFloatUtils._shiftTable[r])}static convertToNumber(e){var t=e>>10;return HalfFloatUtils._uint32View[0]=HalfFloatUtils._mantissaTable[HalfFloatUtils._offsetTable[t]+(1023&e)]+HalfFloatUtils._exponentTable[t],HalfFloatUtils._floatView[0]}}HalfFloatUtils._buffer=new ArrayBuffer(4),HalfFloatUtils._floatView=new Float32Array(HalfFloatUtils._buffer),HalfFloatUtils._uint32View=new Uint32Array(HalfFloatUtils._buffer),HalfFloatUtils._baseTable=new Uint32Array(512),HalfFloatUtils._shiftTable=new Uint32Array(512),HalfFloatUtils._mantissaTable=new Uint32Array(2048),HalfFloatUtils._exponentTable=new Uint32Array(64),HalfFloatUtils._offsetTable=new Uint32Array(64),e.FilterMode=void 0,(l=e.FilterMode||(e.FilterMode={}))[l.Point=0]="Point",l[l.Bilinear=1]="Bilinear",l[l.Trilinear=2]="Trilinear",e.RenderCapable=void 0,(h=e.RenderCapable||(e.RenderCapable={}))[h.Element_Index_Uint32=0]="Element_Index_Uint32",h[h.TextureFormat_R32G32B32A32=1]="TextureFormat_R32G32B32A32",h[h.TextureFormat_R16G16B16A16=2]="TextureFormat_R16G16B16A16",h[h.Texture_anisotropic=3]="Texture_anisotropic",h[h.RenderTextureFormat_R16G16B16A16=4]="RenderTextureFormat_R16G16B16A16",h[h.RenderTextureFormat_R32G32B32A32=5]="RenderTextureFormat_R32G32B32A32",h[h.RenderTextureFormat_Depth=6]="RenderTextureFormat_Depth",h[h.RenderTextureFormat_ShadowMap=7]="RenderTextureFormat_ShadowMap",h[h.Vertex_VAO=8]="Vertex_VAO",h[h.DrawElement_Instance=9]="DrawElement_Instance",h[h.Shader_TextureLod=10]="Shader_TextureLod",h[h.COMPRESS_TEXTURE_S3TC=11]="COMPRESS_TEXTURE_S3TC",h[h.COMPRESS_TEXTURE_S3TC_SRGB=12]="COMPRESS_TEXTURE_S3TC_SRGB",h[h.COMPRESS_TEXTURE_PVRTC=13]="COMPRESS_TEXTURE_PVRTC",h[h.COMPRESS_TEXTURE_ETC1=14]="COMPRESS_TEXTURE_ETC1",h[h.COMPRESS_TEXTURE_ETC=15]="COMPRESS_TEXTURE_ETC",h[h.COMPRESS_TEXTURE_ASTC=16]="COMPRESS_TEXTURE_ASTC",h[h.Texture_SRGB=17]="Texture_SRGB",h[h.MSAA=18]="MSAA",h[h.UnifromBufferObject=19]="UnifromBufferObject",h[h.Texture3D=20]="Texture3D",h[h.Texture_FloatLinearFiltering=21]="Texture_FloatLinearFiltering",h[h.Texture_HalfFloatLinearFiltering=22]="Texture_HalfFloatLinearFiltering";const c=827611204,p=861165636,m=894720068,f=131072;class DDSTextureInfo{constructor(e,t,r,a,i,s,n,o,l,h){this.width=e,this.height=t,this.mipmapCount=r,this.isCube=a,this.blockBytes=s,this.dataOffset=n,this.format=o,this.source=h,this.bpp=i,this.compressed=l}static getDDSTextureInfo(t){let r=new Int32Array(t,0,31),a=r[4],i=r[3],s=1;131072&r[2]&&(s=Math.max(1,r[7]));let n=r[21],o=4==(4&r[20]),l=64==(64&r[20]),h=(r[20]&f)===f,u=512==(512&r[28]),d=n===c||n===p||n===m,_=e.TextureFormat.DXT1,g=r[1]+4,T=1;switch(n){case c:_=e.TextureFormat.DXT1,T=8;break;case p:_=e.TextureFormat.DXT3,T=16;break;case 877942852:case m:_=e.TextureFormat.DXT5,T=16;break;case 113:_=e.TextureFormat.R16G16B16A16,T=4;break;case 116:_=e.TextureFormat.R32G32B32A32,T=4;break;default:throw"Unsupported format "+(S=n,String.fromCharCode(255&S,S>>8&255,S>>16&255,S>>24&255))}var S;if(542327876!==r[0])throw"Invalid magic number in DDS header";if(!o&&!l&&!h)throw"Unsupported format, must contain a FourCC, RGB or LUMINANCE code";let x=LayaGL.renderEngine.getCapable(e.RenderCapable.COMPRESS_TEXTURE_S3TC)||LayaGL.renderEngine.getCapable(e.RenderCapable.COMPRESS_TEXTURE_S3TC_SRGB);if(d&&!x)throw"Compressed textures are not supported on this platform.";return new DDSTextureInfo(a,i,s,u,0,T,g,_,d,t)}}var g;e.TextureDimension=void 0,(g=e.TextureDimension||(e.TextureDimension={}))[g.Tex2D=0]="Tex2D",g[g.Cube=1]="Cube",g[g.Tex3D=2]="Tex3D",g[g.Texture2DArray=3]="Texture2DArray",g[g.CubeArray=4]="CubeArray",g[g.Unkonw=5]="Unkonw",g[g.None=6]="None";const T=6408,S=6407,x=5121;class KTXTextureInfo{static getLayaFormat(t,r,a,i){if(0!=t){if(t==T&&32856==r&&a==x)return{format:e.TextureFormat.R8G8B8A8,sRGB:!1};if(t==T&&35907==r&&a==x)return{format:e.TextureFormat.R8G8B8A8,sRGB:!0};if(t==T&&34836==r&&5126==a)return{format:e.TextureFormat.R32G32B32A32,sRGB:!1};if(t==T&&34842==r&&5131==a)return{format:e.TextureFormat.R16G16B16A16,sRGB:!1};if(t==S&&34837==r&&5126==a)return{format:e.TextureFormat.R32G32B32,sRGB:!1};if(t==S&&34843==r&&5131==a)return{format:e.TextureFormat.R16G16B16,sRGB:!1};if(t==S&&35905==r&&a==x)return{format:e.TextureFormat.R8G8B8,sRGB:!0};if(t==S&&32849==r&&a==x)return{format:e.TextureFormat.R8G8B8,sRGB:!1};throw"ktx: Unsupported UnCompressed image data."}switch(r){case 36196:return{format:e.TextureFormat.ETC1RGB,sRGB:!1};case 37496:return{format:e.TextureFormat.ETC2RGBA,sRGB:!1};case 37492:return{format:e.TextureFormat.ETC2RGB,sRGB:!1};case 37497:return{format:e.TextureFormat.ETC2SRGB_Alpha8,sRGB:!0};case 37493:return{format:e.TextureFormat.ETC2SRGB,sRGB:!0};case 37808:return{format:e.TextureFormat.ASTC4x4,sRGB:!1};case 37812:return{format:e.TextureFormat.ASTC6x6,sRGB:!1};case 37815:return{format:e.TextureFormat.ASTC8x8,sRGB:!1};case 37819:return{format:e.TextureFormat.ASTC10x10,sRGB:!1};case 37821:return{format:e.TextureFormat.ASTC12x12,sRGB:!1};case 37840:return{format:e.TextureFormat.ASTC4x4SRGB,sRGB:!0};case 37844:return{format:e.TextureFormat.ASTC6x6SRGB,sRGB:!0};case 37847:return{format:e.TextureFormat.ASTC8x8SRGB,sRGB:!0};case 37851:return{format:e.TextureFormat.ASTC10x10SRGB,sRGB:!0};case 37853:return{format:e.TextureFormat.ASTC12x12SRGB,sRGB:!0};default:throw"KTX: UnSupported Compressed format."}}static getKTXTextureInfo(e){let t=new Uint8Array(e,0,12);if(171===t[0]&&75===t[1]&&84===t[2]&&88===t[3]&&32===t[4]&&50===t[5]&&48===t[6]&&187===t[7]&&13===t[8]&&10===t[9]&&26===t[10]&&10===t[11])throw"ktx2 !";if(171===t[0]&&75===t[1]&&84===t[2]&&88===t[3]&&32===t[4]&&49===t[5]&&49===t[6]&&187===t[7]&&13===t[8]&&10===t[9]&&26===t[10]&&10===t[11])return KTXTextureInfo.createKTX1Info(e);throw"ktx data wrong, not ktx1 or ktx2 buffer!"}static createKTX1Info(t){let r=Uint32Array.BYTES_PER_ELEMENT,a=new DataView(t,12,13*r),i=67305985==a.getUint32(0,!0),s=a.getUint32(1*r,i),n=a.getUint32(2*r,i),o=a.getUint32(3*r,i),l=a.getUint32(4*r,i);a.getUint32(5*r,i);let h=a.getUint32(6*r,i),u=a.getUint32(7*r,i);a.getUint32(8*r,i);let d=a.getUint32(9*r,i),_=a.getUint32(10*r,i),c=a.getUint32(11*r,i),p=a.getUint32(12*r,i),m=KTXTextureInfo.getLayaFormat(o,l,s,n),f=m.format,g=m.sRGB,T=e.TextureDimension.Tex2D;_>1&&d>1?T=e.TextureDimension.CubeArray:_>1&&d<=1?T=e.TextureDimension.Cube:_<=1&&d>1&&(T=e.TextureDimension.Texture2DArray);return new KTXTextureInfo(t,0==o,g,T,h,u,f,c||1,p,64)}constructor(e,t,r,a,i,s,n,o,l,h){this.source=e,this.compress=t,this.sRGB=r,this.dimension=a,this.width=i,this.height=s,this.format=n,this.mipmapCount=o,this.bytesOfKeyValueData=l,this.headerOffset=h}}class Texture2D extends BaseTexture{static __init__(){var t=new Uint8Array(4);if(t[0]=128,t[1]=128,t[2]=128,t[3]=255,Texture2D.grayTexture=new Texture2D(1,1,e.TextureFormat.R8G8B8A8,!1,!1),Texture2D.grayTexture.setPixelsData(t,!1,!1),Texture2D.grayTexture.lock=!0,Texture2D.grayTexture.name="Default_Gray",t[0]=255,t[1]=255,t[2]=255,t[3]=255,Texture2D.whiteTexture=new Texture2D(1,1,e.TextureFormat.R8G8B8A8,!1,!1),Texture2D.whiteTexture.setPixelsData(t,!1,!1),Texture2D.whiteTexture.lock=!0,Texture2D.whiteTexture.name="Default_White",t[0]=0,t[1]=0,t[2]=0,t[3]=255,Texture2D.blackTexture=new Texture2D(1,1,e.TextureFormat.R8G8B8A8,!1,!1),Texture2D.blackTexture.setPixelsData(t,!1,!1),Texture2D.blackTexture.lock=!0,Texture2D.blackTexture.name="Default_Black",LayaGL.renderEngine.getCapable(e.RenderCapable.TextureFormat_R16G16B16A16)){let t=new Uint16Array(4);t[0]=14336,t[1]=14336,t[2]=15360,t[3]=15360,Texture2D.normalTexture=new Texture2D(1,1,e.TextureFormat.R16G16B16A16,!1,!1,!1),Texture2D.normalTexture.setPixelsData(t,!1,!1)}else t[0]=128,t[1]=128,t[2]=255,t[3]=255,Texture2D.normalTexture=new Texture2D(1,1,e.TextureFormat.R8G8B8A8,!1,!1,!1),Texture2D.normalTexture.setPixelsData(t,!1,!1);Texture2D.normalTexture.lock=!0,Texture2D.normalTexture.name="Default_Normal",Texture2D.errorTexture=Texture2D.whiteTexture}static _SimpleAnimatorTextureParse(t,r=null,a=null){var i,s,n=new Byte(t);switch(n.readUTFString()){case"LAYAANIMATORTEXTURE:0000":var o,l=n.readInt32(),h=n.readInt32();i=new Float32Array(l*l*4),s=new Float32Array(n.readArrayBuffer(4*h)),i.set(s,0),(o=new Texture2D(l,l,e.TextureFormat.R32G32B32A32,!1,!1)).setPixelsData(i,!1,!1),o.filterMode=e.FilterMode.Point;break;case"LAYACOMPRESSANIMATORTEXTURE:0000":l=n.readInt32(),h=n.readInt32();if(i=new Uint16Array(n.readArrayBuffer(2*h)),LayaGL.renderEngine.getCapable(e.RenderCapable.TextureFormat_R16G16B16A16))(s=new Uint16Array(l*l*4)).set(i,0),(o=new Texture2D(l,l,e.TextureFormat.R16G16B16A16,!1,!1)).setPixelsData(s,!1,!1),o.filterMode=e.FilterMode.Point;else{console.log("The platform does not support 16-bit floating-point textures"),LayaGL.renderEngine.getCapable(e.RenderCapable.TextureFormat_R32G32B32A32)||console.error("The platform does not support 32-bit floating-point textures"),s=new Float32Array(l*l*4);for(var u=0,d=i.length;u<d;u++)s[u]=HalfFloatUtils.convertToNumber(i[u]);(o=new Texture2D(l,l,e.TextureFormat.R32G32B32A32,!1,!1)).setPixelsData(s,!1,!1),o.filterMode=e.FilterMode.Point}break;default:throw"Laya3D:unknow version."}return o}static _parseImage(t,r=null,a=null){let i=a?a[2]:e.TextureFormat.R8G8B8A8,s=!a||a[3],n=!!a&&a[4],o=!!a&&a[5],l=!!r&&r.premultiplyAlpha,h=new Texture2D(t.width,t.height,i,s,n,o,l);return r?(h.setImageData(t,l,!1),h.setProperties(r)):h.setImageData(t,!1,!1),n&&(LayaEnv.isConch&&t._nativeObj?h._pixels=new Uint8Array(t._nativeObj.getImageData(0,0,t.width,t.height)):(ILaya.Browser.canvas.size(t.width,t.height),ILaya.Browser.canvas.clear(),ILaya.Browser.context.drawImage(t,0,0,t.width,t.height),h._pixels=new Uint8Array(ILaya.Browser.context.getImageData(0,0,t.width,t.height).data.buffer))),h}static _parseDDS(e,t=null,r=null){let a=DDSTextureInfo.getDDSTextureInfo(e),i=new Texture2D(a.width,a.height,a.format,a.mipmapCount>1,!1,!1);return i.setDDSData(a),t&&i.setProperties(t),i}static _parseKTX(e,t=null,r=null){let a=KTXTextureInfo.getKTXTextureInfo(e),i=new Texture2D(a.width,a.height,a.format,a.mipmapCount>1,!1,a.sRGB);return i.setKTXData(a),t&&i.setProperties(t),i}static _parsePVR(e,t=null,r=null){throw"pvr !"}static load(e,t){ILaya.loader.load(e,t,null,ILaya.Loader.TEXTURE2D)}constructor(t,r,a,i=!0,s,n=!1,o=!1){super(t,r,a),this._canRead=!1,this._dimension=e.TextureDimension.Tex2D,this._gammaSpace=n,this._canRead=s,this._texture=LayaGL.textureContext.createTextureInternal(this._dimension,t,r,a,i,n,o)}setImageData(e,t,r){let a=this._texture;LayaGL.textureContext.setTextureImageData(a,e,t,r)}setPixelsData(e,t,r){let a=this._texture;LayaGL.textureContext.setTexturePixelsData(a,e,t,r)}setSubPixelsData(e,t,r,a,i,s,n,o,l){let h=this._texture;LayaGL.textureContext.setTextureSubPixelsData(h,i,s,n,e,t,r,a,o,l)}setDDSData(e){let t=this._texture;LayaGL.textureContext.setTextureDDSData(t,e)}setKTXData(e){let t=this._texture;LayaGL.textureContext.setTextureKTXData(t,e)}setHDRData(e){let t=this._texture;LayaGL.textureContext.setTextureHDRData(t,e)}get defaultTexture(){return Texture2D.grayTexture}getPixels(){if(this._canRead&&this._pixels)return this._pixels;throw new Error("Texture2D: must set texture canRead is true.")}setProperties(e){e&&(null!=e.wrapModeU&&(this.wrapModeU=e.wrapModeU),null!=e.wrapModeV&&(this.wrapModeV=e.wrapModeV),null!=e.filterMode&&(this.filterMode=e.filterMode),null!=e.anisoLevel&&(this.anisoLevel=e.anisoLevel))}}Texture2D.TEXTURE2D="TEXTURE2D",Texture2D.grayTexture=null,Texture2D.whiteTexture=null,Texture2D.blackTexture=null,Texture2D.normalTexture=null,Texture2D.errorTexture=null;class BaseShader extends Resource{constructor(){super()}}class RenderState2D{static mat2MatArray(e,t){var r=e,a=t;return a[0]=r.a,a[1]=r.b,a[2]=RenderState2D.EMPTYMAT4_ARRAY[2],a[3]=RenderState2D.EMPTYMAT4_ARRAY[3],a[4]=r.c,a[5]=r.d,a[6]=RenderState2D.EMPTYMAT4_ARRAY[6],a[7]=RenderState2D.EMPTYMAT4_ARRAY[7],a[8]=RenderState2D.EMPTYMAT4_ARRAY[8],a[9]=RenderState2D.EMPTYMAT4_ARRAY[9],a[10]=RenderState2D.EMPTYMAT4_ARRAY[10],a[11]=RenderState2D.EMPTYMAT4_ARRAY[11],a[12]=r.tx,a[13]=r.ty,a[14]=RenderState2D.EMPTYMAT4_ARRAY[14],a[15]=RenderState2D.EMPTYMAT4_ARRAY[15],t}static restoreTempArray(){RenderState2D.TEMPMAT4_ARRAY[0]=1,RenderState2D.TEMPMAT4_ARRAY[1]=0,RenderState2D.TEMPMAT4_ARRAY[4]=0,RenderState2D.TEMPMAT4_ARRAY[5]=1,RenderState2D.TEMPMAT4_ARRAY[12]=0,RenderState2D.TEMPMAT4_ARRAY[13]=0}static clear(){RenderState2D.worldScissorTest=!1,RenderState2D.worldAlpha=1}}var y,E,R;RenderState2D._MAXSIZE=99999999,RenderState2D.EMPTYMAT4_ARRAY=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],RenderState2D.TEMPMAT4_ARRAY=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],RenderState2D.worldMatrix4=RenderState2D.TEMPMAT4_ARRAY,RenderState2D.worldMatrix=new Matrix,RenderState2D.matWVP=null,RenderState2D.worldAlpha=1,RenderState2D.worldScissorTest=!1,RenderState2D.width=0,RenderState2D.height=0,RenderState2D.InvertY=!1,e.RenderTargetFormat=void 0,(y=e.RenderTargetFormat||(e.RenderTargetFormat={}))[y.None=-1]="None",y[y.R8G8B8=0]="R8G8B8",y[y.R8G8B8A8=1]="R8G8B8A8",y[y.R16G16B16A16=17]="R16G16B16A16",y[y.R32G32B32=30]="R32G32B32",y[y.R32G32B32A32=15]="R32G32B32A32",y[y.R16G16B16=31]="R16G16B16",y[y.DEPTH_16=35]="DEPTH_16",y[y.STENCIL_8=36]="STENCIL_8",y[y.DEPTHSTENCIL_24_8=37]="DEPTHSTENCIL_24_8",y[y.DEPTH_32=38]="DEPTH_32",y[y.DEPTHSTENCIL_24_Plus=39]="DEPTHSTENCIL_24_Plus",e.RenderClearFlag=void 0,(E=e.RenderClearFlag||(e.RenderClearFlag={}))[E.Nothing=0]="Nothing",E[E.Color=1]="Color",E[E.Depth=2]="Depth",E[E.Stencil=4]="Stencil";class Color{static gammaToLinearSpace(e){return e<=.04045?e/12.92:e<1?Math.pow((e+.055)/1.055,2.4):Math.pow(e,2.4)}static linearToGammaSpace(e){return e<=0?0:e<=.0031308?12.92*e:e<=1?1.055*Math.pow(e,.41666)-.055:Math.pow(e,.41666)}constructor(e=1,t=1,r=1,a=1){this.r=e,this.g=t,this.b=r,this.a=a}equal(e){if(!e)return!1;const toFIxed=(e,t)=>{var r=1e-5;return-r<e-t&&e-t<r};return toFIxed(e.r,this.r)&&toFIxed(e.g,this.g)&&toFIxed(e.b,this.b)&&toFIxed(e.a,this.a)}toLinear(e){e.r=Color.gammaToLinearSpace(this.r),e.g=Color.gammaToLinearSpace(this.g),e.b=Color.gammaToLinearSpace(this.b),e.a=this.a}toGamma(e){e.r=Color.linearToGammaSpace(this.r),e.g=Color.linearToGammaSpace(this.g),e.b=Color.linearToGammaSpace(this.b),e.a=this.a}cloneTo(e){var t=e;t.r=this.r,t.g=this.g,t.b=this.b,t.a=this.a}scale(e){return this.r=this.r*e,this.g=this.g*e,this.b=this.b*e,this}setValue(e,t,r,a){this.r=e,this.g=t,this.b=r,this.a=a}fromArray(e,t=0){this.r=e[t+0],this.g=e[t+1],this.b=e[t+2],this.a=e[t+3]}toArray(){return[this.r,this.g,this.b,this.a]}clone(){var e=new Color;return this.cloneTo(e),e}}Color.RED=new Color(1,0,0,1),Color.GREEN=new Color(0,1,0,1),Color.BLUE=new Color(0,0,1,1),Color.CYAN=new Color(0,1,1,1),Color.YELLOW=new Color(1,.92,.016,1),Color.MAGENTA=new Color(1,0,1,1),Color.GRAY=new Color(.5,.5,.5,1),Color.WHITE=new Color(1,1,1,1),Color.BLACK=new Color(0,0,0,1),Color.CLEAR=new Color(0,0,0,0);class NativeRenderTexture2D extends BaseTexture{static get currentActive(){return NativeRenderTexture2D._currentActive}get depthStencilFormat(){return this._depthStencilFormat}get defaultTexture(){return Texture2D.grayTexture}getIsReady(){return!0}get sourceWidth(){return this._width}get sourceHeight(){return this._height}get offsetX(){return 0}get offsetY(){return 0}constructor(t,r,a=e.RenderTargetFormat.R8G8B8,i=e.RenderTargetFormat.DEPTH_16,s=!0){super(t,r,a),this._mgrKey=0,this._colorFormat=a,this._depthStencilFormat=i,0!=t&&0!=r&&s&&this._create(),this.lock=!0}get isCube(){return this._nativeObj.isCube}get samples(){return this._nativeObj.samples}get generateMipmap(){return this._nativeObj.generateMipmap}_start(){throw new Error("Method not implemented.")}_end(){throw new Error("Method not implemented.")}_create(){this._nativeObj=new window.conchRenderTexture2D(LayaGL.renderEngine._nativeObj,this.width,this.height,this._colorFormat,this.depthStencilFormat),this._texture=this._nativeObj._renderTarget._textures[0]}static pushRT(){throw new Error("Method not implemented.")}static popRT(){throw new Error("Method not implemented.")}start(){this._nativeObj.start()}end(){this._nativeObj.end()}restore(){this._nativeObj.restore()}clear(e=0,t=0,r=0,a=1){this._nativeObj.clear(e,t,r,a)}getData(e,t,r,a){return this._nativeObj.getData(e,t,r,a)}recycle(){}_disposeResource(){this._nativeObj._disposeResource()}}NativeRenderTexture2D._clearColor=new Color(0,0,0,0),NativeRenderTexture2D.rtStack=[],NativeRenderTexture2D.defuv=[0,0,1,0,1,1,0,1],NativeRenderTexture2D.flipyuv=[0,1,1,1,1,0,0,0];class RenderTexture2D extends BaseTexture{static get currentActive(){return RenderTexture2D._currentActive}get depthStencilFormat(){return this._depthStencilFormat}get defaultTexture(){return Texture2D.grayTexture}getIsReady(){return!0}get sourceWidth(){return this._width}get sourceHeight(){return this._height}get offsetX(){return 0}get offsetY(){return 0}constructor(t,r,a=e.RenderTargetFormat.R8G8B8,i=e.RenderTargetFormat.None){super(t,r,a),this._mgrKey=0,this._invertY=!1,this._colorFormat=a,this._depthStencilFormat=i,0!=t&&0!=r&&this._create(),this.lock=!0}get isCube(){return this._renderTarget._isCube}get samples(){return this._renderTarget._samples}get generateMipmap(){return this._renderTarget._generateMipmap}_start(){throw new Error("Method not implemented.")}_end(){throw new Error("Method not implemented.")}_create(){this._renderTarget=LayaGL.textureContext.createRenderTargetInternal(this.width,this.height,this._colorFormat,this.depthStencilFormat,!1,!1,1),this._texture=this._renderTarget._textures[0],this._texture.gammaCorrection=2.2}static pushRT(){RenderTexture2D.rtStack.push({rt:RenderTexture2D._currentActive,w:RenderState2D.width,h:RenderState2D.height})}static popRT(){var e=RenderTexture2D.rtStack.pop();e&&(RenderTexture2D._currentActive!=e.rt&&(e.rt?(LayaGL.textureContext.bindRenderTarget(e.rt._renderTarget),RenderState2D.InvertY=e.rt._invertY):(LayaGL.textureContext.bindoutScreenTarget(),RenderState2D.InvertY=!1),RenderTexture2D._currentActive=e.rt),LayaGL.renderEngine.viewport(0,0,e.w,e.h),LayaGL.renderEngine.scissor(0,0,e.w,e.h),RenderState2D.width=e.w,RenderState2D.height=e.h)}start(){LayaGL.textureContext.bindRenderTarget(this._renderTarget),this._lastRT=RenderTexture2D._currentActive,RenderTexture2D._currentActive=this,RenderState2D.InvertY=this._invertY,LayaGL.renderEngine.viewport(0,0,this._width,this._height),LayaGL.renderEngine.scissor(0,0,this._width,this._height),this._lastWidth=RenderState2D.width,this._lastHeight=RenderState2D.height,RenderState2D.width=this._width,RenderState2D.height=this._height,BaseShader.activeShader=null}end(){LayaGL.textureContext.unbindRenderTarget(this._renderTarget),RenderTexture2D._currentActive=null,RenderState2D.InvertY=!1}restore(){this._lastRT!=RenderTexture2D._currentActive&&(this._lastRT?(LayaGL.textureContext.bindRenderTarget(this._lastRT._renderTarget),RenderState2D.InvertY=this._lastRT._invertY):(LayaGL.textureContext.unbindRenderTarget(this._renderTarget),RenderState2D.InvertY=!1),RenderTexture2D._currentActive=this._lastRT),LayaGL.renderEngine.viewport(0,0,this._lastWidth,this._lastHeight),LayaGL.renderEngine.scissor(0,0,this._lastWidth,this._lastHeight),RenderState2D.width=this._lastWidth,RenderState2D.height=this._lastHeight,BaseShader.activeShader=null}clear(t=0,r=0,a=0,i=1){RenderTexture2D._clearColor.r=t,RenderTexture2D._clearColor.g=r,RenderTexture2D._clearColor.b=a,RenderTexture2D._clearColor.a=i,LayaGL.renderEngine.clearRenderTexture(e.RenderClearFlag.Color|e.RenderClearFlag.Depth,RenderTexture2D._clearColor,1)}getData(e,t,r,a){return LayaGL.textureContext.getRenderTextureData(this._renderTarget,e,t,r,a)}recycle(){}_disposeResource(){this._renderTarget&&this._renderTarget.dispose()}}RenderTexture2D._clearColor=new Color(0,0,0,0),RenderTexture2D._clearLinearColor=new Color,RenderTexture2D.rtStack=[],RenderTexture2D.defuv=[0,0,1,0,1,1,0,1],RenderTexture2D.flipyuv=[0,1,1,1,1,0,0,0],window.conch&&!window.conchConfig.conchWebGL&&(RenderTexture2D=NativeRenderTexture2D);class WebGLRTMgr{static getRT(t,r){return r|=0,(t|=0)>=1e4&&console.error("getRT error! w too big"),new RenderTexture2D(t,r,e.RenderTargetFormat.R8G8B8A8,e.RenderTargetFormat.None)}static releaseRT(e){e.destroy()}}WebGLRTMgr.dict={},e.BlendFactor=void 0,(R=e.BlendFactor||(e.BlendFactor={}))[R.Zero=0]="Zero",R[R.One=1]="One",R[R.SourceColor=2]="SourceColor",R[R.OneMinusSourceColor=3]="OneMinusSourceColor",R[R.DestinationColor=4]="DestinationColor",R[R.OneMinusDestinationColor=5]="OneMinusDestinationColor",R[R.SourceAlpha=6]="SourceAlpha",R[R.OneMinusSourceAlpha=7]="OneMinusSourceAlpha",R[R.DestinationAlpha=8]="DestinationAlpha",R[R.OneMinusDestinationAlpha=9]="OneMinusDestinationAlpha",R[R.SourceAlphaSaturate=10]="SourceAlphaSaturate",R[R.BlendColor=11]="BlendColor",R[R.OneMinusBlendColor=12]="OneMinusBlendColor";class RenderStateContext{static __init__(){RenderStateContext.DepthTestCMD=LayaGL.renderEngine.createRenderStateComand(),RenderStateContext.DepthMaskCMD=LayaGL.renderEngine.createRenderStateComand(),RenderStateContext.DepthFuncCMD=LayaGL.renderEngine.createRenderStateComand(),RenderStateContext.StencilTestCMD=LayaGL.renderEngine.createRenderStateComand(),RenderStateContext.StencilMaskCMD=LayaGL.renderEngine.createRenderStateComand(),RenderStateContext.StencilFuncCMD=LayaGL.renderEngine.createRenderStateComand(),RenderStateContext.stencilOpCMD=LayaGL.renderEngine.createRenderStateComand(),RenderStateContext.BlendCMD=LayaGL.renderEngine.createRenderStateComand(),RenderStateContext.BlendEquationCMD=LayaGL.renderEngine.createRenderStateComand(),RenderStateContext.BlendEquationSeparateCMD=LayaGL.renderEngine.createRenderStateComand(),RenderStateContext.BlendFuncCMD=LayaGL.renderEngine.createRenderStateComand(),RenderStateContext.BlendFuncSeperateCMD=LayaGL.renderEngine.createRenderStateComand(),RenderStateContext.CullFaceCMD=LayaGL.renderEngine.createRenderStateComand(),RenderStateContext.FrontFaceCMD=LayaGL.renderEngine.createRenderStateComand()}static setDepthTest(e){LayaGL.renderEngine._GLRenderState.setDepthTest(e)}static setDepthMask(e){LayaGL.renderEngine._GLRenderState.setDepthMask(e)}static setDepthFunc(e){LayaGL.renderEngine._GLRenderState.setDepthFunc(e)}static setStencilTest(e){LayaGL.renderEngine._GLRenderState.setStencilTest(e)}static setStencilMask(e){LayaGL.renderEngine._GLRenderState.setStencilMask(e)}static setStencilFunc(e,t){LayaGL.renderEngine._GLRenderState.setStencilFunc(e,t)}static setstencilOp(e,t,r){LayaGL.renderEngine._GLRenderState.setstencilOp(e,t,r)}static setBlend(e){LayaGL.renderEngine._GLRenderState.setBlend(e)}static setBlendEquation(e){LayaGL.renderEngine._GLRenderState.setBlendEquation(e)}static setBlendEquationSeparate(e,t){LayaGL.renderEngine._GLRenderState.setBlendEquationSeparate(e,t)}static setBlendFunc(e,t){LayaGL.renderEngine._GLRenderState.setBlendFunc(e,t)}static setBlendFuncSeperate(e,t,r,a){LayaGL.renderEngine._GLRenderState.setBlendFuncSeperate(e,t,r,a)}static setCullFace(e){LayaGL.renderEngine._GLRenderState.setCullFace(e)}static setFrontFace(e){LayaGL.renderEngine._GLRenderState.setFrontFace(e)}}RenderStateContext.stencilFuncArray=new Array(2),RenderStateContext.blendEquationSeparateArray=new Array(2),RenderStateContext.blenfunArray=new Array(2),RenderStateContext.blendFuncSeperateArray=new Array(4),RenderStateContext.stencilOpArray=new Array(3);class BlendMode{static _init_(){BlendMode.fns=[BlendMode.BlendNormal,BlendMode.BlendAdd,BlendMode.BlendMultiply,BlendMode.BlendScreen,BlendMode.BlendOverlay,BlendMode.BlendLight,BlendMode.BlendMask,BlendMode.BlendDestinationOut,BlendMode.BlendAddOld,BlendMode.BlendSourceAlpha],BlendMode.targetFns=[BlendMode.BlendNormalTarget,BlendMode.BlendAddTarget,BlendMode.BlendMultiplyTarget,BlendMode.BlendScreenTarget,BlendMode.BlendOverlayTarget,BlendMode.BlendLightTarget,BlendMode.BlendMask,BlendMode.BlendDestinationOut,BlendMode.BlendAddTargetOld,BlendMode.BlendSourceAlpha]}static BlendNormal(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.OneMinusSourceAlpha)}static BlendAddOld(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.DestinationAlpha)}static BlendAdd(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.One)}static BlendMultiply(){RenderStateContext.setBlendFunc(e.BlendFactor.DestinationColor,e.BlendFactor.OneMinusSourceAlpha)}static BlendScreen(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.One)}static BlendOverlay(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.OneMinusSourceAlpha)}static BlendLight(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.One)}static BlendNormalTarget(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.OneMinusSourceAlpha)}static BlendAddTargetOld(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.DestinationAlpha)}static BlendAddTarget(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.One)}static BlendMultiplyTarget(){RenderStateContext.setBlendFunc(e.BlendFactor.DestinationColor,e.BlendFactor.OneMinusSourceAlpha)}static BlendScreenTarget(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.One)}static BlendOverlayTarget(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.OneMinusSourceColor)}static BlendLightTarget(){RenderStateContext.setBlendFunc(e.BlendFactor.One,e.BlendFactor.One)}static BlendMask(){RenderStateContext.setBlendFunc(e.BlendFactor.Zero,e.BlendFactor.SourceAlpha)}static BlendDestinationOut(){RenderStateContext.setBlendFunc(e.BlendFactor.Zero,e.BlendFactor.Zero)}static BlendSourceAlpha(){RenderStateContext.setBlendFunc(e.BlendFactor.SourceAlpha,e.BlendFactor.OneMinusSourceAlpha)}}BlendMode.activeBlendFunction=null,BlendMode.NAMES=["normal","add","multiply","screen","overlay","light","mask","destination-out","add_old"],BlendMode.TOINT={normal:0,add:1,multiply:2,screen:3,overlay:4,light:5,mask:6,"destination-out":7,lighter:1,lighter_old:8,add_old:8},BlendMode.NORMAL="normal",BlendMode.MASK="mask",BlendMode.LIGHTER="lighter";const b=new Rectangle,C=new Rectangle;class Texture extends Resource{static create(e,t,r,a,i,s=0,n=0,o=0,l=0){return Texture._create(e,t,r,a,i,s,n,o,l)}static _create(e,t,r,a,i,s=0,n=0,o=0,l=0,h=null){var u,d=e instanceof Texture,_=d?e.uv:Texture.DEF_UV,c=d?e.bitmap:e;c.width&&t+a>c.width&&(a=c.width-t),c.height&&r+i>c.height&&(i=c.height-r),h?(u=h).setTo(c,null,o||a,l||i):u=new Texture(c,null,o||a,l||i),u.width=a,u.height=i,u.offsetX=s,u.offsetY=n;var p=1/c.width,m=1/c.height;t*=p,r*=m,a*=p,i*=m;var f=u.uv[0],g=u.uv[1],T=u.uv[4],S=u.uv[5],x=T-f,y=S-g,E=function(e,t,r){for(var a=0;a<8;a+=2)r[a]+=e,r[a+1]+=t;return r}(_[0],_[1],[t,r,t+a,r,t+a,r+i,t,r+i]);u.uv=new Float32Array([f+E[0]*x,g+E[1]*y,T-(1-E[2])*x,g+E[3]*y,T-(1-E[4])*x,S-(1-E[5])*y,f+E[6]*x,S-(1-E[7])*y]);var R=e.scaleRate;return R&&1!=R?(u.sourceWidth/=R,u.sourceHeight/=R,u.width/=R,u.height/=R,u.scaleRate=R,u.offsetX/=R,u.offsetY/=R):u.scaleRate=1,u}static createFromTexture(e,t,r,a,i){var s=e.scaleRate;1!=s&&(t*=s,r*=s,a*=s,i*=s);var n=Rectangle.TEMP.setTo(t-e.offsetX,r-e.offsetY,a,i),o=n.intersection(b.setTo(0,0,e.width,e.height),C);return o?Texture.create(e,o.x,o.y,o.width,o.height,o.x-n.x,o.y-n.y,a,i):null}get uv(){return this._uv}set uv(e){this.uvrect[0]=Math.min(e[0],e[2],e[4],e[6]),this.uvrect[1]=Math.min(e[1],e[3],e[5],e[7]),this.uvrect[2]=Math.max(e[0],e[2],e[4],e[6])-this.uvrect[0],this.uvrect[3]=Math.max(e[1],e[3],e[5],e[7])-this.uvrect[1],this._uv=e}get width(){return this._w?this._w:this.bitmap?this.uv&&this.uv!==Texture.DEF_UV?(this.uv[2]-this.uv[0])*this.bitmap.width:this.bitmap.width:0}set width(e){this._w=e,this.sourceWidth||(this.sourceWidth=e)}get height(){return this._h?this._h:this.bitmap?this.uv&&this.uv!==Texture.DEF_UV?(this.uv[5]-this.uv[1])*this.bitmap.height:this.bitmap.height:0}set height(e){this._h=e,this.sourceHeight||(this.sourceHeight=e)}get bitmap(){return this._bitmap}set bitmap(e){this._bitmap!=e&&(this._bitmap&&this._bitmap._removeReference(this._referenceCount),this._bitmap=e,e&&e._addReference(this._referenceCount))}constructor(e=null,t=null,r=0,a=0){super(!1),this.uvrect=[0,0,1,1],this._w=0,this._h=0,this.offsetX=0,this.offsetY=0,this.sourceWidth=0,this.sourceHeight=0,this.scaleRate=1;let i=e instanceof Texture?e.bitmap:e;this.setTo(i,t,r,a)}_addReference(e=1){super._addReference(e),this._bitmap&&this._bitmap._addReference(e)}_removeReference(e=1){this._bitmap&&this._bitmap._removeReference(e),super._removeReference(e)}_getSource(e=null){return this._destroyed||!this._bitmap?null:(this.recoverBitmap(e),this._bitmap.destroyed?null:this.bitmap._getSource())}setTo(e=null,t=null,r=0,a=0){this.bitmap=e,this.sourceWidth=r,this.sourceHeight=a,e&&(this._w=e.width,this._h=e.height,this.sourceWidth=this.sourceWidth||e.width,this.sourceHeight=this.sourceHeight||e.height),this.uv=t||Texture.DEF_UV}load(e,t){return this._destroyed?Promise.resolve():ILaya.loader.load(e).then((e=>{let r=e.bitmap;this.bitmap=r,this.sourceWidth=this._w=r.width,this.sourceHeight=this._h=r.height,t&&t.run(),this.event(Event.READY,this)}))}getTexturePixels(e,t,r,a){var i,s,n,o=this.bitmap,l=this._w,h=this._h,u=this.sourceWidth,d=this.sourceHeight,_=o.width,c=o.height,p=this.offsetX,m=this.offsetY;let f=r,g=a;if(e+r>l+p&&(f-=e+r-l-p),e+r>u&&(r-=e+r-u),t+a>h+m&&(g-=t+a-h-m),t+a>d&&(a-=t+a-d),r<=0||a<=0)return null;let T=p>e?p-e:0,S=m>t?m-t:0,x=e>p?e-p:0,y=t>m?t-m:0;f-=T,g-=S;var E=4*r,R=null;try{R=o.getPixels()}catch(e){}if(R){if(0==e&&0==t&&r==_&&a==c)return R;let o=this._uv.slice(),l=Math.round(o[0]*_),h=Math.round(o[1]*c);var b=new Uint8Array(r*a*4);for(i=4*l+4*x+(s=(h+y)*(E=4*_)),n=0;n<g;n++)b.set(R.slice(i,i+4*f),4*r*(n+S)+4*T),i+=E;return b}var C=new ILaya.Context;C.size(r,a),C.asBitmap=!0;var v=null;if(0!=e||0!=t||r!=_||a!=c){var D=(v=this._uv.slice())[0],M=v[1],A=(v[2]-D)/l,L=(v[7]-M)/h;v=[D+x*A,M+y*L,D+(x+f)*A,M+y*L,D+(x+f)*A,M+(y+g)*L,D+x*A,M+(y+g)*L]}C._drawTextureM(this,T,S,f,g,null,1,v,4294967295),C._targets.start(),C.flush(),C._targets.end(),C._targets.restore();var I=C._targets.getData(0,0,r,a);for(C.destroy(),b=new Uint8Array(r*a*4),i=0,s=(a-1)*E,n=a-1;n>=0;n--)b.set(I.slice(s,s+E),i),i+=E,s-=E;return b}getPixels(e,t,r,a){return this.getTexturePixels(e,t,r,a)}recoverBitmap(e){var t=this._bitmap.url;this._destroyed||this._bitmap&&!this._bitmap.destroyed||!t||ILaya.loader.load(t).then((t=>{this.bitmap=t.bitmap,e&&e()}))}disposeBitmap(){!this._destroyed&&this._bitmap&&this._bitmap.destroy()}get valid(){return!this._destroyed&&this._bitmap&&!this._bitmap.destroyed}get obsolute(){return this._obsolute||!this._bitmap||this._bitmap.destroyed||this._bitmap.obsolute}set obsolute(e){this._obsolute=e}_disposeResource(){let e=this._bitmap;this._bitmap=null,e&&e._removeReference(this._referenceCount)}getCachedClip(e,t,r,a){let i=`${e}_${t}_${r}_${a}`;this._clipCache||(this._clipCache=new Map);let s=this._clipCache.get(i);return s||(s=Texture.createFromTexture(this,e,t,r,a),s&&(s._sizeGrid=this._sizeGrid),this._clipCache.size>100&&this._clipCache.clear(),this._clipCache.set(i,s),s)}}var v,D,M,A,L;Texture.DEF_UV=new Float32Array([0,0,1,0,1,1,0,1]),Texture.NO_UV=new Float32Array([0,0,0,0,0,0,0,0]),Texture.INV_UV=new Float32Array([0,1,1,1,1,0,0,0]),e.BlendEquationSeparate=void 0,(v=e.BlendEquationSeparate||(e.BlendEquationSeparate={}))[v.ADD=0]="ADD",v[v.SUBTRACT=1]="SUBTRACT",v[v.REVERSE_SUBTRACT=2]="REVERSE_SUBTRACT",v[v.MIN=3]="MIN",v[v.MAX=4]="MAX",e.BlendType=void 0,(D=e.BlendType||(e.BlendType={}))[D.BLEND_DISABLE=0]="BLEND_DISABLE",D[D.BLEND_ENABLE_ALL=1]="BLEND_ENABLE_ALL",D[D.BLEND_ENABLE_SEPERATE=2]="BLEND_ENABLE_SEPERATE",e.CompareFunction=void 0,(M=e.CompareFunction||(e.CompareFunction={}))[M.Never=0]="Never",M[M.Less=1]="Less",M[M.Equal=2]="Equal",M[M.LessEqual=3]="LessEqual",M[M.Greater=4]="Greater",M[M.NotEqual=5]="NotEqual",M[M.GreaterEqual=6]="GreaterEqual",M[M.Always=7]="Always",M[M.Off=8]="Off",e.CullMode=void 0,(A=e.CullMode||(e.CullMode={}))[A.Off=0]="Off",A[A.Front=1]="Front",A[A.Back=2]="Back",e.StencilOperation=void 0,(L=e.StencilOperation||(e.StencilOperation={}))[L.Keep=0]="Keep",L[L.Zero=1]="Zero",L[L.Replace=2]="Replace",L[L.IncrementSaturate=3]="IncrementSaturate",L[L.DecrementSaturate=4]="DecrementSaturate",L[L.Invert=5]="Invert",L[L.IncrementWrap=6]="IncrementWrap",L[L.DecrementWrap=7]="DecrementWrap";class AssetDb{constructor(){this.uuidMap={},this.shaderNameMap={},this.metaMap={}}UUID_to_URL(e){return this.uuidMap[e]}UUID_to_URL_async(e){return Promise.resolve(null)}URL_to_UUID_async(e){return Promise.resolve(null)}resolveURL(e,t){if(e.startsWith("res://")){let r=e.substring(6);return AssetDb.inst.UUID_to_URL_async(r).then((e=>(t&&t(e),e)))}return t&&t(e),Promise.resolve(e)}shaderName_to_URL(e){return this.shaderNameMap[e]}shaderName_to_URL_async(e){return Promise.resolve(null)}getMeta(e,t){return Promise.resolve(null)}getSubAssetURL(e,t,r,a){return r?`${Utils.replaceFileExtension(e,"")}@${r}.${a}`:e}}AssetDb.inst=new AssetDb;class URL{static __init__(){URL.rootPath=URL.basePath=location&&null!=location.protocol&&""!=location.protocol?URL.getPath(location.protocol+"//"+location.host+location.pathname):""}static initMiniGameExtensionOverrides(){LayaEnv.isPreview||(URL.overrideExtension(["rendertexture","videotexture"],"rt.json"),URL.overrideExtension(["controller"],"controller.json"),URL.overrideExtension(["mc"],"mc.bin"),URL.overrideExtension(["mcc"],"mcc.json"),URL.overrideExtension(["shader"],"shader.json"),URL.overrideExtension(["scene3d","scene","taa","prefab"],"json"),URL.overrideExtension(["fui"],"fui.json"),URL.overrideExtension(["glsl"],"glsl.txt"),URL.overrideExtension(["skel"],"skel.bin"))}constructor(e){this._url=URL.formatURL(e),this._path=URL.getPath(e)}get url(){return this._url}get path(){return this._path}static formatURL(e,t){if(!e)return t||URL.basePath||"";if(e.startsWith("res://")){let t=e.substring(6),r=AssetDb.inst.UUID_to_URL(t);if(!r)return e;e=r}let r=e.charCodeAt(0);if(-1==e.indexOf(":")&&47!==r){null!=URL.customFormat&&(e=URL.customFormat(e));let a=URL.version[e];if(null!=a){let t=e.lastIndexOf(".");e=e.substring(0,t)+"-"+a+e.substring(t)}if(126===r)e=URL.join(URL.rootPath,e.substring(2));else{if(null==t){t=URL.basePath;for(let r in URL.basePaths)if(e.startsWith(r)){t=URL.basePaths[r];break}}e=URL.join(t,e)}}return e}static postFormatURL(e){if(URL.hasExtOverrides){let t=Utils.getFileExtension(e),r=URL.overrideFileExts[t];null!=r&&(e=Utils.replaceFileExtension(e,r))}return e}static normalize(e){if(-1==e.indexOf("./"))return e;let t=e.split("/"),r=t.length,a=0;for(;a<r;)if("."!=t[a]){if(".."==t[a]){let e=a-1;if(e>=0&&".."!==t[e]){t.splice(e,2),r-=2,a--;continue}}a++}else t.splice(a,1),r--;return t.length=r,t.join("/")}static getResURLByUUID(e){return e.length>=36&&45===e.charCodeAt(8)&&45===e.charCodeAt(13)?"res://"+e:e}static join(e,t){if(!t)return"";if(t.indexOf(":")>0)return t;if(e){let r=t.charCodeAt(0);126!==r&&47!==r&&(t=47!==e.charCodeAt(e.length-1)?e+"/"+t:e+t)}return URL.normalize(t)}static getPath(e){var t=e.lastIndexOf("/");return t>0?e.substring(0,t+1):""}static getFileName(e){var t=e.lastIndexOf("/");return t>0?e.substring(t+1):e}static getURLVerion(e){var t=e.indexOf("?");return t>=0?e.substring(t):null}static overrideExtension(e,t){for(let r of e)URL.overrideFileExts[r]=t;URL.hasExtOverrides=!0}}URL.version={},URL.basePath="",URL.basePaths={},URL.rootPath="",URL.overrideFileExts={},URL.customFormat=function(e){return e};class IncludeFile{static splitToWords(e,t){for(var r,a,i=[],s=-1,n=0,o=e.length;n<o;n++)if(r=e.charAt(n)," \t=+-*/&%!<>()'\",;".indexOf(r)>=0){if(s>=0&&n-s>1&&(a=e.substr(s,n-s),i.push(a)),'"'==r||"'"==r){var l=e.indexOf(r,n+1);if(l<0)throw"Sharder err:"+e;i.push(e.substr(n+1,l-n-1)),n=l,s=-1;continue}"("==r&&t&&i.length>0&&(a=i[i.length-1]+";","vec4;main;".indexOf(a)<0&&(t.useFuns+=a)),s=-1}else s<0&&(s=n);return s<o&&o-s>1&&(a=e.substr(s,o-s),i.push(a)),i}constructor(e){this.codes={},this.funs={},this.curUseID=-1,this.funnames="",this.script=e;for(var t,r,a=0;!((a=e.indexOf("#begin",a))<0);){for(r=a+5;!((r=e.indexOf("#end",r))<0)&&"i"===e.charAt(r+4);)r+=5;if(r<0)throw"add include err,no #end:"+e;t=e.indexOf("\n",a);var i=IncludeFile.splitToWords(e.substr(a,t-a),null);"code"==i[1]?this.codes[i[2]]=e.substr(t+1,r-t-1):"function"==i[1]&&(t=e.indexOf("function",a),t+="function".length,this.funs[i[3]]=e.substr(t+1,r-t-1),this.funnames+=i[3]+";"),a=r+1}}getWith(e=null){var t=e?this.codes[e]:this.script;if(!t)throw"get with error:"+e;return t}getFunsScript(e){var t="";for(var r in this.funs)e.indexOf(r+";")>=0&&(t+=this.funs[r]);return t}}class ShaderNode{constructor(e){this.childs=[],this.text="",this.useFuns="",this.z=0,this.includefiles=e}setParent(e){e.childs.push(this),this.z=e.z+1,this.parent=e}setCondition(e,t){e&&(this.conditionType=t,e=e.replace(/(\s*$)/g,""),this.condition=function(){return this[e]},this.condition.__condition=e)}toscript(e,t){return this._toscript(e,t,++ShaderNode.__id)}_toscript(e,t,r){if(this.childs.length<1&&!this.text)return t;if(t.length,this.condition){var a=!!this.condition.call(e);if(2===this.conditionType&&(a=!a),!a&&ShaderNode.__noCompileEnable)return t}if(!this.noCompile&&ShaderNode.__noCompileEnable||this.text&&t.push(this.text),this.childs.length>0&&this.childs.forEach((function(a,i,s){a._toscript(e,t,r)})),this.includefiles.length>0&&this.useFuns.length>0)for(var i,s=0,n=this.includefiles.length;s<n;s++)this.includefiles[s].curUseID!=r&&(i=this.includefiles[s].file.getFunsScript(this.useFuns)).length>0&&(this.includefiles[s].curUseID=r,t[0]=i+t[0]);return t}}ShaderNode.__id=1,ShaderNode.__noCompileEnable=!0;const I=new RegExp("\r","g"),w=new RegExp("[ \\t=\\+\\-*/&%!<>!%(),;\\|]","g"),B={Back:e.CullMode.Back,Front:e.CullMode.Front,Off:e.CullMode.Off},P={Disable:e.BlendType.BLEND_DISABLE,All:e.BlendType.BLEND_ENABLE_ALL,Seperate:e.BlendType.BLEND_ENABLE_SEPERATE},F={Zero:e.BlendFactor.Zero,One:e.BlendFactor.One,SourceColor:e.BlendFactor.SourceColor,OneMinusSourceColor:e.BlendFactor.OneMinusSourceColor,DestinationColor:e.BlendFactor.DestinationColor,OneMinusDestinationColor:e.BlendFactor.OneMinusDestinationColor,SourceAlpha:e.BlendFactor.SourceAlpha,OneMinusSourceAlpha:e.BlendFactor.OneMinusSourceAlpha,DestinationAlpha:e.BlendFactor.DestinationAlpha,OneMinusDestinationAlpha:e.BlendFactor.OneMinusDestinationAlpha,SourceAlphaSaturate:e.BlendFactor.SourceAlphaSaturate,BlendColor:e.BlendFactor.BlendColor,OneMinusBlendColor:e.BlendFactor.OneMinusBlendColor},N={Add:e.BlendEquationSeparate.ADD,Subtract:e.BlendEquationSeparate.SUBTRACT,Reverse_substract:e.BlendEquationSeparate.REVERSE_SUBTRACT,Min:e.BlendEquationSeparate.MIN,Max:e.BlendEquationSeparate.MAX},O={Never:e.CompareFunction.Never,Less:e.CompareFunction.Less,Equal:e.CompareFunction.Equal,LessEqual:e.CompareFunction.LessEqual,Greater:e.CompareFunction.Greater,NotEqual:e.CompareFunction.NotEqual,GreaterEqual:e.CompareFunction.GreaterEqual,Always:e.CompareFunction.Always,Off:e.CompareFunction.Off},U={Keep:e.StencilOperation.Keep,Zero:e.StencilOperation.Zero,Replace:e.StencilOperation.Replace,IncrementSaturate:e.StencilOperation.IncrementSaturate,DecrementSaturate:e.StencilOperation.DecrementSaturate,Invert:e.StencilOperation.Invert,IncrementWrap:e.StencilOperation.IncrementWrap,DecrementWrap:e.StencilOperation.DecrementWrap};class ShaderCompile{static addInclude(e,t,r){if(!t||0===t.length)return console.error("shader include file err:"+e),null;if(!r&&ShaderCompile.includes[e])return console.warn("shader include file already exists:"+e),ShaderCompile.includes[e];t=t.replace(I,"");let a=new IncludeFile(t);return ShaderCompile.includes[e]=a,a}static compile(e,t,r){let a={vsNode:new ShaderNode([]),psNode:new ShaderNode([]),includeNames:new Set,defs:new Set},i=[];e=e.replace(I,""),t=t.replace(I,""),ShaderCompile._compileToTree(a.vsNode,e,a.defs,i,r),ShaderCompile._compileToTree(a.psNode,t,a.defs,i,r);for(let e of i)e.file?a.includeNames.add(e.name):console.warn(`ShaderCompile missing file ${e.name}`);return a}static compileAsync(e,t,r){let a={vsNode:new ShaderNode([]),psNode:new ShaderNode([]),includeNames:new Set,defs:new Set},i=[];return e=e.replace(I,""),t=t.replace(I,""),ShaderCompile._compileToTree(a.vsNode,e,a.defs,i,r),ShaderCompile._compileToTree(a.psNode,t,a.defs,i,r),this._loadIncludesDeep(a,i,0)}static _loadIncludesDeep(e,t,r){let a,i=t.length;for(let s=r;s<i;s++){let r=t[s];r.file?e.includeNames.add(r.name):(a||(a=[]),a.push(r))}return a?ILaya.loader.load(a.map((e=>e.name))).then((r=>{let s=a.length;for(let i=0;i<s;i++){let s=a[i],n=r[i];if(n){e.includeNames.add(s.name);let r=n.getWith(s.codeName);s.node.condition?s.node.text=r:(ShaderCompile._compileToTree(s.node,r,e.defs,t,URL.getPath(s.name)),s.node.text="")}else{let e=s.node.parent.childs;e.splice(e.indexOf(s.node),1)}}return t.length>i?ShaderCompile._loadIncludesDeep(e,t,i):e})):Promise.resolve(e)}static _compileToTree(e,t,r,a,i){let s,n,o,l,h,u,d,_,c,p,m=t.split("\n");for(_=0;_<m.length;_++)if(o=m[_],!(o.length<1)&&(u=o.indexOf("//"),0!==u))if(u>=0&&(o=o.substr(0,u)),(u=o.indexOf("#"))<0){n=e.childs[e.childs.length-1];let t=e.includefiles;if(n&&!n.name){t.length>0&&IncludeFile.splitToWords(o,n),n.text+="\n"+o;continue}s=new ShaderNode(t),s.text=o,s.noCompile=!0,t.length>0&&IncludeFile.splitToWords(o,s),s.setParent(e)}else{for(s=new ShaderNode(e.includefiles),s.text=o,s.noCompile=!0,l="#",p=u+1,c=o.length;p<c;p++){let e=o.charAt(p);if(" "===e||"\t"===e||"?"===e)break;l+=e}switch(s.name=l,l){case"#ifdef":case"#ifndef":for(s.src=o,s.noCompile=null!=o.match(/[!&|()=<>]/),s.noCompile?console.log("function():Boolean{return "+o.substr(u+s.name.length)+"}"):(d=o.replace(/^\s*/,"").split(/\s+/),s.setCondition(d[1],"#ifdef"===l?ShaderCompile.IFDEF_YES:ShaderCompile.IFDEF_ELSE),s.text=s.text),s.setParent(e),e=s,d=o.substr(p).split(w),p=0;p<d.length;p++)o=d[p],o.length&&r.add(o);break;case"#if":case"#elif":for(s.src=o,s.noCompile=!0,"#elif"==l&&(n=(e=e.parent).childs[e.childs.length-1],n.text=n.src,n.noCompile=!0,n.condition=null),s.setParent(e),e=s,d=o.substr(p).split(w),p=0;p<d.length;p++)o=d[p],o.length&&"defined"!=o&&r.add(o);break;case"#else":s.src=o,n=(e=e.parent).childs[e.childs.length-1],s.noCompile=n.noCompile,s.noCompile||(s.condition=n.condition,s.conditionType=n.conditionType==ShaderCompile.IFDEF_YES?ShaderCompile.IFDEF_ELSE:ShaderCompile.IFDEF_YES),s.setParent(e),e=s;break;case"#endif":n=(e=e.parent).childs[e.childs.length-1],s.noCompile=n.noCompile,s.noCompile||(s.text=s.text),s.setParent(e);break;case"#include":d=IncludeFile.splitToWords(o,null);let t,_=d[1];_.startsWith(".")?_=URL.join(i,_):_.startsWith("/")?_=URL.formatURL(_.substring(1)):(t=ShaderCompile.includes[_],t||(_="internal/"+_)),t=ShaderCompile.includes[_],!t&&ShaderCompile.loadIncludeFileSync&&(ShaderCompile.loadIncludeFileSync(_),t=ShaderCompile.includes[_]);let c="with"==d[2]?d[3]:null;a.push({name:_,codeName:c,node:s,file:t}),s.setParent(e),(u=d[0].indexOf("?"))<0?(t&&(o=t.getWith(c),this._compileToTree(s,o,r,a,URL.getPath(_))),s.text=""):(s.setCondition(d[0].substr(u+1),ShaderCompile.IFDEF_YES),t&&(s.text=t.getWith(c)));break;case"#import":d=IncludeFile.splitToWords(o,null),h=d[1],s.includefiles.push({node:s,file:ShaderCompile.includes[h],ofs:s.text.length});break;default:s.setParent(e)}}}static getRenderState(e,t){if(!e)return;t.cull=B[e.cull],t.blend=P[e.blend],t.srcBlend=F[e.srcBlend],t.dstBlend=F[e.dstBlend],t.srcBlendRGB=F[e.srcBlendRGB],t.dstBlendRGB=F[e.dstBlendRGB],t.srcBlendAlpha=F[e.srcBlendAlpha],t.dstBlendAlpha=F[e.dstBlendAlpha],t.blendEquation=N[e.blendEquation],t.blendEquationRGB=N[e.blendEquationRGB],t.blendEquationAlpha=N[e.blendEquationAlpha],t.depthTest=O[e.depthTest],t.depthWrite=e.depthWrite,t.stencilRef=e.stencilRef,t.stencilTest=O[e.stencilTest],t.stencilWrite=e.stencilWrite;let r=e.stencilOp,a=r?r[0]:null,i=r?r[1]:null,s=r?r[2]:null;t.stencilOp.x=U[a],t.stencilOp.y=U[i],t.stencilOp.z=U[s]}}ShaderCompile.IFDEF_NO=0,ShaderCompile.IFDEF_YES=1,ShaderCompile.IFDEF_ELSE=2,ShaderCompile.IFDEF_PARENT=3,ShaderCompile.includes={};class DefineDatas{constructor(){this._mask=[],this._length=0}_intersectionDefineDatas(e){for(var t=e._mask,r=this._mask,a=this._length-1;a>=0;a--){var i=r[a]&t[a];0==i&&a==this._length-1?this._length--:r[a]=i}}add(e){var t=e._index,r=t+1,a=this._mask,i=this._length;if(i<r){for(a.length<r&&(a.length=r);i<t;i++)a[i]=0;a[t]=e._value,this._length=r}else a[t]|=e._value}remove(e){var t=e._index,r=this._mask,a=this._length-1;if(!(t>a)){var i=r[t]&~e._value;t==a&&0===i?this._length--:r[t]=i}}addDefineDatas(e){var t=e._mask,r=e._length,a=this._mask,i=this._length;if(i<r){a.length=r;for(var s=0;s<i;s++)a[s]|=t[s];for(;s<r;s++)a[s]=t[s];this._length=r}else for(s=0;s<r;s++)a[s]|=t[s]}removeDefineDatas(e){for(var t=e._mask,r=this._mask,a=this._length-1,i=Math.min(e._length,a);i>=0;i--){var s=r[i]&~t[i];i==a&&0===s?(a--,this._length--):r[i]=s}}has(e){var t=e._index;return!(t>=this._length)&&0!=(this._mask[t]&e._value)}clear(){this._length=0}cloneTo(e){var t=e,r=t._mask,a=this._mask,i=this._length;r.length=i;for(var s=0;s<i;s++)r[s]=a[s];t._length=i}clone(){var e=new DefineDatas;return this.cloneTo(e),e}destroy(){delete this._mask}}class ShaderDefine{constructor(e,t){this._index=e,this._value=t}}ShaderDefine._texGammaDefine={};class ShaderVariant{get shader(){return this._shader}get subShaderIndex(){return this._subShaderIndex}get passIndex(){return this._passIndex}get defineNames(){return this._defineNames}constructor(e,t,r,a){this._subShaderIndex=0,this._passIndex=0,this.setValue(e,t,r,a)}setValue(e,t,r,a){if(!e)throw"ShaderVariantInfo:Shader can't be null.";var i=e.getSubShaderAt(t);if(!i)throw`ShaderVariantInfo:Shader don't have subShaderIndex of ${t}.`;var s=i._passes[r];if(!s)throw`ShaderVariantInfo:Shader don't have passIndex of ${r}.`;for(var n=s._validDefine,o=0,l=a.length;o<l;o++){var h=a[o];if(!n.has(Shader3D.getDefineByName(h)))throw`ShaderVariantInfo:Invalid defineName ${h} in ${e._name} subShaderIndex of ${t} passIndex of ${r}.`}this._shader=e,this._subShaderIndex=t,this._passIndex=r,this._defineNames=a}equal(e){if(this._shader!==e._shader||this._subShaderIndex!==e._subShaderIndex||this._passIndex!==e._passIndex)return!1;var t=this._defineNames,r=e._defineNames;if(t.length!==r.length)return!1;for(var a=0,i=this._defineNames.length;a<i;a++)if(t[a]!==r[a])return!1;return!0}clone(){return new ShaderVariant(this._shader,this._subShaderIndex,this._passIndex,this._defineNames.slice())}}class ShaderVariantCollection{constructor(){this._allCompiled=!1,this._variants=[]}get allCompiled(){return this._allCompiled}get variantCount(){return this._variants.length}add(e){for(var t=0,r=this._variants.length;t<r;t++)if(this._variants[t].equal(e))return!1;return this._variants.push(e.clone()),this._allCompiled=!1,!0}remove(e){for(var t=0,r=this._variants.length;t<r;t++)if(this._variants[t].equal(e))return this._variants.splice(t,1),!0;return!1}contatins(e){for(var t=0,r=this._variants.length;t<r;t++)if(this._variants[t].equal(e))return!0;return!1}getByIndex(e){return this._variants[e]}clear(){this._variants.length=0}compile(){if(!this._allCompiled){for(var e=this._variants,t=0,r=e.length;t<r;t++){var a=e[t];Shader3D.compileShaderByDefineNames(a._shader._name,a._subShaderIndex,a._passIndex,a._defineNames,[])}this._allCompiled=!0}}}class MathUtils3D{constructor(){}static isZero(e){return Math.abs(e)<MathUtils3D.zeroTolerance}static nearEqual(e,t){return!!MathUtils3D.isZero(e-t)}static fastInvSqrt(e){return MathUtils3D.isZero(e)?e:1/Math.sqrt(e)}}MathUtils3D.zeroTolerance=1e-6,MathUtils3D.MaxValue=340282347e30,MathUtils3D.MinValue=-340282347e30,MathUtils3D.Deg2Rad=Math.PI/180;class Vector2{constructor(e=0,t=0){this.x=e,this.y=t}setValue(e,t){this.x=e,this.y=t}static scale(e,t,r){r.x=e.x*t,r.y=e.y*t}static equals(e,t){return MathUtils3D.nearEqual(e.x,t.x)&&MathUtils3D.nearEqual(e.y,t.y)}fromArray(e,t=0){this.x=e[t+0],this.y=e[t+1]}toArray(){return[this.x,this.y]}writeTo(e,t=0){e[t+0]=this.x,e[t+1]=this.y}cloneTo(e){var t=e;t.x=this.x,t.y=this.y}static dot(e,t){return e.x*t.x+e.y*t.y}static normalize(e,t){var r=e.x,a=e.y,i=r*r+a*a;i>0&&(i=1/Math.sqrt(i),t.x=r*i,t.y=a*i)}static scalarLength(e){var t=e.x,r=e.y;return Math.sqrt(t*t+r*r)}clone(){var e=new Vector2;return this.cloneTo(e),e}forNativeElement(e=null){e?(this.elements=e,this.elements[0]=this.x,this.elements[1]=this.y):this.elements=new Float32Array([this.x,this.y]),Vector2.rewriteNumProperty(this,"x",0),Vector2.rewriteNumProperty(this,"y",1)}static rewriteNumProperty(e,t,r){Object.defineProperty(e,t,{get:function(){return this.elements[r]},set:function(e){this.elements[r]=e}})}}Vector2.ZERO=new Vector2(0,0),Vector2.ONE=new Vector2(1,1),Vector2.TempVector2=new Vector2;class Vector4{constructor(e=0,t=0,r=0,a=0){this.x=e,this.y=t,this.z=r,this.w=a}setValue(e,t,r,a){this.x=e,this.y=t,this.z=r,this.w=a}fromArray(e,t=0){this.x=e[t+0],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3]}toArray(){return[this.x,this.y,this.z,this.w]}writeTo(e,t=0){e[t+0]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w}cloneTo(e){var t=e;t.x=this.x,t.y=this.y,t.z=this.z,t.w=this.w}clone(){var e=new Vector4;return this.cloneTo(e),e}static lerp(e,t,r,a){var i=e.x,s=e.y,n=e.z,o=e.w;a.x=i+r*(t.x-i),a.y=s+r*(t.y-s),a.z=n+r*(t.z-n),a.w=o+r*(t.w-o)}static transformByM4x4(e,t,r){var a=e.x,i=e.y,s=e.z,n=e.w,o=t.elements;r.x=a*o[0]+i*o[4]+s*o[8]+n*o[12],r.y=a*o[1]+i*o[5]+s*o[9]+n*o[13],r.z=a*o[2]+i*o[6]+s*o[10]+n*o[14],r.w=a*o[3]+i*o[7]+s*o[11]+n*o[15]}static equals(e,t){return MathUtils3D.nearEqual(Math.abs(e.x),Math.abs(t.x))&&MathUtils3D.nearEqual(Math.abs(e.y),Math.abs(t.y))&&MathUtils3D.nearEqual(Math.abs(e.z),Math.abs(t.z))&&MathUtils3D.nearEqual(Math.abs(e.w),Math.abs(t.w))}equal(e){return Vector4.equals(this,e)}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}static normalize(e,t){var r=e.length();if(r>0){var a=1/r;t.x=e.x*a,t.y=e.y*a,t.z=e.z*a,t.w=e.w*a}}static add(e,t,r){r.x=e.x+t.x,r.y=e.y+t.y,r.z=e.z+t.z,r.w=e.w+t.w}static subtract(e,t,r){r.x=e.x-t.x,r.y=e.y-t.y,r.z=e.z-t.z,r.w=e.w-t.w}static multiply(e,t,r){r.x=e.x*t.x,r.y=e.y*t.y,r.z=e.z*t.z,r.w=e.w*t.w}static scale(e,t,r){r.x=e.x*t,r.y=e.y*t,r.z=e.z*t,r.w=e.w*t}static Clamp(e,t,r,a){var i=e.x,s=e.y,n=e.z,o=e.w,l=t.x,h=t.y,u=t.z,d=t.w,_=r.x,c=r.y,p=r.z,m=r.w;i=(i=i>_?_:i)<l?l:i,s=(s=s>c?c:s)<h?h:s,n=(n=n>p?p:n)<u?u:n,o=(o=o>m?m:o)<d?d:o,a.x=i,a.y=s,a.z=n,a.w=o}static distanceSquared(e,t){var r=e.x-t.x,a=e.y-t.y,i=e.z-t.z,s=e.w-t.w;return r*r+a*a+i*i+s*s}static distance(e,t){var r=e.x-t.x,a=e.y-t.y,i=e.z-t.z,s=e.w-t.w;return Math.sqrt(r*r+a*a+i*i+s*s)}static dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}static min(e,t,r){r.x=Math.min(e.x,t.x),r.y=Math.min(e.y,t.y),r.z=Math.min(e.z,t.z),r.w=Math.min(e.w,t.w)}static max(e,t,r){r.x=Math.max(e.x,t.x),r.y=Math.max(e.y,t.y),r.z=Math.max(e.z,t.z),r.w=Math.max(e.w,t.w)}forNativeElement(e=null){e?(this.elements=e,this.elements[0]=this.x,this.elements[1]=this.y,this.elements[2]=this.z,this.elements[3]=this.w):this.elements=new Float32Array([this.x,this.y,this.z,this.w]),Vector2.rewriteNumProperty(this,"x",0),Vector2.rewriteNumProperty(this,"y",1),Vector2.rewriteNumProperty(this,"z",2),Vector2.rewriteNumProperty(this,"w",3)}}Vector4.ZERO=new Vector4,Vector4.ONE=new Vector4(1,1,1,1),Vector4.UnitX=new Vector4(1,0,0,0),Vector4.UnitY=new Vector4(0,1,0,0),Vector4.UnitZ=new Vector4(0,0,1,0),Vector4.UnitW=new Vector4(0,0,0,1),Vector4.tempVec4=new Vector4(0,0,0,0);class Vector3{static distanceSquared(e,t){var r=e.x-t.x,a=e.y-t.y,i=e.z-t.z;return r*r+a*a+i*i}static distance(e,t){var r=e.x-t.x,a=e.y-t.y,i=e.z-t.z;return Math.sqrt(r*r+a*a+i*i)}static min(e,t,r){r.x=Math.min(e.x,t.x),r.y=Math.min(e.y,t.y),r.z=Math.min(e.z,t.z)}static max(e,t,r){r.x=Math.max(e.x,t.x),r.y=Math.max(e.y,t.y),r.z=Math.max(e.z,t.z)}static transformQuat(e,t,r){var a=e.x,i=e.y,s=e.z,n=t.x,o=t.y,l=t.z,h=t.w,u=h*a+o*s-l*i,d=h*i+l*a-n*s,_=h*s+n*i-o*a,c=-n*a-o*i-l*s;r.x=u*h+c*-n+d*-l-_*-o,r.y=d*h+c*-o+_*-n-u*-l,r.z=_*h+c*-l+u*-o-d*-n}static scalarLength(e){var t=e.x,r=e.y,a=e.z;return Math.sqrt(t*t+r*r+a*a)}static scalarLengthSquared(e){var t=e.x,r=e.y,a=e.z;return t*t+r*r+a*a}static normalize(e,t){var r=e.x,a=e.y,i=e.z,s=r*r+a*a+i*i;s>0&&(s=1/Math.sqrt(s),t.x=r*s,t.y=a*s,t.z=i*s)}static multiply(e,t,r){r.x=e.x*t.x,r.y=e.y*t.y,r.z=e.z*t.z}static scale(e,t,r){r.x=e.x*t,r.y=e.y*t,r.z=e.z*t}static lerp(e,t,r,a){var i=e.x,s=e.y,n=e.z;a.x=i+r*(t.x-i),a.y=s+r*(t.y-s),a.z=n+r*(t.z-n)}static transformV3ToV3(e,t,r){var a=Vector3._tempVector4;Vector3.transformV3ToV4(e,t,a),r.x=a.x,r.y=a.y,r.z=a.z}static transformV3ToV4(e,t,r){var a=e.x,i=e.y,s=e.z,n=t.elements;r.x=a*n[0]+i*n[4]+s*n[8]+n[12],r.y=a*n[1]+i*n[5]+s*n[9]+n[13],r.z=a*n[2]+i*n[6]+s*n[10]+n[14],r.w=a*n[3]+i*n[7]+s*n[11]+n[15]}static TransformNormal(e,t,r){var a=e.x,i=e.y,s=e.z,n=t.elements;r.x=a*n[0]+i*n[4]+s*n[8],r.y=a*n[1]+i*n[5]+s*n[9],r.z=a*n[2]+i*n[6]+s*n[10]}static transformCoordinate(e,t,r){var a=e.x,i=e.y,s=e.z,n=t.elements,o=a*n[3]+i*n[7]+s*n[11]+n[15];r.x=(a*n[0]+i*n[4]+s*n[8]+n[12])/o,r.y=(a*n[1]+i*n[5]+s*n[9]+n[13])/o,r.z=(a*n[2]+i*n[6]+s*n[10]+n[14])/o}static Clamp(e,t,r,a){var i=e.x,s=e.y,n=e.z,o=t.x,l=t.y,h=t.z,u=r.x,d=r.y,_=r.z;i=(i=i>u?u:i)<o?o:i,s=(s=s>d?d:s)<l?l:s,n=(n=n>_?_:n)<h?h:n,a.x=i,a.y=s,a.z=n}static add(e,t,r){r.x=e.x+t.x,r.y=e.y+t.y,r.z=e.z+t.z}static subtract(e,t,r){r.x=e.x-t.x,r.y=e.y-t.y,r.z=e.z-t.z}static cross(e,t,r){var a=e.x,i=e.y,s=e.z,n=t.x,o=t.y,l=t.z;r.x=i*l-s*o,r.y=s*n-a*l,r.z=a*o-i*n}static dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}static equals(e,t){return MathUtils3D.nearEqual(e.x,t.x)&&MathUtils3D.nearEqual(e.y,t.y)&&MathUtils3D.nearEqual(e.z,t.z)}constructor(e=0,t=0,r=0){this.x=e,this.y=t,this.z=r}equal(e){return Vector3.equals(this,e)}setValue(e,t,r){return this.x=e,this.y=t,this.z=r,this}set(e,t,r){return this.x=e,this.y=t,this.z=r,this}fromArray(e,t=0){this.x=e[t+0],this.y=e[t+1],this.z=e[t+2]}toArray(){return[this.x,this.y,this.z]}writeTo(e,t=0){e[t+0]=this.x,e[t+1]=this.y,e[t+2]=this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z}vsub(e,t){return t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z,t}vadd(e,t){return t.x=this.x+e.x,t.y=this.y+e.y,t.z=this.z+e.z,t}scale(e,t){return t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t}normalize(){let e=this.x,t=this.y,r=this.z;var a=e*e+t*t+r*r;return a>0&&(a=1/Math.sqrt(a),this.x=e*a,this.y=t*a,this.z=r*a),this}dot(e){return this.x*e.x+this.y*e.y+this.z*e.z}cross(e,t){var r=this.x,a=this.y,i=this.z,s=e.x,n=e.y,o=e.z;return t.x=a*o-i*n,t.y=i*s-r*o,t.z=r*n-a*s,t}cloneTo(e){var t=e;t.x=this.x,t.y=this.y,t.z=this.z}clone(){var e=new Vector3;return this.cloneTo(e),e}toDefault(){this.x=0,this.y=0,this.z=0}}Vector3._tempVector4=new Vector4,Vector3._tempVector3=new Vector3,Vector3.ZERO=new Vector3(0,0,0),Vector3.ONE=new Vector3(1,1,1),Vector3.NegativeUnitX=new Vector3(-1,0,0),Vector3.UnitX=new Vector3(1,0,0),Vector3.UnitY=new Vector3(0,1,0),Vector3.UnitZ=new Vector3(0,0,1),Vector3.ForwardRH=new Vector3(0,0,-1),Vector3.ForwardLH=new Vector3(0,0,1),Vector3.Up=new Vector3(0,1,0);const G=new Float32Array([1,0,0,0,1,0,0,0,1]),V=new Vector3,k=new Vector3,H=new Vector3;class Matrix3x3{static createRotationQuaternion(e,t){var r=e.x,a=e.y,i=e.z,s=e.w,n=r*r,o=a*a,l=i*i,h=r*a,u=i*s,d=i*r,_=a*s,c=a*i,p=r*s,m=t.elements;m[0]=1-2*(o+l),m[1]=2*(h+u),m[2]=2*(d-_),m[3]=2*(h-u),m[4]=1-2*(l+n),m[5]=2*(c+p),m[6]=2*(d+_),m[7]=2*(c-p),m[8]=1-2*(o+n)}static createFromTranslation(e,t){var r=t.elements;r[0]=1,r[1]=0,r[2]=0,r[3]=0,r[4]=1,r[5]=0,r[6]=e.x,r[7]=e.y,r[8]=1}static createFromRotation(e,t){var r=t.elements,a=Math.sin(e),i=Math.cos(e);r[0]=i,r[1]=a,r[2]=0,r[3]=-a,r[4]=i,r[5]=0,r[6]=0,r[7]=0,r[8]=1}static createFromScaling(e,t){var r=t.elements;r[0]=e.x,r[1]=0,r[2]=0,r[3]=0,r[4]=e.y,r[5]=0,r[6]=0,r[7]=0,r[8]=e.z}static createFromMatrix4x4(e,t){var r=e.elements,a=t.elements;a[0]=r[0],a[1]=r[1],a[2]=r[2],a[3]=r[4],a[4]=r[5],a[5]=r[6],a[6]=r[8],a[7]=r[9],a[8]=r[10]}static multiply(e,t,r){var a=e.elements,i=t.elements,s=r.elements,n=a[0],o=a[1],l=a[2],h=a[3],u=a[4],d=a[5],_=a[6],c=a[7],p=a[8],m=i[0],f=i[1],g=i[2],T=i[3],S=i[4],x=i[5],y=i[6],E=i[7],R=i[8];s[0]=m*n+f*h+g*_,s[1]=m*o+f*u+g*E,s[2]=m*l+f*d+g*p,s[3]=T*n+S*h+x*_,s[4]=T*o+S*u+x*c,s[5]=T*l+S*d+x*p,s[6]=y*n+E*h+R*_,s[7]=y*o+E*u+R*c,s[8]=y*l+E*d+R*p}constructor(e=!0){e&&(this.elements=G.slice())}cloneByArray(e){this.elements.set(e)}determinant(){var e=this.elements,t=e[0],r=e[1],a=e[2],i=e[3],s=e[4],n=e[5],o=e[6],l=e[7],h=e[8];return t*(h*s-n*l)+r*(-h*i+n*o)+a*(l*i-s*o)}translate(e,t){var r=t.elements,a=this.elements,i=a[0],s=a[1],n=a[2],o=a[3],l=a[4],h=a[5],u=a[6],d=a[7],_=a[8],c=e.x,p=e.y;r[0]=i,r[1]=s,r[2]=n,r[3]=o,r[4]=l,r[5]=h,r[6]=c*i+p*o+u,r[7]=c*s+p*l+d,r[8]=c*n+p*h+_}rotate(e,t){var r=t.elements,a=this.elements,i=a[0],s=a[1],n=a[2],o=a[3],l=a[4],h=a[5],u=a[6],d=a[7],_=a[8],c=Math.sin(e),p=Math.cos(e);r[0]=p*i+c*o,r[1]=p*s+c*l,r[2]=p*n+c*h,r[3]=p*o-c*i,r[4]=p*l-c*s,r[5]=p*h-c*n,r[6]=u,r[7]=d,r[8]=_}scale(e,t){var r=t.elements,a=this.elements,i=e.x,s=e.y;r[0]=i*a[0],r[1]=i*a[1],r[2]=i*a[2],r[3]=s*a[3],r[4]=s*a[4],r[5]=s*a[5],r[6]=a[6],r[7]=a[7],r[8]=a[8]}invert(e){var t=e.elements,r=this.elements,a=r[0],i=r[1],s=r[2],n=r[3],o=r[4],l=r[5],h=r[6],u=r[7],d=r[8],_=d*o-l*u,c=-d*n+l*h,p=u*n-o*h,m=a*_+i*c+s*p;m&&(m=1/m,t[0]=_*m,t[1]=(-d*i+s*u)*m,t[2]=(l*i-s*o)*m,t[3]=c*m,t[4]=(d*a-s*h)*m,t[5]=(-l*a+s*n)*m,t[6]=p*m,t[7]=(-u*a+i*h)*m,t[8]=(o*a-i*n)*m)}transpose(e){var t=e.elements,r=this.elements;if(e===this){var a=r[1],i=r[2],s=r[5];t[1]=r[3],t[2]=r[6],t[3]=a,t[5]=r[7],t[6]=i,t[7]=s}else t[0]=r[0],t[1]=r[3],t[2]=r[6],t[3]=r[1],t[4]=r[4],t[5]=r[7],t[6]=r[2],t[7]=r[5],t[8]=r[8]}identity(){this.elements.set(G)}cloneTo(e){var t,r;(t=this.elements)!==(r=e.elements)&&r.set(t)}clone(){var e=new Matrix3x3(!1);return e.elements=this.elements.slice(),e}static lookAt(e,t,r,a){Vector3.subtract(e,t,V),Vector3.normalize(V,V),Vector3.cross(r,V,k),Vector3.normalize(k,k),Vector3.cross(V,k,H);var i=V,s=k,n=H,o=a.elements;o[0]=s.x,o[3]=s.y,o[6]=s.z,o[1]=n.x,o[4]=n.y,o[7]=n.z,o[2]=i.x,o[5]=i.y,o[8]=i.z}static forwardLookAt(e,t,r,a){var i=k,s=H,n=V;t.vsub(e,n).normalize(),r.cross(n,i).normalize(),n.cross(i,s);var o=a.elements;o[0]=i.x,o[1]=i.y,o[2]=i.z,o[3]=s.x,o[4]=s.y,o[5]=s.z,o[6]=n.x,o[7]=n.y,o[8]=n.z}}Matrix3x3.DEFAULT=new Matrix3x3,Matrix3x3.Temp=new Matrix3x3;const W=new Vector3,X=new Vector3,Y=new Vector3,z=new Vector3,j=new Matrix3x3;class Quaternion{static createFromYawPitchRoll(e,t,r,a){var i=.5*r,s=.5*t,n=.5*e,o=Math.sin(i),l=Math.cos(i),h=Math.sin(s),u=Math.cos(s),d=Math.sin(n),_=Math.cos(n);a.x=_*h*l+d*u*o,a.y=d*u*l-_*h*o,a.z=_*u*o-d*h*l,a.w=_*u*l+d*h*o}static multiply(e,t,r){var a=e.x,i=e.y,s=e.z,n=e.w,o=t.x,l=t.y,h=t.z,u=t.w,d=i*h-s*l,_=s*o-a*h,c=a*l-i*o,p=a*o+i*l+s*h;r.x=a*u+o*n+d,r.y=i*u+l*n+_,r.z=s*u+h*n+c,r.w=n*u-p}static rotationAxisAngle(e,t,r){const a=Vector3._tempVector3;Vector3.normalize(e,a),t*=.5;const i=Math.sin(t);r.x=a.x*i,r.y=a.y*i,r.z=a.z*i,r.w=Math.cos(t)}static arcTanAngle(e,t){return 0==e?1==t?Math.PI/2:-Math.PI/2:e>0?Math.atan(t/e):e<0?t>0?Math.atan(t/e)+Math.PI:Math.atan(t/e)-Math.PI:0}static angleTo(e,t,r){Vector3.subtract(t,e,W),Vector3.normalize(W,W),r.x=Math.asin(W.y),r.y=Quaternion.arcTanAngle(-W.z,-W.x)}static createFromAxisAngle(e,t,r){t*=.5;var a=Math.sin(t);r.x=a*e.x,r.y=a*e.y,r.z=a*e.z,r.w=Math.cos(t)}static createFromMatrix4x4(e,t){var r,a,i=e.elements,s=i[0]+i[5]+i[10];s>0?(r=Math.sqrt(s+1),t.w=.5*r,r=.5/r,t.x=(i[6]-i[9])*r,t.y=(i[8]-i[2])*r,t.z=(i[1]-i[4])*r):i[0]>=i[5]&&i[0]>=i[10]?(a=.5/(r=Math.sqrt(1+i[0]-i[5]-i[10])),t.x=.5*r,t.y=(i[1]+i[4])*a,t.z=(i[2]+i[8])*a,t.w=(i[6]-i[9])*a):i[5]>i[10]?(a=.5/(r=Math.sqrt(1+i[5]-i[0]-i[10])),t.x=(i[4]+i[1])*a,t.y=.5*r,t.z=(i[9]+i[6])*a,t.w=(i[8]-i[2])*a):(a=.5/(r=Math.sqrt(1+i[10]-i[0]-i[5])),t.x=(i[8]+i[2])*a,t.y=(i[9]+i[6])*a,t.z=.5*r,t.w=(i[1]-i[4])*a)}static slerp(e,t,r,a){var i,s,n,o,l,h=e.x,u=e.y,d=e.z,_=e.w,c=t.x,p=t.y,m=t.z,f=t.w;return(s=h*c+u*p+d*m+_*f)<0&&(s=-s,c=-c,p=-p,m=-m,f=-f),1-s>1e-6?(i=Math.acos(s),n=Math.sin(i),o=Math.sin((1-r)*i)/n,l=Math.sin(r*i)/n):(o=1-r,l=r),a.x=o*h+l*c,a.y=o*u+l*p,a.z=o*d+l*m,a.w=o*_+l*f,a}static lerp(e,t,r,a){var i=1-r;Quaternion.dot(e,t)>=0?(a.x=i*e.x+r*t.x,a.y=i*e.y+r*t.y,a.z=i*e.z+r*t.z,a.w=i*e.w+r*t.w):(a.x=i*e.x-r*t.x,a.y=i*e.y-r*t.y,a.z=i*e.z-r*t.z,a.w=i*e.w-r*t.w),a.normalize(a)}static add(e,t,r){r.x=e.x+t.x,r.y=e.y+t.y,r.z=e.z+t.z,r.w=e.w+t.w}static dot(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w}constructor(e=0,t=0,r=0,a=1){this.x=e,this.y=t,this.z=r,this.w=a}setValue(e,t,r,a){this.x=e,this.y=t,this.z=r,this.w=a}set(e,t,r,a){return this.x=e,this.y=t,this.z=r,this.w=a,this}scaling(e,t){t.x=this.x*e,t.y=this.y*e,t.z=this.z*e,t.w=this.w*e}normalize(e){var t=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;t>0&&(t=1/Math.sqrt(t),e.x=this.x*t,e.y=this.y*t,e.z=this.z*t,e.w=this.w*t)}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}rotateX(e,t){e*=.5;var r=Math.sin(e),a=Math.cos(e);t.x=this.x*a+this.w*r,t.y=this.y*a+this.z*r,t.z=this.z*a-this.y*r,t.w=this.w*a-this.x*r}rotateY(e,t){e*=.5;var r=Math.sin(e),a=Math.cos(e);t.x=this.x*a-this.z*r,t.y=this.y*a+this.w*r,t.z=this.z*a+this.x*r,t.w=this.w*a-this.y*r}rotateZ(e,t){e*=.5;var r=Math.sin(e),a=Math.cos(e);t.x=this.x*a+this.y*r,t.y=this.y*a-this.x*r,t.z=this.z*a+this.w*r,t.w=this.w*a-this.z*r}getYawPitchRoll(e){Vector3.transformQuat(Vector3.ForwardRH,this,X),Vector3.transformQuat(Vector3.Up,this,Y);var t=Y;Quaternion.angleTo(Vector3.ZERO,X,z);var r=z;r.x==Math.PI/2?(r.y=Quaternion.arcTanAngle(t.z,t.x),r.z=0):r.x==-Math.PI/2?(r.y=Quaternion.arcTanAngle(-t.z,-t.x),r.z=0):(Matrix4x4.createRotationY(-r.y,Matrix4x4.TEMPMatrix0),Matrix4x4.createRotationX(-r.x,Matrix4x4.TEMPMatrix1),Vector3.transformCoordinate(Y,Matrix4x4.TEMPMatrix0,Y),Vector3.transformCoordinate(Y,Matrix4x4.TEMPMatrix1,Y),r.z=Quaternion.arcTanAngle(t.y,-t.x)),r.y<=-Math.PI&&(r.y=Math.PI),r.z<=-Math.PI&&(r.z=Math.PI),r.y>=Math.PI&&r.z>=Math.PI&&(r.y=0,r.z=0,r.x=Math.PI-r.x);var a=e;a.x=r.y,a.y=r.x,a.z=r.z}invert(e){var t=this.x,r=this.y,a=this.z,i=this.w,s=t*t+r*r+a*a+i*i,n=s?1/s:0;e.x=-t*n,e.y=-r*n,e.z=-a*n,e.w=i*n}identity(){this.x=0,this.y=0,this.z=0,this.w=1}fromArray(e,t=0){this.x=e[t+0],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3]}cloneTo(e){this!==e&&(e.x=this.x,e.y=this.y,e.z=this.z,e.w=this.w)}clone(){var e=new Quaternion;return this.cloneTo(e),e}equals(e){return MathUtils3D.nearEqual(this.x,e.x)&&MathUtils3D.nearEqual(this.y,e.y)&&MathUtils3D.nearEqual(this.z,e.z)&&MathUtils3D.nearEqual(this.w,e.w)}static rotationLookAt(e,t,r){Quaternion.lookAt(Vector3.ZERO,e,t,r)}static lookAt(e,t,r,a){Matrix3x3.lookAt(e,t,r,j),Quaternion.rotationMatrix(j,a)}static forwardLookAt(e,t,r,a){Matrix3x3.forwardLookAt(e,t,r,j),Quaternion.rotationMatrix(j,a)}lengthSquared(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}static invert(e,t){var r=e.lengthSquared();MathUtils3D.isZero(r)||(r=1/r,t.x=-e.x*r,t.y=-e.y*r,t.z=-e.z*r,t.w=e.w*r)}static rotationMatrix(e,t){var r,a,i=e.elements,s=i[0],n=i[1],o=i[2],l=i[3],h=i[4],u=i[5],d=i[6],_=i[7],c=i[8],p=s+h+c;p>0?(r=Math.sqrt(p+1),t.w=.5*r,r=.5/r,t.x=(u-_)*r,t.y=(d-o)*r,t.z=(n-l)*r):s>=h&&s>=c?(a=.5/(r=Math.sqrt(1+s-h-c)),t.x=.5*r,t.y=(n+l)*a,t.z=(o+d)*a,t.w=(u-_)*a):h>c?(a=.5/(r=Math.sqrt(1+h-s-c)),t.x=(l+n)*a,t.y=.5*r,t.z=(_+u)*a,t.w=(d-o)*a):(a=.5/(r=Math.sqrt(1+c-s-h)),t.x=(d+o)*a,t.y=(_+u)*a,t.z=.5*r,t.w=(n-l)*a)}forNativeElement(e=null){e?(this.elements=e,this.elements[0]=this.x,this.elements[1]=this.y,this.elements[2]=this.z,this.elements[3]=this.w):this.elements=new Float32Array([this.x,this.y,this.z,this.w]),Vector2.rewriteNumProperty(this,"x",0),Vector2.rewriteNumProperty(this,"y",1),Vector2.rewriteNumProperty(this,"z",2),Vector2.rewriteNumProperty(this,"w",3)}}Quaternion.TEMP=new Quaternion,Quaternion.DEFAULT=new Quaternion,Quaternion.NAN=new Quaternion(NaN,NaN,NaN,NaN);const K=new Vector3,q=new Vector3,Q=new Vector3,$=new Vector3,Z=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]);class Matrix4x4{static createRotationX(e,t){var r=t.elements,a=Math.sin(e),i=Math.cos(e);r[1]=r[2]=r[3]=r[4]=r[7]=r[8]=r[11]=r[12]=r[13]=r[14]=0,r[0]=r[15]=1,r[5]=r[10]=i,r[6]=a,r[9]=-a}static createRotationY(e,t){var r=t.elements,a=Math.sin(e),i=Math.cos(e);r[1]=r[3]=r[4]=r[6]=r[7]=r[9]=r[11]=r[12]=r[13]=r[14]=0,r[5]=r[15]=1,r[0]=r[10]=i,r[2]=-a,r[8]=a}static createRotationZ(e,t){var r=t.elements,a=Math.sin(e),i=Math.cos(e);r[2]=r[3]=r[6]=r[7]=r[8]=r[9]=r[11]=r[12]=r[13]=r[14]=0,r[10]=r[15]=1,r[0]=r[5]=i,r[1]=a,r[4]=-a}static createRotationYawPitchRoll(e,t,r,a){Quaternion.createFromYawPitchRoll(e,t,r,Quaternion.TEMP),Matrix4x4.createRotationQuaternion(Quaternion.TEMP,a)}static createRotationAxis(e,t,r){var a=e.x,i=e.y,s=e.z,n=Math.cos(t),o=Math.sin(t),l=a*a,h=i*i,u=s*s,d=a*i,_=a*s,c=i*s,p=r.elements;p[3]=p[7]=p[11]=p[12]=p[13]=p[14]=0,p[15]=1,p[0]=l+n*(1-l),p[1]=d-n*d+o*s,p[2]=_-n*_-o*i,p[4]=d-n*d-o*s,p[5]=h+n*(1-h),p[6]=c-n*c+o*a,p[8]=_-n*_+o*i,p[9]=c-n*c-o*a,p[10]=u+n*(1-u)}static createRotationQuaternion(e,t){var r=t.elements,a=e.x,i=e.y,s=e.z,n=e.w,o=a*a,l=i*i,h=s*s,u=a*i,d=s*n,_=s*a,c=i*n,p=i*s,m=a*n;r[3]=r[7]=r[11]=r[12]=r[13]=r[14]=0,r[15]=1,r[0]=1-2*(l+h),r[1]=2*(u+d),r[2]=2*(_-c),r[4]=2*(u-d),r[5]=1-2*(h+o),r[6]=2*(p+m),r[8]=2*(_+c),r[9]=2*(p-m),r[10]=1-2*(l+o)}static createTranslate(e,t){var r=t.elements;r[4]=r[8]=r[1]=r[9]=r[2]=r[6]=r[3]=r[7]=r[11]=0,r[0]=r[5]=r[10]=r[15]=1,r[12]=e.x,r[13]=e.y,r[14]=e.z}static createScaling(e,t){var r=t.elements;r[0]=e.x,r[5]=e.y,r[10]=e.z,r[1]=r[4]=r[8]=r[12]=r[9]=r[13]=r[2]=r[6]=r[14]=r[3]=r[7]=r[11]=0,r[15]=1}static multiply(e,t,r){var a=t.elements,i=e.elements,s=r.elements,n=a[0],o=a[1],l=a[2],h=a[3],u=a[4],d=a[5],_=a[6],c=a[7],p=a[8],m=a[9],f=a[10],g=a[11],T=a[12],S=a[13],x=a[14],y=a[15],E=i[0],R=i[1],b=i[2],C=i[3],v=i[4],D=i[5],M=i[6],A=i[7],L=i[8],I=i[9],w=i[10],B=i[11],P=i[12],F=i[13],N=i[14],O=i[15];s[0]=n*E+o*v+l*L+h*P,s[1]=n*R+o*D+l*I+h*F,s[2]=n*b+o*M+l*w+h*N,s[3]=n*C+o*A+l*B+h*O,s[4]=u*E+d*v+_*L+c*P,s[5]=u*R+d*D+_*I+c*F,s[6]=u*b+d*M+_*w+c*N,s[7]=u*C+d*A+_*B+c*O,s[8]=p*E+m*v+f*L+g*P,s[9]=p*R+m*D+f*I+g*F,s[10]=p*b+m*M+f*w+g*N,s[11]=p*C+m*A+f*B+g*O,s[12]=T*E+S*v+x*L+y*P,s[13]=T*R+S*D+x*I+y*F,s[14]=T*b+S*M+x*w+y*N,s[15]=T*C+S*A+x*B+y*O}static createFromQuaternion(e,t){var r=t.elements,a=e.x,i=e.y,s=e.z,n=e.w,o=a+a,l=i+i,h=s+s,u=a*o,d=i*o,_=i*l,c=s*o,p=s*l,m=s*h,f=n*o,g=n*l,T=n*h;r[0]=1-_-m,r[1]=d+T,r[2]=c-g,r[3]=0,r[4]=d-T,r[5]=1-u-m,r[6]=p+f,r[7]=0,r[8]=c+g,r[9]=p-f,r[10]=1-u-_,r[11]=0,r[12]=0,r[13]=0,r[14]=0,r[15]=1}static createAffineTransformation(e,t,r,a){var i=a.elements,s=t.x,n=t.y,o=t.z,l=t.w,h=s+s,u=n+n,d=o+o,_=s*h,c=s*u,p=s*d,m=n*u,f=n*d,g=o*d,T=l*h,S=l*u,x=l*d,y=r.x,E=r.y,R=r.z;i[0]=(1-(m+g))*y,i[1]=(c+x)*y,i[2]=(p-S)*y,i[3]=0,i[4]=(c-x)*E,i[5]=(1-(_+g))*E,i[6]=(f+T)*E,i[7]=0,i[8]=(p+S)*R,i[9]=(f-T)*R,i[10]=(1-(_+m))*R,i[11]=0,i[12]=e.x,i[13]=e.y,i[14]=e.z,i[15]=1}static createLookAt(e,t,r,a){var i=a.elements,s=K,n=q,o=Q;Vector3.subtract(e,t,o),Vector3.normalize(o,o),Vector3.cross(r,o,s),Vector3.normalize(s,s),Vector3.cross(o,s,n),i[3]=i[7]=i[11]=0,i[15]=1,i[0]=s.x,i[4]=s.y,i[8]=s.z,i[1]=n.x,i[5]=n.y,i[9]=n.z,i[2]=o.x,i[6]=o.y,i[10]=o.z,i[12]=-Vector3.dot(s,e),i[13]=-Vector3.dot(n,e),i[14]=-Vector3.dot(o,e)}static createPerspective(e,t,r,a,i){var s=1/Math.tan(.5*e),n=r/(s/t),o=r/s;Matrix4x4.createPerspectiveOffCenter(-n,n,-o,o,r,a,i)}static createPerspectiveOffCenter(e,t,r,a,i,s,n){var o=n.elements,l=s/(s-i);o[1]=o[2]=o[3]=o[4]=o[6]=o[7]=o[12]=o[13]=o[15]=0,o[0]=2*i/(t-e),o[5]=2*i/(a-r),o[8]=(e+t)/(t-e),o[9]=(a+r)/(a-r),o[10]=-l,o[11]=-1,o[14]=-i*l}static createOrthoOffCenter(e,t,r,a,i,s,n){var o=n.elements,l=1/(s-i);o[1]=o[2]=o[3]=o[4]=o[6]=o[8]=o[7]=o[9]=o[11]=0,o[15]=1,o[0]=2/(t-e),o[5]=2/(a-r),o[10]=-l,o[12]=(e+t)/(e-t),o[13]=(a+r)/(r-a),o[14]=-i*l}constructor(e=1,t=0,r=0,a=0,i=0,s=1,n=0,o=0,l=0,h=0,u=1,d=0,_=0,c=0,p=0,m=1,f=null){if(0!=arguments.length){if(1!==arguments.length||null!==arguments[0]){var g=this.elements=f||new Float32Array(16);g[0]=e,g[1]=t,g[2]=r,g[3]=a,g[4]=i,g[5]=s,g[6]=n,g[7]=o,g[8]=l,g[9]=h,g[10]=u,g[11]=d,g[12]=_,g[13]=c,g[14]=p,g[15]=m}}else this.elements=Z.slice()}getElementByRowColumn(e,t){if(e<0||e>3)throw new Error("row Rows and columns for matrices run from 0 to 3, inclusive.");if(t<0||t>3)throw new Error("column Rows and columns for matrices run from 0 to 3, inclusive.");return this.elements[4*e+t]}setElementByRowColumn(e,t,r){if(e<0||e>3)throw new Error("row Rows and columns for matrices run from 0 to 3, inclusive.");if(t<0||t>3)throw new Error("column Rows and columns for matrices run from 0 to 3, inclusive.");this.elements[4*e+t]=r}setRotation(e){var t=e.x,r=e.y,a=e.z,i=e.w,s=t*t,n=r*r,o=a*a,l=t*r,h=a*i,u=a*t,d=r*i,_=r*a,c=t*i,p=this.elements;p[0]=1-2*(n+o),p[1]=2*(l+h),p[2]=2*(u-d),p[4]=2*(l-h),p[5]=1-2*(o+s),p[6]=2*(_+c),p[8]=2*(u+d),p[9]=2*(_-c),p[10]=1-2*(n+s)}setPosition(e){var t=this.elements;t[12]=e.x,t[13]=e.y,t[14]=e.z}equalsOtherMatrix(e){var t=this.elements,r=e.elements;return MathUtils3D.nearEqual(t[0],r[0])&&MathUtils3D.nearEqual(t[1],r[1])&&MathUtils3D.nearEqual(t[2],r[2])&&MathUtils3D.nearEqual(t[3],r[3])&&MathUtils3D.nearEqual(t[4],r[4])&&MathUtils3D.nearEqual(t[5],r[5])&&MathUtils3D.nearEqual(t[6],r[6])&&MathUtils3D.nearEqual(t[7],r[7])&&MathUtils3D.nearEqual(t[8],r[8])&&MathUtils3D.nearEqual(t[9],r[9])&&MathUtils3D.nearEqual(t[10],r[10])&&MathUtils3D.nearEqual(t[11],r[11])&&MathUtils3D.nearEqual(t[12],r[12])&&MathUtils3D.nearEqual(t[13],r[13])&&MathUtils3D.nearEqual(t[14],r[14])&&MathUtils3D.nearEqual(t[15],r[15])}decomposeTransRotScale(e,t,r){var a=J;return this.decomposeTransRotMatScale(e,a,r)?(Quaternion.createFromMatrix4x4(a,t),!0):(t.identity(),!1)}decomposeTransRotMatScale(e,t,r){var a=this.elements,i=e,s=t.elements,n=r;i.x=a[12],i.y=a[13],i.z=a[14];var o=a[0],l=a[1],h=a[2],u=a[4],d=a[5],_=a[6],c=a[8],p=a[9],m=a[10],f=n.x=Math.sqrt(o*o+l*l+h*h),g=n.y=Math.sqrt(u*u+d*d+_*_),T=n.z=Math.sqrt(c*c+p*p+m*m);if(MathUtils3D.isZero(f)||MathUtils3D.isZero(g)||MathUtils3D.isZero(T))return s[1]=s[2]=s[3]=s[4]=s[6]=s[7]=s[8]=s[9]=s[11]=s[12]=s[13]=s[14]=0,s[0]=s[5]=s[10]=s[15]=1,!1;var S=K;S.x=c/T,S.y=p/T,S.z=m/T;var x=q;x.x=o/f,x.y=l/f,x.z=h/f;var y=Q;Vector3.cross(S,x,y);var E=q;return Vector3.cross(y,S,E),s[3]=s[7]=s[11]=s[12]=s[13]=s[14]=0,s[15]=1,s[0]=E.x,s[1]=E.y,s[2]=E.z,s[4]=y.x,s[5]=y.y,s[6]=y.z,s[8]=S.x,s[9]=S.y,s[10]=S.z,s[0]*o+s[1]*l+s[2]*h<0&&(n.x=-f),s[4]*u+s[5]*d+s[6]*_<0&&(n.y=-g),s[8]*c+s[9]*p+s[10]*m<0&&(n.z=-T),!0}decomposeYawPitchRoll(e){var t=Math.asin(-this.elements[9]);e.y=t,Math.cos(t)>MathUtils3D.zeroTolerance?(e.z=Math.atan2(this.elements[1],this.elements[5]),e.x=Math.atan2(this.elements[8],this.elements[10])):(e.z=Math.atan2(-this.elements[4],this.elements[0]),e.x=0)}normalize(){var e=this.elements,t=e[0],r=e[1],a=e[2],i=Math.sqrt(t*t+r*r+a*a);if(!i)return e[0]=0,e[1]=0,void(e[2]=0);1!=i&&(i=1/i,e[0]=t*i,e[1]=r*i,e[2]=a*i)}transpose(){var e,t;return t=(e=this.elements)[1],e[1]=e[4],e[4]=t,t=e[2],e[2]=e[8],e[8]=t,t=e[3],e[3]=e[12],e[12]=t,t=e[6],e[6]=e[9],e[9]=t,t=e[7],e[7]=e[13],e[13]=t,t=e[11],e[11]=e[14],e[14]=t,this}invert(e){var t=this.elements,r=e.elements,a=t[0],i=t[1],s=t[2],n=t[3],o=t[4],l=t[5],h=t[6],u=t[7],d=t[8],_=t[9],c=t[10],p=t[11],m=t[12],f=t[13],g=t[14],T=t[15],S=a*l-i*o,x=a*h-s*o,y=a*u-n*o,E=i*h-s*l,R=i*u-n*l,b=s*u-n*h,C=d*f-_*m,v=d*g-c*m,D=d*T-p*m,M=_*g-c*f,A=_*T-p*f,L=c*T-p*g,I=S*L-x*A+y*M+E*D-R*v+b*C;0!==Math.abs(I)&&(I=1/I,r[0]=(l*L-h*A+u*M)*I,r[1]=(s*A-i*L-n*M)*I,r[2]=(f*b-g*R+T*E)*I,r[3]=(c*R-_*b-p*E)*I,r[4]=(h*D-o*L-u*v)*I,r[5]=(a*L-s*D+n*v)*I,r[6]=(g*y-m*b-T*x)*I,r[7]=(d*b-c*y+p*x)*I,r[8]=(o*A-l*D+u*C)*I,r[9]=(i*D-a*A-n*C)*I,r[10]=(m*R-f*y+T*S)*I,r[11]=(_*y-d*R-p*S)*I,r[12]=(l*v-o*M-h*C)*I,r[13]=(a*M-i*v+s*C)*I,r[14]=(f*x-m*E-g*S)*I,r[15]=(d*E-_*x+c*S)*I)}static billboard(e,t,r,a,i){Vector3.subtract(e,t,K);var s=Vector3.scalarLengthSquared(K);MathUtils3D.isZero(s)?(Vector3.scale(a,-1,q),q.cloneTo(K)):Vector3.scale(K,1/Math.sqrt(s),K),Vector3.cross(r,K,Q),Vector3.normalize(Q,Q),Vector3.cross(K,Q,$);var n=Q,o=$,l=K,h=e,u=i.elements;u[0]=n.x,u[1]=n.y,u[2]=n.z,u[3]=0,u[4]=o.x,u[5]=o.y,u[6]=o.z,u[7]=0,u[8]=l.x,u[9]=l.y,u[10]=l.z,u[11]=0,u[12]=h.x,u[13]=h.y,u[14]=h.z,u[15]=1}identity(){this.elements.set(Z)}isIdentity(){let e=this.elements,t=Matrix4x4.DEFAULT.elements;for(let i=0,s=e.length;i<s;i++)if(r=e[i],a=t[i],!(Math.abs(r-a)<1e-7))return!1;var r,a;return!0}cloneTo(e){this.elements!==e.elements&&e.elements.set(this.elements)}cloneByArray(e){this.elements.set(e)}clone(){var e=new Matrix4x4(null);return e.elements=this.elements.slice(),e}static translation(e,t){var r=t.elements;r[0]=r[5]=r[10]=r[15]=1,r[12]=e.x,r[13]=e.y,r[14]=e.z}getTranslationVector(e){var t=this.elements;e.x=t[12],e.y=t[13],e.z=t[14]}setTranslationVector(e){var t=this.elements,r=e;t[12]=r.x,t[13]=r.y,t[14]=r.z}getForward(e){var t=this.elements;e.x=-t[8],e.y=-t[9],e.z=-t[10]}setForward(e){var t=this.elements;t[8]=-e.x,t[9]=-e.y,t[10]=-e.z}getInvertFront(){this.decomposeTransRotScale(K,Quaternion.TEMP,q);var e=q,t=e.x<0;return e.y<0&&(t=!t),e.z<0&&(t=!t),t}}Matrix4x4.TEMPMatrix0=new Matrix4x4,Matrix4x4.TEMPMatrix1=new Matrix4x4,Matrix4x4.DEFAULT=new Matrix4x4,Matrix4x4.DEFAULTINVERT=new Matrix4x4(-1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),Matrix4x4.ZERO=new Matrix4x4(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const J=new Matrix4x4;class Texture2DArray extends BaseTexture{static get defaultTexture(){return this._defaultTexture}static __init__(){LayaGL.renderEngine.getCapable(e.RenderCapable.Texture3D)&&(this._defaultTexture=new Texture2DArray(1,1,1,e.TextureFormat.R8G8B8A8,!1,!1,!1),this._defaultTexture.lock=!0,this._defaultTexture.setPixelsData(new Uint8Array([255,255,255,255]),!1,!1))}constructor(t,r,a,i,s=!0,n,o=!1){super(t,r,i),this._dimension=e.TextureDimension.Texture2DArray,this._gammaSpace=o,this.depth=a;let l=LayaGL.textureContext;this._texture=l.createTexture3DInternal(this._dimension,t,r,a,i,s,o,!1)}setImageData(e,t,r){let a=this._texture;LayaGL.textureContext.setTexture3DImageData(a,e,this.depth,t,r)}setPixelsData(e,t,r){let a=this._texture;LayaGL.textureContext.setTexture3DPixelsData(a,e,this.depth,t,r)}setSubPixelsData(e,t,r,a,i,s,n,o,l,h,u){let d=this._texture;LayaGL.textureContext.setTexture3DSubPixelsData(d,n,o,l,e,t,r,a,i,s,h,u)}}var ee,te,re,ae;function ShaderDataDefaultValue(t){switch(t){case e.ShaderDataType.Int:return 0;case e.ShaderDataType.Bool:return!1;case e.ShaderDataType.Float:return 0;case e.ShaderDataType.Vector2:return Vector2.ZERO;case e.ShaderDataType.Vector3:return Vector3.ZERO;case e.ShaderDataType.Vector4:return Vector4.ZERO;case e.ShaderDataType.Color:return Color.BLACK;case e.ShaderDataType.Matrix4x4:return Matrix4x4.DEFAULT;case e.ShaderDataType.Matrix3x3:return Matrix3x3.DEFAULT;case e.ShaderDataType.Texture2DArray:case e.ShaderDataType.Texture3D:return Texture2DArray.defaultTexture;default:return null}}e.ShaderDataType=void 0,(ee=e.ShaderDataType||(e.ShaderDataType={}))[ee.Int=0]="Int",ee[ee.Bool=1]="Bool",ee[ee.Float=2]="Float",ee[ee.Vector2=3]="Vector2",ee[ee.Vector3=4]="Vector3",ee[ee.Vector4=5]="Vector4",ee[ee.Color=6]="Color",ee[ee.Matrix4x4=7]="Matrix4x4",ee[ee.Texture2D=8]="Texture2D",ee[ee.TextureCube=9]="TextureCube",ee[ee.Buffer=10]="Buffer",ee[ee.Matrix3x3=11]="Matrix3x3",ee[ee.Texture2DArray=12]="Texture2DArray",ee[ee.Texture3D=13]="Texture3D";class ShaderData{get uniformBufferDatas(){return this._uniformBufferDatas}get uniformBuffersMap(){return this._uniformBuffersMap}constructor(e=null){this._ownerResource=null,this.applyUBO=!1,this._data=null,this._defineDatas=new DefineDatas,this._ownerResource=e,this._initData(),this._uniformBufferDatas=new Map,this._uniformBuffersMap=new Map}_addCheckUBO(e,t,r){this._uniformBufferDatas.set(e,{ubo:t,uboBuffer:r}),r._uniformParamsState.forEach(((e,r)=>{this.uniformBuffersMap.set(r,t)})),t.setDataByUniformBufferData(r)}_initData(){this._data={},this._gammaColorMap=new Map}getData(){return this._data}applyUBOData(){this._uniformBufferDatas.forEach(((e,t)=>{e.ubo.setDataByUniformBufferData(e.uboBuffer)})),this.applyUBO=!1}addDefine(e){this._defineDatas.add(e)}removeDefine(e){this._defineDatas.remove(e)}hasDefine(e){return this._defineDatas.has(e)}clearDefine(){this._defineDatas.clear()}getBool(e){return this._data[e]}setBool(e,t){this._data[e]=t}getInt(e){return this._data[e]}setInt(e,t){this._data[e]=t;let r=this._uniformBuffersMap.get(e);r&&this._uniformBufferDatas.get(r._name).uboBuffer._setData(e,this.getInt(e))}getNumber(e){return this._data[e]}setNumber(e,t){this._data[e]=t;let r=this._uniformBuffersMap.get(e);r&&(this._uniformBufferDatas.get(r._name).uboBuffer._setData(e,this.getNumber(e)),this.applyUBO=!0)}getVector2(e){return this._data[e]}setVector2(e,t){this._data[e]?t.cloneTo(this._data[e]):this._data[e]=t.clone();let r=this._uniformBuffersMap.get(e);r&&(this._uniformBufferDatas.get(r._name).uboBuffer._setData(e,this.getVector2(e)),this.applyUBO=!0)}getVector3(e){return this._data[e]}setVector3(e,t){this._data[e]?t.cloneTo(this._data[e]):this._data[e]=t.clone();let r=this._uniformBuffersMap.get(e);r&&(this._uniformBufferDatas.get(r._name).uboBuffer._setData(e,this.getVector3(e)),this.applyUBO=!0)}getVector(e){return this._data[e]}setVector(e,t){this._data[e]?t.cloneTo(this._data[e]):this._data[e]=t.clone();let r=this._uniformBuffersMap.get(e);r&&(this._uniformBufferDatas.get(r._name).uboBuffer._setData(e,this.getVector(e)),this.applyUBO=!0)}getColor(e){return this._gammaColorMap.get(e)}setColor(e,t){if(!t)return;if(this._data[e]){let r=this._gammaColorMap.get(e);t.cloneTo(r);let a=this._data[e];a.x=Color.gammaToLinearSpace(t.r),a.y=Color.gammaToLinearSpace(t.g),a.z=Color.gammaToLinearSpace(t.b),a.w=t.a}else{let r=new Vector4;r.x=Color.gammaToLinearSpace(t.r),r.y=Color.gammaToLinearSpace(t.g),r.z=Color.gammaToLinearSpace(t.b),r.w=t.a,this._data[e]=r,this._gammaColorMap.set(e,t.clone())}let r=this._uniformBuffersMap.get(e);r&&(this._uniformBufferDatas.get(r._name).uboBuffer._setData(e,this.getLinearColor(e)),this.applyUBO=!0)}getLinearColor(e){return this._data[e]}getMatrix4x4(e){return this._data[e]}setMatrix4x4(e,t){this._data[e]?t.cloneTo(this._data[e]):this._data[e]=t.clone();let r=this._uniformBuffersMap.get(e);r&&(this._uniformBufferDatas.get(r._name).uboBuffer._setData(e,this.getMatrix4x4(e)),this.applyUBO=!0)}getMatrix3x3(e){return this._data[e]}setMatrix3x3(e,t){this._data[e]?t.cloneTo(this._data[e]):this._data[e]=t.clone();let r=this._uniformBuffersMap.get(e);r&&this._uniformBufferDatas.get(r._name).uboBuffer._setData(e,this.getMatrix3x3(e))}getBuffer(e){return this._data[e]}setBuffer(e,t){this._data[e]=t}setTexture(e,t){var r=this._data[e];if(t){let r=ShaderDefine._texGammaDefine[e];r&&t&&t.gammaCorrection>1?this.addDefine(r):r&&this.removeDefine(r)}this._data[e]=t,r&&r._removeReference(),t&&t._addReference()}getTexture(e){return this._data[e]}getSourceIndex(e){for(var t in this._data)if(this._data[t]==e)return Number(t);return-1}setValueData(e,t){if(t instanceof Color)return void this.setColor(e,t);t&&t.clone?this._data[e]=t.clone():this._data[e]=t;let r=this._uniformBuffersMap.get(e);r&&(this._uniformBufferDatas.get(r._name).uboBuffer._setData(e,this.getValueData(e)),this.applyUBO=!0)}setUniformBuffer(e,t){this._data[e]=t}getUniformBuffer(e){return this._data[e]}setShaderData(t,r,a){switch(r){case e.ShaderDataType.Int:this.setInt(t,a);break;case e.ShaderDataType.Bool:this.setBool(t,a);break;case e.ShaderDataType.Float:this.setNumber(t,a);break;case e.ShaderDataType.Vector2:this.setVector2(t,a);break;case e.ShaderDataType.Vector3:this.setVector3(t,a);break;case e.ShaderDataType.Vector4:this.setVector(t,a);break;case e.ShaderDataType.Color:this.setColor(t,a);break;case e.ShaderDataType.Matrix4x4:this.setMatrix4x4(t,a);break;case e.ShaderDataType.Matrix3x3:this.setMatrix3x3(t,a);break;case e.ShaderDataType.Texture2D:case e.ShaderDataType.TextureCube:case e.ShaderDataType.Texture2DArray:case e.ShaderDataType.Texture3D:this.setTexture(t,a);break;case e.ShaderDataType.Buffer:this.setBuffer(t,a);break;default:throw new Error(`unkown shader data type: ${r}`)}}getShaderData(t,r){switch(r){case e.ShaderDataType.Int:return this.getInt(t);case e.ShaderDataType.Bool:return this.getBool(t);case e.ShaderDataType.Float:return this.getNumber(t);case e.ShaderDataType.Vector2:return this.getVector2(t);case e.ShaderDataType.Vector3:return this.getVector3(t);case e.ShaderDataType.Vector4:return this.getVector(t);case e.ShaderDataType.Color:return this.getColor(t);case e.ShaderDataType.Matrix4x4:return this.getMatrix4x4(t);case e.ShaderDataType.Texture2D:case e.ShaderDataType.TextureCube:case e.ShaderDataType.Texture2DArray:case e.ShaderDataType.Texture3D:return this.getTexture(t);case e.ShaderDataType.Buffer:return this.getBuffer(t);case e.ShaderDataType.Matrix3x3:return this.getMatrix3x3(t);case e.ShaderDataType.Matrix4x4:return this.getMatrix4x4(t);default:throw"unkone shader data type."}}getValueData(e){return this._data[e]}cloneTo(e){var t=e,r=t._data;for(var a in this._data){var i=this._data[a];if(null!=i)if("number"==typeof i)r[a]=i;else if("number"==typeof i)r[a]=i;else if("boolean"==typeof i)r[a]=i;else if(i instanceof Vector2){var s=r[a]||(r[a]=new Vector2);i.cloneTo(s),r[a]=s}else if(i instanceof Vector3){var n=r[a]||(r[a]=new Vector3);i.cloneTo(n),r[a]=n}else if(i instanceof Vector4){let t=this.getColor(parseInt(a));if(t){let r=t.clone();e.setColor(parseInt(a),r)}else{var o=r[a]||(r[a]=new Vector4);i.cloneTo(o),r[a]=o}}else if(i instanceof Matrix3x3){let e=r[a]||(r[a]=new Matrix3x3);i.cloneTo(e),r[a]=e}else if(i instanceof Matrix4x4){var l=r[a]||(r[a]=new Matrix4x4);i.cloneTo(l),r[a]=l}else(i instanceof BaseTexture||i instanceof Resource)&&(r[a]=i,i._addReference())}this._defineDatas.cloneTo(t._defineDatas),this._gammaColorMap.forEach(((t,r)=>{e._gammaColorMap.set(r,t.clone())})),this._cloneUBO(t._uniformBufferDatas),t.applyUBO=!0}_cloneUBO(e){this._uniformBufferDatas.forEach(((t,r)=>{e.has(r)&&t.uboBuffer.cloneTo(e.get(r).uboBuffer)}))}clone(){var e=new ShaderData;return this.cloneTo(e),e}reset(){for(var e in this._data){var t=this._data[e];t instanceof Resource&&t._removeReference()}this._data={},this._gammaColorMap.clear(),this._uniformBufferDatas.clear(),this.applyUBO=!1,this._uniformBuffersMap.clear(),this._defineDatas.clear()}destroy(){for(var e in this._defineDatas.destroy(),this._defineDatas=null,this._data){var t=this._data[e];t instanceof Resource&&t._removeReference()}this._data=null,this._gammaColorMap.clear(),this._gammaColorMap=null,delete this._uniformBufferDatas,delete this._uniformBuffersMap,this._uniformBufferDatas=null,this._uniformBuffersMap=null}}e.UniformBufferParamsType=void 0,(te=e.UniformBufferParamsType||(e.UniformBufferParamsType={}))[te.Number=0]="Number",te[te.Vector2=1]="Vector2",te[te.Vector3=2]="Vector3",te[te.Vector4=3]="Vector4",te[te.Matrix4x4=4]="Matrix4x4",te[te.Vector4Array=5]="Vector4Array",te[te.MatrixArray=6]="MatrixArray";class UnifromBufferData{constructor(e){this._uniformParamsState=new Map(e),this._createBuffer(),this._updateFlag=new Vector2,this._resetUpdateFlag()}_createBuffer(){var e=0;this._layoutMap={};this._uniformParamsState.forEach(((t,r)=>{e+=this._addUniformParams(r,t,e)})),this._bytelength=4*Math.ceil(e/4)*4,this._buffer=new Float32Array(e)}_getArraySize(e){let t=e.indexOf("["),r=e.indexOf("]");if(-1!=t&&-1!=r&&t<r)return parseFloat(e.substring(t+1,r));throw e+" is illegal "}_addUniformParams(t,r,a){let i,s=0,n=0,o=a%4;switch(r){case e.UniformBufferParamsType.Number:s=1,n=1;break;case e.UniformBufferParamsType.Vector2:switch(s=2,o){case 0:case 2:n=2;break;case 1:case 3:a+=1,n=3}break;case e.UniformBufferParamsType.Vector3:switch(s=3,n=3,o){case 1:case 2:case 3:a+=4-o,n=4-o+3}break;case e.UniformBufferParamsType.Vector4:switch(s=4,o){case 0:n=4;break;case 1:a+=3,n=7;break;case 2:a+=2,n=6;break;case 3:a+=1,n=5}break;case e.UniformBufferParamsType.Matrix4x4:s=16,i=o?4-o:o,a+=i,n=s+i;break;case e.UniformBufferParamsType.Vector4Array:s=4*this._getArraySize(Shader3D.propertyIDToName(t)),i=o?4-o:o,a+=i,n=s+i;break;case e.UniformBufferParamsType.MatrixArray:s=16*this._getArraySize(Shader3D.propertyIDToName(t)),i=o?4-o:o,a+=i,n=s+i;break;default:throw"Unifrom Buffer Params Type is illegal "}const l=new Vector2(a,s);return this._layoutMap[t]=l,n}_getParamsInfo(e){return this._layoutMap[e]}_setUpdateFlag(e,t){e<this._updateFlag.x&&(this._updateFlag.x=e),t>this._updateFlag.y&&(this._updateFlag.y=t)}destroy(){delete this._buffer,this._uniformParamsState.clear(),this._uniformParamsState=null,this._layoutMap=null,this._updateFlag=null}_resetUpdateFlag(){this._updateFlag.setValue(this._buffer.length,0)}_has(e){return!!this._getParamsInfo(e)}_setData(t,r){switch(this._uniformParamsState.get(t)){case e.UniformBufferParamsType.Number:this.setNumberbyIndex(t,r);break;case e.UniformBufferParamsType.Vector2:this.setVector2byIndex(t,r);break;case e.UniformBufferParamsType.Vector3:this.setVector3byIndex(t,r);break;case e.UniformBufferParamsType.Vector4:this.setVector4byIndex(t,r);break;case e.UniformBufferParamsType.Matrix4x4:this.setMatrixbyIndex(t,r);break;case e.UniformBufferParamsType.Vector4Array:this.setVector4ArraybyIndex(t,r);break;case e.UniformBufferParamsType.MatrixArray:this.setMatrixArraybyIndex(t,r)}}getbyteLength(){return this._bytelength}setVector4Array(e,t){const r=Shader3D.propertyNameToID(e);this.setVector4ArraybyIndex(r,t)}setVector4ArraybyIndex(e,t){const r=this._getParamsInfo(e);if(!r)return;let a=r.x,i=r.y/4;for(let e=0;e<i;e++){let r=t[e];this._buffer[a++]=r.x,this._buffer[a++]=r.y,this._buffer[a++]=r.z,this._buffer[a++]=r.w}this._setUpdateFlag(r.x,a)}setMatrixArray(e,t){const r=Shader3D.propertyNameToID(e);this.setMatrixArraybyIndex(r,t)}setMatrixArraybyIndex(e,t){const r=this._getParamsInfo(e);if(!r)return;let a=r.x,i=r.y/4;for(let e=0;e<i;e++){let r=t[e];this._buffer.set(r.elements,a),a+=16}this._setUpdateFlag(r.x,a)}setNumber(e,t){const r=Shader3D.propertyNameToID(e);this.setNumberbyIndex(r,t)}setNumberbyIndex(e,t){const r=this._getParamsInfo(e);if(!r)return;let a=r.x;this._buffer[a++]=t,this._setUpdateFlag(r.x,a)}setVector2(e,t){const r=Shader3D.propertyNameToID(e);this.setVector2byIndex(r,t)}setVector2byIndex(e,t){const r=this._getParamsInfo(e);if(!r)return;let a=r.x;this._buffer[a++]=t.x,this._buffer[a++]=t.y,this._setUpdateFlag(r.x,a)}setVector3(e,t){const r=Shader3D.propertyNameToID(e);this.setVector3byIndex(r,t)}setVector3byIndex(e,t){const r=this._getParamsInfo(e);if(!r)return;let a=r.x;this._buffer[a++]=t.x,this._buffer[a++]=t.y,this._buffer[a++]=t.z,this._setUpdateFlag(r.x,a)}setVector4(e,t){const r=Shader3D.propertyNameToID(e);this.setVector4byIndex(r,t)}setVector4byIndex(e,t){const r=this._getParamsInfo(e);if(!r)return;let a=r.x;this._buffer[a++]=t.x,this._buffer[a++]=t.y,this._buffer[a++]=t.z,this._buffer[a++]=t.w,this._setUpdateFlag(r.x,a)}setColor(e,t){const r=Shader3D.propertyNameToID(e);this.setColorbyIndex(r,t)}setColorbyIndex(e,t){const r=this._getParamsInfo(e);if(!r)return;let a=r.x;this._buffer[a++]=Color.gammaToLinearSpace(t.r),this._buffer[a++]=Color.gammaToLinearSpace(t.g),this._buffer[a++]=Color.gammaToLinearSpace(t.b),this._buffer[a++]=Color.gammaToLinearSpace(t.a),this._setUpdateFlag(r.x,a)}setMatrix(e,t){const r=Shader3D.propertyNameToID(e);this.setMatrixbyIndex(r,t)}setMatrixbyIndex(e,t){const r=this._getParamsInfo(e);if(!r)return;let a=r.x;this._buffer.set(t.elements,a),a+=16,this._setUpdateFlag(r.x,a)}clone(){let e=new UnifromBufferData(this._uniformParamsState);return this.cloneTo(e),e}cloneTo(e){e._bytelength==this._bytelength&&(e._buffer=Float32Array.from(this._buffer),this._updateFlag.setValue(0,this._buffer.length))}}class ShaderProcessInfo{}class ShaderCompileDefineBase{constructor(e,t,r){this._validDefine=new DefineDatas,this._cacheShaderHierarchy=1,this._cacheSharders={},this._owner=e,this.name=t,this._VS=r.vsNode,this._PS=r.psNode,this._defs=r.defs;for(let e of r.defs)this._validDefine.add(Shader3D.getDefineByName(e))}_resizeCacheShaderMap(e,t,r){var a=this._cacheShaderHierarchy-1;if(t==a)for(var i in e)for(var s=e[i],n=0,o=r-a;n<o;n++)n==o-1?e[0]=s:e=e[0==n?i:0]={};else for(var i in++t,e)this._resizeCacheShaderMap(e[i],t,r)}withCompile(e){var t,r=ShaderCompileDefineBase._debugDefineString,a=ShaderCompileDefineBase._debugDefineMask;e._intersectionDefineDatas(this._validDefine),Shader3D.debugMode&&(t=e._length);var i=this._cacheSharders,s=e._length;s>this._cacheShaderHierarchy&&(this._resizeCacheShaderMap(i,0,s),this._cacheShaderHierarchy=s);for(var n=e._mask,o=e._length-1,l=this._cacheShaderHierarchy-1,h=0;h<l;h++){var u=o<h?0:n[h],d=i[u];d||(i[u]=d={}),i=d}var _=o<l?0:n[l],c=i[_];if(c)return c;var p=ShaderCompileDefineBase._defineString;Shader3D._getNamesByDefineData(e,p);let m=new ShaderProcessInfo;if(m.is2D=!0,m.vs=this._VS,m.ps=this._PS,m.attributeMap=this._owner._attributeMap,m.uniformMap=this._owner._uniformMap,m.defineString=p,c=LayaGL.renderOBJCreate.createShaderInstance(m,this),i[_]=c,Shader3D.debugMode){for(var f="",g="",T=(h=0,t);h<T;h++)g+=h==T-1?a[h]:a[h]+",";for(h=0,T=r.length;h<T;h++)f+=h==T-1?r[h]:r[h]+",";console.log("%cLayaAir: Shader Compile Information---ShaderName:"+this.name+"  DefineMask:["+g+"] DefineNames:["+f+"]","color:green")}return c}}ShaderCompileDefineBase._defineString=[],ShaderCompileDefineBase._debugDefineString=[],ShaderCompileDefineBase._debugDefineMask=[];class ShaderPass extends ShaderCompileDefineBase{get renderState(){return this._renderState}constructor(e,t){super(e,null,t),this._tags={},this.statefirst=!1,this._renderState=LayaGL.renderOBJCreate.createRenderState(),this._renderState.setNull()}_addDebugShaderVariantCollection(e,t,r){var a=Shader3D._debugShaderVariantInfo,i=this._owner,s=i._owner,n=e._mask;Shader3D._getNamesByDefineData(e,t),r.length=n.length;for(var o=0,l=n.length;o<l;o++)r[o]=n[o];a?a.setValue(s,s._subShaders.indexOf(i),i._passes.indexOf(this),t):Shader3D._debugShaderVariantInfo=a=new ShaderVariant(s,s._subShaders.indexOf(i),i._passes.indexOf(this),t),Shader3D.debugShaderVariantCollection.add(a)}withCompile(e,t=!1){var r,a=ShaderPass._debugDefineStrings,i=ShaderPass._debugDefineMasks;e._intersectionDefineDatas(this._validDefine),Shader3D.debugMode&&(r=e._length,this._addDebugShaderVariantCollection(e,a,i));var s=this._cacheSharders,n=e._length;n>this._cacheShaderHierarchy&&(this._resizeCacheShaderMap(s,0,n),this._cacheShaderHierarchy=n);for(var o=e._mask,l=e._length-1,h=this._cacheShaderHierarchy-1,u=0;u<h;u++){var d=l<u?0:o[u],_=s[d];_||(s[d]=_={}),s=_}var c=l<h?0:o[h],p=s[c];if(p)return p;let m=new ShaderProcessInfo;m.is2D=t,m.vs=this._VS,m.ps=this._PS,m.attributeMap=this._owner._attributeMap,m.uniformMap=this._owner._uniformMap;var f=ShaderPass._defineStrings;if(Shader3D._getNamesByDefineData(e,f),m.defineString=f,p=LayaGL.renderOBJCreate.createShaderInstance(m,this),s[c]=p,Shader3D.debugMode){for(var g="",T="",S="",x="",y=(u=0,r);u<y;u++)S+=u==y-1?i[u]:i[u]+",";for(u=0,y=a.length;u<y;u++)Shader3D._configDefineValues.has(Shader3D.getDefineByName(a[u]))?T+=a[u]+",":g+=a[u]+",";if(this.nodeCommonMap)for(var E=0;E<this.nodeCommonMap.length;E++)x+=this.nodeCommonMap[E]+",";console.log("%cLayaAir: Shader Compile Information---ShaderName:"+this._owner._owner._name+" SubShaderIndex:"+this._owner._owner._subShaders.indexOf(this._owner)+" PassIndex:"+this._owner._passes.indexOf(this)+" DefineMask:["+S+"] DefineNames:["+g+"] Environment Macro DefineNames:["+T+"]Sprite CommonNode:["+x+"]","color:green")}return p}}ShaderPass._defineStrings=[],ShaderPass._debugDefineStrings=[],ShaderPass._debugDefineMasks=[];class VertexElement{get offset(){return this._offset}get elementFormat(){return this._elementFormat}get elementUsage(){return this._elementUsage}constructor(e,t,r){this._offset=e,this._elementFormat=t,this._elementUsage=r}}e.RenderParams=void 0,(re=e.RenderParams||(e.RenderParams={}))[re.Max_Active_Texture_Count=0]="Max_Active_Texture_Count",re[re.Max_Uniform_Count=1]="Max_Uniform_Count",re[re.Max_AnisoLevel_Count=2]="Max_AnisoLevel_Count",re[re.MAX_Texture_Size=3]="MAX_Texture_Size",re[re.MAX_Texture_Image_Uint=4]="MAX_Texture_Image_Uint",re[re.SHADER_CAPAILITY_LEVEL=5]="SHADER_CAPAILITY_LEVEL",re[re.FLOAT=6]="FLOAT",re[re.UNSIGNED_BYTE=7]="UNSIGNED_BYTE",re[re.BYTE=8]="BYTE",re[re.UNSIGNED_SHORT=9]="UNSIGNED_SHORT";class VertexElementFormat{static __init__(){VertexElementFormat._elementInfos={single:[1,LayaGL.renderEngine.getParams(e.RenderParams.FLOAT),0],vector2:[2,LayaGL.renderEngine.getParams(e.RenderParams.FLOAT),0],vector3:[3,LayaGL.renderEngine.getParams(e.RenderParams.FLOAT),0],vector4:[4,LayaGL.renderEngine.getParams(e.RenderParams.FLOAT),0],color:[4,LayaGL.renderEngine.getParams(e.RenderParams.FLOAT),0],byte4:[4,LayaGL.renderEngine.getParams(e.RenderParams.UNSIGNED_BYTE),0],byte3:[3,LayaGL.renderEngine.getParams(e.RenderParams.UNSIGNED_BYTE),0],byte2:[2,LayaGL.renderEngine.getParams(e.RenderParams.UNSIGNED_BYTE),0],byte:[1,LayaGL.renderEngine.getParams(e.RenderParams.UNSIGNED_BYTE),0],short2:[2,LayaGL.renderEngine.getParams(e.RenderParams.UNSIGNED_SHORT),0],short4:[4,LayaGL.renderEngine.getParams(e.RenderParams.UNSIGNED_SHORT),0],normalizedshort2:[2,LayaGL.renderEngine.getParams(e.RenderParams.UNSIGNED_SHORT),1],normalizedshort4:[4,LayaGL.renderEngine.getParams(e.RenderParams.UNSIGNED_SHORT),1],halfvector2:[2,LayaGL.renderEngine.getParams(e.RenderParams.FLOAT),0],halfvector4:[4,LayaGL.renderEngine.getParams(e.RenderParams.FLOAT),0],nbyte4:[4,LayaGL.renderEngine.getParams(e.RenderParams.BYTE),1],ubyte4:[4,LayaGL.renderEngine.getParams(e.RenderParams.UNSIGNED_BYTE),1]}}static getElementInfos(e){var t=VertexElementFormat._elementInfos[e];if(t)return t;throw"VertexElementFormat: this vertexElementFormat is not implement."}}VertexElementFormat.Single="single",VertexElementFormat.Vector2="vector2",VertexElementFormat.Vector3="vector3",VertexElementFormat.Vector4="vector4",VertexElementFormat.Color="color",VertexElementFormat.Byte4="byte4",VertexElementFormat.Byte3="byte3",VertexElementFormat.Byte2="byte2",VertexElementFormat.ByteOne="byte",VertexElementFormat.Short2="short2",VertexElementFormat.Short4="short4",VertexElementFormat.NormalizedShort2="normalizedshort2",VertexElementFormat.NormalizedShort4="normalizedshort4",VertexElementFormat.HalfVector2="halfvector2",VertexElementFormat.HalfVector4="halfvector4",VertexElementFormat.NorByte4="nbyte4",VertexElementFormat.NorUByte4="ubyte4";class VertexDeclaration{get id(){return this._id}get vertexStride(){return this._vertexStride}get vertexElementCount(){return this._vertexElements.length}constructor(e,t){this._id=++VertexDeclaration._uniqueIDCounter,this._vertexElementsDic={},this._vertexStride=e,this._vertexElements=t,this._VAElements=[];var r=t.length;this._shaderValues={};for(var a=0;a<r;a++){var i=t[a],s=i._elementUsage;this._vertexElementsDic[s]=i;var n=new Int32Array(5),o=VertexElementFormat.getElementInfos(i._elementFormat);n[0]=o[0],n[1]=o[1],n[2]=o[2],n[3]=this._vertexStride,n[4]=i._offset,this._shaderValues[s]=n,this._VAElements.push({format:i._elementFormat,stride:i._offset,shaderLocation:s})}}getVertexElementByIndex(e){return this._vertexElements[e]}getVertexElementByUsage(e){return this._vertexElementsDic[e]}}VertexDeclaration._uniqueIDCounter=1;class VertexMesh{static __init__(){VertexMesh.instanceWorldMatrixDeclaration=new VertexDeclaration(64,[new VertexElement(0,VertexElementFormat.Vector4,VertexMesh.MESH_WORLDMATRIX_ROW0),new VertexElement(16,VertexElementFormat.Vector4,VertexMesh.MESH_WORLDMATRIX_ROW1),new VertexElement(32,VertexElementFormat.Vector4,VertexMesh.MESH_WORLDMATRIX_ROW2),new VertexElement(48,VertexElementFormat.Vector4,VertexMesh.MESH_WORLDMATRIX_ROW3)]),VertexMesh.instanceSimpleAnimatorDeclaration=new VertexDeclaration(16,[new VertexElement(0,VertexElementFormat.Vector4,VertexMesh.MESH_SIMPLEANIMATOR)]),VertexMesh.instanceLightMapScaleOffsetDeclaration=new VertexDeclaration(16,[new VertexElement(0,VertexElementFormat.Vector4,VertexMesh.MESH_LIGHTMAPSCALEOFFSET)])}static getVertexDeclaration(e,t=!0){var r=VertexMesh._vertexDeclarationMap[e+(t?"_0":"_1")];if(!r){for(var a=e.split(","),i=0,s=[],n=0,o=a.length;n<o;n++){var l;switch(a[n]){case"POSITION":l=new VertexElement(i,VertexElementFormat.Vector3,VertexMesh.MESH_POSITION0),i+=12;break;case"NORMAL":l=new VertexElement(i,VertexElementFormat.Vector3,VertexMesh.MESH_NORMAL0),i+=12;break;case"COLOR":l=new VertexElement(i,VertexElementFormat.Vector4,VertexMesh.MESH_COLOR0),i+=16;break;case"UV":l=new VertexElement(i,VertexElementFormat.Vector2,VertexMesh.MESH_TEXTURECOORDINATE0),i+=8;break;case"UV1":l=new VertexElement(i,VertexElementFormat.Vector2,VertexMesh.MESH_TEXTURECOORDINATE1),i+=8;break;case"BLENDWEIGHT":l=new VertexElement(i,VertexElementFormat.Vector4,VertexMesh.MESH_BLENDWEIGHT0),i+=16;break;case"BLENDINDICES":t?(l=new VertexElement(i,VertexElementFormat.Vector4,VertexMesh.MESH_BLENDINDICES0),i+=16):(l=new VertexElement(i,VertexElementFormat.Byte4,VertexMesh.MESH_BLENDINDICES0),i+=4);break;case"TANGENT":l=new VertexElement(i,VertexElementFormat.Vector4,VertexMesh.MESH_TANGENT0),i+=16;break;case"NORMAL_BYTE":l=new VertexElement(i,VertexElementFormat.NorByte4,VertexMesh.MESH_NORMAL0),i+=4;break;default:throw"VertexMesh: unknown vertex flag."}s.push(l)}r=new VertexDeclaration(i,s),VertexMesh._vertexDeclarationMap[e+(t?"_0":"_1")]=r}return r}}VertexMesh.MESH_POSITION0=0,VertexMesh.MESH_COLOR0=1,VertexMesh.MESH_TEXTURECOORDINATE0=2,VertexMesh.MESH_NORMAL0=3,VertexMesh.MESH_TANGENT0=4,VertexMesh.MESH_BLENDINDICES0=5,VertexMesh.MESH_BLENDWEIGHT0=6,VertexMesh.MESH_TEXTURECOORDINATE1=7,VertexMesh.MESH_WORLDMATRIX_ROW0=8,VertexMesh.MESH_WORLDMATRIX_ROW1=9,VertexMesh.MESH_WORLDMATRIX_ROW2=10,VertexMesh.MESH_WORLDMATRIX_ROW3=11,VertexMesh.MESH_SIMPLEANIMATOR=12,VertexMesh.MESH_LIGHTMAPSCALEOFFSET=13,VertexMesh.MESH_CUSTOME0=12,VertexMesh.MESH_CUSTOME1=13,VertexMesh.MESH_CUSTOME2=14,VertexMesh.MESH_CUSTOME3=15,VertexMesh._vertexDeclarationMap={};class SubShader{static regIncludeBindUnifrom(e,t,r){let a={},i=a[e]={};i.uniformMap=t,i.defaultValue=r,Object.assign(SubShader.IncludeUniformMap,a)}constructor(t=SubShader.DefaultAttributeMap,r={},a=null){this._uniformBufferDataMap=new Map,this._flags={},this._passes=[],this._attributeMap=t,this._uniformMap=r,this._uniformDefaultValue=a,this._uniformTypeMap=new Map;for(const t in r)if("object"==typeof r[t]){let e=r[t],a=new Map;for(const t in e){let r=ShaderDataTypeToUniformBufferType(e[t]);a.set(t,r),this._uniformTypeMap.set(t,e[t])}let i=new Map;a.forEach(((e,t)=>{i.set(Shader3D.propertyNameToID(t),e)}));let s=new UnifromBufferData(i);this._uniformBufferDataMap.set(t,s)}else{let a=r[t];if(this._uniformTypeMap.set(t,a),a==e.ShaderDataType.Texture2D||a==e.ShaderDataType.TextureCube||a==e.ShaderDataType.Texture3D||a==e.ShaderDataType.Texture2DArray){let e=Shader3D.getDefineByName(`Gamma_${t}`),r=Shader3D.propertyNameToID(t);ShaderDefine._texGammaDefine[r]=e}}}setFlag(e,t){t?this._flags[e]=t:delete this._flags[e]}getFlag(e){return this._flags[e]}addShaderPass(e,t,r="Forward"){return this._addShaderPass(ShaderCompile.compile(e,t),r)}_addShaderPass(e,t="Forward"){var r=new ShaderPass(this,e);return r._pipelineMode=t,this._passes.push(r),this._addIncludeUniform(e.includeNames),r}_addIncludeUniform(e){for(let r of e)if(SubShader.IncludeUniformMap[r]){let e=SubShader.IncludeUniformMap[r],a=e.uniformMap,i=e.defaultValue;for(var t in a)this._uniformTypeMap.has(t)||(this._uniformTypeMap.set(t,a[t]),this._uniformMap[t]=a[t]);for(var t in i)this._uniformDefaultValue[t]||(this._uniformDefaultValue[t]=i[t])}}}function ShaderDataTypeToUniformBufferType(t){switch(t){case e.ShaderDataType.Float:return e.UniformBufferParamsType.Number;case e.ShaderDataType.Vector2:return e.UniformBufferParamsType.Vector2;case e.ShaderDataType.Vector3:return e.UniformBufferParamsType.Vector3;case e.ShaderDataType.Vector4:case e.ShaderDataType.Color:return e.UniformBufferParamsType.Vector4;case e.ShaderDataType.Matrix4x4:return e.UniformBufferParamsType.Matrix4x4;default:throw"ShaderDataType can not be in UniformBuffer."}}SubShader.IncludeUniformMap={},SubShader.DefaultAttributeMap={a_Position:[VertexMesh.MESH_POSITION0,e.ShaderDataType.Vector4],a_Normal:[VertexMesh.MESH_NORMAL0,e.ShaderDataType.Vector3],a_Tangent0:[VertexMesh.MESH_TANGENT0,e.ShaderDataType.Vector4],a_Texcoord0:[VertexMesh.MESH_TEXTURECOORDINATE0,e.ShaderDataType.Vector2],a_Texcoord1:[VertexMesh.MESH_TEXTURECOORDINATE1,e.ShaderDataType.Vector2],a_Color:[VertexMesh.MESH_COLOR0,e.ShaderDataType.Vector4],a_BoneWeights:[VertexMesh.MESH_BLENDWEIGHT0,e.ShaderDataType.Vector4],a_BoneIndices:[VertexMesh.MESH_BLENDINDICES0,e.ShaderDataType.Vector4],a_WorldMat:[VertexMesh.MESH_WORLDMATRIX_ROW0,e.ShaderDataType.Matrix4x4],a_SimpleTextureParams:[VertexMesh.MESH_SIMPLEANIMATOR,e.ShaderDataType.Vector4],a_LightmapScaleOffset:[VertexMesh.MESH_LIGHTMAPSCALEOFFSET,e.ShaderDataType.Vector4]};class Shader3D{static init(){Shader3D.debugShaderVariantCollection=new ShaderVariantCollection}static _getNamesByDefineData(e,t){var r=Shader3D._maskMap,a=e._mask;t.length=0;for(var i=0,s=e._length;i<s;i++)for(var n=r[i],o=a[i],l=0;l<32;l++){var h=1<<l;if(o>0&&h>o)break;o&h&&t.push(n[h])}}static getDefineByName(e){var t=Shader3D._defineMap[e];if(!t){var r=Shader3D._maskMap,a=Shader3D._defineCounter,i=Math.floor(a/32),s=1<<a%32;t=new ShaderDefine(i,s),Shader3D._defineMap[e]=t,i==r.length&&(r.length++,r[i]={}),r[i][s]=e,Shader3D._defineCounter++}return t}static propertyNameToID(e){return LayaGL.renderEngine.propertyNameToID(e)}static propertyIDToName(e){return LayaGL.renderEngine.propertyIDToName(e)}static addInclude(e,t){ShaderCompile.addInclude(e,t)}static compileShaderByDefineNames(e,t,r,a,i){var s=Shader3D.find(e);if(s){var n=s.getSubShaderAt(t);if(n){var o=n._passes[r];if(o.nodeCommonMap=i,o){var l=Shader3D._compileDefineDatas;Shader3D._configDefineValues.cloneTo(l);for(var h=0,u=a.length;h<u;h++)l.add(Shader3D.getDefineByName(a[h]));o.withCompile(l)}else console.warn("Shader3D: unknown passIndex.")}else console.warn("Shader3D: unknown subShaderIndex.")}else console.warn("Shader3D: unknown shader name.")}static add(e,t=!1,r=!1){return Shader3D._preCompileShader[e]=new Shader3D(e,t,r)}static find(e){return Shader3D._preCompileShader[e]}static parse(e,t){var r;e.name||console.warn("shader name is empty",e),e.uniformMap||console.warn(`${e.name}: uniformMap is empty`);let a=Shader3D.add(e.name,e.enableInstancing,e.supportReflectionProbe);a._surportVolumetricGI=e.surportVolumetricGI;let i=new SubShader(e.attributeMap?e.attributeMap:SubShader.DefaultAttributeMap,e.uniformMap,e.defaultValue);a.addSubShader(i);let s=e.shaderPass;for(var n in s){let a=s[n];if(!a.VS){console.warn(`${e.name}: VS of pass ${n} is empty`);continue}if(!a.FS){console.warn(`${e.name}: FS of pass ${n} is empty`);continue}let o=i._addShaderPass(ShaderCompile.compile(a.VS,a.FS,t),a.pipeline);o.statefirst=null!==(r=a.statefirst)&&void 0!==r&&r,ShaderCompile.getRenderState(a.renderState,o.renderState)}return a}get name(){return this._name}constructor(e,t,r){this._enableInstancing=!1,this._supportReflectionProbe=!1,this._surportVolumetricGI=!1,this._subShaders=[],this._name=e,this._enableInstancing=t,this._supportReflectionProbe=r}addSubShader(e){this._subShaders.push(e),e._owner=this}getSubShaderAt(e){return this._subShaders[e]}}Shader3D._configDefineValues=new DefineDatas,Shader3D._compileDefineDatas=new DefineDatas,Shader3D.PERIOD_CUSTOM=0,Shader3D.PERIOD_MATERIAL=1,Shader3D.PERIOD_SPRITE=2,Shader3D.PERIOD_CAMERA=3,Shader3D.PERIOD_SCENE=4,Shader3D._propertyNameMap={},Shader3D._propertyNameCounter=0,Shader3D._defineCounter=0,Shader3D._defineMap={},Shader3D._preCompileShader={},Shader3D._maskMap=[],Shader3D.debugMode=!1;class ShaderDefines2D{static __init__(){ShaderDefines2D.TEXTURE2D=Shader3D.getDefineByName("TEXTURE2D"),ShaderDefines2D.PRIMITIVE=Shader3D.getDefineByName("PRIMITIVE"),ShaderDefines2D.FILTERGLOW=Shader3D.getDefineByName("GLOW_FILTER"),ShaderDefines2D.FILTERBLUR=Shader3D.getDefineByName("BLUR_FILTER"),ShaderDefines2D.FILTERCOLOR=Shader3D.getDefineByName("COLOR_FILTER"),ShaderDefines2D.COLORADD=Shader3D.getDefineByName("COLOR_ADD"),ShaderDefines2D.WORLDMAT=Shader3D.getDefineByName("WORLDMAT"),ShaderDefines2D.FILLTEXTURE=Shader3D.getDefineByName("FILLTEXTURE"),ShaderDefines2D.MVP3D=Shader3D.getDefineByName("MVP3D"),ShaderDefines2D.GAMMASPACE=Shader3D.getDefineByName("GAMMASPACE"),ShaderDefines2D.INVERTY=Shader3D.getDefineByName("INVERTY"),ShaderDefines2D.GAMMATEXTURE=Shader3D.getDefineByName("GAMMATEXTURE"),ShaderDefines2D.TEXTURESHADER=Shader3D.getDefineByName("TEXTUREVS"),ShaderDefines2D.PRIMITIVESHADER=Shader3D.getDefineByName("PRIMITIVEMESH"),ShaderDefines2D.initSprite2DCommandEncoder()}static initSprite2DCommandEncoder(){ShaderDefines2D.UNIFORM_MMAT=Shader3D.propertyNameToID("u_mmat"),ShaderDefines2D.UNIFORM_CLIPMATDIR=Shader3D.propertyNameToID("u_clipMatDir"),ShaderDefines2D.UNIFORM_CLIPMATPOS=Shader3D.propertyNameToID("u_clipMatPos"),ShaderDefines2D.UNIFORM_MMAT2=Shader3D.propertyNameToID("u_mmat2"),ShaderDefines2D.UNIFORM_SIZE=Shader3D.propertyNameToID("u_size"),ShaderDefines2D.UNIFORM_CLIPOFF=Shader3D.propertyNameToID("u_clipOff"),ShaderDefines2D.UNIFORM_MVPMatrix=Shader3D.propertyNameToID("u_MvpMatrix"),ShaderDefines2D.UNIFORM_SPRITETEXTURE=Shader3D.propertyNameToID("u_spriteTexture"),ShaderDefines2D.UNIFORM_STRENGTH_SIG2_2SIG2_GAUSS1=Shader3D.propertyNameToID("u_strength_sig2_2sig2_gauss1"),ShaderDefines2D.UNIFORM_BLURINFO=Shader3D.propertyNameToID("u_blurInfo"),ShaderDefines2D.UNIFORM_COLORALPHA=Shader3D.propertyNameToID("u_colorAlpha"),ShaderDefines2D.UNIFORM_COLORMAT=Shader3D.propertyNameToID("u_colorMat"),ShaderDefines2D.UNIFORM_COLOR=Shader3D.propertyNameToID("u_color"),ShaderDefines2D.UNIFORM_BLURINFO1=Shader3D.propertyNameToID("u_blurInfo1"),ShaderDefines2D.UNIFORM_BLURINFO2=Shader3D.propertyNameToID("u_blurInfo2"),ShaderDefines2D.UNIFORM_COLORADD=Shader3D.propertyNameToID("u_colorAdd"),ShaderDefines2D.UNIFORM_TEXRANGE=Shader3D.propertyNameToID("u_TexRange");const t=LayaGL.renderOBJCreate.createGlobalUniformMap("Sprite2D");t.addShaderUniform(ShaderDefines2D.UNIFORM_MMAT,"u_mmat",e.ShaderDataType.Matrix4x4),t.addShaderUniform(ShaderDefines2D.UNIFORM_CLIPMATDIR,"u_clipMatDir",e.ShaderDataType.Vector4),t.addShaderUniform(ShaderDefines2D.UNIFORM_CLIPMATPOS,"u_clipMatPos",e.ShaderDataType.Vector2),t.addShaderUniform(ShaderDefines2D.UNIFORM_MMAT2,"u_mmat2",e.ShaderDataType.Matrix4x4),t.addShaderUniform(ShaderDefines2D.UNIFORM_SIZE,"u_size",e.ShaderDataType.Vector2),t.addShaderUniform(ShaderDefines2D.UNIFORM_CLIPOFF,"u_clipOff",e.ShaderDataType.Vector2),t.addShaderUniform(ShaderDefines2D.UNIFORM_MVPMatrix,"u_MvpMatrix",e.ShaderDataType.Matrix4x4),t.addShaderUniform(ShaderDefines2D.UNIFORM_SPRITETEXTURE,"u_spriteTexture",e.ShaderDataType.Texture2D),t.addShaderUniform(ShaderDefines2D.UNIFORM_STRENGTH_SIG2_2SIG2_GAUSS1,"u_strength_sig2_2sig2_gauss1",e.ShaderDataType.Vector4),t.addShaderUniform(ShaderDefines2D.UNIFORM_BLURINFO,"u_blurInfo",e.ShaderDataType.Vector2),t.addShaderUniform(ShaderDefines2D.UNIFORM_COLORALPHA,"u_colorAlpha",e.ShaderDataType.Vector4),t.addShaderUniform(ShaderDefines2D.UNIFORM_COLORMAT,"u_colorMat",e.ShaderDataType.Matrix4x4),t.addShaderUniform(ShaderDefines2D.UNIFORM_COLOR,"u_color",e.ShaderDataType.Vector4),t.addShaderUniform(ShaderDefines2D.UNIFORM_BLURINFO1,"u_blurInfo1",e.ShaderDataType.Vector4),t.addShaderUniform(ShaderDefines2D.UNIFORM_BLURINFO2,"u_blurInfo2",e.ShaderDataType.Vector4),t.addShaderUniform(ShaderDefines2D.UNIFORM_COLORADD,"u_colorAdd",e.ShaderDataType.Vector4),t.addShaderUniform(ShaderDefines2D.UNIFORM_TEXRANGE,"u_TexRange",e.ShaderDataType.Vector4)}}class RenderInfo{}RenderInfo.loopStTm=0,RenderInfo.loopCount=0,e.WrapMode=void 0,(ae=e.WrapMode||(e.WrapMode={}))[ae.Repeat=0]="Repeat",ae[ae.Clamp=1]="Clamp",ae[ae.Mirrored=2]="Mirrored";class AtlasGrid{constructor(e=0,t=0,r=0){this.atlasID=0,this._width=0,this._height=0,this._texCount=0,this._rowInfo=null,this._cells=null,this._used=0,this._cells=null,this._rowInfo=null,this.atlasID=r,this._init(e,t)}addRect(e,t,r,a){return!!this._get(t,r,a)&&(this._fill(a.x,a.y,t,r,e),this._texCount++,!0)}_release(){this._cells=null,this._rowInfo=null}_init(e,t){return this._width=e,this._height=t,this._release(),0!=this._width&&(this._cells=new Uint8Array(this._width*this._height*3),this._rowInfo=new Uint8Array(this._height),this._used=0,this._clear(),!0)}_get(e,t,r){if(e>this._width||t>this._height)return!1;for(var a=-1,i=-1,s=this._width,n=this._height,o=this._cells,l=0;l<n;l++)if(!(this._rowInfo[l]<e))for(var h=0;h<s;){var u=3*(l*s+h);if(0!=o[u]||o[u+1]<e||o[u+2]<t)h+=o[u+1];else{a=h,i=l;for(var d=0;d<e;d++)if(o[3*d+u+2]<t){a=-1;break}if(!(a<0))return r.x=a,r.y=i,!0;h+=o[u+1]}}return!1}_fill(e,t,r,a,i){var s=this._width,n=this._height;this._check(e+r<=s&&t+a<=n);for(var o=t;o<a+t;++o){this._check(this._rowInfo[o]>=r),this._rowInfo[o]-=r;for(var l=0;l<r;l++){var h=3*(e+o*s+l);this._check(0==this._cells[h]),this._cells[h]=i,this._cells[h+1]=r,this._cells[h+2]=a}}if(e>0)for(o=0;o<a;++o){var u=0;for(l=e-1;l>=0&&0==this._cells[3*((t+o)*s+l)];--l,++u);for(l=u;l>0;--l)this._cells[3*((t+o)*s+e-l)+1]=l,this._check(l>0)}if(t>0)for(l=e;l<e+r;++l){for(u=0,o=t-1;o>=0&&0==this._cells[3*(l+o*s)];--o,u++);for(o=u;o>0;--o)this._cells[3*(l+(t-o)*s)+2]=o,this._check(o>0)}this._used+=r*a/(this._width*this._height)}_check(e){0==e&&console.log("xtexMerger 错误啦")}_clear(){this._texCount=0;for(var e=0;e<this._height;e++)this._rowInfo[e]=this._width;for(var t=0;t<this._height;t++)for(var r=0;r<this._width;r++){var a=3*(t*this._width+r);this._cells[a]=0,this._cells[a+1]=this._width-r,this._cells[a+2]=this._width-t}}}class FontInfo{static parse(e){if(e===ne)return ie;let t=FontInfo._cache[e];return t||(t=FontInfo._cache[e]=new FontInfo(e)),ne=e,ie=t,t}constructor(e){this._family="Arial",this._size=14,this._italic=!1,this._bold=!1,this.setFont(e||"14px Arial")}setFont(e){this._font=e;var t=e.split(" "),r=t.length;if(r<2)1==r&&t[0].indexOf("px")>0&&(this._size=parseInt(t[0]));else{var a=-1;for(let i=0;i<r;i++)if(t[i].indexOf("px")>0||t[i].indexOf("pt")>0){a=i,this._size=parseInt(t[i]),this._size<=0&&(console.debug("font parse error:"+e),this._size=14);break}var i=a+1,s=t[i];for(i++;i<r;i++)s+=" "+t[i];this._family=s.split(",")[0],this._italic=t.indexOf("italic")>=0,this._bold=t.indexOf("bold")>=0}}}FontInfo._cache={};var ie,se,ne="";class WordText{constructor(){this.pagecharsCtx=null,window.conch&&!window.conchConfig.conchWebGL?this._nativeObj=new window._conchWordText:(this.width=-1,this.pageChars=[],this.scalex=1,this.scaley=1)}setText(e){this.text=e,this._nativeObj?this._nativeObj._text=e:this.width=-1,this.cleanCache()}toString(){return this.text}get length(){return this.text?this.text.length:0}cleanCache(){if(this._nativeObj)return void this._nativeObj.cleanCache();let e=this.pageChars;if(e.length>0){for(var t in e){let r=e[t];if(!r)continue;let a=r.tex;1==r.words.length&&a&&a.ri&&a.destroy()}this.pageChars=[]}this.scalex=1,this.scaley=1}get splitRender(){return this._splitRender}set splitRender(e){this._splitRender=e,this._nativeObj&&(this._nativeObj.splitRender=e)}}class CharRenderInfo{constructor(){this.char="",this.deleted=!1,this.uv=new Array(8),this.pos=0,this.orix=0,this.oriy=0,this.touchTick=0,this.isSpace=!1}touch(){var e=RenderInfo.loopCount;this.touchTick!=e&&this.tex.touchRect(this,e),this.touchTick=e}}class ICharRender{constructor(){this.fontsz=16}getWidth(e,t){return 0}scale(e,t){}get canvasWidth(){return 0}set canvasWidth(e){}getCharBmp(e,t,r,a,i,s,n,o,l,h,u=null){return null}}class Browser{static __init__(){var e;let t=window.Laya||ILaya.Laya;if(Browser._window)return Browser._window;let r,a=Browser._window=window,i=Browser._document=a.document,s=Browser.userAgent=a.navigator.userAgent,n=a.navigator.maxTouchPoints||0,o=a.navigator.platform;window.conch&&"conchUseWXAdapter"in Browser.window&&(r=["wxMiniGame","MiniAdpter","wx"]),"my"in Browser.window&&(s.indexOf("TB/")>-1||s.indexOf("Taobao/")>-1||s.indexOf("TM/")>-1?r=["tbMiniGame","TBMiniAdapter","my"]:s.indexOf("AlipayMiniGame")>-1&&(r=["aliPayMiniGame","ALIMiniAdapter","my"])),(-1==s.indexOf("OPPO")&&s.indexOf("MiniGame")>-1||-1!=s.indexOf("runtime")||-1!=s.indexOf("miniprogram")&&window.isWXMiMi)&&"wx"in Browser.window&&(r="tt"in Browser.window?["ttMiniGame","TTMiniAdapter","tt"]:"bl"in Browser.window?["biliMiniGame","BLMiniAdapter",null]:"qq"in Browser.window?["qqMiniGame","QQMiniAdapter",null]:["wxMiniGame","MiniAdpter","wx"]),"hbs"in Browser.window&&(r=["hwMiniGame","HWMiniAdapter",null]),s.indexOf("SwanGame")>-1&&(r=["bdMiniGame","BMiniAdapter",null]),s.indexOf("QuickGame")>-1&&(r=["miMiniGame","KGMiniAdapter","qg"]),s.indexOf("OPPO")>-1&&s.indexOf("MiniGame")>-1&&(r=["qgMiniGame","QGMiniAdapter","qg"],Config.fixedFrames=!1),s.indexOf("VVGame")>-1&&(r=["vvMiniGame","VVMiniAdapter","qg"],Config.fixedFrames=!1),null!=r&&(Browser.window[r[0]](t,t),t[r[1]].enable(),Browser.miniGameContext=Browser.window[r[2]]),a.trace=console.log,a.requestAnimationFrame=a.requestAnimationFrame||a.webkitRequestAnimationFrame||a.mozRequestAnimationFrame||a.oRequestAnimationFrame||a.msRequestAnimationFrame||function(e){return a.setTimeout(e,1e3/60)};var l=i.body.style;l.margin=0,l.overflow="hidden",l["-webkit-user-select"]="none",l["-webkit-tap-highlight-color"]="rgba(200,200,200,0)";var h=i.getElementsByTagName("meta");let u,d={width:"device-width","initial-scale":"1.0","minimum-scale":"1.0","maximum-scale":"1.0","user-scalable":"no"};for(const e of h)if("viewport"==e.name){u=e;break}if(u){let e=(u.content||"").split(",");for(let t of e){let e=t.split("=");d[e[0].trim()]||(d[e[0]]=e[1])}}else u=i.createElement("meta"),u.name="viewport",null===(e=i.getElementsByTagName("head")[0])||void 0===e||e.appendChild(u);return u.content=Object.keys(d).map((e=>e+"="+d[e])),Browser.onMobile=!!window.conch||s.indexOf("Mobile")>-1,Browser.onIOS=!!s.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),Browser.onIPhone=s.indexOf("iPhone")>-1,Browser.onMac=s.indexOf("Mac OS X")>-1,Browser.onIPad=s.indexOf("iPad")>-1||"MacIntel"===o&&n>1,Browser.onAndroid=s.indexOf("Android")>-1||s.indexOf("Adr")>-1,Browser.onWP=s.indexOf("Windows Phone")>-1,Browser.onQQBrowser=s.indexOf("QQBrowser")>-1,Browser.onMQQBrowser=s.indexOf("MQQBrowser")>-1||s.indexOf("Mobile")>-1&&s.indexOf("QQ")>-1,Browser.onIE=!!a.ActiveXObject||"ActiveXObject"in a,Browser.onWeiXin=s.indexOf("MicroMessenger")>-1,Browser.onSafari=s.indexOf("Safari")>-1&&-1===s.indexOf("Chrome"),Browser.onChrome=s.indexOf("Chrome")>-1,Browser.onPC=!Browser.onMobile,Browser.onFirefox=s.indexOf("Firefox")>-1,Browser.onEdge=s.indexOf("Edge")>-1||s.indexOf("Edg")>-1,Browser.onMiniGame=s.indexOf("MiniGame")>-1,Browser.onBDMiniGame=s.indexOf("SwanGame")>-1,Browser.onLayaRuntime=!!window.conch,s.indexOf("OPPO")>-1&&s.indexOf("MiniGame")>-1?(Browser.onQGMiniGame=!0,Browser.onMiniGame=!1):"qq"in Browser.window&&s.indexOf("MiniGame")>-1?(Browser.onQQMiniGame=!0,Browser.onMiniGame=!1):"bl"in Browser.window&&s.indexOf("MiniGame")>-1?(Browser.onBLMiniGame=!0,Browser.onMiniGame=!1):"tt"in Browser.window&&s.indexOf("MiniGame")>-1&&(Browser.onTTMiniGame=!0,Browser.onMiniGame=!1),Browser.onHWMiniGame="hbs"in Browser.window,Browser.onVVMiniGame=s.indexOf("VVGame")>-1,Browser.onKGMiniGame=s.indexOf("QuickGame")>-1,s.indexOf("AlipayMiniGame")>-1&&(Browser.onAlipayMiniGame=!0,Browser.onMiniGame=!1),(s.indexOf("TB/")>-1||s.indexOf("Taobao/")>-1||s.indexOf("TM/")>-1)&&(Browser.onTBMiniGame=!0),(Browser.onAndroid||Browser.onIOS)&&(!o||-1==o.indexOf("Win")&&-1==o.indexOf("Mac"))?Browser.onAndroid?Browser.platform=Browser.PLATFORM_ANDROID:Browser.platform=Browser.PLATFORM_IOS:Browser.platform=Browser.PLATFORM_PC,a}static get _isMiniGame(){return Browser.onMiniGame||Browser.onBDMiniGame||Browser.onQGMiniGame||Browser.onKGMiniGame||Browser.onVVMiniGame||Browser.onAlipayMiniGame||Browser.onQQMiniGame||Browser.onBLMiniGame||Browser.onTTMiniGame||Browser.onHWMiniGame||Browser.onTBMiniGame||Browser.window&&Browser.window.isWXMiMi}static createElement(e){return Browser.__init__(),Browser._document.createElement(e)}static getElementById(e){return Browser.__init__(),Browser._document.getElementById(e)}static removeElement(e){e&&e.parentNode&&e.parentNode.removeChild(e)}static now(){return Date.now()}static get clientWidth(){return Browser.__init__(),Browser._clientWidth||Browser._window.innerWidth||Browser._document.body.clientWidth}static set clientWidth(e){Browser._clientWidth=e}static get clientHeight(){return Browser.__init__(),Browser._clientHeight||Browser._window.innerHeight||Browser._document.body.clientHeight||Browser._document.documentElement.clientHeight}static set clientHeight(e){Browser._clientHeight=e}static get width(){return Browser.__init__(),(ILaya.stage&&ILaya.stage.canvasRotation?Browser.clientHeight:Browser.clientWidth)*Browser.pixelRatio}static get height(){return Browser.__init__(),(ILaya.stage&&ILaya.stage.canvasRotation?Browser.clientWidth:Browser.clientHeight)*Browser.pixelRatio}static get pixelRatio(){return Browser._pixelRatio<0&&(Browser.__init__(),Browser.userAgent.indexOf("Mozilla/6.0(Linux; Android 6.0; HUAWEI NXT-AL10 Build/HUAWEINXT-AL10)")>-1?Browser._pixelRatio=2:(Browser._pixelRatio=Browser._window.devicePixelRatio||1,Browser._pixelRatio<1&&(Browser._pixelRatio=1))),Browser._pixelRatio}static get container(){return Browser._container||(Browser.__init__(),Browser._container=Browser.createElement("div"),Browser._container.id="layaContainer",Browser._document.body.appendChild(Browser._container)),Browser._container}static set container(e){Browser._container=e}static get window(){return Browser._window||Browser.__init__()}static get document(){return Browser.__init__(),Browser._document}static getQueryString(e){if(Browser.onMiniGame)return null;if(!window.location||!window.location.search)return null;var t=new RegExp("(^|&)"+e+"=([^&]*)(&|$)"),r=window.location.search.substring(1).match(t);return null!=r?unescape(r[2]):null}static getSafariToolbarOffset(){return(Browser.window.__innerHeight||Browser.document.body.clientHeight||Browser.document.documentElement.clientHeight)-Browser.window.innerHeight}static loadLib(e){return new Promise(((t,r)=>{let a=Browser.document.createElement("script");a.onload=function(){t()},a.onerror=function(){r(`load ${e} failed`)},a.src=e,Browser.document.body.appendChild(a)}))}}Browser.PLATFORM_PC=0,Browser.PLATFORM_ANDROID=1,Browser.PLATFORM_IOS=2,Browser._pixelRatio=-1,Browser.mainCanvas=null,Browser.hanzi=new RegExp("^[一-龥]$"),Browser.fontMap={},Browser.measureText=function(e,t){let r=Browser.hanzi.test(e);if(r&&Browser.fontMap[t])return Browser.fontMap[t];let a=Browser.context;a.font=t;let i=a.measureText(e);return r&&(Browser.fontMap[t]=i),i};class CharRender_Canvas extends ICharRender{constructor(e,t,r=!0,a=!0,i=!1){super(),this.ctx=null,this.lastScaleX=1,this.lastScaleY=1,this.maxTexW=0,this.maxTexH=0,this.scaleFontSize=!0,this.showDbgInfo=!1,this.supportImageData=!0,this.maxTexW=e,this.maxTexH=t,this.scaleFontSize=r,this.supportImageData=a,this.showDbgInfo=i,CharRender_Canvas.canvas||(CharRender_Canvas.canvas=Browser.createElement("canvas"),CharRender_Canvas.canvas.width=1024,CharRender_Canvas.canvas.height=512,CharRender_Canvas.canvas.style.left="-10000px",CharRender_Canvas.canvas.style.position="absolute",window.document.body.appendChild(CharRender_Canvas.canvas),this.ctx=CharRender_Canvas.canvas.getContext("2d",{willReadFrequently:!0}))}get canvasWidth(){return CharRender_Canvas.canvas.width}set canvasWidth(e){CharRender_Canvas.canvas.width!=e&&(CharRender_Canvas.canvas.width=e,e>2048&&console.warn("画文字设置的宽度太大，超过2048了"),this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(this.lastScaleX,this.lastScaleY))}getWidth(e,t){return this.ctx?(this.ctx._lastFont!=e&&(this.ctx.font=e,this.ctx._lastFont=e),this.ctx.measureText(t).width):0}scale(e,t){if(!this.supportImageData)return this.lastScaleX=e,void(this.lastScaleY=t);this.lastScaleX==e&&this.lastScaleY==t||(this.ctx.setTransform(e,0,0,t,0,0),this.lastScaleX=e,this.lastScaleY=t)}getCharBmp(e,t,r,a,i,s,n,o,l,h,u=null){if(!this.supportImageData)return this.getCharCanvas(e,t,r,a,i,s,n,o,l,h);var d=this.ctx,_=this.fontsz;d.font!=t&&(d.font=t,d._lastFont=t),s.width=d.measureText(e).width;var c=s.width*this.lastScaleX,p=s.height*this.lastScaleY;c+=(n+l)*this.lastScaleX,p+=(o+h)*this.lastScaleY,c=Math.ceil(c),p=Math.ceil(p);var m=(c=Math.min(c,CharRender_Canvas.canvas.width))+2*r+1,f=(p=Math.min(p,CharRender_Canvas.canvas.height))+2*r+1;u&&(m=Math.max(m,u[0]+u[2]+1),f=Math.max(f,u[1]+u[3]+1)),d.clearRect(0,0,m/this.lastScaleX+1,f/this.lastScaleY+1),d.save(),d.textBaseline="middle",r>0&&(d.lineJoin="round",d.strokeStyle=i,d.lineWidth=r,d.strokeText(e,n,o+_/2)),a&&(d.fillStyle=a,d.fillText(e,n,o+_/2)),this.showDbgInfo&&(d.strokeStyle="#ff0000",d.strokeRect(1,1,c-2,p-2),d.strokeStyle="#00ff00",d.strokeRect(n,o,s.width,s.height)),u&&(u[2]<=0&&(u[2]=-u[2]+Math.ceil(s.width+2*r)*this.lastScaleX),u[2]<=0&&(u[2]=1));var g=u?d.getImageData(u[0],u[1],u[2],u[3]+1):d.getImageData(0,0,c,p+1);return d.restore(),s.bmpWidth=g.width,s.bmpHeight=g.height,g}getCharCanvas(e,t,r,a,i,s,n,o,l,h){var u=this.ctx;u.font!=t&&(u.font=t,u._lastFont=t),s.width=u.measureText(e).width;var d=s.width*this.lastScaleX,_=s.height*this.lastScaleY;d+=(n+l)*this.lastScaleX,_+=(o+h)*this.lastScaleY+1,d=Math.min(d,this.maxTexW),_=Math.min(_,this.maxTexH),CharRender_Canvas.canvas.width=Math.min(d+1,this.maxTexW),CharRender_Canvas.canvas.height=Math.min(_+1,this.maxTexH),u.font=t,u.clearRect(0,0,d+1+r,_+1+r),u.setTransform(1,0,0,1,0,0),u.save(),this.scaleFontSize&&u.scale(this.lastScaleX,this.lastScaleY),u.translate(n,o),u.textAlign="left";var c=this.fontsz;return u.textBaseline="middle",r>0?(u.strokeStyle=i,u.fillStyle=a,u.lineWidth=r,u.fillAndStrokeText?u.fillAndStrokeText(e,0,c/2):(u.strokeText(e,0,c/2),u.fillText(e,0,c/2))):a&&(u.fillStyle=a,u.fillText(e,0,c/2)),this.showDbgInfo&&(u.strokeStyle="#ff0000",u.strokeRect(0,0,d,_),u.strokeStyle="#00ff00",u.strokeRect(0,0,s.width,s.height)),u.restore(),s.bmpWidth=CharRender_Canvas.canvas.width,s.bmpHeight=CharRender_Canvas.canvas.height,CharRender_Canvas.canvas}}CharRender_Canvas.canvas=null;class TextRender{constructor(){this.fontSizeInfo={},this.mapFont={},this.fontID=0,this.fontScaleX=1,this.fontScaleY=1,this._curStrPos=0,this.textAtlases=[],this.isoTextures=[],this.lastFont=null,this.fontSizeW=0,this.fontSizeH=0,this.fontSizeOffX=0,this.fontSizeOffY=0,this.renderPerChar=!0,this.tmpAtlasPos=new Point,this.textureMem=0;var e=!1,t=ILaya.Laya.MiniAdpter;t&&t.systemInfo&&t.systemInfo.system&&(e="ios 10.1.1"===t.systemInfo.system.toLowerCase()),(ILaya.Browser.onMiniGame||ILaya.Browser.onTTMiniGame||ILaya.Browser.onBLMiniGame||ILaya.Browser.onAlipayMiniGame||ILaya.Browser.onTBMiniGame)&&!e&&(TextRender.isWan1Wan=!0),this.charRender=new CharRender_Canvas(2048,2048,TextRender.scaleFontWithCtx,!TextRender.isWan1Wan,!1),TextRender.textRenderInst=this,ILaya.Laya.textRender=this,TextRender.atlasWidth2=TextRender.atlasWidth*TextRender.atlasWidth}setFont(e){if(this.lastFont!=e){this.lastFont=e;var t=this.getFontSizeInfo(e._family),r=t>>24,a=t>>16&255,i=t>>8&255,s=255&t,n=e._size/TextRender.standardFontSize;this.fontSizeOffX=Math.ceil(r*n),this.fontSizeOffY=Math.ceil(a*n),this.fontSizeW=Math.ceil(i*n),this.fontSizeH=Math.ceil(s*n),e._font.indexOf("italic")>=0?this.fontStr=e._font.replace("italic",""):this.fontStr=e._font}}getNextChar(e){var t=e.length,r=this._curStrPos;if(!e.substring)return null;if(r>=t)return null;for(var a=r,i=0;a<t;a++){var s=e.charCodeAt(a);if(s>>>11==27){if(1==i)break;i=1,a++}else if(65038===s||65039===s);else if(8205==s)i=2;else if(0==i)i=1;else if(1==i)break}return this._curStrPos=a,e.substring(r,a)}filltext(e,t,r,a,i,s,n,o,l){if(!(t.length<=0)){var h=FontInfo.parse(i),u=0;switch(l){case"center":u=Const.ENUM_TEXTALIGN_CENTER;break;case"right":u=Const.ENUM_TEXTALIGN_RIGHT}this._fast_filltext(e,t,r,a,h,s,n,o,u)}}_fast_filltext(e,t,r,a,i,s,n,o,l){if(!t||t.length>=1){if(o<0&&(o=0),this.setFont(i),this.fontScaleX=this.fontScaleY=1,TextRender.scaleFontWithCtx){let t=e.getMatScaleX(),r=e.getMatScaleY();if(t<1e-4||r<.1)return;t>1&&(this.fontScaleX=Math.min(TextRender.maxFontScale,t)),r>1&&(this.fontScaleY=Math.min(TextRender.maxFontScale,r))}i._italic&&(e._italicDeg=13);var h=t,u=t instanceof WordText,d=t&&t.toString(),_=u?h.pageChars:[],c=0;switch(u?(d=h.text,(c=h.width)<0&&(c=h.width=this.charRender.getWidth(this.fontStr,d))):c=d?this.charRender.getWidth(this.fontStr,d):0,l){case Const.ENUM_TEXTALIGN_CENTER:r-=c/2;break;case Const.ENUM_TEXTALIGN_RIGHT:r-=c}u&&(this.hasFreedText(_)||h.pagecharsCtx!=e)&&(_=h.pageChars=[]);var p=null,m=this.renderPerChar=!u||TextRender.forceSplitRender||u&&h.splitRender;if(!_||_.length<1){if(u&&(h.scalex=this.fontScaleX,h.scaley=this.fontScaleY),m){var f,g=0;for(this._curStrPos=0;(f=this.getNextChar(d))&&(p=this.getCharRenderInfo(f,i,s,n,o,!1));)if(p.isSpace);else{var T=_[p.tex.id];if(T)T=T.words;else{var S={texgen:p.tex.genID,tex:p.tex,words:new Array};_[p.tex.id]=S,T=S.words}T.push({ri:p,x:g,y:0,w:p.bmpWidth/this.fontScaleX,h:p.bmpHeight/this.fontScaleY}),g+=p.width}}else{var x=i._size/3|0,y=TextRender.noAtlas||(c+x+x)*this.fontScaleX>TextRender.atlasWidth;p=this.getCharRenderInfo(d,i,s,n,o,y),_[0]={texgen:p.tex.genID,tex:p.tex,words:[{ri:p,x:0,y:0,w:p.bmpWidth/this.fontScaleX,h:p.bmpHeight/this.fontScaleY}]}}u&&(h.pagecharsCtx=e)}this._drawResortedWords(e,r,a,_),e._italicDeg=0}}_drawResortedWords(e,t,r,a){var i=!!e._charSubmitCache&&e._charSubmitCache._enable,s=e._curMat;for(var n in a){var o=a[n];if(o){var l=o.words,h=l.length;if(!(h<=0))for(var u=a[n].tex,d=0;d<h;d++){var _=l[d],c=_.ri;if(c.isSpace)continue;c.touch(),e.drawTexAlign=!0;let a=u;e._inner_drawTexture(a.texture,a.id,t+_.x-c.orix,r+_.y-c.oriy,_.w,_.h,s,c.uv,1,i,4294967295),e.touches&&e.touches.push(c)}}}}hasFreedText(e){for(let a in e){var t=e[a];if(t){var r=t.tex;if(r.destroyed||r.genID!=t.texgen)return!0}}return!1}getCharRenderInfo(e,t,r,a,i,s=!1){var n=this.mapFont[t._family];null==n&&(this.mapFont[t._family]=n=this.fontID++);var o=e+"_"+n+"_"+t._size+"_"+r;i>0&&(o+="_"+a+i),t._bold&&(o+="P"),1==this.fontScaleX&&1==this.fontScaleY||(o+=(20*this.fontScaleX|0)+"_"+(20*this.fontScaleY|0));var l,h,u=0,d=this.textAtlases.length;if(!s)for(u=0;u<d;u++)if(l=(h=this.textAtlases[u]).charMaps[o])return l.touch(),l;l=new CharRenderInfo,this.charRender.scale(this.fontScaleX,this.fontScaleY),l.char=e,l.height=t._size;var _=t._size/3|0,c=null;i||(i=0);var p=Math.ceil((this.charRender.getWidth(this.fontStr,e)+2*i)*this.fontScaleX);if(p>this.charRender.canvasWidth&&(this.charRender.canvasWidth=Math.min(2048,p+2*_)),s){if(this.charRender.fontsz=t._size,c=this.charRender.getCharBmp(e,this.fontStr,i,r,a,l,_,_,_,_,null)){var m=TextTexture.getTextTexture(c.width,c.height);m.addChar(c,0,0,l.uv),l.tex=m,l.orix=_,l.oriy=_,m.ri=l,this.isoTextures.push(m)}}else{var f=e.length,g=1*i,T=Math.ceil((this.fontSizeW+2*g)*this.fontScaleX),S=Math.ceil((this.fontSizeH+2*g)*this.fontScaleY);TextRender.imgdtRect[0]=(_-this.fontSizeOffX-g)*this.fontScaleX|0,TextRender.imgdtRect[1]=(_-this.fontSizeOffY-g)*this.fontScaleY|0,this.renderPerChar||1==f?(TextRender.imgdtRect[2]=Math.max(p,T),TextRender.imgdtRect[3]=Math.max(p,S)):(TextRender.imgdtRect[2]=-this.fontSizeOffX*this.fontScaleX,TextRender.imgdtRect[3]=S),this.charRender.fontsz=t._size,(c=this.charRender.getCharBmp(e,this.fontStr,i,r,a,l,_,_,_,_,TextRender.imgdtRect))&&(h=this.addBmpData(c,l),TextRender.isWan1Wan?(l.orix=_,l.oriy=_):(l.orix=this.fontSizeOffX+g,l.oriy=this.fontSizeOffY+g),h.charMaps[o]=l)}return l}addBmpData(e,t){for(var r,a=e.width,i=e.height,s=this.textAtlases.length,n=!1,o=0;o<s&&!(n=(r=this.textAtlases[o]).getAEmpty(a,i,this.tmpAtlasPos));o++);if(!n){if(r=new TextAtlas,this.textAtlases.push(r),!(n=r.getAEmpty(a,i,this.tmpAtlasPos)))throw"err1";this.cleanAtlases()}return n&&(r.texture.addChar(e,this.tmpAtlasPos.x,this.tmpAtlasPos.y,t.uv),t.tex=r.texture),r}GC(){for(var e=0,t=this.textAtlases.length,r=TextRender.destroyAtlasDt,a=0,i=RenderInfo.loopCount,s=-1,n=0,o=null,l=null;e<t;e++){if(o=(l=this.textAtlases[e]).texture){o.curUsedCovRate,a+=o.curUsedCovRateAtlas;var h=l.usedRate-o.curUsedCovRateAtlas;n<h&&(n=h,s=e)}i-l.texture.lastTouchTm>r&&(TextRender.showLog&&console.log(l.texture.id),l.destroy(),this.textAtlases[e]=this.textAtlases[t-1],t--,e--,s=-1)}for(this.textAtlases.length=t,t=this.isoTextures.length,e=0;e<t;e++)i-(o=this.isoTextures[e]).lastTouchTm>TextRender.destroyUnusedTextureDt&&(o.ri.deleted=!0,o.ri.tex=null,o.destroy(),this.isoTextures[e]=this.isoTextures[t-1],t--,e--);this.isoTextures.length=t;var u=this.textAtlases.length>1&&this.textAtlases.length-a>=2;(TextRender.atlasWidth*TextRender.atlasWidth*4*this.textAtlases.length>TextRender.cleanMem||u||TextRender.simClean)&&(TextRender.simClean=!1,TextRender.showLog&&console.log("清理使用率低的贴图。总使用率:",a,":",this.textAtlases.length,"最差贴图:"+s),s>=0&&((l=this.textAtlases[s]).destroy(),this.textAtlases[s]=this.textAtlases[this.textAtlases.length-1],this.textAtlases.length=this.textAtlases.length-1)),TextTexture.clean()}cleanAtlases(){}getCharBmp(e){}checkBmpLine(e,t,r,a){this.bmpData32.buffer!=e.data.buffer&&(this.bmpData32=new Uint32Array(e.data.buffer));for(var i=e.width*t+r,s=r;s<a;s++)if(0!=this.bmpData32[i++])return!0;return!1}updateBbx(e,t,r=!1){var a=e.width,i=e.height,s=0,n=t[1],o=0,l=n;if(this.checkBmpLine(e,n,0,a))for(;;){if((l=(n+o)/2|0)+1>=n){t[1]=l;break}this.checkBmpLine(e,l,0,a)?n=l:o=l}if(t[3]>i)t[3]=i;else if(l=n=t[3],o=i,this.checkBmpLine(e,n,0,a))for(;;){if((l=(n+o)/2|0)-1<=n){t[3]=l;break}this.checkBmpLine(e,l,0,a)?n=l:o=l}if(!r){var h=t[0],u=a*t[1];for(l=t[1];l<t[3];l++){for(s=0;s<h;s++)if(0!=this.bmpData32[u+s]){h=s;break}u+=a}t[0]=h;var d=t[2];for(u=a*t[1],l=t[1];l<t[3];l++){for(s=d;s<a;s++)if(0!=this.bmpData32[u+s]){d=s;break}u+=a}t[2]=d}}getFontSizeInfo(e){var t=this.fontSizeInfo[e];if(null!=t)return t;var r="bold "+TextRender.standardFontSize+"px "+e;if(TextRender.isWan1Wan){this.fontSizeW=1.5*this.charRender.getWidth(r,"有"),this.fontSizeH=1.5*TextRender.standardFontSize;var a=this.fontSizeW<<8|this.fontSizeH;return this.fontSizeInfo[e]=a,a}TextRender.pixelBBX[0]=TextRender.standardFontSize/2,TextRender.pixelBBX[1]=TextRender.standardFontSize/2,TextRender.pixelBBX[2]=TextRender.standardFontSize,TextRender.pixelBBX[3]=TextRender.standardFontSize;this.charRender.scale(1,1),TextRender.tmpRI.height=TextRender.standardFontSize,this.charRender.fontsz=TextRender.standardFontSize;var i=this.charRender.getCharBmp("g",r,0,"red",null,TextRender.tmpRI,16,16,16,16);this.bmpData32=new Uint32Array(i.data.buffer),this.updateBbx(i,TextRender.pixelBBX,!1),i=this.charRender.getCharBmp("有",r,0,"red",null,TextRender.tmpRI,16,16,16,16),this.bmpData32=new Uint32Array(i.data.buffer),TextRender.pixelBBX[2]<16+TextRender.tmpRI.width&&(TextRender.pixelBBX[2]=16+TextRender.tmpRI.width),this.updateBbx(i,TextRender.pixelBBX,!1);var s=Math.max(16-TextRender.pixelBBX[0],0)<<24|Math.max(16-TextRender.pixelBBX[1],0)<<16|TextRender.pixelBBX[2]-TextRender.pixelBBX[0]<<8|TextRender.pixelBBX[3]-TextRender.pixelBBX[1];return this.fontSizeInfo[e]=s,s}printDbgInfo(){for(var e in console.log("图集个数:"+this.textAtlases.length+",每个图集大小:"+TextRender.atlasWidth+"x"+TextRender.atlasWidth," 用canvas:",TextRender.isWan1Wan),console.log("图集占用空间:"+TextRender.atlasWidth*TextRender.atlasWidth*4/1024/1024*this.textAtlases.length+"M"),console.log("缓存用到的字体:"),this.mapFont){var t=this.getFontSizeInfo(e),r=t>>24,a=t>>16&255,i=t>>8&255,s=255&t;console.log("    "+e," off:",r,a," size:",i,s)}var n=0;console.log("缓存数据:");var o=0,l=0;this.textAtlases.forEach((function(e){var t=e.texture.id,r=RenderInfo.loopCount-e.texture.lastTouchTm,a=r>0?r+"帧以前":"当前帧";for(var i in o+=e.texture.curUsedCovRate,l+=e.texture.curUsedCovRateAtlas,console.log("--图集(id:"+t+",当前使用率:"+(1e3*e.texture.curUsedCovRate|0)+"‰","当前图集使用率:",(100*e.texture.curUsedCovRateAtlas|0)+"%","图集使用率:",100*e.usedRate|0,"%, 使用于:"+a+")--:"),e.charMaps){var s=e.charMaps[i];console.log("     off:",s.orix,s.oriy," bmp宽高:",s.bmpWidth,s.bmpHeight,"无效:",s.deleted,"touchdt:",RenderInfo.loopCount-s.touchTick,"位置:",s.uv[0]*TextRender.atlasWidth|0,s.uv[1]*TextRender.atlasWidth|0,"字符:",s.char,"key:",i),n++}})),console.log("独立贴图文字("+this.isoTextures.length+"个):"),this.isoTextures.forEach((function(e){console.log("    size:",e._texW,e._texH,"touch间隔:",RenderInfo.loopCount-e.lastTouchTm,"char:",e.ri.char)})),console.log("总缓存:",n,"总使用率:",o,"总当前图集使用率:",l)}showAtlas(e,t,r,a,i,s){if(!this.textAtlases[e])return console.log("没有这个图集"),null;var n=new Sprite,o=this.textAtlases[e].texture,l={width:TextRender.atlasWidth,height:TextRender.atlasWidth,sourceWidth:TextRender.atlasWidth,sourceHeight:TextRender.atlasWidth,offsetX:0,offsetY:0,getIsReady:function(){return!0},_addReference:function(){},_removeReference:function(){},_getSource:function(){return o._getSource()},bitmap:{id:o.id},_uv:Texture.DEF_UV};return n.size=function(e,r){return this.width=e,this.height=r,n.graphics.clear(),n.graphics.drawRect(0,0,n.width,n.height,t),n.graphics.drawTexture(l,0,0,n.width,n.height),this},n.graphics.drawRect(0,0,i,s,t),n.graphics.drawTexture(l,0,0,i,s),n.pos(r,a),ILaya.stage.addChild(n),n}filltext_native(e,t,r,a,i,s,n,o,l){if(!(t&&t.length<=0)){var h=FontInfo.parse(i),u=0;switch(l){case"center":u=Const.ENUM_TEXTALIGN_CENTER;break;case"right":u=Const.ENUM_TEXTALIGN_RIGHT}return this._fast_filltext(e,t,r,a,h,s,n,o,u)}}}TextRender.useOldCharBook=!1,TextRender.atlasWidth=1024,TextRender.noAtlas=!1,TextRender.forceSplitRender=!1,TextRender.forceWholeRender=!1,TextRender.scaleFontWithCtx=!0,TextRender.maxFontScale=4,TextRender.standardFontSize=32,TextRender.destroyAtlasDt=10,TextRender.checkCleanTextureDt=2e3,TextRender.destroyUnusedTextureDt=3e3,TextRender.cleanMem=104857600,TextRender.isWan1Wan=!1,TextRender.showLog=!1,TextRender.debugUV=!1,TextRender.tmpRI=new CharRenderInfo,TextRender.pixelBBX=[0,0,0,0],TextRender.imgdtRect=[0,0,0,0],TextRender.simClean=!1;class TextAtlas{constructor(){this.texWidth=1024,this.texHeight=1024,this.texture=null,this.charMaps={},this.texHeight=this.texWidth=TextRender.atlasWidth,this.texture=TextTexture.getTextTexture(this.texWidth,this.texHeight),this.texWidth/TextAtlas.atlasGridW>256&&(TextAtlas.atlasGridW=Math.ceil(this.texWidth/256)),this.atlasgrid=new AtlasGrid(this.texWidth/TextAtlas.atlasGridW,this.texHeight/TextAtlas.atlasGridW,this.texture.id)}setProtecteDist(e){}getAEmpty(e,t,r){var a=this.atlasgrid.addRect(1,Math.ceil(e/TextAtlas.atlasGridW),Math.ceil(t/TextAtlas.atlasGridW),r);return a&&(r.x*=TextAtlas.atlasGridW,r.y*=TextAtlas.atlasGridW),a}get usedRate(){return this.atlasgrid._used}destroy(){for(var e in this.charMaps){this.charMaps[e].deleted=!0}this.texture.discard()}printDebugInfo(){}}TextAtlas.atlasGridW=16;class TextTexture extends Resource{get gammaCorrection(){return this.bitmap._glTexture.gammaCorrection}constructor(e,t){super(),this._texW=0,this._texH=0,this._discardTm=0,this.genID=0,this.bitmap={id:0,_glTexture:null},this.curUsedCovRate=0,this.curUsedCovRateAtlas=0,this.lastTouchTm=0,this.ri=null,this._texW=e||TextRender.atlasWidth,this._texH=t||TextRender.atlasWidth,this.bitmap.id=this.id,this.lock=!0,this._render2DContext=LayaGL.render2DContext}recreateResource(){if(!this._source){var t=this._source=new Texture2D(this._texW,this._texH,e.TextureFormat.R8G8B8A8,!1,!1,!0,!0);t.setPixelsData(null,!0,!1),t.lock=!0,this.bitmap._glTexture=t,this._source.filterMode=e.FilterMode.Bilinear,this._source.wrapModeU=e.WrapMode.Clamp,this._source.wrapModeV=e.WrapMode.Clamp,TextRender.debugUV&&this.fillWhite()}}addChar(e,t,r,a=null){if(TextRender.isWan1Wan)return this.addCharCanvas(e,t,r,a);var i,s,n,o,l=e.data;return e.data instanceof Uint8ClampedArray&&(l=new Uint8Array(l.buffer)),!this._source&&this.recreateResource(),LayaGL.textureContext.setTextureSubPixelsData(this._source._texture,l,0,!1,t,r,e.width,e.height,!0,!1),i=t/this._texW,s=r/this._texH,n=(t+e.width)/this._texW,o=(r+e.height)/this._texH,(a=a||new Array(8))[0]=i,a[1]=s,a[2]=n,a[3]=s,a[4]=n,a[5]=o,a[6]=i,a[7]=o,a}addCharCanvas(e,t,r,a=null){var i,s,n,o;return!this._source&&this.recreateResource(),LayaGL.textureContext.setTextureSubImageData(this._source._texture,e,t,r,!0,!1),LayaEnv.isConch?(i=t/this._texW,s=r/this._texH,n=(t+e.width)/this._texW,o=(r+e.height)/this._texH):(i=(t+1)/this._texW,s=(r+1)/this._texH,n=(t+e.width-1)/this._texW,o=(r+e.height-1)/this._texH),(a=a||new Array(8))[0]=i,a[1]=s,a[2]=n,a[3]=s,a[4]=n,a[5]=o,a[6]=i,a[7]=o,a}fillWhite(){!this._source&&this.recreateResource();var e=new Uint8Array(this._texW*this._texH*4);e.fill(255),LayaGL.textureContext.setTextureImageData(this._source._getSource(),e,!0,!1)}discard(){ILaya.stage.setGlobalRepaint(),this.destroy()}static getTextTexture(e,t){return new TextTexture(e,t)}_disposeResource(){this._source&&this._source.destroy(),this._source=null}static clean(){var e=RenderInfo.loopStTm;if(0===TextTexture.cleanTm&&(TextTexture.cleanTm=e),e-TextTexture.cleanTm>=TextRender.checkCleanTextureDt){for(var t=0;t<TextTexture.poolLen;t++){var r=TextTexture.pool[t];e-r._discardTm>=TextRender.destroyUnusedTextureDt&&(r.destroy(),TextTexture.pool[t]=TextTexture.pool[TextTexture.poolLen-1],TextTexture.poolLen--,t--)}TextTexture.cleanTm=e}}touchRect(e,t){this.lastTouchTm!=t&&(this.curUsedCovRate=0,this.curUsedCovRateAtlas=0,this.lastTouchTm=t);var r=TextRender.atlasWidth*TextRender.atlasWidth,a=TextAtlas.atlasGridW*TextAtlas.atlasGridW;this.curUsedCovRate+=e.bmpWidth*e.bmpHeight/r,this.curUsedCovRateAtlas+=Math.ceil(e.bmpWidth/TextAtlas.atlasGridW)*Math.ceil(e.bmpHeight/TextAtlas.atlasGridW)/(r/a)}get texture(){return this}_getSource(){return this._source._getSource()}drawOnScreen(e,t){}}TextTexture.pool=new Array(10),TextTexture.poolLen=0,TextTexture.cleanTm=0,e.RenderSpriteData=void 0,(se=e.RenderSpriteData||(e.RenderSpriteData={}))[se.Zero=0]="Zero",se[se.Texture2D=1]="Texture2D",se[se.Primitive=2]="Primitive";class Value2D{static _initone(e,t){Value2D._typeClass[e]=t,Value2D._cache[e]=[],Value2D._cache[e]._length=0,Value2D.globalShaderData=new ShaderData}static create(e){var t=Value2D._cache[e]?Value2D._cache[e]:[];return t._length?t[--t._length]:new Value2D._typeClass[e]}set size(e){this.defines.setVector2(ShaderDefines2D.UNIFORM_SIZE,e)}get size(){return this.defines.getVector2(ShaderDefines2D.UNIFORM_SIZE)}set mmat(e){this.defines.setMatrix4x4(ShaderDefines2D.UNIFORM_MMAT,e)}get mmat(){return this.defines.getMatrix4x4(ShaderDefines2D.UNIFORM_MMAT)}set u_MvpMatrix(e){this.defines.setMatrix4x4(ShaderDefines2D.UNIFORM_MVPMatrix,e)}get u_MvpMatrix(){return this.defines.getMatrix4x4(ShaderDefines2D.UNIFORM_MVPMatrix)}get textureHost(){return this._textureHost}set textureHost(e){this._textureHost=e,this.defines.setTexture(ShaderDefines2D.UNIFORM_SPRITETEXTURE,e)}set color(e){e&&this.defines.setVector(ShaderDefines2D.UNIFORM_COLOR,e)}get color(){return this.defines.getVector(ShaderDefines2D.UNIFORM_COLOR)}set colorAdd(e){this.defines.setVector(ShaderDefines2D.UNIFORM_COLORADD,e)}get colorAdd(){return this.defines.getVector(ShaderDefines2D.UNIFORM_COLORADD)}set clipMatDir(e){this.defines.setVector(ShaderDefines2D.UNIFORM_CLIPMATDIR,e)}get clipMatDir(){return this.defines.getVector(ShaderDefines2D.UNIFORM_CLIPMATDIR)}set clipMatPos(e){this.defines.setVector2(ShaderDefines2D.UNIFORM_CLIPMATPOS,e)}get clipMatPos(){return this.defines.getVector2(ShaderDefines2D.UNIFORM_CLIPMATPOS)}set clipOff(e){this.defines.setVector2(ShaderDefines2D.UNIFORM_CLIPOFF,e)}get clipOff(){return this.defines.getVector2(ShaderDefines2D.UNIFORM_CLIPOFF)}constructor(t){this.defines=new ShaderData,this.alpha=1,this.ALPHA=1,this.mainID=e.RenderSpriteData.Zero,this.ref=1,this._cacheID=0,this._size=new Vector2,this._mmat=new Matrix4x4,this._clipMatDir=new Vector4(Const.MAX_CLIP_SIZE,0,0,Const.MAX_CLIP_SIZE),this._clipMatpos=new Vector2,this._clipOff=new Vector2,this.mainID=t,this.textureHost=null,this.texture=null,this.clipMatDir=this._clipMatDir,this.clipMatPos=this._clipMatpos,this.clipOff=this._clipOff,this._cacheID=t,this._inClassCache=Value2D._cache[this._cacheID],t>0&&!this._inClassCache&&(this._inClassCache=Value2D._cache[this._cacheID]=[],this._inClassCache._length=0),this.clear()}updateShaderData(){var t=RenderState2D;RenderState2D.worldMatrix4===RenderState2D.TEMPMAT4_ARRAY||this.defines.addDefine(ShaderDefines2D.WORLDMAT),this._mmat.cloneByArray(t.worldMatrix4),this.mmat=this._mmat,RenderState2D.matWVP&&(this.defines.addDefine(ShaderDefines2D.MVP3D),this.u_MvpMatrix=RenderState2D.matWVP);let r=!RenderTexture2D.currentActive||1!=RenderTexture2D.currentActive._texture.gammaCorrection,a=!1;this.textureHost&&(this.textureHost instanceof RenderTexture2D?a=1!=this.textureHost.gammaCorrection:this.textureHost instanceof Texture&&this.textureHost.bitmap?a=1!=this.textureHost.bitmap.gammaCorrection:this.textureHost instanceof TextTexture&&this.textureHost.bitmap&&(a=1!=this.textureHost.gammaCorrection)),a?this.defines.addDefine(ShaderDefines2D.GAMMATEXTURE):this.defines.removeDefine(ShaderDefines2D.GAMMATEXTURE),r?this.defines.addDefine(ShaderDefines2D.GAMMASPACE):this.defines.removeDefine(ShaderDefines2D.GAMMASPACE),RenderState2D.InvertY?this.defines.addDefine(ShaderDefines2D.INVERTY):this.defines.removeDefine(ShaderDefines2D.INVERTY),this.mainID==e.RenderSpriteData.Texture2D&&this.defines.addDefine(ShaderDefines2D.TEXTURESHADER),this.mainID==e.RenderSpriteData.Primitive&&this.defines.addDefine(ShaderDefines2D.PRIMITIVESHADER)}upload(e=null){if(this._size.setValue(RenderState2D.width,RenderState2D.height),this.size=this._size,this.updateShaderData(),e){for(var t,r=0,a=(i=e._shader._subShaders[0]._passes).length;r<a&&"Forward"!=(t=i[r])._pipelineMode;r++);Value2D._compileDefine,this.defines._defineDatas.cloneTo(Value2D._compileDefine),Value2D._compileDefine.addDefineDatas(e._defineDatas),Value2D._compileDefine.addDefineDatas(Value2D.globalShaderData._defineDatas),(s=t.withCompile(Value2D._compileDefine,!0)).bind(),s.uploadUniforms(s._sprite2DUniformParamsMap,this.defines,!0),s.uploadUniforms(s._sceneUniformParamsMap,Value2D.globalShaderData,!0),s.uploadUniforms(s._materialUniformParamsMap,e.shaderData,!0)}else{var i,s;if((i=this._defaultShader._subShaders[0]._passes).length>=1)(s=(t=i[0]).withCompile(this.defines._defineDatas,!0)).bind(),s.uploadUniforms(s._sprite2DUniformParamsMap,this.defines,!0)}}setFilters(e){if(this.filters=e,e)for(var t,r=e.length,a=0;a<r;a++)(t=e[a])&&(this.defines.addDefine(t.typeDefine),t.action.setValue(this))}clear(){this.clipOff.x=0,this.clipOff=this.clipOff}release(){--this.ref<1&&(this._inClassCache&&(this._inClassCache[this._inClassCache._length++]=this),this.clear(),this.filters=null,this.ref=1,this.clipOff.x=0,this.clipOff=this.clipOff,this.texture=null,this.textureHost=null)}}Value2D._cache=[],Value2D._typeClass=[],Value2D.TEMPMAT4_ARRAY=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Value2D._compileDefine=new DefineDatas;class SubmitKey{constructor(){this.clear()}clear(){this.submitType=-1,this.blendShader=this.other=0}copyFrom(e){this.other=e.other,this.blendShader=e.blendShader,this.submitType=e.submitType}copyFrom2(e,t,r){this.other=r,this.submitType=t}equal3_2(e,t,r){return this.submitType===t&&this.other===r&&this.blendShader===e.blendShader}equal4_2(e,t,r){return this.submitType===t&&this.other===r&&this.blendShader===e.blendShader}equal_3(e){return this.submitType===e.submitType&&this.blendShader===e.blendShader}equal(e){return this.other===e.other&&this.submitType===e.submitType&&this.blendShader===e.blendShader}}class SubmitCMD{constructor(){this._ref=1,this._key=new SubmitKey}renderSubmit(){return this.fun.apply(this._this,this.args),1}getRenderType(){return 0}releaseRender(){if(--this._ref<1){var e=SubmitCMD.POOL;e[e._length++]=this,this.args=null,this.fun=null,this._this=null}}static create(e,t,r){var a=SubmitCMD.POOL._length?SubmitCMD.POOL[--SubmitCMD.POOL._length]:new SubmitCMD;return a.fun=t,a.args=e,a._this=r,a._ref=1,a._key.clear(),a}}SubmitCMD.POOL=[],SubmitCMD.POOL._length=0;class Filter{constructor(){}get type(){return-1}}Filter.BLUR=16,Filter.COLOR=32,Filter.GLOW=8,Filter._filter=function(t,r,a,i){var s=r,n=this._next;if(n){var o=t.filters,l=o.length;if(1==l&&o[0].type==Filter.COLOR)return r.save(),r.setColorFilter(o[0]),n._fun.call(n,t,r,a,i),void r.restore();var h,u=Value2D.create(e.RenderSpriteData.Texture2D),d=Point.TEMP,_=s._curMat,c=Matrix.create();_.copyTo(c);var p=0,m=0,f=null,g=t._cacheStyle.filterCache||null;if(g&&0==t.getRepaint()){if((t._isHaveGlowFilter()||!1)&&(p=50,m=25),(h=t.getBounds()).width<=0||h.height<=0)return;h.width+=p+8,h.height+=p+8,h.x-=t.pivotX+4,h.y-=t.pivotY+4,d.x=h.x*c.a+h.y*c.c,d.y=h.y*c.d+h.x*c.b,h.x=d.x,h.y=d.y,d.x=h.width*c.a+h.height*c.c,d.y=h.height*c.d+h.width*c.b,h.width=d.x,h.height=d.y}else{t._isHaveGlowFilter()&&(p=50,m=25),(h=new Rectangle).copyFrom(t.getSelfBounds()),h.x+=t.x,h.y+=t.y,h.x-=t.pivotX+4,h.y-=t.pivotY+4;var T=h.x,S=h.y;if(h.width+=p+8,h.height+=p+8,h.width=Math.ceil(h.width),h.height=Math.ceil(h.height),d.x=h.x*c.a+h.y*c.c,d.y=h.y*c.d+h.x*c.b,h.x=d.x,h.y=d.y,d.x=h.width*c.a+h.height*c.c,d.y=h.height*c.d+h.width*c.b,h.width=d.x,h.height=d.y,h.width<=0||h.height<=0)return;g&&WebGLRTMgr.releaseRT(g),f=WebGLRTMgr.getRT(h.width,h.height);var x=g=WebGLRTMgr.getRT(h.width,h.height);t._getCacheStyle().filterCache=g,s.pushRT(),s.useRT(f);var y=t.x-T+m,E=t.y-S+m;n._fun.call(n,t,r,y,E),s.useRT(x);for(var R=0;R<l;R++){0!=R&&(s.useRT(f),s.drawTarget(x,0,0,h.width,h.height,Matrix.TEMP.identity(),u,null,BlendMode.TOINT.overlay),s.useRT(x));var b=o[R];switch(b.type){case Filter.BLUR:case Filter.GLOW:b._glRender&&b._glRender.render(f,r,h.width,h.height,b);break;case Filter.COLOR:s.setColorFilter(b),s.drawTarget(f,0,0,h.width,h.height,Matrix.EMPTY.identity(),Value2D.create(e.RenderSpriteData.Texture2D)),s.setColorFilter(null)}}s.popRT()}if(a=a-m-t.x,i=i-m-t.y,d.setTo(a,i),c.transformPoint(d),a=d.x+h.x,i=d.y+h.y,s._drawRenderTexture(g,a,i,h.width,h.height,Matrix.TEMP.identity(),1,RenderTexture2D.defuv),f){var C=SubmitCMD.create([f],(function(e){e.destroy()}),this);f=null,r.addRenderObject(C)}c.destroy()}};const oe={purple:"#800080",orange:"#ffa500",white:"#FFFFFF",red:"#FF0000",green:"#00FF00",blue:"#0000FF",black:"#000000",yellow:"#FFFF00",gray:"#808080"};class ColorUtils{constructor(e){if(this.arrColor=[],null==e||"none"==e)return this.strColor="#00000000",this.numColor=0,void(this.arrColor=[0,0,0,0]);let t;"string"==typeof e?(t=Utils.fromStringColor(e),this.strColor=e):(t=e,this.strColor=Utils.toHexColor(t)),this.strColor.indexOf("rgba")>=0||9===this.strColor.length?(this.arrColor=[((4278190080&t)>>>24)/255,((16711680&t)>>16)/255,((65280&t)>>8)/255,(255&t)/255],this.numColor=(4278190080&t)>>>24|(16711680&t)>>8|(65280&t)<<8|(255&t)<<24):(this.arrColor=[((16711680&t)>>16)/255,((65280&t)>>8)/255,(255&t)/255,1],this.numColor=4278190080|(16711680&t)>>16|65280&t|(255&t)<<16)}static _initDefault(){for(var e in ColorUtils._DEFAULT={},oe)ColorUtils._SAVE[e]=ColorUtils._DEFAULT[e]=new ColorUtils(oe[e]);return ColorUtils._DEFAULT}static _initSaveMap(){ColorUtils._SAVE_SIZE=0,ColorUtils._SAVE=Object.assign({},ColorUtils._DEFAULT)}static create(e){let t=e+"",r=ColorUtils._SAVE[t];return null!=r?r:(ColorUtils._SAVE_SIZE>500&&ColorUtils._initSaveMap(),ColorUtils._SAVE_SIZE++,ColorUtils._SAVE[t]=new ColorUtils(e))}}ColorUtils._SAVE={},ColorUtils._SAVE_SIZE=0,ColorUtils._DEFAULT=ColorUtils._initDefault();const le=[0,.01,.02,.04,.05,.06,.07,.08,.1,.11,.12,.14,.15,.16,.17,.18,.2,.21,.22,.24,.25,.27,.28,.3,.32,.34,.36,.38,.4,.42,.44,.46,.48,.5,.53,.56,.59,.62,.65,.68,.71,.74,.77,.8,.83,.86,.89,.92,.95,.98,1,1.06,1.12,1.18,1.24,1.3,1.36,1.42,1.48,1.54,1.6,1.66,1.72,1.78,1.84,1.9,1.96,2,2.12,2.25,2.37,2.5,2.62,2.75,2.87,3,3.2,3.4,3.6,3.8,4,4.3,4.7,4.9,5,5.5,6,6.5,6.8,7,7.3,7.5,7.8,8,8.4,8.7,9,9.4,9.6,9.8,10],he=[.3086,.6094,.082,0,0,.3086,.6094,.082,0,0,.3086,.6094,.082,0,0,0,0,0,1,0],ue=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1];class ColorFilter extends Filter{constructor(e=null){super(),e||(e=this._copyMatrix(ue)),this._mat=new Float32Array(16),this._alpha=new Float32Array(4),this.setByMatrix(e)}gray(){return this.setByMatrix(he)}color(e=0,t=0,r=0,a=1){return this.setByMatrix([e,0,0,0,1,0,t,0,0,1,0,0,r,0,1,0,0,0,a,0])}setColor(e){var t=ColorUtils.create(e).arrColor,r=[0,0,0,0,256*t[0],0,0,0,0,256*t[1],0,0,0,0,256*t[2],0,0,0,1,0];return this.setByMatrix(r)}setByMatrix(e){this._matrix!=e&&this._copyMatrix(e);for(var t=0,r=0,a=0;a<20;a++)a%5!=4?this._mat[t++]=e[a]:this._alpha[r++]=e[a];return this}get type(){return Filter.COLOR}get typeDefine(){return ShaderDefines2D.FILTERCOLOR}adjustColor(e,t,r,a){return this.adjustHue(a),this.adjustContrast(t),this.adjustBrightness(e),this.adjustSaturation(r),this}adjustBrightness(e){return 0==(e=this._clampValue(e,100))||isNaN(e)?this:this._multiplyMatrix([1,0,0,0,e,0,1,0,0,e,0,0,1,0,e,0,0,0,1,0,0,0,0,0,1])}adjustContrast(e){if(0==(e=this._clampValue(e,100))||isNaN(e))return this;var t,r=(t=e<0?127+e/100*127:127*(t=0==(t=e%1)?le[e]:le[e<<0]*(1-t)+le[1+(e<<0)]*t)+127)/127,a=.5*(127-t);return this._multiplyMatrix([r,0,0,0,a,0,r,0,0,a,0,0,r,0,a,0,0,0,1,0,0,0,0,0,1])}adjustSaturation(e){if(0==(e=this._clampValue(e,100))||isNaN(e))return this;var t=1+(e>0?3*e/100:e/100),r=1-t,a=.3086*r,i=.6094*r,s=.082*r;return this._multiplyMatrix([a+t,i,s,0,0,a,i+t,s,0,0,a,i,s+t,0,0,0,0,0,1,0,0,0,0,0,1])}adjustHue(e){if(0==(e=this._clampValue(e,180)/180*Math.PI)||isNaN(e))return this;var t=Math.cos(e),r=Math.sin(e),a=.213,i=.715,s=.072;return this._multiplyMatrix([a+t*(1-a)+r*-a,i+t*-i+r*-i,s+t*-s+r*(1-s),0,0,a+t*-a+.143*r,i+t*(1-i)+.14*r,s+t*-s+-.283*r,0,0,a+t*-a+-.787*r,i+t*-i+r*i,s+t*(1-s)+r*s,0,0,0,0,0,1,0,0,0,0,0,1])}reset(){return this.setByMatrix(this._copyMatrix(ue))}_multiplyMatrix(e){var t=[];this._matrix=this._fixMatrix(this._matrix);for(var r=0;r<5;r++){for(var a=0;a<5;a++)t[a]=this._matrix[a+5*r];for(a=0;a<5;a++){for(var i=0,s=0;s<5;s++)i+=e[a+5*s]*t[s];this._matrix[a+5*r]=i}}return this.setByMatrix(this._matrix)}_clampValue(e,t){return Math.min(t,Math.max(-t,e))}_fixMatrix(e=null){return null==e?ue:(e.length<25?e=e.slice(0,e.length).concat(ue.slice(e.length,25)):e.length>25&&(e=e.slice(0,25)),e)}_copyMatrix(e){this._matrix||(this._matrix=[]);for(var t=0;t<25;t++)this._matrix[t]=e[t];return this._matrix}onAfterDeserialize(){let e=ColorUtils.create(this._color||"#FFFFFF").arrColor;this.color(e[0],e[1],e[2],e[3]),this.adjustColor(this._brightness||0,this._contrast||0,this._saturation||0,this._hue||0)}}class GrahamScan{static multiply(e,t,r){return(e.x-r.x)*(t.y-r.y)-(t.x-r.x)*(e.y-r.y)}static dis(e,t){return(e.x-t.x)*(e.x-t.x)+(e.y-t.y)*(e.y-t.y)}static _getPoints(e,t=!1,r=null){for(GrahamScan._mPointList||(GrahamScan._mPointList=[]);GrahamScan._mPointList.length<e;)GrahamScan._mPointList.push(new Point);return r||(r=[]),r.length=0,t?GrahamScan.getFrom(r,GrahamScan._mPointList,e):GrahamScan.getFromR(r,GrahamScan._mPointList,e),r}static getFrom(e,t,r){var a;for(a=0;a<r;a++)e.push(t[a]);return e}static getFromR(e,t,r){var a;for(a=0;a<r;a++)e.push(t.pop());return e}static pListToPointList(e,t=!1){var r,a=e.length/2,i=GrahamScan._getPoints(a,t,GrahamScan._tempPointList);for(r=0;r<a;r++)i[r].setTo(e[r+r],e[r+r+1]);return i}static pointListToPlist(e){var t,r,a=e.length,i=GrahamScan._temPList;for(i.length=0,t=0;t<a;t++)r=e[t],i.push(r.x,r.y);return i}static scanPList(e){return Utils.copyArray(e,GrahamScan.pointListToPlist(GrahamScan.scan(GrahamScan.pListToPointList(e,!0))))}static scan(e){var t,r,a,i,s,n=0,o=e.length,l={};for((i=GrahamScan._temArr).length=0,t=(o=e.length)-1;t>=0;t--)(s=(a=e[t]).x+"_"+a.y)in l||(l[s]=!0,i.push(a));for(o=i.length,Utils.copyArray(e,i),t=1;t<o;t++)(e[t].y<e[n].y||e[t].y==e[n].y&&e[t].x<e[n].x)&&(n=t);for(a=e[0],e[0]=e[n],e[n]=a,t=1;t<o-1;t++){for(n=t,r=t+1;r<o;r++)(GrahamScan.multiply(e[r],e[n],e[0])>0||0==GrahamScan.multiply(e[r],e[n],e[0])&&GrahamScan.dis(e[0],e[r])<GrahamScan.dis(e[0],e[n]))&&(n=r);a=e[t],e[t]=e[n],e[n]=a}if((i=GrahamScan._temArr).length=0,e.length<3)return Utils.copyArray(i,e);for(i.push(e[0],e[1],e[2]),t=3;t<o;t++){for(;i.length>=2&&GrahamScan.multiply(e[t],i[i.length-1],i[i.length-2])>=0;)i.pop();e[t]&&i.push(e[t])}return i}}GrahamScan._tempPointList=[],GrahamScan._temPList=[],GrahamScan._temArr=[];class SpriteConst{}var de,_e,ce,pe;SpriteConst.ALPHA=1,SpriteConst.TRANSFORM=2,SpriteConst.BLEND=4,SpriteConst.CANVAS=8,SpriteConst.FILTERS=16,SpriteConst.MASK=32,SpriteConst.CLIP=64,SpriteConst.STYLE=128,SpriteConst.TEXTURE=256,SpriteConst.GRAPHICS=512,SpriteConst.LAYAGL3D=1024,SpriteConst.CUSTOM=2048,SpriteConst.ONECHILD=4096,SpriteConst.HITAREA=8192,SpriteConst.CHILDS=16384,SpriteConst.REPAINT_NONE=0,SpriteConst.REPAINT_NODE=1,SpriteConst.REPAINT_CACHE=2,SpriteConst.REPAINT_ALL=3,e.RenderStatisticsInfo=void 0,(de=e.RenderStatisticsInfo||(e.RenderStatisticsInfo={}))[de.DrawCall=0]="DrawCall",de[de.InstanceDrawCall=1]="InstanceDrawCall",de[de.Triangle=2]="Triangle",de[de.UniformUpload=3]="UniformUpload",de[de.GPUMemory=4]="GPUMemory",de[de.TextureMemeory=5]="TextureMemeory",de[de.RenderTextureMemory=6]="RenderTextureMemory",de[de.BufferMemory=7]="BufferMemory";class Stat{static show(e,t,r){Stat.checkUI()&&(this.hide(),Stat._show=!0,Stat._currentShowArray=r||Stat.AllShow,Stat._statUI.show(e,t,Stat._currentShowArray),ILaya.systemTimer.frameLoop(1,null,Stat.loop))}static showToggle(e,t,r){Stat.checkUI()&&(this.hide(),Stat._show=!0,Stat._currentToggleArray=r,Stat._statUI.showToggle(e,t,r),ILaya.systemTimer.frameLoop(1,null,Stat.loop))}static checkUI(){if(!Stat._statUI){let e=ClassUtils.getClass("StatUI");if(!e)return console.error("StatUI not found"),!1;Stat._statUI=new e}return!0}static hide(){Stat._show&&(Stat._show=!1,Stat._currentShowArray=null,Stat._currentToggleArray=null,ILaya.systemTimer.clear(null,Stat.loop),Stat._statUI&&Stat._statUI.hide())}static loop(){Stat._count++;let e=Browser.now();if(e-Stat._timer<1e3)return;let t=Stat._count;if(Stat.FPS=Math.round(1e3*t/(e-Stat._timer)),Stat._show){Stat.updateEngineData();let e=Stat.FPS>0?Math.floor(1e3/Stat.FPS).toString():" ";Stat._fpsStr=Stat.FPS+(Stat.renderSlow?" slow":"")+" "+e+"ms",Stat._statUI.update(),Stat.clear()}Stat._count=0,Stat._timer=e}static updateEngineData(){Stat.trianglesFaces=LayaGL.renderEngine.getStatisticsInfo(e.RenderStatisticsInfo.Triangle),Stat.drawCall=LayaGL.renderEngine.getStatisticsInfo(e.RenderStatisticsInfo.DrawCall),Stat.instanceDrawCall=LayaGL.renderEngine.getStatisticsInfo(e.RenderStatisticsInfo.InstanceDrawCall),Stat.gpuMemory=LayaGL.renderEngine.getStatisticsInfo(e.RenderStatisticsInfo.GPUMemory),Stat.textureMemory=LayaGL.renderEngine.getStatisticsInfo(e.RenderStatisticsInfo.TextureMemeory),Stat.renderTextureMemory=LayaGL.renderEngine.getStatisticsInfo(e.RenderStatisticsInfo.RenderTextureMemory),Stat.bufferMemory=LayaGL.renderEngine.getStatisticsInfo(e.RenderStatisticsInfo.BufferMemory)}static clear(){Stat._currentShowArray&&(Stat._currentShowArray.forEach((e=>{"average"==e.mode&&(Stat[e.value]=0)})),LayaGL.renderEngine.clearStatisticsInfo(e.RenderStatisticsInfo.Triangle),LayaGL.renderEngine.clearStatisticsInfo(e.RenderStatisticsInfo.DrawCall),LayaGL.renderEngine.clearStatisticsInfo(e.RenderStatisticsInfo.InstanceDrawCall))}static render(e,t,r){Stat._show&&Stat._statUI.render(e,t,r)}}Stat.FPSStatUIParams={title:"FPS",value:"_fpsStr",color:"yellow",units:"int",mode:"summit"},Stat.NodeStatUIParams={title:"Node",value:"spriteCount",color:"white",units:"int",mode:"summit"},Stat.Sprite3DStatUIParams={title:"Sprite3D",value:"sprite3DCount",color:"white",units:"int",mode:"summit"},Stat.DrawCall={title:"DrawCall",value:"drawCall",color:"white",units:"int",mode:"average"},Stat.TriangleFace={title:"TriangleFace",value:"trianglesFaces",color:"white",units:"int",mode:"average"},Stat.RenderNode={title:"RenderNode",value:"renderNode",color:"white",units:"int",mode:"summit"},Stat.SkinRenderNode={title:"SkinRenderNode",value:"skinRenderNode",color:"white",units:"int",mode:"summit"},Stat.ParticleRenderNode={title:"ParticleRenderNode",value:"particleRenderNode",color:"white",units:"int",mode:"summit"},Stat.FrustumCulling={title:"FrustumCulling",value:"frustumCulling",color:"white",units:"int",mode:"average"},Stat.UniformUpload={title:"UniformUpload",value:"uniformUpload",color:"white",units:"int",mode:"average"},Stat.OpaqueDrawCall={title:"OpaqueDrawCall",value:"opaqueDrawCall",color:"white",units:"int",mode:"average"},Stat.TransDrawCall={title:"TransDrawCall",value:"transDrawCall",color:"white",units:"int",mode:"average"},Stat.DepthCastDrawCall={title:"DepthCastDrawCall",value:"depthCastDrawCall",color:"white",units:"int",mode:"average"},Stat.InstanceDrawCall={title:"InstanceDrawCall",value:"instanceDrawCall",color:"white",units:"int",mode:"average"},Stat.CMDDrawCall={title:"CMDDrawCall",value:"cmdDrawCall",color:"white",units:"int",mode:"average"},Stat.BlitDrawCall={title:"BlitDrawCall",value:"blitDrawCall",color:"white",units:"int",mode:"average"},Stat.GPUMemory={title:"GPUMemory",value:"gpuMemory",color:"white",units:"M",mode:"summit"},Stat.TextureMemeory={title:"TextureMemory",value:"textureMemory",color:"white",units:"M",mode:"summit"},Stat.RenderTextureMemory={title:"RenderTextureMemory",value:"renderTextureMemory",color:"white",units:"M",mode:"summit"},Stat.BufferMemory={title:"BufferMemory",value:"bufferMemory",color:"white",units:"M",mode:"summit"},Stat.uploadUniformNum={title:"UploadUniformNum",value:"uploadUniform",color:"white",units:"int",mode:"average"},Stat.AllShow=[Stat.FPSStatUIParams,Stat.NodeStatUIParams,Stat.Sprite3DStatUIParams,Stat.DrawCall,Stat.TriangleFace,Stat.RenderNode,Stat.SkinRenderNode,Stat.ParticleRenderNode,Stat.FrustumCulling,Stat.OpaqueDrawCall,Stat.TransDrawCall,Stat.DepthCastDrawCall,Stat.InstanceDrawCall,Stat.CMDDrawCall,Stat.BlitDrawCall,Stat.GPUMemory,Stat.TextureMemeory,Stat.RenderTextureMemory,Stat.BufferMemory,Stat.uploadUniformNum],Stat.memoryShow=[Stat.GPUMemory,Stat.TextureMemeory,Stat.RenderTextureMemory,Stat.BufferMemory],Stat.renderShow=[Stat.DrawCall,Stat.TriangleFace,Stat.OpaqueDrawCall,Stat.TransDrawCall,Stat.DepthCastDrawCall,Stat.InstanceDrawCall,Stat.CMDDrawCall,Stat.BlitDrawCall],Stat.toogle_Shadow={title:"Shadow",value:"enableShadow",color:"white"},Stat.toogle_MulLight={title:"MulLight",value:"enableMulLight",color:"white"},Stat.toogle_Light={title:"Light",value:"enableLight",color:"white"},Stat.toogle_Postprocess={title:"Postprocess",value:"enablePostprocess",color:"white"},Stat.toogle_AnimatorUpdate={title:"AnimatorUpdate",value:"enableAnimatorUpdate",color:"white"},Stat.toogle_PhysicsUpdate={title:"PhysicsUpdate",value:"enablePhysicsUpdate",color:"white"},Stat.toogle_Skin={title:"Skin",value:"enableSkin",color:"white"},Stat.toogle_Transparent={title:"Transparent",value:"enableTransparent",color:"white"},Stat.toogle_Particle={title:"Particle",value:"enableParticle",color:"white"},Stat.toogle_msaa={title:"MSAA",value:"enablemsaa",color:"white"},Stat.toogle_CameraCMD={title:"CameraCMD",value:"enableCameraCMD",color:"white"},Stat.toogle_Opaque={title:"Opaque",value:"enableOpaque",color:"white"},Stat.AllToggle=[Stat.toogle_Shadow,Stat.toogle_Light,Stat.toogle_MulLight,Stat.toogle_Postprocess,Stat.toogle_AnimatorUpdate,Stat.toogle_PhysicsUpdate,Stat.toogle_Opaque,Stat.toogle_Transparent,Stat.toogle_CameraCMD,Stat.toogle_Skin,Stat.toogle_Particle,Stat.toogle_msaa],Stat.RenderModeToggle=[Stat.toogle_Shadow,Stat.toogle_Light,Stat.toogle_MulLight,Stat.toogle_Postprocess,Stat.toogle_AnimatorUpdate,Stat.toogle_PhysicsUpdate],Stat.RenderFuncToggle=[Stat.toogle_Opaque,Stat.toogle_Transparent,Stat.toogle_CameraCMD,Stat.toogle_Skin,Stat.toogle_Particle,Stat.toogle_msaa],Stat.FPS=0,Stat.loopCount=0,Stat.spriteRenderUseCacheCount=0,Stat.canvasNormal=0,Stat.canvasBitmap=0,Stat.canvasReCache=0,Stat.renderSlow=!1,Stat._timer=0,Stat._count=0,Stat._fpsStr="",Stat.spriteCount=0,Stat.sprite3DCount=0,Stat.drawCall=0,Stat.trianglesFaces=0,Stat.renderNode=0,Stat.skinRenderNode=0,Stat.particleRenderNode=0,Stat.frustumCulling=0,Stat.uniformUpload=0,Stat.opaqueDrawCall=0,Stat.transDrawCall=0,Stat.depthCastDrawCall=0,Stat.instanceDrawCall=0,Stat.cmdDrawCall=0,Stat.blitDrawCall=0,Stat.textureMemory=0,Stat.renderTextureMemory=0,Stat.bufferMemory=0,Stat.uploadUniform=0,Stat.enableShadow=!0,Stat.enableMulLight=!0,Stat.enableLight=!0,Stat.enableCameraCMD=!0,Stat.enablePostprocess=!0,Stat.enableSkin=!0,Stat.enableTransparent=!0,Stat.enableParticle=!0,Stat.enableAnimatorUpdate=!0,Stat.enablePhysicsUpdate=!0,Stat.enablemsaa=!0,Stat.enableOpaque=!0,window.Stat=Stat;class SubmitBase{static __init__(){var t=SubmitBase.RENDERBASE=new SubmitBase(-1);t.shaderValue=new Value2D(e.RenderSpriteData.Zero),t.shaderValue.ALPHA=1,t._ref=4294967295}constructor(e=SubmitBase.TYPE_2D){this.clipInfoID=-1,this._mesh=null,this._blendFn=null,this._id=0,this._renderType=0,this._parent=null,this._key=new SubmitKey,this._startIdx=0,this._numEle=0,this._ref=1,this.shaderValue=null,this._renderType=e,this._id=++SubmitBase.ID}getID(){return this._id}getRenderType(){return this._renderType}toString(){return"ibindex:"+this._startIdx+" num:"+this._numEle+" key="+this._key}renderSubmit(){return 1}releaseRender(){}}SubmitBase.TYPE_2D=1e4,SubmitBase.TYPE_CANVAS=10003,SubmitBase.TYPE_CMDSETRT=10004,SubmitBase.TYPE_CUSTOM=10005,SubmitBase.TYPE_BLURRT=10006,SubmitBase.TYPE_CMDDESTORYPRERT=10007,SubmitBase.TYPE_DISABLESTENCIL=10008,SubmitBase.TYPE_OTHERIBVB=10009,SubmitBase.TYPE_PRIMITIVE=10010,SubmitBase.TYPE_RT=10011,SubmitBase.TYPE_BLUR_RT=10012,SubmitBase.TYPE_TARGET=10013,SubmitBase.TYPE_CHANGE_VALUE=10014,SubmitBase.TYPE_SHAPE=10015,SubmitBase.TYPE_TEXTURE=10016,SubmitBase.TYPE_FILLTEXTURE=10017,SubmitBase.KEY_ONCE=-1,SubmitBase.KEY_FILLRECT=1,SubmitBase.KEY_DRAWTEXTURE=2,SubmitBase.KEY_VG=3,SubmitBase.KEY_TRIANGLES=4,SubmitBase.ID=1,SubmitBase.preRender=null,e.BufferTargetType=void 0,(_e=e.BufferTargetType||(e.BufferTargetType={}))[_e.ARRAY_BUFFER=0]="ARRAY_BUFFER",_e[_e.ELEMENT_ARRAY_BUFFER=1]="ELEMENT_ARRAY_BUFFER",_e[_e.UNIFORM_BUFFER=2]="UNIFORM_BUFFER",_e[_e.COPY_READ_BUFFER=3]="COPY_READ_BUFFER",_e[_e.COPY_WRITE_BUFFER=4]="COPY_WRITE_BUFFER",_e[_e.TRANSFORM_FEEDBACK_BUFFER=5]="TRANSFORM_FEEDBACK_BUFFER",_e[_e.PIXEL_PACK_BUFFER=6]="PIXEL_PACK_BUFFER",_e[_e.PIXEL_UNPACK_BUFFER=7]="PIXEL_UNPACK_BUFFER",e.BufferUsage=void 0,(ce=e.BufferUsage||(e.BufferUsage={}))[ce.Static=0]="Static",ce[ce.Dynamic=1]="Dynamic",ce[ce.Stream=2]="Stream";class VertexAttributeLayout{static getVertexLayoutByPool(e){let t=VertexAttributeLayout._pool;for(var r in t){let a=t[r];if(a.deepthEqaul(e))return a}return new VertexAttributeLayout(e)}constructor(e){this.VAElements=new Array,this.attributeByteSize=new Array,this.instanceMode=new Array;for(let t=0;t<e.length;t++){let r=[],a=e[t].vertexDeclaration.vertexStride,i=e[t].vertexDeclaration._VAElements;for(let e=0;e<i.length;e++)r.push({format:i[e].format,stride:i[e].stride,shaderLocation:i[e].shaderLocation});this.attributeByteSize.push(a),this.VAElements.push(r),this.instanceMode.push(e[t].instanceBuffer)}this.id=VertexAttributeLayout.IPoint,VertexAttributeLayout._pool[VertexAttributeLayout.IPoint++]=this}deepthEqaul(e){if(e.length!=this.VAElements.length)return!1;for(var t=0;t<e.length;t++){let i=e[t]._vertexDeclaration._VAElements,s=this.VAElements[t];if(i.length!=s.length)return!1;for(var r=0,a=i.length;r<a;r++){let e=i[r],t=s[r];if(e.format!=t.format||e.stride!=t.stride||e.shaderLocation!=t.shaderLocation)return!1}}return!0}}VertexAttributeLayout.IPoint=0,VertexAttributeLayout._pool={};class BufferState{constructor(){this._nativeVertexArrayObject=LayaGL.renderEngine.createVertexState()}applyVertexBuffers(){this._nativeVertexArrayObject&&this._nativeVertexArrayObject.applyVertexBuffer(this._vertexBuffers)}applyIndexBuffers(){this._nativeVertexArrayObject&&this._nativeVertexArrayObject.applyIndexBuffer(this._bindedIndexBuffer)}applyState(e,t){this.vertexlayout=VertexAttributeLayout.getVertexLayoutByPool(e),this._vertexBuffers=e,this._bindedIndexBuffer=t,this._nativeVertexArrayObject&&(t&&t.unbind(),this.bind(),this.applyVertexBuffers(),this.applyIndexBuffers(),this.unBind(),t&&t.unbind())}bind(){this._nativeVertexArrayObject&&(this._nativeVertexArrayObject.bindVertexArray(),BufferState._curBindedBufferState=this)}unBind(){if(this._nativeVertexArrayObject){if(BufferState._curBindedBufferState!=this)throw"BufferState: must call bind() function first.";this._nativeVertexArrayObject.unbindVertexArray(),BufferState._curBindedBufferState=null}}isbind(){return BufferState._curBindedBufferState==this}static clearbindBufferState(){LayaGL.renderEngine.unbindVertexState(),BufferState._curBindedBufferState=null}destroy(){this._nativeVertexArrayObject&&(this._nativeVertexArrayObject.destroy(),this._nativeVertexArrayObject=null)}}e.IndexFormat=void 0,(pe=e.IndexFormat||(e.IndexFormat={}))[pe.UInt8=0]="UInt8",pe[pe.UInt16=1]="UInt16",pe[pe.UInt32=2]="UInt32";class Buffer{get bufferUsage(){return this._bufferUsage}constructor(e,t){this._byteLength=0,this._glBuffer=LayaGL.renderEngine.createBuffer(e,t),this._bufferType=e,this._bufferUsage=t}bind(){return this._glBuffer.bindBuffer()}unbind(){return this._glBuffer.unbindBuffer()}destroy(){this._glBuffer&&(this._glBuffer.destroy(),this._glBuffer=null)}}class IndexBuffer extends Buffer{constructor(t,r){super(t,r),this._indexType=e.IndexFormat.UInt16}_setIndexData(e,t){var r=BufferState._curBindedBufferState;r?r._bindedIndexBuffer===this?this._glBuffer.setDataLength(0):(r.unBind(),this.bind(),"number"==typeof e?this._glBuffer.setDataLength(e):this._glBuffer.setData(e,t),r.bind()):(this.bind(),"number"==typeof e?this._glBuffer.setDataLength(e):this._glBuffer.setData(e,t))}}class Buffer2D{get bufferLength(){return this.constBuffer._buffer.byteLength}set byteLength(e){this.setByteLength(e)}setByteLength(e){this.constBuffer._byteLength!==e&&(e<=this._bufferSize||this._resizeBuffer(2*e+256,!0),this.constBuffer._byteLength=e)}needSize(e){var t=this.constBuffer._byteLength;if(e){var r=this.constBuffer._byteLength+e;r<=this._bufferSize||this._resizeBuffer(r<<1,!0),this.constBuffer._byteLength=r}return t}constructor(e){this._maxsize=0,this._upload=!0,this._uploadSize=0,this._bufferSize=0,this._u8Array=null,this.constBuffer=e}getFloat32Array(){return this._floatArray32||(this._floatArray32=new Float32Array(this.constBuffer._buffer.buffer)),this._floatArray32}_bufferData(){if(this._maxsize=Math.max(this._maxsize,this.constBuffer._byteLength),RenderInfo.loopCount%30==0){if(this.constBuffer._buffer.byteLength>this._maxsize+64){this.constBuffer._buffer=this.constBuffer._buffer.slice(0,this._maxsize+64),this._bufferSize=this.constBuffer._buffer.byteLength,this._checkArrayUse();let e=this.constBuffer._buffer.buffer;this._bufferSize%4==0&&(this._floatArray32=new Float32Array(e)),this._bufferSize%4==0&&(this._uint32Array=new Uint32Array(e)),this._uint16Array=new Uint16Array(e)}this._maxsize=this.constBuffer._byteLength}this._uploadSize<this.constBuffer._buffer.byteLength&&(this._uploadSize=this.constBuffer._buffer.byteLength,this.constBuffer._glBuffer.setDataLength(this._uploadSize)),this.constBuffer._glBuffer.setData(new Uint8Array(this.constBuffer._buffer.buffer,0,this.constBuffer._byteLength),0),this.constBuffer.unbind()}_bufferSubData(e=0,t=0,r=0){if(this._maxsize=Math.max(this._maxsize,this.constBuffer._byteLength),RenderInfo.loopCount%30==0&&(this.constBuffer._buffer.byteLength>this._maxsize+64&&(this.constBuffer._buffer=this.constBuffer._buffer.slice(0,this._maxsize+64),this._bufferSize=this.constBuffer._buffer.byteLength,this._checkArrayUse()),this._maxsize=this.constBuffer._byteLength),this._uploadSize<this.constBuffer._buffer.byteLength&&(this._uploadSize=this.constBuffer._buffer.byteLength,this.constBuffer._glBuffer.setDataLength(this._uploadSize)),t||r){var a=this.constBuffer._buffer.buffer.slice(t,r);this.constBuffer._glBuffer.setData(a,e)}else this.constBuffer._glBuffer.setData(this.constBuffer._buffer.buffer,e)}_checkArrayUse(){}_bind_upload(){return!!this._upload&&(this._upload=!1,this.constBuffer.bind(),this._bufferData(),!0)}_bind_subUpload(e=0,t=0,r=0){return!!this._upload&&(this._upload=!1,this.constBuffer.bind(),this._bufferSubData(e,t,r),!0)}_resizeBuffer(e,t){var r=this.constBuffer._buffer;if(r&&e<=r.byteLength)return this;if(this._u8Array,t&&r&&r.byteLength>0){var a=new Uint8Array(r.buffer),i=new Uint8Array(e);i.set(a,0),r=this.constBuffer._buffer=i,this._u8Array=new Uint8Array(this.constBuffer._buffer.buffer)}else{var s=new ArrayBuffer(e);r=this.constBuffer._buffer=new Uint8Array(s),this._u8Array=new Uint8Array(r.buffer)}return r=this.constBuffer._buffer.buffer,e%4==0&&(this._floatArray32=new Float32Array(r)),e%4==0&&(this._uint32Array=new Uint32Array(r)),this._uint16Array=new Uint16Array(r),this._checkArrayUse(),this._upload=!0,this._bufferSize=r.byteLength,this}append(e){var t,r;this._upload=!0,t=e.byteLength,e instanceof Uint8Array?(this._resizeBuffer(this.constBuffer._byteLength+t,!0),r=new Uint8Array(this.constBuffer._buffer.buffer,this.constBuffer._byteLength)):e instanceof Uint16Array?(this._resizeBuffer(this.constBuffer._byteLength+t,!0),r=new Uint16Array(this.constBuffer._buffer.buffer,this.constBuffer._byteLength)):e instanceof Float32Array&&(this._resizeBuffer(this.constBuffer._byteLength+t,!0),r=new Float32Array(this.constBuffer._buffer.buffer,this.constBuffer._byteLength)),r.set(e,0),this.constBuffer._byteLength+=t,this._checkArrayUse()}appendU16Array(e,t){this._resizeBuffer(this.constBuffer._byteLength+2*t,!0);var r=new Uint16Array(this.constBuffer._buffer.buffer,this.constBuffer._byteLength,t);if(6==t)r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=e[3],r[4]=e[4],r[5]=e[5];else if(t>=100)r.set(new Uint16Array(e.buffer,0,t));else for(var a=0;a<t;a++)r[a]=e[a];this.constBuffer._byteLength+=2*t,this._checkArrayUse()}getBuffer(){return this.constBuffer._buffer.buffer}setNeedUpload(){this._upload=!0}subUpload(e=0,t=0,r=0){var a=this._bind_subUpload();return this.constBuffer.unbind(),BaseShader.activeShader=null,a}_disposeResource(){this._upload=!0,this._uploadSize=0,this._floatArray32=null,this._uint32Array=null,this._u8Array=null}clear(){this.constBuffer._byteLength=0,this._upload=!0}}Buffer2D.FLOAT32=4,Buffer2D.SHORT=2;class IndexBuffer2D extends IndexBuffer{constructor(t=e.BufferUsage.Static){super(e.BufferTargetType.ELEMENT_ARRAY_BUFFER,t),this.buffer2D=new Buffer2D(this),this._bufferUsage=t,this._buffer=new Uint8Array(8)}_bindForVAO(){this._glBuffer.bindBuffer()}destory(){this._uint16Array=null,this._buffer=null}disposeResource(){this.buffer2D._disposeResource()}}IndexBuffer2D.create=function(t=e.BufferUsage.Static){return new IndexBuffer2D(t)};class VertexBuffer extends Buffer{get vertexDeclaration(){return this._vertexDeclaration}set vertexDeclaration(e){this._vertexDeclaration=e}get instanceBuffer(){return this._instanceBuffer}set instanceBuffer(e){this._instanceBuffer=e}constructor(e,t){super(e,t),this._instanceBuffer=!1,this._vertexDeclaration=null}}class VertexBuffer2D extends VertexBuffer{get vertexStride(){return this._vertexStride}constructor(t,r){super(e.BufferTargetType.ARRAY_BUFFER,r),this.buffer2D=new Buffer2D(this),this._vertexStride=t,this._bufferUsage=r}getFloat32Array(){return this.buffer2D._floatArray32}get _floatArray32(){return this.buffer2D._floatArray32}get _uint32Array(){return this.buffer2D._uint32Array}appendArray(e){var t=this._byteLength>>2;this.buffer2D.setByteLength(this._byteLength+4*e.length),this.getFloat32Array().set(e,t),this.buffer2D._upload=!0}deleteBuffer(){this.buffer2D._disposeResource()}_bindForVAO(){this._glBuffer.bindBuffer()}destroy(){super.destroy(),this._byteLength=0,this.buffer2D._upload=!0,this._buffer=null}}VertexBuffer2D.create=function(t,r=e.BufferUsage.Dynamic){return new VertexBuffer2D(t,r)};class Mesh2D{constructor(t,r,a){this._stride=0,this.vertNum=0,this.indexNum=0,this._applied=!1,this._quadNum=0,this.canReuse=!1,this._stride=t,this._vb=new VertexBuffer2D(t,e.BufferUsage.Dynamic),r?this._vb.buffer2D._resizeBuffer(r,!1):Config.webGL2D_MeshAllocMaxMem&&this._vb.buffer2D._resizeBuffer(65536*t,!1),this._ib=new IndexBuffer2D,a&&this._ib.buffer2D._resizeBuffer(a,!1)}createQuadIB(e){this._quadNum=e,this._ib.buffer2D._resizeBuffer(6*e*2,!1),this._ib.buffer2D.byteLength=this._ib.buffer2D.bufferLength;for(var t=this._ib.buffer2D._uint16Array,r=0,a=0,i=0;i<e;i++)t[r++]=a,t[r++]=a+2,t[r++]=a+1,t[r++]=a,t[r++]=a+3,t[r++]=a+2,a+=4;this._ib.buffer2D.setNeedUpload()}setAttributes(e){if(this._attribInfo=e,this._attribInfo.length%3!=0)throw"Mesh2D setAttributes error!"}configVAO(){this._applied||(this._applied=!0,this._vao||(this._vao=new BufferState),this._vao.applyState([this._vb],this._ib))}useMesh(){(this._vao&&!this._vao.isbind()||this._ib.buffer2D._upload||this._vb.buffer2D._upload)&&BufferState._curBindedBufferState&&BufferState._curBindedBufferState.unBind(),this._applied||this.configVAO(),this._ib.buffer2D._bind_upload(),this._vb.buffer2D._bind_upload(),this._vao.bind()}releaseMesh(){}destroy(){}clearVB(){this._vb.buffer2D.clear()}}Mesh2D._gvaoid=0;class MeshQuadTexture extends Mesh2D{static __int__(){MeshQuadTexture._fixattriInfo=[5126,4,0,5121,4,16,5121,4,20]}constructor(){super(MeshQuadTexture.const_stride,4,4),this.canReuse=!0,this.setAttributes(MeshQuadTexture._fixattriInfo),MeshQuadTexture._fixib?(this._ib=MeshQuadTexture._fixib,this._quadNum=MeshQuadTexture._maxIB):(this.createQuadIB(MeshQuadTexture._maxIB),MeshQuadTexture._fixib=this._ib),MeshQuadTexture.VertexDeclarition||(MeshQuadTexture.VertexDeclarition=new VertexDeclaration(24,[new VertexElement(0,VertexElementFormat.Vector4,0),new VertexElement(16,VertexElementFormat.Byte4,1),new VertexElement(20,VertexElementFormat.Byte4,2)])),this._vb.vertexDeclaration=MeshQuadTexture.VertexDeclarition}static getAMesh(e){var t=null;return t=MeshQuadTexture._POOL.length?MeshQuadTexture._POOL.pop():new MeshQuadTexture,e&&t._vb.buffer2D._resizeBuffer(65536*MeshQuadTexture.const_stride,!1),t}releaseMesh(){this._vb.buffer2D.setByteLength(0),this.vertNum=0,this.indexNum=0,MeshQuadTexture._POOL.push(this)}destroy(){this._vb.destroy(),this._vb.deleteBuffer()}addQuad(e,t,r,a){var i=this._vb,s=i._byteLength>>2;i.buffer2D.setByteLength(s+MeshQuadTexture.const_stride<<2);var n=i._floatArray32||i.getFloat32Array(),o=i._uint32Array,l=s,h=a?255:0;n[l++]=e[0],n[l++]=e[1],n[l++]=t[0],n[l++]=t[1],o[l++]=r,o[l++]=h,n[l++]=e[2],n[l++]=e[3],n[l++]=t[2],n[l++]=t[3],o[l++]=r,o[l++]=h,n[l++]=e[4],n[l++]=e[5],n[l++]=t[4],n[l++]=t[5],o[l++]=r,o[l++]=h,n[l++]=e[6],n[l++]=e[7],n[l++]=t[6],n[l++]=t[7],o[l++]=r,o[l++]=h,i.buffer2D._upload=!0}}MeshQuadTexture.const_stride=24,MeshQuadTexture._maxIB=16384,MeshQuadTexture._POOL=[];class MeshTexture extends Mesh2D{static __init__(){MeshTexture._fixattriInfo=[5126,4,0,5121,4,16,5121,4,20]}constructor(){super(MeshTexture.const_stride,4,4),this.canReuse=!0,this.setAttributes(MeshTexture._fixattriInfo),MeshTexture.VertexDeclarition||(MeshTexture.VertexDeclarition=new VertexDeclaration(24,[new VertexElement(0,VertexElementFormat.Vector4,0),new VertexElement(16,VertexElementFormat.Byte4,1),new VertexElement(20,VertexElementFormat.Byte4,2)])),this._vb.vertexDeclaration=MeshTexture.VertexDeclarition}static getAMesh(e){var t;return t=MeshTexture._POOL.length?MeshTexture._POOL.pop():new MeshTexture,e&&t._vb.buffer2D._resizeBuffer(65536*MeshTexture.const_stride,!1),t}addData(e,t,r,a,i){var s=this._vb,n=this._ib,o=e.length>>1,l=s.buffer2D.needSize(o*MeshTexture.const_stride)>>2,h=s._floatArray32||s.getFloat32Array(),u=s._uint32Array,d=0,_=a.a,c=a.b,p=a.c,m=a.d,f=a.tx,g=a.ty,T=0;for(T=0;T<o;T++){var S=e[d],x=e[d+1];h[l]=S*_+x*p+f,h[l+1]=S*c+x*m+g,h[l+2]=t[d],h[l+3]=t[d+1],u[l+4]=i,u[l+5]=255,l+=6,d+=2}s.buffer2D.setNeedUpload();var y=this.vertNum,E=r.length,R=n.buffer2D.needSize(r.byteLength),b=n.buffer2D._uint16Array,C=R>>1;if(y>0){var v=C+E,D=0;for(T=C;T<v;T++,D++)b[T]=r[D]+y}else b.set(r,C);n.buffer2D.setNeedUpload(),this.vertNum+=o,this.indexNum+=r.length}releaseMesh(){this._vb.buffer2D.setByteLength(0),this._ib.buffer2D.setByteLength(0),this.vertNum=0,this.indexNum=0,MeshTexture._POOL.push(this)}destroy(){this._ib.destroy(),this._vb.destroy(),this._ib.disposeResource(),this._vb.deleteBuffer()}}MeshTexture.const_stride=24,MeshTexture._POOL=[];class MeshVG extends Mesh2D{static __init__(){MeshVG._fixattriInfo=[5126,2,0,5121,4,8]}constructor(){super(MeshVG.const_stride,4,4),this.canReuse=!0,this.setAttributes(MeshVG._fixattriInfo),MeshVG.vertexDeclaration||(MeshVG.vertexDeclaration=new VertexDeclaration(12,[new VertexElement(0,VertexElementFormat.Vector2,0),new VertexElement(8,VertexElementFormat.Byte4,1)])),this._vb.vertexDeclaration=MeshVG.vertexDeclaration}static getAMesh(e){var t;return t=MeshVG._POOL.length?MeshVG._POOL.pop():new MeshVG,e&&t._vb.buffer2D._resizeBuffer(65536*MeshVG.const_stride,!1),t}addVertAndIBToMesh(e,t,r,a){for(var i=this._vb.buffer2D.needSize(t.length/2*MeshVG.const_stride)>>2,s=this._vb._floatArray32||this._vb.getFloat32Array(),n=this._vb._uint32Array,o=0,l=t.length/2,h=0;h<l;h++)s[i++]=t[o],s[i++]=t[o+1],o+=2,n[i++]=r;this._vb.buffer2D.setNeedUpload(),this._ib.buffer2D.append(new Uint16Array(a)),this._ib.buffer2D.setNeedUpload(),this.vertNum+=l,this.indexNum+=a.length}releaseMesh(){this._vb.buffer2D.setByteLength(0),this._ib.buffer2D.setByteLength(0),this.vertNum=0,this.indexNum=0,MeshVG._POOL.push(this)}destroy(){this._ib.destroy(),this._vb.destroy(),this._ib.disposeResource(),this._vb.deleteBuffer()}}MeshVG.const_stride=12,MeshVG._POOL=[],MeshVG.vertexDeclaration=null;class NativeWebGLCacheAsNormalCanvas{constructor(e,t){this._context=e,this._nativeObj=new window._conchWebGLCacheAsNormalCanvas(e._nativeObj,0)}startRec(){this._nativeObj.startRec()}endRec(){this._nativeObj.endRec()}isCacheValid(){return this._nativeObj.isCacheValid()}isTextNeedRestore(){return this._nativeObj.isTextNeedRestore()}get context(){return this._context}}class WebGLCacheAsNormalCanvas{constructor(e,t){this.submitStartPos=0,this.submitEndPos=0,this.touches=[],this.submits=[],this.sprite=null,this.meshlist=[],this.cachedClipInfo=new Matrix,this.oldTx=0,this.oldTy=0,this.invMat=new Matrix,this.context=e,this.sprite=t,e._globalClipMatrix.copyTo(this.cachedClipInfo)}startRec(){let e=this.context;e._charSubmitCache&&e._charSubmitCache._enable&&(e._charSubmitCache.enable(!1,e),e._charSubmitCache.enable(!0,e)),e._incache=!0,this.touches.length=0,e.touches=this.touches,e._globalClipMatrix.copyTo(this.cachedClipInfo),this.submits.length=0,this.submitStartPos=e._submits._length;for(var t=0,r=this.meshlist.length;t<r;t++){var a=this.meshlist[t];a.canReuse?a.releaseMesh():a.destroy()}this.meshlist.length=0,this._mesh=MeshQuadTexture.getAMesh(!1),this._pathMesh=MeshVG.getAMesh(!1),this._triangleMesh=MeshTexture.getAMesh(!1),this.meshlist.push(this._mesh),this.meshlist.push(this._pathMesh),this.meshlist.push(this._triangleMesh),e._curSubmit=SubmitBase.RENDERBASE,this._oldMesh=e._mesh,this._oldPathMesh=e._pathMesh,this._oldTriMesh=e._triangleMesh,this._oldMeshList=e.meshlist,e._mesh=this._mesh,e._pathMesh=this._pathMesh,e._triangleMesh=this._triangleMesh,e.meshlist=this.meshlist,this.oldTx=e._curMat.tx,this.oldTy=e._curMat.ty,e._curMat.tx=0,e._curMat.ty=0,e._curMat.copyTo(this.invMat),this.invMat.invert()}endRec(){let e=this.context;e._charSubmitCache&&e._charSubmitCache._enable&&(e._charSubmitCache.enable(!1,e),e._charSubmitCache.enable(!0,e));var t=e._submits;this.submitEndPos=t._length;for(var r=this.submitEndPos-this.submitStartPos,a=0;a<r;a++)this.submits.push(t[this.submitStartPos+a]);t._length-=r,e._mesh=this._oldMesh,e._pathMesh=this._oldPathMesh,e._triangleMesh=this._oldTriMesh,e.meshlist=this._oldMeshList,e._curSubmit=SubmitBase.RENDERBASE,e._curMat.tx=this.oldTx,e._curMat.ty=this.oldTy,e.touches=null,e._incache=!1}isCacheValid(){var e=this.context._globalClipMatrix;return e.a==this.cachedClipInfo.a&&e.b==this.cachedClipInfo.b&&e.c==this.cachedClipInfo.c&&e.d==this.cachedClipInfo.d&&e.tx==this.cachedClipInfo.tx&&e.ty==this.cachedClipInfo.ty}isTextNeedRestore(){var e=!1,t=this.touches;if(t)for(var r=0;r<t.length;r++)if(t[r].deleted){e=!0;break}return e}flushsubmit(){var e=SubmitBase.RENDERBASE;this.submits.forEach((function(t){t!=SubmitBase.RENDERBASE&&(SubmitBase.preRender=e,e=t,t.renderSubmit())}))}releaseMem(){}}WebGLCacheAsNormalCanvas.matI=new Matrix,window.conch&&!window.conchConfig.conchWebGL&&(WebGLCacheAsNormalCanvas=NativeWebGLCacheAsNormalCanvas);class LayaGLQuickRunner{static __init__(){LayaGLQuickRunner.map[SpriteConst.ALPHA|SpriteConst.TRANSFORM|SpriteConst.GRAPHICS]=LayaGLQuickRunner.alpha_transform_drawLayaGL,LayaGLQuickRunner.map[SpriteConst.ALPHA|SpriteConst.GRAPHICS]=LayaGLQuickRunner.alpha_drawLayaGL,LayaGLQuickRunner.map[SpriteConst.TRANSFORM|SpriteConst.GRAPHICS]=LayaGLQuickRunner.transform_drawLayaGL,LayaGLQuickRunner.map[SpriteConst.TRANSFORM|SpriteConst.CHILDS]=LayaGLQuickRunner.transform_drawNodes,LayaGLQuickRunner.map[SpriteConst.ALPHA|SpriteConst.TRANSFORM|SpriteConst.TEXTURE]=LayaGLQuickRunner.alpha_transform_drawTexture,LayaGLQuickRunner.map[SpriteConst.ALPHA|SpriteConst.TEXTURE]=LayaGLQuickRunner.alpha_drawTexture,LayaGLQuickRunner.map[SpriteConst.TRANSFORM|SpriteConst.TEXTURE]=LayaGLQuickRunner.transform_drawTexture,LayaGLQuickRunner.map[SpriteConst.GRAPHICS|SpriteConst.CHILDS]=LayaGLQuickRunner.drawLayaGL_drawNodes}static transform_drawTexture(e,t,r,a){e._style;var i=e.texture;t.saveTransform(LayaGLQuickRunner.curMat),t.transformByMatrix(e.transform,r,a);var s=e._isWidthSet?e._width:i.sourceWidth,n=e._isHeightSet?e._height:i.sourceHeight,o=s/i.sourceWidth,l=n/i.sourceHeight;if(s=i.width*o,n=i.height*l,s<=0||n<=0)return null;var h=-e.pivotX+i.offsetX*o,u=-e.pivotY+i.offsetY*l;e._getBit(NodeFlags.HIDE_BY_EDITOR)||t.drawTexture(i,h,u,s,n),t.restoreTransform(LayaGLQuickRunner.curMat)}static alpha_drawTexture(e,t,r,a){var i,s=e._style,n=e.texture;if((i=s.alpha)>.01||e._needRepaint()){var o=t.globalAlpha;t.globalAlpha*=i;var l=e._isWidthSet?e._width:n.sourceWidth,h=e._isHeightSet?e._height:n.sourceHeight,u=l/n.sourceWidth,d=h/n.sourceHeight;if(l=n.width*u,h=n.height*d,l<=0||h<=0)return null;var _=r-s.pivotX+n.offsetX*u,c=a-s.pivotY+n.offsetY*d;e._getBit(NodeFlags.HIDE_BY_EDITOR)||t.drawTexture(n,_,c,l,h),t.globalAlpha=o}}static alpha_transform_drawTexture(e,t,r,a){var i,s=e._style,n=e.texture;if((i=s.alpha)>.01||e._needRepaint()){var o=t.globalAlpha;t.globalAlpha*=i,t.saveTransform(LayaGLQuickRunner.curMat),t.transformByMatrix(e.transform,r,a);var l=e._isWidthSet?e._width:n.sourceWidth,h=e._isHeightSet?e._height:n.sourceHeight,u=l/n.sourceWidth,d=h/n.sourceHeight;if(l=n.width*u,h=n.height*d,l<=0||h<=0)return null;var _=-s.pivotX+n.offsetX*u,c=-s.pivotY+n.offsetY*d;e._getBit(NodeFlags.HIDE_BY_EDITOR)||t.drawTexture(n,_,c,l,h),t.restoreTransform(LayaGLQuickRunner.curMat),t.globalAlpha=o}}static alpha_transform_drawLayaGL(e,t,r,a){var i,s=e._style;if((i=s.alpha)>.01||e._needRepaint()){var n=t.globalAlpha;t.globalAlpha*=i,t.saveTransform(LayaGLQuickRunner.curMat),t.transformByMatrix(e.transform,r,a),e._getBit(NodeFlags.HIDE_BY_EDITOR)||e._graphics&&e._graphics._render(e,t,-s.pivotX,-s.pivotY),t.restoreTransform(LayaGLQuickRunner.curMat),t.globalAlpha=n}}static alpha_drawLayaGL(e,t,r,a){var i,s=e._style;if((i=s.alpha)>.01||e._needRepaint()){var n=t.globalAlpha;t.globalAlpha*=i,e._getBit(NodeFlags.HIDE_BY_EDITOR)||e._graphics&&e._graphics._render(e,t,r-s.pivotX,a-s.pivotY),t.globalAlpha=n}}static transform_drawLayaGL(e,t,r,a){var i=e._style;t.saveTransform(LayaGLQuickRunner.curMat),t.transformByMatrix(e.transform,r,a),e._getBit(NodeFlags.HIDE_BY_EDITOR)||e._graphics&&e._graphics._render(e,t,-i.pivotX,-i.pivotY),t.restoreTransform(LayaGLQuickRunner.curMat)}static transform_drawNodes(e,t,r,a){var i=e._getBit(NodeFlags.DRAWCALL_OPTIMIZE)&&t.drawCallOptimize(!0);let s=t._drawingToTexture;var n=e._style;t.saveTransform(LayaGLQuickRunner.curMat),t.transformByMatrix(e.transform,r,a),r=-n.pivotX,a=-n.pivotY;var o=e._children,l=o.length;let h,u,d,_,c,p,m;n.viewport&&(h=n.viewport,u=h.x,d=h.y,_=h.right,c=h.bottom);for(let e=0;e<l;++e){let i,n=o[e];i=s?n._visible&&!n._getBit(NodeFlags.ESCAPE_DRAWING_TO_TEXTURE):n._visible||n._getBit(NodeFlags.DISABLE_VISIBILITY),h&&((p=n._x)>=_||p+n.width<=u||(m=n._y)>=c||m+n.height<=d)&&(i=!1),i&&n.render(t,r,a)}t.restoreTransform(LayaGLQuickRunner.curMat),i&&t.drawCallOptimize(!1)}static drawLayaGL_drawNodes(e,t,r,a){var i=e._getBit(NodeFlags.DRAWCALL_OPTIMIZE)&&t.drawCallOptimize(!0);let s=t._drawingToTexture;var n=e._style;r-=n.pivotX,a-=n.pivotY,e._getBit(NodeFlags.HIDE_BY_EDITOR)||e._graphics&&e._graphics._render(e,t,r,a);var o=e._children,l=o.length;let h,u,d,_,c,p,m;n.viewport&&(h=n.viewport,u=h.x,d=h.y,_=h.right,c=h.bottom);for(let e=0;e<l;++e){let i,n=o[e];i=s?n._visible&&!n._getBit(NodeFlags.ESCAPE_DRAWING_TO_TEXTURE):n._visible||n._getBit(NodeFlags.DISABLE_VISIBILITY),h&&((p=n._x)>=_||p+n.width<=u||(m=n._y)>=c||m+n.height<=d)&&(i=!1),i&&n.render(t,r,a)}i&&t.drawCallOptimize(!1)}}LayaGLQuickRunner.map=[],LayaGLQuickRunner.curMat=new Matrix;class NativeFilter{constructor(){}get type(){return-1}}NativeFilter.BLUR=16,NativeFilter.COLOR=32,NativeFilter.GLOW=8,NativeFilter._filter=function(t,r,a,i){var s=r,n=this._next;if(n){var o=t.filters,l=o.length;if(1==l&&o[0].type==NativeFilter.COLOR)return r.save(),r.setColorFilter(o[0]),n._fun.call(n,t,r,a,i),void r.restore();var h,u=Value2D.create(e.RenderSpriteData.Texture2D),d=Point.TEMP,_=s._curMat,c=Matrix.create();_.copyTo(c);var p=0,m=0,f=null,g=t._cacheStyle.filterCache||null;if(g&&0==t.getRepaint()){if((t._isHaveGlowFilter()||!1)&&(p=50,m=25),(h=t.getBounds()).width<=0||h.height<=0)return;h.width+=p+8,h.height+=p+8,h.x-=t.pivotX+4,h.y-=t.pivotY+4,d.x=h.x*c.a+h.y*c.c,d.y=h.y*c.d+h.x*c.b,h.x=d.x,h.y=d.y,d.x=h.width*c.a+h.height*c.c,d.y=h.height*c.d+h.width*c.b,h.width=d.x,h.height=d.y}else{t._isHaveGlowFilter()&&(p=50,m=25),(h=new Rectangle).copyFrom(t.getSelfBounds()),h.x+=t.x,h.y+=t.y,h.x-=t.pivotX+4,h.y-=t.pivotY+4;var T=h.x,S=h.y;if(h.width+=p+8,h.height+=p+8,d.x=h.x*c.a+h.y*c.c,d.y=h.y*c.d+h.x*c.b,h.x=d.x,h.y=d.y,d.x=h.width*c.a+h.height*c.c,d.y=h.height*c.d+h.width*c.b,h.width=d.x,h.height=d.y,h.width<=0||h.height<=0)return;g&&g.destroy(),f=new window.conchRenderTexture2D(LayaGL.renderEngine._nativeObj,h.width,h.height,e.RenderTargetFormat.R8G8B8A8,e.RenderTargetFormat.None);var x=g=new window.conchRenderTexture2D(LayaGL.renderEngine._nativeObj,h.width,h.height,e.RenderTargetFormat.R8G8B8A8,e.RenderTargetFormat.None);t._getCacheStyle().filterCache=g,s.pushRT(),s.useRT(f);var y=t.x-T+m,E=t.y-S+m;n._fun.call(n,t,r,y,E),s.useRT(x);for(var R=0;R<l;R++){0!=R&&(s.useRT(f),s.drawTarget(x,0,0,h.width,h.height,Matrix.TEMP.identity(),u,null,BlendMode.TOINT.overlay),s.useRT(x));var b=o[R];switch(b.type){case NativeFilter.BLUR:s.drawTargetBlurFilter(f,0,0,h.width,h.height,b.strength);break;case NativeFilter.GLOW:b._glRender&&b._glRender.render(f,r,h.width,h.height,b);break;case NativeFilter.COLOR:s.setColorFilter(b),s.drawTarget(f,0,0,h.width,h.height,Matrix.EMPTY.identity(),Value2D.create(e.RenderSpriteData.Texture2D)),s.setColorFilter(null)}}s.popRT()}a=a-m-t.x,i=i-m-t.y,d.setTo(a,i),c.transformPoint(d),a=d.x+h.x,i=d.y+h.y,s.drawFilter(g,f,a,i,h.width,h.height),c.destroy()}};class RenderSprite{static __init__(){var e,t,r;for(LayaGLQuickRunner.__init__(),r=new RenderSprite(69905,null),t=RenderSprite.renders.length=2*SpriteConst.CHILDS,e=0;e<t;e++)RenderSprite.renders[e]=r;RenderSprite.renders[0]=new RenderSprite(0,null)}static _initRenderFun(e,t,r,a){var i=e._renderType;(RenderSprite.renders[i]=RenderSprite._getTypeRender(i))._fun(e,t,r,a)}static _getTypeRender(e){if(LayaGLQuickRunner.map[e]&&LayaEnv.isPlaying)return new RenderSprite(e,null);for(var t=null,r=SpriteConst.CHILDS;r>0;)r&e&&(t=new RenderSprite(r,t)),r>>=1;return t}constructor(e,t){if(LayaGLQuickRunner.map[e]&&LayaEnv.isPlaying)return this._fun=LayaGLQuickRunner.map[e],void(this._next=RenderSprite.NORENDER);switch(this._next=t||RenderSprite.NORENDER,e){case 0:return void(this._fun=this._no);case SpriteConst.ALPHA:return void(this._fun=this._alpha);case SpriteConst.TRANSFORM:return void(this._fun=this._transform);case SpriteConst.BLEND:return void(this._fun=this._blend);case SpriteConst.CANVAS:return void(this._fun=this._canvas);case SpriteConst.MASK:return void(LayaEnv.isConch&&!window.conchConfig.conchWebGL?this._fun=this._maskNative:this._fun=this._mask);case SpriteConst.CLIP:return void(this._fun=this._clip);case SpriteConst.STYLE:return void(this._fun=this._style);case SpriteConst.GRAPHICS:return void(this._fun=this._graphics);case SpriteConst.CHILDS:return void(this._fun=this._children);case SpriteConst.CUSTOM:return void(this._fun=this._custom);case SpriteConst.TEXTURE:return void(this._fun=this._texture);case SpriteConst.FILTERS:return void(LayaEnv.isConch&&!window.conchConfig.conchWebGL?this._fun=NativeFilter._filter:this._fun=Filter._filter);case SpriteConst.HITAREA:return void(this._fun=this._hitarea);case 69905:return void(this._fun=RenderSprite._initRenderFun)}this.onCreate(e)}onCreate(e){}_style(e,t,r,a){}_no(e,t,r,a){}_custom(e,t,r,a){e.customRender(t,r,a),this._next._fun.call(this._next,e,t,0,0)}_clip(e,t,r,a){let i=this._next;if(i==RenderSprite.NORENDER)return;if(e._getBit(NodeFlags.DISABLE_INNER_CLIPPING)&&!t._drawingToTexture)return void i._fun.call(i,e,t,r,a);let s=e._style.scrollRect,n=s.width,o=s.height;0===n&&(n=.001),0===o&&(o=.001),t.save(),t.clipRect(r,a,n,o),i._fun.call(i,e,t,r-s.x,a-s.y),t.restore()}_texture(e,t,r,a){if(!e._getBit(NodeFlags.HIDE_BY_EDITOR)){var i=e.texture;if(i._getSource()){var s=e._isWidthSet?e._width:i.sourceWidth,n=e._isHeightSet?e._height:i.sourceHeight,o=s/i.sourceWidth,l=n/i.sourceHeight;if(s=i.width*o,n=i.height*l,s>0&&n>0){let h=r-e.pivotX+i.offsetX*o,u=a-e.pivotY+i.offsetY*l;t.material=e.graphics.material,t.drawTexture(i,h,u,s,n,4294967295),t.material=null}}}var h=this._next;h!=RenderSprite.NORENDER&&h._fun.call(h,e,t,r,a)}_graphics(e,t,r,a){if(!e._getBit(NodeFlags.HIDE_BY_EDITOR)){var i=e._style,s=e._graphics;s&&s._render(e,t,r-i.pivotX,a-i.pivotY)}var n=this._next;n!=RenderSprite.NORENDER&&n._fun.call(n,e,t,r,a)}_hitarea(e,t,r,a){if(!t._drawingToTexture&&e.hitArea){var i=e._style,s=e.hitArea._hit,n=t.globalAlpha;t.globalAlpha*=.5,s&&s._render(e,t,r-i.pivotX,a-i.pivotY),(s=e.hitArea._unHit)&&s._render(e,t,r-i.pivotX,a-i.pivotY),t.globalAlpha=n}var o=this._next;o!=RenderSprite.NORENDER&&o._fun.call(o,e,t,r,a)}_alpha(e,t,r,a){var i;if((i=e._style.alpha)>.01||e._needRepaint()){var s=t.globalAlpha;t.globalAlpha*=i;var n=this._next;n._fun.call(n,e,t,r,a),t.globalAlpha=s}}_transform(e,t,r,a){var i=e.transform,s=this._next;i&&s!=RenderSprite.NORENDER?(t.save(),t.transform(i.a,i.b,i.c,i.d,i.tx+r,i.ty+a),s._fun.call(s,e,t,0,0),t.restore()):s!=RenderSprite.NORENDER&&s._fun.call(s,e,t,r,a)}_children(e,t,r,a){let i=e._style,s=e._children,n=s.length;r-=e.pivotX,a-=e.pivotY;let o,l,h,u,d,_,c,p=e._getBit(NodeFlags.DRAWCALL_OPTIMIZE)&&t.drawCallOptimize(!0),m=t._drawingToTexture;i.viewport&&(o=i.viewport,l=o.x,h=o.y,u=o.right,d=o.bottom);for(let i=0;i<n;++i){let n,p=s[i];n=m?p._visible&&!p._getBit(NodeFlags.ESCAPE_DRAWING_TO_TEXTURE):p._visible||p._getBit(NodeFlags.DISABLE_VISIBILITY),n&&(o&&((_=p._x)>=u||_+p.width<=l||(c=p._y)>=d||c+p.height<=h)?n=!1:e._cacheStyle.mask!=p||p._getBit(NodeFlags.DISABLE_VISIBILITY)||(n=!1)),n&&(p._getBit(NodeFlags.DISABLE_OUTER_CLIPPING)&&t.clipRect(0,0,1,1,!0),p.render(t,r,a))}p&&t.drawCallOptimize(!1)}_canvas(e,t,r,a){var i=e._cacheStyle,s=this._next;if(!i.enableCanvasRender||!t._drawingToTexture&&i.mask&&i.mask._getBit(NodeFlags.DISABLE_VISIBILITY))s._fun.call(s,e,t,r,a);else{"bitmap"===i.cacheAs?Stat.canvasBitmap++:Stat.canvasNormal++;var n=!1,o=!1;if(i.canvas){var l=i.canvas;o=l.isTextNeedRestore&&l.isTextNeedRestore(),n=l.isCacheValid&&!l.isCacheValid()}if(e._needRepaint()||!i.canvas||o||n||ILaya.stage.isGlobalRepaint())if("normal"===i.cacheAs){if(t._targets)return void s._fun.call(s,e,t,r,a);this._canvas_webgl_normal_repaint(e,t)}else this._canvas_repaint(e,t,r,a);var h=i.cacheRect;t.material=e.graphics.material,t.drawCanvas(i.canvas,r+h.x,a+h.y,h.width,h.height),t.material=null}}_canvas_repaint(e,t,r,a){var i,s,n,o,l,h,u,d,_,c=e._cacheStyle,p=this._next,m=c.canvas,f=c.cacheAs;if(u=(_=c._calculateCacheRect(e,f,r,a)).x,d=_.y,l=(o=c.cacheRect).width*u,h=o.height*d,s=o.x,n=o.y,"bitmap"===f&&(l>2048||h>2048))return console.warn("cache bitmap size larger than 2048, cache ignored"),c.releaseContext(),void p._fun.call(p,e,t,r,a);if(m||(c.createContext(),m=c.canvas),(i=m.context).sprite=e,(m.width!=l||m.height!=h)&&m.size(l,h),"bitmap"===f?i.asBitmap=!0:"normal"===f&&(i.asBitmap=!1),i.clear(),1!=u||1!=d){var g=i;g.save(),g.scale(u,d),p._fun.call(p,e,i,-s,-n),g.restore(),e._applyFilters()}else g=i,p._fun.call(p,e,i,-s,-n),e._applyFilters();c.staticCache&&(c.reCache=!1),Stat.canvasReCache++}_canvas_webgl_normal_repaint(e,t){var r=e._cacheStyle,a=this._next,i=r.canvas,s=r.cacheAs;r._calculateCacheRect(e,s,0,0),i||(i=new WebGLCacheAsNormalCanvas(t,e),r.canvas=i);var n=i.context;i.startRec(),a._fun.call(a,e,n,e.pivotX,e.pivotY),e._applyFilters(),Stat.canvasReCache++,i.endRec()}_blend(e,t,r,a){var i=e._style,s=this._next;i.blendMode?(t.save(),t.globalCompositeOperation=i.blendMode,s._fun.call(s,e,t,r,a),t.restore()):s._fun.call(s,e,t,r,a)}_mask(t,r,a,i){let s=this._next,n=t.mask;if(!n||n._getBit(NodeFlags.DISABLE_VISIBILITY)&&!r._drawingToTexture)s._fun.call(s,t,r,a,i);else{r.save();let o=r.globalCompositeOperation,l=new Rectangle;l.copyFrom(n.getBounds());let h=l.width=Math.round(l.width),u=l.height=Math.round(l.height);if(l.x=Math.round(l.x),l.y=Math.round(l.y),h>0&&u>0){let d=WebGLRTMgr.getRT(h,u);r.breakNextMerge(),r.pushRT(),r.addRenderObject(SubmitCMD.create([r,d,h,u],RenderSprite.tmpTarget,this)),n.render(r,-l.x,-l.y),r.breakNextMerge(),r.popRT(),r.save();let _=.1;r.clipRect(a+l.x-t.getStyle().pivotX+_,i+l.y-t.getStyle().pivotY+_,h-2*_,u-2*_),s._fun.call(s,t,r,a,i),r.restore(),o=r.globalCompositeOperation,r.addRenderObject(SubmitCMD.create(["mask"],RenderSprite.setBlendMode,this));let c=Value2D.create(e.RenderSpriteData.Texture2D),p=Texture.INV_UV;r.drawTarget(d,a+l.x-t.getStyle().pivotX,i+l.y-t.getStyle().pivotY,h,u,Matrix.TEMP.identity(),c,p,6),r.addRenderObject(SubmitCMD.create([d],RenderSprite.recycleTarget,this))}r.addRenderObject(SubmitCMD.create([o],RenderSprite.setBlendMode,this)),r.restore()}}_maskNative(e,t,r,a){var i=this._next,s=e.mask;if(s){t.save(),t.globalCompositeOperation;var n=new Rectangle;n.copyFrom(s.getBounds());let o=n.width=Math.round(n.width),l=n.height=Math.round(n.height);if(n.x=Math.round(n.x),n.y=Math.round(n.y),o>0&&l>0){let h=t.drawMask(o,l);s.render(t,-n.x,-n.y);let u=.1;t.drawMasked(r+n.x-e.getStyle().pivotX+u,a+n.y-e.getStyle().pivotY+u,o-2*u,l-2*u),i._fun.call(i,e,t,r,a),t.drawMaskComposite(h,r+n.x-e.getStyle().pivotX,a+n.y-e.getStyle().pivotY,o,l)}t.restore()}else i._fun.call(i,e,t,r,a)}static tmpTarget(e,t,r,a){t.start(),t.clear(0,0,0,0)}static recycleTarget(e){WebGLRTMgr.releaseRT(e)}static setBlendMode(e){BlendMode.targetFns[BlendMode.TOINT[e]]()}}RenderSprite.renders=[],RenderSprite.NORENDER=new RenderSprite(0,null);class Bezier{constructor(){this._controlPoints=[new Point,new Point,new Point],this._calFun=this.getPoint2}_switchPoint(e,t){var r=this._controlPoints.shift();r.setTo(e,t),this._controlPoints.push(r)}getPoint2(e,t){var r=this._controlPoints[0],a=this._controlPoints[1],i=this._controlPoints[2],s=Math.pow(1-e,2)*r.x+2*e*(1-e)*a.x+Math.pow(e,2)*i.x,n=Math.pow(1-e,2)*r.y+2*e*(1-e)*a.y+Math.pow(e,2)*i.y;t.push(s,n)}getPoint3(e,t){var r=this._controlPoints[0],a=this._controlPoints[1],i=this._controlPoints[2],s=this._controlPoints[3],n=Math.pow(1-e,3)*r.x+3*a.x*e*(1-e)*(1-e)+3*i.x*e*e*(1-e)+s.x*Math.pow(e,3),o=Math.pow(1-e,3)*r.y+3*a.y*e*(1-e)*(1-e)+3*i.y*e*e*(1-e)+s.y*Math.pow(e,3);t.push(n,o)}insertPoints(e,t){var r,a;for(a=1/(e=e>0?e:5),r=0;r<=1;r+=a)this._calFun(r,t)}getBezierPoints(e,t=5,r=2){var a,i;if((i=e.length)<2*(r+1))return[];var s=[];switch(r){case 2:this._calFun=this.getPoint2;break;case 3:this._calFun=this.getPoint3;break;default:return[]}for(;this._controlPoints.length<=r;)this._controlPoints.push(Point.create());for(a=0;a<2*r;a+=2)this._switchPoint(e[a],e[a+1]);for(a=2*r;a<i;a+=2)this._switchPoint(e[a],e[a+1]),a/2%r==0&&this.insertPoints(t,s);return s}}var me;Bezier.I=new Bezier,e.RenderStateType=void 0,(me=e.RenderStateType||(e.RenderStateType={}))[me.DepthTest=0]="DepthTest",me[me.DepthMask=1]="DepthMask",me[me.DepthFunc=2]="DepthFunc",me[me.StencilTest=3]="StencilTest",me[me.StencilMask=4]="StencilMask",me[me.StencilFunc=5]="StencilFunc",me[me.StencilOp=6]="StencilOp",me[me.BlendType=7]="BlendType",me[me.BlendEquation=8]="BlendEquation",me[me.BlendEquationSeparate=9]="BlendEquationSeparate",me[me.BlendFunc=10]="BlendFunc",me[me.BlendFuncSeperate=11]="BlendFuncSeperate",me[me.CullFace=12]="CullFace",me[me.FrontFace=13]="FrontFace";class DrawStyle{static create(e){if(e){var t=e instanceof ColorUtils?e:ColorUtils.create(e);return t._drawStyle||(t._drawStyle=new DrawStyle(e))}return DrawStyle.DEFAULT}constructor(e){this.setValue(e)}setValue(e){this._color=e?e instanceof ColorUtils?e:ColorUtils.create(e):ColorUtils.create("#000000")}reset(){this._color=ColorUtils.create("#000000")}toInt(){return this._color.numColor}equal(e){return"string"==typeof e?this._color.strColor===e:e instanceof ColorUtils&&this._color.numColor===e.numColor}toColorStr(){return this._color.strColor}}DrawStyle.DEFAULT=new DrawStyle("#000000");class Path{constructor(){this._lastOriX=0,this._lastOriY=0,this.paths=[],this._curPath=null}beginPath(e){this.paths.length=1,this._curPath=this.paths[0]=new renderPath,this._curPath.convex=e}closePath(){this._curPath.loop=!0}newPath(){this._curPath=new renderPath,this.paths.push(this._curPath)}addPoint(e,t){this._curPath.path.push(e,t)}push(e,t){this._curPath?this._curPath.path.length>0&&(this._curPath=new renderPath,this.paths.push(this._curPath)):(this._curPath=new renderPath,this.paths.push(this._curPath));var r=this._curPath;r.path=e.slice(),r.convex=t}reset(){this.paths.length=0}}class renderPath{constructor(){this.path=[],this.loop=!1,this.convex=!1}}class SaveBase{static _createArray(){var e=[];return e._length=0,e}static _init(){var e=SaveBase._namemap={};return e[SaveBase.TYPE_ALPHA]="ALPHA",e[SaveBase.TYPE_FILESTYLE]="fillStyle",e[SaveBase.TYPE_FONT]="font",e[SaveBase.TYPE_LINEWIDTH]="lineWidth",e[SaveBase.TYPE_STROKESTYLE]="strokeStyle",e[SaveBase.TYPE_ENABLEMERGE]="_mergeID",e[SaveBase.TYPE_MARK]=e[SaveBase.TYPE_TRANSFORM]=e[SaveBase.TYPE_TRANSLATE]=[],e[SaveBase.TYPE_TEXTBASELINE]="textBaseline",e[SaveBase.TYPE_TEXTALIGN]="textAlign",e[SaveBase.TYPE_GLOBALCOMPOSITEOPERATION]="_nBlendType",e[SaveBase.TYPE_SHADER]="shader",e[SaveBase.TYPE_FILTERS]="filters",e[SaveBase.TYPE_COLORFILTER]="_colorFiler",e}constructor(){}isSaveMark(){return!1}restore(e){this._dataObj[this._valueName]=this._value,SaveBase.POOL[SaveBase.POOL._length++]=this,this._newSubmit&&(e._curSubmit=SubmitBase.RENDERBASE)}static save(e,t,r,a){if((e._saveMark._saveuse&t)!==t){e._saveMark._saveuse|=t;var i=SaveBase.POOL,s=i._length>0?i[--i._length]:new SaveBase;s._value=r[s._valueName=SaveBase._namemap[t]],s._dataObj=r,s._newSubmit=a;var n=e._save;n[n._length++]=s}}}SaveBase.TYPE_ALPHA=1,SaveBase.TYPE_FILESTYLE=2,SaveBase.TYPE_FONT=8,SaveBase.TYPE_LINEWIDTH=256,SaveBase.TYPE_STROKESTYLE=512,SaveBase.TYPE_MARK=1024,SaveBase.TYPE_TRANSFORM=2048,SaveBase.TYPE_TRANSLATE=4096,SaveBase.TYPE_ENABLEMERGE=8192,SaveBase.TYPE_TEXTBASELINE=16384,SaveBase.TYPE_TEXTALIGN=32768,SaveBase.TYPE_GLOBALCOMPOSITEOPERATION=65536,SaveBase.TYPE_CLIPRECT=131072,SaveBase.TYPE_CLIPRECT_STENCIL=262144,SaveBase.TYPE_IBVB=524288,SaveBase.TYPE_SHADER=1048576,SaveBase.TYPE_FILTERS=2097152,SaveBase.TYPE_FILTERS_TYPE=4194304,SaveBase.TYPE_COLORFILTER=8388608,SaveBase.POOL=SaveBase._createArray(),SaveBase._namemap=SaveBase._init();class SaveClipRect{constructor(){this._globalClipMatrix=new Matrix,this._clipInfoID=-1,this._clipRect=new Rectangle,this.incache=!1}isSaveMark(){return!1}restore(e){this._globalClipMatrix.copyTo(e._globalClipMatrix),this._clipRect.clone(e._clipRect),e._clipInfoID=this._clipInfoID,SaveClipRect.POOL[SaveClipRect.POOL._length++]=this,e._clipInCache=this.incache}static save(e){if((e._saveMark._saveuse&SaveBase.TYPE_CLIPRECT)!=SaveBase.TYPE_CLIPRECT){e._saveMark._saveuse|=SaveBase.TYPE_CLIPRECT;var t=SaveClipRect.POOL,r=t._length>0?t[--t._length]:new SaveClipRect;e._globalClipMatrix.copyTo(r._globalClipMatrix),e._clipRect.clone(r._clipRect),r._clipInfoID=e._clipInfoID,r.incache=e._clipInCache;var a=e._save;a[a._length++]=r}}}SaveClipRect.POOL=SaveBase._createArray();class SaveMark{constructor(){this._saveuse=0}isSaveMark(){return!0}restore(e){e._saveMark=this._preSaveMark,SaveMark.POOL[SaveMark.POOL._length++]=this}static Create(e){var t=SaveMark.POOL,r=t._length>0?t[--t._length]:new SaveMark;return r._saveuse=0,r._preSaveMark=e._saveMark,e._saveMark=r,r}}SaveMark.POOL=SaveBase._createArray();class SaveTransform{constructor(){this._matrix=new Matrix}isSaveMark(){return!1}restore(e){e._curMat=this._savematrix,SaveTransform.POOL[SaveTransform.POOL._length++]=this}static save(e){var t=e._saveMark;if((t._saveuse&SaveBase.TYPE_TRANSFORM)!==SaveBase.TYPE_TRANSFORM){t._saveuse|=SaveBase.TYPE_TRANSFORM;var r=SaveTransform.POOL,a=r._length>0?r[--r._length]:new SaveTransform;a._savematrix=e._curMat,e._curMat=e._curMat.copyTo(a._matrix);var i=e._save;i[i._length++]=a}}}SaveTransform.POOL=SaveBase._createArray();class SaveTranslate{constructor(){this._mat=new Matrix}isSaveMark(){return!1}restore(e){this._mat.copyTo(e._curMat),SaveTranslate.POOL[SaveTranslate.POOL._length++]=this}static save(e){var t=SaveTranslate.POOL,r=t._length>0?t[--t._length]:new SaveTranslate;e._curMat.copyTo(r._mat);var a=e._save;a[a._length++]=r}}SaveTranslate.POOL=SaveBase._createArray();class Shader2D{constructor(){this.ALPHA=1,this.shaderType=0,this.fillStyle=DrawStyle.DEFAULT,this.strokeStyle=DrawStyle.DEFAULT,this.material=null}destroy(){this.filters=null}static __init__(){Shader3D.addInclude("Sprite2DFrag.glsl","vec3 gammaToLinear(in vec3 value)\r\n{\r\n    return pow((value + 0.055) / 1.055, vec3(2.4));\r\n}\r\n\r\nvec4 gammaToLinear(in vec4 value)\r\n{\r\n    return vec4(gammaToLinear(value.rgb), value.a);\r\n}\r\n\r\nvec3 linearToGamma(in vec3 value)\r\n{\r\n    return vec3(mix(pow(value.rgb, vec3(0.41666)) * 1.055 - vec3(0.055), value.rgb * 12.92, vec3(lessThanEqual(value.rgb, vec3(0.0031308)))));\r\n\r\n    // return pow(value, vec3(1.0 / 2.2));\r\n    // return pow(value, vec3(0.455));\r\n}\r\n\r\nvec4 linearToGamma(in vec4 value)\r\n{\r\n    return vec4(linearToGamma(value.rgb), value.a);\r\n}\r\n\r\nvec4 sampleTexture(sampler2D spriteTexture, vec2 uv)\r\n{\r\n    vec4 color = texture2D(spriteTexture, uv);\r\n#ifndef GAMMATEXTURE\r\n    //是linear数据\r\n    #ifdef GAMMASPACE\r\n        color.xyz = linearToGamma(color.xyz);    \r\n    #endif\r\n#else\r\n    //gamma数据\r\n    #ifndef GAMMASPACE\r\n        color.xyz = gammaToLinear(color.xyz);\r\n    #endif\r\n#endif\r\n    return color;\r\n}\r\n\r\n#if defined(PRIMITIVEMESH)\r\n    varying vec4 v_color;\r\n    varying vec2 v_cliped;\r\n  \r\n\r\n    vec4 getGlColor(vec4 color){\r\n        #ifdef GAMMASPACE\r\n            return color;\r\n        #else\r\n            return gammaToLinear(color);\r\n        #endif\r\n    }\r\n\r\n#elif defined(TEXTUREVS)\r\n    varying vec2 v_cliped;\r\n    varying vec4 v_texcoordAlpha;\r\n    varying vec4 v_color;\r\n    varying float v_useTex;\r\n    \r\n    //uniform\r\n    uniform sampler2D u_spriteTexture;\r\n\r\n    #ifdef BLUR_FILTER\r\n        uniform vec4 u_strength_sig2_2sig2_gauss1; // TODO模糊的过程中会导致变暗变亮\r\n        uniform vec2 u_blurInfo;\r\n        #define PI 3.141593\r\n    #endif\r\n\r\n    #ifdef COLOR_FILTER\r\n        uniform vec4 u_colorAlpha;\r\n        uniform mat4 u_colorMat;\r\n    #endif\r\n\r\n    #ifdef GLOW_FILTER\r\n        uniform vec4 u_color;\r\n        uniform vec4 u_blurInfo1;\r\n        uniform vec4 u_blurInfo2;\r\n    #endif\r\n\r\n    #ifdef COLOR_ADD\r\n        uniform vec4 u_colorAdd;\r\n    #endif\r\n\r\n    #ifdef FILLTEXTURE\r\n        uniform vec4 u_TexRange; // startu,startv,urange, vrange\r\n    #endif\r\n\r\n\r\n    #ifdef BLUR_FILTER\r\n        float getGaussian(float x, float y)\r\n        {\r\n            return u_strength_sig2_2sig2_gauss1.w * exp(-(x * x + y * y) / u_strength_sig2_2sig2_gauss1.z);\r\n        }\r\n\r\n        vec4 blur()\r\n        {\r\n            const float blurw = 9.0;\r\n            vec4 vec4Color = vec4(0.0, 0.0, 0.0, 0.0);\r\n            vec2 halfsz = vec2(blurw, blurw) / 2.0 / u_blurInfo;\r\n            vec2 startpos = v_texcoordAlpha.xy - halfsz;\r\n            vec2 ctexcoord = startpos;\r\n            vec2 step = 1.0 / u_blurInfo; //每个像素\r\n\r\n            for (float y = 0.0; y <= blurw; ++y)\r\n            {\r\n                ctexcoord.x = startpos.x;\r\n                for (float x = 0.0; x <= blurw; ++x)\r\n                {\r\n                    // TODO 纹理坐标的固定偏移应该在vs中处理\r\n                    vec4Color += sampleTexture(u_spriteTexture, ctexcoord) * getGaussian(x - blurw / 2.0, y - blurw / 2.0);\r\n                    ctexcoord.x += step.x;\r\n                }\r\n                ctexcoord.y += step.y;\r\n            }\r\n            // vec4Color.w=1.0;  这个会导致丢失alpha。以后有时间再找模糊会导致透明的问题\r\n            return vec4Color;\r\n        }\r\n    #endif\r\n\r\n    vec4 getSpriteTextureColor(){\r\n        #ifdef FILLTEXTURE\r\n            return sampleTexture(u_spriteTexture, fract(v_texcoordAlpha.xy) * u_TexRange.zw + u_TexRange.xy);\r\n        #else\r\n            return sampleTexture(u_spriteTexture, v_texcoordAlpha.xy);\r\n        #endif\r\n    }\r\n\r\n    void setglColor(in vec4 color){\r\n        if (v_useTex <= 0.)\r\n            color = vec4(1., 1., 1., 1.);\r\n\r\n        color.a *= v_color.w;\r\n        // color.rgb*=v_color.w;\r\n        vec4 transColor = v_color;\r\n        #ifndef GAMMASPACE\r\n            transColor = gammaToLinear(v_color);\r\n        #endif\r\n        color.rgb *= transColor.rgb;\r\n        gl_FragColor = color;\r\n\r\n        #ifdef COLOR_ADD\r\n            gl_FragColor = vec4(u_colorAdd.rgb, u_colorAdd.a * gl_FragColor.a);\r\n            gl_FragColor.xyz *= u_colorAdd.a;\r\n        #endif\r\n\r\n        #ifdef BLUR_FILTER\r\n            gl_FragColor = blur();\r\n            gl_FragColor.w *= v_color.w;\r\n        #endif\r\n\r\n        #ifdef COLOR_FILTER\r\n            mat4 alphaMat = u_colorMat;\r\n\r\n            alphaMat[0][3] *= gl_FragColor.a;\r\n            alphaMat[1][3] *= gl_FragColor.a;\r\n            alphaMat[2][3] *= gl_FragColor.a;\r\n\r\n            gl_FragColor = gl_FragColor * alphaMat;\r\n            gl_FragColor += u_colorAlpha / 255.0 * gl_FragColor.a;\r\n        #endif\r\n\r\n        #ifdef GLOW_FILTER\r\n            const float c_IterationTime = 10.0;\r\n            float floatIterationTotalTime = c_IterationTime * c_IterationTime;\r\n            vec4 vec4Color = vec4(0.0, 0.0, 0.0, 0.0);\r\n            vec2 vec2FilterDir = vec2(-(u_blurInfo1.z) / u_blurInfo2.x, -(u_blurInfo1.w) / u_blurInfo2.y);\r\n            vec2 vec2FilterOff = vec2(u_blurInfo1.x / u_blurInfo2.x / c_IterationTime * 2.0, u_blurInfo1.y / u_blurInfo2.y / c_IterationTime * 2.0);\r\n            float maxNum = u_blurInfo1.x * u_blurInfo1.y;\r\n            vec2 vec2Off = vec2(0.0, 0.0);\r\n            float floatOff = c_IterationTime / 2.0;\r\n            for (float i = 0.0; i <= c_IterationTime; ++i)\r\n            {\r\n                for (float j = 0.0; j <= c_IterationTime; ++j)\r\n                {\r\n                    vec2Off = vec2(vec2FilterOff.x * (i - floatOff), vec2FilterOff.y * (j - floatOff));\r\n                    vec4Color += sampleTexture(u_spriteTexture, v_texcoordAlpha.xy + vec2FilterDir + vec2Off) / floatIterationTotalTime;\r\n                }\r\n            }\r\n            gl_FragColor = vec4(u_color.rgb, vec4Color.a * u_blurInfo2.z);\r\n            gl_FragColor.rgb *= gl_FragColor.a;\r\n        #endif\r\n    }\r\n#endif\r\n\r\n\r\n\r\nvoid clip(){\r\n    if(v_cliped.x<0.) discard;\r\n    if(v_cliped.x>1.) discard;\r\n    if(v_cliped.y<0.) discard;\r\n    if(v_cliped.y>1.) discard;\r\n}"),Shader3D.addInclude("Sprite2DVertex.glsl",'#include "Sprite2DShaderInfo.glsl";\r\n#if defined(PRIMITIVEMESH)\r\n    // attribute vec4 a_position;\r\n    // attribute vec4 a_attribColor;\r\n    #ifdef WORLDMAT\r\n        uniform mat4 u_mmat;\r\n    #endif//WORLDMAT\r\n\r\n    varying vec4 v_color;\r\n    varying vec2 v_cliped;\r\n\r\n    uniform vec4 u_clipMatDir;\r\n    uniform vec2 u_clipMatPos;\r\n    uniform vec2 u_size;\r\n\r\n    void getVertexInfo(inout vertexInfo info){\r\n        float clipw = length(u_clipMatDir.xy);\r\n        float cliph = length(u_clipMatDir.zw);\r\n        vec2 clippos = a_position.xy - u_clipMatPos.xy;\t//pos已经应用矩阵了，为了减的有意义，clip的位置也要缩放\r\n        if(clipw>20000. && cliph>20000.)\r\n            info.cliped = vec2(0.5,0.5);\r\n        else {\r\n            //clipdir是带缩放的方向，由于上面clippos是在缩放后的空间计算的，所以需要把方向先normalize一下\r\n            info.cliped =vec2( dot(clippos,u_clipMatDir.xy)/clipw/clipw, dot(clippos,u_clipMatDir.zw)/cliph/cliph);\r\n        }\r\n        info.color = a_attribColor/255.;\r\n    }\r\n\r\n    void getPosition(inout vec4 pos){\r\n        #ifdef WORLDMAT\r\n            vec4 pos = u_mmat*vec4(a_position.xy,0.,1.);\r\n            pos = vec4((pos.x/u_size.x-0.5)*2.0,(0.5-pos.y/u_size.y)*2.0,pos.z,1.0);\r\n        #else\r\n            pos = vec4((a_position.x/u_size.x-0.5)*2.0,(0.5-a_position.y/u_size.y)*2.0,a_position.z,1.0);\r\n        #endif\r\n    }\r\n\r\n#elif defined(TEXTUREVS)\r\n\t//texture和fillrect使用的。\r\n    // attribute vec4 a_posuv;\r\n    // attribute vec4 a_attribColor;\r\n    // attribute vec4 a_attribFlags;\r\n\r\n    uniform vec4 u_clipMatDir;\r\n    uniform vec2 u_clipMatPos;\t\t// 这个是全局的，不用再应用矩阵了。\r\n\r\n    uniform vec2 u_size;\r\n    uniform vec2 u_clipOff;\t\t\t// 使用要把clip偏移。cacheas normal用. 只用了[0]\r\n    #ifdef WORLDMAT\r\n        uniform mat4 u_mmat;\r\n    #endif\r\n\r\n    #ifdef MVP3D\r\n        uniform mat4 u_MvpMatrix;\r\n    #endif\r\n\r\n    varying vec2 v_cliped;\r\n    varying vec4 v_texcoordAlpha;\r\n    varying vec4 v_color;\r\n    varying float v_useTex;\r\n\r\n    void getVertexInfo(inout vertexInfo info){\r\n       \t//texcoordAlpha\r\n        info.texcoordAlpha.xy = a_posuv.zw;\r\n        //color\r\n        info.color = a_attribColor/255.0;\r\n\t    info.color.xyz*= info.color.w;//反正后面也要预乘\r\n        //useTex\r\n        info.useTex = a_attribFlags.r/255.0;\r\n\r\n        //clip\r\n    \tfloat clipw = length(u_clipMatDir.xy);\r\n    \tfloat cliph = length(u_clipMatDir.zw);\r\n\t    vec2 clpos = u_clipMatPos.xy;\r\n        #ifdef WORLDMAT\r\n            // 如果有mmat，需要修改clipMatPos,因为 这是cacheas normal （如果不是就错了）， clipMatPos被去掉了偏移\r\n            if(u_clipOff[0]>0.0){\r\n                clpos.x+=u_mmat[3].x;\t//tx\t最简单处理\r\n                clpos.y+=u_mmat[3].y;\t//ty\r\n            }\r\n        #endif\r\n        vec2 clippos = a_posuv.xy - clpos;\t//pos已经应用矩阵了，为了减的有意义，clip的位置也要缩放\r\n        if(clipw>20000. && cliph>20000.)\r\n            info.cliped = vec2(0.5,0.5);\r\n        else {\r\n            //转成0到1之间。/clipw/clipw 表示clippos与normalize之后的clip朝向点积之后，再除以clipw\r\n            info.cliped = vec2( dot(clippos,u_clipMatDir.xy)/clipw/clipw, dot(clippos,u_clipMatDir.zw)/cliph/cliph);\r\n        }\r\n    }\r\n\r\n    void getPosition(inout vec4 glPosition){\r\n        vec4 pos = vec4(a_posuv.xy,0.,1.);\r\n        #ifdef WORLDMAT\r\n            pos= u_mmat * pos;\r\n        #endif\r\n            vec4 pos1 = vec4((pos.x/u_size.x-0.5)*2.0,(0.5-pos.y/u_size.y)*2.0,0.,1.0);\r\n        #ifdef MVP3D\r\n            glPosition = u_MvpMatrix * pos1;\r\n        #else\r\n            glPosition = pos1;\r\n        #endif\r\n        \r\n        #ifdef INVERTY\r\n            glPosition.y = -glPosition.y;\r\n        #endif\r\n    }\r\n\r\n#endif'),Shader3D.addInclude("Sprite2DShaderInfo.glsl","\r\n#if defined(PRIMITIVEMESH)\r\n    struct vertexInfo {\r\n        vec4 color;\r\n        vec2 cliped;\r\n    };\r\n#elif defined(TEXTUREVS)\r\n   struct vertexInfo {\r\n        vec4 color;\r\n        vec2 cliped;\r\n        vec4 texcoordAlpha;\r\n        float useTex;\r\n    };\r\n#endif"),Shader2D.textureShader=Shader3D.add("Sprite2DTexture",!1,!1);let e=new SubShader(Shader2D.textureAttribute,{},{});Shader2D.textureShader.addSubShader(e),e.addShaderPass('#define SHADER_NAME TextureVS2D\r\n#include "Sprite2DVertex.glsl";\r\n\r\nvoid main() {\r\n\tvertexInfo info;\r\n\tgetVertexInfo(info);\r\n\r\n\tv_cliped = info.cliped;\r\n\tv_texcoordAlpha = info.texcoordAlpha;\r\n\tv_useTex = info.useTex;\r\n\tv_color = info.color;\r\n\r\n\tvec4 pos;\r\n\tgetPosition(pos);\r\n\tgl_Position = pos;\r\n\r\n}\r\n','#define SHADER_NAME TextureFS2D\r\n//texture和fillrect使用的。\r\n#if defined(GL_FRAGMENT_PRECISION_HIGH) // 原来的写法会被我们自己的解析流程处理，而我们的解析是不认内置宏的，导致被删掉，所以改成 if defined 了\r\nprecision highp float;\r\n#else\r\nprecision mediump float;\r\n#endif\r\n\r\n#include "Sprite2DFrag.glsl";\r\n\r\nvoid main()\r\n{\r\n    clip();\r\n    vec4 color = getSpriteTextureColor();\r\n    setglColor(color);\r\n}\r\n'),Shader2D.primitiveShader=Shader3D.add("Sprite2DPrimitive",!1,!1),e=new SubShader(Shader2D.primitiveAttribute,{},{}),Shader2D.primitiveShader.addSubShader(e),e.addShaderPass('#define SHADER_NAME PrimitiveVS2D\r\n#include "Sprite2DVertex.glsl";\r\n\r\n\r\n#ifdef WORLDMAT\r\n\tuniform mat4 mmat;\r\n#endif\r\n\r\nvoid main(){\r\n\tvertexInfo info;\r\n\tgetVertexInfo(info);\r\n\t\r\n\t//Update \r\n\tv_color = info.color;\r\n\tv_cliped = info.cliped;\r\n\t\r\n\tvec4 pos;\r\n\t\r\n\tgetPosition(pos);\r\n\tgl_Position = pos;\r\n}','#define SHADER_NAME PrimitiveFS2D\r\nprecision mediump float;\r\n\r\n#include "Sprite2DFrag.glsl";\r\n\r\nvoid main(){\r\n\tclip();\r\n\tgl_FragColor = getGlColor(v_color);\r\n\tgl_FragColor.rgb*=gl_FragColor.a;\r\n}')}}Shader2D.primitiveAttribute={a_position:[0,e.ShaderDataType.Vector4],a_attribColor:[1,e.ShaderDataType.Vector4]},Shader2D.textureAttribute={a_posuv:[0,e.ShaderDataType.Vector4],a_attribColor:[1,e.ShaderDataType.Vector4],a_attribFlags:[2,e.ShaderDataType.Vector4]};class SkinMeshBuffer{constructor(){this.ib=IndexBuffer2D.create(e.BufferUsage.Dynamic),this.vb=VertexBuffer2D.create(8)}static getInstance(){return SkinMeshBuffer.instance=SkinMeshBuffer.instance||new SkinMeshBuffer}addSkinMesh(e){e.getData2(this.vb,this.ib,this.vb._byteLength/32)}reset(){this.vb.buffer2D.clear(),this.ib.buffer2D.clear()}}const fe=15*Math.PI/180;class BasePoly{static _checkMinAngle(e,t,r,a,i,s){const n=r-e,o=a-t,l=i-r,h=s-a,u=(n*l+o*h)/(Math.sqrt(n*n+o*o)*Math.sqrt(l*l+h*h)),d=Math.acos(Math.abs(u));return Math.abs(d)<fe}static createLine2(e,t,r,a,i,s){if(e.length<4)return null;let n=a;var o=BasePoly.tempData.length>e.length+2?BasePoly.tempData:new Array(e.length+2);o[0]=e[0],o[1]=e[1];var l=2,h=0,u=e.length;for(h=2;h<u;h+=2)Math.abs(e[h]-e[h-2])+Math.abs(e[h+1]-e[h-1])>.01&&(o[l++]=e[h],o[l++]=e[h+1]);let d=Math.abs(e[0]-o[l-2])+Math.abs(e[1]-o[l-1]);s&&d>0&&(d>1e-13?(o[l++]=e[0],o[l++]=e[1]):(o[l-2]=e[0],o[l-1]=e[1]));var _=i;u=l/2;var c,p,m,f,g,T,S=r/2;for(c=o[0],p=o[1],m=o[2],f=o[3],this.vec2=this.getNormal(c,p,m,f,S,this.vec2),_.push(c-this.vec2.x,p-this.vec2.y,c+this.vec2.x,p+this.vec2.y),h=1;h<u-1;h++)c=o[2*(h-1)],p=o[2*(h-1)+1],m=o[2*h],f=o[2*h+1],g=o[2*(h+1)],T=o[2*(h+1)+1],t.push(a+0,a+1,a+3,a+3,a+2,a+0),a+=2,a+=this._setMiddleVertexs(c,p,m,f,g,T,S,_,this.vec2,t,a);if(c=o[l-4],p=o[l-3],m=o[l-2],f=o[l-1],this.vec2=this.getNormal(c,p,m,f,S,this.vec2),_.push(m-this.vec2.x,f-this.vec2.y,m+this.vec2.x,f+this.vec2.y),t.push(a+0,a+1,a+3,a+3,a+2,a+0),m==o[0]&&f==o[1]){g=o[2],T=o[3];let e=_.length/2;a+=4;let r=BasePoly.tempIndexs;r[0]=n+e-2,r[1]=n+e-1,r[2]=n,r[3]=n+1,this._setMiddleVertexs(c,p,m,f,g,T,S,_,this.vec2,t,a,r)}return _}static _setMiddleVertexs(e,t,r,a,i,s,n,o,l,h,u,d=null){this.getNormal(e,t,r,a,n,l);let _=l.x,c=l.y;this.getNormal(r,a,i,s,n,l);let p=l.x,m=l.y;if(this._checkMinAngle(e,t,r,a,i,s))return d?h.push(d[0],d[1],d[3],d[3],d[2],d[0]):(o.push(r-_,a-c,r+_,a+c),o.push(r-p,a-m,r+p,a+m),h.push(u+0,u+1,u+3,u+3,u+2,u+0)),2;let f=-c+t-(-c+a),g=-_+r-(-_+e),T=(-_+e)*(-c+a)-(-_+r)*(-c+t),S=-m+s-(-m+a),x=-p+r-(-p+i),y=(-p+i)*(-m+a)-(-p+r)*(-m+s),E=f*x-S*g;if(E=f*x-S*g,Math.abs(E)<.1)return E+=10.1,o.push(r-_,a-c,r+_,a+c),0;let R=(g*y-x*T)/E,b=(S*T-f*y)/E;return d?E>0?(o.push(R,b,r,a),h.push(d[0],u+0,d[2]),h.push(d[2],u+1,d[0])):(o.push(r-(R-r),a-(b-a),r,a),h.push(d[1],u+0,d[3]),h.push(d[3],u+1,d[1])):(o.push(r-_,a-c,r+_,a+c),E>0?(o.push(R,b,r,a),h.push(u+0,u+2,u+4),h.push(u+4,u+3,u+0)):(o.push(r-(R-r),a-(b-a),r,a),h.push(u+1,u+2,u+5),h.push(u+5,u+3,u+1)),o.push(r-p,a-m,r+p,a+m)),4}static getNormal(e,t,r,a,i,s){s||(s=new Vector2);let n=a-t,o=e-r,l=Math.sqrt(n*n+o*o);return s.x=n/l*i,s.y=o/l*i,s}static createLineTriangle(e,t,r,a,i,s,n){var o=e.slice(),l=o.length,h=o[0],u=o[1],d=o[2],_=(o[2],0),c=0,p=0,m=0,f=l/2;if(!(f<=1)&&2!=f){for(var g=new Array(4*f),T=0,S=0,x=0;x<f-1;x++)h=o[S++],u=o[S++],d=o[S++],m=o[S++]-u,0!=(p=d-h)&&0!=m&&(_=Math.sqrt(p*p+m*m))>.001&&(g[c=4*T]=h,g[c+1]=u,g[c+2]=p/_,g[c+3]=m/_,T++);for(a?(h=o[l-2],u=o[l-1],d=o[0],m=o[1]-u,0!=(p=d-h)&&0!=m&&(_=Math.sqrt(p*p+m*m))>.001&&(g[c=4*T]=h,g[c+1]=u,g[c+2]=p/_,g[c+3]=m/_,T++)):(g[c=4*T]=h,g[c+1]=u,g[c+2]=p/_,g[c+3]=m/_,T++),S=0,x=0;x<f;x++)h=o[S],u=o[S+1],d=o[S+2],o[S+3]}}}BasePoly.tempData=new Array(256),BasePoly.tempIndexs=new Array(4);class EarcutNode{constructor(e,t,r){this.i=e,this.x=t,this.y=r,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}}class Earcut{static earcut(e,t,r){r=r||2;var a,i,s,n,o,l,h,u=t&&t.length,d=u?t[0]*r:e.length,_=Earcut.linkedList(e,0,d,r,!0),c=[];if(!_)return c;if(u&&(_=Earcut.eliminateHoles(e,t,_,r)),e.length>80*r){a=s=e[0],i=n=e[1];for(var p=r;p<d;p+=r)(o=e[p])<a&&(a=o),(l=e[p+1])<i&&(i=l),o>s&&(s=o),l>n&&(n=l);h=0!==(h=Math.max(s-a,n-i))?1/h:0}return Earcut.earcutLinked(_,c,r,a,i,h),c}static linkedList(e,t,r,a,i){var s,n;if(i===Earcut.signedArea(e,t,r,a)>0)for(s=t;s<r;s+=a)n=Earcut.insertNode(s,e[s],e[s+1],n);else for(s=r-a;s>=t;s-=a)n=Earcut.insertNode(s,e[s],e[s+1],n);return n&&Earcut.equals(n,n.next)&&(Earcut.removeNode(n),n=n.next),n}static filterPoints(e,t){if(!e)return e;t||(t=e);var r,a=e;do{if(r=!1,a.steiner||!Earcut.equals(a,a.next)&&0!==Earcut.area(a.prev,a,a.next))a=a.next;else{if(Earcut.removeNode(a),(a=t=a.prev)===a.next)break;r=!0}}while(r||a!==t);return t}static earcutLinked(e,t,r,a,i,s,n=null){if(e){!n&&s&&Earcut.indexCurve(e,a,i,s);for(var o,l,h=e;e.prev!==e.next;)if(o=e.prev,l=e.next,s?Earcut.isEarHashed(e,a,i,s):Earcut.isEar(e))t.push(o.i/r),t.push(e.i/r),t.push(l.i/r),Earcut.removeNode(e),e=l.next,h=l.next;else if((e=l)===h){n?1===n?(e=Earcut.cureLocalIntersections(e,t,r),Earcut.earcutLinked(e,t,r,a,i,s,2)):2===n&&Earcut.splitEarcut(e,t,r,a,i,s):Earcut.earcutLinked(Earcut.filterPoints(e,null),t,r,a,i,s,1);break}}}static isEar(e){var t=e.prev,r=e,a=e.next;if(Earcut.area(t,r,a)>=0)return!1;for(var i=e.next.next;i!==e.prev;){if(Earcut.pointInTriangle(t.x,t.y,r.x,r.y,a.x,a.y,i.x,i.y)&&Earcut.area(i.prev,i,i.next)>=0)return!1;i=i.next}return!0}static isEarHashed(e,t,r,a){var i=e.prev,s=e,n=e.next;if(Earcut.area(i,s,n)>=0)return!1;for(var o=i.x<s.x?i.x<n.x?i.x:n.x:s.x<n.x?s.x:n.x,l=i.y<s.y?i.y<n.y?i.y:n.y:s.y<n.y?s.y:n.y,h=i.x>s.x?i.x>n.x?i.x:n.x:s.x>n.x?s.x:n.x,u=i.y>s.y?i.y>n.y?i.y:n.y:s.y>n.y?s.y:n.y,d=Earcut.zOrder(o,l,t,r,a),_=Earcut.zOrder(h,u,t,r,a),c=e.nextZ;c&&c.z<=_;){if(c!==e.prev&&c!==e.next&&Earcut.pointInTriangle(i.x,i.y,s.x,s.y,n.x,n.y,c.x,c.y)&&Earcut.area(c.prev,c,c.next)>=0)return!1;c=c.nextZ}for(c=e.prevZ;c&&c.z>=d;){if(c!==e.prev&&c!==e.next&&Earcut.pointInTriangle(i.x,i.y,s.x,s.y,n.x,n.y,c.x,c.y)&&Earcut.area(c.prev,c,c.next)>=0)return!1;c=c.prevZ}return!0}static cureLocalIntersections(e,t,r){var a=e;do{var i=a.prev,s=a.next.next;!Earcut.equals(i,s)&&Earcut.intersects(i,a,a.next,s)&&Earcut.locallyInside(i,s)&&Earcut.locallyInside(s,i)&&(t.push(i.i/r),t.push(a.i/r),t.push(s.i/r),Earcut.removeNode(a),Earcut.removeNode(a.next),a=e=s),a=a.next}while(a!==e);return a}static splitEarcut(e,t,r,a,i,s){var n=e;do{for(var o=n.next.next;o!==n.prev;){if(n.i!==o.i&&Earcut.isValidDiagonal(n,o)){var l=Earcut.splitPolygon(n,o);return n=Earcut.filterPoints(n,n.next),l=Earcut.filterPoints(l,l.next),Earcut.earcutLinked(n,t,r,a,i,s),void Earcut.earcutLinked(l,t,r,a,i,s)}o=o.next}n=n.next}while(n!==e)}static eliminateHoles(e,t,r,a){var i,s,n,o,l,h=[];for(i=0,s=t.length;i<s;i++)n=t[i]*a,o=i<s-1?t[i+1]*a:e.length,(l=Earcut.linkedList(e,n,o,a,!1))===l.next&&(l.steiner=!0),h.push(Earcut.getLeftmost(l));for(h.sort(Earcut.compareX),i=0;i<h.length;i++)Earcut.eliminateHole(h[i],r),r=Earcut.filterPoints(r,r.next);return r}static compareX(e,t){return e.x-t.x}static eliminateHole(e,t){if(t=Earcut.findHoleBridge(e,t)){var r=Earcut.splitPolygon(t,e);Earcut.filterPoints(r,r.next)}}static findHoleBridge(e,t){var r,a=t,i=e.x,s=e.y,n=-1/0;do{if(s<=a.y&&s>=a.next.y&&a.next.y!==a.y){var o=a.x+(s-a.y)*(a.next.x-a.x)/(a.next.y-a.y);if(o<=i&&o>n){if(n=o,o===i){if(s===a.y)return a;if(s===a.next.y)return a.next}r=a.x<a.next.x?a:a.next}}a=a.next}while(a!==t);if(!r)return null;if(i===n)return r.prev;var l,h=r,u=r.x,d=r.y,_=1/0;for(a=r.next;a!==h;)i>=a.x&&a.x>=u&&i!==a.x&&Earcut.pointInTriangle(s<d?i:n,s,u,d,s<d?n:i,s,a.x,a.y)&&((l=Math.abs(s-a.y)/(i-a.x))<_||l===_&&a.x>r.x)&&Earcut.locallyInside(a,e)&&(r=a,_=l),a=a.next;return r}static indexCurve(e,t,r,a){var i=e;do{null===i.z&&(i.z=Earcut.zOrder(i.x,i.y,t,r,a)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==e);i.prevZ.nextZ=null,i.prevZ=null,Earcut.sortLinked(i)}static sortLinked(e){var t,r,a,i,s,n,o,l,h=1;do{for(r=e,e=null,s=null,n=0;r;){for(n++,a=r,o=0,t=0;t<h&&(o++,a=a.nextZ);t++);for(l=h;o>0||l>0&&a;)0!==o&&(0===l||!a||r.z<=a.z)?(i=r,r=r.nextZ,o--):(i=a,a=a.nextZ,l--),s?s.nextZ=i:e=i,i.prevZ=s,s=i;r=a}s.nextZ=null,h*=2}while(n>1);return e}static zOrder(e,t,r,a,i){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-r)*i)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-a)*i)|t<<8))|t<<4))|t<<2))|t<<1))<<1}static getLeftmost(e){var t=e,r=e;do{t.x<r.x&&(r=t),t=t.next}while(t!==e);return r}static pointInTriangle(e,t,r,a,i,s,n,o){return(i-n)*(t-o)-(e-n)*(s-o)>=0&&(e-n)*(a-o)-(r-n)*(t-o)>=0&&(r-n)*(s-o)-(i-n)*(a-o)>=0}static isValidDiagonal(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!Earcut.intersectsPolygon(e,t)&&Earcut.locallyInside(e,t)&&Earcut.locallyInside(t,e)&&Earcut.middleInside(e,t)}static area(e,t,r){return(t.y-e.y)*(r.x-t.x)-(t.x-e.x)*(r.y-t.y)}static equals(e,t){return e.x===t.x&&e.y===t.y}static intersects(e,t,r,a){return!!(Earcut.equals(e,t)&&Earcut.equals(r,a)||Earcut.equals(e,a)&&Earcut.equals(r,t))||Earcut.area(e,t,r)>0!=Earcut.area(e,t,a)>0&&Earcut.area(r,a,e)>0!=Earcut.area(r,a,t)>0}static intersectsPolygon(e,t){var r=e;do{if(r.i!==e.i&&r.next.i!==e.i&&r.i!==t.i&&r.next.i!==t.i&&Earcut.intersects(r,r.next,e,t))return!0;r=r.next}while(r!==e);return!1}static locallyInside(e,t){return Earcut.area(e.prev,e,e.next)<0?Earcut.area(e,t,e.next)>=0&&Earcut.area(e,e.prev,t)>=0:Earcut.area(e,t,e.prev)<0||Earcut.area(e,e.next,t)<0}static middleInside(e,t){var r=e,a=!1,i=(e.x+t.x)/2,s=(e.y+t.y)/2;do{r.y>s!=r.next.y>s&&r.next.y!==r.y&&i<(r.next.x-r.x)*(s-r.y)/(r.next.y-r.y)+r.x&&(a=!a),r=r.next}while(r!==e);return a}static splitPolygon(e,t){var r=new EarcutNode(e.i,e.x,e.y),a=new EarcutNode(t.i,t.x,t.y),i=e.next,s=t.prev;return e.next=t,t.prev=e,r.next=i,i.prev=r,a.next=r,r.prev=a,s.next=a,a.prev=s,a}static insertNode(e,t,r,a){var i=new EarcutNode(e,t,r);return a?(i.next=a.next,i.prev=a,a.next.prev=i,a.next=i):(i.prev=i,i.next=i),i}static removeNode(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}static signedArea(e,t,r,a){for(var i=0,s=t,n=r-a;s<r;s+=a)i+=(e[n]-e[s])*(e[s+1]+e[n+1]),n=s;return i}}var ge,Te;e.MeshTopology=void 0,(ge=e.MeshTopology||(e.MeshTopology={}))[ge.Points=0]="Points",ge[ge.Lines=1]="Lines",ge[ge.LineLoop=2]="LineLoop",ge[ge.LineStrip=3]="LineStrip",ge[ge.Triangles=4]="Triangles",ge[ge.TriangleStrip=5]="TriangleStrip",ge[ge.TriangleFan=6]="TriangleFan";class Submit extends SubmitBase{constructor(e=SubmitBase.TYPE_2D){super(e)}renderSubmit(){if(0===this._numEle||!this._mesh||0==this._numEle)return 1;var t=this.shaderValue.textureHost;if(t){var r=t._getSource();if(!r)return 1;this.shaderValue.texture=r}return this._mesh.useMesh(),this.shaderValue.upload(this.material),BlendMode.activeBlendFunction!==this._blendFn&&(RenderStateContext.setBlend(!0),this._blendFn(),BlendMode.activeBlendFunction=this._blendFn),LayaGL.renderDrawContext.drawElements2DTemp(e.MeshTopology.Triangles,this._numEle,e.IndexFormat.UInt16,this._startIdx),1}releaseRender(){SubmitBase.RENDERBASE!=this&&--this._ref<1&&(Submit.POOL[Submit._poolSize++]=this,this.shaderValue.release(),this.shaderValue=null,this._mesh=null,this._parent&&(this._parent.releaseRender(),this._parent=null))}static create(e,t,r){var a=Submit._poolSize?Submit.POOL[--Submit._poolSize]:new Submit;a._ref=1,a._mesh=t,a._key.clear(),a._startIdx=t.indexNum*Const.BYTES_PIDX,a._numEle=0;var i=e._nBlendType;a._blendFn=e._targets?BlendMode.targetFns[i]:BlendMode.fns[i],a.shaderValue=r,a.material=e.material;var s=e._shader2D.filters;return s&&a.shaderValue.setFilters(s),a}static createShape(e,t,r,a){var i=Submit._poolSize?Submit.POOL[--Submit._poolSize]:new Submit;i._mesh=t,i._numEle=r,i._startIdx=2*t.indexNum,i._ref=1,i.shaderValue=a;var s=e._nBlendType;return i._key.blendShader=s,i.material=e.material,i._blendFn=e._targets?BlendMode.targetFns[s]:BlendMode.fns[s],i}}Submit._poolSize=0,Submit.POOL=[];class SubmitCanvas extends SubmitBase{static create(e,t,r){var a=SubmitCanvas.POOL._length?SubmitCanvas.POOL[--SubmitCanvas.POOL._length]:new SubmitCanvas;a.canv=e,a._ref=1,a._numEle=0;var i=a.shaderValue;return i.alpha=t,i.defines.clearDefine(),r&&r.length&&i.setFilters(r),a}constructor(){super(SubmitBase.TYPE_2D),this._matrix=new Matrix,this._matrix4=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],this.shaderValue=new Value2D(e.RenderSpriteData.Zero)}renderSubmit(){var e=RenderState2D.worldAlpha,t=RenderState2D.worldMatrix4,r=RenderState2D.worldMatrix,a=RenderState2D.worldFilters,i=RenderState2D.worldShaderDefines,s=this.shaderValue,n=this._matrix,o=this._matrix4,l=Matrix.TEMP;return Matrix.mul(n,r,l),o[0]=l.a,o[1]=l.b,o[4]=l.c,o[5]=l.d,o[12]=l.tx,o[13]=l.ty,RenderState2D.worldMatrix=l.clone(),RenderState2D.worldMatrix4=o,RenderState2D.worldAlpha=RenderState2D.worldAlpha*s.alpha,s.filters&&s.filters.length&&(RenderState2D.worldFilters=s.filters,RenderState2D.worldShaderDefines=s.defines),this.canv.flushsubmit(),RenderState2D.worldAlpha=e,RenderState2D.worldMatrix4=t,RenderState2D.worldMatrix.destroy(),RenderState2D.worldMatrix=r,RenderState2D.worldFilters=a,RenderState2D.worldShaderDefines=i,1}releaseRender(){if(--this._ref<1){var e=SubmitCanvas.POOL;this._mesh=null,e[e._length++]=this}}getRenderType(){return SubmitBase.TYPE_CANVAS}}SubmitCanvas.POOL=[],SubmitCanvas.POOL._length=0;class SubmitTarget{constructor(){this.blendType=0,this._ref=1,this._key=new SubmitKey}renderSubmit(){this._mesh.useMesh();var t=this.srcRT;return t&&(this.shaderValue.textureHost=t,this.shaderValue.upload(),this.blend(),LayaGL.renderDrawContext.drawElements2DTemp(e.MeshTopology.Triangles,this._numEle,e.IndexFormat.UInt16,this._startIdx)),1}blend(){BlendMode.activeBlendFunction!==BlendMode.fns[this.blendType]&&(RenderStateContext.setBlend(!0),BlendMode.fns[this.blendType](),BlendMode.activeBlendFunction=BlendMode.fns[this.blendType])}getRenderType(){return 0}releaseRender(){if(--this._ref<1){var e=SubmitTarget.POOL;e[e._length++]=this}}static create(e,t,r,a){var i=SubmitTarget.POOL._length?SubmitTarget.POOL[--SubmitTarget.POOL._length]:new SubmitTarget;if(i._mesh=t,i.srcRT=a,i._startIdx=t.indexNum*Const.BYTES_PIDX,i._ref=1,i._key.clear(),i._numEle=0,i.blendType=e._nBlendType,i._key.blendShader=i.blendType,i.shaderValue=r,e._colorFiler){var s=e._colorFiler;r.defines.addDefine(s.typeDefine),Matrix4x4.TEMPMatrix0.cloneByArray(s._mat),r.colorMat=Matrix4x4.TEMPMatrix0,Vector4.tempVec4.setValue(s._alpha[0],s._alpha[1],s._alpha[2],s._alpha[3]),r.colorAlpha=Vector4.tempVec4}return i}}SubmitTarget.POOL=[],SubmitTarget.POOL._length=0;class SubmitTexture extends SubmitBase{constructor(e=SubmitBase.TYPE_2D){super(e)}releaseRender(){--this._ref<1&&(SubmitTexture.POOL[SubmitTexture._poolSize++]=this,this.shaderValue.release(),this._mesh=null,this._parent&&(this._parent.releaseRender(),this._parent=null))}renderSubmit(){if(0===this._numEle)return 1;var t=this.shaderValue.textureHost;if(t){var r=t?t._getSource():null;if(!r)return 1}return this._mesh.useMesh(),this.shaderValue.updateShaderData(),SubmitBase.preRender,SubmitBase.preRender._key,BlendMode.activeBlendFunction!==this._blendFn&&(RenderStateContext.setBlend(!0),this._blendFn(),BlendMode.activeBlendFunction=this._blendFn),this.shaderValue.texture=r,this.shaderValue.upload(this.material),LayaGL.renderDrawContext.drawElements2DTemp(e.MeshTopology.Triangles,this._numEle,e.IndexFormat.UInt16,this._startIdx),1}static create(e,t,r){var a=SubmitTexture._poolSize?SubmitTexture.POOL[--SubmitTexture._poolSize]:new SubmitTexture(SubmitBase.TYPE_TEXTURE);a._mesh=t,a._key.clear(),a._key.submitType=SubmitBase.KEY_DRAWTEXTURE,a._ref=1,a._startIdx=t.indexNum*Const.BYTES_PIDX,a._numEle=0;var i=e._nBlendType;if(a._key.blendShader=i,a._blendFn=e._targets?BlendMode.targetFns[i]:BlendMode.fns[i],a.shaderValue=r,a.material=e.material,e._colorFiler){var s=e._colorFiler;r.defines.addDefine(s.typeDefine),Matrix4x4.TEMPMatrix0.cloneByArray(s._mat),r.colorMat=Matrix4x4.TEMPMatrix0,Vector4.tempVec4.setValue(s._alpha[0],s._alpha[1],s._alpha[2],s._alpha[3]),r.colorAlpha=Vector4.tempVec4}return a}}SubmitTexture._poolSize=0,SubmitTexture.POOL=[];class CharSubmitCache{constructor(){this._data=[],this._ndata=0,this._clipid=-1,this._clipMatrix=new Matrix,this._enable=!1}clear(){this._tex=null,this._imgId=-1,this._ndata=0,this._enable=!1,this._colorFiler=null}destroy(){this.clear(),this._data.length=0,this._data=null}add(e,t,r,a,i,s){this._ndata>0&&(this._tex!=t||this._imgId!=r||this._clipid>=0&&this._clipid!=e._clipInfoID)&&this.submit(e),this._clipid=e._clipInfoID,e._globalClipMatrix.copyTo(this._clipMatrix),this._tex=t,this._imgId=r,this._colorFiler=e._colorFiler,this._data[this._ndata]=a,this._data[this._ndata+1]=i,this._data[this._ndata+2]=s,this._ndata+=3}getPos(){return 0==CharSubmitCache.__nPosPool?new Array(8):CharSubmitCache.__posPool[--CharSubmitCache.__nPosPool]}enable(e,t){e!==this._enable&&(this._enable=e,this._enable||this.submit(t))}submit(t){var r=this._ndata;if(r){var a=t._mesh,i=t._colorFiler;t._colorFiler=this._colorFiler;var s=SubmitTexture.create(t,a,Value2D.create(e.RenderSpriteData.Texture2D));t._submits[t._submits._length++]=t._curSubmit=s,s.shaderValue.textureHost=this._tex,s._key.other=this._imgId,t._colorFiler=i,t._copyClipInfo(s,this._clipMatrix),s.clipInfoID=this._clipid;for(var n=0;n<r;n+=3)a.addQuad(this._data[n],this._data[n+1],this._data[n+2],!0),CharSubmitCache.__posPool[CharSubmitCache.__nPosPool++]=this._data[n];r/=3,s._numEle+=6*r,a.indexNum+=6*r,a.vertNum+=4*r,t._drawCount+=r,this._ndata=0,RenderInfo.loopCount%100==0&&(this._data.length=0)}}}CharSubmitCache.__posPool=[],CharSubmitCache.__nPosPool=0;class Config3D{static setResolution(e,t){Config3D.customResolution=!0,Config3D._resoluWidth=e,Config3D._resoluHeight=t}}Config3D.enableDynamicBatch=!0,Config3D.enableStaticBatch=!0,Config3D.enableUniformBufferObject=!0,Config3D.pixelRatio=1,Config3D.customResolution=!1,Config3D.defaultCacheRTMemory=256,Config3D.defaultPhysicsMemory=16,Config3D.enableMultiLight=!0,Config3D.maxLightCount=32,Config3D.lightClusterCount=new Vector3(12,12,12),Config3D.maxMorphTargetCount=32,Config3D.useBVHCull=!1,Config3D.BVH_max_SpatialCount=7,Config3D.BVH_limit_size=32,Config3D.BVH_Min_Build_nums=10,Config3D._resoluWidth=-1,Config3D._resoluHeight=-1,Config3D.debugFrustumCulling=!1,Config.isStencil=!0;class RenderTexture extends BaseTexture{static get currentActive(){return RenderTexture._currentActive}static configRenderContextInstance(e){RenderTexture._configInstance=e}static createFromPool(e,t,r,a,i=!1,s=1,n=!1,o=!1){i=i&&0==(e&e-1)&&0==(t&t-1);let l=RenderTexture._pool.length;for(let h=0;h<l;h++){let u=RenderTexture._pool[h];if(u.width==e&&u.height==t&&u.colorFormat==r&&u.depthStencilFormat==a&&u._generateMipmap==i&&u.multiSamples==s&&u.generateDepthTexture==n&&u._gammaSpace==o){u._inPool=!1;let e=RenderTexture._pool[l-1];return RenderTexture._pool[h]=e,RenderTexture._pool.length-=1,RenderTexture._poolMemory-=u._renderTarget.gpuMemory/1024/1024,u}}let h=new RenderTexture(e,t,r,a,i,s,n,o);return h.lock=!0,h}static recoverToPool(e){e._inPool||e.destroyed||(RenderTexture._pool.push(e),RenderTexture._poolMemory+=e._renderTarget.gpuMemory/1024/1024,e._inPool=!0)}static clearPool(){if(!(RenderTexture._poolMemory<Config3D.defaultCacheRTMemory)){for(var e in RenderTexture._pool)RenderTexture._pool[e].destroy();RenderTexture._pool=[],RenderTexture._poolMemory=0}}static get bindCanvasRender(){return RenderTexture._bindCanvasRender}static set bindCanvasRender(e){e!=this._bindCanvasRender&&(this._bindCanvasRender=e)}get generateDepthTexture(){return this._generateDepthTexture}set generateDepthTexture(t){t&&!this._depthStencilTexture&&(this._depthStencilTexture=new BaseTexture(this.width,this.height,this.depthStencilFormat),this._depthStencilTexture._dimension=e.TextureDimension.Tex2D,this._depthStencilTexture._texture=LayaGL.textureContext.createRenderTextureInternal(e.TextureDimension.Tex2D,this.width,this.height,this.depthStencilFormat,!1,!1),LayaGL.textureContext.setupRendertargetTextureAttachment(this._renderTarget,this._depthStencilTexture._texture)),this._generateDepthTexture=t}get depthStencilTexture(){return this._depthStencilTexture}get colorFormat(){return this._renderTarget.colorFormat}get depthStencilFormat(){return this._renderTarget.depthStencilFormat}get multiSamples(){return this._renderTarget._samples}get isCube(){return this._renderTarget._isCube}get samples(){return this._renderTarget._samples}get generateMipmap(){return this._renderTarget._generateMipmap}constructor(t,r,a,i,s=!1,n=1,o=!1,l=!1){super(t,r,a),this._inPool=!1,this._isCameraTarget=!1,this._generateDepthTexture=!1,this._gammaSpace=l,this._depthStencilFormat=null==i?e.RenderTargetFormat.None:i,this._generateMipmap=s,this._multiSamples=n,this._generateDepthTexture=o,this._createRenderTarget()}_createRenderTarget(){this._dimension=e.TextureDimension.Tex2D,this._renderTarget=LayaGL.textureContext.createRenderTargetInternal(this.width,this.height,this._format,this._depthStencilFormat,this._generateMipmap,this._gammaSpace,this._multiSamples),this._generateMipmap=this._renderTarget._generateMipmap,this._texture=this._renderTarget._textures[0],this.generateDepthTexture=this._generateDepthTexture}recreate(t,r,a,i,s=!1,n=1,o=!1,l=!1){this._width=t,this._height=r,this._format=a,this._gammaSpace=l,this._depthStencilFormat=null==i?e.RenderTargetFormat.None:i,this._generateMipmap=s,this._multiSamples=n,this._generateDepthTexture=o,this._disposeResource(),this._createRenderTarget()}_start(){RenderTexture._configInstance.invertY=this._isCameraTarget,RenderTexture._currentActive!=this&&(RenderTexture._currentActive&&RenderTexture._currentActive._end(),RenderTexture._currentActive=this,LayaGL.textureContext.bindRenderTarget(this._renderTarget))}_end(){RenderTexture._currentActive=null,LayaGL.textureContext.unbindRenderTarget(this._renderTarget),this._isCameraTarget&&(RenderTexture._configInstance.invertY=!1)}getData(e,t,r,a,i){return LayaGL.textureContext.readRenderTargetPixelData(this._renderTarget,e,t,r,a,i),i}_disposeResource(){var e;RenderTexture._currentActive==this&&this._end(),this._renderTarget.dispose(),this._renderTarget=null,null===(e=this._depthStencilTexture)||void 0===e||e.destroy(),this._depthStencilTexture=null}}RenderTexture._currentActive=null,RenderTexture._configInstance={},RenderTexture._pool=[],RenderTexture._poolMemory=0,function(e){e[e.SIZE=0]="SIZE",e[e.CLEAR=1]="CLEAR",e[e.SAVE=2]="SAVE",e[e.TRANSFORM=3]="TRANSFORM",e[e.ALPHA=4]="ALPHA",e[e.RESTORE=5]="RESTORE",e[e.FILL_STYLE=6]="FILL_STYLE",e[e.FILL_RECT=7]="FILL_RECT",e[e.STROKE_STYLE=8]="STROKE_STYLE",e[e.LINE_WIDTH=9]="LINE_WIDTH",e[e.STROKE_RECT=10]="STROKE_RECT",e[e.FILL_WORD_TEXT=11]="FILL_WORD_TEXT",e[e.DRAW_TEXTURE_SIZE_GRID=12]="DRAW_TEXTURE_SIZE_GRID",e[e.DRAW_TEXTURE=13]="DRAW_TEXTURE",e[e.CLIP_RECT=14]="CLIP_RECT",e[e.DRAW_LINE=15]="DRAW_LINE",e[e.DRAW_LINES=16]="DRAW_LINES",e[e.SCALE=17]="SCALE",e[e.TRANSLATE=18]="TRANSLATE",e[e.ROTATE=19]="ROTATE",e[e.DRAW_CIRCLE=20]="DRAW_CIRCLE",e[e.DRAW_PIE=21]="DRAW_PIE",e[e.DRAW_POLY=22]="DRAW_POLY",e[e.DRAW_CURVES=23]="DRAW_CURVES",e[e.BEGIN_PATH=24]="BEGIN_PATH",e[e.MOVE_TO=25]="MOVE_TO",e[e.LINE_TO=26]="LINE_TO",e[e.ARC_TO=27]="ARC_TO",e[e.CLOSE_PATH=28]="CLOSE_PATH",e[e.FILL=29]="FILL",e[e.STROKE=30]="STROKE",e[e.SET_AS_BITMAP=31]="SET_AS_BITMAP",e[e.DRAW_MASKED=32]="DRAW_MASKED",e[e.DRAW_TRANGLES=33]="DRAW_TRANGLES",e[e.SET_GLOBAL_COMPOSITE_OPERTAION=34]="SET_GLOBAL_COMPOSITE_OPERTAION",e[e.FILL_WORDS=35]="FILL_WORDS",e[e.FILL_TEXTURE=36]="FILL_TEXTURE"}(Te||(Te={}));class NativeContext{static __init__(){}constructor(){this._byteLen=0,this.sprite=null,this._renderObject3DList=[],this._tmpMatrix=new Matrix,this._nativeObj=new window._conchContext(LayaGL.renderEngine._nativeObj),this._byteLen=524288,this._tempRenderTexture2D=new NativeRenderTexture2D(0,0,e.RenderTargetFormat.R8G8B8A8,e.RenderTargetFormat.None,!1),this._init(!1)}_init(e){this._buffer=new ArrayBuffer(this._byteLen),this._idata=new Int32Array(this._buffer),this._fdata=new Float32Array(this._buffer),this._byteArray=new Uint8Array(this._buffer);var t=window.webglPlus.createArrayBufferRef(this._buffer,NativeContext.ARRAY_BUFFER_TYPE_CMD,e,NativeContext.ARRAY_BUFFER_REF_REFERENCE);this._nativeObj.setSharedCommandBuffer(t),this._idata[0]=1}_need(e){if(!(this._byteLen-(this._idata[0]<<2)>=e)&&(this._nativeObj.flushCommand(),e>this._byteLen))throw"too big"}get lineJoin(){return""}set lineJoin(e){}get lineCap(){return""}set lineCap(e){}get miterLimit(){return""}set miterLimit(e){}clearRect(e,t,r,a){}set isMain(e){this._nativeObj.flushCommand(),this._nativeObj.isMain=e}get isMain(){return this._nativeObj.flushCommand(),this._nativeObj.isMain}set _targets(e){e&&(this._nativeObj.flushCommand(),this._nativeObj._target=e._nativeObj)}get _targets(){this._nativeObj.flushCommand();let e=this._nativeObj._target;return e?(this._tempRenderTexture2D.width=this._nativeObj.width,this._tempRenderTexture2D.height=this._nativeObj.height,this._tempRenderTexture2D._nativeObj=e,this._tempRenderTexture2D._renderTarget=e._renderTarget,this._tempRenderTexture2D._texture=e._renderTarget._textures[0],this._tempRenderTexture2D):null}alpha(e){this.globalAlpha*=e}flush(){BufferState._curBindedBufferState&&BufferState._curBindedBufferState.unBind(),this._nativeObj.flushCommand(),this._nativeObj.flush()}clear(){this.add_i(Te.CLEAR),this._nativeObj.flushCommand(),this._renderObject3DList.length=0}destroy(e=!1){this._nativeObj.flushCommand(),this._tempRenderTexture2D._nativeObj&&(this._tempRenderTexture2D._nativeObj._deleteRT=e),this._nativeObj.destroy(e)}static set2DRenderConfig(){if(!NativeContext.const2DRenderCMD){const t=NativeContext.const2DRenderCMD=LayaGL.renderEngine.createRenderStateComand();t.addCMD(e.RenderStateType.BlendType,!0),t.addCMD(e.RenderStateType.BlendEquation,e.BlendEquationSeparate.ADD),BlendMode.activeBlendFunction=null,t.addCMD(e.RenderStateType.BlendFunc,[e.BlendFactor.One,e.BlendFactor.OneMinusSourceAlpha]),t.addCMD(e.RenderStateType.DepthTest,!1),t.addCMD(e.RenderStateType.DepthMask,!0),t.addCMD(e.RenderStateType.CullFace,!1),t.addCMD(e.RenderStateType.FrontFace,e.CullMode.Front)}NativeContext.const2DRenderCMD.applyCMD(),RenderTexture.currentActive&&RenderTexture.currentActive._end(),window.set2DRenderConfig(),BufferState._curBindedBufferState&&BufferState._curBindedBufferState.unBind()}set globalCompositeOperation(e){this.add_i_String(Te.SET_GLOBAL_COMPOSITE_OPERTAION,e)}get globalCompositeOperation(){return this._nativeObj.flushCommand(),this._nativeObj.globalCompositeOperation}set fillStyle(e){var t=ColorUtils.create(e);this.add_ii(Te.FILL_STYLE,t.numColor)}get fillStyle(){return this._nativeObj.flushCommand(),this._nativeObj.fillStyle}set globalAlpha(e){this.add_if(Te.ALPHA,e)}get globalAlpha(){return this._nativeObj.flushCommand(),this._nativeObj.globalAlpha}save(){this.add_i(Te.SAVE)}restore(){this.add_i(Te.RESTORE)}saveTransform(e){this.add_i(Te.SAVE)}transformByMatrix(e,t,r){this.add_iffffff(Te.TRANSFORM,e.a,e.b,e.c,e.d,e.tx+t,e.ty+r)}restoreTransform(e){this.add_i(Te.RESTORE)}clipRect(e,t,r,a){this.add_iffff(Te.CLIP_RECT,e,t,r,a)}transform(e,t,r,a,i,s){this.add_iffffff(Te.TRANSFORM,e,t,r,a,i,s)}scale(e,t){this.add_iff(Te.SCALE,e,t)}drawTexture(e,t,r,a,i,s=4294967295){this.checkTexture(e)&&this.add_iiffffffffffffi(Te.DRAW_TEXTURE,e.bitmap._texture.id,t,r,a,i,e.uv[0],e.uv[1],e.uv[2],e.uv[3],e.uv[4],e.uv[5],e.uv[6],e.uv[7],s)}drawTextureWithTransform(e,t,r,a,i,s,n,o,l,h,u,d=4294967295){if(this.checkTexture(e)){this.save(),this.alpha(l);var _=u||e.uv;s?(this.add_iffffff(Te.TRANSFORM,s.a,s.b,s.c,s.d,s.tx+n,s.ty+o),this.add_iiffffffffffffi(Te.DRAW_TEXTURE,e.bitmap._texture.id,t,r,a||e.width,i||e.height,_[0],_[1],_[2],_[3],_[4],_[5],_[6],_[7],d)):this.add_iiffffffffffffi(Te.DRAW_TEXTURE,e.bitmap._texture.id,t+n,r+o,a||e.width,i||e.height,_[0],_[1],_[2],_[3],_[4],_[5],_[6],_[7],d),this.restore()}}drawTextureWithSizeGrid(e,t,r,a,i,s,n,o,l){if(this.checkTexture(e)){var h=e.uv;e.bitmap.width,e.bitmap.height;var u=s[0],d=s[3],_=s[1],c=s[2],p=s[4];this.add_iiffffffffiffffffffffi(Te.DRAW_TEXTURE_SIZE_GRID,e.bitmap._texture.id,t,r,a,i,u,_,c,d,p?1:0,n,o,h[0],h[1],h[2],h[3],h[4],h[5],h[6],h[7],l)}}_drawTextureM(e,t,r,a,i,s,n,o,l){if(this.checkTexture(e)){this.save(),this.alpha(n),s&&this.add_iffffff(Te.TRANSFORM,s.a,s.b,s.c,s.d,s.tx,s.ty);var h=o||e.uv;this.add_iiffffffffffffi(Te.DRAW_TEXTURE,e.bitmap._texture.id,t,r,a||e.width,i||e.height,h[0],h[1],h[2],h[3],h[4],h[5],h[6],h[7],l),this.restore()}}translate(e,t){this.add_iff(Te.TRANSLATE,e,t)}_transform(e,t,r){this.add_iff(Te.TRANSLATE,t,r),this.add_iffffff(Te.TRANSFORM,e.a,e.b,e.c,e.d,e.tx,e.ty),this.add_iff(Te.TRANSLATE,-t,-r)}_rotate(e,t,r){this.add_iff(Te.TRANSLATE,t,r),this.add_if(Te.ROTATE,e),this.add_iff(Te.TRANSLATE,-t,-r)}_scale(e,t,r,a){this.add_iff(Te.TRANSLATE,r,a),this.add_iff(Te.SCALE,e,t),this.add_iff(Te.TRANSLATE,-r,-a)}_drawLine(e,t,r,a,i,s,n,o,l){var h=ColorUtils.create(n);this.add_iffffffif(Te.DRAW_LINE,e,t,r,a,i,s,h.numColor,o)}_drawLines(e,t,r,a,i,s){var n=ColorUtils.create(a);this.add_iffif_ab(Te.DRAW_LINES,e,t,n.numColor,i,new Float32Array(r))}_drawCircle(e,t,r,a,i,s,n){var o=ColorUtils.create(a),l=ColorUtils.create(i);this.add_ifffiiiif(Te.DRAW_CIRCLE,e,t,r,a?1:0,o.numColor,i?1:0,l.numColor,s)}_drawPie(e,t,r,a,i,s,n,o,l){var h=ColorUtils.create(s),u=ColorUtils.create(n);this.add_ifffffiiiif(Te.DRAW_PIE,e,t,r,a,i,s?1:0,h.numColor,n?1:0,u.numColor,o)}_drawPoly(e,t,r,a,i,s,n,o){var l=ColorUtils.create(a),h=ColorUtils.create(i);this.add_iffiiiifi_ab(Te.DRAW_POLY,e,t,a?1:0,l.numColor,i?1:0,h.numColor,s,n?1:0,new Float32Array(r))}fillRect(e,t,r,a,i){if(null!=i){var s=ColorUtils.create(i);this.add_ii(Te.FILL_STYLE,s.numColor)}this.add_i(Te.SAVE),this.add_iffff(Te.FILL_RECT,e,t,r,a),this.add_i(Te.RESTORE)}fillTexture(e,t,r,a,i,s,n,o){if(this.checkTexture(e)){var l=0;switch(s){case"repeat":l=0;break;case"repeat-x":l=1;break;case"repeat-y":l=2;break;case"no-repeat":l=3}this.add_iiffffiffi(Te.FILL_TEXTURE,e.bitmap._texture.id,t,r,a,i,l,n.x,n.y,o)}}drawRect(e,t,r,a,i,s,n){if(null!=i){var o=ColorUtils.create(i);this.add_i(Te.SAVE),this.add_ii(Te.FILL_STYLE,o.numColor),this.add_iffff(Te.FILL_RECT,e,t,r,a),this.add_i(Te.RESTORE)}if(null!=s){var l=ColorUtils.create(s);this.add_i(Te.SAVE),this.add_ii(Te.STROKE_STYLE,l.numColor),this.add_if(Te.LINE_WIDTH,n),this.add_iffff(Te.STROKE_RECT,e,t,r,a),this.add_i(Te.RESTORE)}}_drawPath(e,t,r,a,i){this.add_ii(Te.BEGIN_PATH,0);for(var s=0,n=r.length;s<n;s++){var o=r[s];switch(o[0]){case"moveTo":this.add_iff(Te.MOVE_TO,e+o[1],t+o[2]);break;case"lineTo":this.add_iff(Te.LINE_TO,e+o[1],t+o[2]);break;case"arcTo":this.add_ifffff(Te.ARC_TO,e+o[1],t+o[2],e+o[3],t+o[4],o[5]);break;case"closePath":this.add_i(Te.CLOSE_PATH)}}if(null!=a){var l=ColorUtils.create(a.fillStyle);this.add_ii(Te.FILL_STYLE,l.numColor),this.add_i(Te.FILL)}if(null!=i){var h=ColorUtils.create(i.strokeStyle);this.add_ii(Te.STROKE_STYLE,h.numColor),this.add_if(Te.LINE_WIDTH,i.lineWidth||1),this.add_i(Te.STROKE)}}drawCurves(e,t,r,a,i){var s=ColorUtils.create(a);this.add_iffif_ab(Te.DRAW_CURVES,e,t,s.numColor,i,new Float32Array(r))}drawCanvas(e,t,r,a,i){e&&(this._nativeObj.flushCommand(),e instanceof NativeWebGLCacheAsNormalCanvas?this._nativeObj.drawCanvasNormal(e._nativeObj,t,r,a,i):this._nativeObj.drawCanvasBitmap(e.context._nativeObj,t,r,a,i))}fillText(e,t,r,a,i,s,n=0,o=""){var l=0;switch(s){case"center":l=Const.ENUM_TEXTALIGN_CENTER;break;case"right":l=Const.ENUM_TEXTALIGN_RIGHT}var h=ColorUtils.create(i),u=ColorUtils.create(o);"string"==typeof e?this.add_iiiifff_String_String(Te.FILL_WORDS,h.numColor,u.numColor,l,t,r,n,e,a):this.add_iiffiifi_String(Te.FILL_WORD_TEXT,e._nativeObj.id,t,r,h.numColor,u.numColor,n,l,a)}drawText(e,t,r,a,i,s){var n=0;switch(s){case"center":n=Const.ENUM_TEXTALIGN_CENTER;break;case"right":n=Const.ENUM_TEXTALIGN_RIGHT}var o=ColorUtils.create(i),l=ColorUtils.create(null);"string"==typeof e?this.add_iiiifff_String_String(Te.FILL_WORDS,o.numColor,l.numColor,n,t,r,0,e,a):this.add_iiffiifi_String(Te.FILL_WORD_TEXT,e._nativeObj.id,t,r,o.numColor,l.numColor,0,n,a)}strokeWord(e,t,r,a,i,s,n){var o=0;switch(n){case"center":o=Const.ENUM_TEXTALIGN_CENTER;break;case"right":o=Const.ENUM_TEXTALIGN_RIGHT}var l=ColorUtils.create(i),h=ColorUtils.create(null);"string"==typeof e?this.add_iiiifff_String_String(Te.FILL_WORDS,l.numColor,h.numColor,o,t,r,s,e,a):this.add_iiffiifi_String(Te.FILL_WORD_TEXT,e._nativeObj.id,t,r,l.numColor,h.numColor,s,o,a)}fillBorderText(e,t,r,a,i,s,n,o){var l=0;switch(o){case"center":l=Const.ENUM_TEXTALIGN_CENTER;break;case"right":l=Const.ENUM_TEXTALIGN_RIGHT}var h=ColorUtils.create(i),u=ColorUtils.create(s);"string"==typeof e?this.add_iiiifff_String_String(Te.FILL_WORDS,h.numColor,u.numColor,l,t,r,n,e,a):this.add_iiffiifi_String(Te.FILL_WORD_TEXT,e._nativeObj.id,t,r,h.numColor,u.numColor,n,l,a)}filltext11(e,t,r,a,i,s,n,o){var l=0;switch(o){case"center":l=Const.ENUM_TEXTALIGN_CENTER;break;case"right":l=Const.ENUM_TEXTALIGN_RIGHT}var h=ColorUtils.create(i),u=ColorUtils.create(s);"string"==typeof e?this.add_iiiifff_String_String(Te.FILL_WORDS,h.numColor,u.numColor,l,t,r,n,e,a):this.add_iiffiifi_String(Te.FILL_WORD_TEXT,e._nativeObj.id,t,r,h.numColor,u.numColor,n,l,a)}_fast_filltext(e,t,r,a,i,s,n,o,l=0){var h=ColorUtils.create(i),u=ColorUtils.create(s);"string"==typeof e?this.add_iiiifff_String_String(Te.FILL_WORDS,h.numColor,u.numColor,o,t,r,n,e,a._font):this.add_iiffiifi_String(Te.FILL_WORD_TEXT,e._nativeObj.id,t,r,h.numColor,u.numColor,n,o,a._font)}drawTriangles(e,t,r,a,i,s,n,o,l,h=4294967295){if(this.checkTexture(e)){var u=n||this._tmpMatrix;null!=l?(this.add_i(Te.SAVE),this.add_i_String(Te.SET_GLOBAL_COMPOSITE_OPERTAION,l),this.add_iiifffffffff_ab_ab_ab(Te.DRAW_TRANGLES,e.bitmap._texture.id,h,t,r,o,u.a,u.b,u.c,u.d,u.tx,u.ty,a instanceof Array?Float32Array.from(a):a,i instanceof Array?Float32Array.from(i):i,s instanceof Array?Uint16Array.from(s):s),this.add_i(Te.RESTORE)):this.add_iiifffffffff_ab_ab_ab(Te.DRAW_TRANGLES,e.bitmap._texture.id,h,t,r,o,u.a,u.b,u.c,u.d,u.tx,u.ty,a instanceof Array?Float32Array.from(a):a,i instanceof Array?Float32Array.from(i):i,s instanceof Array?Uint16Array.from(s):s)}}drawMask(e,t){return this._nativeObj.flushCommand(),this._nativeObj.drawMask(e,t)}drawMasked(e,t,r,a){this.add_iffff(Te.DRAW_MASKED,e,t,r,a)}drawMaskComposite(e,t,r,a,i){this._nativeObj.flushCommand(),this._nativeObj.drawMaskComposite(e,t,r,a,i)}set asBitmap(e){this.add_ii(Te.SET_AS_BITMAP,e?1:0)}size(e,t){this.add_iii(Te.SIZE,e,t)}setColorFilter(e){this._nativeObj.flushCommand(),e?this._nativeObj.setColorFilter(!0,e._alpha,e._mat):this._nativeObj.setColorFilter(!1,null,null)}drawTarget(e,t,r,a,i,s,n,o=null,l=-1){return this._nativeObj.flushCommand(),this._nativeObj.drawTarget(e,t,r,a,i,s.a,s.b,s.c,s.d,s.tx,s.ty,l)}drawTargetBlurFilter(e,t,r,a,i,s){this._nativeObj.flushCommand(),this._nativeObj.drawTargetBlurFilter(e,t,r,a,i,s)}get _curMat(){this._nativeObj.flushCommand();var e=this._nativeObj._curMat,t=Matrix.create();return t.a=e[0],t.b=e[1],t.c=e[2],t.d=e[3],t.tx=e[4],t.ty=e[5],t}addRenderObject3D(e){this._renderObject3DList.push(e._nativeObj),this._nativeObj.flushCommand(),this._nativeObj.addRenderObject3D(e._nativeObj)}pushRT(){this._nativeObj.flushCommand(),this._nativeObj.pushRT()}popRT(){this._nativeObj.flushCommand(),this._nativeObj.popRT()}useRT(e){this._nativeObj.flushCommand(),this._nativeObj.useRT(e)}drawFilter(e,t,r,a,i,s){this._nativeObj.flushCommand(),this._nativeObj.drawFilter(e,t,r,a,i,s)}checkTexture(e){var t=this.sprite;return!!e._getSource((function(){t&&t.repaint()}))}add_i(e){this._need(4),this._idata[this._idata[0]++]=e}add_ii(e,t){this._need(8);var r=this._idata[0];this._idata[r++]=e,this._idata[r++]=t,this._idata[0]=r}add_if(e,t){this._need(8);var r=this._idata[0];this._idata[r++]=e,this._fdata[r++]=t,this._idata[0]=r}add_iff(e,t,r){this._need(12);var a=this._idata[0];this._idata[a++]=e,this._fdata[a++]=t,this._fdata[a++]=r,this._idata[0]=a}add_iffif(e,t,r,a,i){this._need(20);var s=this._idata[0],n=this._fdata;this._idata[s++]=e,n[s++]=t,n[s++]=r,this._idata[s++]=a,n[s++]=i,this._idata[0]=s}add_iffff(e,t,r,a,i){this._need(20);var s=this._idata[0],n=this._fdata;this._idata[s++]=e,n[s++]=t,n[s++]=r,n[s++]=a,n[s++]=i,this._idata[0]=s}add_iii(e,t,r){this._need(12);var a=this._idata,i=this._idata[0];a[i++]=e,a[i++]=t,a[i++]=r,this._idata[0]=i}add_iiffff(e,t,r,a,i,s){this._need(24);var n=this._idata[0],o=this._fdata;this._idata[n++]=e,this._idata[n++]=t,o[n++]=r,o[n++]=a,o[n++]=i,o[n++]=s,this._idata[0]=n}add_ifffff(e,t,r,a,i,s){this._need(24);var n=this._idata[0],o=this._fdata;this._idata[n++]=e,o[n++]=t,o[n++]=r,o[n++]=a,o[n++]=i,o[n++]=s,this._idata[0]=n}add_iffffff(e,t,r,a,i,s,n){this._need(28);var o=this._idata[0],l=this._fdata;this._idata[o++]=e,l[o++]=t,l[o++]=r,l[o++]=a,l[o++]=i,l[o++]=s,l[o++]=n,this._idata[0]=o}add_ifffiiiif(e,t,r,a,i,s,n,o,l){this._need(36);var h=this._idata,u=h[0],d=this._fdata;h[u++]=e,d[u++]=t,d[u++]=r,d[u++]=a,h[u++]=i,h[u++]=s,h[u++]=n,h[u++]=o,d[u++]=l,h[0]=u}add_ifffffiiiif(e,t,r,a,i,s,n,o,l,h,u){this._need(44);var d=this._idata,_=d[0],c=this._fdata;d[_++]=e,c[_++]=t,c[_++]=r,c[_++]=a,c[_++]=i,c[_++]=s,d[_++]=n,d[_++]=o,d[_++]=l,d[_++]=h,c[_++]=u,d[0]=_}add_iffffffif(e,t,r,a,i,s,n,o,l){this._need(36);var h=this._idata,u=h[0],d=this._fdata;h[u++]=e,d[u++]=t,d[u++]=r,d[u++]=a,d[u++]=i,d[u++]=s,d[u++]=n,h[u++]=o,d[u++]=l,h[0]=u}add_String(e){var t=e.byteLength;if(this._need(t+4),this._idata[this._idata[0]++]=t,0!=t){var r=new Uint8Array(e);this._byteArray.set(r,4*this._idata[0]),this._idata[0]+=t/4}}add_iffiiiifi(e,t,r,a,i,s,n,o,l){this._need(45);var h=this._idata[0],u=this._fdata;this._idata[h++]=e,u[h++]=t,u[h++]=r,this._idata[h++]=a,this._idata[h++]=i,this._idata[h++]=s,this._idata[h++]=n,u[h++]=o,this._idata[h++]=l,this._idata[0]=h}add_iiffiifi(e,t,r,a,i,s,n,o){this._need(32);var l=this._idata[0],h=this._fdata;this._idata[l++]=e,this._idata[l++]=t,h[l++]=r,h[l++]=a,this._idata[l++]=i,this._idata[l++]=s,h[l++]=n,this._idata[l++]=o,this._idata[0]=l}add_i_String(e,t){var r=window.conch.strTobufer(t);this._need(4+r.byteLength+4),this.add_i(e),this.add_String(r)}add_iiiifff(e,t,r,a,i,s,n){this._need(28);var o=this._idata[0],l=this._fdata;this._idata[o++]=e,this._idata[o++]=t,this._idata[o++]=r,this._idata[o++]=a,l[o++]=i,l[o++]=s,l[o++]=n,this._idata[0]=o}add_iiffiifi_String(e,t,r,a,i,s,n,o,l){var h=window.conch.strTobufer(l);this._need(32+h.byteLength+4),this.add_iiffiifi(e,t,r,a,i,s,n,o),this.add_String(h)}add_iiiifff_String_String(e,t,r,a,i,s,n,o,l){var h=window.conch.strTobufer(o),u=window.conch.strTobufer(l);this._need(28+(h.byteLength+4)+(u.byteLength+4)),this.add_iiiifff(e,t,r,a,i,s,n),this.add_String(h),this.add_String(u)}add_iiffffffffffffi(e,t,r,a,i,s,n,o,l,h,u,d,_,c,p){this._need(60);var m=this._idata,f=m[0],g=this._fdata;m[f++]=e,m[f++]=t,g[f++]=r,g[f++]=a,g[f++]=i,g[f++]=s,g[f++]=n,g[f++]=o,g[f++]=l,g[f++]=h,g[f++]=u,g[f++]=d,g[f++]=_,g[f++]=c,m[f++]=p,m[0]=f}add_iiffffffffiffffffffffi(e,t,r,a,i,s,n,o,l,h,u,d,_,c,p,m,f,g,T,S,x,y){this._need(88);var E=this._idata,R=this._fdata,b=E[0];E[b++]=e,E[b++]=t,R[b++]=r,R[b++]=a,R[b++]=i,R[b++]=s,R[b++]=n,R[b++]=o,R[b++]=l,R[b++]=h,E[b++]=u,R[b++]=d,R[b++]=_,R[b++]=c,R[b++]=p,R[b++]=m,R[b++]=f,R[b++]=g,R[b++]=T,R[b++]=S,R[b++]=x,E[b++]=y,E[0]=b}add_iiifffffffff(e,t,r,a,i,s,n,o,l,h,u,d){this._need(48);var _=this._idata,c=this._fdata,p=_[0];_[p++]=e,_[p++]=t,_[p++]=r,c[p++]=a,c[p++]=i,c[p++]=s,c[p++]=n,c[p++]=o,c[p++]=l,c[p++]=h,c[p++]=u,c[p++]=d,_[0]=p}add_iiffffiffi(e,t,r,a,i,s,n,o,l,h){this._need(40);let u=this._idata,d=this._fdata;var _=u[0];u[_++]=e,u[_++]=t,d[_++]=r,d[_++]=a,d[_++]=i,d[_++]=s,u[_++]=n,d[_++]=o,d[_++]=l,u[_++]=h,u[0]=_}add_iiifffffffff_ab_ab_ab(e,t,r,a,i,s,n,o,l,h,u,d,_,c,p){var m=this.getAlignLength(_),f=this.getAlignLength(c),g=this.getAlignLength(p);this._need(48+(m+4)+(f+4)+(g+4)),this.add_iiifffffffff(e,t,r,a,i,s,n,o,l,h,u,d),this.wab(_,_.byteLength,m,0),this.wab(c,c.byteLength,f,0),this.wab(p,p.byteLength,g,0)}wab(e,t,r,a){a=a||0,this._need(r+4),this._idata[this._idata[0]++]=t;var i=null;if(e instanceof Float32Array&&0==a)this._fdata.set(e,this._idata[0]);else{if(e instanceof ArrayBuffer)i=new Uint8Array(e,a,t);else{if(!e.buffer)return void console.log("not arraybuffer/dataview");i=new Uint8Array(e.buffer,a+e.byteOffset,t)}this._byteArray.set(i,4*this._idata[0])}this._idata[0]+=r/4}getAlignLength(e){return e.byteLength+3&4294967292}add_iif_ab(e,t,r,a){var i=this.getAlignLength(a);this._need(12+i+4),this.add_iff(e,t,r),this.wab(a,a.byteLength,i,0)}add_iffif_ab(e,t,r,a,i,s){var n=this.getAlignLength(s);this._need(20+n+4),this.add_iffif(e,t,r,a,i),this.wab(s,s.byteLength,n,0)}add_iffiiiifi_ab(e,t,r,a,i,s,n,o,l,h){var u=this.getAlignLength(h);this._need(45+u+4),this.add_iffiiiifi(e,t,r,a,i,s,n,o,l),this.wab(h,h.byteLength,u,0)}}NativeContext.ARRAY_BUFFER_TYPE_DATA=0,NativeContext.ARRAY_BUFFER_TYPE_CMD=1,NativeContext.ARRAY_BUFFER_REF_REFERENCE=0,NativeContext.ARRAY_BUFFER_REF_COPY=1,NativeContext.ENUM_TEXTALIGN_DEFAULT=0,NativeContext.ENUM_TEXTALIGN_CENTER=1,NativeContext.ENUM_TEXTALIGN_RIGHT=2;const Se=new Matrix(Const.MAX_CLIP_SIZE,0,0,Const.MAX_CLIP_SIZE,0,0);class Context{static __init__(){Context.MAXCLIPRECT=new Rectangle(0,0,Const.MAX_CLIP_SIZE,Const.MAX_CLIP_SIZE),ContextParams.DEFAULT=new ContextParams}drawImage(...e){}getImageData(...e){}measureText(e){return null}setTransform(...e){}$transform(e,t,r,a,i,s){}set material(e){this._shader2D.material=e}get material(){return this._shader2D.material}get lineJoin(){return""}set lineJoin(e){}get lineCap(){return""}set lineCap(e){}get miterLimit(){return""}set miterLimit(e){}clearRect(e,t,r,a){}_drawRect(e,t,r,a,i){i&&(this.fillStyle=i),this.fillRect(e,t,r,a,null)}drawTexture2(e,t,r,a,i,s){}transformByMatrix(e,t,r){this.transform(e.a,e.b,e.c,e.d,e.tx+t,e.ty+r)}saveTransform(e){this.save()}restoreTransform(e){this.restore()}drawRect(e,t,r,a,i,s,n){var o=this;null!=i&&(o.fillStyle=i,o.fillRect(e,t,r,a)),null!=s&&(o.strokeStyle=s,o.lineWidth=n,o.strokeRect(e,t,r,a))}alpha(e){this.globalAlpha*=e}_transform(e,t,r){this.translate(t,r),this.transform(e.a,e.b,e.c,e.d,e.tx,e.ty),this.translate(-t,-r)}_rotate(e,t,r){this.translate(t,r),this.rotate(e),this.translate(-t,-r)}_scale(e,t,r,a){this.translate(r,a),this.scale(e,t),this.translate(-r,-a)}_drawLine(e,t,r,a,i,s,n,o,l){this.beginPath(),this.strokeStyle=n,this.lineWidth=o,this.moveTo(e+r,t+a),this.lineTo(e+i,t+s),this.stroke()}_drawLines(e,t,r,a,i,s){this.beginPath(),this.strokeStyle=a,this.lineWidth=i,this.addPath(r.slice(),!1,!1,e,t),this.stroke()}drawCurves(e,t,r,a,i){this.beginPath(),this.strokeStyle=a,this.lineWidth=i,this.moveTo(e+r[0],t+r[1]);for(var s=2,n=r.length;s<n;)this.quadraticCurveTo(e+r[s++],t+r[s++],e+r[s++],t+r[s++]);this.stroke()}_fillAndStroke(e,t,r,a=!1){null!=e&&(this.fillStyle=e,this.fill()),null!=t&&r>0&&(this.strokeStyle=t,this.lineWidth=r,this.stroke())}_drawCircle(e,t,r,a,i,s,n){this.beginPath(!0),this.arc(e,t,r,r,0,Context.PI2,!1,!0,40),this.closePath(),this._fillAndStroke(a,i,s)}_drawEllipse(e,t,r,a,i,s,n){this.beginPath(!0),this.arc(e,t,r,a,0,Context.PI2,!1,!0,40),this.closePath(),this._fillAndStroke(i,s,n)}_drawRoundRect(e,t,r,a,i,s,n,o,l,h,u){this.beginPath(!0);var d=this._getPath();0>=i?d.addPoint(e,t):this.arc(e+i,t+i,i,i,Math.PI,Math.PI+Context.HPI);let _=e+r-s;0>=s?d.addPoint(_,t):this.arc(_,t+s,s,s,Math.PI+Context.HPI,Context.PI2),_=e+r-o;let c=t+a-o;0>=o?d.addPoint(_,c):this.arc(_,c,o,o,0,Context.HPI),_=e+n,c=t+a-n,0>=n?d.addPoint(_,c):this.arc(_,c,n,n,Math.PI-Context.HPI,Math.PI),d.addPoint(e,t+i),this.closePath(),this._fillAndStroke(l,h,u)}_drawPie(e,t,r,a,i,s,n,o,l){this.beginPath(),this.moveTo(e,t),this.arc(e,t,r,r,a,i),this.closePath(),this._fillAndStroke(s,n,o)}_drawPoly(e,t,r,a,i,s,n,o){this.beginPath(),this.addPath(r.slice(),!0,n,e,t),this.closePath(),this._fillAndStroke(a,i,s,n)}_drawPath(e,t,r,a,i){this.beginPath();for(var s=0,n=r.length;s<n;s++){var o=r[s];switch(o[0]){case"moveTo":this.moveTo(e+o[1],t+o[2]);break;case"lineTo":this.lineTo(e+o[1],t+o[2]);break;case"arcTo":this.arcTo(e+o[1],t+o[2],e+o[3],t+o[4],o[5]);break;case"closePath":this.closePath()}}null!=a&&(this.fillStyle=a.fillStyle,this.fill()),null!=i&&(this.strokeStyle=i.strokeStyle,this.lineWidth=i.lineWidth||1,this.lineJoin=i.lineJoin,this.lineCap=i.lineCap,this.miterLimit=i.miterLimit,this.stroke())}static set2DRenderConfig(){if(!Context.const2DRenderCMD){const t=Context.const2DRenderCMD=LayaGL.renderEngine.createRenderStateComand();t&&(t.addCMD(e.RenderStateType.BlendType,!0),t.addCMD(e.RenderStateType.BlendEquation,e.BlendEquationSeparate.ADD),BlendMode.activeBlendFunction=null,t.addCMD(e.RenderStateType.BlendFunc,[e.BlendFactor.One,e.BlendFactor.OneMinusSourceAlpha]),t.addCMD(e.RenderStateType.DepthTest,!1),t.addCMD(e.RenderStateType.DepthMask,!0),t.addCMD(e.RenderStateType.CullFace,!1),t.addCMD(e.RenderStateType.FrontFace,e.CullMode.Front))}Context.const2DRenderCMD&&Context.const2DRenderCMD.applyCMD(),RenderTexture.currentActive&&RenderTexture.currentActive._end(),RenderTexture2D.currentActive&&RenderTexture2D.currentActive.end(),LayaGL.renderEngine.viewport(0,0,RenderState2D.width,RenderState2D.height),LayaGL.renderEngine.scissorTest(!0),LayaGL.renderEngine.scissor(0,0,RenderState2D.width,RenderState2D.height)}constructor(){if(this._tmpMatrix=new Matrix,this._drawTexToDrawTri_Vert=new Float32Array(8),this._drawTexToDrawTri_Index=new Uint16Array([0,1,2,0,2,3]),this._tempUV=new Float32Array(8),this._drawTriUseAbsMatrix=!1,this._id=++Context._COUNT,this._other=null,this._renderNextSubmitIndex=0,this._path=null,this._drawCount=1,this._width=Const.MAX_CLIP_SIZE,this._height=Const.MAX_CLIP_SIZE,this._renderCount=0,this._submits=null,this._curSubmit=null,this._submitKey=new SubmitKey,this._pathMesh=null,this._triangleMesh=null,this.meshlist=[],this._transedPoints=new Array(8),this._temp4Points=new Array(8),this._clipRect=Context.MAXCLIPRECT,this._globalClipMatrix=Se.clone(),this._clipInCache=!1,this._clipInfoID=0,this._clipID_Gen=0,this._lastMatScaleX=1,this._lastMatScaleY=1,this._lastMat_a=1,this._lastMat_b=0,this._lastMat_c=0,this._lastMat_d=1,this._nBlendType=0,this._save=null,this._targets=null,this._charSubmitCache=null,this._saveMark=null,this._shader2D=new Shader2D,this.sprite=null,this._italicDeg=0,this._lastTex=null,this._fillColor=0,this._flushCnt=0,this.defTexture=null,this._colorFiler=null,this.drawTexAlign=!1,this._incache=!1,this.isMain=!1,this.clearColor=new Color,Context._contextcount++,Context._textRender=Context._textRender||new TextRender,!this.defTexture){var t=new Texture2D(2,2,e.TextureFormat.R8G8B8A8,!0,!1,!1);t.setPixelsData(new Uint8Array(16),!1,!1),t.lock=!0,this.defTexture=new Texture(t)}this._lastTex=this.defTexture,this.clear()}clearBG(t,r,a,i){this.clearColor.r=t,this.clearColor.g=r,this.clearColor.b=a,this.clearColor.a=i,LayaGL.renderEngine.clearRenderTexture(e.RenderClearFlag.Color,this.clearColor,1)}_getSubmits(){return this._submits}_releaseMem(e=!1){if(this._submits){this._curMat&&this._curMat.destroy(),this._curMat=null,this._shader2D.destroy(),this._shader2D=null,this._charSubmitCache.clear();for(var t=0,r=this._submits._length;t<r;t++)this._submits[t].releaseRender();var a;for(this._submits.length=0,this._submits._length=0,this._submits=null,this._curSubmit=SubmitBase.RENDERBASE,this._path=null,this._save=null,t=0,a=this.meshlist.length;t<a;t++){this.meshlist[t].destroy()}this.meshlist.length=0,this.sprite=null,e||(this._targets&&this._targets.destroy(),this._targets=null)}}destroy(e=!1){--Context._contextcount,this.sprite=null,this._releaseMem(e),this._charSubmitCache&&this._charSubmitCache.destroy(),this._mesh.destroy(),e||(this._targets&&this._targets.destroy(),this._targets=null),this.defTexture&&(this.defTexture.bitmap&&this.defTexture.bitmap.destroy(),this.defTexture.destroy())}clear(){this._submits||(this._other=ContextParams.DEFAULT,this._curMat=Matrix.create(),this._charSubmitCache=new CharSubmitCache,this._mesh=MeshQuadTexture.getAMesh(this.isMain),this.meshlist.push(this._mesh),this._pathMesh=MeshVG.getAMesh(this.isMain),this.meshlist.push(this._pathMesh),this._triangleMesh=MeshTexture.getAMesh(this.isMain),this.meshlist.push(this._triangleMesh),this._submits=[],this._save=[SaveMark.Create(this)],this._save.length=10,this._shader2D=new Shader2D),this._submitKey.clear(),this._mesh.clearVB(),this._drawCount=1,this._other=ContextParams.DEFAULT,this._other.lineWidth=this._shader2D.ALPHA=1,this._nBlendType=0,this._clipRect=Context.MAXCLIPRECT,this._curSubmit=SubmitBase.RENDERBASE,SubmitBase.RENDERBASE._ref=16777215,SubmitBase.RENDERBASE._numEle=0,this._shader2D.fillStyle=this._shader2D.strokeStyle=DrawStyle.DEFAULT;for(let e=0,t=this._submits._length;e<t;e++)this._submits[e].releaseRender();this._submits._length=0,this._curMat.identity(),this._other.clear(),this._saveMark=this._save[0],this._save._length=1}size(t,r){this._width==t&&this._height==r||(this._width=t,this._height=r,this._targets&&(this._targets.destroy(),this._targets=new RenderTexture2D(t,r,e.RenderTargetFormat.R8G8B8A8,-1)),this.isMain&&(LayaGL.renderEngine.viewport(0,0,t,r),LayaGL.renderEngine.scissor(0,0,t,r),RenderState2D.width=t,RenderState2D.height=r)),0===t&&0===r&&this._releaseMem()}set asBitmap(t){if(t){let t=this._targets;if(!this._width||!this._height)throw Error("asBitmap no size!");t&&t.width==this._width&&t.height==this._height||(t&&t.destroy(),this._targets=new RenderTexture2D(this._width,this._height,e.RenderTargetFormat.R8G8B8A8))}else this._targets&&this._targets.destroy(),this._targets=null}getMatScaleX(){return this._lastMat_a==this._curMat.a&&this._lastMat_b==this._curMat.b||(this._lastMatScaleX=this._curMat.getScaleX(),this._lastMat_a=this._curMat.a,this._lastMat_b=this._curMat.b),this._lastMatScaleX}getMatScaleY(){return this._lastMat_c==this._curMat.c&&this._lastMat_d==this._curMat.d||(this._lastMatScaleY=this._curMat.getScaleY(),this._lastMat_c=this._curMat.c,this._lastMat_d=this._curMat.d),this._lastMatScaleY}getFillColor(){return this._fillColor}set fillStyle(e){this._shader2D.fillStyle.equal(e)||(SaveBase.save(this,SaveBase.TYPE_FILESTYLE,this._shader2D,!1),this._shader2D.fillStyle=DrawStyle.create(e),this._submitKey.other=-this._shader2D.fillStyle.toInt())}get fillStyle(){return this._shader2D.fillStyle}set globalAlpha(e){(e=Math.floor(1e3*e)/1e3)!=this._shader2D.ALPHA&&(SaveBase.save(this,SaveBase.TYPE_ALPHA,this._shader2D,!1),this._shader2D.ALPHA=e)}get globalAlpha(){return this._shader2D.ALPHA}set textAlign(e){this._other.textAlign===e||(this._other=this._other.make(),SaveBase.save(this,SaveBase.TYPE_TEXTALIGN,this._other,!1),this._other.textAlign=e)}get textAlign(){return this._other.textAlign}set textBaseline(e){this._other.textBaseline===e||(this._other=this._other.make(),SaveBase.save(this,SaveBase.TYPE_TEXTBASELINE,this._other,!1),this._other.textBaseline=e)}get textBaseline(){return this._other.textBaseline}set globalCompositeOperation(e){var t=BlendMode.TOINT[e];null==t||this._nBlendType===t||(SaveBase.save(this,SaveBase.TYPE_GLOBALCOMPOSITEOPERATION,this,!0),this._curSubmit=SubmitBase.RENDERBASE,this._nBlendType=t)}get globalCompositeOperation(){return BlendMode.NAMES[this._nBlendType]}set strokeStyle(e){this._shader2D.strokeStyle.equal(e)||(SaveBase.save(this,SaveBase.TYPE_STROKESTYLE,this._shader2D,!1),this._shader2D.strokeStyle=DrawStyle.create(e),this._submitKey.other=-this._shader2D.strokeStyle.toInt())}get strokeStyle(){return this._shader2D.strokeStyle}translate(e,t){0===e&&0===t||(SaveTranslate.save(this),this._curMat._bTransform?(SaveTransform.save(this),this._curMat.tx+=e*this._curMat.a+t*this._curMat.c,this._curMat.ty+=e*this._curMat.b+t*this._curMat.d):(this._curMat.tx=e,this._curMat.ty=t))}set lineWidth(e){this._other.lineWidth===e||(this._other=this._other.make(),SaveBase.save(this,SaveBase.TYPE_LINEWIDTH,this._other,!1),this._other.lineWidth=e)}get lineWidth(){return this._other.lineWidth}save(){this._save[this._save._length++]=SaveMark.Create(this)}restore(){var e=this._save._length,t=this._nBlendType;if(!(e<1)){for(var r=e-1;r>=0;r--){var a=this._save[r];if(a.restore(this),a.isSaveMark())return void(this._save._length=r)}t!=this._nBlendType&&(this._curSubmit=SubmitBase.RENDERBASE)}}set font(e){this._other=this._other.make(),SaveBase.save(this,SaveBase.TYPE_FONT,this._other,!1)}fillText(e,t,r,a,i,s,n=0,o=""){Context._textRender.filltext(this,e,t,r,a,i,o,n,s)}drawText(e,t,r,a,i,s){Context._textRender.filltext(this,e,t,r,a,i,null,0,s)}strokeWord(e,t,r,a,i,s,n){Context._textRender.filltext(this,e,t,r,a,null,i,s,n)}fillBorderText(e,t,r,a,i,s,n,o){Context._textRender.filltext(this,e,t,r,a,i,s,n,o)}_fast_filltext(e,t,r,a,i,s,n,o){Context._textRender._fast_filltext(this,e,t,r,a,i,s,n,o)}filltext11(e,t,r,a,i,s,n,o){Context._textRender.filltext(this,e,t,r,a,i,s,n,o)}_fillRect(t,r,a,i,s){var n=this._curSubmit,o=n._key.submitType===SubmitBase.KEY_DRAWTEXTURE&&n._key.blendShader===this._nBlendType&&this.isSameClipInfo(n)&&this._curSubmit.material==this.material;this._mesh.vertNum+4>Context._MAXVERTNUM&&(this._mesh=MeshQuadTexture.getAMesh(this.isMain),this.meshlist.push(this._mesh),o=!1),this.transformQuad(t,r,a,i,0,this._curMat,this._transedPoints),this.clipedOff(this._transedPoints)||(this._mesh.addQuad(this._transedPoints,Texture.NO_UV,s,!1),o||(n=this._curSubmit=SubmitTexture.create(this,this._mesh,Value2D.create(e.RenderSpriteData.Texture2D)),this._submits[this._submits._length++]=n,this._copyClipInfo(n,this._globalClipMatrix),!this._lastTex||this._lastTex.destroyed?n.shaderValue.textureHost=this.defTexture:n.shaderValue.textureHost=this._lastTex,n._key.other=this._lastTex&&this._lastTex.bitmap?this._lastTex.bitmap.id:-1,n._renderType=SubmitBase.TYPE_TEXTURE),this._curSubmit._numEle+=6,this._mesh.indexNum+=6,this._mesh.vertNum+=4)}fillRect(e,t,r,a,i){var s=i?DrawStyle.create(i):this._shader2D.fillStyle,n=this.mixRGBandAlpha(s.toInt());this._fillRect(e,t,r,a,n)}fillTexture(e,t,r,a,i,s,n,o){e._getSource()?this._fillTexture(e,e.width,e.height,e.uvrect,t,r,a,i,s,n.x,n.y,o):this.sprite&&ILaya.systemTimer.callLater(this,this._repaintSprite)}_fillTexture(t,r,a,i,s,n,o,l,h,u,d,_){var c=this._curSubmit;this._mesh.vertNum+4>Context._MAXVERTNUM&&(this._mesh=MeshQuadTexture.getAMesh(this.isMain),this.meshlist.push(this._mesh));var p=!0,m=!0;switch(h){case"repeat":break;case"repeat-x":m=!1;break;case"repeat-y":p=!1;break;case"no-repeat":p=m=!1}var f=this._temp4Points,g=0,T=0,S=0,x=0,y=0,E=0;if(u<0?(S=s,g=-u%r/r):S=s+u,d<0?(x=n,T=-d%a/a):x=n+d,y=s+o,E=n+l,!p&&(y=Math.min(y,s+u+r)),!m&&(E=Math.min(E,n+d+a)),!(y<s||E<n||S>y||x>E)){var R=(y-s-u)/r,b=(E-n-d)/a;if(this.transformQuad(S,x,y-S,E-x,0,this._curMat,this._transedPoints),f[0]=g,f[1]=T,f[2]=R,f[3]=T,f[4]=R,f[5]=b,f[6]=g,f[7]=b,!this.clipedOff(this._transedPoints)){var C=this._mixRGBandAlpha(_,this._shader2D.ALPHA);this._mesh.addQuad(this._transedPoints,f,C,!0);var v=Value2D.create(e.RenderSpriteData.Texture2D);v.defines.addDefine(ShaderDefines2D.FILLTEXTURE);var D=i.concat();Vector4.tempVec4.setValue(D[0],D[1],D[2],D[3]),v.u_TexRange=Vector4.tempVec4,c=this._curSubmit=SubmitTexture.create(this,this._mesh,v),this._submits[this._submits._length++]=c,this._copyClipInfo(c,this._globalClipMatrix),c.shaderValue.textureHost=t,c._renderType=SubmitBase.TYPE_TEXTURE,this._curSubmit._numEle+=6,this._mesh.indexNum+=6,this._mesh.vertNum+=4}this.breakNextMerge()}}setColorFilter(e){SaveBase.save(this,SaveBase.TYPE_COLORFILTER,this,!0),this._colorFiler=e,this._curSubmit=SubmitBase.RENDERBASE}drawTexture(e,t,r,a,i,s=4294967295){this._drawTextureM(e,t,r,a,i,null,1,null,s)}drawTextures(e,t,r,a,i){if(e._getSource())for(var s=t.length/2,n=0,o=e.bitmap.id,l=0;l<s;l++){const s="number"==typeof i[l]?i[l]:4294967295;this._inner_drawTexture(e,o,t[n++]+r,t[n++]+a,0,0,null,null,1,!1,s)}else this.sprite&&ILaya.systemTimer.callLater(this,this._repaintSprite)}_drawTextureM(e,t,r,a,i,s,n,o,l){var h=this.sprite;return!!e._getSource((function(){h&&h.repaint()}))&&this._inner_drawTexture(e,e.bitmap.id,t,r,a,i,s,o,n,!1,l)}_drawRenderTexture(e,t,r,a,i,s,n,o,l=4294967295){return this._inner_drawTexture(e,-1,t,r,a,i,s,o,n,!1,l)}submitDebugger(){this._submits[this._submits._length++]=SubmitCMD.create([],(function(){}),this)}_copyClipInfo(e,t){var r=e.shaderValue.clipMatDir;r.x=t.a,r.y=t.b,r.z=t.c,r.w=t.d,e.shaderValue.clipMatDir=r;var a=e.shaderValue.clipMatPos;a.x=t.tx,a.y=t.ty,e.shaderValue.clipMatPos=a,e.clipInfoID=this._clipInfoID,this._clipInCache&&(e.shaderValue.clipOff.x=1,e.shaderValue.clipOff=e.shaderValue.clipOff)}isSameClipInfo(e){return e.clipInfoID===this._clipInfoID}_useNewTex2DSubmit(t,r){this._mesh.vertNum+r>Context._MAXVERTNUM&&(this._mesh=MeshQuadTexture.getAMesh(this.isMain),this.meshlist.push(this._mesh));var a=SubmitTexture.create(this,this._mesh,Value2D.create(e.RenderSpriteData.Texture2D));this._submits[this._submits._length++]=this._curSubmit=a,a.shaderValue.textureHost=t,this._copyClipInfo(a,this._globalClipMatrix)}_drawTexRect(e,t,r,a,i){this.transformQuad(e,t,r,a,this._italicDeg,this._curMat,this._transedPoints);var s=this._transedPoints;s[0]=s[0]+.5|0,s[1]=s[1]+.5|0,s[2]=s[2]+.5|0,s[3]=s[3]+.5|0,s[4]=s[4]+.5|0,s[5]=s[5]+.5|0,s[6]=s[6]+.5|0,s[7]=s[7]+.5|0,this.clipedOff(this._transedPoints)||(this._mesh.addQuad(this._transedPoints,i,this._fillColor,!0),this._curSubmit._numEle+=6,this._mesh.indexNum+=6,this._mesh.vertNum+=4)}drawCallOptimize(e){return this._charSubmitCache.enable(e,this),e}_inner_drawTexture(t,r,a,i,s,n,o,l,h,u,d){if(s<=0||n<=0)return!1;var _=this._curSubmit._key;if(l=l||t._uv,_.submitType===SubmitBase.KEY_TRIANGLES&&_.other===r){var c=this._drawTexToDrawTri_Vert;c[0]=a,c[1]=i,c[2]=a+s,c[3]=i,c[4]=a+s,c[5]=i+n,c[6]=a,c[7]=i+n,this._drawTriUseAbsMatrix=!0;var p=this._tempUV;return p[0]=l[0],p[1]=l[1],p[2]=l[2],p[3]=l[3],p[4]=l[4],p[5]=l[5],p[6]=l[6],p[7]=l[7],this.drawTriangles(t,0,0,c,p,this._drawTexToDrawTri_Index,o||this._curMat,h,null,null),this._drawTriUseAbsMatrix=!1,!0}var m=this._mesh,f=this._curSubmit,g=u?this._charSubmitCache.getPos():this._transedPoints;if(this.transformQuad(a,i,s||t.width,n||t.height,this._italicDeg,o||this._curMat,g),this.drawTexAlign){var T=Math.round;g[0]=T(g[0]),g[1]=T(g[1]),g[2]=T(g[2]),g[3]=T(g[3]),g[4]=T(g[4]),g[5]=T(g[5]),g[6]=T(g[6]),g[7]=T(g[7]),this.drawTexAlign=!1}var S=this._mixRGBandAlpha(d,this._shader2D.ALPHA*h);if(u)return this._charSubmitCache.add(this,t,r,g,l,S),!0;this._drawCount++;var x=r>=0&&_.submitType===SubmitBase.KEY_DRAWTEXTURE&&_.other===r&&this.isSameClipInfo(f)&&this._curSubmit.material==this.material;return this._lastTex=t,m.vertNum+4>Context._MAXVERTNUM&&(m=this._mesh=MeshQuadTexture.getAMesh(this.isMain),this.meshlist.push(m),x=!1),m.addQuad(g,l,S,!0),x||(this._submits[this._submits._length++]=this._curSubmit=f=SubmitTexture.create(this,m,Value2D.create(e.RenderSpriteData.Texture2D)),f.shaderValue.textureHost=t,f._key.other=r,this._copyClipInfo(f,this._globalClipMatrix)),f._numEle+=6,m.indexNum+=6,m.vertNum+=4,!0}transform4Points(e,t,r){var a=t.tx,i=t.ty,s=t.a,n=t.b,o=t.c,l=t.d,h=e[0],u=e[1],d=e[2],_=e[3],c=e[4],p=e[5],m=e[6],f=e[7];t._bTransform?(r[0]=h*s+u*o+a,r[1]=h*n+u*l+i,r[2]=d*s+_*o+a,r[3]=d*n+_*l+i,r[4]=c*s+p*o+a,r[5]=c*n+p*l+i,r[6]=m*s+f*o+a,r[7]=m*n+f*l+i):(r[0]=h+a,r[1]=u+i,r[2]=d+a,r[3]=_+i,r[4]=c+a,r[5]=p+i,r[6]=m+a,r[7]=f+i)}clipedOff(e){return this._clipRect.width<=0||this._clipRect.height<=0}transformQuad(e,t,r,a,i,s,n){var o=0;0!=i&&(o=Math.tan(i*Math.PI/180)*a);var l=e+r,h=t+a,u=s.tx,d=s.ty,_=s.a,c=s.b,p=s.c,m=s.d,f=e+o,g=t,T=l+o,S=t,x=l,y=h,E=e,R=h;s._bTransform?(n[0]=f*_+g*p+u,n[1]=f*c+g*m+d,n[2]=T*_+S*p+u,n[3]=T*c+S*m+d,n[4]=x*_+y*p+u,n[5]=x*c+y*m+d,n[6]=E*_+R*p+u,n[7]=E*c+R*m+d):(n[0]=f+u,n[1]=g+d,n[2]=T+u,n[3]=S+d,n[4]=x+u,n[5]=y+d,n[6]=E+u,n[7]=R+d)}pushRT(){this.addRenderObject(SubmitCMD.create(null,RenderTexture2D.pushRT,this))}popRT(){this.addRenderObject(SubmitCMD.create(null,RenderTexture2D.popRT,this)),this.breakNextMerge()}useRT(e){this.addRenderObject(SubmitCMD.create([e],(function(e){if(!e)throw"error useRT";e.start(),e.clear(0,0,0,0)}),this)),this.breakNextMerge()}RTRestore(e){this.addRenderObject(SubmitCMD.create([e],(function(e){e.restore()}),this)),this.breakNextMerge()}breakNextMerge(){this._curSubmit=SubmitBase.RENDERBASE}_repaintSprite(){this.sprite&&this.sprite.repaint()}drawTextureWithTransform(e,t,r,a,i,s,n,o,l,h,u,d=4294967295){var _,c=this._curMat;if(h&&(_=this.globalCompositeOperation,this.globalCompositeOperation=h),!s)return this._drawTextureM(e,t+n,r+o,a,i,c,l,u,d),void(h&&(this.globalCompositeOperation=_));var p=this._tmpMatrix;p.a=s.a,p.b=s.b,p.c=s.c,p.d=s.d,p.tx=s.tx+n,p.ty=s.ty+o,p._bTransform=s._bTransform,s&&c._bTransform?(Matrix.mul(p,c,p),(s=p)._bTransform=!0):(p.tx+=c.tx,p.ty+=c.ty,s=p),this._drawTextureM(e,t,r,a,i,s,l,u,d),h&&(this.globalCompositeOperation=_)}_flushToTarget(e,t){RenderState2D.worldScissorTest=!1,LayaGL.renderEngine.scissorTest(!1);var r=RenderState2D.worldAlpha,a=RenderState2D.worldMatrix4,i=RenderState2D.worldMatrix;RenderState2D.worldShaderDefines,RenderState2D.worldMatrix=Matrix.EMPTY,RenderState2D.restoreTempArray(),RenderState2D.worldMatrix4=RenderState2D.TEMPMAT4_ARRAY,RenderState2D.worldAlpha=1,BaseShader.activeShader=null,t.start(),e._submits._length>0&&t.clear(0,0,0,0),e._curSubmit=SubmitBase.RENDERBASE,e.flush(),e.clear(),t.restore(),e._curSubmit=SubmitBase.RENDERBASE,BaseShader.activeShader=null,RenderState2D.worldAlpha=r,RenderState2D.worldMatrix4=a,RenderState2D.worldMatrix=i}drawCanvas(e,t,r,a,i){if(e){var s,n=e.context;if(n._targets)n._submits._length>0&&(s=SubmitCMD.create([n,n._targets],this._flushToTarget,this),this._submits[this._submits._length++]=s),this._drawRenderTexture(n._targets,t,r,a,i,null,1,RenderTexture2D.flipyuv),this._curSubmit=SubmitBase.RENDERBASE;else{var o=e;o.touches&&o.touches.forEach((function(e){e.touch()})),s=SubmitCanvas.create(e,this._shader2D.ALPHA,this._shader2D.filters),this._submits[this._submits._length++]=s,s._key.clear();var l=s._matrix;this._curMat.copyTo(l);var h=l.tx,u=l.ty;l.tx=l.ty=0,l.transformPoint(Point.TEMP.setTo(t,r)),l.translate(Point.TEMP.x+h,Point.TEMP.y+u),Matrix.mul(o.invMat,l,l),this._curSubmit=SubmitBase.RENDERBASE}}}drawTarget(e,t,r,a,i,s,n,o=null,l=-1,h=4294967295){if(this._drawCount++,this._mesh.vertNum+4>Context._MAXVERTNUM&&(this._mesh=MeshQuadTexture.getAMesh(this.isMain),this.meshlist.push(this._mesh)),this.transformQuad(t,r,a,i,0,s||this._curMat,this._transedPoints),!this.clipedOff(this._transedPoints)){this._mesh.addQuad(this._transedPoints,o||Texture.DEF_UV,h,!0);var u=this._curSubmit=SubmitTarget.create(this,this._mesh,n,e);return u.blendType=-1==l?this._nBlendType:l,this._copyClipInfo(u,this._globalClipMatrix),u._numEle=6,this._mesh.indexNum+=6,this._mesh.vertNum+=4,this._submits[this._submits._length++]=u,this._curSubmit=SubmitBase.RENDERBASE,!0}return this._curSubmit=SubmitBase.RENDERBASE,!1}drawTriangles(t,r,a,i,s,n,o,l,h,u=4294967295){if(t._getSource()){var d=null;h&&(d=this.globalCompositeOperation,this.globalCompositeOperation=h),this._drawCount++;var _=this._tmpMatrix,c=this._triangleMesh,p=t.bitmap,m=this._curSubmit._key,f=m.submitType===SubmitBase.KEY_TRIANGLES&&m.other===p.id&&m.blendShader==this._nBlendType&&this._curSubmit.material==this.material;if(c.vertNum+i.length/2>Context._MAXVERTNUM&&(c=this._triangleMesh=MeshTexture.getAMesh(this.isMain),this.meshlist.push(c),f=!1),!f){var g=this._curSubmit=SubmitTexture.create(this,c,Value2D.create(e.RenderSpriteData.Texture2D));g.shaderValue.textureHost=t,g._renderType=SubmitBase.TYPE_TEXTURE,g._key.submitType=SubmitBase.KEY_TRIANGLES,g._key.other=p.id,this._copyClipInfo(g,this._globalClipMatrix),this._submits[this._submits._length++]=g}var T=this._mixRGBandAlpha(u,this._shader2D.ALPHA*l);this._drawTriUseAbsMatrix?c.addData(i,s,n,o,T):(o?(_.a=o.a,_.b=o.b,_.c=o.c,_.d=o.d,_.tx=o.tx+r,_.ty=o.ty+a):(_.a=1,_.b=0,_.c=0,_.d=1,_.tx=r,_.ty=a),Matrix.mul(_,this._curMat,_),c.addData(i,s,n,_||this._curMat,T)),this._curSubmit._numEle+=n.length,h&&(this.globalCompositeOperation=d)}else this.sprite&&ILaya.systemTimer.callLater(this,this._repaintSprite)}transform(e,t,r,a,i,s){SaveTransform.save(this),Matrix.mul(Matrix.TEMP.setTo(e,t,r,a,i,s),this._curMat,this._curMat),this._curMat._checkTransform()}_transformByMatrix(e,t,r){e.setTranslate(t,r),Matrix.mul(e,this._curMat,this._curMat),e.setTranslate(0,0),this._curMat._bTransform=!0}setTransformByMatrix(e){e.copyTo(this._curMat)}rotate(e){SaveTransform.save(this),this._curMat.rotateEx(e)}scale(e,t){SaveTransform.save(this),this._curMat.scaleEx(e,t)}clipRect(e,t,r,a,i){if(SaveClipRect.save(this),this._clipRect==Context.MAXCLIPRECT?this._clipRect=new Rectangle(e,t,r,a):(this._clipRect.width=r,this._clipRect.height=a,this._clipRect.x=e,this._clipRect.y=t),this._clipID_Gen++,this._clipID_Gen%=1e4,this._clipInfoID=this._clipID_Gen,i)Se.copyTo(this._globalClipMatrix);else{var s=this._globalClipMatrix,n=s.tx,o=s.ty,l=n+s.a,h=o+s.d;if(this._clipRect.width>=Const.MAX_CLIP_SIZE?(s.a=s.d=Const.MAX_CLIP_SIZE,s.b=s.c=s.tx=s.ty=0):(this._curMat._bTransform?(s.tx=this._clipRect.x*this._curMat.a+this._clipRect.y*this._curMat.c+this._curMat.tx,s.ty=this._clipRect.x*this._curMat.b+this._clipRect.y*this._curMat.d+this._curMat.ty,s.a=this._clipRect.width*this._curMat.a,s.b=this._clipRect.width*this._curMat.b,s.c=this._clipRect.height*this._curMat.c,s.d=this._clipRect.height*this._curMat.d):(s.tx=this._clipRect.x+this._curMat.tx,s.ty=this._clipRect.y+this._curMat.ty,s.a=this._clipRect.width,s.b=s.c=0,s.d=this._clipRect.height),this._incache&&(this._clipInCache=!0)),s.a>0&&s.d>0){var u=s.tx+s.a,d=s.ty+s.d;u<=n||d<=o||s.tx>=l||s.ty>=h?(s.a=-.1,s.d=-.1):(s.tx<n&&(s.a-=n-s.tx,s.tx=n),u>l&&(s.a-=u-l),s.ty<o&&(s.d-=o-s.ty,s.ty=o),d>h&&(s.d-=d-h),s.a<=0&&(s.a=-.1),s.d<=0&&(s.d=-.1))}}}addRenderObject(e){this._submits[this._submits._length++]=e}submitElement(e,t){this.isMain;var r=this._submits,a=r._length;t<0&&(t=r._length);for(var i=SubmitBase.RENDERBASE;e<t;)this._renderNextSubmitIndex=e+1,r[e]!==SubmitBase.RENDERBASE?(SubmitBase.preRender=i,e+=(i=r[e]).renderSubmit()):e++;return a}flush(){this._clipID_Gen=0;var e=this.submitElement(0,this._submits._length);this._path&&this._path.reset(),SkinMeshBuffer.instance&&SkinMeshBuffer.getInstance().reset(),this._curSubmit=SubmitBase.RENDERBASE;for(var t=0,r=this.meshlist.length;t<r;t++){var a=this.meshlist[t];a.canReuse?a.releaseMesh():a.destroy()}return this.meshlist.length=0,this._mesh=MeshQuadTexture.getAMesh(this.isMain),this._pathMesh=MeshVG.getAMesh(this.isMain),this._triangleMesh=MeshTexture.getAMesh(this.isMain),this.meshlist.push(this._mesh,this._pathMesh,this._triangleMesh),this._flushCnt++,this._flushCnt%60==0&&this.isMain&&TextRender.textRenderInst&&TextRender.textRenderInst.GC(),e}beginPath(e=!1){this._getPath().beginPath(e)}closePath(){this._path.closePath()}addPath(e,t,r,a,i){let s=e.length;for(let t=0;t<s-1;t+=2)e[t]+=a,e[t+1]+=i;t&&s>5&&(e[s-2]!=e[0]||e[s-1]!=e[1])&&e.push(e[0],e[1]),this._getPath().push(e,r)}fill(){var e=this._curMat,t=this._getPath(),r=this._curSubmit;r._key.submitType===SubmitBase.KEY_VG&&r._key.blendShader===this._nBlendType&&this.isSameClipInfo(r)&&this._curSubmit.material==this.material||(this._curSubmit=this.addVGSubmit(this._pathMesh));for(var a,i=this.mixRGBandAlpha(this.fillStyle.toInt()),s=0,n=0,o=t.paths.length;n<o;n++){var l=t.paths[n],h=l.path.length/2;if(!(h<3||3==h&&!l.convex)){var u,d,_,c,p=l.path.concat(),m=0;if(e._bTransform)for(m=0;m<h;m++)d=(u=m<<1)+1,_=p[u],c=p[d],p[u]=e.a*_+e.c*c+e.tx,p[d]=e.b*_+e.d*c+e.ty;else for(m=0;m<h;m++)d=(u=m<<1)+1,_=p[u],c=p[d],p[u]=_+e.tx,p[d]=c+e.ty;this._pathMesh.vertNum+h>Context._MAXVERTNUM&&(this._curSubmit._numEle+=s,s=0,this._pathMesh=MeshVG.getAMesh(this.isMain),this._curSubmit=this.addVGSubmit(this._pathMesh));var f=this._pathMesh.vertNum;if(l.convex){var g=h-2;a=new Array(3*g);for(var T=0,S=0;S<g;S++)a[T++]=f,a[T++]=S+1+f,a[T++]=S+2+f}else if(a=Earcut.earcut(p,null,2),f>0)for(var x=0;x<a.length;x++)a[x]+=f;this._pathMesh.addVertAndIBToMesh(this,p,i,a),s+=a.length}}this._curSubmit._numEle+=s}addVGSubmit(t){var r=Submit.createShape(this,t,0,Value2D.create(e.RenderSpriteData.Primitive));return r._key.submitType=SubmitBase.KEY_VG,this._submits[this._submits._length++]=r,this._copyClipInfo(r,this._globalClipMatrix),r}stroke(){if(this.lineWidth>0){var e=this.mixRGBandAlpha(this.strokeStyle._color.numColor),t=this._getPath(),r=this._curSubmit;r._key.submitType===SubmitBase.KEY_VG&&r._key.blendShader===this._nBlendType&&this.isSameClipInfo(r)&&this._curSubmit.material==this.material||(this._curSubmit=this.addVGSubmit(this._pathMesh));for(var a=0,i=0,s=t.paths.length;i<s;i++){var n=t.paths[i];if(!(n.path.length<=0)){var o=[],l=[],h=2*n.path.length;if(!(h<2)){this._pathMesh.vertNum+h>Context._MAXVERTNUM&&(this._curSubmit._numEle+=a,a=0,this._pathMesh=MeshVG.getAMesh(this.isMain),this.meshlist.push(this._pathMesh),this._curSubmit=this.addVGSubmit(this._pathMesh)),BasePoly.createLine2(n.path,o,this.lineWidth,this._pathMesh.vertNum,l,n.loop);var u,d,_,c,p=l.length/2,m=this._curMat,f=0;if(m._bTransform)for(f=0;f<p;f++)d=(u=f<<1)+1,_=l[u],c=l[d],l[u]=m.a*_+m.c*c+m.tx,l[d]=m.b*_+m.d*c+m.ty;else for(f=0;f<p;f++)d=(u=f<<1)+1,_=l[u],c=l[d],l[u]=_+m.tx,l[d]=c+m.ty;this._pathMesh.addVertAndIBToMesh(this,l,e,o),a+=o.length}}}this._curSubmit._numEle+=a}}moveTo(e,t){var r=this._getPath();r.newPath(),r._lastOriX=e,r._lastOriY=t,r.addPoint(e,t)}lineTo(e,t){var r=this._getPath();Math.abs(e-r._lastOriX)<.001&&Math.abs(t-r._lastOriY)<.001||(r._lastOriX=e,r._lastOriY=t,r.addPoint(e,t))}arcTo(e,t,r,a,i){var s=0,n=0,o=0,l=this._path._lastOriX-e,h=this._path._lastOriY-t,u=Math.sqrt(l*l+h*h);if(!(u<=1e-6)){var d=l/u,_=h/u,c=r-e,p=a-t,m=c*c+p*p,f=Math.sqrt(m);if(!(f<=1e-6)){var g=c/f,T=p/f,S=d+g,x=_+T,y=Math.sqrt(S*S+x*x);if(!(y<=1e-6)){var E=S/y,R=x/y,b=Math.acos(E*d+R*_),C=Math.PI/2-b,v=(u=i*Math.tan(C))*d+e,D=u*_+t,M=Math.sqrt(u*u+i*i),A=e+E*M,L=t+R*M,I=0,w=0;if(d*T-_*g>=0){var B=2*C/Context.SEGNUM;I=Math.sin(B),w=Math.cos(B)}else B=2*-C/Context.SEGNUM,I=Math.sin(B),w=Math.cos(B);var P=this._path._lastOriX,F=this._path._lastOriY,N=v,O=D;(Math.abs(N-this._path._lastOriX)>.1||Math.abs(O-this._path._lastOriY)>.1)&&(n=N,o=O,P=N,F=O,this._path._lastOriX=n,this._path._lastOriY=o,this._path.addPoint(n,o));var U=v-A,G=D-L;for(s=0;s<Context.SEGNUM;s++){var V=U*w+G*I,k=-U*I+G*w;n=V+A,o=k+L,(Math.abs(P-n)>.1||Math.abs(F-o)>.1)&&(this._path._lastOriX=n,this._path._lastOriY=o,this._path.addPoint(n,o),P=n,F=o),U=V,G=k}}}}}arc(e,t,r,a,i,s,n=!1,o=!0,l=10){var h,u,d=0,_=0,c=0,p=0,m=0;if(_=s-i,n)if(Math.abs(_)>=2*Math.PI)_=2*-Math.PI;else for(;_>0;)_-=2*Math.PI;else if(Math.abs(_)>=2*Math.PI)_=2*Math.PI;else for(;_<0;)_+=2*Math.PI;var f=this.getMatScaleX(),g=this.getMatScaleY(),T=r*(f>g?f:g),S=2*Math.PI*T;u=0|Math.max(S/l,l);var x=this._getPath();for(h=0;h<=u;h++)d=i+_*(h/u),c=Math.cos(d),m=t+Math.sin(d)*a,(p=e+c*r)==this._path._lastOriX&&m==this._path._lastOriY||x.addPoint(p,m);c=Math.cos(s),m=t+Math.sin(s)*a,(p=e+c*r)==this._path._lastOriX&&m==this._path._lastOriY||x.addPoint(p,m)}quadraticCurveTo(e,t,r,a){for(var i=Bezier.I.getBezierPoints([this._path._lastOriX,this._path._lastOriY,e,t,r,a],30,2),s=0,n=i.length/2;s<n;s++)this.lineTo(i[2*s],i[2*s+1]);this.lineTo(r,a)}mixRGBandAlpha(e){return this._mixRGBandAlpha(e,this._shader2D.ALPHA)}_mixRGBandAlpha(e,t){if(t>=1)return e;var r=(4278190080&e)>>>24;return 0!=r?r*=t:r=255*t,16777215&e|r<<24}strokeRect(e,t,r,a,i){if(this.lineWidth>0){var s=this.mixRGBandAlpha(this.strokeStyle._color.numColor),n=this.lineWidth/2;this._fillRect(e-n,t-n,r+this.lineWidth,this.lineWidth,s),this._fillRect(e-n,t-n+a,r+this.lineWidth,this.lineWidth,s),this._fillRect(e-n,t+n,this.lineWidth,a-this.lineWidth,s),this._fillRect(e-n+r,t+n,this.lineWidth,a-this.lineWidth,s)}}clip(){}drawParticle(e,t,r){r.x=e,r.y=t,this._submits[this._submits._length++]=r}_getPath(){return this._path||(this._path=new Path)}get canvas(){return this._canvas}_fillTexture_h(e,t,r,a,i,s,n,o,l){a<=0&&console.error("_fillTexture_h error: oriw must>0");for(var h=s,u=Math.floor(o/a),d=o%a,_=0;_<u;_++)this._inner_drawTexture(e,t,h,n,a,i,this._curMat,r,1,!1,l),h+=a;if(d>0){var c=r[2]-r[0],p=r[0]+c*(d/a),m=Context.tmpuv1;m[0]=r[0],m[1]=r[1],m[2]=p,m[3]=r[3],m[4]=p,m[5]=r[5],m[6]=r[6],m[7]=r[7],this._inner_drawTexture(e,t,h,n,d,i,this._curMat,m,1,!1,l)}}_fillTexture_v(e,t,r,a,i,s,n,o,l){i<=0&&console.error("_fillTexture_v error: orih must>0");for(var h=n,u=Math.floor(o/i),d=o%i,_=0;_<u;_++)this._inner_drawTexture(e,t,s,h,a,i,this._curMat,r,1,!1,l),h+=i;if(d>0){var c=r[7]-r[1],p=r[1]+c*(d/i),m=Context.tmpuv1;m[0]=r[0],m[1]=r[1],m[2]=r[2],m[3]=r[3],m[4]=r[4],m[5]=p,m[6]=r[6],m[7]=p,this._inner_drawTexture(e,t,s,h,a,d,this._curMat,m,1,!1,l)}}drawTextureWithSizeGrid(e,t,r,a,i,s,n,o,l){if(!e._getSource())return;t+=n,r+=o;var h=e.uv,u=e.bitmap.width,d=e.bitmap.height;let _=e.offsetX,c=e.offsetY,p=e.sourceWidth,m=e.sourceHeight,f=p-e.width-_,g=m-e.height-c;var T=s[0];0>(T-=c)&&(c+=T,T=0),r+=c;var S=s[3];0>(S-=_)&&(_+=S,S=0),t+=_;var x=s[1];0>(x-=f)&&(f+=x,x=0);var y=s[2];0>(y-=g)&&(g+=y,y=0),a-=_+f,i-=c+g;var E=s[4];a==e.width&&(S=x=0),i==e.height&&(T=y=0);var R=T/d,b=S/u,C=x/u,v=y/d,D=e.bitmap.id,M=this._curMat,A=this._tempUV,L=1,I=1;S+x>a&&(L=a/(S+x)),T+y>i&&(I=i/(T+y)),S*=L,x*=L,T*=I,y*=I;var w=h[0],B=h[1],P=h[4],F=h[5],N=w,O=B,U=P,G=F;if(S&&T&&(U=w+b,G=B+R,A[0]=w,A[1]=B,A[2]=U,A[3]=B,A[4]=U,A[5]=G,A[6]=w,A[7]=G,this._inner_drawTexture(e,D,t,r,S,T,M,A,1,!1,l)),x&&T&&(N=P-C,O=B,U=P,G=B+R,A[0]=N,A[1]=O,A[2]=U,A[3]=O,A[4]=U,A[5]=G,A[6]=N,A[7]=G,this._inner_drawTexture(e,D,a-x+t,0+r,x,T,M,A,1,!1,l)),S&&y&&(N=w,O=F-v,U=w+b,G=F,A[0]=N,A[1]=O,A[2]=U,A[3]=O,A[4]=U,A[5]=G,A[6]=N,A[7]=G,this._inner_drawTexture(e,D,0+t,i-y+r,S,y,M,A,1,!1,l)),x&&y&&(N=P-C,O=F-v,U=P,G=F,A[0]=N,A[1]=O,A[2]=U,A[3]=O,A[4]=U,A[5]=G,A[6]=N,A[7]=G,this._inner_drawTexture(e,D,a-x+t,i-y+r,x,y,M,A,1,!1,l)),T&&(N=w+b,O=B,U=P-C,G=B+R,A[0]=N,A[1]=O,A[2]=U,A[3]=O,A[4]=U,A[5]=G,A[6]=N,A[7]=G,E?this._fillTexture_h(e,D,A,e.width-S-x,T,S+t,r,a-S-x,l):this._inner_drawTexture(e,D,S+t,r,a-S-x,T,M,A,1,!1,l)),y&&(N=w+b,O=F-v,U=P-C,G=F,A[0]=N,A[1]=O,A[2]=U,A[3]=O,A[4]=U,A[5]=G,A[6]=N,A[7]=G,E?this._fillTexture_h(e,D,A,e.width-S-x,y,S+t,i-y+r,a-S-x,l):this._inner_drawTexture(e,D,S+t,i-y+r,a-S-x,y,M,A,1,!1,l)),S&&(N=w,O=B+R,U=w+b,G=F-v,A[0]=N,A[1]=O,A[2]=U,A[3]=O,A[4]=U,A[5]=G,A[6]=N,A[7]=G,E?this._fillTexture_v(e,D,A,S,e.height-T-y,t,T+r,i-T-y,l):this._inner_drawTexture(e,D,t,T+r,S,i-T-y,M,A,1,!1,l)),x&&(N=P-C,O=B+R,U=P,G=F-v,A[0]=N,A[1]=O,A[2]=U,A[3]=O,A[4]=U,A[5]=G,A[6]=N,A[7]=G,E?this._fillTexture_v(e,D,A,x,e.height-T-y,a-x+t,T+r,i-T-y,l):this._inner_drawTexture(e,D,a-x+t,T+r,x,i-T-y,M,A,1,!1,l)),N=w+b,O=B+R,U=P-C,G=F-v,A[0]=N,A[1]=O,A[2]=U,A[3]=O,A[4]=U,A[5]=G,A[6]=N,A[7]=G,E){var V=Context.tmpUVRect;V[0]=N,V[1]=O,V[2]=U-N,V[3]=G-O,this._fillTexture(e,e.width-S-x,e.height-T-y,V,S+t,T+r,a-S-x,i-T-y,"repeat",0,0,l)}else this._inner_drawTexture(e,D,S+t,T+r,a-S-x,i-T-y,M,A,1,!1,l)}addRenderObject3D(e){this._curSubmit=SubmitBase.RENDERBASE,this.addRenderObject(e)}}Context._SUBMITVBSIZE=32e3,Context._MAXVERTNUM=65535,Context.MAXCLIPRECT=null,Context._COUNT=0,Context.SEGNUM=32,Context._contextcount=0,Context.PI2=2*Math.PI,Context.HPI=.5*Math.PI,Context._textRender=null,Context.tmpuv1=[0,0,0,0,0,0,0,0],Context.tmpUV=[0,0,0,0,0,0,0,0],Context.tmpUVRect=[0,0,0,0];class ContextParams{constructor(){this.lineWidth=1}clear(){this.lineWidth=1,this.textAlign=this.textBaseline=null}make(){return this===ContextParams.DEFAULT?new ContextParams:this}}window.conch&&!window.conchConfig.conchWebGL&&(Context=NativeContext);class HTMLCanvas extends Resource{get source(){return this._source}get width(){return this._width}set width(e){this._width=e}get height(){return this._height}set height(e){this._height=e}_getSource(){return this._source}constructor(e=!1){super(),this._source=e?Browser.createElement("canvas"):this,this.lock=!0}clear(){this._ctx&&(this._ctx.clear?this._ctx.clear():this._ctx.clearRect(0,0,this._width,this._height)),this._texture&&(this._texture.destroy(),this._texture=null)}destroy(){super.destroy(),this._setCPUMemory(0),this._ctx&&this._ctx.destroy&&this._ctx.destroy(),this._ctx=null}release(){}get context(){return this._ctx||(this._source==this?this._ctx=new Context:this._ctx=this._source.getContext(LayaEnv.isConch?"layagl":"2d"),this._ctx._canvas=this),this._ctx}_setContext(e){this._ctx=e}getContext(e,t=null){return this.context}getMemSize(){return 0}size(e,t){(this._width!=e||this._height!=t||this._source&&(this._source.width!=e||this._source.height!=t))&&(this._width=e,this._height=t,this._setCPUMemory(e*t*4),this._ctx&&this._ctx.size&&this._ctx.size(e,t),this._source&&(this._source.height=t,this._source.width=e),this._texture&&(this._texture.destroy(),this._texture=null))}getTexture(){if(!this._texture){var t=new Texture2D(this.source.width,this.source.height,e.TextureFormat.R8G8B8A8,!0,!1,!1);t.setImageData(this.source,!1,!1),this._texture=new Texture(t)}return this._texture}toBase64(e,t){if(this._source){if(LayaEnv.isConch){var r=window,a=this._ctx._targets.sourceWidth,i=this._ctx._targets.sourceHeight,s=this._ctx._targets.getData(0,0,a,i);return r.conchToBase64FlipY?r.conchToBase64FlipY(e,t,s.buffer,a,i):r.conchToBase64(e,t,s.buffer,a,i)}return this._source.toDataURL(e,t)}return null}toBase64Async(e,t,r){var a=this._ctx._targets.sourceWidth,i=this._ctx._targets.sourceHeight;this._ctx._targets.getDataAsync(0,0,a,i,(function(s){let n=window;var o=n.conchToBase64FlipY?n.conchToBase64FlipY(e,t,s.buffer,a,i):n.conchToBase64(e,t,s.buffer,a,i);r(o)}))}}class BoundsStyle{reset(){return this.bounds&&this.bounds.recover(),this.userBounds&&this.userBounds.recover(),this.bounds=null,this.userBounds=null,this.temBM=null,this}recover(){Pool.recover("BoundsStyle",this.reset())}static create(){return Pool.getItemByClass("BoundsStyle",BoundsStyle)}}class CacheStyle{constructor(){this.reset()}needBitmapCache(){return this.cacheForFilters||!!this.mask}needEnableCanvasRender(){return"none"!=this.userSetCache||this.cacheForFilters||!!this.mask}releaseContext(){if(this.canvas&&this.canvas.size){Pool.recover("CacheCanvas",this.canvas),this.canvas.size(0,0);try{this.canvas.width=0,this.canvas.height=0}catch(e){}}this.canvas=null}createContext(){if(!this.canvas){this.canvas=Pool.getItem("CacheCanvas")||new HTMLCanvas(!1);var e=this.canvas.context;e||(e=this.canvas.getContext("2d"))}}releaseFilterCache(){var e=this.filterCache;e&&(e.destroy(),e.recycle(),this.filterCache=null)}recover(){this!==CacheStyle.EMPTY&&Pool.recover("SpriteCache",this.reset())}reset(){return this.releaseContext(),this.releaseFilterCache(),this.cacheAs="none",this.enableCanvasRender=!1,this.userSetCache="none",this.cacheForFilters=!1,this.staticCache=!1,this.reCache=!0,this.mask=null,this.maskParent=null,this.filterCache=null,this.filters=null,this.hasGlowFilter=!1,this.cacheRect&&this.cacheRect.recover(),this.cacheRect=null,this}static create(){return Pool.getItemByClass("SpriteCache",CacheStyle)}_calculateCacheRect(e,t,r,a){var i,s=e._cacheStyle;if(s.cacheRect||(s.cacheRect=Rectangle.create()),"bitmap"===t?((i=e.getSelfBounds()).width=i.width+2*CacheStyle.CANVAS_EXTEND_EDGE,i.height=i.height+2*CacheStyle.CANVAS_EXTEND_EDGE,i.x=i.x-e.pivotX,i.y=i.y-e.pivotY,i.x=i.x-CacheStyle.CANVAS_EXTEND_EDGE,i.y=i.y-CacheStyle.CANVAS_EXTEND_EDGE,i.x=Math.floor(i.x+r)-r,i.y=Math.floor(i.y+a)-a,i.width=Math.floor(i.width),i.height=Math.floor(i.height),s.cacheRect.copyFrom(i)):s.cacheRect.setTo(-e._style.pivotX,-e._style.pivotY,1,1),i=s.cacheRect,e._style.scrollRect){var n=e._style.scrollRect;i.x-=n.x,i.y-=n.y}return CacheStyle._scaleInfo.setTo(1,1),CacheStyle._scaleInfo}}CacheStyle.EMPTY=new CacheStyle,CacheStyle._scaleInfo=new Point,CacheStyle.CANVAS_EXTEND_EDGE=16;class SpriteStyle{constructor(){this.reset()}reset(){return this.scaleX=this.scaleY=1,this.skewX=this.skewY=0,this.pivotX=this.pivotY=this.rotation=0,this.alpha=1,this.scrollRect&&this.scrollRect.recover(),this.scrollRect=null,this.viewport&&this.viewport.recover(),this.viewport=null,this.hitArea=null,this.dragging=null,this.blendMode=null,this}recover(){this!==SpriteStyle.EMPTY&&Pool.recover("SpriteStyle",this.reset())}static create(){return Pool.getItemByClass("SpriteStyle",SpriteStyle)}}SpriteStyle.EMPTY=new SpriteStyle;class AlphaCmd{static create(e){var t=Pool.getItemByClass("AlphaCmd",AlphaCmd);return t.alpha=e,t}recover(){Pool.recover("AlphaCmd",this)}run(e,t,r){e.alpha(this.alpha)}get cmdID(){return AlphaCmd.ID}}AlphaCmd.ID="Alpha";class DrawCircleCmd{constructor(){this.lineWidth=0}static create(e,t,r,a,i,s){var n=Pool.getItemByClass("DrawCircleCmd",DrawCircleCmd);return n.x=e,n.y=t,n.radius=r,n.fillColor=a,n.lineColor=i,n.lineWidth=s,n}recover(){this.fillColor=null,this.lineColor=null,Pool.recover("DrawCircleCmd",this)}run(e,t,r){let a=this.lineWidth>=1&&this.lineColor?this.lineWidth/2:0;if(this.percent&&e.sprite){let i=e.sprite.width,s=e.sprite.height;e._drawCircle(this.x*i+t,this.y*s+r,this.radius*Math.min(i,s)-a,this.fillColor,this.lineColor,this.lineWidth,0)}else e._drawCircle(this.x+t,this.y+r,this.radius-a,this.fillColor,this.lineColor,this.lineWidth,0)}get cmdID(){return DrawCircleCmd.ID}getBoundPoints(e){return Rectangle._getBoundPointS(this.x-this.radius,this.y-this.radius,this.radius+this.radius,this.radius+this.radius,this.percent?e:null)}}DrawCircleCmd.ID="DrawCircle",ClassUtils.regClass("DrawCircleCmd",DrawCircleCmd);class DrawCurvesCmd{static create(e,t,r,a,i){var s=Pool.getItemByClass("DrawCurvesCmd",DrawCurvesCmd);return s.x=e,s.y=t,s.points=r,s.lineColor=a,s.lineWidth=i,s}recover(){this.points=null,this.lineColor=null,Pool.recover("DrawCurvesCmd",this)}run(e,t,r){this.points&&e.drawCurves(this.x+t,this.y+r,this.points,this.lineColor,this.lineWidth)}get cmdID(){return DrawCurvesCmd.ID}getBoundPoints(e){return Bezier.I.getBezierPoints(this.points)}}DrawCurvesCmd.ID="DrawCurves",ClassUtils.regClass("DrawCurvesCmd",DrawCurvesCmd);class DrawImageCmd{constructor(){this.color=4294967295}static create(e,t,r,a,i,s){null==a&&(a=e.sourceWidth),null==i&&(i=e.sourceHeight);let n=a/e.sourceWidth,o=i/e.sourceHeight;a=e.width*n,i=e.height*o,t+=e.offsetX*n,r+=e.offsetY*o;var l=Pool.getItemByClass("DrawImageCmd",DrawImageCmd);return l.texture=e,e._addReference(),l.x=t,l.y=r,l.width=a,l.height=i,l.color=null!=s?ColorUtils.create(s).numColor:4294967295,l}recover(){this.texture&&this.texture._removeReference(),this.texture=null,Pool.recover("DrawImageCmd",this)}run(e,t,r){this.texture&&e.drawTexture(this.texture,this.x+t,this.y+r,this.width,this.height,this.color)}get cmdID(){return DrawImageCmd.ID}}DrawImageCmd.ID="DrawImage";class DrawLineCmd{constructor(){this.lineWidth=0}static create(e,t,r,a,i,s){var n=Pool.getItemByClass("DrawLineCmd",DrawLineCmd);return n.fromX=e,n.fromY=t,n.toX=r,n.toY=a,n.lineColor=i,n.lineWidth=s,n}recover(){Pool.recover("DrawLineCmd",this)}run(e,t,r){let a=this.lineWidth<1||this.lineWidth%2==0?0:.5;if(this.percent&&e.sprite){let i=e.sprite.width,s=e.sprite.height;e._drawLine(t,r,this.fromX*i+a,this.fromY*s+a,this.toX*i+a,this.toY*s+a,this.lineColor,this.lineWidth,0)}else e._drawLine(t,r,this.fromX+a,this.fromY+a,this.toX+a,this.toY+a,this.lineColor,this.lineWidth,0)}get cmdID(){return DrawLineCmd.ID}getBoundPoints(e){let t;xe.length=0,t=.5*this.lineWidth;let r=this.fromX,a=this.fromY,i=this.toX,s=this.toY;return this.percent&&(r*=e.width,a*=e.height,i*=e.width,s*=e.height),r==i?xe.push(r+t,a,i+t,s,r-t,a,i-t,s):a==s?xe.push(r,a+t,i,s+t,r,a-t,i,s-t):xe.push(r,a,i,s),xe}}DrawLineCmd.ID="DrawLine";const xe=[];ClassUtils.regClass("DrawLineCmd",DrawLineCmd);class DrawLinesCmd{constructor(){this.lineWidth=0}static create(e,t,r,a,i){var s=Pool.getItemByClass("DrawLinesCmd",DrawLinesCmd);return s.x=e,s.y=t,s.points=r,s.lineColor=a,s.lineWidth=i,s}recover(){this.points=null,this.lineColor=null,Pool.recover("DrawLinesCmd",this)}run(e,t,r){let a=this.lineWidth<1||this.lineWidth%2==0?0:.5;this.points&&e._drawLines(this.x+a+t,this.y+a+r,this.points,this.lineColor,this.lineWidth,0)}get cmdID(){return DrawLinesCmd.ID}}DrawLinesCmd.ID="DrawLines",ClassUtils.regClass("DrawLinesCmd",DrawLinesCmd);class DrawPathCmd{static create(e,t,r,a,i){var s=Pool.getItemByClass("DrawPathCmd",DrawPathCmd);return s.x=e,s.y=t,s.paths=r,s.brush=a,s.pen=i,s}recover(){this.paths=null,this.brush=null,this.pen=null,Pool.recover("DrawPathCmd",this)}run(e,t,r){this.paths&&e._drawPath(this.x+t,this.y+r,this.paths,this.brush,this.pen)}get cmdID(){return DrawPathCmd.ID}getBoundPoints(e){let t=ye;t.length=0;let r=this.paths,a=r.length;for(let e=0;e<a;e++){let a=r[e];a.length>1&&(t.push(a[1],a[2]),a.length>3&&t.push(a[3],a[4]))}return t}}DrawPathCmd.ID="DrawPath";const ye=[];ClassUtils.regClass("DrawPathCmd",DrawPathCmd);class DrawPieCmd{constructor(){this.radius=0,this.lineWidth=0}static create(e,t,r,a,i,s,n,o){var l=Pool.getItemByClass("DrawPieCmd",DrawPieCmd);return l.x=e,l.y=t,l.radius=r,l._startAngle=a,l._endAngle=i,l.fillColor=s,l.lineColor=n,l.lineWidth=o,l}recover(){this.fillColor=null,this.lineColor=null,Pool.recover("DrawPieCmd",this)}run(e,t,r){let a=this.lineWidth>=1&&this.lineColor?this.lineWidth/2:0,i=this.lineColor?this.lineWidth:0;e._drawPie(this.x+a+t,this.y+a+r,this.radius-i,this._startAngle,this._endAngle,this.fillColor,this.lineColor,this.lineWidth,0)}get cmdID(){return DrawPieCmd.ID}get startAngle(){return 180*this._startAngle/Math.PI}set startAngle(e){this._startAngle=e*Math.PI/180}get endAngle(){return 180*this._endAngle/Math.PI}set endAngle(e){this._endAngle=e*Math.PI/180}getBoundPoints(e){let t=Ee;Ee.length=0;let r=Math.PI/180,a=this.endAngle-this.startAngle,i=this.x,s=this.y,n=this.radius;if(a>=360||a<=-360)return t.push(i-n,s-n),t.push(i+n,s-n),t.push(i+n,s+n),t.push(i-n,s+n),t;t.push(i,s);var o=a%360;o<0&&(o+=360);var l=this.startAngle+o,h=this.startAngle*r,u=l*r;t.push(i+n*Math.cos(h),s+n*Math.sin(h)),t.push(i+n*Math.cos(u),s+n*Math.sin(u));for(var d=90*Math.ceil(this.startAngle/90),_=90*Math.floor(l/90),c=d;c<=_;c+=90){var p=c*r;t.push(i+n*Math.cos(p),s+n*Math.sin(p))}return t}}DrawPieCmd.ID="DrawPie";const Ee=[];ClassUtils.regClass("DrawPieCmd",DrawPieCmd);class DrawPolyCmd{static create(e,t,r,a,i,s){var n=Pool.getItemByClass("DrawPolyCmd",DrawPolyCmd);return n.x=e,n.y=t,n.points=r,n.fillColor=a,n.lineColor=i,n.lineWidth=s,n}recover(){this.points=null,this.fillColor=null,this.lineColor=null,Pool.recover("DrawPolyCmd",this)}run(e,t,r){let a=this.points.length<=6,i=this.lineWidth>=1&&this.lineColor?this.lineWidth%2==0?0:.5:0;this.points&&e._drawPoly(this.x+i+t,this.y+i+r,this.points,this.fillColor,this.lineColor,this.lineWidth,a,0)}get cmdID(){return DrawPolyCmd.ID}}DrawPolyCmd.ID="DrawPoly",ClassUtils.regClass("DrawPolyCmd",DrawPolyCmd);class DrawRectCmd{constructor(){this.lineWidth=0}static create(e,t,r,a,i,s,n,o){var l=Pool.getItemByClass("DrawRectCmd",DrawRectCmd);return l.x=e,l.y=t,l.width=r,l.height=a,l.fillColor=i,l.lineColor=s,l.lineWidth=n,l.percent=o,l}recover(){this.fillColor=null,this.lineColor=null,Pool.recover("DrawRectCmd",this)}run(e,t,r){let a=this.lineWidth>=1&&this.lineColor?this.lineWidth/2:0,i=this.lineColor?this.lineWidth:0;if(this.percent&&e.sprite){let s=e.sprite.width,n=e.sprite.height;e.drawRect(this.x*s+a+t,this.y*n+a+r,this.width*s-i,this.height*n-i,this.fillColor,this.lineColor,this.lineWidth)}else e.drawRect(this.x+a+t,this.y+a+r,this.width-i,this.height-i,this.fillColor,this.lineColor,this.lineWidth)}get cmdID(){return DrawRectCmd.ID}getBoundPoints(e){return Rectangle._getBoundPointS(this.x,this.y,this.width,this.height,this.percent?e:null)}}DrawRectCmd.ID="DrawRect",ClassUtils.regClass("DrawRectCmd",DrawRectCmd);class DrawTextureCmd{constructor(){this.color=4294967295,this.uv=null}static create(e,t,r,a,i,s,n,o,l,h){null==a&&(a=e.sourceWidth),null==i&&(i=e.sourceHeight);let u=a/e.sourceWidth,d=i/e.sourceHeight;a=e.width*u,i=e.height*d,t+=e.offsetX*u,r+=e.offsetY*d;var _=Pool.getItemByClass("DrawTextureCmd",DrawTextureCmd);return _.texture=e,e._addReference(),_.x=t,_.y=r,_.width=a,_.height=i,_.matrix=s,_.alpha=n,_.blendMode=l,_.uv=h||null,_.color=null!=o?ColorUtils.create(o).numColor:4294967295,_}recover(){this.texture&&this.texture._removeReference(),this.texture=null,this.matrix=null,Pool.recover("DrawTextureCmd",this)}run(e,t,r){this.texture&&e.drawTextureWithTransform(this.texture,this.x,this.y,this.width,this.height,this.matrix,t,r,this.alpha,this.blendMode,this.uv,this.color)}get cmdID(){return DrawTextureCmd.ID}}DrawTextureCmd.ID="DrawTexture",ClassUtils.regClass("DrawTextureCmd",DrawTextureCmd);class FillTextureCmd{constructor(){this.color=4294967295}static create(e,t,r,a,i,s,n,o){var l=Pool.getItemByClass("FillTextureCmd",FillTextureCmd);return l.texture=e,e._addReference(),l.x=t,l.y=r,l.width=a,l.height=i,l.type=s,l.offset=n,l.color=null!=o?ColorUtils.create(o).numColor:4294967295,l}recover(){this.texture&&this.texture._removeReference(),this.texture=null,this.offset=null,Pool.recover("FillTextureCmd",this)}run(e,t,r){if(this.texture)if(this.percent&&e.sprite){let a=e.sprite.width,i=e.sprite.height;e.fillTexture(this.texture,this.x*a+t,this.y*i+r,this.width*a,this.height*i,this.type,this.offset||Point.EMPTY,this.color)}else e.fillTexture(this.texture,this.x+t,this.y+r,this.width,this.height,this.type,this.offset||Point.EMPTY,this.color)}get cmdID(){return FillTextureCmd.ID}getBoundPoints(e){return this.width&&this.height?Rectangle._getBoundPointS(this.x,this.y,this.width,this.height,this.percent?e:null):Rectangle._getBoundPointS(this.x,this.y,this.texture.width,this.texture.height)}}FillTextureCmd.ID="FillTexture",ClassUtils.regClass("FillTextureCmd",FillTextureCmd);class RestoreCmd{static create(){return Pool.getItemByClass("RestoreCmd",RestoreCmd)}recover(){Pool.recover("RestoreCmd",this)}run(e,t,r){e.restore()}get cmdID(){return RestoreCmd.ID}}RestoreCmd.ID="Restore";class RotateCmd{static create(e,t,r){var a=Pool.getItemByClass("RotateCmd",RotateCmd);return a.angle=e,a.pivotX=t,a.pivotY=r,a}recover(){Pool.recover("RotateCmd",this)}run(e,t,r){e._rotate(this.angle,this.pivotX+t,this.pivotY+r)}get cmdID(){return RotateCmd.ID}}RotateCmd.ID="Rotate";class ScaleCmd{static create(e,t,r,a){var i=Pool.getItemByClass("ScaleCmd",ScaleCmd);return i.scaleX=e,i.scaleY=t,i.pivotX=r,i.pivotY=a,i}recover(){Pool.recover("ScaleCmd",this)}run(e,t,r){e._scale(this.scaleX,this.scaleY,this.pivotX+t,this.pivotY+r)}get cmdID(){return ScaleCmd.ID}}ScaleCmd.ID="Scale";class TransformCmd{static create(e,t,r){var a=Pool.getItemByClass("TransformCmd",TransformCmd);return a.matrix=e,a.pivotX=t,a.pivotY=r,a}recover(){this.matrix=null,Pool.recover("TransformCmd",this)}run(e,t,r){e._transform(this.matrix,this.pivotX+t,this.pivotY+r)}get cmdID(){return TransformCmd.ID}}TransformCmd.ID="Transform";class TranslateCmd{static create(e,t){var r=Pool.getItemByClass("TranslateCmd",TranslateCmd);return r.tx=e,r.ty=t,r}recover(){Pool.recover("TranslateCmd",this)}run(e,t,r){e.translate(this.tx,this.ty)}get cmdID(){return TranslateCmd.ID}}TranslateCmd.ID="Translate";class DrawTrianglesCmd{static create(e,t,r,a,i,s,n,o,l,h){var u=Pool.getItemByClass("DrawTrianglesCmd",DrawTrianglesCmd);return u.texture=e,u.x=t,u.y=r,u.vertices=a,u.uvs=i,u.indices=s,u.matrix=n,u.alpha=o,u.color=null!=l?ColorUtils.create(l).numColor:4294967295,u.blendMode=h,u}recover(){this.texture=null,this.vertices=null,this.uvs=null,this.indices=null,this.matrix=null,Pool.recover("DrawTrianglesCmd",this)}run(e,t,r){e.drawTriangles(this.texture,this.x+t,this.y+r,this.vertices,this.uvs,this.indices,this.matrix,this.alpha,this.blendMode,this.color)}get cmdID(){return DrawTrianglesCmd.ID}getBoundPoints(e){let t=this.vertices;var r=t.length;if(r<2)return[];for(var a=t[0],i=t[1],s=a,n=i,o=2;o<r;){var l=t[o++],h=t[o++];a>l&&(a=l),i>h&&(i=h),s<l&&(s=l),n<h&&(n=h)}return[a,i,s,i,s,n,a,n]}}DrawTrianglesCmd.ID="DrawTriangles",ClassUtils.regClass("DrawTrianglesCmd",DrawTrianglesCmd);class Draw9GridTextureCmd{constructor(){this.color=4294967295}static create(e,t,r,a,i,s,n=!1,o=null){let l=Pool.getItemByClass("Draw9GridTextureCmd",Draw9GridTextureCmd);return l.texture=e,e._addReference(),l.x=t,l.y=r,l.width=a,l.height=i,l.sizeGrid=s,l.percent=n,l.color=null!=o?ColorUtils.create(o).numColor:4294967295,l}recover(){this.texture._removeReference(),Pool.recover("Draw9GridTextureCmd",this)}run(e,t,r){if(this.texture){let a=this.sizeGrid||this.texture._sizeGrid||Re;if(this.percent&&e.sprite){let i=e.sprite.width,s=e.sprite.height;e.drawTextureWithSizeGrid(this.texture,this.x*i,this.y*s,this.width*i,this.height*s,a,t,r,this.color)}else e.drawTextureWithSizeGrid(this.texture,this.x,this.y,this.width,this.height,a,t,r,this.color)}}get cmdID(){return Draw9GridTextureCmd.ID}getBoundPoints(e){let t=this.x,r=this.y,a=this.width,i=this.height;return this.percent&&(t*=e.width,r*=e.height,a*=e.width,i*=e.height),[t,r,a,r,a,i,t,i]}}Draw9GridTextureCmd.ID="Draw9GridTexture";const Re=[0,0,0,0,0];ClassUtils.regClass("Draw9GridTextureCmd",Draw9GridTextureCmd);class SaveCmd{static create(){return Pool.getItemByClass("SaveCmd",SaveCmd)}recover(){Pool.recover("SaveCmd",this)}run(e,t,r){e.save()}get cmdID(){return SaveCmd.ID}}SaveCmd.ID="Save";const be=new Matrix,Ce=new Matrix,ve=[];class GraphicsBounds{constructor(){this._cacheBoundsType=!1}destroy(){this._graphics=null,this._cacheBoundsType=!1,this._temp&&(this._temp.length=0),this._rstBoundPoints&&(this._rstBoundPoints.length=0),this._bounds&&this._bounds.recover(),this._bounds=null,Pool.recover("GraphicsBounds",this)}static create(){return Pool.getItemByClass("GraphicsBounds",GraphicsBounds)}reset(){this._temp&&(this._temp.length=0)}getBounds(e=!1){return(!this._bounds||!this._temp||this._temp.length<1||e!=this._cacheBoundsType)&&(this._bounds=Rectangle._getWrapRec(this.getBoundPoints(e),this._bounds)),this._cacheBoundsType=e,this._bounds}getBoundPoints(e=!1){return(!this._temp||this._temp.length<1||e!=this._cacheBoundsType)&&(this._temp=this._getCmdPoints(e)),this._cacheBoundsType=e,this._rstBoundPoints=Utils.copyArray(this._rstBoundPoints,this._temp)}_getCmdPoints(e=!1){let t=this._graphics.cmds,r=this._graphics._sp;this._affectBySize=!1;let a=this._temp||(this._temp=[]);if(a.length=0,0==t.length)return a;let i=ve;i.length=0;let s=Ce;s.identity();let n=be;for(let e=0,o=t.length;e<o;e++){let o=t[e];switch(o.percent&&(this._affectBySize=!0),o.cmdID){case AlphaCmd.ID:case SaveCmd.ID:i.push(s),s=s.clone();break;case RestoreCmd.ID:s=i.pop();break;case ScaleCmd.ID:n.identity(),n.translate(-o.pivotX,-o.pivotY),n.scale(o.scaleX,o.scaleY),n.translate(o.pivotX,o.pivotY),this._switchMatrix(s,n);break;case RotateCmd.ID:n.identity(),n.translate(-o.pivotX,-o.pivotY),n.rotate(o.angle),n.translate(o.pivotX,o.pivotY),this._switchMatrix(s,n);break;case TranslateCmd.ID:n.identity(),n.translate(o.tx,o.ty),this._switchMatrix(s,n);break;case TransformCmd.ID:n.identity(),n.translate(-o.pivotX,-o.pivotY),n.concat(o.matrix),n.translate(o.pivotX,o.pivotY),this._switchMatrix(s,n);break;case DrawImageCmd.ID:case FillTextureCmd.ID:addPointArrToRst(a,Rectangle._getBoundPointS(o.x,o.y,o.width,o.height),s);break;case DrawTextureCmd.ID:s.copyTo(n),o.matrix&&n.concat(o.matrix),addPointArrToRst(a,Rectangle._getBoundPointS(o.x,o.y,o.width,o.height),n);break;case DrawRectCmd.ID:case DrawCircleCmd.ID:case DrawLineCmd.ID:addPointArrToRst(a,o.getBoundPoints(r),s);break;case DrawCurvesCmd.ID:addPointArrToRst(a,o.getBoundPoints(r),s,o.x,o.y);break;case DrawLinesCmd.ID:case DrawPolyCmd.ID:addPointArrToRst(a,o.points,s,o.x,o.y);break;case DrawPathCmd.ID:addPointArrToRst(a,o.getBoundPoints(r),s,o.x,o.y);break;case DrawPieCmd.ID:case DrawTrianglesCmd.ID:case Draw9GridTextureCmd.ID:addPointArrToRst(a,o.getBoundPoints(r),s)}}return a.length>200?a=Utils.copyArray(a,Rectangle._getWrapRec(a)._getBoundPoints()):a.length>8&&(a=GrahamScan.scanPList(a)),a}_switchMatrix(e,t){t.concat(e),t.copyTo(e)}}function addPointArrToRst(e,t,r,a=0,i=0){let s=t.length;for(let n=0;n<s;n+=2)addPointToRst(e,t[n]+a,t[n+1]+i,r)}function addPointToRst(e,t,r,a){var i=Point.TEMP;i.setTo(t||0,r||0),a.transformPoint(i),e.push(i.x,i.y)}class ClipRectCmd{static create(e,t,r,a){var i=Pool.getItemByClass("ClipRectCmd",ClipRectCmd);return i.x=e,i.y=t,i.width=r,i.height=a,i}recover(){Pool.recover("ClipRectCmd",this)}run(e,t,r){e.clipRect(this.x+t,this.y+r,this.width,this.height)}get cmdID(){return ClipRectCmd.ID}}ClipRectCmd.ID="ClipRect";class DrawTexturesCmd{static create(e,t,r){var a=Pool.getItemByClass("DrawTexturesCmd",DrawTexturesCmd);return a.texture=e,e._addReference(),a.pos=t,a.colors=r||[],a}recover(){this.texture._removeReference(),this.texture=null,this.pos=null,Pool.recover("DrawTexturesCmd",this)}run(e,t,r){e.drawTextures(this.texture,this.pos,t,r,this.colors)}get cmdID(){return DrawTexturesCmd.ID}}DrawTexturesCmd.ID="DrawTextures";class FillTextCmd{constructor(){this.x=0,this.y=0,this._strokeColor="#000000"}set text(e){this._text=e}get text(){return this._text}set strokeColor(e){this._strokeColor=e}get strokeColor(){return this._strokeColor}set stroke(e){this._stroke=e}get stroke(){return this._stroke}set align(e){this._align=e}get align(){return this._align}static create(e,t,r,a,i,s,n,o){var l=Pool.getItemByClass("FillTextCmd",FillTextCmd);switch(l._text=null,l._wordText=null,l.x=t,l.y=r,l.font=a,l.color=i,l._stroke=n,l._strokeColor=o,s){case"center":l._align=Const.ENUM_TEXTALIGN_CENTER;break;case"right":l._align=Const.ENUM_TEXTALIGN_RIGHT;break;default:l._align=Const.ENUM_TEXTALIGN_DEFAULT}return e instanceof WordText?(l._wordText=e,e.cleanCache()):l._text=e,l}recover(){Pool.recover("FillTextCmd",this)}run(e,t,r){ILaya.stage.isGlobalRepaint()&&this._wordText&&this._wordText.cleanCache(),null==this._text&&(this._text=""),null==this._fontObj&&(this.font=null),null==this._color&&(this._color="#ffffff"),e._fast_filltext(this._wordText||this._text,this.x+t,this.y+r,this._fontObj,this._color,this._strokeColor,this._stroke,this._align)}get cmdID(){return FillTextCmd.ID}get font(){return this._font}set font(e){this._font=e,e||(e=Config.defaultFontSize+"px "+Config.defaultFont),this._fontObj=FontInfo.parse(e),this._wordText&&this._wordText.cleanCache()}get color(){return this._color}set color(e){this._color=e,this._wordText&&this._wordText.cleanCache()}}FillTextCmd.ID="FillText",ClassUtils.regClass("FillTextCmd",FillTextCmd);class CacheManger{constructor(){}static regCacheByFunction(e,t){var r;CacheManger.unRegCacheByFunction(e,t),r={tryDispose:e,getCacheList:t},CacheManger._cacheList.push(r)}static unRegCacheByFunction(e,t){var r,a;for(a=CacheManger._cacheList.length,r=0;r<a;r++)if(CacheManger._cacheList[r].tryDispose==e&&CacheManger._cacheList[r].getCacheList==t)return void CacheManger._cacheList.splice(r,1)}static forceDispose(){var e,t=CacheManger._cacheList.length;for(e=0;e<t;e++)CacheManger._cacheList[e].tryDispose(!0)}static beginCheck(e=15e3){ILaya.systemTimer.loop(e,null,CacheManger._checkLoop)}static stopCheck(){ILaya.systemTimer.clear(null,CacheManger._checkLoop)}static _checkLoop(){var e=CacheManger._cacheList;if(!(e.length<1)){var t,r,a=ILaya.Browser.now();for(r=t=e.length;t>0&&(CacheManger._index++,CacheManger._index=CacheManger._index%r,e[CacheManger._index].tryDispose(!1),!(ILaya.Browser.now()-a>CacheManger.loopTimeLimit));)t--}}}CacheManger.loopTimeLimit=2,CacheManger._cacheList=[],CacheManger._index=0;class VectorGraphManager{constructor(){this.useDic={},this.shapeDic={},this.shapeLineDic={},this._id=0,this._checkKey=!1,this._freeIdArray=[],CacheManger.regCacheByFunction(this.startDispose.bind(this),this.getCacheList.bind(this))}static getInstance(){return VectorGraphManager.instance=VectorGraphManager.instance||new VectorGraphManager}getId(){return this._id++}addShape(e,t){this.shapeDic[e]=t,this.useDic[e]||(this.useDic[e]=!0)}addLine(e,t){this.shapeLineDic[e]=t,this.shapeLineDic[e]||(this.shapeLineDic[e]=!0)}getShape(e){this._checkKey&&null!=this.useDic[e]&&(this.useDic[e]=!0)}deleteShape(e){this.shapeDic[e]&&(this.shapeDic[e]=null,delete this.shapeDic[e]),this.shapeLineDic[e]&&(this.shapeLineDic[e]=null,delete this.shapeLineDic[e]),null!=this.useDic[e]&&delete this.useDic[e]}getCacheList(){var e,t=[];for(e in this.shapeDic)t.push(this.shapeDic[e]);for(e in this.shapeLineDic)t.push(this.shapeLineDic[e]);return t}startDispose(e){var t;for(t in this.useDic)this.useDic[t]=!1;this._checkKey=!0}endDispose(){if(this._checkKey){var e;for(e in this.useDic)this.useDic[e]||this.deleteShape(e);this._checkKey=!1}}}class DrawEllipseCmd{constructor(){this.lineWidth=0}static create(e,t,r,a,i,s,n,o){var l=Pool.getItemByClass("DrawEllipseCmd",DrawEllipseCmd);return l.x=e,l.y=t,l.width=r,l.height=a,l.fillColor=i,l.lineColor=s,l.lineWidth=n,l.percent=o,l}recover(){this.fillColor=null,this.lineColor=null,Pool.recover("DrawEllipseCmd",this)}run(e,t,r){let a=this.lineWidth>=1&&this.lineColor?this.lineWidth/2:0;if(this.percent&&e.sprite){let i=e.sprite.width,s=e.sprite.height;e._drawEllipse(this.x*i+t,this.y*s+r,this.width*i-a,this.height*s-a,this.fillColor,this.lineColor,this.lineWidth)}else e._drawEllipse(this.x+t,this.y+r,this.width-a,this.height-a,this.fillColor,this.lineColor,this.lineWidth)}get cmdID(){return DrawEllipseCmd.ID}getBoundPoints(e){return Rectangle._getBoundPointS(this.x-this.width,this.y-this.height,2*this.width,2*this.height,this.percent?e:null)}}DrawEllipseCmd.ID="DrawEllipse",ClassUtils.regClass("DrawEllipseCmd",DrawEllipseCmd);class DrawRoundRectCmd{constructor(){this.lineWidth=0}static create(e,t,r,a,i,s,n,o,l,h,u,d){var _=Pool.getItemByClass("DrawRoundRectCmd",DrawRoundRectCmd);return _.x=e,_.y=t,_.width=r,_.height=a,_.lt=i,_.rt=s,_.lb=n,_.rb=o,_.fillColor=l,_.lineColor=h,_.lineWidth=u,_.percent=d,_}recover(){this.fillColor=null,this.lineColor=null,Pool.recover("DrawRoundRectCmd",this)}run(e,t,r){let a=this.lineWidth>=1&&this.lineColor?this.lineWidth/2:0,i=this.lineColor?this.lineWidth:0;if(this.percent&&e.sprite){let s=e.sprite.width,n=e.sprite.height;e._drawRoundRect(this.x*s+a+t,this.y*n+a+r,this.width*s-i,this.height*n-i,this.lt,this.rt,this.lb,this.rb,this.fillColor,this.lineColor,this.lineWidth)}else e._drawRoundRect(this.x+a+t,this.y+a+r,this.width-i,this.height-i,this.lt,this.rt,this.lb,this.rb,this.fillColor,this.lineColor,this.lineWidth)}get cmdID(){return DrawRoundRectCmd.ID}getBoundPoints(e){return Rectangle._getBoundPointS(this.x,this.y,this.width,this.height,this.percent?e:null)}}DrawRoundRectCmd.ID="DrawRoundRect",ClassUtils.regClass("DrawRoundRectCmd",DrawRoundRectCmd);class Graphics{static add2DGlobalUniformData(e,t,r){LayaGL.renderOBJCreate.createGlobalUniformMap("Sprite2DGlobal").addShaderUniform(e,t,r)}static get globalShaderData(){return Value2D.globalShaderData}constructor(){this._sp=null,this._render=this._renderEmpty,this._cmds=[],this._vectorgraphArray=null,this._graphicBounds=null,this._createData()}_createData(){}_clearData(){}_destroyData(){}destroy(){this.clear(!0),this._graphicBounds&&this._graphicBounds.destroy(),this._graphicBounds=null,this._vectorgraphArray=null,this._sp&&(this._sp._renderType=0,this._sp=null),this._destroyData()}clear(e=!0){if(e)for(let e=0,t=this._cmds.length;e<t;e++)this._cmds[e].recover();if(this._cmds.length=0,this._render=this._renderEmpty,this._clearData(),this._sp&&(this._sp._renderType&=~SpriteConst.GRAPHICS),this._repaint(),this._vectorgraphArray){for(let e=0,t=this._vectorgraphArray.length;e<t;e++)VectorGraphManager.getInstance().deleteShape(this._vectorgraphArray[e]);this._vectorgraphArray.length=0}}_clearBoundsCache(e){this._graphicBounds&&(e&&!this._graphicBounds._affectBySize||this._graphicBounds.reset())}_initGraphicBounds(){this._graphicBounds||(this._graphicBounds=GraphicsBounds.create(),this._graphicBounds._graphics=this)}_repaint(){this._clearBoundsCache(),this._sp&&this._sp.repaint()}_isOnlyOne(){return 1===this._cmds.length}get cmds(){return this._cmds}set cmds(e){this._sp&&(this._sp._renderType|=SpriteConst.GRAPHICS),this._cmds=e;let t=e.length;this._render=0===t?this._renderEmpty:1===t?this._renderOne:this._renderAll,this._repaint()}addCmd(e){if(null!=e)return this._sp&&(this._sp._renderType|=SpriteConst.GRAPHICS),this._cmds.push(e),this._render=1===this._cmds.length?this._renderOne:this._renderAll,this._repaint(),e;console.warn("null cmd")}removeCmd(e){let t=this.cmds.indexOf(e);if(-1!=t){this._cmds.splice(t,1);let e=this._cmds.length;this._render=0===e?this._renderEmpty:1===e?this._renderOne:this._renderAll,this._repaint()}}getBounds(e=!1){return this._initGraphicBounds(),this._graphicBounds.getBounds(e)}getBoundPoints(e=!1){return this._initGraphicBounds(),this._graphicBounds.getBoundPoints(e)}get material(){return this._material}set material(e){this._material!=e&&(this._material&&this._material._removeReference(),this._material=e,null!=e&&e._addReference())}drawImage(e,t=0,r=0,a=null,i=null,s=null){return e&&e.bitmap?this.addCmd(DrawImageCmd.create(e,t,r,a,i,s)):null}drawTexture(e,t=0,r=0,a=null,i=null,s=null,n=1,o=null,l=null,h){return!e||n<.01?null:e.bitmap?this.addCmd(DrawTextureCmd.create(e,t,r,a,i,s,n,o,l,h)):null}drawTextures(e,t,r){return e?this.addCmd(DrawTexturesCmd.create(e,t,r)):null}drawTriangles(e,t,r,a,i,s,n=null,o=1,l=null,h=null){return this.addCmd(DrawTrianglesCmd.create(e,t,r,a,i,s,n,o,l,h))}fillTexture(e,t,r,a=0,i=0,s="repeat",n=null,o=null){return e&&e.bitmap?this.addCmd(FillTextureCmd.create(e,t,r,a,i,s,n||Point.EMPTY,o)):null}clipRect(e,t,r,a){return this.addCmd(ClipRectCmd.create(e,t,r,a))}fillText(e,t,r,a,i,s){return this.addCmd(FillTextCmd.create(e,t,r,a,i,s,0,""))}fillBorderText(e,t,r,a,i,s,n,o){return this.addCmd(FillTextCmd.create(e,t,r,a,i,s,n,o))}strokeText(e,t,r,a,i,s,n){return this.addCmd(FillTextCmd.create(e,t,r,a,null,n,s,i))}alpha(e){return this.addCmd(AlphaCmd.create(e))}transform(e,t=0,r=0){return this.addCmd(TransformCmd.create(e,t,r))}rotate(e,t=0,r=0){return this.addCmd(RotateCmd.create(e,t,r))}scale(e,t,r=0,a=0){return this.addCmd(ScaleCmd.create(e,t,r,a))}translate(e,t){return this.addCmd(TranslateCmd.create(e,t))}save(){return this.addCmd(SaveCmd.create())}restore(){return this.addCmd(RestoreCmd.create())}replaceTextColor(e){this._repaint();let t=this._cmds;for(let r=t.length-1;r>-1;r--){let a=t[r];switch(a.cmdID){case FillTextCmd.ID:a.color=e;break;case DrawImageCmd.ID:a.color=null!=e?ColorUtils.create(e).numColor:4294967295}}}loadImage(e,t=0,r=0,a=null,i=null,s=null){let n=ILaya.loader.getRes(e);n?(this.drawImage(n,t,r,a,i),s&&s.call(this._sp)):ILaya.loader.load(e).then((e=>{this.drawImage(e,t,r,a,i),s&&s.call(this._sp)}))}_renderEmpty(e,t,r,a){}_renderAll(e,t,r,a){t.sprite=e,t.material=this._material;var i=this._cmds;for(let e=0,s=i.length;e<s;e++)i[e].run(t,r,a);t.material=null}_renderOne(e,t,r,a){t.sprite=e,t.material=this._material,this._cmds[0].run(t,r,a),t.material=null}drawLine(e,t,r,a,i,s=1){return this.addCmd(DrawLineCmd.create(e,t,r,a,i,s))}drawLines(e,t,r,a,i=1){return!r||r.length<4?null:this.addCmd(DrawLinesCmd.create(e,t,r,a,i))}drawCurves(e,t,r,a,i=1){return this.addCmd(DrawCurvesCmd.create(e,t,r,a,i))}drawRect(e,t,r,a,i,s=null,n=1,o){return this.addCmd(DrawRectCmd.create(e,t,r,a,i,s,n,o))}drawRoundRect(e,t,r,a,i,s,n,o,l,h=null,u=1,d){return this.addCmd(DrawRoundRectCmd.create(e,t,r,a,i,s,n,o,l,h,u,d))}drawCircle(e,t,r,a,i=null,s=1){return this.addCmd(DrawCircleCmd.create(e,t,r,a,i,s))}drawEllipse(e,t,r,a,i,s,n,o){return this.addCmd(DrawEllipseCmd.create(e,t,r,a,i,s,n,o))}drawPie(e,t,r,a,i,s,n=null,o=1){return this.addCmd(DrawPieCmd.create(e,t,r,Utils.toRadian(a),Utils.toRadian(i),s,n,o))}drawPoly(e,t,r,a,i=null,s=1){return this.addCmd(DrawPolyCmd.create(e,t,r,a,i,s))}drawPath(e,t,r,a=null,i=null){return this.addCmd(DrawPathCmd.create(e,t,r,a,i))}draw9Grid(e,t=0,r=0,a=0,i=0,s,n){this.addCmd(Draw9GridTextureCmd.create(e,t,r,a,i,s,!1,n))}}const De=[];class Node extends EventDispatcher{get url(){return this._url}set url(e){this._url=e}get hideFlags(){return this._hideFlags}set hideFlags(e){this._hideFlags=e}get is3D(){return this._is3D}get destroyed(){return this._destroyed}constructor(){super(),this._bits=0,this._hideFlags=0,this._children=De,this._parent=null,this._destroyed=!1,this.name="",this._initialize()}_initialize(){this._extra={}}_setBit(e,t){e===NodeFlags.DISPLAY&&(this._getBit(e)!=t&&this._updateDisplayedInstage());t?this._bits|=e:this._bits&=~e}_getBit(e){return 0!=(this._bits&e)}_setUpNoticeChain(){this._getBit(NodeFlags.DISPLAY)&&this._setBitUp(NodeFlags.DISPLAY)}_setBitUp(e){var t=this;for(t._setBit(e,!0),t=t._parent;t;){if(t._getBit(e))return;t._setBit(e,!0),t=t._parent}}onStartListeningToType(e){e!==Event.DISPLAY&&e!==Event.UNDISPLAY||this._getBit(NodeFlags.DISPLAY)||this._setBitUp(NodeFlags.DISPLAY)}bubbleEvent(e,t){let r=Me.length>0?Me.pop():[];r.length=0;let a=this;for(;a;)a.activeInHierarchy&&r.push(a),a=a.parent;if(t instanceof Event){t._stopped=!1;for(let a of r)if(t.setTo(e,a,this),a.event(e,t),t._stopped)break}else for(let a of r)a.event(e,t);Me.push(r)}hasHideFlag(e){return 0!=(this._hideFlags&e)}destroy(e=!0){this._destroyed=!0,this.destroyAllComponent(),this._parent&&this._parent.removeChild(this),this._children&&(e?this.destroyChildren():this.removeChildren()),this.onDestroy(),this._children=null,this.offAll()}onDestroy(){}destroyChildren(){if(this._children)for(let e=0,t=this._children.length;e<t;e++)this._children[0]&&this._children[0].destroy(!0)}addChild(e){if(!e||this._destroyed||e===this)return e;if(e._zOrder&&this._setBit(NodeFlags.HAS_ZORDER,!0),e._parent===this){var t=this.getChildIndex(e);t!==this._children.length-1&&(this._children.splice(t,1),this._children.push(e),this._childChanged())}else e._parent&&e._parent.removeChild(e),this._children===De&&(this._children=[]),this._children.push(e),e._setParent(this);return e}addChildren(...e){for(var t=0,r=e.length;t<r;)this.addChild(e[t++])}addChildAt(e,t){if(!e||this._destroyed||e===this)return e;if(e._zOrder&&this._setBit(NodeFlags.HAS_ZORDER,!0),t>=0&&t<=this._children.length){if(e._parent===this){var r=this.getChildIndex(e);this._children.splice(r,1),this._children.splice(t,0,e),this._childChanged()}else e._parent&&e._parent.removeChild(e),this._children===De&&(this._children=[]),this._children.splice(t,0,e),e._setParent(this);return e}throw new Error("appendChildAt:The index is out of bounds")}getChildIndex(e){return this._children.indexOf(e)}getChildByName(e){for(let t of this._children)if(t&&t.name===e)return t;return null}getChildAt(e){return this._children[e]||null}setChildIndex(e,t){var r=this._children;if(t<0||t>=r.length)throw new Error("setChildIndex:The index is out of bounds.");var a=this.getChildIndex(e);if(a<0)throw new Error("setChildIndex:node is must child of this object.");return r.splice(a,1),r.splice(t,0,e),this._childChanged(),e}_childChanged(e=null){}removeChild(e){if(!this._children)return e;var t=this._children.indexOf(e);return this.removeChildAt(t)}removeSelf(){return this._parent&&this._parent.removeChild(this),this}removeChildByName(e){var t=this.getChildByName(e);return t&&this.removeChild(t),t}removeChildAt(e){var t=this.getChildAt(e);return t&&(this._children.splice(e,1),t._setParent(null)),t}removeChildren(e=0,t=2147483647){if(this._children&&this._children.length>0){var r=this._children;if(0===e&&t>=r.length-1){var a=r;this._children=De}else a=r.splice(e,t-e+1);for(var i=0,s=a.length;i<s;i++)a[i]._setParent(null)}return this}replaceChild(e,t){var r=this._children.indexOf(t);return r>-1?(this._children.splice(r,1,e),t._setParent(null),e._setParent(this),e):null}get numChildren(){return this._children?this._children.length:0}get parent(){return this._parent}isAncestorOf(e){let t=e.parent;for(;t;){if(t==this)return!0;t=t.parent}return!1}_setParent(e){if(this._parent!==e)if(e)this._parent=e,this._onAdded(),this.event(Event.ADDED),this._getBit(NodeFlags.DISPLAY)&&(this._setUpNoticeChain(),e.displayedInStage&&this._displayChild(this,!0)),e._childChanged(this);else{this._onRemoved(),this.event(Event.REMOVED);let t=this._parent;this._getBit(NodeFlags.DISPLAY)&&this._displayChild(this,!1),this._parent=e,t._childChanged(this)}}get displayedInStage(){return this._getBit(NodeFlags.DISPLAY)||this._setBitUp(NodeFlags.DISPLAY),this._getBit(NodeFlags.DISPLAYED_INSTAGE)}_updateDisplayedInstage(){var e;e=this;for(var t=ILaya.stage,r=!1;e;){if(e._getBit(NodeFlags.DISPLAY)){r=e._getBit(NodeFlags.DISPLAYED_INSTAGE);break}if(e===t||e._getBit(NodeFlags.DISPLAYED_INSTAGE)){r=!0;break}e=e._parent}this._setBit(NodeFlags.DISPLAYED_INSTAGE,r)}_setDisplay(e){this._getBit(NodeFlags.DISPLAYED_INSTAGE)!==e&&(this._setBit(NodeFlags.DISPLAYED_INSTAGE,e),e?this.event(Event.DISPLAY):this.event(Event.UNDISPLAY))}_displayChild(e,t){var r=e._children;if(r)for(var a=0,i=r.length;a<i;a++){var s=r[a];s&&(s._getBit(NodeFlags.DISPLAY)&&(s._children.length>0?this._displayChild(s,t):s._setDisplay(t)))}e._setDisplay(t)}contains(e){if(e===this)return!0;for(;e;){if(e._parent===this)return!0;e=e._parent}return!1}timerLoop(e,t,r,a=null,i=!0,s=!1){this.timer.loop(e,t,r,a,i,s)}timerOnce(e,t,r,a=null,i=!0){this.timer._create(!1,!1,e,t,r,a,i)}frameLoop(e,t,r,a=null,i=!0){this.timer._create(!0,!0,e,t,r,a,i)}frameOnce(e,t,r,a=null,i=!0){this.timer._create(!0,!1,e,t,r,a,i)}clearTimer(e,t){this.timer.clear(e,t)}callLater(e,t=null){this.timer.callLater(this,e,t)}runCallLater(e){this.timer.runCallLater(this,e)}get scene(){return this._scene}get active(){return!this._getBit(NodeFlags.NOT_READY)&&!this._getBit(NodeFlags.NOT_ACTIVE)}set active(e){if(e=!!e,!this._getBit(NodeFlags.NOT_ACTIVE)!==e){if(this._activeChangeScripts&&0!==this._activeChangeScripts.length)throw e?"Node: can't set the main inActive node active in hierarchy,if the operate is in main inActive node or it's children script's onDisable Event.":"Node: can't set the main active node inActive in hierarchy,if the operate is in main active node or it's children script's onEnable Event.";this._setBit(NodeFlags.NOT_ACTIVE,!e),this._parent&&this._parent.activeInHierarchy&&this._processActive(e,!0)}}get activeInHierarchy(){return this._getBit(NodeFlags.ACTIVE_INHIERARCHY)}_onActive(){Stat.spriteCount++}_onInActive(){Stat.spriteCount--}_onActiveInScene(){this.event(Node.EVENT_SET_ACTIVESCENE,this._scene)}_onInActiveInScene(){this.event(Node.EVENT_SET_IN_ACTIVESCENE,this._scene)}onAwake(){}onEnable(){}onDisable(){}_parse(e,t){}_setBelongScene(e){if(!this._scene||this.scene!=e){this._scene=e,this._onActiveInScene();for(let t=0,r=this._children.length;t<r;t++)this._children[t]._setBelongScene(e)}}_setUnBelongScene(){if(this._scene!==this){this._onInActiveInScene(),this._scene=null;for(let e=0,t=this._children.length;e<t;e++)this._children[e]._setUnBelongScene()}}_processActive(e,t){this._activeChangeScripts||(this._activeChangeScripts=[]);let r=this._activeChangeScripts;e?this._activeHierarchy(r,t):this._inActiveHierarchy(r,t);for(let t=0,a=r.length;t<a;t++){let a=r[t];a.owner&&a._setActive(e)}r.length=0}_activeHierarchy(e,t){if(this._setBit(NodeFlags.ACTIVE_INHIERARCHY,!0),this._components)for(let t=0,r=this._components.length;t<r;t++){let r=this._components[t];r._isScript()?r._enabled&&e.push(r):r._setActive(!0)}this._onActive();for(let r=0,a=this._children.length;r<a;r++){let a=this._children[r];!a._getBit(NodeFlags.NOT_ACTIVE)&&!a._getBit(NodeFlags.NOT_READY)&&a._activeHierarchy(e,t)}this._getBit(NodeFlags.AWAKED)||(this._setBit(NodeFlags.AWAKED,!0),this.onAwake()),this.onEnable()}_inActiveHierarchy(e,t){if(this._onInActive(),this._components)for(let t=0,r=this._components.length;t<r;t++){let r=this._components[t];r._isScript()?r._enabled&&e.push(r):r._setActive(!1)}this._setBit(NodeFlags.ACTIVE_INHIERARCHY,!1);for(let r=0,a=this._children.length;r<a;r++){let a=this._children[r];a&&!a._getBit(NodeFlags.NOT_ACTIVE)&&a._inActiveHierarchy(e,t)}this.onDisable()}_onAdded(){if(this._activeChangeScripts&&0!==this._activeChangeScripts.length)throw"Node: can't set the main inActive node active in hierarchy,if the operate is in main inActive node or it's children script's onDisable Event.";{let e=this._parent.scene;e&&this._setBelongScene(e),this._parent.activeInHierarchy&&this.active&&this._processActive(!0)}}_onRemoved(){if(this._activeChangeScripts&&0!==this._activeChangeScripts.length)throw"Node: can't set the main active node inActive in hierarchy,if the operate is in main active node or it's children script's onEnable Event.";this._parent.activeInHierarchy&&this.active&&this._processActive(!1),this._parent.scene&&this._setUnBelongScene()}_addComponentInstance(e){var t;this._components||(this._components=[]),this._components.push(e),e._setOwner(this),this.activeInHierarchy&&e._setActive(!0),null===(t=this._componentsChanged)||void 0===t||t.call(this,e,0)}_destroyComponent(e){var t;if(!this._components)return;let r=this._components.indexOf(e);-1!=r&&(this._components.splice(r,1),e._destroy(),null===(t=this._componentsChanged)||void 0===t||t.call(this,e,1))}destroyAllComponent(){var e;if(this._components){for(let e=0,t=this._components.length;e<t;e++){let t=this._components[e];t&&!t.destroyed&&t._destroy()}this._components.length=0,null===(e=this._componentsChanged)||void 0===e||e.call(this,null,2)}}_cloneTo(e,t,r){var a=e;if(this._components)for(let e=0,t=this._components.length;e<t;e++){var i=a.addComponent(this._components[e].constructor);this._components[e]._cloneTo(i)}}addComponentInstance(e){if(e.owner)throw"Node:the component has belong to other node.";return e._singleton&&this.getComponent(e.constructor)?console.warn("Node:the component is singleton, can't add the second one.",e):this._addComponentInstance(e),e}addComponent(e){let t=Pool.createByClass(e);if(!t)throw"missing "+e.toString();return t._singleton&&this.getComponent(e)?console.warn("Node:the component is singleton, can't add the second one.",t):this._addComponentInstance(t),t}getComponent(e){if(this._components)for(let t=0,r=this._components.length;t<r;t++){let r=this._components[t];if(r instanceof e)return r}return null}get components(){return this._components||De}getComponents(e){var t;if(this._components)for(let r=0,a=this._components.length;r<a;r++){let a=this._components[r];a instanceof e&&(t=t||[]).push(a)}return t}get timer(){return this._scene?this._scene.timer:ILaya.timer}onAfterDeserialize(){}}Node.EVENT_SET_ACTIVESCENE="ActiveScene",Node.EVENT_SET_IN_ACTIVESCENE="InActiveScene";const Me=[],Ae=.5*Math.PI,Le=2*Math.PI;class Ease{static linearNone(e,t,r,a){return r*e/a+t}static linearIn(e,t,r,a){return r*e/a+t}static linearInOut(e,t,r,a){return r*e/a+t}static linearOut(e,t,r,a){return r*e/a+t}static bounceIn(e,t,r,a){return r-Ease.bounceOut(a-e,0,r,a)+t}static bounceInOut(e,t,r,a){return e<.5*a?.5*Ease.bounceIn(2*e,0,r,a)+t:.5*Ease.bounceOut(2*e-a,0,r,a)+.5*r+t}static bounceOut(e,t,r,a){return(e/=a)<1/2.75?r*(7.5625*e*e)+t:e<2/2.75?r*(7.5625*(e-=1.5/2.75)*e+.75)+t:e<2.5/2.75?r*(7.5625*(e-=2.25/2.75)*e+.9375)+t:r*(7.5625*(e-=2.625/2.75)*e+.984375)+t}static backIn(e,t,r,a,i=1.70158){return r*(e/=a)*e*((i+1)*e-i)+t}static backInOut(e,t,r,a,i=1.70158){return(e/=.5*a)<1?.5*r*(e*e*((1+(i*=1.525))*e-i))+t:r/2*((e-=2)*e*((1+(i*=1.525))*e+i)+2)+t}static backOut(e,t,r,a,i=1.70158){return r*((e=e/a-1)*e*((i+1)*e+i)+1)+t}static elasticIn(e,t,r,a,i=0,s=0){var n;return 0==e?t:1==(e/=a)?t+r:(s||(s=.3*a),!i||r>0&&i<r||r<0&&i<-r?(i=r,n=s/4):n=s/Le*Math.asin(r/i),-i*Math.pow(2,10*(e-=1))*Math.sin((e*a-n)*Le/s)+t)}static elasticInOut(e,t,r,a,i=0,s=0){var n;return 0==e?t:2==(e/=.5*a)?t+r:(s||(s=a*(.3*1.5)),!i||r>0&&i<r||r<0&&i<-r?(i=r,n=s/4):n=s/Le*Math.asin(r/i),e<1?i*Math.pow(2,10*(e-=1))*Math.sin((e*a-n)*Le/s)*-.5+t:i*Math.pow(2,-10*(e-=1))*Math.sin((e*a-n)*Le/s)*.5+r+t)}static elasticOut(e,t,r,a,i=0,s=0){var n;return 0==e?t:1==(e/=a)?t+r:(s||(s=.3*a),!i||r>0&&i<r||r<0&&i<-r?(i=r,n=s/4):n=s/Le*Math.asin(r/i),i*Math.pow(2,-10*e)*Math.sin((e*a-n)*Le/s)+r+t)}static strongIn(e,t,r,a){return r*(e/=a)*e*e*e*e+t}static strongInOut(e,t,r,a){return(e/=.5*a)<1?.5*r*e*e*e*e*e+t:.5*r*((e-=2)*e*e*e*e+2)+t}static strongOut(e,t,r,a){return r*((e=e/a-1)*e*e*e*e+1)+t}static sineInOut(e,t,r,a){return.5*-r*(Math.cos(Math.PI*e/a)-1)+t}static sineIn(e,t,r,a){return-r*Math.cos(e/a*Ae)+r+t}static sineOut(e,t,r,a){return r*Math.sin(e/a*Ae)+t}static quintIn(e,t,r,a){return r*(e/=a)*e*e*e*e+t}static quintInOut(e,t,r,a){return(e/=.5*a)<1?.5*r*e*e*e*e*e+t:.5*r*((e-=2)*e*e*e*e+2)+t}static quintOut(e,t,r,a){return r*((e=e/a-1)*e*e*e*e+1)+t}static quartIn(e,t,r,a){return r*(e/=a)*e*e*e+t}static quartInOut(e,t,r,a){return(e/=.5*a)<1?.5*r*e*e*e*e+t:.5*-r*((e-=2)*e*e*e-2)+t}static quartOut(e,t,r,a){return-r*((e=e/a-1)*e*e*e-1)+t}static cubicIn(e,t,r,a){return r*(e/=a)*e*e+t}static cubicInOut(e,t,r,a){return(e/=.5*a)<1?.5*r*e*e*e+t:.5*r*((e-=2)*e*e+2)+t}static cubicOut(e,t,r,a){return r*((e=e/a-1)*e*e+1)+t}static quadIn(e,t,r,a){return r*(e/=a)*e+t}static quadInOut(e,t,r,a){return(e/=.5*a)<1?.5*r*e*e+t:.5*-r*(--e*(e-2)-1)+t}static quadOut(e,t,r,a){return-r*(e/=a)*(e-2)+t}static expoIn(e,t,r,a){return 0==e?t:r*Math.pow(2,10*(e/a-1))+t-.001*r}static expoInOut(e,t,r,a){return 0==e?t:e==a?t+r:(e/=.5*a)<1?.5*r*Math.pow(2,10*(e-1))+t:.5*r*(2-Math.pow(2,-10*--e))+t}static expoOut(e,t,r,a){return e==a?t+r:r*(1-Math.pow(2,-10*e/a))+t}static circIn(e,t,r,a){return-r*(Math.sqrt(1-(e/=a)*e)-1)+t}static circInOut(e,t,r,a){return(e/=.5*a)<1?.5*-r*(Math.sqrt(1-e*e)-1)+t:.5*r*(Math.sqrt(1-(e-=2)*e)+1)+t}static circOut(e,t,r,a){return r*Math.sqrt(1-(e=e/a-1)*e)+t}}class Handler{constructor(e=null,t=null,r=null,a=!1){this.once=!1,this._id=0,this.setTo(e,t,r,a)}setTo(e,t,r,a=!1){return this._id=Handler._gid++,this.caller=e,this.method=t,this.args=r,this.once=a,this}run(){if(null==this.method)return null;var e=this._id,t=this.method.apply(this.caller,this.args);return this._id===e&&this.once&&this.recover(),t}runWith(e){if(null==this.method)return null;var t=this._id;if(null==e)var r=this.method.apply(this.caller,this.args);else r=this.args||e.unshift?this.args?this.method.apply(this.caller,this.args.concat(e)):this.method.apply(this.caller,e):this.method.call(this.caller,e);return this._id===t&&this.once&&this.recover(),r}clear(){return this.caller=null,this.method=null,this.args=null,this}recover(){this._id>0&&(this._id=0,Handler._pool.push(this.clear()))}static create(e,t,r=null,a=!0){return Handler._pool.length?Handler._pool.pop().setTo(e,t,r,a):new Handler(e,t,r,a)}}Handler._pool=[],Handler._gid=1;class Tween{constructor(){this.gid=0,this.repeat=1,this._count=0}static to(e,t,r,a=null,i=null,s=0,n=!1,o=!0){return Pool.getItemByClass("tween",Tween)._create(e,t,r,a,i,s,n,!0,o,!0)}static from(e,t,r,a=null,i=null,s=0,n=!1,o=!0){return Pool.getItemByClass("tween",Tween)._create(e,t,r,a,i,s,n,!1,o,!0)}to(e,t,r,a=null,i=null,s=0,n=!1){return this._create(e,t,r,a,i,s,n,!0,!1,!0)}from(e,t,r,a=null,i=null,s=0,n=!1){return this._create(e,t,r,a,i,s,n,!1,!1,!0)}_create(e,t,r,a,i,s,n,o,l,h){if(!e)throw new Error("Tween:target is null");this._target=e,this._duration=r,this._ease=a||t.ease||Tween.easeNone,this._complete=i||t.complete,this._delay=s,this._props=[],this._usedTimer=0,this._startTimer=Browser.now(),this._usedPool=l,this._delayParam=null,this.update=t.update;var u=e.$_GID||(e.$_GID=Utils.getGID());return Tween.tweenMap[u]?(n&&Tween.clearTween(e),Tween.tweenMap[u].push(this)):Tween.tweenMap[u]=[this],h?s<=0?this.firstStart(e,t,o):(this._delayParam=[e,t,o],ILaya.timer.once(s,this,this.firstStart,this._delayParam)):this._initProps(e,t,o),this}firstStart(e,t,r){this._delayParam=null,e.destroyed?this.clear():(this._initProps(e,t,r),this._beginLoop())}_initProps(e,t,r){for(var a in t)if("number"==typeof e[a]){var i=r?e[a]:t[a],s=r?t[a]:e[a];this._props.push([a,i,s-i]),r||(e[a]=i)}}_beginLoop(){ILaya.timer.frameLoop(1,this,this._doEase)}_doEase(){this._updateEase(Browser.now())}_updateEase(e){var t=this._target;if(t){if(t.destroyed)return Tween.clearTween(t);var r=this._usedTimer=e-this._startTimer-this._delay;if(!(r<0)){if(r>=this._duration)return this.complete();for(var a=r>0?this._ease(r,0,1,this._duration):0,i=this._props,s=0,n=i.length;s<n;s++){var o=i[s];t[o[0]]=o[1]+a*o[2]}this.update&&this.update.run()}}}set progress(e){var t=e*this._duration;this._startTimer=Browser.now()-this._delay-t}complete(){if(this._target){ILaya.timer.runTimer(this,this.firstStart);for(var e=this._target,t=this._props,r=this._complete,a=0,i=t.length;a<i;a++){var s=t[a];e[s[0]]=s[1]+s[2]}this.update&&this.update.run(),this._count++,0!=this.repeat&&this._count>=this.repeat?(this.clear(),r&&r.run()):this.restart()}}pause(){var e;ILaya.timer.clear(this,this._beginLoop),ILaya.timer.clear(this,this._doEase),ILaya.timer.clear(this,this.firstStart),(e=Browser.now()-this._startTimer-this._delay)<0&&(this._usedTimer=e)}setStartTime(e){this._startTimer=e}static clearAll(e){if(e&&e.$_GID){var t=Tween.tweenMap[e.$_GID];if(t){for(var r=0,a=t.length;r<a;r++)t[r]._clear();t.length=0}}}static clear(e){e.clear()}static clearTween(e){Tween.clearAll(e)}clear(){this._target&&(this._remove(),this._clear())}_clear(){this.pause(),ILaya.timer.clear(this,this.firstStart),this._complete=null,this._target=null,this._ease=null,this._props=null,this._delayParam=null,this.repeat=1,this._usedPool&&(this.update=null,Pool.recover("tween",this))}recover(){this._usedPool=!0,this._clear()}_remove(){var e=Tween.tweenMap[this._target.$_GID];if(e)for(var t=0,r=e.length;t<r;t++)if(e[t]===this){e.splice(t,1);break}}restart(){if(this.pause(),this._usedTimer=0,this._startTimer=Browser.now(),this._delayParam)ILaya.timer.once(this._delay,this,this.firstStart,this._delayParam);else{for(var e=this._props,t=0,r=e.length;t<r;t++){var a=e[t];this._target[a[0]]=a[1]}ILaya.timer.once(this._delay,this,this._beginLoop)}}resume(){this._usedTimer>=this._duration||(this._startTimer=Browser.now()-this._usedTimer-this._delay,this._delayParam?this._usedTimer<0?ILaya.timer.once(-this._usedTimer,this,this.firstStart,this._delayParam):this.firstStart.apply(this,this._delayParam):this._beginLoop())}static easeNone(e,t,r,a){return r*e/a+t}}Tween.tweenMap=[];class Dragging{constructor(){this.ratio=.92,this.maxOffset=60,this._dragging=!1,this._clickOnly=!0}start(e,t,r,a,i,s,n=.92){this.clearTimer(),this.target=e,this.area=t,this.hasInertia=r,this.elasticDistance=t?a:0,this.elasticBackTime=i,this.data=s,this.ratio=n,this._parent=e.parent,this._clickOnly=!0,this._dragging=!0,this._elasticRateX=this._elasticRateY=1,this._lastX=this._parent.mouseX,this._lastY=this._parent.mouseY,ILaya.stage.on(Event.MOUSE_UP,this,this.onStageMouseUp),ILaya.stage.on(Event.MOUSE_OUT,this,this.onStageMouseUp),ILaya.systemTimer.frameLoop(1,this,this.loop)}clearTimer(){ILaya.systemTimer.clear(this,this.loop),ILaya.systemTimer.clear(this,this.tweenMove),this._tween&&(this._tween.recover(),this._tween=null)}stop(){this._dragging&&(ILaya.stage.off(Event.MOUSE_UP,this,this.onStageMouseUp),ILaya.stage.off(Event.MOUSE_OUT,this,this.onStageMouseUp),this._dragging=!1,this.target&&this.area&&this.backToArea(),this.clear())}loop(){var e=this._parent.getMousePoint(),t=e.x,r=e.y,a=t-this._lastX,i=r-this._lastY;if(this._clickOnly){if(!(Math.abs(a*ILaya.stage._canvasTransform.getScaleX())>1||Math.abs(i*ILaya.stage._canvasTransform.getScaleY())>1))return;this._clickOnly=!1,this._offsets||(this._offsets=[]),this._offsets.length=0,this.target.event(Event.DRAG_START,this.data)}else this._offsets.push(a,i);0===a&&0===i||(this._lastX=t,this._lastY=r,this.target.x+=a*this._elasticRateX,this.target.y+=i*this._elasticRateY,this.area&&this.checkArea(),this.target.event(Event.DRAG_MOVE,this.data))}checkArea(){if(this.elasticDistance<=0)this.backToArea();else{if(this.target._x<this.area.x)var e=this.area.x-this.target._x;else e=this.target._x>this.area.x+this.area.width?this.target._x-this.area.x-this.area.width:0;if(this._elasticRateX=Math.max(0,1-e/this.elasticDistance),this.target._y<this.area.y)var t=this.area.y-this.target.y;else t=this.target._y>this.area.y+this.area.height?this.target._y-this.area.y-this.area.height:0;this._elasticRateY=Math.max(0,1-t/this.elasticDistance)}}backToArea(){this.target.x=Math.min(Math.max(this.target._x,this.area.x),this.area.x+this.area.width),this.target.y=Math.min(Math.max(this.target._y,this.area.y),this.area.y+this.area.height)}onStageMouseUp(e){if(ILaya.stage.off(Event.MOUSE_UP,this,this.onStageMouseUp),ILaya.stage.off(Event.MOUSE_OUT,this,this.onStageMouseUp),ILaya.systemTimer.clear(this,this.loop),!this._clickOnly&&this.target)if(this.hasInertia){this._offsets.length<1&&this._offsets.push(this._parent.mouseX-this._lastX,this._parent.mouseY-this._lastY),this._offsetX=this._offsetY=0;for(var t=this._offsets.length,r=Math.min(t,6),a=this._offsets.length-r,i=t-1;i>a;i--)this._offsetY+=this._offsets[i--],this._offsetX+=this._offsets[i];this._offsetX=this._offsetX/r*2,this._offsetY=this._offsetY/r*2,Math.abs(this._offsetX)>this.maxOffset&&(this._offsetX=this._offsetX>0?this.maxOffset:-this.maxOffset),Math.abs(this._offsetY)>this.maxOffset&&(this._offsetY=this._offsetY>0?this.maxOffset:-this.maxOffset),ILaya.systemTimer.frameLoop(1,this,this.tweenMove)}else this.elasticDistance>0?this.checkElastic():this.clear()}checkElastic(){var e=NaN,t=NaN;if(this.target.x<this.area.x?e=this.area.x:this.target._x>this.area.x+this.area.width&&(e=this.area.x+this.area.width),this.target.y<this.area.y?t=this.area.y:this.target._y>this.area.y+this.area.height&&(t=this.area.y+this.area.height),isNaN(e)&&isNaN(t))this.clear();else{var r={};isNaN(e)||(r.x=e),isNaN(t)||(r.y=t),this._tween=Tween.to(this.target,r,this.elasticBackTime,Ease.sineOut,Handler.create(this,this.clear),0,!1,!1)}}tweenMove(){this._offsetX*=this.ratio*this._elasticRateX,this._offsetY*=this.ratio*this._elasticRateY,this.target.x+=this._offsetX,this.target.y+=this._offsetY,this.area&&this.checkArea(),this.target.event(Event.DRAG_MOVE,this.data),(Math.abs(this._offsetX)<1&&Math.abs(this._offsetY)<1||this._elasticRateX<.5||this._elasticRateY<.5)&&(ILaya.systemTimer.clear(this,this.tweenMove),this.elasticDistance>0?this.checkElastic():this.clear())}clear(){if(this.target){this.clearTimer();var e=this.target;this.target=null,this._parent=null,e.event(Event.DRAG_END,this.data)}}}class SpriteUtils{static getGlobalRecByPoints(e,t,r,a,i){var s,n;s=Point.create().setTo(t,r),s=e.localToGlobal(s),n=Point.create().setTo(a,i),n=e.localToGlobal(n);var o=Rectangle._getWrapRec([s.x,s.y,n.x,n.y]);return s.recover(),n.recover(),o}static getGlobalPosAndScale(e){return SpriteUtils.getGlobalRecByPoints(e,0,0,1,1)}static getTransformRelativeToWindow(e,t,r){var a=ILaya.stage,i=SpriteUtils.getGlobalPosAndScale(e),s=a._canvasTransform.clone(),n=s.tx,o=s.ty;s.rotate(-Math.PI/180*a.canvasDegree),s.scale(a.clientScaleX,a.clientScaleY);var l,h,u,d,_=a.canvasDegree%180!=0;return _?(l=r+i.y,h=t+i.x,l*=s.d,h*=s.a,90==a.canvasDegree?(l=n-l,h+=o):(l+=n,h=o-h)):(l=t+i.x,h=r+i.y,l*=s.a,h*=s.d,l+=n,h+=o),h+=a._safariOffsetY,_?(u=s.d*i.height,d=s.a*i.width):(u=s.a*i.width,d=s.d*i.height),{x:l,y:h,scaleX:u,scaleY:d}}static fitDOMElementInArea(e,t,r,a,i,s){e._fitLayaAirInitialized||(e._fitLayaAirInitialized=!0,e.style.transformOrigin=e.style.webKittransformOrigin="left top",e.style.position="absolute");var n=SpriteUtils.getTransformRelativeToWindow(t,r,a);e.style.transform=e.style.webkitTransform="scale("+n.scaleX+","+n.scaleY+") rotate("+ILaya.stage.canvasDegree+"deg)",e.style.width=i+"px",e.style.height=s+"px",e.style.left=n.x+"px",e.style.top=n.y+"px"}static updateOrder(e){if(!e||e.length<2)return!1;for(var t,r,a,i=1,s=e.length;i<s;){for(a=e[t=i],r=e[t]._zOrder;--t>-1&&e[t]._zOrder>r;)e[t+1]=e[t];e[t+1]=a,i++}return!0}}class Sprite extends Node{destroy(e=!0){super.destroy(e),this._style&&this._style.recover(),this._cacheStyle&&this._cacheStyle.recover(),this._boundStyle&&this._boundStyle.recover(),this._transform&&this._transform.recover(),this._style=null,this._cacheStyle=null,this._boundStyle=null,this._transform=null,this._texture&&this._texture._removeReference(),this._texture=null,this._graphics&&this._ownGraphics&&this._graphics.destroy(),this._graphics=null}constructor(){super(),this._x=0,this._y=0,this._width=0,this._height=0,this._anchorX=0,this._anchorY=0,this._visible=!0,this._mouseState=0,this._zOrder=0,this._renderType=0,this._transform=null,this._tfChanged=!1,this._repaint=SpriteConst.REPAINT_NONE,this._texture=null,this._sizeFlag=0,this._style=SpriteStyle.EMPTY,this._cacheStyle=CacheStyle.EMPTY,this._boundStyle=null,this._graphics=null,this._ownGraphics=!1,this.mouseThrough=!1,this.autoSize=!1,this.hitTestPrior=!1,this._globalDeltaFlages=0,this._cacheGlobal=!1,this._globalPosx=0,this._globalPosy=0,this._globalRotate=0,this._globalScalex=1,this._globalScaley=1}get scene(){return this._scene}updateZOrder(){SpriteUtils.updateOrder(this._children)&&this.repaint()}_getBoundsStyle(){return this._boundStyle||(this._boundStyle=BoundsStyle.create()),this._boundStyle}_setCustomRender(){}set customRenderEnable(e){e&&(this._renderType|=SpriteConst.CUSTOM,this._setCustomRender())}get cacheAs(){return this._cacheStyle.userSetCache}_setCacheAs(e){}set cacheAs(e){e!==this._cacheStyle.userSetCache&&("bitmap"!=e||this._cacheStyle.canvas instanceof HTMLCanvas||(this._cacheStyle.canvas=null),this._getCacheStyle().userSetCache=e,this.mask&&"normal"===e||(this._setCacheAs(e),this._checkCanvasEnable(),this.repaint()))}_checkCanvasEnable(){var e=this._cacheStyle.needEnableCanvasRender();this._getCacheStyle().enableCanvasRender=e,e?(this._cacheStyle.needBitmapCache()?this._cacheStyle.cacheAs="bitmap":this._cacheStyle.cacheAs=this._cacheStyle.userSetCache,this._cacheStyle.reCache=!0,this._renderType|=SpriteConst.CANVAS):(this._cacheStyle.cacheAs="none",this._cacheStyle.releaseContext(),this._renderType&=~SpriteConst.CANVAS),this._setCacheAs(this._cacheStyle.cacheAs)}get staticCache(){return this._cacheStyle.staticCache}set staticCache(e){this._getCacheStyle().staticCache=e,e||this.reCache()}reCache(){this._cacheStyle.reCache=!0,this._repaint|=SpriteConst.REPAINT_CACHE}getRepaint(){return this._repaint}_setX(e){this._x=e}_setY(e){this._y=e}get x(){return this._x}set x(e){if(!this._destroyed&&this._x!==e){this._setX(e),this.cacheGlobal&&(this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Position_X|Sprite.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(Sprite.Sprite_GlobalDeltaFlage_Position_X|Sprite.Sprite_GlobalDeltaFlage_Matrix,!0)),this.parentRepaint(SpriteConst.REPAINT_CACHE);var t=this._cacheStyle.maskParent;t&&t.repaint(SpriteConst.REPAINT_CACHE)}}get y(){return this._y}set y(e){if(!this._destroyed&&this._y!==e){this._setY(e),this.cacheGlobal&&(this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Position_Y|Sprite.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(Sprite.Sprite_GlobalDeltaFlage_Position_Y|Sprite.Sprite_GlobalDeltaFlage_Matrix,!0)),this.parentRepaint(SpriteConst.REPAINT_CACHE);var t=this._cacheStyle.maskParent;t&&t.repaint(SpriteConst.REPAINT_CACHE)}}get width(){return this.get_width()}set width(e){this.set_width(e)}set_width(e){let t=this._sizeFlag;null==e?(e=0,this._sizeFlag&=-2):0==e?this._sizeFlag|=1:this._sizeFlag&=-2,this._width===e&&t==this._sizeFlag||(this._width=e,this._setWidth(e),this._setPivotX(this._anchorX*e),this._graphics&&this._graphics._clearBoundsCache(!0),this._setTranformChange(),this._shouldRefreshLayout())}get_width(){return this.autoSize?this.texture?this.texture.width:this._graphics||0!==this._children.length?this.getSelfBounds().width:0:0==this._width&&0==(1&this._sizeFlag)&&this.texture?this.texture.width:this._width}get height(){return this.get_height()}set height(e){this.set_height(e)}set_height(e){let t=this._sizeFlag;null==e?(e=0,this._sizeFlag&=-3):0==e?this._sizeFlag|=2:this._sizeFlag&=-3,this._height===e&&t==this._sizeFlag||(this._height=e,this._setHeight(e),this._setPivotY(this._anchorY*e),this._graphics&&this._graphics._clearBoundsCache(!0),this._setTranformChange(),this._shouldRefreshLayout())}get_height(){return this.autoSize?this.texture?this.texture.height:this._graphics||0!==this._children.length?this.getSelfBounds().height:0:0==this._height&&0==(2&this._sizeFlag)&&this.texture?this.texture.height:this._height}get _isWidthSet(){return 0!=this._width||0!=(1&this._sizeFlag)}get _isHeightSet(){return 0!=this._height||0!=(2&this._sizeFlag)}_setWidth(e){}_setHeight(e){}_shouldRefreshLayout(){}get displayWidth(){return this.width*this.scaleX}get displayHeight(){return this.height*this.scaleY}setSelfBounds(e){this._getBoundsStyle().userBounds=e}getBounds(){return this._getBoundsStyle().bounds=Rectangle._getWrapRec(this._boundPointsToParent())}getSelfBounds(){return this._boundStyle&&this._boundStyle.userBounds?this._boundStyle.userBounds:this._graphics||0!==this._children.length||this._texture?this._getBoundsStyle().bounds=Rectangle._getWrapRec(this._getBoundPointsM(!1)):Rectangle.TEMP.setTo(0,0,this.width,this.height)}_boundPointsToParent(e=!1){let t=0,r=0;this._style&&(t=this.pivotX,r=this.pivotY,e=e||0!==this._style.rotation,this._style.scrollRect&&(t+=this._style.scrollRect.x,r+=this._style.scrollRect.y));let a=this._getBoundPointsM(e);if(!a||a.length<1)return a;if(8!=a.length&&(a=e?GrahamScan.scanPList(a):Rectangle._getWrapRec(a,Rectangle.TEMP)._getBoundPoints()),!this.transform)return Utils.transPointList(a,this._x-t,this._y-r),a;let i=Point.TEMP,s=a.length;for(let e=0;e<s;e+=2)i.x=a[e],i.y=a[e+1],this.toParentPoint(i),a[e]=i.x,a[e+1]=i.y;return a}getGraphicBounds(e=!1){return this._graphics?this._graphics.getBounds(e):Rectangle.TEMP.setTo(0,0,0,0)}_getBoundPointsM(e=!1){if(this._boundStyle&&this._boundStyle.userBounds)return this._boundStyle.userBounds._getBoundPoints();this._boundStyle||this._getBoundsStyle();let t,r=this._boundStyle.temBM;if(r||(r=this._boundStyle.temBM=[]),this._style.scrollRect){r.length=0;var a=Rectangle.TEMP;return a.copyFrom(this._style.scrollRect),r.push(...a._getBoundPoints()),r}this._graphics?t=this._graphics.getBoundPoints():(r.length=0,t=r),this._texture&&((a=Rectangle.TEMP).setTo(0,0,this.width||this._texture.width,this.height||this._texture.height),t.push(...a._getBoundPoints()));let i=this._children;for(let r=0,a=i.length;r<a;r++){let a=i[r];if(!0===a._visible&&a._cacheStyle.maskParent!=this){let r=a._boundPointsToParent(e);r&&(t?t.push(...r):t=r)}}return t}_getCacheStyle(){return this._cacheStyle===CacheStyle.EMPTY&&(this._cacheStyle=CacheStyle.create()),this._cacheStyle}getStyle(){return this._style===SpriteStyle.EMPTY&&(this._style=SpriteStyle.create()),this._style}setStyle(e){this._style=e}get scaleX(){return this._style.scaleX}set scaleX(e){this.set_scaleX(e)}get scaleY(){return this._style.scaleY}set scaleY(e){this.set_scaleY(e)}set_scaleX(e){this.getStyle().scaleX!==e&&(this.cacheGlobal&&(this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Scale_X|Sprite.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(Sprite.Sprite_GlobalDeltaFlage_Scale_X|Sprite.Sprite_GlobalDeltaFlage_Matrix,!0)),this._setScaleX(e),this._setTranformChange(),this._shouldRefreshLayout())}get_scaleX(){return this._style.scaleX}set_scaleY(e){this.getStyle().scaleY!==e&&(this.cacheGlobal&&(this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Scale_Y|Sprite.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(Sprite.Sprite_GlobalDeltaFlage_Scale_Y|Sprite.Sprite_GlobalDeltaFlage_Matrix,!0)),this._setScaleY(e),this._setTranformChange(),this._shouldRefreshLayout())}get_scaleY(){return this._style.scaleY}_setScaleX(e){this._style.scaleX=e}_setScaleY(e){this._style.scaleY=e}get rotation(){return this._style.rotation}set rotation(e){this.getStyle().rotation!==e&&(this.cacheGlobal&&(this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Rotation|Sprite.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(Sprite.Sprite_GlobalDeltaFlage_Rotation|Sprite.Sprite_GlobalDeltaFlage_Matrix,!0)),this._setRotation(e),this._setTranformChange())}_setRotation(e){this.getStyle().rotation=e}get skewX(){return this._style.skewX}set skewX(e){this.getStyle().skewX!==e&&(this._setSkewX(e),this._setTranformChange())}_setSkewX(e){this._style.skewX=e}get skewY(){return this._style.skewY}set skewY(e){this.getStyle().skewY!==e&&(this._setSkewY(e),this._setTranformChange())}_setSkewY(e){this._style.skewY=e}_createTransform(){return Matrix.create()}_adjustTransform(){this._tfChanged=!1;var e=this._style,t=e.scaleX,r=e.scaleY,a=e.skewX,i=e.skewY,s=e.rotation,n=this._transform||(this._transform=this._createTransform());if(s||1!==t||1!==r||0!==a||0!==i){n._bTransform=!0;var o=.0174532922222222*(s-a),l=.0174532922222222*(s+i),h=Math.cos(l),u=Math.sin(l),d=Math.sin(o),_=Math.cos(o);n.a=t*h,n.b=t*u,n.c=-r*d,n.d=r*_,n.tx=n.ty=0}else n.identity(),this._renderType&=~SpriteConst.TRANSFORM;return n}_setTransform(e){}get transform(){return this._tfChanged?this._adjustTransform():this._transform}set transform(e){this.set_transform(e)}get_transform(){return this._tfChanged?this._adjustTransform():this._transform}set_transform(e){this._tfChanged=!1;var t=this._transform||(this._transform=this._createTransform());e.copyTo(t),this._setTransform(t),e&&(this._x=t.tx,this._y=t.ty,t.tx=t.ty=0),e?this._renderType|=SpriteConst.TRANSFORM:this._renderType&=~SpriteConst.TRANSFORM,this.parentRepaint()}_setPivotX(e){this.getStyle().pivotX=e}_getPivotX(){return this._style.pivotX}_setPivotY(e){this.getStyle().pivotY=e}_getPivotY(){return this._style.pivotY}get pivotX(){return this._getPivotX()}set pivotX(e){if(this.getStyle().pivotX!=e){this._setPivotX(e);let t=this.width;0!=t&&(this._anchorX=e/t),this._shouldRefreshLayout(),this.repaint()}}get pivotY(){return this._getPivotY()}set pivotY(e){if(this.getStyle().pivotY!=e){this._setPivotY(e);let t=this.height;0!=t&&(this._anchorY=e/t),this._shouldRefreshLayout(),this.repaint()}}get anchorX(){return this.get_anchorX()}get_anchorX(){return this._anchorX}set anchorX(e){this.set_anchorX(e)}set_anchorX(e){isNaN(e)&&(e=null),this._anchorX!=e&&(this._anchorX=e,null!=e&&(this._setPivotX(e*this.width),this._shouldRefreshLayout(),this.repaint()))}get anchorY(){return this.get_anchorY()}get_anchorY(){return this._anchorY}set anchorY(e){this.set_anchorY(e)}set_anchorY(e){isNaN(e)&&(e=null),this._anchorY!=e&&(this._anchorY=e,null!=e&&(this._setPivotY(e*this.height),this._shouldRefreshLayout(),this.repaint()))}_setAlpha(e){this._style.alpha!==e&&(this.getStyle().alpha=e,1!==e?this._renderType|=SpriteConst.ALPHA:this._renderType&=~SpriteConst.ALPHA,this.parentRepaint())}_getAlpha(){return this._style.alpha}get alpha(){return this._getAlpha()}set alpha(e){e=e<0?0:e>1?1:e,this._setAlpha(e)}get visible(){return this.get_visible()}set visible(e){this.set_visible(e)}get_visible(){return this._visible}set_visible(e){this._visible!==e&&(this._visible=e,this.parentRepaint(SpriteConst.REPAINT_ALL))}get blendMode(){return this._style.blendMode}set blendMode(e){this.getStyle().blendMode!=e&&(this.getStyle().blendMode=e,e&&"source-over"!=e?this._renderType|=SpriteConst.BLEND:this._renderType&=~SpriteConst.BLEND,this.parentRepaint())}get graphics(){return this._graphics||(this.graphics=new Graphics,this._ownGraphics=!0),this._graphics}set graphics(e){this.setGraphics(e,!1)}setGraphics(e,t){this._graphics&&(this._graphics._sp=null,this._ownGraphics&&this._graphics.destroy()),this._ownGraphics=t,this._graphics=e,e?(this._renderType|=SpriteConst.GRAPHICS,e._sp=this):this._renderType&=~SpriteConst.GRAPHICS,this.repaint()}get material(){var e;return null===(e=this._graphics)||void 0===e?void 0:e.material}set material(e){null==this._graphics&&null==e||(this.graphics.material=e)}get scrollRect(){return this._style.scrollRect}set scrollRect(e){null==this.getStyle().scrollRect&&null==e||(this.getStyle().scrollRect=e,e?this._renderType|=SpriteConst.CLIP:this._renderType&=~SpriteConst.CLIP,this.repaint())}pos(e,t,r=!1){if(this._x!==e||this._y!==t){if(this._destroyed)return this;if(r){this._setX(e),this._setY(t),this.parentRepaint(SpriteConst.REPAINT_CACHE);var a=this._cacheStyle.maskParent;if(a&&a.repaint(SpriteConst.REPAINT_CACHE),this.cacheGlobal){let e=Sprite.Sprite_GlobalDeltaFlage_Position_X|Sprite.Sprite_GlobalDeltaFlage_Position_Y;this._setGlobalCacheFlag(e,!0),this._syncGlobalFlag(e,!0)}}else this.x=e,this.y=t}return this}pivot(e,t){return this.pivotX=e,this.pivotY=t,this}size(e,t){return this.width=e,this.height=t,this}scale(e,t,r){if(this._destroyed)return this;var a=this.getStyle();return a.scaleX==e&&a.scaleY==t||(r?(this._setScaleX(e),this._setScaleY(t),this._setTranformChange(),this._shouldRefreshLayout()):(this.scaleX=e,this.scaleY=t)),this}skew(e,t){return this.skewX=e,this.skewY=t,this}render(e,t,r){RenderSprite.renders[this._renderType]._fun(this,e,t+this._x,r+this._y),this._repaint=0}drawToCanvas(e,t,r,a){return Sprite.drawToCanvas(this,this._renderType,e,t,r,a)}drawToTexture(e,t,r,a,i=null){return Sprite.drawToTexture(this,this._renderType,e,t,r,a,i)}drawToTexture3D(e,t,r){throw"not implement"}static drawToCanvas(e,t,r,a,i,s){i-=e.x,s-=e.y,i|=0,s|=0,r|=0,a|=0;var n=new Context;n.size(r,a),n.asBitmap=!0,n._targets.start(),n._targets.clear(0,0,0,0),RenderSprite.renders[t]._fun(e,n,i,s),n.flush(),n._targets.end(),n._targets.restore();var o=n._targets.getData(0,0,r,a);n.destroy();for(var l=new ImageData(r,a),h=4*r,u=l.data,d=a-1,_=d*h,c=0;d>=0;d--)u.set(o.subarray(c,c+h),_),_-=h,c+=h;var p=new HTMLCanvas(!0);return p.size(r,a),p.getContext("2d").putImageData(l,0,0),p}static drawToTexture(e,t,r,a,i,s,n=null){Context.set2DRenderConfig(),Sprite.drawtocanvCtx||(Sprite.drawtocanvCtx=new Context),i-=e.x,s-=e.y,i|=0,s|=0,r|=0,a|=0;var o=n?Sprite.drawtocanvCtx:new Context;let l;if(o.clear(),o.size(r,a),n?o._targets=n:o.asBitmap=!0,o._targets){o._targets.start();let r=RenderTexture2D._clearColor;o._targets.clear(r.r,r.g,r.b,r.a),o._drawingToTexture=!0,RenderSprite.renders[t]._fun(e,o,i,s),o._drawingToTexture=!1,o.flush(),o._targets.end(),o._targets.restore(),n||(l=o._targets),o._targets=null}if(!n){var h=new Texture(o._targets?o._targets:l,Texture.INV_UV);return o.destroy(!0),h}return e._repaint=0,n}customRender(e,t,r){this._repaint=SpriteConst.REPAINT_ALL}_applyFilters(){}get filters(){return this._cacheStyle.filters}set filters(e){e&&0===e.length&&(e=null),this._getCacheStyle().filters=e?e.slice():null,e?this._renderType|=SpriteConst.FILTERS:this._renderType&=~SpriteConst.FILTERS,e&&e.length>0?(this._getBit(NodeFlags.DISPLAY)||this._setBitUp(NodeFlags.DISPLAY),1==e.length&&e[0]instanceof ColorFilter||(this._getCacheStyle().cacheForFilters=!0,this._checkCanvasEnable())):this._cacheStyle.cacheForFilters&&(this._cacheStyle.cacheForFilters=!1,this._checkCanvasEnable()),this._getCacheStyle().hasGlowFilter=this._isHaveGlowFilter(),this.repaint()}_isHaveGlowFilter(){var e,t;if(this.filters)for(e=0;e<this.filters.length;e++)if(this.filters[e].type==Filter.GLOW)return!0;for(e=0,t=this._children.length;e<t;e++)if(this._children[e]._isHaveGlowFilter())return!0;return!1}localToGlobal(e,t=!1,r=null){!0===t&&(e=new Point(e.x,e.y));var a=this;for(r=r||ILaya.stage;a&&!a._destroyed&&a!=r;)e=a.toParentPoint(e),a=a.parent;return e}globalToLocal(e,t=!1,r=null){t&&(e=new Point(e.x,e.y));var a=this,i=[];for(r=r||ILaya.stage;a&&!a._destroyed&&a!=r;)i.push(a),a=a.parent;for(var s=i.length-1;s>=0;)e=(a=i[s]).fromParentPoint(e),s--;return e}toParentPoint(e){if(!e)return e;e.x-=this.pivotX,e.y-=this.pivotY,this.transform&&this._transform.transformPoint(e),e.x+=this._x,e.y+=this._y;var t=this._style.scrollRect;return t&&(e.x-=t.x,e.y-=t.y),e}fromParentPoint(e){if(!e)return e;e.x-=this._x,e.y-=this._y;var t=this._style.scrollRect;return t&&(e.x+=t.x,e.y+=t.y),this.transform&&this._transform.invertTransformPoint(e),e.x+=this.pivotX,e.y+=this.pivotY,e}onStartListeningToType(e){super.onStartListeningToType(e),1!==this._mouseState&&Event.isMouseEvent(e)&&(this.mouseEnabled=!0,this._setBit(NodeFlags.HAS_MOUSE,!0),this._parent&&this._onDisplay())}_onDisplay(e){if(1!==this._mouseState){var t=this;for(t=t.parent;t&&1!==t._mouseState&&!t._getBit(NodeFlags.HAS_MOUSE);)t.mouseEnabled=!0,t._setBit(NodeFlags.HAS_MOUSE,!0),t=t.parent}}_setParent(e){super._setParent(e),e&&this._getBit(NodeFlags.HAS_MOUSE)&&this._onDisplay()}loadImage(e,t=null){if(e){let r=ILaya.loader.getRes(e);r?(this.texture=r,this.repaint(SpriteConst.REPAINT_ALL),t&&t.run()):(this._skinBaseUrl&&(e=URL.formatURL(e,this._skinBaseUrl)),ILaya.loader.load(e).then((e=>{this.texture=e,this.repaint(SpriteConst.REPAINT_ALL),t&&t.run()})))}else this.texture=null,this.repaint(SpriteConst.REPAINT_ALL),t&&t.run();return this}static fromImage(e){return(new Sprite).loadImage(e)}repaint(e=SpriteConst.REPAINT_CACHE){this._repaint&e||(this._repaint|=e,this.parentRepaint(e)),this._cacheStyle&&this._cacheStyle.maskParent&&this._cacheStyle.maskParent.repaint(e)}_needRepaint(){return this._repaint&SpriteConst.REPAINT_CACHE&&this._cacheStyle.enableCanvasRender&&this._cacheStyle.reCache}_childChanged(e=null){super._childChanged(e),this._children.length?this._renderType|=SpriteConst.CHILDS:this._renderType&=~SpriteConst.CHILDS,e&&this._getBit(NodeFlags.HAS_ZORDER)&&ILaya.systemTimer.callLater(this,this.updateZOrder),this.repaint(SpriteConst.REPAINT_ALL)}parentRepaint(e=SpriteConst.REPAINT_CACHE){var t=this._parent;!t||t._repaint&e||(t._repaint|=e,t.parentRepaint(e))}get stage(){return ILaya.stage}get hitArea(){return this._style.hitArea}set hitArea(e){this.getStyle().hitArea=e}_setMask(e){}get mask(){return this._cacheStyle.mask}set mask(e){e==this||e&&this.mask==e&&e._cacheStyle.maskParent==this||(this.mask&&(this.mask._getCacheStyle().maskParent=null),this._getCacheStyle().mask=e,this._setMask(e),this._checkCanvasEnable(),e?(e._getCacheStyle().maskParent=this,this._renderType|=SpriteConst.MASK):this._renderType&=~SpriteConst.MASK,this.repaint())}get mouseEnabled(){return this._mouseState>1}set mouseEnabled(e){this._mouseState=e?2:1}startDrag(e=null,t=!1,r=0,a=300,i=null,s=.92){this._style.dragging||(this.getStyle().dragging=new Dragging),this._style.dragging.start(this,e,t,r,a,i,s)}stopDrag(){this._style.dragging&&this._style.dragging.stop()}_setDisplay(e){e||this._cacheStyle&&(this._cacheStyle.releaseContext(),this._cacheStyle.releaseFilterCache(),this._cacheStyle.hasGlowFilter&&(this._cacheStyle.hasGlowFilter=!1)),super._setDisplay(e)}hitTestPoint(e,t){var r=this.globalToLocal(Point.TEMP.setTo(e,t));return e=r.x,t=r.y,(this._style.hitArea?this._style.hitArea:this._isWidthSet&&this._isHeightSet?Rectangle.TEMP.setTo(0,0,this._width,this._height):this.getSelfBounds()).contains(e,t)}getMousePoint(){return this.globalToLocal(Point.TEMP.setTo(ILaya.stage.mouseX,ILaya.stage.mouseY))}get mouseX(){return this.getMousePoint().x}get mouseY(){return this.getMousePoint().y}get zOrder(){return this._zOrder}set zOrder(e){this._zOrder!=e&&(this._zOrder=e,this._parent&&(e&&this._parent._setBit(NodeFlags.HAS_ZORDER,!0),ILaya.systemTimer.callLater(this._parent,this.updateZOrder)))}get texture(){return this._texture}_setTexture(e){}set texture(e){"string"==typeof e?this.loadImage(e):this._texture!=e&&(this._texture&&this._texture._removeReference(),this._texture=e,e&&e._addReference(),this._setTexture(e),this._setWidth(this.width),this._setHeight(this.height),e?this._renderType|=SpriteConst.TEXTURE:this._renderType&=~SpriteConst.TEXTURE,this.repaint())}get viewport(){return this._style.viewport}set viewport(e){if("string"==typeof e){let t=e.split(",");t.length>3&&(e=new Rectangle(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3])))}this.getStyle().viewport=e}_setTranformChange(){this._tfChanged=!0,this._renderType|=SpriteConst.TRANSFORM,this.parentRepaint(SpriteConst.REPAINT_CACHE)}set drawCallOptimize(e){this._setBit(NodeFlags.DRAWCALL_OPTIMIZE,e)}get drawCallOptimize(){return this._getBit(NodeFlags.DRAWCALL_OPTIMIZE)}onAfterDeserialize(){super.onAfterDeserialize(),LayaEnv.isPlaying&&(this._gcmds&&(this.graphics.cmds=this._gcmds,delete this._gcmds),this._filters&&(this.filters=this._filters,delete this._filters))}get cacheGlobal(){return this._cacheGlobal}set cacheGlobal(e){if(this._cacheGlobal!=e)if(this._cacheGlobal=e,e){if(this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Position_X,!0),this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Position_Y,!0),this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Scale_X,!0),this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Scale_Y,!0),this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Rotation,!0),this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Matrix,!0),this._parent==ILaya.stage||!this._parent)return;this._parent.cacheGlobal=e}else this._children.forEach((t=>{t.cacheGlobal=e}))}getGlobalMatrix(){return null==this._globalMatrix&&(this._globalMatrix=Matrix.create()),this._getGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Matrix)&&(this._globalMatrix.identity(),this._globalMatrix.translate(-this.pivotX,-this.pivotY),this._globalMatrix.scale(this.globalScaleX,this.globalScaleY),this._globalMatrix.rotate(Utils.toRadian(this.globalRotation)),this._globalMatrix.translate(this.globalPosX,this.globalPosY),this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Matrix,!1)),this._globalMatrix}CustomMaterial(){}set globalPosX(e){this.setGlobalPos(e,this._globalPosy)}set globalPosY(e){this.setGlobalPos(this._globalPosx,e)}setGlobalPos(e,t){if(this._getGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Matrix)||e!=this.globalPosX||t!=this.globalPosY)if(this._cacheGlobal){let r=this.parent.getGlobalMatrix().invertTransformPoint(Point.TEMP.setTo(e,t));this._setX(r.x),this._setY(r.y),this._globalPosx=e,this._globalPosy=t;let a=Sprite.Sprite_GlobalDeltaFlage_Position_X|Sprite.Sprite_GlobalDeltaFlage_Position_Y;this._setGlobalCacheFlag(a,!1),this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(a|Sprite.Sprite_GlobalDeltaFlage_Matrix,!0)}else{Point.TEMP.setTo(e,t);let r=this.globalToLocal(Point.TEMP,!1,null);r=this.toParentPoint(r),this.x=r.x,this.y=r.y}}get globalPosX(){if(this._cacheGlobal){if(this._getGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Matrix|Sprite.Sprite_GlobalDeltaFlage_Position_X)){this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Position_X,!1);let e=this.parent.getGlobalMatrix(),t=this.toParentPoint(Point.TEMP.setTo(this.pivotX,this.pivotY));t=e.transformPoint(t),this._globalPosx=t.x,this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(Sprite.Sprite_GlobalDeltaFlage_Matrix,!0)}return this._globalPosx}return this.localToGlobal(Point.TEMP.setTo(0,0),!1,null).x}get globalPosY(){if(this._cacheGlobal){if(this._getGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Matrix|Sprite.Sprite_GlobalDeltaFlage_Position_Y)){this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Position_Y,!1);let e=this.parent.getGlobalMatrix(),t=this.toParentPoint(Point.TEMP.setTo(this.pivotX,this.pivotY));t=e.transformPoint(t),this._globalPosy=t.y,this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(Sprite.Sprite_GlobalDeltaFlage_Matrix,!0)}return this._globalPosy}return this.localToGlobal(Point.TEMP.setTo(0,0),!1,null).y}get globalRotation(){if(this._cacheGlobal)return this._getGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Rotation)&&(this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Rotation,!1),this._parent!=ILaya.stage&&this._parent?this._globalRotate=this.rotation+this.parent.globalRotation:this._globalRotate=this.rotation),this._globalRotate;for(var e=0,t=this;t&&t!==ILaya.stage;)e+=t.rotation,t=t.parent;return e}set globalRotation(e){(this._getGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Matrix)||e!=this.globalRotation)&&(this._parent!=ILaya.stage&&this._parent?(this._setRotation(e-this.parent.globalRotation),this._setTranformChange()):(this._setRotation(e),this._setTranformChange()),this._cacheGlobal&&(this._globalRotate=e,this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Rotation,!1),this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Matrix,!0),this._syncGlobalFlag(Sprite.Sprite_GlobalDeltaFlage_Matrix,!0)))}get globalScaleX(){if(this._cacheGlobal)return this._getGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Scale_X)&&(this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Scale_X,!1),this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Matrix,!0),this._parent!=ILaya.stage&&this._parent?this._globalScalex=this.scaleX*this.parent.globalScaleX:this._globalScalex=this.scaleX,this._syncGlobalFlag(Sprite.Sprite_GlobalDeltaFlage_Matrix,!0)),this._globalScalex;for(var e=1,t=this;t&&t!==ILaya.stage;)e*=t.scaleX,t=t.parent;return e}get globalScaleY(){if(this._cacheGlobal)return this._getGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Scale_Y)&&(this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Scale_Y,!1),this._setGlobalCacheFlag(Sprite.Sprite_GlobalDeltaFlage_Matrix,!0),this._parent!=ILaya.stage&&this._parent?this._globalScaley=this.scaleY*this.parent.globalScaleY:this._globalScaley=this.scaleY,this._syncGlobalFlag(Sprite.Sprite_GlobalDeltaFlage_Matrix,!0)),this._globalScaley;for(var e=1,t=this;t&&t!==ILaya.stage;)e*=t.scaleY,t=t.parent;return e}_getGlobalCacheFlag(e){return 0!=(this._globalDeltaFlages&e)}_getGlobalCacheLocalToGlobal(e,t){return this._cacheGlobal?this.getGlobalMatrix().transformPoint(Point.TEMP.setTo(this.pivotX+e,this.pivotY+t)):this.localToGlobal(Point.TEMP.setTo(e,t),!1,null)}_getGlobalCacheGlobalToLocal(e,t){if(this._cacheGlobal){let r=this.getGlobalMatrix().invertTransformPoint(Point.TEMP.setTo(e,t));return r.x-=this.pivotX,r.y-=this.pivotY,r}return this.globalToLocal(Point.TEMP.setTo(e,t),!1,null)}_setGlobalCacheFlag(e,t){t?this._globalDeltaFlages|=e:this._globalDeltaFlages&=~e,t&&this.event("GlobaChange",e)}get globalDeltaFlages(){return this._globalDeltaFlages}_syncGlobalFlag(e,t){this.cacheGlobal&&this._children.forEach((r=>{r._setGlobalCacheFlag(e,t),r._syncGlobalFlag(e,t)}))}}Sprite.Sprite_GlobalDeltaFlage_Position_X=1,Sprite.Sprite_GlobalDeltaFlage_Position_Y=2,Sprite.Sprite_GlobalDeltaFlage_Rotation=4,Sprite.Sprite_GlobalDeltaFlage_Scale_X=8,Sprite.Sprite_GlobalDeltaFlage_Scale_Y=16,Sprite.Sprite_GlobalDeltaFlage_Matrix=32;class AnimationBase extends Sprite{constructor(){super(),this.wrapMode=0,this._interval=Config.animationInterval,this._isReverse=!1,this._frameRateChanged=!1,this._setBitUp(NodeFlags.DISPLAY)}play(e=0,t=!0,r=""){this._isPlaying=!0,this._actionName=r,this.index="string"==typeof e?this._getFrameByLabel(e):e,this.loop=t,this._isReverse=this.wrapMode===AnimationBase.WRAP_REVERSE,0==this.index&&this._isReverse&&(this.index=this.count-1),this.interval>0&&this.timerLoop(this.interval,this,this._frameLoop,null,!0,!0)}get interval(){return this._interval}set interval(e){this._interval!=e&&(this._frameRateChanged=!0,this._interval=e,this._isPlaying&&e>0&&this.timerLoop(e,this,this._frameLoop,null,!0,!0))}_getFrameByLabel(e){for(var t=0;t<this._count;t++){var r=this._labels[t];if(r&&r.indexOf(e)>-1)return t}return 0}_frameLoop(){if(this._controlNode&&!this._controlNode._destroyed){if(this._isReverse){if(this._index--,this._index<0){if(!this.loop)return this._index=0,this.stop(),void this.event(Event.COMPLETE);this.wrapMode==AnimationBase.WRAP_PINGPONG?(this._index=this._count>0?1:0,this._isReverse=!1):this._index=this._count-1,this.event(Event.COMPLETE)}}else if(this._index++,this._index>=this._count){if(!this.loop)return this._index--,this.stop(),void this.event(Event.COMPLETE);this.wrapMode==AnimationBase.WRAP_PINGPONG?(this._index=this._count-2>=0?this._count-2:0,this._isReverse=!0):this._index=0,this.event(Event.COMPLETE)}this.index=this._index}else this.clearTimer(this,this._frameLoop)}_setControlNode(e){this._controlNode&&(this._controlNode.off(Event.DISPLAY,this,this._resumePlay),this._controlNode.off(Event.UNDISPLAY,this,this._resumePlay)),this._controlNode=e,e&&e!=this&&(e.on(Event.DISPLAY,this,this._resumePlay),e.on(Event.UNDISPLAY,this,this._resumePlay))}_setDisplay(e){super._setDisplay(e),this._resumePlay()}_resumePlay(){this._isPlaying&&(this._controlNode.displayedInStage?this.play(this._index,this.loop,this._actionName):this.clearTimer(this,this._frameLoop))}stop(){this._isPlaying=!1,this.clearTimer(this,this._frameLoop)}get isPlaying(){return this._isPlaying}addLabel(e,t){this._labels||(this._labels={}),this._labels[t]||(this._labels[t]=[]),this._labels[t].push(e)}removeLabel(e){if(e){if(this._labels)for(var t in this._labels)this._removeLabelFromList(this._labels[t],e)}else this._labels=null}_removeLabelFromList(e,t){if(e)for(var r=e.length-1;r>=0;r--)e[r]==t&&e.splice(r,1)}gotoAndStop(e){this.index="string"==typeof e?this._getFrameByLabel(e):e,this.stop()}get index(){return this._index}set index(e){if(this._index=e,this._displayToIndex(e),this._labels&&this._labels[e])for(var t=this._labels[e],r=0,a=t.length;r<a;r++)this.event(Event.LABEL,t[r])}_displayToIndex(e){}get count(){return this._count}clear(){return this.stop(),this._labels=null,this}}AnimationBase.WRAP_POSITIVE=0,AnimationBase.WRAP_REVERSE=1,AnimationBase.WRAP_PINGPONG=2;class AtlasInfoManager{static enable(e,t=null){ILaya.loader.fetch(e,"json").then((e=>{e&&(AtlasInfoManager.addAtlases(e),t&&t.run())}))}static addAtlases(e){let t=AtlasInfoManager._fileLoadDic;for(let r in e){let a=e[r],i=URL.formatURL(a[0]),s=a[1],n=s.length,o={url:r};for(let e=0;e<n;e++)t[i+s[e]]=o}}static addAtlas(e,t,r){t=URL.formatURL(t);let a=AtlasInfoManager._fileLoadDic,i={url:e};for(let e of r)a[t+e]=i}static getFileLoadPath(e){return AtlasInfoManager._fileLoadDic[e]}}AtlasInfoManager._fileLoadDic={};class WorkerLoader{static workerSupported(){return!!Worker}static set enable(e){if(WorkerLoader._enable!=e){if(e){if(!Worker)return;WorkerLoader._worker||(WorkerLoader._worker=new Worker(WorkerLoader.workerPath),WorkerLoader._worker.onmessage=WorkerLoader.workerMessage,WorkerLoader._dispatcher=new EventDispatcher)}WorkerLoader._enable=e}}static get enable(){return WorkerLoader._enable}static load(e,t){return new Promise((r=>{WorkerLoader._worker.postMessage({url:e,options:t}),WorkerLoader._dispatcher.once(e,r)}))}static workerMessage(e){let t=e.data;if(t)switch(t.type){case"Image":WorkerLoader._dispatcher.event(t.url,t.imageBitmap);break;case"Disable":WorkerLoader.enable=!1}}}WorkerLoader.workerPath="libs/laya.workerloader.js",WorkerLoader._enable=!1;class AtlasResource extends Resource{constructor(e,t,r){super(),this.dir=e,this.textures=t,this.frames=r,this.lock=!0}_disposeResource(){for(let e of this.textures)e&&e.destroy();for(let e of this.frames)e.destroy();this.frames.length=0,this.textures.length=0}}class BatchProgress{constructor(e){this._callback=e,this._items=[],this._weights=[],this._progress=0}get itemCount(){return this._items.length}reset(){this._items.length=0,this._weights.length=0,this._progress=0}createCallback(e){let t=this._items.length;return this._items.push(0),null==e?this._weights.push(null):this._weights.push(Math.max(0,Math.min(e,1))),e=>this.update(t,e)}update(e,t){if(-1!=e){this._items[e]=Math.max(0,Math.min(t,1));let r=0,a=this._items,i=this._weights,s=1/a.length;for(let e=0;e<a.length;e++){let t=a[e],n=i[e];null!=t&&(r+=t*(null!=n?n:s))}(t=r)>1&&(t=1)}t>this._progress&&(this._progress=t,this._callback(t))}}class ImgUtils{static compareVersion(e,t){let r=e.split("."),a=t.split(".");const i=Math.max(r.length,a.length);for(;r.length<i;)r.push("0");for(;a.length<i;)a.push("0");for(let e=0;e<i;e++){const t=parseInt(r[e]),i=parseInt(a[e]);if(t>i)return!0;if(t<i)return!1}return!0}static get isSupport(){if(Browser._isMiniGame){var e=Browser.window.wx.getSystemInfoSync().SDKVersion;return ImgUtils.compareVersion(e,"2.14.0")}return!!Browser.onLayaRuntime||!!Browser.window.Blob&&!!Browser.window.Blob}static arrayBufferToURL(e,t){if(!ImgUtils.isSupport)return e;if(ImgUtils.data[e])return ImgUtils.data[e];var r="";if(Browser._isMiniGame||Browser.onLayaRuntime)r=Browser.window.wx.createBufferURL(t);else if(Browser.window.Blob){let e=new Blob([t],{type:"application/octet-binary"});r=Browser.window.URL.createObjectURL(e)}return ImgUtils.isSavaData&&(ImgUtils.data[e]=r),r}static _arrayBufferToURL(e){if(!ImgUtils.isSupport)return null;var t="";if(Browser._isMiniGame||Browser.onLayaRuntime)t=Browser.window.wx.createBufferURL(e);else if(Browser.window.Blob){let r=new Blob([e],{type:"application/octet-binary"});t=Browser.window.URL.createObjectURL(r)}return t}static destroy(e){if(ImgUtils.isSupport){var t=ImgUtils.data[e];t&&(Browser._isMiniGame||Browser.onLayaRuntime?Browser.window.wx.revokeBufferURL(t):Browser.window.Blob&&Browser.window.URL.revokeObjectURL(t),delete ImgUtils.data[e])}}}ImgUtils.data={},ImgUtils.isSavaData=!1;class XMLUtils{static decodeString(e){let t=e.length,r="",a=0,i=0;for(;;){if(i=e.indexOf("&",a),-1==i){r+=e.substring(a);break}r+=e.substring(a,i),a=i+1,i=a;let s=Math.min(t,i+10);for(;i<s&&";"!=e[i];i++);if(i<s&&i>a){let t=e.substring(a,i),s=0;if("#"==t[0])t.length>1?(s="x"==t[1]?parseInt(t.substring(2),16):parseInt(t.substring(1)),r+=String.fromCharCode(s),a=i+1):r+="&";else{switch(t){case"amp":s=38;break;case"apos":s=39;break;case"gt":s=62;break;case"lt":s=60;break;case"nbsp":s=32;break;case"quot":s=34}s>0?(r+=String.fromCharCode(s),a=i+1):r+="&"}}else r+="&"}return r}static encodeString(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/'/g,"&apos;").replace(/"/g,"&quot;")}static getString(e,t,r){if(null==e)return null==r?null:r;let a=e[t];return null!=a?""+a:null==r?null:r}static getInt(e,t,r){let a=this.getString(e,t);if(null!=a&&a.length>0)if("%"==a[a.length-1]){let e=parseInt(a.substring(0,a.length-1));if(!isNaN(e))return Math.ceil(e/100*r)}else{let e=parseInt(a);if(!isNaN(e))return e}return null==r?0:r}static getFloat(e,t,r){let a=this.getString(e,t);if(null==a||0==a.length)return null==r?0:r;let i=parseFloat(a);return isNaN(i)?null==r?0:r:i}static getBool(e,t,r){let a=this.getString(e,t);return null==a||0==a.length?null!=r&&r:"true"==a||"1"==a||"false"!=a&&"0"!=a&&(null!=r&&r)}}var Ie;e.XMLTagType=void 0,(Ie=e.XMLTagType||(e.XMLTagType={}))[Ie.Start=0]="Start",Ie[Ie.End=1]="End",Ie[Ie.Void=2]="Void",Ie[Ie.CDATA=3]="CDATA",Ie[Ie.Comment=4]="Comment",Ie[Ie.Instruction=5]="Instruction";class XMLIterator{static begin(e,t){XMLIterator.source=e,XMLIterator.lowerCaseName=t,this.sourceLen=e.length,this.parsePos=0,this.lastTagEnd=0,this.tagPos=0,this.tagLength=0,this.tagName=null}static nextTag(){let t,r,a="";for(this.tagType=e.XMLTagType.Start,this.lastTagEnd=this.parsePos,this.attrParsed=!1,this.lastTagName=this.tagName;-1!=(t=this.source.indexOf("<",this.parsePos))&&(this.parsePos=t,t++,t!=this.sourceLen);){if(r=this.source[t],"!"==r){if(this.sourceLen>t+7&&"<![CDATA["==this.source.substring(t-1,t+8))return t=this.source.indexOf("]]>",t),this.tagType=e.XMLTagType.CDATA,this.tagName="",this.tagPos=this.parsePos,this.tagLength=-1==t?this.sourceLen-this.parsePos:t+3-this.parsePos,this.parsePos+=this.tagLength,!0;if(this.sourceLen>t+2&&"\x3c!--"==this.source.substring(t-1,t+3))return t=this.source.indexOf("--\x3e",t),this.tagType=e.XMLTagType.Comment,this.tagName="",this.tagPos=this.parsePos,this.tagLength=-1==t?this.sourceLen-this.parsePos:t+3-this.parsePos,this.parsePos+=this.tagLength,!0;t++,this.tagType=e.XMLTagType.Instruction}else"/"==r?(t++,this.tagType=e.XMLTagType.End):"?"==r&&(t++,this.tagType=e.XMLTagType.Instruction);for(;t<this.sourceLen&&(r=this.source[t],-1==" \t\n\r\v".indexOf(r)&&">"!=r&&"/"!=r);t++);if(t==this.sourceLen)break;a+=this.source.substring(this.parsePos+1,t),a.length>0&&"/"==a[0]&&(a=a.substring(1));let i=!1,s=!1,n=-1;for(;t<this.sourceLen;t++)if(r=this.source[t],'"'==r?i||(s=!s):"'"==r&&(s||(i=!i)),">"==r){if(!i&&!s){n=-1;break}n=t}else if("<"==r)break;if(-1!=n&&(t=n),t==this.sourceLen)break;return"/"==this.source[t-1]&&(this.tagType=e.XMLTagType.Void),this.tagName=a,this.lowerCaseName&&(this.tagName=this.tagName.toLowerCase()),this.tagPos=this.parsePos,this.tagLength=t+1-this.parsePos,this.parsePos+=this.tagLength,!0}return this.tagPos=this.sourceLen,this.tagLength=0,this.tagName=null,!1}static getTagSource(){return this.source.substring(this.tagPos,this.tagPos+this.tagLength)}static getRawText(e){if(this.lastTagEnd==this.tagPos)return"";if(e){let e=this.lastTagEnd;for(;e<this.tagPos;e++){let t=this.source[e];if(-1==" \t\n\r\v".indexOf(t))break}return e==this.tagPos?"":this.source.substring(e,this.tagPos).trim()}return this.source.substring(this.lastTagEnd,this.tagPos)}static getText(e){if(this.lastTagEnd==this.tagPos)return"";if(e){let e=this.lastTagEnd;for(;e<this.tagPos;e++){let t=this.source[e];if(-1==" \t\n\r\v".indexOf(t))break}return e==this.tagPos?"":XMLUtils.decodeString(this.source.substring(e,this.tagPos)).trimEnd()}return XMLUtils.decodeString(this.source.substring(this.lastTagEnd,this.tagPos))}static get attributes(){if(!this.attrParsed){for(let e in this._attrs)delete this._attrs[e];this.parseAttributes(this._attrs),this.attrParsed=!0}return this._attrs}static getAttribute(e){return this.attributes[e]}static parseAttributes(e){let t,r=0,a=0,i=!1,s=0,n="",o=this.tagPos,l=this.tagPos+this.tagLength;if(o<l&&"<"==this.source[o])for(;o<l;o++){let e=this.source[o];if(-1!=" \t\n\r\v".indexOf(e)||">"==e||"/"==e)break}for(;o<l;o++){let h=this.source[o];if("="==h){r=-1,a=-1,s=0;for(let e=o+1;e<l;e++){let t=this.source[e];if(-1!=" \t\n\r\v".indexOf(t)){if(-1!=r&&0==s){a=e-1;break}}else if(">"==t){if(0==s){a=e-1;break}}else if('"'==t)if(-1!=r){if(1!=s){a=e-1;break}}else s=2,r=e+1;else if("'"==t)if(-1!=r){if(2!=s){a=e-1;break}}else s=1,r=e+1;else-1==r&&(r=e)}if(-1==r||-1==a)break;t=n,this.lowerCaseName&&(t=t.toLowerCase()),n="",e[t]=XMLUtils.decodeString(this.source.substring(r,a+1)),o=a+1}else-1==" \t\n\r\v".indexOf(h)?((i||"/"==h||">"==h)&&(n.length>0&&(t=n,this.lowerCaseName&&(t=t.toLowerCase()),e[t]="",n=""),i=!1),"/"!=h&&">"!=h&&(n+=h)):n.length>0&&(i=!0)}}}XMLIterator._attrs={},String.prototype.trimEnd||(String.prototype.trimEnd=function(){return this.replace(/\s+$/g,"")});class XML{constructor(e){e&&this.parse(e)}get attributes(){return this._attrs||(this._attrs={}),this._attrs}getAttrString(e,t){return XMLUtils.getString(this._attrs,e,t)}getAttrInt(e,t){return XMLUtils.getInt(this._attrs,e,t)}getAttrFloat(e,t){return XMLUtils.getFloat(this._attrs,e,t)}getAttrBool(e,t){return XMLUtils.getBool(this._attrs,e,t)}setAttribute(e,t){this._attrs||(this._attrs={}),this._attrs[e]=t}getNode(e){return this._children?this._children.find((t=>t.name==e)):null}elements(e){return this._children||(this._children=new Array),e?this._children.filter((t=>t.name==e)):this._children}parse(t){let r;this.reset();let a=new Array;for(XMLIterator.begin(t);XMLIterator.nextTag();)if(XMLIterator.tagType==e.XMLTagType.Start||XMLIterator.tagType==e.XMLTagType.Void){let t;if(r)t=new XML;else{if(null!=this.name)throw this.reset(),new Error("Invalid xml format - no root node.");t=this}t.name=XMLIterator.tagName,t._attrs=Object.assign({},XMLIterator.attributes),r&&(XMLIterator.tagType!=e.XMLTagType.Void&&a.push(r),null==r._children&&(r._children=new Array),r._children.push(t)),XMLIterator.tagType!=e.XMLTagType.Void&&(r=t)}else if(XMLIterator.tagType==e.XMLTagType.End){if(null==r||r.name!=XMLIterator.tagName)throw this.reset(),new Error("Invalid xml format - <"+XMLIterator.tagName+"> dismatched.");null!=r._children&&0!=r._children.length||(r.text=XMLIterator.getText()),r=a.length>0?a.pop():null}}reset(){this._attrs=null,null!=this._children&&this._children.length,this.text=null}}class HttpRequest extends EventDispatcher{constructor(){super(...arguments),this._http=new XMLHttpRequest}send(e,t=null,r="get",a="text",i){this._responseType=a,this._data=null,(Browser.onVVMiniGame||Browser.onQGMiniGame||Browser.onQQMiniGame||Browser.onAlipayMiniGame||Browser.onBLMiniGame||Browser.onHWMiniGame||Browser.onTTMiniGame||Browser.onTBMiniGame)&&(e=HttpRequest._urlEncode(e)),this._url=e;let s=this._http;if(s.open(r,e,!0),t?"string"==typeof t?s.setRequestHeader("Content-Type","application/x-www-form-urlencoded"):(s.setRequestHeader("Content-Type","application/json"),t instanceof ArrayBuffer||(t=JSON.stringify(t))):Browser.onBLMiniGame&&Browser.onAndroid&&(t={}),i)for(let e=0;e<i.length;e++)s.setRequestHeader(i[e++],i[e]);let n="arraybuffer"!==a?"text":"arraybuffer";s.responseType=n,s.dataType&&(s.dataType=n),s.onerror=e=>{this._onError(e)},s.onabort=e=>{this._onAbort(e)},s.onprogress=e=>{this._onProgress(e)},s.onload=e=>{this._onLoad(e)},s.send(t)}_onProgress(e){e&&e.lengthComputable&&this.event(Event.PROGRESS,e.loaded/e.total)}_onAbort(e){this.error("Request was aborted by user")}_onError(e){this.error("Request failed Status:"+this._http.status+" text:"+this._http.statusText)}_onLoad(e){var t=this._http,r=void 0!==t.status?t.status:200;200===r||204===r||0===r?this.complete():this.error("["+t.status+"]"+t.statusText+":"+t.responseURL)}error(e){this.clear(),this.event(Event.ERROR,e)}complete(){this.clear();var e=!0;try{"json"===this._responseType?this._data=JSON.parse(this._http.responseText):"xml"===this._responseType?this._data=new XML(this._http.responseText):this._data=this._http.response||this._http.responseText}catch(t){e=!1,this.error(t.message)}e&&this.event(Event.COMPLETE,this._data instanceof Array?[this._data]:this._data)}clear(){var e=this._http;e.onerror=e.onabort=e.onprogress=e.onload=null}get url(){return this._url}get data(){return this._data}get http(){return this._http}reset(){this.offAll(),this._data=null}}HttpRequest._urlEncode=encodeURI;class Downloader{constructor(){this.httpRequestPool=[]}common(e,t,r,a,i,s){let n=this.getRequestInst();n.on(Event.COMPLETE,(()=>{let e=n.data;this.returnRequestInst(n),s(e)})),n.on(Event.ERROR,null,(e=>{this.returnRequestInst(n),s(null,e)})),i&&n.on(Event.PROGRESS,i),n.send(t,null,"get",a),e.$ref=n}image(e,t,r,a,i){let s=new Browser.window.Image;s.crossOrigin="",s.onload=()=>{s.onload=null,s.onerror=null,i(s)},s.onerror=()=>{s.onload=null,s.onerror=null,i(null,"")},s.src=t,e.$ref=s}imageWithBlob(e,t,r,a,i){let s=ImgUtils.arrayBufferToURL(r,t);this.image(e,s,r,a,i)}imageWithWorker(e,t,r,a,i){WorkerLoader.enable=!0,WorkerLoader.enable?WorkerLoader.load(t,e.workerLoaderOptions).then((e=>{e?i(e):i(null,"workerloader failed!")})):this.image(e,t,r,a,i)}audio(e,t,r,a,i){let s=Browser.createElement("audio");s.crossOrigin="",s.oncanplaythrough=()=>{s.oncanplaythrough=null,s.onerror=null,i(s)},s.onerror=()=>{s.oncanplaythrough=null,s.onerror=null,i(null,"")},s.src=t,e.$ref=s}getRequestInst(){return 0==this.httpRequestPool.length||Browser.onVVMiniGame||Browser.onHWMiniGame?new HttpRequest:this.httpRequestPool.pop()}returnRequestInst(e){e.reset(),this.httpRequestPool.length<10&&this.httpRequestPool.push(e)}}var we=0;const Be={ext:null,typeId:null,main:!1,loaderType:null};class Loader extends EventDispatcher{static registerLoader(e,t,r){let a;r?(a=Loader.typeMap[r],a?a.loaderType!=t&&(a={typeId:a.typeId,loaderType:t}):Loader.typeMap[r]=a={typeId:we++,loaderType:t}):a={typeId:we++,loaderType:t};for(let i of e){let e=Loader.extMap[i];if(e&&r){let r=e.findIndex((e=>e.typeId==a.typeId));-1==r?e.push(a):e[r].loaderType=t}else Loader.extMap[i]=[a]}}constructor(){super(),this.retryNum=1,this.retryDelay=0,this.maxLoader=5,this._loadings=new Map,this._queue=[],this._downloadings=new Set}get loading(){return this._loadings.size>0}load(e,t,r,a,i,s,n,o,l){let h,u,d,_,c=Fe;if(t instanceof Handler?(h=t,u=a):"string"==typeof t?u=t:null!=t&&(u=t.type,c=t),null==i&&null==s&&null==o&&null==n&&null==l||(c=c===Fe?{priority:i,cache:s,ignoreCache:o,group:n,useWorkerLoader:l}:Object.assign(c,{priority:i,cache:s,ignoreCache:o,group:n,useWorkerLoader:l})),!1===c.cache&&(c.ignoreCache=!0),d=r instanceof Handler?e=>r.runWith(e):r,Array.isArray(e)){let t;d&&(t=new BatchProgress(d));let r=[];for(let a=0;a<e.length;a++){let i=e[a];i&&("string"==typeof i?r.push(this._load1(i,u,c,null==t?void 0:t.createCallback())):r.push(this._load1(i.url,i.type||u,c!==Fe?Object.assign({},c,i):i,null==t?void 0:t.createCallback())))}_=Promise.all(r)}else _="string"==typeof e?this._load1(e,u,c,d):this._load1(e.url,e.type||u,c!==Fe?Object.assign({},c,e):e,d);return h?_.then((e=>(h.runWith(e),e))):_}_load1(e,t,r,a){if(LayaEnv.isPreview){if(e.startsWith("res://")){let i=e.substring(6);return AssetDb.inst.UUID_to_URL_async(i).then((s=>s?this._load2(s,i,t,r,a):(!r.silent&&Loader.warnFailed(e),Promise.resolve(null))))}return AssetDb.inst.URL_to_UUID_async(e).then((i=>this._load2(e,i,t,r,a)))}return this._load2(e,null,t,r,a)}_load2(e,t,r,a,i){let{ext:s,typeId:n,main:o,loaderType:l}=Loader.getURLInfo(e,r);if(!l)return!a.silent&&Loader.warnFailed(e),Promise.resolve(null);let h,u=URL.formatURL(e);if(a.group){let e=Loader.groupMap[a.group];e||(e=Loader.groupMap[a.group]=new Set),e.add(u)}if(!a.ignoreCache){let e=Loader._getRes(u,r);if(void 0!==e){if(null==e)return Promise.resolve(null);if(!(e instanceof Resource))return Promise.resolve(e);if(e.obsolute&&(h=e),!(h||e.uuid&&t&&t!=e.uuid))return Promise.resolve(e)}}let d=u;o||(d+="@"+n);let _=this._loadings.get(d);if(_)return a.initiator===_?Promise.resolve():(i&&_.onProgress.add(i),new Promise((e=>_.onComplete.add(e))));let c=AtlasInfoManager.getFileLoadPath(u);if(c)return this.load(c.url,{type:Loader.ATLAS,baseUrl:c.baseUrl}).then((()=>Loader.getRes(e,r)));_=Pe.length>0?Pe.pop():new LoadTask,_.type=r,_.url=e,_.uuid=t,_.ext=s,delete(a=Object.assign(_.options,a)).type,null==a.priority&&(a.priority=0),null==a.useWorkerLoader&&(a.useWorkerLoader=WorkerLoader.enable),i&&_.onProgress.add(i),_.loader=this,_.obsoluteInst=h;let p,m=new l;this._loadings.set(d,_);try{p=m.load(_)}catch(t){!a.silent&&Loader.warnFailed(e,t),p=Promise.resolve(null)}return p.then((r=>(r instanceof Resource&&r._setCreateURL(e,t),!1!==_.options.cache&&Loader._cacheRes(u,r,n,o),_.progress.update(-1,1),_.onComplete.invoke(r),r))).catch((t=>(!a.silent&&Loader.warnFailed(e,t),!1!==_.options.cache&&Loader._cacheRes(u,null,n,o),_.onComplete.invoke(null),null))).then((e=>(this._loadings.delete(d),_.reset(),Pe.push(_),0==this._loadings.size&&this.event(Event.COMPLETE),e)))}fetch(e,t,r,a){var i;let s={originalUrl:e,url:e,contentType:t,priority:null!==(i=(a=a||Fe).priority)&&void 0!==i?i:1,retryCnt:0,onProgress:r,onComplete:null};return a.useWorkerLoader&&(s.useWorkerLoader=!0,s.workerLoaderOptions=a.workerLoaderOptions),a.blob&&(s.blob=a.blob),a.noRetry&&(s.retryCnt=-1),a.silent&&(s.silent=!0),AssetDb.inst.resolveURL(e).then((e=>new Promise((t=>{s.url=URL.formatURL(e),s.onComplete=t,this.queueToDownload(s)}))))}queueToDownload(e){if(this._downloadings.size<this.maxLoader)return void this.download(e);let t=e.priority;if(0==t)this._queue.push(e);else{let r=this._queue.findIndex((e=>e.priority<t));-1!=r?this._queue.splice(r,0,e):this._queue.push(e)}}download(e){this._downloadings.add(e);let t=URL.postFormatURL(e.url);if("image"==e.contentType){let r=Loader.preLoadedMap[e.url];if(r){if(!(r instanceof ArrayBuffer))return void this.completeItem(e,r);e.blob=r}e.blob?Loader.downloader.imageWithBlob(e,e.blob,e.originalUrl,e.onProgress,((t,r)=>{t||(e.retryCnt=-1),this.completeItem(e,t,r)})):e.useWorkerLoader?Loader.downloader.imageWithWorker(e,t,e.originalUrl,e.onProgress,((t,r)=>{t||(e.useWorkerLoader=!1),this.completeItem(e,t,r)})):Loader.downloader.image(e,t,e.originalUrl,e.onProgress,((t,r)=>this.completeItem(e,t,r)))}else if("sound"==e.contentType)Loader.downloader.audio(e,t,e.originalUrl,e.onProgress,((t,r)=>this.completeItem(e,t,r)));else{let r=Loader.preLoadedMap[e.url];if(r)return void this.completeItem(e,r);Loader.downloader.common(e,t,e.originalUrl,e.contentType,e.onProgress,((t,r)=>this.completeItem(e,t,r)))}}completeItem(e,t,r){this._downloadings.delete(e),t?(this._downloadings.size<this.maxLoader&&this._queue.length>0&&this.download(this._queue.shift()),e.onProgress&&e.onProgress(1),e.onComplete(t)):-1!=e.retryCnt&&e.retryCnt<this.retryNum?(e.retryCnt++,e.silent||console.debug(`Retry to load ${e.url} (${e.retryCnt})`),ILaya.systemTimer.once(this.retryDelay,this,this.queueToDownload,[e],!1)):(!e.silent&&Loader.warnFailed(e.url),e.onProgress&&e.onProgress(1),this._downloadings.size<this.maxLoader&&this._queue.length>0&&this.download(this._queue.shift()),e.onComplete(null))}static getURLInfo(e,t){let r,a,i,s,n=e.startsWith("data:")?"png":Utils.getFileExtension(e);if(n.length>0&&(r=Loader.extMap[n]),t){let e=Loader.typeMap[t];if(!e)return Be;a=e.typeId;let n=0;r?r[0].typeId===a||-1!=(n=r.findIndex((e=>e.typeId===a)))?(i=0==n,s=r[n].loaderType):(i=!1,s=e.loaderType):(i=t!=Loader.TEXTURE2D,s=e.loaderType)}else{if(!r)return Be;i=!0,a=r[0].typeId,s=r[0].loaderType}return{ext:n,main:i,typeId:a,loaderType:s}}static warnFailed(e,t){this.warn(`Failed to load '${e}'`,t)}static warn(e,t){t?console.warn(e,t):console.warn(e)}static getRes(e,t){return e=URL.formatURL(e),Loader._getRes(e,t)||null}static _getRes(e,t){let r,a=Loader.loadedMap[e];if(a){if(t){let e=Loader.typeMap[t];if(!e)return;if(2==a.length)a[0]==e.typeId&&(r=a[1]);else{let t=a.indexOf(e.typeId);-1!=t&&(r=a[t+1])}}else r=a[1];return r instanceof Resource&&r.destroyed?void 0:r}}static getTexture2D(e){return Loader.getRes(e,Loader.TEXTURE2D)}static getBaseTexture(e){return Loader.getRes(e,Loader.TEXTURE2D)}static getAtlas(e){return Loader.getRes(e,Loader.ATLAS)}getRes(e,t){return Loader.getRes(e,t)}static createNodes(e){var t;return null===(t=Loader.getRes(e))||void 0===t?void 0:t.create()}static cacheRes(e,t,r){e=URL.formatURL(e);let a=Loader.getURLInfo(e,r);null!=a.typeId&&Loader._cacheRes(e,t,a.typeId,a.main)}static _cacheRes(e,t,r,a){let i=Loader.loadedMap[e];if(a)i?(i[0]=r,i[1]=t):i=Loader.loadedMap[e]=[r,t];else if(i){let e=i.findIndex((e=>e===r));-1!=e?i[e+1]=t:i.push(r,t)}else i=Loader.loadedMap[e]=[null,void 0,r,t]}cacheRes(e,t,r){Loader.cacheRes(e,t,r)}static clearRes(e,t){e=URL.formatURL(e),Loader._clearRes(e,t)}clearRes(e,t){e=URL.formatURL(e),Loader._clearRes(e,t)}static _clearRes(e,t){let r=Loader.loadedMap[e];if(r)if(t){if(r[1]==t)2==r.length?delete Loader.loadedMap[e]:r[1]=void 0;else{let a=r.indexOf(t);if(-1==a)return;4==r.length&&null==r[0]?delete Loader.loadedMap[e]:r.splice(a-1,2)}t instanceof Resource&&!t.destroyed&&t.destroy()}else if(delete Loader.loadedMap[e],r.length>2)for(let e=1;e<r.length;e+=2){let t=r[e];t instanceof Resource&&!t.destroyed&&t.destroy()}else{let e=r[1];e instanceof Resource&&!e.destroyed&&e.destroy()}}clearTextureRes(e){e=URL.formatURL(e);let t=Loader.loadedMap[e];if(!t)return;let r=t[1];if(r instanceof Texture)r.disposeBitmap();else if(r instanceof AtlasResource)for(let e of r.textures)e.disposeBitmap()}static setGroup(e,t){e=URL.formatURL(e);let r=Loader.groupMap[t];r||(r=Loader.groupMap[t]=new Set),r.add(e)}static clearResByGroup(e){let t=Loader.groupMap[e];if(t)for(let e of t)Loader._clearRes(e)}clearUnLoaded(){if(0==this._queue.length)return;let e=this._queue.concat();this._queue.length=0;for(let t of e)t.onComplete(null)}cancelLoadByUrls(e){if(e)for(var t=0,r=e.length;t<r;t++)this.cancelLoadByUrl(e[t])}cancelLoadByUrl(e){e=URL.formatURL(e);let t=this._queue.findIndex((t=>t.url==e));if(-1!=t){let e=this._queue[t];this._queue.splice(t,1),e.onComplete(null)}}loadPackage(e,t,r){let a,i;if("string"==typeof t?(i=t,a=r):a=t,i){i.endsWith("/")||(i+="/");let t=e+"/";return URL.basePaths[t]=i,this._loadSubFileConfig(e,null,a)}{if(LayaEnv.isPreview)return Promise.resolve();let t=ILaya.Browser.miniGameContext;return null==t?this._loadSubFileConfig(e,null,a):this._loadMiniPackage(t,e,a).then((()=>this._loadSubFileConfig(e,t,a)))}}_loadMiniPackage(e,t,r){return e.subPkgNameSeperator&&(t=t.replace(/\//g,e.subPkgNameSeperator)),t.length>0?new Promise(((a,i)=>{let s=e.loadSubpackage({name:t,success:e=>{a(e)},fail:e=>{i(e)}});s.onProgressUpdate&&s.onProgressUpdate((e=>{r&&r(e)}))})):Promise.resolve()}_loadSubFileConfig(e,t,r){return t&&t.subPkgPathSeperator&&(e=e.replace(/\//g,t.subPkgPathSeperator)),e.length>0&&(e+="/"),this.fetch(e+"fileconfig.json","json",r).then((r=>{let a=[],i=r.files;for(let e in i)if(e.length>0)for(let t of i[e])a.push(e+"/"+t);else for(let t of i[e])a.push(t);if(r.hash){let e=0,t=URL.version;for(let i of r.hash)null!=i&&(t[a[e]]=i),e++}let s,n,o=r.config,l=o.length,h=0,u=0,d=0,_=0,c=0,p=AssetDb.inst.metaMap;for(;;){if(null==s){if(h>=l)break;n=o[h],s=n.i,Array.isArray(s)?c=s.length:(d=s,c=0,_=1),u=0}if(0==_){if(u>=c){h++,s=null;continue}_=s[u++],_>0?(d=_,_=0):_=-_}else _--;let e=a[d+_];switch(n.t){case 0:p[e]=n;break;case 1:AtlasInfoManager.addAtlas(e,n.prefix,n.frames);break;case 2:AssetDb.inst.shaderNameMap[n.shaderName]=e;break;case 3:Loader.preLoadedMap[URL.formatURL(e)]=n}}return!t&&r.entry?ILaya.Browser.loadLib(e+r.entry):Promise.resolve()}))}}Loader.TEXT="text",Loader.JSON="json",Loader.XML="xml",Loader.BUFFER="arraybuffer",Loader.IMAGE="image",Loader.SOUND="sound",Loader.VIDEO="video",Loader.ATLAS="atlas",Loader.FONT="font",Loader.TTF="ttf",Loader.HIERARCHY="HIERARCHY",Loader.MESH="MESH",Loader.MATERIAL="MATERIAL",Loader.TEXTURE2D="TEXTURE2D",Loader.TEXTURECUBE="TEXTURE2D",Loader.TEXTURE2DARRAY="TEXTURE2D",Loader.ANIMATIONCLIP="ANIMATIONCLIP",Loader.TERRAINHEIGHTDATA="TERRAINHEIGHTDATA",Loader.TERRAINRES="TERRAIN",Loader.SPINE="SPINE",Loader.extMap={},Loader.typeMap={},Loader.downloader=new Downloader,Loader.groupMap={},Loader.loadedMap={},Loader.preLoadedMap={};class LoadTask{constructor(){this.options={},this.onProgress=new Delegate,this.onComplete=new Delegate,this.progress=new BatchProgress((e=>this.onProgress.invoke(e)))}reset(){for(let e in this.options)delete this.options[e];this.onProgress.clear(),this.onComplete.clear(),this.progress.reset(),this.obsoluteInst=null}}const Pe=[],Fe={};class MathUtil{static subtractVector3(e,t,r){r[0]=e[0]-t[0],r[1]=e[1]-t[1],r[2]=e[2]-t[2]}static lerp(e,t,r){return e*(1-r)+t*r}static scaleVector3(e,t,r){r[0]=e[0]*t,r[1]=e[1]*t,r[2]=e[2]*t}static lerpVector3(e,t,r,a){var i=e[0],s=e[1],n=e[2];a[0]=i+r*(t[0]-i),a[1]=s+r*(t[1]-s),a[2]=n+r*(t[2]-n)}static lerpVector4(e,t,r,a){var i=e[0],s=e[1],n=e[2],o=e[3];a[0]=i+r*(t[0]-i),a[1]=s+r*(t[1]-s),a[2]=n+r*(t[2]-n),a[3]=o+r*(t[3]-o)}static slerpQuaternionArray(e,t,r,a,i,s,n){var o,l,h,u,d,_=e[t+0],c=e[t+1],p=e[t+2],m=e[t+3],f=r[a+0],g=r[a+1],T=r[a+2],S=r[a+3];return(l=_*f+c*g+p*T+m*S)<0&&(l=-l,f=-f,g=-g,T=-T,S=-S),1-l>1e-6?(o=Math.acos(l),h=Math.sin(o),u=Math.sin((1-i)*o)/h,d=Math.sin(i*o)/h):(u=1-i,d=i),s[n+0]=u*_+d*f,s[n+1]=u*c+d*g,s[n+2]=u*p+d*T,s[n+3]=u*m+d*S,s}static getRotation(e,t,r,a){return Math.atan2(a-t,r-e)/Math.PI*180}static sortBigFirst(e,t){return e==t?0:t>e?1:-1}static sortSmallFirst(e,t){return e==t?0:t>e?-1:1}static sortNumBigFirst(e,t){return parseFloat(t)-parseFloat(e)}static sortNumSmallFirst(e,t){return parseFloat(e)-parseFloat(t)}static sortByKey(e,t=!1,r=!0){var a;return a=t?r?MathUtil.sortNumBigFirst:MathUtil.sortBigFirst:r?MathUtil.sortNumSmallFirst:MathUtil.sortSmallFirst,function(t,r){return a(t[e],r[e])}}}class FrameAnimation extends AnimationBase{static _sortIndexFun(e,t){return e.index-t.index}constructor(){super(),void 0===FrameAnimation._sortIndexFun&&(FrameAnimation._sortIndexFun=MathUtil.sortByKey("index",!1,!0))}_setUp(e,t){this._targetDic=e,this._animationData=t,this.interval=1e3/t.frameRate,t.parsed?(this._count=t.count,this._labels=t.labels,this._usedFrames=t.animationNewFrames):(this._usedFrames=[],this._calculateDatas(),t.parsed=!0,t.labels=this._labels,t.count=this._count,t.animationNewFrames=this._usedFrames)}clear(){return super.clear(),this._targetDic=null,this._animationData=null,this}_displayToIndex(e){if(this._animationData){e<0&&(e=0),e>this._count&&(e=this._count);var t,r=this._animationData.nodes,a=r.length;for(t=0;t<a;t++)this._displayNodeToFrame(r[t],e)}}_displayNodeToFrame(e,t,r=null){r||(r=this._targetDic);var a=r[e.target];if(a){var i,s,n,o,l=e.frames,h=e.keys,u=h.length;for(o=0;o<u;o++)n=(s=l[i=h[o]]).length>t?s[t]:s[s.length-1],a[i]=n;var d,_=e.funkeys;if(0!=(u=_.length))for(o=0;o<u;o++)void 0!==(d=l[i=_[o]])[t]&&a[i]&&a[i].apply(a,d[t])}}_calculateDatas(){if(this._animationData){var e,t,r=this._animationData.nodes,a=r.length;for(this._count=0,e=0;e<a;e++)t=r[e],this._calculateKeyFrames(t);this._count+=1}}_calculateKeyFrames(e){var t,r,a=e.keyframes,i=e.target;for(t in e.frames||(e.frames={}),e.keys?e.keys.length=0:e.keys=[],e.funkeys?e.funkeys.length=0:e.funkeys=[],e.initValues||(e.initValues={}),a){var s=-1!=t.indexOf("()");if(r=a[t],s&&(t=t.substr(0,t.length-2)),e.frames[t]||(e.frames[t]=[]),s){e.funkeys.push(t);for(var n=e.frames[t],o=0;o<r.length;o++){var l=r[o];n[l.index]=l.value,l.index>this._count&&(this._count=l.index)}}else this._targetDic&&this._targetDic[i]&&(e.initValues[t]=this._targetDic[i][t]),r.sort(FrameAnimation._sortIndexFun),e.keys.push(t),this._calculateNodePropFrames(r,e.frames[t],t,i)}}resetNodes(){if(this._targetDic&&this._animationData){var e,t,r,a=this._animationData.nodes,i=a.length;for(e=0;e<i;e++)if(r=(t=a[e]).initValues){var s,n=this._targetDic[t.target];if(n)for(s in r)n[s]=r[s]}}}_calculateNodePropFrames(e,t,r,a){var i,s=e.length-1;for(t.length=e[s].index+1,i=0;i<s;i++)this._dealKeyFrame(e[i]),this._calculateFrameValues(e[i],e[i+1],t);0==s&&(t[0]=e[0].value,this._usedFrames&&(this._usedFrames[e[0].index]=!0)),this._dealKeyFrame(e[i])}_dealKeyFrame(e){e.label&&""!=e.label&&this.addLabel(e.label,e.index)}_calculateFrameValues(e,t,r){var a,i,s=e.index,n=t.index,o=e.value,l=t.value-e.value,h=n-s,u=this._usedFrames;if(n>this._count&&(this._count=n),e.tween)for(null==(i=Ease[e.tweenMethod])&&(i=Ease.linearNone),a=s;a<n;a++)r[a]=i(a-s,o,l,h),u&&(u[a]=!0);else for(a=s;a<n;a++)r[a]=o;u&&(u[e.index]=!0,u[t.index]=!0),r[t.index]=t.value}}class GraphicAnimation extends FrameAnimation{constructor(){super(...arguments),this._nodeIDAniDic={}}_parseNodeList(e){this._nodeList||(this._nodeList=[]),this._nodeDefaultProps[e.compId]=e.props,e.compId&&this._nodeList.push(e.compId);var t=e.child;if(t){var r,a=t.length;for(r=0;r<a;r++)this._parseNodeList(t[r])}}_calGraphicData(e){var t;if(this._setUp(null,e),this._createGraphicData(),this._nodeIDAniDic)for(t in this._nodeIDAniDic)this._nodeIDAniDic[t]=null}_createGraphicData(){var e,t,r=[],a=this.count,i=this._usedFrames;for(i||(i=[]),e=0;e<a;e++)!i[e]&&t||(t=this._createFrameGraphic(e)),r.push(t);this._gList=r}_createFrameGraphic(e){var t=new Graphics;return GraphicAnimation._rootMatrix||(GraphicAnimation._rootMatrix=new Matrix),this._updateNodeGraphic(this._rootNode,e,GraphicAnimation._rootMatrix,t),t}_updateNodeGraphic(e,t,r,a,i=1){var s,n,o;(s=this._nodeGDic[e.compId]=this._getNodeGraphicData(e.compId,t,this._nodeGDic[e.compId])).resultTransform||(s.resultTransform=new Matrix),n=s.resultTransform,Matrix.mul(s.transform,r,n);var l=s.alpha*i;if(!(l<.01)){s.skin&&(o=this._getTextureByUrl(s.skin))&&(n._checkTransform()?(a.drawTexture(o,0,0,s.width,s.height,n,l),s.resultTransform=null):a.drawTexture(o,n.tx,n.ty,s.width,s.height,null,l));var h,u,d=e.child;if(d)for(u=d.length,h=0;h<u;h++)this._updateNodeGraphic(d[h],t,n,a,l)}}_updateNoChilds(e,t){if(e.skin){var r=this._getTextureByUrl(e.skin);if(r){var a=e.transform;a._checkTransform(),!a._bTransform?t.drawTexture(r,a.tx,a.ty,e.width,e.height,null,e.alpha):t.drawTexture(r,0,0,e.width,e.height,a.clone(),e.alpha)}}}_updateNodeGraphic2(e,t,r){var a;if(a=this._nodeGDic[e.compId]=this._getNodeGraphicData(e.compId,t,this._nodeGDic[e.compId]),e.child){var i,s,n,o=a.transform;o._checkTransform(),s=(i=!o._bTransform)&&(0!=o.tx||0!=o.ty),(n=o._bTransform||1!=a.alpha)&&r.save(),1!=a.alpha&&r.alpha(a.alpha),i?s&&r.translate(o.tx,o.ty):r.transform(o.clone());var l,h,u,d=e.child;if(a.skin&&(l=this._getTextureByUrl(a.skin))&&r.drawImage(l,0,0,a.width,a.height),d)for(u=d.length,h=0;h<u;h++)this._updateNodeGraphic2(d[h],t,r);n?r.restore():i?s&&r.translate(-o.tx,-o.ty):r.transform(o.clone().invert())}else this._updateNoChilds(a,r)}_calculateKeyFrames(e){super._calculateKeyFrames(e),this._nodeIDAniDic[e.target]=e}getNodeDataByID(e){return this._nodeIDAniDic[e]}_getParams(e,t,r,a){var i=GraphicAnimation._temParam;i.length=t.length;var s,n=t.length;for(s=0;s<n;s++)i[s]=this._getObjVar(e,t[s][0],r,t[s][1],a);return i}_getObjVar(e,t,r,a,i){if(t in e){var s=e[t];return r>=s.length&&(r=s.length-1),e[t][r]}return t in i?i[t]:a}_getNodeGraphicData(e,t,r){r||(r=new GraphicNode),r.transform?r.transform.identity():r.transform=new Matrix;var a=this.getNodeDataByID(e);if(!a)return r;var i,s,n,o=a.frames,l=this._getParams(o,GraphicAnimation._drawTextureCmd,t,this._nodeDefaultProps[e]),h=l[0],u=l[5],d=l[6],_=l[13],c=l[14],p=l[7],m=l[8],f=l[9],g=l[11],T=l[12];i=l[3],s=l[4],0!=i&&0!=s||(h=null),-1==i&&(i=0),-1==s&&(s=0),r.skin=h,r.width=i,r.height=s,h&&((n=this._getTextureByUrl(h))?(i||(i=n.sourceWidth),s||(s=n.sourceHeight)):console.warn("lost skin:",h,",you may load pics first")),r.alpha=l[10];var S=r.transform;0!=_&&(u=_*i),0!=c&&(d=c*s),0==u&&0==d||S.translate(-u,-d);var x=null;if(f||1!==p||1!==m||g||T){(x=GraphicAnimation._tempMt).identity(),x._bTransform=!0;var y=.0174532922222222*(f-g),E=.0174532922222222*(f+T),R=Math.cos(E),b=Math.sin(E),C=Math.sin(y),v=Math.cos(y);x.a=p*R,x.b=p*b,x.c=-m*C,x.d=m*v,x.tx=x.ty=0}return x&&(S=Matrix.mul(S,x,S)),S.translate(l[1],l[2]),r}_getTextureByUrl(e){return Loader.getRes(e)}setAniData(e,t=null){if(e.animations){this._nodeDefaultProps={},this._nodeGDic={},this._nodeList&&(this._nodeList.length=0),this._rootNode=e,this._parseNodeList(e);var r,a,i={},s=[],n=e.animations,o=n.length;for(r=0;r<o;r++)if(a=n[r],this._labels=null,(!t||t==a.name)&&a){try{this._calGraphicData(a)}catch(e){console.warn("parse animation fail:"+a.name+",empty animation created"),this._gList=[]}var l={};l.interval=1e3/a.frameRate,l.frames=this._gList,l.labels=this._labels,l.name=a.name,s.push(l),i[a.name]=l}this.animationList=s,this.animationDic=i}GraphicAnimation._temParam.length=0}parseByData(e){var t,r;t=e.nodeRoot,r=e.aniO,delete e.nodeRoot,delete e.aniO,this._nodeDefaultProps={},this._nodeGDic={},this._nodeList&&(this._nodeList.length=0),this._rootNode=t,this._parseNodeList(t),this._labels=null;try{this._calGraphicData(r)}catch(e){console.warn("parse animation fail:"+r.name+",empty animation created"),this._gList=[]}var a=e;return a.interval=1e3/r.frameRate,a.frames=this._gList,a.labels=this._labels,a.name=r.name,a}setUpAniData(e){if(e.animations){var t,r,a={},i=[],s=e.animations,n=s.length;for(t=0;t<n;t++)if(r=s[t]){var o={};o.name=r.name,o.aniO=r,o.nodeRoot=e,i.push(o),a[r.name]=o}this.animationList=i,this.animationDic=a}}_clear(){this.animationList=null,this.animationDic=null,this._gList=null,this._nodeGDic=null}static parseAnimationByData(e){var t;return GraphicAnimation._I||(GraphicAnimation._I=new GraphicAnimation),t=GraphicAnimation._I.parseByData(e),GraphicAnimation._I._clear(),t}static parseAnimationData(e){var t;return GraphicAnimation._I||(GraphicAnimation._I=new GraphicAnimation),GraphicAnimation._I.setUpAniData(e),(t={}).animationList=GraphicAnimation._I.animationList,t.animationDic=GraphicAnimation._I.animationDic,GraphicAnimation._I._clear(),t}}GraphicAnimation._drawTextureCmd=[["skin",null],["x",0],["y",0],["width",-1],["height",-1],["pivotX",0],["pivotY",0],["scaleX",1],["scaleY",1],["rotation",0],["alpha",1],["skewX",0],["skewY",0],["anchorX",0],["anchorY",0]],GraphicAnimation._temParam=[],GraphicAnimation._tempMt=new Matrix;class GraphicNode{constructor(){this.alpha=1}}class Animation extends AnimationBase{constructor(){super(),this._autoPlay=!1,this._setControlNode(this)}destroy(e=!0){this.stop(),super.destroy(e),this._frames=null,this._labels=null}play(e=0,t=!0,r=""){r&&this._setFramesFromCache(r,!0),super.play(e,t,r)}_setFramesFromCache(e,t=!1){if(this._url&&(e=this._url+"#"+e),e&&Animation.framesMap[e]){var r=Animation.framesMap[e];return r instanceof Array?(this._frames=Animation.framesMap[e],this._count=this._frames.length):(r.nodeRoot&&(Animation.framesMap[e]=GraphicAnimation.parseAnimationByData(r),r=Animation.framesMap[e]),this._frames=r.frames,this._count=this._frames.length,this._frameRateChanged||(this._interval=r.interval),this._labels=this._copyLabels(r.labels)),!0}return t&&console.log("ani not found:",e),!1}_copyLabels(e){if(!e)return null;var t,r;for(r in t={},e)t[r]=Utils.copyArray([],e[r]);return t}_frameLoop(){this._visible&&this._style.alpha>.01&&this._frames&&super._frameLoop()}_displayToIndex(e){this._frames&&(this.graphics=this._frames[e])}get frames(){return this._frames}set frames(e){this._frames=e,e&&(this._count=e.length,this._actionName&&this._setFramesFromCache(this._actionName,!0),this.index=this._index)}get source(){return this._source}set source(e){this._source=e,e?e.indexOf(".ani")>-1?this.loadAnimation(e):e.startsWith("res://")||e.indexOf(".json")>-1||e.indexOf("als")>-1||e.indexOf("atlas")>-1?this.loadAtlas(e):this.loadImages(e.split(",")):this.clear()}set autoPlay(e){this._autoPlay=e,e?this.play():this.stop()}get autoPlay(){return this._autoPlay}clear(){return super.clear(),this.stop(),this.graphics=null,this._frames=null,this._labels=null,this}loadImages(e,t=""){return this._url="",this._setFramesFromCache(t)||(this.frames=Animation.framesMap[t]?Animation.framesMap[t]:Animation.createFrames(e,t)),!this._isPlaying&&this._autoPlay&&this.play(),this}loadAtlas(e,t=null,r=""){if(this._url="",!this._setFramesFromCache(r)){let onLoaded=a=>{e===a&&(this.frames=Animation.framesMap[r]?Animation.framesMap[r]:Animation.createFrames(e,r),!this._isPlaying&&this._autoPlay&&this.play(),t&&t.run())};Loader.getAtlas(e)?onLoaded(e):ILaya.loader.load(e,Handler.create(null,onLoaded,[e]),null,Loader.ATLAS)}return this}loadAnimation(e,t=null,r=null){this._url=e;return this._actionName||(this._actionName=""),this._setFramesFromCache(this._actionName)?(this._setFramesFromCache(this._actionName,!0),this.index=0,t&&t.run()):!r||Loader.getAtlas(r)?this._loadAnimationData(e,t,r):ILaya.loader.load(r,Handler.create(this,this._loadAnimationData,[e,t,r]),null,Loader.ATLAS),this}_loadAnimationData(e,t=null,r=null){!r||Loader.getAtlas(r)?ILaya.loader.fetch(e,"json").then((r=>{if(this._url!==e)return;if(!r)return void(Animation.framesMap[e+"#"]&&(this._setFramesFromCache(this._actionName,!0),this.index=0,this._resumePlay(),t&&t.run()));let a;if(Animation.framesMap[e+"#"])this._setFramesFromCache(this._actionName,!0),this.index=0,this._resumePlay();else{let t=GraphicAnimation.parseAnimationData(r);if(!t)return;let i,s=t.animationList,n=s.length;for(let t=0;t<n;t++)a=s[t],Animation.framesMap[e+"#"+a.name]=a,i||(i=a);i&&(Animation.framesMap[e+"#"]=i,this._setFramesFromCache(this._actionName,!0),this.index=0),this._resumePlay()}t&&t.run()})):console.warn("atlas load fail:"+r)}static createFrames(e,t){var r;if("string"==typeof e){var a=Loader.getAtlas(e);if(a&&a.frames.length){let e=a.frames;r=[];for(var i=0,s=e.length;i<s;i++){var n=new Graphics;n.drawImage(e[i],0,0),r.push(n)}}}else if(e instanceof Array)for(r=[],i=0,s=e.length;i<s;i++)(n=new Graphics).loadImage(e[i],0,0),r.push(n);return t&&(Animation.framesMap[t]=r),r}static clearCache(e){var t,r=Animation.framesMap,a=e+"#";for(t in r)t!==e&&0!==t.indexOf(a)||delete Animation.framesMap[t]}onAfterDeserialize(){super.onAfterDeserialize(),this.images&&(this._source||this.loadImages(this.images),delete this.images)}}Animation.framesMap={};class BitmapFont extends Resource{static loadFont(e,t){ILaya.loader.load(e,Loader.FONT).then((e=>{t&&t.runWith(e)}))}constructor(){super(!1),this.dict={},this.fontSize=12,this.autoScaleSize=!1,this.tint=!0,this.maxWidth=0,this.lineHeight=12,this.letterSpacing=0}parseFont(e,t){var r;if(null==e||null==t)return;this.texture=t,t._addReference();let a=e.getNode("info");this.fontSize=a.getAttrInt("size",12),this.autoScaleSize=a.getAttrBool("autoScaleSize"),this.lineHeight=a.getAttrInt("lineHeight",this.fontSize),0==this.lineHeight&&(this.lineHeight=this.fontSize);let i=a.getAttrString("padding","").split(",");this.padding=[parseInt(i[0]),parseInt(i[1]),parseInt(i[2]),parseInt(i[3])];let s=(null===(r=e.getNode("chars"))||void 0===r?void 0:r.elements("char"))||[],n=0,o=this.dict;for(let e=0,r=s.length;e<r;e++){let r=s[e],a=r.getAttrInt("id"),i=r.getAttrInt("xoffset")/1,l=r.getAttrInt("yoffset")/1,h=r.getAttrInt("xadvance")/1,u=r.getAttrInt("x"),d=r.getAttrInt("y"),_=r.getAttrInt("width"),c=r.getAttrInt("height"),p=Texture.create(t,u,d,_,c,i,l);0==h&&(h=_),h+=this.letterSpacing,n=Math.max(n,h),o[a]={x:0,y:0,width:_,height:c,advance:h,texture:p}}this.maxWidth=n>0?n:this.fontSize,o[32]||(o[32]={x:0,y:0,advance:Math.floor(.5*this.fontSize)+this.letterSpacing})}_disposeResource(){var e;if(this.texture){for(let t in this.dict)null===(e=this.dict[t].texture)||void 0===e||e.destroy();this.texture._removeReference(),this.dict=null,this.texture=null,this.padding=null}}getTextWidth(e,t){let r=0;for(let a=0,i=e.length;a<i;a++){let i=this.dict[e.charCodeAt(a)];if(i){let e=this.autoScaleSize?t/this.fontSize:1;r+=Math.round(i.advance*e)}}return r}getMaxWidth(e){return null!=e&&this.autoScaleSize?Math.round(this.maxWidth*(e/this.fontSize)):this.maxWidth}getMaxHeight(e){return null!=e&&this.autoScaleSize?Math.round(this.lineHeight*(e/this.fontSize)):this.lineHeight}}class EffectAnimation extends FrameAnimation{constructor(){super(...arguments),this._initData={}}set target(e){this._target&&this._target.off(EffectAnimation.EFFECT_BEGIN,this,this._onOtherBegin),this._target=e,this._target&&this._target.on(EffectAnimation.EFFECT_BEGIN,this,this._onOtherBegin),this._addEvent()}get target(){return this._target}_onOtherBegin(e){e!==this&&this.stop()}set playEvent(e){this._playEvent=e,e&&this._addEvent()}_addEvent(){this._target&&this._playEvent&&(this._setControlNode(this._target),this._target.on(this._playEvent,this,this._onPlayAction))}_onPlayAction(){this.play(0,!1)}play(e=0,t=!0,r=""){this._target&&(this._target.event(EffectAnimation.EFFECT_BEGIN,[this]),this._recordInitData(),super.play(e,t,r))}_recordInitData(){var e,t,r;if(this._aniKeys)for(t=this._aniKeys.length,e=0;e<t;e++)r=this._aniKeys[e],this._initData[r]=this._target[r]}set effectClass(e){if(this._effectClass=ClassUtils.getClass(e),this._effectClass){var t=this._effectClass.uiView;if(t){var r=t.animations;if(r&&r[0]){var a=r[0];this._setUp({},a),a.nodes&&a.nodes[0]&&(this._aniKeys=a.nodes[0].keys)}}}}set effectData(e){if(e){var t=e.animations;if(t&&t[0]){var r=t[0];this._setUp({},r),r.nodes&&r.nodes[0]&&(this._aniKeys=r.nodes[0].keys)}}}_displayToIndex(e){if(this._animationData){e<0&&(e=0),e>this._count&&(e=this._count);var t,r=this._animationData.nodes,a=r.length;for(a=a>1?1:a,t=0;t<a;t++)this._displayNodeToFrame(r[t],e)}}_displayNodeToFrame(e,t,r=null){if(this._target){var a,i,s,n,o,l,h,u,d,_=this._target,c=e.frames,p=e.keys,m=p.length,f=e.secondFrames;for(n=0;n<m;n++)i=c[a=p[n]],-1==(o=f[a])?s=this._initData[a]:t<o?(u=(h=e.keyframes[a])[0]).tween?(null==(l=Ease[u.tweenMethod])&&(l=Ease.linearNone),d=h[1],s=l(t,this._initData[a],d.value-this._initData[a],d.index)):s=this._initData[a]:s=i.length>t?i[t]:i[i.length-1],_[a]=s}}_calculateKeyFrames(e){super._calculateKeyFrames(e);var t,r,a=e.keyframes;e.target;var i={};for(t in e.secondFrames=i,a)(r=a[t]).length<=1?i[t]=-1:i[t]=r[1].index}}EffectAnimation.EFFECT_BEGIN="effectbegin";class TextStyle{constructor(){this.font="",this.fontSize=12,this.color="#000000",this.bold=!1,this.italic=!1,this.underline=!1,this.underlineColor=null,this.align="left",this.valign="top",this.alignItems="middle",this.leading=2,this.stroke=0,this.strokeColor="#000000"}}var Ne;e.HtmlElementType=void 0,(Ne=e.HtmlElementType||(e.HtmlElementType={}))[Ne.Text=0]="Text",Ne[Ne.Link=1]="Link",Ne[Ne.Image=2]="Image",Ne[Ne.Input=3]="Input",Ne[Ne.Select=4]="Select",Ne[Ne.Object=5]="Object",Ne[Ne.LinkEnd=6]="LinkEnd";class HtmlElement{constructor(){this.style=new TextStyle}getAttr(e){return null==this._attrs?null:this._attrs[e]}setAttr(e,t){null==this._attrs&&(this._attrs={}),this._attrs[e]=t}getAttrString(e,t){return XMLUtils.getString(this._attrs,e,t)}getAttrInt(e,t){return XMLUtils.getInt(this._attrs,e,t)}getAttrFloat(e,t){return XMLUtils.getFloat(this._attrs,e,t)}getAttrBool(e,t){return XMLUtils.getBool(this._attrs,e,t)}fetchAttributes(){this._attrs=Object.assign({},XMLIterator.attributes)}reset(){this.name=null,this.text=null,this.obj&&(this.obj.release(),Pool.recoverByClass(this.obj),this.obj=null),this._attrs=null}static getFromPool(t){let r;return r=this.pool.length>0?this.pool.pop():new HtmlElement,r.type=t,r.type==e.HtmlElementType.Text||r._attrs||(r._attrs={}),r}static returnToPool(e){if(Array.isArray(e)){for(let t of e)t.reset();this.pool.push(...e),e.length=0}else e.reset(),this.pool.push(e)}}HtmlElement.pool=[];class HtmlImage{constructor(){this.obj=new Sprite}get element(){return this._element}get width(){return this.obj.width}get height(){return this.obj.height}create(e,t){this._owner=e,this._element=t,this._owner.objContainer.addChild(this.obj);let r=this._element.getAttrString("src");r&&this.loadTexture(r)}loadTexture(e){let t=this._element.getAttrInt("width",-1),r=this._element.getAttrInt("height",-1);-1!=t&&(this.obj.width=t),-1!=r&&(this.obj.height=r);let a=Loader.getRes(e);a?(this.obj.texture=a,-1==t&&(this.obj.width=a.sourceWidth),-1==r&&(this.obj.height=a.sourceHeight)):ILaya.loader.load(e,{silent:!0}).then((e=>{if(this.obj.destroyed)return;let a=this.obj.width,i=this.obj.height;this.obj.texture=e,-1==t&&(this.obj.width=e?e.sourceWidth:0),-1==r&&(this.obj.height=e?e.sourceHeight:0),!this._owner||a==this.obj.width&&i==this.obj.height||this._owner.refreshLayout()}))}pos(e,t){this.obj.pos(e,t)}release(){this.obj.removeSelf(),this.obj.offAll(),this.obj.texture=null,this._owner=null,this._element=null}destroy(){this.obj.destroy()}}class HtmlLink{constructor(){this._shape=new Sprite,this._shape.hitArea=this,this._shape.on(Event.CLICK,(()=>{this._owner.bubbleEvent(Event.LINK,this._element.getAttrString("href"))})),this._rects=[],this._rectCnt=0}get element(){return this._element}get width(){return 0}get height(){return 0}create(e,t){this._owner=e,this._element=t,this._owner.objContainer.addChild(this._shape)}resetArea(){this._rectCnt=0}addRect(e,t,r,a){let i=this._rects[this._rectCnt];i||(i=this._rects[this._rectCnt]=new Rectangle),this._rectCnt++,i.setTo(e,t,r,a)}contains(e,t){for(let r=0;r<this._rectCnt;r++)if(this._rects[r].contains(e,t))return!0;return!1}pos(e,t){}release(){this._shape.removeSelf(),this._owner=null,this._element=null}destroy(){this._shape.destroy()}}class HtmlParseOptions{constructor(){this.linkUnderline=HtmlParseOptions.defaultLinkUnderline,this.linkColor=HtmlParseOptions.defaultLinkColor}}HtmlParseOptions.defaultLinkUnderline=!0,HtmlParseOptions.defaultLinkColor=null,ClassUtils.regClass("HtmlParseOptions",HtmlParseOptions);const Oe=new Array,Ue=new Array;class HtmlParser{constructor(){this._styleStack=new Array,this._style=new TextStyle,this._options=new HtmlParseOptions}parse(t,r,a,i){null==i&&(i=this._options),this._elements=a,this._styleStackTop=0,Object.assign(this._style,r),this._style.colorChanged=!1;let s,n=0,o=i.ignoreWhiteSpace,l=!1;for(XMLIterator.begin(t,!0);XMLIterator.nextTag();)switch(0==n&&(s=XMLIterator.getText(o),s.length>0&&(l&&"\n"==s[0]&&(s=s.substring(1)),this.appendText(s))),l=!1,XMLIterator.tagName){case"b":XMLIterator.tagType==e.XMLTagType.Start?(this.pushStyle(),this._style.bold=!0):this.popStyle();break;case"i":XMLIterator.tagType==e.XMLTagType.Start?(this.pushStyle(),this._style.italic=!0):this.popStyle();break;case"u":XMLIterator.tagType==e.XMLTagType.Start?(this.pushStyle(),this._style.underline=!0):this.popStyle();break;case"strike":XMLIterator.tagType==e.XMLTagType.Start?(this.pushStyle(),this._style.strikethrough=!0):this.popStyle();break;case"font":if(XMLIterator.tagType==e.XMLTagType.Start){this.pushStyle(),this._style.fontSize=XMLUtils.getInt(XMLIterator.attributes,"size",this._style.fontSize);let e=XMLIterator.getAttribute("color");null!=e&&(this._style.color=e,this._style.colorChanged=!0)}else XMLIterator.tagType==e.XMLTagType.End&&this.popStyle();break;case"br":this.appendText("\n");break;case"img":if(XMLIterator.tagType==e.XMLTagType.Start||XMLIterator.tagType==e.XMLTagType.Void){let t=HtmlElement.getFromPool(e.HtmlElementType.Image);t.fetchAttributes(),t.name=t.getAttrString("name"),t.style.align=this._style.align,t.style.underline=this._style.underline,t.style.underlineColor=this._style.underlineColor,this._elements.push(t)}break;case"a":if(XMLIterator.tagType==e.XMLTagType.Start){this.pushStyle(),this._style.underline=this._style.underline||i.linkUnderline,this._style.colorChanged||null==i.linkColor||(this._style.color=i.linkColor);let t=HtmlElement.getFromPool(e.HtmlElementType.Link);t.fetchAttributes(),t.name=t.getAttrString("name"),t.style.align=this._style.align,this._elements.push(t)}else if(XMLIterator.tagType==e.XMLTagType.End){this.popStyle();let t=HtmlElement.getFromPool(e.HtmlElementType.LinkEnd);this._elements.push(t)}break;case"input":{let t=HtmlElement.getFromPool(e.HtmlElementType.Input);t.fetchAttributes(),t.name=t.getAttrString("name"),Object.assign(t.style,this._style),this._elements.push(t)}break;case"select":if(XMLIterator.tagType==e.XMLTagType.Start||XMLIterator.tagType==e.XMLTagType.Void){let t=HtmlElement.getFromPool(e.HtmlElementType.Select);if(t.fetchAttributes(),XMLIterator.tagType==e.XMLTagType.Start){for(Oe.length=0,Ue.length=0;XMLIterator.nextTag()&&"select"!=XMLIterator.tagName;)"option"==XMLIterator.tagName&&(XMLIterator.tagType==e.XMLTagType.Start||XMLIterator.tagType==e.XMLTagType.Void?Ue.push(XMLUtils.getString(XMLIterator.attributes,"value","")):Oe.push(XMLIterator.getText()));t.setAttr("items",Oe.slice()),t.setAttr("values",Ue.slice())}t.name=t.getAttrString("name"),Object.assign(t.style,this._style),this._elements.push(t)}break;case"p":XMLIterator.tagType==e.XMLTagType.Start?(this.pushStyle(),this._style.align=XMLIterator.getAttribute("align"),this.isNewLine()||this.appendText("\n")):XMLIterator.tagType==e.XMLTagType.End&&(this.appendText("\n"),l=!0,this.popStyle());break;case"ui":case"div":case"li":XMLIterator.tagType==e.XMLTagType.Start?this.isNewLine()||this.appendText("\n"):(this.appendText("\n"),l=!0);break;case"html":case"body":o=!0;break;case"head":case"style":case"script":case"form":XMLIterator.tagType==e.XMLTagType.Start?n++:XMLIterator.tagType==e.XMLTagType.End&&n--}0==n&&(s=XMLIterator.getText(o),s.length>0&&(l&&"\n"==s[0]&&(s=s.substring(1)),this.appendText(s))),this._elements=null}pushStyle(){let e;this._styleStack.length<=this._styleStackTop?(e=new TextStyle,this._styleStack.push(e)):e=this._styleStack[this._styleStackTop],Object.assign(e,this._style),this._styleStackTop++}popStyle(){if(this._styleStackTop>0){let e=this._styleStack[this._styleStackTop-1];Object.assign(this._style,e),this._styleStackTop--}}isNewLine(){if(this._elements.length>0){let t=this._elements[this._elements.length-1];return!(!t||t.type!=e.HtmlElementType.Text)&&t.text.endsWith("\n")}return!0}appendText(t){let r;this._elements.length>0&&(r=this._elements[this._elements.length-1],r.type==e.HtmlElementType.Text&&function(e,t){for(let r in e)if(!r.startsWith("_")&&e[r]!=t[r])return!1;return!0}(r.style,this._style))?r.text+=t:(r=HtmlElement.getFromPool(e.HtmlElementType.Text),r.text=t,Object.assign(r.style,this._style),this._elements.push(r))}}HtmlParser.defaultParser=new HtmlParser,HtmlParser.classMap={[e.HtmlElementType.Image]:HtmlImage,[e.HtmlElementType.Link]:HtmlLink};class UBBParser{constructor(){this._readPos=0,this.defaultImgWidth=0,this.defaultImgHeight=0,this._handlers={},this._handlers.url=this.onTag_URL,this._handlers.img=this.onTag_IMG,this._handlers.b=this.onTag_B,this._handlers.i=this.onTag_I,this._handlers.u=this.onTag_U,this._handlers.sup=this.onTag_Simple,this._handlers.sub=this.onTag_Simple,this._handlers.color=this.onTag_COLOR,this._handlers.font=this.onTag_FONT,this._handlers.size=this.onTag_SIZE}onTag_URL(e,t,r){return t?"</a>":null!=r?'<a href="'+r+'">':'<a href="'+this.getTagText()+'">'}onTag_IMG(e,t,r){if(t)return null;var a=this.getTagText(!0);return a?this.defaultImgWidth?'<img src="'+a+'" width="'+this.defaultImgWidth+'" height="'+this.defaultImgHeight+'"/>':'<img src="'+a+'"/>':null}onTag_B(e,t,r){return t?"</b>":"<b>"}onTag_I(e,t,r){return t?"</i>":"<i>"}onTag_U(e,t,r){return t?"</u>":"<u>"}onTag_Simple(e,t,r){return t?"</"+e+">":"<"+e+">"}onTag_COLOR(e,t,r){return t?"</font>":(this.lastColor=r,'<font color="'+r+'">')}onTag_FONT(e,t,r){return t?"</font>":'<font face="'+r+'">'}onTag_SIZE(e,t,r){return t?"</font>":(this.lastSize=r,'<font size="'+r+'">')}getTagText(e){for(var t,r=this._readPos,a="";-1!=(t=this._text.indexOf("[",r));){if(92!=this._text.charCodeAt(t-1)){a+=this._text.substring(r,t);break}a+=this._text.substring(r,t-1),a+="[",r=t+1}return-1==t?null:(e&&(this._readPos=t),a)}parse(e,t){this._text=e,this.lastColor=null,this.lastSize=null;for(var r,a,i,s,n,o,l,h=0,u="";-1!=(r=e.indexOf("[",h));)if(r>0&&92==e.charCodeAt(r-1))u+=e.substring(h,r-1),u+="[",h=r+1;else{if(u+=e.substring(h,r),h=r,-1==(r=e.indexOf("]",h)))break;i="/"==e.charAt(h+1),s=e.substring(i?h+2:h+1,r),this._readPos=r+1,n=null,o=null,-1!=(a=s.indexOf("="))&&(n=s.substring(a+1),s=s.substring(0,a)),s=s.toLowerCase(),null!=(l=this._handlers[s])?t||null!=(o=l.call(this,s,i,n))&&(u+=o):u+=e.substring(h,this._readPos),h=this._readPos}return h<e.length&&(u+=e.substring(h)),this._text=null,u}}UBBParser.defaultParser=new UBBParser;class Text extends Sprite{constructor(){super(),this._overflow=Text.VISIBLE,this._singleCharRender=!1,this._prompt="",this._textWidth=0,this._textHeight=0,this._textStyle=new TextStyle,this._textStyle.fontSize=Config.defaultFontSize,this._text="",this.font="",this._elements=[],this._lines=[],this._padding=[0,0,0,0],this._fontSizeScale=1}static registerBitmapFont(e,t){t._addReference(),Text._bitmapFonts[e]=t}static unregisterBitmapFont(e,t=!0){let r=Text._bitmapFonts[e];r&&(r._removeReference(),t&&r.destroy(),delete Text._bitmapFonts[e])}destroy(e=!0){recoverLines(this._lines),HtmlElement.returnToPool(this._elements),super.destroy(e)}_getBoundPointsM(e=!1){var t=Rectangle.TEMP;return t.setTo(0,0,this.width,this.height),t._getBoundPoints()}getGraphicBounds(e=!1){var t=Rectangle.TEMP;return t.setTo(0,0,this.width,this.height),t}get_width(){return this._isWidthSet?this._width:this.textWidth}_setWidth(e){super._setWidth(e),this._updatingLayout?this.drawBg():this.markChanged()}get_height(){return this._isHeightSet?this._height:this.textHeight}_setHeight(e){super._setHeight(e),this._updatingLayout?this.drawBg():this.markChanged()}get textWidth(){return this.typeset(),this._textWidth}get textHeight(){return this.typeset(),this._textHeight}get text(){return this._text}set text(e){null==e?e="":"string"!=typeof e&&(e=""+e),!this.ignoreLang&&Text.langPacks&&(e=Text.langPacks[e]||e),this._text!=e&&(this._text=e,this.markChanged(),this.event(Event.CHANGE))}changeText(e){this.text=e}get font(){return this._textStyle.font}set font(e){if(this._textStyle.font=e,e||(e=Config.defaultFont)||(e="Arial"),this._realFont=e,this._bitmapFont=Text._bitmapFonts[e],this._bitmapFont)this._text&&this.markChanged();else if(e&&(Utils.getFileExtension(e)||e.startsWith("res://"))){let t=e,r=ILaya.loader.getRes(e);!r||r.obsolute?ILaya.loader.load(e).then((e=>{e&&this._realFont==t&&(e instanceof BitmapFont?this._bitmapFont=e:this._realFont=e.family,this._text&&this.markChanged())})):(r instanceof BitmapFont?this._bitmapFont=r:this._realFont=r.family,this._text&&this.markChanged())}else this._realFont=ILaya.Browser.onIPhone&&Config.fontFamilyMap[e]||e,this._text&&this.markChanged()}get fontSize(){return this._textStyle.fontSize}set fontSize(e){this._textStyle.fontSize!=e&&(this._textStyle.fontSize=e,this.markChanged())}get color(){return this._textStyle.color}set color(e){this.set_color(e)}set_color(e){this._textStyle.color!=e&&(this._textStyle.color=e,!this._isChanged&&this._graphics&&0==this._elements.length?this._graphics.replaceTextColor(this._textStyle.color):this.markChanged())}get bold(){return this._textStyle.bold}set bold(e){this._textStyle.bold!=e&&(this._textStyle.bold=e,this.markChanged())}get italic(){return this._textStyle.italic}set italic(e){this._textStyle.italic!=e&&(this._textStyle.italic=e,this.markChanged())}get align(){return this._textStyle.align}set align(e){this._textStyle.align!=e&&(this._textStyle.align=e,this.markChanged())}get valign(){return this._textStyle.valign}set valign(e){this._textStyle.valign!=e&&(this._textStyle.valign=e,this.markChanged())}get alignItems(){return this._textStyle.alignItems}set alignItems(e){this._textStyle.alignItems!=e&&(this._textStyle.alignItems=e,this.markChanged())}get wordWrap(){return this._wordWrap}set wordWrap(e){this._wordWrap!=e&&(this._wordWrap=e,this.markChanged())}get leading(){return this._textStyle.leading}set leading(e){this._textStyle.leading!=e&&(this._textStyle.leading=e,this.markChanged())}get padding(){return this._padding}set padding(e){if("string"==typeof e){let t=e.split(",");this._padding.length=0;for(let e=0;e<4;e++){let r=parseFloat(t[e]);isNaN(r)&&(r=0),this._padding.push(r)}}else this._padding=e;this.markChanged()}get bgColor(){return this._bgColor}set bgColor(e){this._bgColor=e,this.drawBg()}get borderColor(){return this._borderColor}set borderColor(e){this._borderColor=e,this.drawBg()}get stroke(){return this._textStyle.stroke}set stroke(e){this._textStyle.stroke!=e&&(this._textStyle.stroke=e,this.markChanged())}get strokeColor(){return this._textStyle.strokeColor}set strokeColor(e){this._textStyle.strokeColor!=e&&(this._textStyle.strokeColor=e,this.markChanged())}get overflow(){return this._overflow}set overflow(e){this._overflow!=e&&(this._overflow=e,this.markChanged())}get underline(){return this._textStyle.underline}set underline(e){this._textStyle.underline!=e&&(this._textStyle.underline=e,this.markChanged())}get underlineColor(){return this._textStyle.underlineColor}set underlineColor(e){this._textStyle.underlineColor!=e&&(this._textStyle.underlineColor=e,this.markChanged())}get singleCharRender(){return this._singleCharRender}set singleCharRender(e){this._singleCharRender=e}get html(){return this._html}set html(e){this._html!=e&&(this._html=e,this.markChanged())}get ubb(){return this._ubb}set ubb(e){this._ubb!=e&&(this._ubb=e,this.markChanged())}get maxWidth(){return this._maxWidth}set maxWidth(e){this._maxWidth!=e&&(this._maxWidth=e,this.markChanged())}get htmlParseOptions(){return this._htmlParseOptions}set htmlParseOptions(e){this._htmlParseOptions=e}parseTemplate(e){let t,r,a,i,s=0,n="";for(;-1!=(t=e.indexOf("{",s));)if(t>0&&92==e.charCodeAt(t-1))n+=e.substring(s,t-1),n+="{",s=t+1;else{if(n+=e.substring(s,t),s=t,t=e.indexOf("}",s),-1==t)break;t!=s+1?(a=e.substring(s+1,t),r=a.indexOf("="),-1!=r?(i=this._templateVars[a.substring(0,r)],n+=null==i?a.substring(r+1):i):(i=this._templateVars[a],null!=i&&(n+=i)),s=t+1):(n+=e.substring(s,s+2),s=t+1)}return s<e.length&&(n+=e.substring(s)),n}get templateVars(){return this._templateVars}set templateVars(e){(this._templateVars||e)&&(this._templateVars=!0===e?{}:!1===e?null:e,this.markChanged())}setVar(e,t){return this._templateVars||(this._templateVars={}),this._templateVars[e]=t,this.markChanged(),this}set scrollX(e){if(this.typeset(),!this._scrollPos)return;let t=this.maxScrollX;e=(e=e<0?0:e)>t?t:e,this._scrollPos.x=e,this.renderText()}get scrollX(){return this._scrollPos?this._scrollPos.x:0}set scrollY(e){if(this.typeset(),!this._scrollPos)return;let t=this.maxScrollY;e=(e=e<0?0:e)>t?t:e,this._scrollPos.y=e,this.renderText()}get scrollY(){return this._scrollPos?this._scrollPos.y:0}get maxScrollX(){let e=this.textWidth-this._width;return e<0?0:e}get maxScrollY(){let e=this.textHeight-this._height;return e<0?0:e}get lines(){return this.typeset(),this._lines}markChanged(){this._isChanged||(this._isChanged=!0,ILaya.systemTimer.callLater(this,this._typeset))}typeset(){this._isChanged&&ILaya.systemTimer.runCallLater(this,this._typeset)}refreshLayout(){ILaya.systemTimer.callLater(this,this.doLayout)}get objContainer(){return this._objContainer||(this._objContainer=new Sprite,this._objContainer.hideFlags|=HideFlags.HideAndDontSave,this.addChild(this._objContainer)),this._objContainer}_typeset(){if(this._isChanged=!1,this._hideText||this._destroyed)return;HtmlElement.returnToPool(this._elements),this._objContainer&&this._objContainer.removeChildren();let t,r=this._text;if(!r&&this._prompt&&(r=this._prompt,t=!0),!r)return this.graphics.clear(!0),this.drawBg(),this._textWidth=this._textHeight=0,this._scrollPos=null,void(this._onPostLayout&&(this._updatingLayout=!0,this._onPostLayout(),this._updatingLayout=!1));let a,i=this._html;if(r=r.replace(We,"\n"),this._parseEscapeChars&&(r=r.replace(Xe,getReplaceStr)),!t&&this._templateVars&&(r=this.parseTemplate(r)),this._ubb&&(r=UBBParser.defaultParser.parse(r),i=!0),!t&&this._asPassword&&(r=Text._passwordChar.repeat(r.length)),t&&(a=this._textStyle.color,this._textStyle.color=this._promptColor),i)HtmlParser.defaultParser.parse(r,this._textStyle,this._elements,this._htmlParseOptions);else{let t=HtmlElement.getFromPool(e.HtmlElementType.Text);Object.assign(t.style,this._textStyle),t.text=r,this._elements.push(t)}t&&(this._textStyle.color=a),this.doLayout()}doLayout(){if(this._destroyed)return;this._updatingLayout=!0,this._fontSizeScale=1;let t,r=this._wordWrap||this._overflow==Text.ELLIPSIS,a=this._padding;if(t=this._isWidthSet?this._width-a[3]-a[1]:Number.MAX_VALUE,this._maxWidth>0){let e=this._maxWidth-a[3]-a[1];(!r||e<t)&&(t=e),r=!0}let i,s,n,o,l,h,u,d=this._isHeightSet?this._height-a[0]-a[2]:Number.MAX_VALUE,_=this._bitmapFont,c="middle"==this._textStyle.alignItems?1:"bottom"==this._textStyle.alignItems?2:0,getTextWidth=e=>{if(_)return _.getTextWidth(e,u);{let t=ILaya.Browser.context.measureText(e);return t?t.width:100}},buildLines=(e,t)=>{if(_)l=_.getMaxWidth(u),h=_.getMaxHeight(u);else{let e=(t.italic?"italic ":"")+(t.bold?"bold ":"")+u+"px "+this._realFont;t._ctxFont=e,ILaya.Browser.context.font=e;let r=ILaya.Browser.context.measureText(Text._testWord);r?(l=r.width,h=Math.ceil(r.height||u)):(l=100,h=u)}let a=e.split("\n");if(r)for(let e=0,r=a.length;e<r;e++){let i=a[e];i.length>0&&wrapText(i,t),e!=r-1&&(endLine(),startLine())}else for(let e=0,r=a.length;e<r;e++){let i=a[e];i.length>0&&addCmd(i,t,null),e!=r-1&&(endLine(),startLine())}},addCmd=(e,t,r)=>{let a=Ge.length>0?Ge.pop():{};a.x=i,a.y=s,"string"==typeof e?(r||(r=getTextWidth(e)),a.wt||(a.wt=new WordText),a.wt.setText(e),a.wt.width=r,a.wt.splitRender=this._singleCharRender,a.width=r,a.height=h):(a.obj=e,a.x++,a.width=e.width+2,a.height=e.height),a.style=t,a.linkEnd=!1,a.next=null,i+=Math.round(a.width),n.cmd?o.next=a:n.cmd=a,o=a},endLine=()=>{let e=0,t=n.cmd;for(;t;)t.height>e&&(e=t.height),t=t.next;for(t=n.cmd;t;)t.y=1==c?Math.floor(.5*(e-t.height)):2==c?Math.floor(e-t.height):0,t=t.next;0==e&&(e=h),e++,n.height=e,n.width=i},startLine=()=>(i=0,n&&(s+=n.height+Math.floor(this._textStyle.leading*this._fontSizeScale)),n=Ve.length>0?Ve.pop():{cmds:[]},n.x=0,n.y=s,this._lines.push(n),n),wrapText=(e,r)=>{let a=Math.max(0,t-i),s=getTextWidth(e);if(s<=a)return void addCmd(e,r,s);let n=0,o=0,h=0,u=testEmoji(e);_||u||(n=Math.floor(a/l),0==n&&(n=1),o=getTextWidth(e.substring(0,n)),a<o&&0!=i&&(endLine(),startLine(),a=t));let d=e.length;for(let l=n;l<d;l++){s=getTextWidth(e.charAt(l)),o+=s;let _=!1;if(u&&l+1<d&&testEmoji(e.charAt(l)+e.charAt(l+1))&&(o+=s>>1,l++,_=!0),o>a){if(_&&(o==s+(s>>1)?l++:l--),0==l){i>0&&(endLine(),startLine(),a=t);continue}let u=e.substring(h,l);o-=s;let p=u.charCodeAt(u.length-1);if((c=p)>=65&&c<=90||c>=97&&c<=122||39===c){let t=He.exec(u);t&&(l=t.index+h,0==t.index?l+=u.length:(o=null,u=e.substring(h,l)))}if(addCmd(u,r,o),endLine(),startLine(),a=t,h=l,!(l+n<d)){addCmd(e.substring(h,d),r),h=-1;break}0!=n&&(l+=n-1),o=getTextWidth(e.substring(h,l+1))}}var c;-1!=h&&addCmd(e.substring(h,d),r)},calcTextSize=()=>{let e=0,t=0;for(let t of this._lines)t.width>e&&(e=t.width);e>0&&(e+=a[1]+a[3]),this._textWidth=e;let r=this._lines[this._lines.length-1];r&&(t=r.y+r.height),t>0&&(t+=a[0]+a[2]),this._textHeight=t},run=()=>{i=s=l=h=0,n=null,o=null,recoverLines(this._lines),startLine();let a=this._elements;for(let s=0,n=a.length;s<n;s++){let n=a[s];if(n.type==e.HtmlElementType.Text)u=Math.floor(n.style.fontSize*this._fontSizeScale),0==u&&(u=1),buildLines(n.text,n.style);else if(n.type==e.HtmlElementType.LinkEnd)o&&(o.linkEnd=!0);else{let e=n.obj;if(!e){let t=HtmlParser.classMap[n.type];t&&(e=Pool.createByClass(t),e.create(this,n),n.obj=e)}if(e){if(r){t-i<e.width+1&&i>0&&(endLine(),startLine())}addCmd(e,n.style)}}}endLine(),calcTextSize()};if(run(),this._overflow==Text.SHRINK){if(this._lines.length>1&&this._textHeight>d){let e=0,r=this._textStyle.fontSize;this._fontSizeScale=Math.sqrt(d/this._textHeight);let a=Math.floor(this._fontSizeScale*this._textStyle.fontSize);for(;run(),this._textWidth>t||this._textHeight>d?r=a:e=a,r-e>1||r!=e&&a==r;)a=e+(r-e)/2,this._fontSizeScale=a/this._textStyle.fontSize}else if(this._textWidth>t&&(this._fontSizeScale=t/this._textWidth,run(),this._textWidth>t)){let e=Math.floor(this._textStyle.fontSize*this._fontSizeScale);e--,this._fontSizeScale=e/this._textStyle.fontSize,run()}}else if(this._overflow==Text.ELLIPSIS&&(this._textWidth>t||this._textHeight>d)){let e=this._lines.findIndex((e=>e.y+e.height>d));0==e&&(e=1);let r=!1;-1!=e&&this._lines.length>e&&(recoverLines(this._lines.splice(e,this._lines.length-e)),r=!0);let a,i=this._lines[this._lines.length-1].cmd,s=!1;for(;i;)a=i.next,s?(i.obj?i.obj=null:i.wt&&i.wt.cleanCache(),Ge.push(i)):(!a&&r||i.x+i.width>t)&&(i.obj&&(i.obj=null),i.wt||(i.wt=new WordText),i.wt.setText(i.wt.text.substring(0,Math.max(0,i.wt.text.length-2))+ze),u=i.style.fontSize,i.width=i.wt.width=getTextWidth(i.wt.text),i.wt.splitRender=this._singleCharRender,i.next=null,s=!0),i=a;s&&calcTextSize()}this._onPostLayout&&this._onPostLayout();let p="center"==this._textStyle.align?1:"right"==this._textStyle.align?2:0;if(0!=p&&this._isWidthSet){let e=this._width-a[3]-a[1];for(let t of this._lines){let r=0;1==p?r=Math.floor(.5*(e-t.width)):2==p&&(r=e-t.width),r>0&&(t.x=r)}}if(this._isHeightSet&&this._textHeight<this._height){let e=0;if("middle"===this._textStyle.valign?e=Math.floor(.5*(this._height-this._textHeight)):"bottom"===this._textStyle.valign&&(e=this._height-this._textHeight),e>0)for(let t of this._lines)t.y+=e}if(this._overflow==Text.SCROLL&&(this._isWidthSet&&this._textWidth>this._width||this._isHeightSet&&this._textHeight>this._height))if(this._scrollPos){let e=this.maxScrollX,t=this.maxScrollY;this._scrollPos.x>e&&(this._scrollPos.x=e),this._scrollPos.y>t&&(this._scrollPos.y=t)}else this._scrollPos=new Point(0,0);else this._scrollPos=null;this._objContainer&&(this._objContainer.size(this._width,this._height),this._scrollPos||this._overflow==Text.HIDDEN&&this._objContainer.numChildren>0?(this._objContainer.scrollRect||(this._objContainer.scrollRect=new Rectangle),this._objContainer.scrollRect.setTo(0,0,this._width,this._height)):this._objContainer.scrollRect=null),this._updatingLayout=!1,this.renderText()}renderText(){let t=this.graphics;t.clear(!0),this.drawBg();let r=this._padding,a=r[3],i=r[0],s=this._bitmapFont,n=this._scrollPos,o=this._isWidthSet?this._width:this._textWidth,l=this._isHeightSet?this._height:this._textHeight,h=l-r[2],u=this._overflow==Text.HIDDEN||this._overflow==Text.SCROLL;u&&(t.save(),t.clipRect(0,0,o,l),this.repaint()),o-=r[3]+r[1],l-=r[0]+r[2];let d,_,c=0,p=0,m=this._lines,f=m.length;for(let r=0;r<f;r++){let l=m[r];c=a+l.x,p=i+l.y,n&&(c-=n.x,p-=n.y);let f=u&&(p+l.height<=i||p>=h),g=l.cmd;for(;g;){if(g.linkEnd&&d&&(d.addRect(_,p,c+g.x+g.width-_,l.height),d=null),g.obj)g.obj.pos(c+g.x,p+g.y),g.obj.element.type==e.HtmlElementType.Link&&(d=g.obj,d.resetArea(),_=c+g.x);else if(!f)if(s){let e=0,r=g.wt.text,a=s.tint?g.style.color:"#FFFFFF",i=Math.floor((s.autoScaleSize?g.style.fontSize:s.fontSize)*this._fontSizeScale)/s.fontSize;for(let n=0,o=r.length;n<o;n++){let o=r.charCodeAt(n),l=s.dict[o];l&&(l.texture&&t.drawImage(l.texture,c+g.x+e+l.x*i,p+g.y+l.y*i,l.width*i,l.height*i,a),e+=Math.round(l.advance*i))}}else{let e=g.style._ctxFont;g.style.stroke?t.fillBorderText(g.wt,c+g.x,p+g.y,e,g.style.color,null,g.style.stroke,g.style.strokeColor):t.fillText(g.wt,c+g.x,p+g.y,e,g.style.color,null)}if(!f&&g.style.underline){let e=Math.max(1,g.style.fontSize*this._fontSizeScale/16);t.drawLine(c+g.x,p+l.height-e,c+g.x+g.width,p+l.height-e,g.style.underlineColor||g.style.color,e)}g=g.next}d&&(d.addRect(_,p,o-_+a,l.height),_=a)}u&&t.restore()}drawBg(){let e=this._bgDrawCmd;if(this._bgColor||this._borderColor){e||(e=new DrawRectCmd,e.x=e.y=0,e.width=e.height=1,e.percent=!0,this._bgDrawCmd=e),e.fillColor=this._bgColor,e.lineColor=this._borderColor,e.lineWidth=this._borderColor?1:0;let t=this.graphics.cmds,r=t.indexOf(e);0!=r&&(-1!=r&&t.splice(r,1),t.unshift(e),this.graphics.cmds=t)}else e&&this.graphics.removeCmd(e)}}Text.VISIBLE="visible",Text.SCROLL="scroll",Text.HIDDEN="hidden",Text.SHRINK="shrink",Text.ELLIPSIS="ellipsis",Text.RightToLeft=!1,Text._testWord="游",Text._passwordChar="●",Text._bitmapFonts={};const Ge=[],Ve=[];function recoverLines(e){for(let t of e){let e=t.cmd;for(;e;)e.obj?e.obj=null:e.wt&&e.wt.cleanCache(),Ge.push(e),e=e.next;t.cmd=null}Ve.push(...e),e.length=0}const ke=/[\uD800-\uDBFF][\uDC00-\uDFFF]/g;function testEmoji(e){return null!=e&&ke.test(e)}const He=/(?:[^\s\!-\/])+$/,We=/\r\n/g,Xe=/\\(\w)/g,Ye={"\\n":"\n","\\t":"\t"},ze="…";function getReplaceStr(e){return Ye[e]}var je=!0;const Ke=new Point,qe=new Rectangle,Qe=[],$e=[];var Ze;class InputManager{constructor(){this._touches=[],this._touchPool=[],this._mouseTouch=new TouchInfo(this._touches),this._pressKeys=new Set,this._keyEvent=new Event,this._keyEvent._touches=this._touches}static get inst(){return Ze}static getTouchPos(e){var t,r;return null==e?(null===(t=Ze._touches[0])||void 0===t?void 0:t.pos)||Point.EMPTY:(null===(r=Ze.getTouch(e))||void 0===r?void 0:r.pos)||Point.EMPTY}static get touchTarget(){return Ze._touchTarget}static get touches(){return Ze._touches}static get touchCount(){return Ze._touches.length}static cancelClick(e){let t=null==e?Ze._touches[0]:Ze.getTouch(e);t&&(t.clickCancelled=!0)}static hasKeyDown(e){return Ze._pressKeys.has(e)}static __init__(e,t){let r=Ze=new InputManager;r._stage=e,t.oncontextmenu=()=>!1,t.addEventListener("mousedown",(e=>{Browser.onIE||e.cancelable&&e.preventDefault(),r._touchInput||r.handleMouse(e,0)}),{passive:!1}),t.addEventListener("mouseup",(e=>{e.cancelable&&e.preventDefault(),r._touchInput||r.handleMouse(e,1)}),{passive:!1}),t.addEventListener("mousemove",(e=>{e.cancelable&&e.preventDefault(),r._touchInput||r.handleMouse(e,2)}),{passive:!1}),t.addEventListener("mouseout",(e=>{r._touchInput||r.handleMouse(e,3)}),{passive:!1}),t.addEventListener("touchstart",(e=>{r._touchInput=!0,je||InputManager.isTextInputting||e.cancelable&&e.preventDefault(),r.handleTouch(e,0)}),{passive:!1}),t.addEventListener("touchend",(e=>{je||InputManager.isTextInputting||e.cancelable&&e.preventDefault(),je=!1,r.handleTouch(e,1)}),{passive:!1}),t.addEventListener("touchmove",(e=>{e.cancelable&&e.preventDefault(),r.handleTouch(e,2)}),{passive:!1}),t.addEventListener("touchcancel",(e=>{e.cancelable&&e.preventDefault(),r.handleTouch(e,3)}),{passive:!1}),t.addEventListener("wheel",(e=>{r.handleMouse(e,4)}),{passive:!1}),t.addEventListener("pointerdown",(e=>{t.setPointerCapture(e.pointerId)})),t.addEventListener("pointerup",(e=>{t.releasePointerCapture(e.pointerId)}),!0);let a=Browser.document;a.addEventListener("keydown",(e=>{r.handleKeys(e)}),!0),a.addEventListener("keypress",(e=>{r.handleKeys(e)}),!0),a.addEventListener("keyup",(e=>{r.handleKeys(e)}),!0)}handleMouse(e,t){var r,a,i,s,n;this._eventType=t,this._nativeEvent=e;let o=this._mouseTouch;Ke.setTo(e.pageX||e.clientX,e.pageY||e.clientY),this._stage._canvasTransform&&this._stage._canvasTransform.invertTransformPoint(Ke),InputManager.mouseX=Ke.x,InputManager.mouseY=Ke.y;let l=Ke.x/this._stage.clientScaleX,h=Ke.y/this._stage.clientScaleY;if(o.event.nativeEvent=e,3!=t&&InputManager.mouseEventsEnabled){o.target=this._touchTarget=this.getNodeUnderPoint(l,h);let e=Math.round(l),t=Math.round(h);if((e!=o.pos.x||t!=o.pos.y)&&(this._stage._mouseMoveTime=Browser.now(),o.pos.setTo(e,t),o.move(),InputManager.mouseEventsEnabled)){o.target.bubbleEvent(Event.MOUSE_MOVE,o.event);for(let e of o.downTargets)e.event(Event.MOUSE_DRAG,o.event)}}else o.target=this._touchTarget=null;if(o.lastRollOver!=o.target&&this.handleRollOver(o),0==t)o.began||(o.begin(),this._touches[0]=o,o.event.button=e.button,InputManager.mouseEventsEnabled&&(this.handleFocus(),0==e.button?null===(r=o.target)||void 0===r||r.bubbleEvent(Event.MOUSE_DOWN,o.event):null===(a=o.target)||void 0===a||a.bubbleEvent(Event.RIGHT_MOUSE_DOWN,o.event)));else if(1==t){if(o.began){if(o.end(),this._touches.length=0,o.event.button=e.button,InputManager.mouseEventsEnabled){if(0==e.button?null===(i=o.target)||void 0===i||i.bubbleEvent(Event.MOUSE_UP,o.event):null===(s=o.target)||void 0===s||s.bubbleEvent(Event.RIGHT_MOUSE_UP,o.event),o.moved)for(let e of o.downTargets)e.event(Event.MOUSE_DRAG_END,o.event);let t=o.clickTest();t&&(0==e.button?(o.event.isDblClick=2==o.clickCount,t.bubbleEvent(Event.CLICK,o.event),2==o.clickCount&&t.bubbleEvent(Event.DOUBLE_CLICK,o.event),o.event.isDblClick=!1):(o.event.isDblClick=2==o.clickCount,t.bubbleEvent(Event.RIGHT_CLICK,o.event),o.event.isDblClick=!1))}o.event.button=0}}else 4==t&&InputManager.mouseEventsEnabled&&(o.event.delta=.025*e.deltaY,null===(n=o.target)||void 0===n||n.bubbleEvent(Event.MOUSE_WHEEL,o.event),o.event.delta=0)}handleTouch(e,t){var r,a;this._eventType=t,this._nativeEvent=e;let i=e.changedTouches;for(let s=0;s<i.length;++s){let n=i[s];if(!InputManager.multiTouchEnabled&&this._touches.length>0&&this._touches[0].touchId!=n.identifier)continue;Ke.setTo(n.pageX,n.pageY),this._stage._canvasTransform&&this._stage._canvasTransform.invertTransformPoint(Ke),InputManager.mouseX=Ke.x,InputManager.mouseY=Ke.y;let o=Ke.x/this._stage.clientScaleX,l=Ke.y/this._stage.clientScaleY,h=this.getTouch(n.identifier,0==t);if(h){if(h.event.nativeEvent=e,h.event.touchId=h.touchId,3!=t&&InputManager.mouseEventsEnabled){h.target=this._touchTarget=this.getNodeUnderPoint(o,l),this._stage._mouseMoveTime=Browser.now();let e=Math.round(o),r=Math.round(l);if((Math.abs(e-h.pos.x)>1.5||Math.abs(r-h.pos.y)>1.5)&&(h.pos.setTo(e,r),2==t&&(h.move(),InputManager.mouseEventsEnabled))){h.target.bubbleEvent(Event.MOUSE_MOVE,h.event);for(let e of h.downTargets)e.event(Event.MOUSE_DRAG,h.event)}}else h.target=this._touchTarget=null;if(h.lastRollOver!=h.target&&this.handleRollOver(h),0==t)h.began||(h.begin(),InputManager.mouseEventsEnabled&&(this.handleFocus(),null===(r=h.target)||void 0===r||r.bubbleEvent(Event.MOUSE_DOWN,h.event)));else if(1==t||3==t){if(h.began){if(h.end(),InputManager.mouseEventsEnabled){if(null===(a=h.target)||void 0===a||a.bubbleEvent(Event.MOUSE_UP,h.event),h.moved)for(let e of h.downTargets)e.event(Event.MOUSE_DRAG_END,h.event);if(3!=t){let e=h.clickTest();null!=e&&(h.event.isDblClick=2==h.clickCount,e.bubbleEvent(Event.CLICK,h.event),2==h.clickCount&&e.bubbleEvent(Event.DOUBLE_CLICK,h.event),h.event.isDblClick=!1)}}h.target=null,this.handleRollOver(h)}h.reset(),this._touches.splice(this._touches.indexOf(h),1),this._touchPool.push(h)}}}}getTouch(e,t){let r=this._touches.find((t=>t.touchId==e));return r||!t||(r=this._touchPool.length>0?this._touchPool.pop():new TouchInfo(this._touches),r.touchId=e,this._touches.push(r)),r}handleFocus(){if(InputManager.isTextInputting&&this._stage.focus&&this._stage.focus.focus&&!this._stage.focus.contains(this._touchTarget)){let e=this._stage.focus._tf||this._stage.focus,t=this._touchTarget._tf||this._touchTarget;t.nativeInput&&t.multiline==e.multiline?e._focusOut():e.focus=!1}}handleKeys(e){let t=e.type,r=e.keyCode;if("keydown"===t?(0!=r&&this._pressKeys.add(r),this._pressKeys.add(e.key)):"keyup"===t&&(0!=r&&this._pressKeys.delete(r),this._pressKeys.delete(e.key)),this._keyEvent.nativeEvent=e,InputManager.keyEventsEnabled){let e=this._stage.focus&&null!=this._stage.focus.event&&this._stage.focus.displayedInStage?this._stage.focus:this._stage,r=e;for(;r;)r.event(t,this._keyEvent.setTo(t,r,e)),r=r.parent}this._keyEvent.nativeEvent=null}getNodeUnderPoint(e,t){let r=this.getSpriteUnderPoint(this._stage,e,t);return r||(r=this.getSprite3DUnderPoint(e,t)),r||this._stage}getSpriteUnderPoint(e,t,r){let a=e._style.scrollRect;if(a&&!e._getBit(NodeFlags.DISABLE_INNER_CLIPPING)&&(qe.setTo(a.x,a.y,a.width,a.height),!qe.contains(t,r)))return null;let i=e._getBit(NodeFlags.EDITING_NODE);if(!i&&e.hitTestPrior&&!e.mouseThrough&&e!=this._stage&&!this.hitTest(e,t,r))return null;for(let a=e._children.length-1;a>-1;a--){let s=e._children[a],n=i||s._getBit(NodeFlags.EDITING_NODE);if(!s._destroyed&&(n?(!s.hasHideFlag(HideFlags.HideInHierarchy)||s.mouseThrough)&&!s._getBit(NodeFlags.HIDE_BY_EDITOR):s._mouseState>1)&&(s._visible||s._getBit(NodeFlags.DISABLE_VISIBILITY))){Ke.setTo(t,r),s.fromParentPoint(Ke);let e=this.getSpriteUnderPoint(s,Ke.x,Ke.y);if(e)return e}}if(i){if(!e._getBit(NodeFlags.LOCK_BY_EDITOR)&&!e.hasHideFlag(HideFlags.HideInHierarchy)&&this.hitTest(e,t,r,i))return e}else if(e!=this._stage&&(e.hitTestPrior&&!e.mouseThrough||this.hitTest(e,t,r)))return e;return null}getSprite3DUnderPoint(e,t){return null}hitTest(e,t,r,a){let i=!1;e.scrollRect&&(t-=e._style.scrollRect.x,r-=e._style.scrollRect.y);let s=e._style.hitArea,n=e.mouseThrough;return a&&(s=null,n=!1),s?s.contains(t,r,e):((e.width>0&&e.height>0||n||s)&&(i=n?e.getGraphicBounds().contains(t,r):(s||qe.setTo(0,0,e.width,e.height)).contains(t,r)),i)}handleRollOver(e){if(!InputManager.mouseEventsEnabled)return void(e.lastRollOver=e.target);Qe.length=0,$e.length=0;let t=e.lastRollOver;for(;t;)$e.push(t),t=t.parent;for(e.lastRollOver=e.target,t=e.target;t;){let e=$e.indexOf(t);if(-1!=e){$e.splice(e,$e.length-e);break}Qe.push(t),t=t.parent}let r=$e.length;if(r>0){for(let a=0;a<r;a++)t=$e[a],t._destroyed||t.event(Event.MOUSE_OUT,e.event.setTo(Event.MOUSE_OUT,t,t));$e.length=0}if(r=Qe.length,r>0){for(let a=0;a<r;a++)t=Qe[a],t.activeInHierarchy&&t.event(Event.MOUSE_OVER,e.event.setTo(Event.MOUSE_OVER,t,t));Qe.length=0}}}InputManager.multiTouchEnabled=!0,InputManager.mouseEventsEnabled=!0,InputManager.keyEventsEnabled=!0,InputManager.clickTestThreshold=10,InputManager.mouseX=0,InputManager.mouseY=0,InputManager.isTextInputting=!1,InputManager.isiOSWKwebView=!1;const Je={};class TouchInfo{constructor(e){this.downPos=new Point,this.downTargets=[],this.event=new Event,this.event._touches=e,this.pos=this.event.touchPos,this.reset()}begin(){if(this.began=!0,this.clickCancelled=!1,this.moved=!1,this.downPos.copy(this.pos),this.downTargets.length=0,this.target){let e=this.target;for(;e;)this.downTargets.push(e),e=e.parent}}move(){this.moved=!0,(Math.abs(this.pos.x-this.downPos.x)>InputManager.clickTestThreshold||Math.abs(this.pos.y-this.downPos.y)>InputManager.clickTestThreshold)&&(this.clickCancelled=!0)}end(){this.began=!1;let e=performance.now(),t=Je[this.touchId];t||(t={pos:new Point,time:0,button:0},Je[this.touchId]=t),0==this.downTargets.length||this.clickCancelled||Math.abs(this.pos.x-this.downPos.x)>InputManager.clickTestThreshold||Math.abs(this.pos.y-this.downPos.y)>InputManager.clickTestThreshold?(this.clickCancelled=!0,t.time=0,this.clickCount=1):(e-t.time<350&&Math.abs(this.pos.x-t.pos.x)<InputManager.clickTestThreshold&&Math.abs(this.pos.y-t.pos.y)<InputManager.clickTestThreshold&&t.button==this.event.button?this.clickCount=2:this.clickCount=1,t.time=e,t.pos.copy(this.pos),t.button=this.event.button)}clickTest(){if(this.clickCancelled)return this.downTargets.length=0,null;let e=this.downTargets[0];if(e.activeInHierarchy)return this.downTargets.length=0,e;for(e=this.target;e;){if(-1!=this.downTargets.indexOf(e)&&e.activeInHierarchy)break;e=e.parent}return this.downTargets.length=0,e}reset(){this.pos.setTo(0,0),this.touchId=0,this.clickCount=0,this.began=!1,this.moved=!1,this.target=null,this.downTargets.length=0,this.lastRollOver=null,this.clickCancelled=!1}}class Render{static customRequestAnimationFrame(e,t){Render._customRequestAnimationFrame=e,Render._loopFunction=t}static set customRenderEngine(e){Render._customEngine=e}static get customRenderEngine(){return Render._customEngine}constructor(e,t,r){this._first=!0,this._startTm=0,this._timeId=0,Render._Render=this,Render._mainCanvas=r;let a=Render._mainCanvas.source;a.id="layaCanvas",a.width=e,a.height=t,LayaEnv.isConch&&document.body.appendChild(a),this.initRender(Render._mainCanvas,e,t),Config._enableWindowRAFFunction?window.requestAnimationFrame(loop):requestAnimationFrame(loop);let i=this;performance.now();let s=Config.FPS,n=Render.ifps=1e3/s;function loop(e){performance.now(),i._first&&(i._startTm=Math.floor(e/n)*n,i._first=!1),e-=i._startTm;let t=Math.floor(e/n);(t-Render.lastFrm>0||LayaEnv.isConch||!Config.fixedFrames)&&(Render.lastFrm=t,ILaya.stage._loop()),Render._customRequestAnimationFrame&&Render._loopFunction?Render._customRequestAnimationFrame(Render._loopFunction):Config._enableWindowRAFFunction?window.requestAnimationFrame(loop):requestAnimationFrame(loop)}ILaya.stage.on("visibilitychange",this,this._onVisibilitychange)}_onVisibilitychange(){ILaya.stage.isVisibility?0!=this._timeId&&window.clearInterval(this._timeId):this._timeId=window.setInterval(this._enterFrame,1e3)}static vsyncTime(){return Render.lastFrm*Render.ifps}initRender(e,t,r){e.size(t,r),ShaderDefines2D.__init__(),VertexElementFormat.__init__(),Context.__init__(),SubmitBase.__init__();var a=new Context;return Context._rendercontex=a,a.isMain=!0,Render._context=a,e._setContext(a),Shader2D.__init__(),BlendMode._init_(),!0}_enterFrame(e=null){ILaya.stage._loop()}static get context(){return Render._context}static get canvas(){return Render._mainCanvas.source}}Render.lastFrm=0,Render.ifps=1e3/60;const et={Int8Array:Int8Array,Uint8Array:Uint8Array,Int16Array:Int16Array,Uint16Array:Uint16Array,Int32Array:Int32Array,Uint32Array:Uint32Array,Float32Array:Float32Array,Float64Array:Float64Array};var tt,rt,at;class SerializeUtil{static decodeObj(e,t,r){r?(tt=r.outErrors,rt=r.getNodeByRef,at=r.getNodeData):(tt=null,rt=null,at=null),SerializeUtil.isDeserializing=!0;try{return SerializeUtil._decodeObj(e,t)}finally{SerializeUtil.isDeserializing=!1}}static _decodeObj(e,t){if(null==e)return null;if(Array.isArray(e)){let t=[];for(let r=0;r<e.length;r++){let a=e[r];if(null!=a)try{t[r]=SerializeUtil._decodeObj(a)}catch(e){tt&&tt.push(e),t[r]=null}else t[r]=null}return t}if("object"==typeof e){if(null!=e._$uuid){let t=URL.getResURLByUUID(e._$uuid);return ILaya.loader.getRes(t,SerializeUtil.getLoadTypeByEngineType(e._$type))}if(null!=e._$ref){let t=null==rt?void 0:rt(e._$ref);if(t&&e._$type){let r=ClassUtils.getClass(e._$type);return r?t.getComponent(r):null}return t}let r=e._$type;if("any"===r)return e._$type?e.value:e;let a=et[r];if(null!=a)return e._$type?new a(e.value):new a(e);if(!t){let e=ClassUtils.getClass(r);if(!e)return null;t=new e}for(let r in e){if(r.startsWith("_$"))continue;let a=e[r];if(null==a||"object"!=typeof a||Array.isArray(a)||a._$type||a._$uuid||a._$ref)try{let e=SerializeUtil._decodeObj(a);t[r]=e,null!=e&&null!=a&&a._$tmpl&&(t[a._$tmpl]=at(e))}catch(e){tt&&tt.push(e)}else{let e=t[r];if(e)try{SerializeUtil._decodeObj(a,e)}catch(e){tt&&tt.push(e)}}}return t.onAfterDeserialize&&t.onAfterDeserialize(),t}return e}static getLoadTypeByEngineType(e){switch(e){case"Texture2D":case"RenderTexture":return Loader.TEXTURE2D;case"TextureCube":return Loader.TEXTURECUBE;case"Prefab":return Loader.HIERARCHY;default:return null}}static bakeOverrideData(e){let t=null;for(let r=e.length,a=r-1;a>=0;a--){let i=e[a];if(i&&i.length>0)for(let e of i){let i,s=e._$override||e._$parent;if(Array.isArray(s)?i=s[r-a-1]:a==r-1&&(i=s),null!=i){t||(t={});let s=t[i];s||(t[i]=s=[]),s.push(r-a,e)}}}return t}static applyOverrideData(e,t){return function test(e){if(t[e._$id])return!0;let r=e._$child;return!(!r||!r.find((e=>test(e))))}(e)&&(e=function cloneTree(e){let t=Object.assign({},e),r=t._$child;r&&(t._$child=r.map((e=>cloneTree(e))));let a=t._$comp;return a&&(t._$comp=a.map((e=>Object.assign({},e)))),t}(e),function visit(e){let r=e._$child;if(r)for(let e of r)e._$id&&visit(e);let a=t[e._$id];if(a)for(let t=0;t<a.length;t+=2){let i,s=a[t],n=a[t+1];if(i=n._$override){let t;if(Array.isArray(i))if(s==i.length-1){let a=i[s];r?t=r.find((e=>e._$override==a)):e._$child=r=[],t||(t={_$override:a},r.push(t))}else if(s<i.length-1){let a=i.slice(s);r?t=r.find((e=>{let t=e._$override;return Array.isArray(t)&&arrayEquals(t,a)})):e._$child=r=[],t||(t={_$override:a},r.push(t))}else t=e;else t=e;if(mergeData(t,n),n._$comp){let e=t._$comp;e||(t._$comp=e=[]);for(let t of n._$comp){let r=t._$type||t._$override,a=e.find((e=>e._$override==r||e._$type==r));a||(a={},t._$type?a._$type=r:a._$override=r,e.push(a)),mergeData(a,t)}}}else if(i=n._$parent){let t;if(r||(e._$child=r=[]),s<i.length){t=s==i.length-1?i[s]:i.slice(s);let e=Object.assign({},n);e._$parent=t,r.push(e)}else{let t=Object.assign({},n);delete t._$parent,e._$prefab?r.push(t):(delete t._$index,n._$index<r.length?r.splice(n._$index,0,t):r.push(t))}}}}(e)),e}}function mergeData(e,t){for(let r in t){if(r.startsWith("_$"))continue;let a=t[r];if(null==a||"object"!=typeof a||Array.isArray(a)||(a._$type||a._$uuid||a._$ref))e[r]=a;else{let t=e[r];null!=t&&"object"==typeof t?(e[r]=t=Object.assign({},t),mergeData(t,a)):e[r]=a}}}function arrayEquals(e,t){if(e.length===t.length){for(var r=0;r<e.length;r++)if(e[r]!==t[r])return!1;return!0}return!1}SerializeUtil.isDeserializing=!1;class Input extends Text{constructor(){super(),this._multiline=!1,this._editable=!0,this._maxChars=0,this._type="text",Input.IOS_IFRAME=ILaya.Browser.onIOS&&ILaya.Browser.window.top!=ILaya.Browser.window.self,this._width=100,this._height=20,this.multiline=!1,this.overflow=Text.SCROLL,this._promptColor="#A9A9A9",this.on(Event.MOUSE_DOWN,this,this._onMouseDown),this.on(Event.UNDISPLAY,this,this._onUnDisplay)}static __init__(){if(Input._createInputElement(),ILaya.Browser.onMobile){var e=!1;(ILaya.Browser.onMiniGame||ILaya.Browser.onBDMiniGame||ILaya.Browser.onQGMiniGame||ILaya.Browser.onKGMiniGame||ILaya.Browser.onVVMiniGame||ILaya.Browser.onAlipayMiniGame||ILaya.Browser.onQQMiniGame||ILaya.Browser.onBLMiniGame||ILaya.Browser.onTTMiniGame||ILaya.Browser.onHWMiniGame||ILaya.Browser.onTBMiniGame)&&(e=!0),Render.canvas.addEventListener(Input.IOS_IFRAME?e?"touchend":"click":"touchend",Input._popupInputMethod)}}static _popupInputMethod(e){InputManager.isTextInputting&&Input.inputElement.focus()}static _createInputElement(){Input._initInput(Input.area=ILaya.Browser.createElement("textarea")),Input._initInput(Input.input=ILaya.Browser.createElement("input")),Input.inputContainer=ILaya.Browser.createElement("div"),Input.inputContainer.style.position="absolute",Input.inputContainer.style.zIndex="1E5",ILaya.Browser.container.appendChild(Input.inputContainer),Input.inputContainer.setPos=function(e,t){Input.inputContainer.style.left=e+"px",Input.inputContainer.style.top=t+"px"}}static _initInput(e){var t=e.style;t.cssText="position:absolute;overflow:hidden;resize:none;transform-origin:0 0;-webkit-transform-origin:0 0;-moz-transform-origin:0 0;-o-transform-origin:0 0;",t.resize="none",t.backgroundColor="transparent",t.border="none",t.outline="none",t.zIndex="1",e.addEventListener("input",Input._processInputting),e.addEventListener("mousemove",Input._stopEvent,{passive:!1}),e.addEventListener("mousedown",Input._stopEvent,{passive:!1}),e.addEventListener("touchmove",Input._stopEvent,{passive:!1}),e.setFontFace=function(t){e.style.fontFamily=t},LayaEnv.isConch&&!Input.isAppUseNewInput||(e.setColor=function(t){e.style.color=t},e.setFontSize=function(t){e.style.fontSize=t+"px"})}static _processInputting(e){var t=Input.inputElement.target;if(t){var r=Input.inputElement.value;t._restrictPattern&&(r=r.replace(/\u2006|\x27/g,""),t._restrictPattern.test(r)&&(r=r.replace(t._restrictPattern,""),Input.inputElement.value=r)),null==r&&(r=""),t._text=r,t.event(Event.INPUT)}}static _stopEvent(e){"touchmove"==e.type&&e.preventDefault(),e.stopPropagation&&e.stopPropagation()}setSelection(e,t){this.focus=!0,Input.inputElement.selectionStart=e,Input.inputElement.selectionEnd=t}get multiline(){return this._multiline}set multiline(e){this._multiline=e,SerializeUtil.isDeserializing||(this.valign=e?"top":"middle")}get nativeInput(){return this._multiline?Input.area:Input.input}_onUnDisplay(e=null){this.focus=!1}_onMouseDown(e){this.focus=!0}_syncInputTransform(){var e=this.nativeInput,t=SpriteUtils.getTransformRelativeToWindow(this,this._padding[3],this._padding[0]),r=this._width-this._padding[1]-this._padding[3],a=this._height-this._padding[0]-this._padding[2];LayaEnv.isConch&&!Input.isAppUseNewInput?(e.setScale(t.scaleX,t.scaleY),e.setSize(r,a),e.setPos(t.x,t.y)):(Input.inputContainer.style.transform=Input.inputContainer.style.webkitTransform="scale("+t.scaleX+","+t.scaleY+") rotate("+ILaya.stage.canvasDegree+"deg)",e.style.width=r+"px",e.style.height=a+"px",Input.inputContainer.style.left=t.x+"px",Input.inputContainer.style.top=t.y+"px")}select(){this.nativeInput.select()}get focus(){return this._focus}set focus(e){var t=this.nativeInput;this._focus!==e&&(e?(t.target?t.target._focusOut():this._setInputMethod(),(t=this.nativeInput).target=this,this._focusIn()):(t.target=null,this._focusOut(),ILaya.Browser.document.body.scrollTop=0,t.blur(),LayaEnv.isConch&&!Input.isAppUseNewInput?t.setPos(-1e4,-1e4):Input.inputContainer.contains(t)&&Input.inputContainer.removeChild(t)))}_setInputMethod(){Input.input.parentElement&&Input.inputContainer.removeChild(Input.input),Input.area.parentElement&&Input.inputContainer.removeChild(Input.area),ILaya.Browser.onAndroid&&(Input.input=Input.inputElement=ILaya.Browser.createElement("input"),Input._initInput(Input.input)),Input.inputElement=this._multiline?Input.area:Input.input,Input.inputContainer.appendChild(Input.inputElement),Text.RightToLeft&&(Input.inputElement.style.direction="rtl")}_focusIn(){InputManager.isTextInputting=!0;var e=this.nativeInput;Input.input&&(Input.input.type=this._type),this._focus=!0;var t=e.style;t.whiteSpace=this.wordWrap?"pre-wrap":"nowrap",this._setPromptColor(),e.readOnly=!this._editable,LayaEnv.isConch&&!Input.isAppUseNewInput&&(e.setType(this._type),e.setForbidEdit(!this._editable)),e.maxLength=this._maxChars<=0?1e5:this._maxChars,e.value=this._text,e.placeholder=this._prompt,ILaya.stage.off(Event.KEY_DOWN,this,this._onKeyDown),ILaya.stage.on(Event.KEY_DOWN,this,this._onKeyDown),ILaya.stage.focus=this,this.event(Event.FOCUS),ILaya.Browser.onPC&&e.focus(),LayaEnv.isConch&&Input.isAppUseNewInput||ILaya.Browser.onMiniGame||ILaya.Browser.onBDMiniGame||ILaya.Browser.onQGMiniGame||ILaya.Browser.onKGMiniGame||ILaya.Browser.onVVMiniGame||ILaya.Browser.onAlipayMiniGame||ILaya.Browser.onQQMiniGame||ILaya.Browser.onBLMiniGame||ILaya.Browser.onTTMiniGame||ILaya.Browser.onHWMiniGame||ILaya.Browser.onTBMiniGame||(this.graphics.clear(!0),this.drawBg(),this._hideText=!0),e.setColor(this.color),e.setFontSize(this.fontSize),e.setFontFace(this._realFont),LayaEnv.isConch&&!Input.isAppUseNewInput&&e.setMultiAble&&e.setMultiAble(this._multiline),t.lineHeight=this.leading+this.fontSize+"px",t.fontStyle=this.italic?"italic":"normal",t.fontWeight=this.bold?"bold":"normal",t.textAlign=this.align,t.padding="0 0",this._syncInputTransform(),!LayaEnv.isConch&&ILaya.Browser.onPC&&ILaya.systemTimer.frameLoop(1,this,this._syncInputTransform)}_setPromptColor(){Input.promptStyleDOM=ILaya.Browser.getElementById("promptStyle"),Input.promptStyleDOM||(Input.promptStyleDOM=ILaya.Browser.createElement("style"),Input.promptStyleDOM.setAttribute("id","promptStyle"),ILaya.Browser.document.head.appendChild(Input.promptStyleDOM)),Input.promptStyleDOM.innerText="input::-webkit-input-placeholder, textarea::-webkit-input-placeholder {color:"+this._promptColor+"}input:-moz-placeholder, textarea:-moz-placeholder {color:"+this._promptColor+"}input::-moz-placeholder, textarea::-moz-placeholder {color:"+this._promptColor+"}input:-ms-input-placeholder, textarea:-ms-input-placeholder {color:"+this._promptColor+"}"}_focusOut(){InputManager.isTextInputting&&(InputManager.isiOSWKwebView||(InputManager.isTextInputting=!1),this._focus=!1,this._hideText=!1,this.text=this.nativeInput.value,this.markChanged(),this.typeset(),ILaya.stage.off(Event.KEY_DOWN,this,this._onKeyDown),ILaya.stage.focus=null,this.event(Event.BLUR),this.event(Event.CHANGE),LayaEnv.isConch&&!Input.isAppUseNewInput&&this.nativeInput.blur(),ILaya.Browser.onPC&&ILaya.systemTimer.clear(this,this._syncInputTransform))}_onKeyDown(e){13===e.keyCode&&(ILaya.Browser.onMobile&&!this._multiline&&(this.focus=!1),this.event(Event.ENTER))}miniGameTxt(e){e+="",this._multiline||(e=e.replace(/\r?\n/g,"")),this.text=e}set text(e){null==e?e="":"string"!=typeof e&&(e=""+e),this._focus?(this.nativeInput.value=e,this.event(Event.CHANGE)):(this._multiline||(e=e.replace(/\r?\n/g,"")),super.text=e)}get text(){return this._focus?this.nativeInput.value:super.text}set_color(e){this._focus&&this.nativeInput.setColor(e),super.set_color(e)}set bgColor(e){super.bgColor=e,LayaEnv.isConch&&!Input.isAppUseNewInput&&this.nativeInput.setBgColor(e)}get bgColor(){return super.bgColor}get restrict(){return this._restrict}set restrict(e){this._restrict=e,e?((e="[^"+e+"]").indexOf("^^")>-1&&(e=e.replace("^^","")),this._restrictPattern=new RegExp(e,"g")):this._restrictPattern=null}set editable(e){this._editable=e,LayaEnv.isConch&&!Input.isAppUseNewInput&&Input.input.setForbidEdit(!e)}get editable(){return this._editable}get maxChars(){return this._maxChars}set maxChars(e){this._maxChars=e}get prompt(){return this._prompt}set prompt(e){var t;e=(null===(t=Text.langPacks)||void 0===t?void 0:t[e])||e,this._prompt!=e&&(this._prompt=e,this.markChanged())}get promptColor(){return this._promptColor}set promptColor(e){this._promptColor!=e&&(this._promptColor=e,this.markChanged())}get type(){return this._type}set type(e){this._asPassword="password"===e,this._type=e,this.markChanged()}}Input.TYPE_TEXT="text",Input.TYPE_PASSWORD="password",Input.TYPE_EMAIL="email",Input.TYPE_URL="url",Input.TYPE_NUMBER="number",Input.TYPE_RANGE="range",Input.TYPE_DATE="date",Input.TYPE_MONTH="month",Input.TYPE_WEEK="week",Input.TYPE_TIME="time",Input.TYPE_DATE_TIME="datetime",Input.TYPE_DATE_TIME_LOCAL="datetime-local",Input.TYPE_SEARCH="search",Input.IOS_IFRAME=!1,Input.isAppUseNewInput=!1;class Widget extends Component{constructor(){super(),this._top=null,this._bottom=null,this._left=null,this._right=null,this._centerX=null,this._centerY=null,this.runInEditor=!0,this.hideFlags|=HideFlags.HideAndDontSave}onReset(){this._top=this._bottom=this._left=this._right=this._centerX=this._centerY=null}_onEnable(){this.owner.parent?this._onAdded():this.owner.once(Event.ADDED,this,this._onAdded)}_onDisable(){this.owner.off(Event.ADDED,this,this._onAdded),this.owner.parent&&this.owner.parent.off(Event.RESIZE,this,this._onParentResize)}_onAdded(){this.owner.parent&&this.owner.parent.on(Event.RESIZE,this,this._onParentResize),this.resetLayoutX(),this.resetLayoutY()}_onParentResize(){var e=this.resetLayoutX(),t=this.resetLayoutY();(e||t)&&this.owner.event(Event.RESIZE)}resetLayoutX(){var e=this.owner;if(!e)return!1;var t=e.parent;if(t)if(null!=this._centerX)e.x=Math.round(.5*(t.width-e.displayWidth)+this._centerX+e.pivotX*e.scaleX);else if(null!=this._left){if(e.x=Math.round(this._left+e.pivotX*e.scaleX),null!=this._right){if(!t._width)return!1;var r=(t._width-this._left-this._right)/(e.scaleX||.01);if(r!=e._width)return e.width=r,!0}}else null!=this._right&&(e.x=Math.round(t.width-e.displayWidth-this._right+e.pivotX*e.scaleX));return!1}resetLayoutY(){var e=this.owner;if(!e)return!1;var t=e.parent;if(t)if(null!=this._centerY)e.y=Math.round(.5*(t.height-e.displayHeight)+this._centerY+e.pivotY*e.scaleY);else if(null!=this._top){if(e.y=Math.round(this._top+e.pivotY*e.scaleY),null!=this._bottom){if(!t._height)return!1;var r=(t._height-this._top-this._bottom)/(e.scaleY||.01);if(r!=e._height)return e.height=r,!0}}else null!=this._bottom&&(e.y=Math.round(t.height-e.displayHeight-this._bottom+e.pivotY*e.scaleY));return!1}resetLayout(){this.owner&&(this.resetLayoutX(),this.resetLayoutY())}get top(){return this._top}set top(e){isNaN(e)&&(e=null),this._top!=e&&(this._top=e,this.resetLayoutY())}get bottom(){return this._bottom}set bottom(e){isNaN(e)&&(e=null),this._bottom!=e&&(this._bottom=e,this.resetLayoutY())}get left(){return this._left}set left(e){isNaN(e)&&(e=null),this._left!=e&&(this._left=e,this.resetLayoutX())}get right(){return this._right}set right(e){isNaN(e)&&(e=null),this._right!=e&&(this._right=e,this.resetLayoutX())}get centerX(){return this._centerX}set centerX(e){isNaN(e)&&(e=null),this._centerX!=e&&(this._centerX=e,this.resetLayoutX())}get centerY(){return this._centerY}set centerY(e){isNaN(e)&&(e=null),this._centerY!=e&&(this._centerY=e,this.resetLayoutY())}}Widget.EMPTY=null,Widget.EMPTY=new Widget;const it=new Rectangle,st=new Point;class HitArea{contains(e,t,r){return!!HitArea._isHitGraphic(e,t,r,this._hit)&&!HitArea._isHitGraphic(e,t,r,this._unHit)}static _isHitGraphic(e,t,r,a){if(!a)return!1;let i=a.cmds;if(0==i.length)return!1;let s=i.length;for(let a=0;a<s;a++){let s=i[a];if(s){if("Translate"===s.cmdID)e-=s.tx,t-=s.ty;if(HitArea._isHitCmd(e,t,r,s))return!0}}return!1}static _isHitCmd(e,t,r,a){if(!a)return!1;var i=!1;switch(a.cmdID){case"DrawRect":a.percent?it.setTo(a.x*r.width,a.y*r.height,a.width*r.width,a.height*r.height):it.setTo(a.x,a.y,a.width,a.height),i=it.contains(e,t);break;case"DrawCircle":let s=a.radius;a.percent?(e-=a.x*r.width,t-=a.y*r.height,s*=r.width):(e-=a.x,t-=a.y),i=e*e+t*t<s*s;break;case"DrawPoly":e-=a.x,t-=a.y,i=HitArea._ptInPolygon(e,t,a.points)}return i}static _ptInPolygon(e,t,r){var a=st;a.setTo(e,t);var i,s,n,o,l,h=0;l=r.length;for(var u=0;u<l;u+=2){if(i=r[u],s=r[u+1],n=r[(u+2)%l],s!=(o=r[(u+3)%l]))if(!(a.y<Math.min(s,o)))if(!(a.y>=Math.max(s,o)))(a.y-s)*(n-i)/(o-s)+i>a.x&&h++}return h%2==1}get hit(){return this._hit||(this._hit=new Graphics),this._hit}set hit(e){this._hit=e}get unHit(){return this._unHit||(this._unHit=new Graphics),this._unHit}set unHit(e){this._unHit=e}onAfterDeserialize(){LayaEnv.isPlaying&&(this._hitCmds&&(this.hit.cmds=this._hitCmds,delete this._hitCmds),this._unHitCmds&&(this.unHit.cmds=this._unHitCmds,delete this._unHitCmds))}}ClassUtils.regClass("HitArea",HitArea);class WeakObject{static __init__(){WeakObject.I=new WeakObject,WeakObject.supportWeakMap||ILaya.systemTimer.loop(WeakObject.delInterval,null,WeakObject.clearCache)}static clearCache(){for(var e=0,t=WeakObject._maps.length;e<t;e++){WeakObject._maps[e]._obj={}}}constructor(){this._obj={},WeakObject._maps.push(this)}set(e,t){null!=e&&(WeakObject.supportWeakMap||("string"==typeof e||"number"==typeof e?this._obj[e]=t:(e.$_GID||(e.$_GID=Utils.getGID()),this._obj[e.$_GID]=t)))}get(e){return null==e?null:WeakObject.supportWeakMap?void 0:"string"==typeof e||"number"==typeof e?this._obj[e]:this._obj[e.$_GID]}del(e){null!=e&&(WeakObject.supportWeakMap||("string"==typeof e||"number"==typeof e?delete this._obj[e]:delete this._obj[this._obj.$_GID]))}has(e){return null!=e&&(!WeakObject.supportWeakMap&&("string"==typeof e||"number"==typeof e?null!=this._obj[e]:null!=this._obj[this._obj.$_GID]))}}WeakObject.supportWeakMap=!1,WeakObject.delInterval=6e5,WeakObject._maps=[];class Prefab extends Resource{constructor(e){super(),this.version=e,this._deps=[]}create(e,t){return this.json?LegacyUIParser.createByData(null,this.json):null}get deps(){return this._deps}addDep(e){e instanceof Resource&&(e._addReference(),this._deps.push(e),!LayaEnv.isPlaying&&e instanceof Prefab&&e.on("obsolute",this,this.onDepObsolute))}addDeps(e){for(let t of e)t instanceof Resource&&(t._addReference(),this._deps.push(t),!LayaEnv.isPlaying&&t instanceof Prefab&&t.on("obsolute",this,this.onDepObsolute))}_disposeResource(){for(let e of this._deps)e._removeReference(),!LayaEnv.isPlaying&&e instanceof Prefab&&e.off("obsolute",this,this.onDepObsolute)}get obsolute(){return this._obsolute}set obsolute(e){this._obsolute!=e&&(this._obsolute=e,e&&!LayaEnv.isPlaying&&this.event("obsolute"))}onDepObsolute(){this.obsolute=!0}}var nt,ot,lt=Prefab;class PrefabImpl extends Prefab{constructor(e,t,r){super(r),this.api=e,this.data=t}create(e,t){let r=this.api.parse(this.data,e,t);return Array.isArray(r)?(1==r.length&&(r[0].url=this.url),r[0]):(r.url=this.url,r)}}class LegacyUIParser{static parse(e,t){let r=null==t?void 0:t.root;if(!r){let t=LayaEnv.isPlaying&&e.props.runtime?e.props.runtime:e.type,a=ClassUtils.getClass(t);r="instance"==e.props.renderType?a.instance||(a.instance=new a):new a}return r&&r._viewCreated?r:LegacyUIParser.createByData(r,e)}static getBindFun(e){let t=LegacyUIParser._funMap;t||(t=LegacyUIParser._funMap=new WeakObject);var r=LegacyUIParser._funMap.get(e);if(null==r){var a='"'+e+'"',i="(function(data){if(data==null)return;with(data){try{\nreturn "+(a=a.replace(/^"\${|}"$/g,"").replace(/\${/g,'"+').replace(/}/g,'+"'))+"\n}catch(e){}}})";r=window.Laya._runScript(i),LegacyUIParser._funMap.set(e,r)}return r}static createByData(e,t){var r=InitTool.create();if("_idMap"in(e=LegacyUIParser.createComp(t,e,e,null,r))&&(e._idMap=r._idMap),t.animations){var a,i,s,n=[],o=t.animations,l=o.length;for(a=0;a<l;a++){switch(i=new FrameAnimation,s=o[a],i._setUp(r._idMap,s),e[s.name]=i,i._setControlNode(e),s.action){case 1:i.play(0,!1);break;case 2:i.play(0,!0)}n.push(i)}e._aniList=n}return e instanceof Scene&&e._width>0&&null==t.props.hitTestPrior&&!e.mouseThrough&&(e.hitTestPrior=!0),r.finish(),e._setBit(NodeFlags.NOT_READY,!1),e.parent&&e.parent.activeInHierarchy&&e.active&&e._processActive(!0),e}static createInitTool(){return InitTool.create()}static createComp(e,t=null,r=null,a=null,i=null){if(!(t=t||LegacyUIParser.getCompInstance(e)))return e.props&&e.props.runtime?console.warn("runtime not found:"+e.props.runtime):console.warn("can not create:"+e.type),null;var s=e.child;if(s)for(var n=t instanceof(nt||(nt=ClassUtils.getClass("List"))),o=0,l=s.length;o<l;o++){var h=s[o];if(!("itemRender"in t)||"render"!=h.props.name&&"render"!==h.props.renderType)if("Graphic"==h.type)this._addGraphicsToSprite(h,t);else if(this._isDrawType(h.type))this._addGraphicToSprite(h,t,!0);else{if(n){var u=[],d=LegacyUIParser.createComp(h,null,r,u,i);u.length&&(d._$bindData=u)}else d=LegacyUIParser.createComp(h,null,r,a,i);"Script"==h.type?d instanceof Component?t.addComponentInstance(d):"owner"in d?d.owner=t:"target"in d&&(d.target=t):"mask"==h.props.renderType||"mask"==h.props.name?t.mask=d:d instanceof Node&&t.addChild(d)}else t.itemRender=h}var _=e.props;for(var c in _){var p=_[c];"string"==typeof p&&(p.indexOf("@node:")>=0||p.indexOf("@Prefab:")>=0)?i&&i.addNodeRef(t,c,p):LegacyUIParser.setCompValue(t,c,p,r,a)}return t._afterInited&&t._afterInited(),e.compId&&i&&i._idMap&&(i._idMap[e.compId]=t),t}static setCompValue(e,t,r,a=null,i=null){if("string"==typeof r&&r.indexOf("${")>-1){if(LegacyUIParser._sheet||(LegacyUIParser._sheet=ClassUtils.getClass("laya.data.Table")),!LegacyUIParser._sheet)return void console.warn("Can not find class Sheet");if(i)i.push(e,t,r);else if(a){-1==r.indexOf("].")&&(r=r.replace(".","[0]."));var s,n,o=new DataWatcher(e,t,r);o.exe(a);for(var l=r.replace(/\[.*?\]\./g,".");null!=(s=LegacyUIParser._parseWatchData.exec(l));){for(var h=s[1];null!=(n=LegacyUIParser._parseKeyWord.exec(h));){var u=n[0],d=a._watchMap[u]||(a._watchMap[u]=[]);d.push(o),LegacyUIParser._sheet.I.notifer.on(u,a,a.changeData,[u])}(d=a._watchMap[h]||(a._watchMap[h]=[])).push(o),LegacyUIParser._sheet.I.notifer.on(h,a,a.changeData,[h])}}}else"var"===t&&a?a[r]=e:e[t]="true"===r||"false"!==r&&r}static getCompInstance(e){if("UIView"==e.type&&e.props&&e.props.pageData)return LegacyUIParser.createByData(null,e.props.pageData);var t=LayaEnv.isPlaying&&e.props&&e.props.runtime||e.type,r=ClassUtils.getClass(t);if(!r)throw"Can not find class "+t;if("Script"===e.type&&r.prototype._doAwake){var a=Pool.createByClass(r);return a._destroyed=!1,a}if(e.props&&"renderType"in e.props&&"instance"==e.props.renderType)return r.instance||(r.instance=new r),r.instance;let i=new r;return i instanceof(ot||(ot=ClassUtils.getClass("View")))&&(i._scene=i),i}static collectResourceLinks(e){let t=new Set,r=[];function addInnerUrl(e){t.has(e)||(t.add(e),r.push(e))}if(e.loadList)for(let t of e.loadList)addInnerUrl(t);if(e.loadList3D)for(let t of e.loadList3D)addInnerUrl(t);return function check(e){let t=e.props;for(let e in t){let r=t[e];if("string"==typeof r&&r.indexOf("@Prefab:")>=0){addInnerUrl(r.replace("@Prefab:",""))}}let r=e.child;if(r)for(let e=0,t=r.length;e<t;e++){check(r[e])}}(e),r}static createByJson(e,t=null,r=null,a=null,i=null){"string"==typeof e&&(e=JSON.parse(e));var s=e.props;if(!t&&!(t=i?i.runWith(e):ClassUtils.getInstance(LayaEnv.isPlaying&&s.runtime||e.type)))return null;var n=e.child;if(n)for(var o=0,l=n.length;o<l;o++){var h=n[o];if("render"!==h.props.name&&"render"!==h.props.renderType||!t._$set_itemRender)if("Graphic"==h.type)this._addGraphicsToSprite(h,t);else if(this._isDrawType(h.type))this._addGraphicToSprite(h,t,!0);else{var u=this.createByJson(h,null,r,a,i);"Script"===h.type?"owner"in u?u.owner=t:"target"in u&&(u.target=t):"mask"==h.props.renderType?t.mask=u:t.addChild(u)}else t.itemRender=h}if(s)for(var d in s){var _=s[d];"var"===d&&r?r[_]=t:_ instanceof Array&&t[d]instanceof Function?t[d].apply(t,_):t[d]=_}return a&&e.customProps&&a.runWith([t,e]),t.created&&t.created(),t}static _addGraphicsToSprite(e,t){var r=e.child;if(r&&!(r.length<1)){var a,i,s=this._getGraphicsFromSprite(e,t),n=0,o=0;for(e.props&&(n=this._getObjVar(e.props,"x",0),o=this._getObjVar(e.props,"y",0)),0!=n&&0!=o&&s.translate(n,o),i=r.length,a=0;a<i;a++)this._addGraphicToGraphics(r[a],s);0!=n&&0!=o&&s.translate(-n,-o)}}static _addGraphicToSprite(e,t,r=!1){var a=r?this._getGraphicsFromSprite(e,t):t.graphics;this._addGraphicToGraphics(e,a)}static _getGraphicsFromSprite(e,t){if(!e||!e.props)return t.graphics;var r=e.props.renderType;if("hit"===r||"unHit"===r){var a=t._style.hitArea||(t.hitArea=new HitArea);a[r]||(a[r]=new Graphics);var i=a[r]}return i||(i=t.graphics),i}static _getTransformData(e){var t;("pivotX"in e||"pivotY"in e)&&(t=t||new Matrix).translate(-this._getObjVar(e,"pivotX",0),-this._getObjVar(e,"pivotY",0));var r=this._getObjVar(e,"scaleX",1),a=this._getObjVar(e,"scaleY",1),i=this._getObjVar(e,"rotation",0);return this._getObjVar(e,"skewX",0),this._getObjVar(e,"skewY",0),1==r&&1==a&&0==i||((t=t||new Matrix).scale(r,a),t.rotate(.0174532922222222*i)),t}static _addGraphicToGraphics(e,t){var r,a;if((r=e.props)&&(a=this.DrawTypeDic[e.type])){var i=t,s=this._getParams(r,a[1],a[2],a[3]),n=this._tM;(n||1!=this._alpha)&&(i.save(),n&&i.transform(n),1!=this._alpha&&i.alpha(this._alpha)),i[a[0]].apply(i,s),(n||1!=this._alpha)&&i.restore()}}static _adptLineData(e){return e[2]=parseFloat(e[0])+parseFloat(e[2]),e[3]=parseFloat(e[1])+parseFloat(e[3]),e}static _adptTextureData(e){return e[0]=ILaya.Loader.getRes(e[0]),e}static _adptLinesData(e){return e[2]=this._getPointListByStr(e[2]),e}static _isDrawType(e){return"Image"!==e&&e in this.DrawTypeDic}static _getParams(e,t,r=0,a=null){var i,s,n,o=this._temParam;for(o.length=t.length,s=t.length,i=0;i<s;i++)o[i]=this._getObjVar(e,t[i][0],t[i][1]);return this._alpha=this._getObjVar(e,"alpha",1),(n=this._getTransformData(e))?(r||(r=0),n.translate(o[r],o[r+1]),o[r]=o[r+1]=0,this._tM=n):this._tM=null,a&&this[a]&&(o=this[a](o)),o}static _getPointListByStr(e){var t,r,a=e.split(",");for(r=a.length,t=0;t<r;t++)a[t]=parseFloat(a[t]);return a}static _getObjVar(e,t,r){return t in e?e[t]:r}}LegacyUIParser._parseWatchData=/\${(.*?)}/g,LegacyUIParser._parseKeyWord=/[a-zA-Z_][a-zA-Z0-9_]*(?:(?:\.[a-zA-Z_][a-zA-Z0-9_]*)+)/g,LegacyUIParser.DrawTypeDic={Rect:["drawRect",[["x",0],["y",0],["width",0],["height",0],["fillColor",null],["lineColor",null],["lineWidth",1]]],Circle:["drawCircle",[["x",0],["y",0],["radius",0],["fillColor",null],["lineColor",null],["lineWidth",1]]],Pie:["drawPie",[["x",0],["y",0],["radius",0],["startAngle",0],["endAngle",0],["fillColor",null],["lineColor",null],["lineWidth",1]]],Image:["drawTexture",[["x",0],["y",0],["width",0],["height",0]]],Texture:["drawTexture",[["skin",null],["x",0],["y",0],["width",0],["height",0]],1,"_adptTextureData"],FillTexture:["fillTexture",[["skin",null],["x",0],["y",0],["width",0],["height",0],["repeat",null]],1,"_adptTextureData"],FillText:["fillText",[["text",""],["x",0],["y",0],["font",null],["color",null],["textAlign",null]],1],Line:["drawLine",[["x",0],["y",0],["toX",0],["toY",0],["lineColor",null],["lineWidth",0]],0,"_adptLineData"],Lines:["drawLines",[["x",0],["y",0],["points",""],["lineColor",null],["lineWidth",0]],0,"_adptLinesData"],Curves:["drawCurves",[["x",0],["y",0],["points",""],["lineColor",null],["lineWidth",0]],0,"_adptLinesData"],Poly:["drawPoly",[["x",0],["y",0],["points",""],["fillColor",null],["lineColor",null],["lineWidth",1]],0,"_adptLinesData"]},LegacyUIParser._temParam=[];class DataWatcher{constructor(e,t,r){this.comp=e,this.prop=t,this.value=r}exe(e){var t=LegacyUIParser.getBindFun(this.value);this.comp[this.prop]=t.call(this,e)}}class InitTool{reset(){this._nodeRefList=null,this._initList=null,this._idMap=null}recover(){this.reset(),Pool.recover("InitTool",this)}static create(){var e=Pool.getItemByClass("InitTool",InitTool);return e._idMap={},e}addNodeRef(e,t,r){this._nodeRefList||(this._nodeRefList=[]),this._nodeRefList.push([e,t,r])}setNodeRef(){if(this._nodeRefList)if(this._idMap){var e,t,r;for(t=this._nodeRefList.length,e=0;e<t;e++)(r=this._nodeRefList[e])[0][r[1]]=this.getReferData(r[2]);this._nodeRefList=null}else this._nodeRefList=null}getReferData(e){if(e.indexOf("@Prefab:")>=0)return new PrefabImpl(LegacyUIParser,Loader.getRes(e.replace("@Prefab:","")),2);if(e.indexOf("@arr:")>=0){var t,r,a,i;a=(t=(e=e.replace("@arr:","")).split(",")).length;var s=[];for(r=0;r<a;r++)(i=t[r])?s.push(this._idMap[i.replace("@node:","")]):s.push(null);return s}return this._idMap[e.replace("@node:","")]}addInitItem(e){this._initList||(this._initList=[]),this._initList.push(e)}doInits(){this._initList&&(this._initList=null)}finish(){this.setNodeRef(),this.doInits(),this.recover()}}class Scene extends Sprite{constructor(e=!0){super(),this.autoDestroyAtClosed=!1,this._viewCreated=!1,this._timer=ILaya.timer,this._widget=Widget.EMPTY,this._scene=this,e&&this.createChildren()}createChildren(){}static setUIMap(e){let t=ILaya.loader.getRes(e);if(!t)throw"请提前加载uimap的json，再使用该接口设置！";for(let e in t)ILaya.Loader.loadedMap[e+".scene"]=t[e]}loadScene(e){Scene.unDestroyedScenes.add(this);let t=e.indexOf(".")>-1?e:e+".scene",r=ILaya.loader.getRes(t);r?this._viewCreated||(r.create({root:this}),this._viewCreated=!0,Scene.unDestroyedScenes.add(this)):(this._setBit(NodeFlags.NOT_READY,!0),ILaya.loader.load(t,null,(e=>{Scene._loadPage&&Scene._loadPage.event("progress",e)})).then((r=>{if(!r)throw"Can not find scene:"+e;this._viewCreated?this._setBit(NodeFlags.NOT_READY,!1):(this.url=t,Scene.hideLoadingPage(),r.create({root:this}),this._viewCreated=!0,Scene.unDestroyedScenes.add(this))})))}createView(e){e&&!this._viewCreated&&(this._viewCreated=!0,LegacyUIParser.createByData(this,e))}getNodeByID(e){return this._idMap?this._idMap[e]:null}open(e=!0,t=null){e&&Scene.closeAll(),Scene.root.addChild(this),this._scene3D&&ILaya.stage.addChildAt(this._scene3D,0),this.onOpened(t)}onOpened(e){}close(e=null){this.onClosed(e),this.autoDestroyAtClosed?(this.destroy(),this._scene3D&&this._scene3D.destroy()):(this.removeSelf(),this._scene3D&&this._scene3D.removeSelf())}onClosed(e=null){}destroy(e=!0){super.destroy(e),this._scene3D&&(this._scene3D.destroy(),this._scene3D=null),this._idMap=null,Scene.unDestroyedScenes.delete(this)}get_width(){if(this._isWidthSet)return this._width;for(var e=0,t=this.numChildren-1;t>-1;t--){var r=this.getChildAt(t);r._visible&&(e=Math.max(r._x+r.width*r.scaleX,e))}return e}get_height(){if(this._isHeightSet)return this._height;for(var e=0,t=this.numChildren-1;t>-1;t--){var r=this.getChildAt(t);r._visible&&(e=Math.max(r._y+r.height*r.scaleY,e))}return e}get timer(){return this._timer}set timer(e){this._timer=e}get scene3D(){return this._scene3D}get top(){return this._widget.top}set top(e){e!=this._widget.top&&(this._getWidget().top=e)}get bottom(){return this._widget.bottom}set bottom(e){e!=this._widget.bottom&&(this._getWidget().bottom=e)}get left(){return this._widget.left}set left(e){e!=this._widget.left&&(this._getWidget().left=e)}get right(){return this._widget.right}set right(e){e!=this._widget.right&&(this._getWidget().right=e)}get centerX(){return this._widget.centerX}set centerX(e){e!=this._widget.centerX&&(this._getWidget().centerX=e)}get centerY(){return this._widget.centerY}set centerY(e){e!=this._widget.centerY&&(this._getWidget().centerY=e)}_shouldRefreshLayout(){super._shouldRefreshLayout(),this.callLater(this._sizeChanged)}_sizeChanged(){this.event(Event.RESIZE),this._widget!==Widget.EMPTY&&this._widget.resetLayout()}freshLayout(){this._widget!=Widget.EMPTY&&this._widget.resetLayout()}_getWidget(){return this._widget===Widget.EMPTY&&(this._widget=this.addComponent(Widget)),this._widget}static get root(){let e=Scene._root;return e||(e=Scene._root=ILaya.stage.addChild(new Sprite),e.name="root",e.mouseThrough=!0,ILaya.stage.on("resize",null,(()=>{e.size(ILaya.stage.width,ILaya.stage.height),e.event(Event.RESIZE)})),e.size(ILaya.stage.width,ILaya.stage.height),e.event(Event.RESIZE)),e}static load(e,t=null,r=null){return ILaya.loader.load(e,null,(e=>{Scene._loadPage&&Scene._loadPage.event("progress",e),r&&r.runWith(e)})).then((r=>{if(!r)throw"Can not find scene:"+e;let a,i=[],s=r.create(null,i);if(i.length>0&&console.warn(`Error loading ${e}: \n${i.join("\n")}`),s instanceof Scene)a=s;else{if(!s._is3D)throw"Not a scene:"+e;a=new Scene,a.left=a.right=a.top=a.bottom=0,a._scene3D=s}return a._viewCreated=!0,a._scene3D&&(a._scene3D._scene2D=a),Scene.unDestroyedScenes.add(a),Scene.hideLoadingPage(),t&&t.runWith(a),a}))}static open(e,t=!0,r=null,a=null,i=null){if(r instanceof Handler){var s=a;a=r,r=s}return Scene.showLoadingPage(),Scene.load(e,Handler.create(null,this._onSceneLoaded,[t,a,r]),i)}static _onSceneLoaded(e,t,r,a){a.open(e,r),t&&t.runWith(a)}static close(e,t){let r=!1;for(let a of Scene.unDestroyedScenes)if(a&&a.parent&&a.url===e&&(null==t||a.name==t)){a.close(),r=!0;break}return r}static closeAll(){let e=Scene.root;for(let r=0,a=e.numChildren;r<a;r++){var t=e.getChildAt(0);t instanceof Scene?t.close():t.removeSelf()}}static destroy(e,t){let r=!1;for(let a of Scene.unDestroyedScenes)if(a.url===e&&(null==t||a.name==t)&&!a._destroyed){a.destroy(),r=!0;break}return r}static gc(){Resource.destroyUnusedResources()}static setLoadingPage(e){Scene._loadPage=e}static showLoadingPage(e=null,t=500){Scene._loadPage&&(ILaya.systemTimer.clear(null,Scene._showLoading),ILaya.systemTimer.clear(null,Scene._hideLoading),ILaya.systemTimer.once(t,null,Scene._showLoading,[e],!1))}static _showLoading(e){ILaya.stage.addChild(Scene._loadPage),Scene._loadPage instanceof Scene&&Scene._loadPage.onOpened(e)}static _hideLoading(){Scene._loadPage instanceof Scene?Scene._loadPage.close():Scene._loadPage.removeSelf()}static hideLoadingPage(e=500){Scene._loadPage&&(ILaya.systemTimer.clear(null,Scene._showLoading),ILaya.systemTimer.clear(null,Scene._hideLoading),ILaya.systemTimer.once(e,null,Scene._hideLoading))}}Scene.unDestroyedScenes=new Set;class Timer{constructor(e=!0){this.scale=1,this.currFrame=0,this._delta=0,this._map={},this._handlers=[],this._temp=[],this._count=0,e&&Timer.gSysTimer&&Timer.gSysTimer.frameLoop(1,this,this._update),this.currTimer=this._getNowData(),this._lastTimer=this._getNowData()}get delta(){return this._delta}_update(){if(this.scale<=0)return this._lastTimer=this._getNowData(),void(this._delta=0);var e=this.currFrame=this.currFrame+this.scale,t=this._getNowData(),r=t-this._lastTimer>3e4;this._delta=(t-this._lastTimer)*this.scale;var a=this.currTimer=this.currTimer+this._delta;this._lastTimer=t;var i=this._handlers;this._count=0;for(var s=0,n=i.length;s<n;s++){var o=i[s];if(null!==o.method){var l=o.userFrame?e:a;if(l>=o.exeTime)if(o.repeat)if(!o.jumpFrame||r)o.exeTime+=o.delay,o.run(!1),l>o.exeTime&&(o.exeTime+=Math.ceil((l-o.exeTime)/o.delay)*o.delay);else for(;l>=o.exeTime;)o.exeTime+=o.delay,o.run(!1);else o.run(!0)}else this._count++}(this._count>30||e%200==0)&&this._clearHandlers()}_clearHandlers(){for(var e=this._handlers,t=0,r=e.length;t<r;t++){var a=e[t];null!==a.method?this._temp.push(a):this._recoverHandler(a)}this._handlers=this._temp,e.length=0,this._temp=e}_recoverHandler(e){this._map[e.key]==e&&delete this._map[e.key],e.clear(),Timer._pool.push(e)}_getNowData(){return Date.now()}_create(e,t,r,a,i,s,n){if(!r)return i.apply(a,s),null;if(n){var o=this._getHandler(a,i);if(o)return o.repeat=t,o.userFrame=e,o.delay=r,o.caller=a,o.method=i,o.args=s,o.exeTime=r+(e?this.currFrame:this.currTimer+this._getNowData()-this._lastTimer),o}return(o=Timer._pool.length>0?Timer._pool.pop():new TimerHandler).repeat=t,o.userFrame=e,o.delay=r,o.caller=a,o.method=i,o.args=s,o.exeTime=r+(e?this.currFrame:this.currTimer+this._getNowData()-this._lastTimer),this._indexHandler(o),this._handlers.push(o),o}_indexHandler(e){var t=e.caller,r=e.method,a=t?t.$_GID||(t.$_GID=Utils.getGID()):0,i=r.$_TID||(r.$_TID=Timer._mid++);e.key=a+"_"+i,this._map[e.key]=e}once(e,t,r,a=null,i=!0){this._create(!1,!1,e,t,r,a,i)}loop(e,t,r,a=null,i=!0,s=!1){var n=this._create(!1,!0,e,t,r,a,i);n&&(n.jumpFrame=s)}frameOnce(e,t,r,a=null,i=!0){this._create(!0,!1,e,t,r,a,i)}frameLoop(e,t,r,a=null,i=!0){this._create(!0,!0,e,t,r,a,i)}toString(){return" handlers:"+this._handlers.length+" pool:"+Timer._pool.length}clear(e,t){var r=this._getHandler(e,t);r&&r.clear()}clearAll(e){if(e)for(var t=0,r=this._handlers.length;t<r;t++){var a=this._handlers[t];a.caller===e&&a.clear()}}_getHandler(e,t){var r=(e?e.$_GID||(e.$_GID=Utils.getGID()):0)+"_"+(t.$_TID||(t.$_TID=Timer._mid++));return this._map[r]}callLater(e,t,r=null){CallLater.I.callLater(e,t,r)}runCallLater(e,t){CallLater.I.runCallLater(e,t)}clearCallLater(e,t){CallLater.I.clear(e,t)}runTimer(e,t){var r=this._getHandler(e,t);r&&null!=r.method&&(this._map[r.key]=null,r.run(!0))}pause(){this.scale=0}resume(){this.scale=1}destroy(){for(var e=0,t=this._handlers.length;e<t;e++){this._handlers[e].clear()}this._handlers.length=0,this._map={},this._temp.length=0}}Timer.gSysTimer=null,Timer._pool=[],Timer._mid=1;class TimerHandler{clear(){this.caller=null,this.method=null,this.args=null}run(e){var t=this.caller;if(t&&t.destroyed)return this.clear();var r=this.method,a=this.args;e&&this.clear(),null!=r&&(a?r.apply(t,a):r.call(t))}}class CallLater{constructor(){this._pool=[],this._map={},this._laters=[]}_update(){let e=this._laters,t=e.length;if(t>0){for(let r=0,a=t-1;r<=a;r++){let t=e[r];this._map[t.key]=null,null!==t.method&&(t.run(),t.clear()),this._pool.push(t),r===a&&(a=e.length-1)}e.length=0}}_getHandler(e,t){var r=e?e.$_GID||(e.$_GID=Utils.getGID()):0,a=t.$_TID||(t.$_TID=Timer._mid++);return this._map[r+"."+a]}callLater(e,t,r=null){if(null==this._getHandler(e,t)){let s;s=this._pool.length?this._pool.pop():new LaterHandler,s.caller=e,s.method=t,s.args=r;var a=e?e.$_GID:0,i=t.$_TID;s.key=a+"."+i,this._map[s.key]=s,this._laters.push(s)}}runCallLater(e,t){var r=this._getHandler(e,t);r&&null!=r.method&&(this._map[r.key]=null,r.run(),r.clear())}clear(e,t){var r=this._getHandler(e,t);return!!r&&(this._map[r.key]=null,r.key="",r.clear(),!0)}clearAll(e){if(e)for(var t=0,r=this._laters.length;t<r;t++){var a=this._laters[t];a.caller===e&&(this._map[a.key]=null,a.key="",a.clear())}}}CallLater.I=new CallLater;class LaterHandler{clear(){this.caller=null,this.method=null,this.args=null}run(){var e=this.caller;if(e&&e.destroyed)return this.clear();var t=this.method,r=this.args;null!=t&&(r?t.apply(e,r):t.call(e))}}class WebGL{static _nativeRender_enable(){}static enable(){return!0}static onStageResize(e,t){LayaGL.renderEngine.viewport(0,0,e,t),RenderState2D.width=e,RenderState2D.height=t}}WebGL.isNativeRender_enable=!1;class RunDriver{}RunDriver.changeWebGLSize=function(e,t){WebGL.onStageResize(e,t)};class ComponentDriver{constructor(){this._onUpdates=new Set,this._onLateUpdates=new Set,this._onPreRenders=new Set,this._onPostRenders=new Set,this._toStarts=new Set,this._toDestroys=new Set}callStart(){for(let e of this._toStarts)if(2==e._status){e._status=3;try{e.onStart()}catch(e){console.log(e)}}this._toStarts.clear()}callUpdate(){for(let e of this._onUpdates)if(3==e._status)try{e.onUpdate()}catch(e){console.log(e)}}callLateUpdate(){for(let e of this._onLateUpdates)if(3==e._status)try{e.onLateUpdate()}catch(e){console.log(e)}}callPreRender(){for(let e of this._onPreRenders)if(3==e._status)try{e.onPreRender()}catch(e){console.log(e)}}callPostRender(){for(let e of this._onPostRenders)if(3==e._status)try{e.onPostRender()}catch(e){console.log(e)}}callDestroy(){for(let e of this._toDestroys)try{e._destroy(!0)}catch(e){console.log(e)}this._toDestroys.clear()}add(e){1==e._status&&(e.onStart?(e._status=2,this._toStarts.add(e)):e._status=3),e.onUpdate&&this._onUpdates.add(e),e.onLateUpdate&&this._onLateUpdates.add(e),e.onPreRender&&this._onPreRenders.add(e),e.onPostRender&&this._onPostRenders.add(e)}remove(e){2==e._status&&(e._status=1),e.onUpdate&&this._onUpdates.delete(e),e.onLateUpdate&&this._onLateUpdates.delete(e),e.onPreRender&&this._onPreRenders.delete(e),e.onPostRender&&this._onPostRenders.delete(e)}destroy(){}}class Stage extends Sprite{constructor(){super(),this.offset=new Point,this._frameRate="fast",this.designWidth=0,this.designHeight=0,this.canvasRotation=!1,this.canvasDegree=0,this.renderingEnabled=!0,this.screenAdaptationEnabled=!0,this._canvasTransform=new Matrix,this._screenMode="none",this._scaleMode="noscale",this._alignV="top",this._alignH="left",this._bgColor="black",this._mouseMoveTime=0,this._renderCount=0,this._safariOffsetY=0,this._frameStartTime=0,this._previousOrientation=Browser.window.orientation,this._wgColor=[0,0,0,1],this._scene3Ds=[],this._globalRepaintSet=!1,this._globalRepaintGet=!1,this.useRetinalCanvas=!1,this._needUpdateCanvasSize=!1,super.set_transform(this._createTransform()),this.mouseEnabled=!0,this.hitTestPrior=!0,this.autoSize=!1,this._setBit(NodeFlags.DISPLAYED_INSTAGE,!0),this._setBit(NodeFlags.ACTIVE_INHIERARCHY,!0),this._isFocused=!0,this._isVisibility=!0,this.useRetinalCanvas=Config.useRetinalCanvas;var e=Browser.window;e.addEventListener("focus",(()=>{this._isFocused=!0,this.event(Event.FOCUS),this.event(Event.FOCUS_CHANGE)})),e.addEventListener("blur",(()=>{this._isFocused=!1,this.event(Event.BLUR),this.event(Event.FOCUS_CHANGE),this._isInputting()&&(Input.inputElement.target.focus=!1)}));var t="visibilityState",r="visibilitychange",a=e.document;void 0!==a.hidden?(r="visibilitychange",t="visibilityState"):void 0!==a.mozHidden?(r="mozvisibilitychange",t="mozVisibilityState"):void 0!==a.msHidden?(r="msvisibilitychange",t="msVisibilityState"):void 0!==a.webkitHidden&&(r="webkitvisibilitychange",t="webkitVisibilityState"),e.document.addEventListener(r,(()=>{"hidden"==Browser.document[t]?(this._isVisibility=!1,this._isInputting()&&(Input.inputElement.target.focus=!1)):this._isVisibility=!0,this.renderingEnabled=this._isVisibility,this.event(Event.VISIBILITY_CHANGE)})),e.addEventListener("resize",(()=>{var e=Browser.window.orientation;null!=e&&e!=this._previousOrientation&&this._isInputting()&&(Input.inputElement.target.focus=!1),this._previousOrientation=e,this._isInputting()||(Browser.onSafari&&(this._safariOffsetY=Browser.getSafariToolbarOffset()),this.screenAdaptationEnabled&&(this.event(Event.WILL_RESIZE),this.updateCanvasSize()))})),e.addEventListener("orientationchange",(e=>{this.screenAdaptationEnabled&&(this.event(Event.WILL_RESIZE),this.updateCanvasSize())})),this._componentDriver=new ComponentDriver}_isInputting(){return Browser.onMobile&&InputManager.isTextInputting}set_width(e){this.designWidth=e,super.set_width(e),this.updateCanvasSize(!0)}get_width(){return this.needUpdateCanvasSize(),super.get_width()}set_height(e){this.designHeight=e,super.set_height(e),this.updateCanvasSize(!0)}get_height(){return this.needUpdateCanvasSize(),super.get_height()}set transform(e){super.set_transform(e)}get transform(){return this._tfChanged&&this._adjustTransform(),this._transform=this._transform||this._createTransform()}get isFocused(){return this._isFocused}get isVisibility(){return this._isVisibility}updateCanvasSize(e){e?this._needUpdateCanvasSize||(this._needUpdateCanvasSize=!0,ILaya.systemTimer.callLater(this,this.updateCanvasSize)):this.setScreenSize(Browser.clientWidth*Browser.pixelRatio,Browser.clientHeight*Browser.pixelRatio)}needUpdateCanvasSize(){this._needUpdateCanvasSize&&this.updateCanvasSize()}setScreenSize(e,t){this._needUpdateCanvasSize=!1;var r=!1;if(this._screenMode!==Stage.SCREEN_NONE&&(r=(e/t<1?Stage.SCREEN_VERTICAL:Stage.SCREEN_HORIZONTAL)!==this._screenMode)){var a=t;t=e,e=a}this.canvasRotation=r;var i=Render._mainCanvas,s=this._canvasTransform.identity(),n=this._scaleMode,o=e/this.designWidth,l=t/this.designHeight,h=this.useRetinalCanvas?e:this.designWidth,u=this.useRetinalCanvas?t:this.designHeight,d=e,_=t,c=Browser.pixelRatio;switch(this._width=this.designWidth,this._height=this.designHeight,n){case Stage.SCALE_NOSCALE:o=l=1,d=this.designWidth,_=this.designHeight;break;case Stage.SCALE_SHOWALL:o=l=Math.min(o,l),h=d=Math.round(this.designWidth*o),u=_=Math.round(this.designHeight*l);break;case Stage.SCALE_NOBORDER:o=l=Math.max(o,l),d=Math.round(this.designWidth*o),_=Math.round(this.designHeight*l);break;case Stage.SCALE_FULL:o=l=c,h=e,u=t,this._width=e/c,this._height=t/c;break;case Stage.SCALE_FIXED_WIDTH:l=o,this._height=u=Math.round(t/o);break;case Stage.SCALE_FIXED_HEIGHT:o=l,this._width=h=Math.round(e/l);break;case Stage.SCALE_FIXED_AUTO:e/t<this.designWidth/this.designHeight?(l=o,this._height=u=Math.round(t/o)):(o=l,this._width=h=Math.round(e/l));break;case Stage.SCALE_FIXED_AUTO_LAYAME:e<t?(l=o,this._height=u=Math.round(t/o)):(l=o=t/this.designWidth,this._width=h=Math.round(e/o),this._height=u=Math.round(t/l));break;case Stage.SCALE_FIXED_AUTO_LAYAVERSE:e>t?(o=l,this._width=h=Math.round(e/l)):(l=o=e/this.designHeight,this._width=h=Math.round(e/o),this._height=u=Math.round(t/l))}this.useRetinalCanvas&&(d=h=e,_=u=t),o*=this.scaleX,l*=this.scaleY,1===o&&1===l?this.transform.identity():(this.transform.a=this._formatData(o/(d/h)),this.transform.d=this._formatData(l/(_/u))),i.size(h,u),RunDriver.changeWebGLSize(h,u),s.scale(d/h/c,_/u/c),this._alignH===Stage.ALIGN_LEFT?this.offset.x=0:this._alignH===Stage.ALIGN_RIGHT?this.offset.x=e-d:this.offset.x=.5*(e-d)/c,this._alignV===Stage.ALIGN_TOP?this.offset.y=0:this._alignV===Stage.ALIGN_BOTTOM?this.offset.y=t-_:this.offset.y=.5*(t-_)/c,this.offset.x=Math.round(this.offset.x),this.offset.y=Math.round(this.offset.y),s.translate(this.offset.x,this.offset.y),this._safariOffsetY&&s.translate(0,this._safariOffsetY),this.canvasDegree=0,r&&(this._screenMode===Stage.SCREEN_HORIZONTAL?(s.rotate(Math.PI/2),s.translate(t/c,0),this.canvasDegree=90):(s.rotate(-Math.PI/2),s.translate(0,e/c),this.canvasDegree=-90)),s.a=this._formatData(s.a),s.d=this._formatData(s.d),s.tx=this._formatData(s.tx),s.ty=this._formatData(s.ty),super.set_transform(this.transform),Stage._setStageStyle(i,h,u,s),this._safariOffsetY&&s.translate(0,-this._safariOffsetY),this.visible=!0,this._repaint|=SpriteConst.REPAINT_CACHE,this.event(Event.RESIZE)}static _setStageStyle(e,t,r,a){var i=e.source.style;i.transformOrigin=i.webkitTransformOrigin=i.msTransformOrigin=i.mozTransformOrigin=i.oTransformOrigin="0px 0px 0px",i.transform=i.webkitTransform=i.msTransform=i.mozTransform=i.oTransform="matrix("+a.toString()+")",i.width=t,i.height=r,a.translate(parseInt(i.left)||0,parseInt(i.top)||0)}setScreenSizeForScene(e,t,r){var a=!1;if(r!==Stage.SCREEN_NONE&&(a=(e/t<1?Stage.SCREEN_VERTICAL:Stage.SCREEN_HORIZONTAL)!==r)){var i=t;t=e,e=i}this.canvasRotation=a,Render._mainCanvas.source.style,this._canvasTransform.clone().identity();var s=this._scaleMode,n=e/this.designWidth,o=t/this.designHeight,l=this.useRetinalCanvas?e:this.designWidth,h=this.useRetinalCanvas?t:this.designHeight,u=e,d=t;Browser.pixelRatio;let _=this.designWidth,c=this.designHeight;switch(s){case Stage.SCALE_NOSCALE:n=o=1,u=this.designWidth,d=this.designHeight;break;case Stage.SCALE_SHOWALL:n=o=Math.min(n,o),l=u=Math.round(this.designWidth*n),h=d=Math.round(this.designHeight*o);break;case Stage.SCALE_NOBORDER:n=o=Math.max(n,o),u=Math.round(this.designWidth*n),d=Math.round(this.designHeight*o);break;case Stage.SCALE_FULL:n=o=1,_=l=e,c=h=t;break;case Stage.SCALE_FIXED_WIDTH:o=n,c=h=Math.round(t/n);break;case Stage.SCALE_FIXED_HEIGHT:n=o,_=l=Math.round(e/o);break;case Stage.SCALE_FIXED_AUTO:e/t<this.designWidth/this.designHeight?(o=n,c=h=Math.round(t/n)):(n=o,_=l=Math.round(e/o))}return this.useRetinalCanvas&&(u=l=e,d=h=t),{stageWidth:_,stageHeight:c,canvasWidth:l,canvasHeight:h,scaleX:n/(u/l),scaleY:o/(d/h)}}_formatData(e){return Math.abs(e)<1e-6?0:Math.abs(1-e)<.001?e>0?1:-1:e}get scaleMode(){return this._scaleMode}set scaleMode(e){this._scaleMode=e,this.updateCanvasSize(!0)}get alignH(){return this.needUpdateCanvasSize(),this._alignH}set alignH(e){this._alignH=e,this.updateCanvasSize(!0)}get alignV(){return this.needUpdateCanvasSize(),this._alignV}set alignV(e){this._alignV=e,this.updateCanvasSize(!0)}get bgColor(){return this._bgColor}set bgColor(e){this._bgColor=e,this._wgColor=e?ColorUtils.create(e).arrColor:null,Stage._setStyleBgColor(e)}static _setStyleBgColor(e){Render.canvas.style.background=e||"none"}get mouseX(){return Math.round(InputManager.mouseX/this.clientScaleX)}get mouseY(){return Math.round(InputManager.mouseY/this.clientScaleY)}getMousePoint(){return Point.TEMP.setTo(this.mouseX,this.mouseY)}get clientScaleX(){return this.needUpdateCanvasSize(),this._transform?this._transform.getScaleX():1}get clientScaleY(){return this.needUpdateCanvasSize(),this._transform?this._transform.getScaleY():1}get screenMode(){return this._screenMode}set screenMode(e){this._screenMode=e}repaint(e=SpriteConst.REPAINT_CACHE){this._repaint|=e}parentRepaint(e=SpriteConst.REPAINT_CACHE){}_loop(){return this._globalRepaintGet=this._globalRepaintSet,this._globalRepaintSet=!1,this.render(Render._context,0,0),!0}getFrameTm(){return this._frameStartTime}getTimeFromFrameStart(){return Browser.now()-this._frameStartTime}set visible(e){this.visible!==e&&(super.set_visible(e),Stage._setVisibleStyle(e))}static _setVisibleStyle(e){Render._mainCanvas.source.style.visibility=e?"visible":"hidden"}get visible(){return super.visible}render(e,t,r){if(LayaEnv.isConch)return void this.renderToNative(e,t,r);let a=ILaya.timer._delta/1e3;if(this._frameRate===Stage.FRAME_SLEEP){var i=Browser.now();if(i-this._frameStartTime<1e3)return;this._frameStartTime=i}else{if(!this._visible)return this._renderCount++,void(this._renderCount%5==0&&(CallLater.I._update(),Stat.loopCount++,RenderInfo.loopCount=Stat.loopCount,this._runComponents(),this._updateTimers()));this._frameStartTime=Browser.now(),RenderInfo.loopStTm=this._frameStartTime}this._renderCount++;var s=(this._frameRate===Stage.FRAME_MOUSE?this._frameStartTime-this._mouseMoveTime<2e3?Stage.FRAME_FAST:Stage.FRAME_SLOW:this._frameRate)!==Stage.FRAME_SLOW,n=this._renderCount%2==0;if(Stat.renderSlow=!s,s||n){if(CallLater.I._update(),Stat.loopCount++,RenderInfo.loopCount=Stat.loopCount,this.renderingEnabled){for(let e=0,t=this._scene3Ds.length;e<t;e++)this._scene3Ds[e]._update(a);this._runComponents(),e.clear(),this._componentDriver.callPreRender(),super.render(e,t,r),Stat.render(e,t,r),Stage.clear(this._bgColor),e.flush(),this._componentDriver.callPostRender(),VectorGraphManager.instance&&VectorGraphManager.getInstance().endDispose()}else this._runComponents();this._updateTimers()}}renderToNative(e,t,r){if(this._renderCount++,this._visible){if(this._frameStartTime=Browser.now(),CallLater.I._update(),Stat.loopCount++,RenderInfo.loopCount=Stat.loopCount,this.renderingEnabled){for(let e=0,t=this._scene3Ds.length;e<t;e++)this._scene3Ds[e]._update();this._runComponents(),this._componentDriver.callPreRender(),e.clear(),super.render(e,t,r),Stat.render(e,t,r),this._componentDriver.callPostRender()}else this._runComponents();this.renderingEnabled&&(Stage.clear(this._bgColor),e.flush(),VectorGraphManager.instance&&VectorGraphManager.getInstance().endDispose()),this._updateTimers()}else this._renderCount%5==0&&(CallLater.I._update(),Stat.loopCount++,RenderInfo.loopCount=Stat.loopCount,this._runComponents(),this._updateTimers())}_runComponents(){this._componentDriver.callStart(),this._componentDriver.callUpdate(),this._componentDriver.callLateUpdate(),this._componentDriver.callDestroy()}_updateTimers(){ILaya.systemTimer._update(),ILaya.physicsTimer._update(),ILaya.timer._update()}set fullScreenEnabled(e){var t=Browser.document,r=Render.canvas;e?(r.addEventListener("mousedown",requestFullscreen),r.addEventListener("touchstart",requestFullscreen),t.addEventListener("fullscreenchange",fullScreenChanged),t.addEventListener("mozfullscreenchange",fullScreenChanged),t.addEventListener("webkitfullscreenchange",fullScreenChanged),t.addEventListener("msfullscreenchange",fullScreenChanged)):(r.removeEventListener("mousedown",requestFullscreen),r.removeEventListener("touchstart",requestFullscreen),t.removeEventListener("fullscreenchange",fullScreenChanged),t.removeEventListener("mozfullscreenchange",fullScreenChanged),t.removeEventListener("webkitfullscreenchange",fullScreenChanged),t.removeEventListener("msfullscreenchange",fullScreenChanged))}exitFullscreen(){var e=Browser.document;e.exitFullscreen?e.exitFullscreen():e.mozCancelFullScreen?e.mozCancelFullScreen():e.webkitExitFullscreen&&e.webkitExitFullscreen()}get frameRate(){return LayaEnv.isConch?this._frameRateNative:this._frameRate}set frameRate(e){if(LayaEnv.isConch){var t=window.conch;switch(e){case Stage.FRAME_FAST:t.config.setLimitFPS(60);break;case Stage.FRAME_MOUSE:t.config.setMouseFrame(2e3);break;case Stage.FRAME_SLOW:t.config.setSlowFrame(!0);break;case Stage.FRAME_SLEEP:t.config.setLimitFPS(1)}this._frameRateNative=e}else this._frameRate=e}isGlobalRepaint(){return this._globalRepaintGet}setGlobalRepaint(){this._globalRepaintSet=!0}}function requestFullscreen(){var e=Browser.document.documentElement;e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen();var t=Render.canvas;t.removeEventListener("mousedown",requestFullscreen),t.removeEventListener("touchstart",requestFullscreen)}function fullScreenChanged(){ILaya.stage.event(Event.FULL_SCREEN_CHANGE)}Stage.SCALE_NOSCALE="noscale",Stage.SCALE_EXACTFIT="exactfit",Stage.SCALE_SHOWALL="showall",Stage.SCALE_NOBORDER="noborder",Stage.SCALE_FULL="full",Stage.SCALE_FIXED_WIDTH="fixedwidth",Stage.SCALE_FIXED_HEIGHT="fixedheight",Stage.SCALE_FIXED_AUTO="fixedauto",Stage.SCALE_FIXED_AUTO_LAYAME="fixedauto_layame",Stage.SCALE_FIXED_AUTO_LAYAVERSE="fixedauto_layaverse",Stage.ALIGN_LEFT="left",Stage.ALIGN_RIGHT="right",Stage.ALIGN_CENTER="center",Stage.ALIGN_TOP="top",Stage.ALIGN_MIDDLE="middle",Stage.ALIGN_BOTTOM="bottom",Stage.SCREEN_NONE="none",Stage.SCREEN_HORIZONTAL="horizontal",Stage.SCREEN_VERTICAL="vertical",Stage.FRAME_FAST="fast",Stage.FRAME_SLOW="slow",Stage.FRAME_MOUSE="mouse",Stage.FRAME_SLEEP="sleep",Stage.clear=function(e){Context.set2DRenderConfig(),RenderState2D.worldScissorTest&&LayaGL.renderEngine.scissorTest(!1);var t=Render.context,r=0==t._submits._length||Config.preserveDrawingBuffer?ColorUtils.create(e).arrColor:ILaya.stage._wgColor;r?t.clearBG(r[0],r[1],r[2],r[3]):t.clearBG(0,0,0,0),RenderState2D.clear()};class BlurFilterGLRender{render(t,r,a,i,s){var n=Value2D.create(e.RenderSpriteData.Texture2D);this.setShaderInfo(n,s,t.width,t.height),r.drawTarget(t,0,0,a,i,Matrix.EMPTY.identity(),n)}setShaderInfo(e,t,r,a){e.defines.addDefine(ShaderDefines2D.FILTERBLUR);var i=e;BlurFilterGLRender.blurinfo.x=r,BlurFilterGLRender.blurinfo.y=a,i.blurInfo=BlurFilterGLRender.blurinfo;var s=t.strength/3,n=s*s;Vector4.tempVec4.x=t.strength_sig2_2sig2_gauss1[0]=t.strength,Vector4.tempVec4.y=t.strength_sig2_2sig2_gauss1[1]=n,Vector4.tempVec4.z=t.strength_sig2_2sig2_gauss1[2]=2*n,Vector4.tempVec4.w=t.strength_sig2_2sig2_gauss1[3]=1/(2*Math.PI*n),i.strength_sig2_2sig2_gauss1=Vector4.tempVec4}}BlurFilterGLRender.blurinfo=new Vector2;class BlurFilter extends Filter{constructor(e=4){super(),this.strength_sig2_2sig2_gauss1=[],this.strength=e,this._glRender=new BlurFilterGLRender}get type(){return Filter.BLUR}getStrenth_sig2_2sig2_native(){this.strength_sig2_native||(this.strength_sig2_native=new Float32Array(4));var e=this.strength/3,t=e*e;return this.strength_sig2_native[0]=this.strength,this.strength_sig2_native[1]=t,this.strength_sig2_native[2]=2*t,this.strength_sig2_native[3]=1/(2*Math.PI*t),this.strength_sig2_native}}class GlowFilterGLRender{setShaderInfo(e,t,r,a){e.defines.addDefine(a.typeDefine);var i=e;Vector4.tempVec4.setValue(a._sv_blurInfo1[0],a._sv_blurInfo1[1],a._sv_blurInfo1[2],a._sv_blurInfo1[3]),i.u_blurInfo1=Vector4.tempVec4;var s=a._sv_blurInfo2;s[0]=t,s[1]=r,Vector4.tempVec4.setValue(s[0],s[1],s[2],s[3]),i.u_blurInfo2=Vector4.tempVec4;var n=a.getColor();Vector4.tempVec4.setValue(n[0],n[1],n[2],n[3]),i.color=Vector4.tempVec4}render(t,r,a,i,s){var n=a,o=i,l=Value2D.create(e.RenderSpriteData.Texture2D);this.setShaderInfo(l,n,o,s);var h=Value2D.create(e.RenderSpriteData.Texture2D),u=Matrix.TEMP.identity();r.drawTarget(t,0,0,n,o,u,l),r.drawTarget(t,0,0,n,o,u,h,null,9)}}class GlowFilter extends Filter{constructor(e,t=4,r=6,a=6){super(),this._elements=new Float32Array(9),this._sv_blurInfo1=new Array(4),this._sv_blurInfo2=[0,0,1,0],this._color=new ColorUtils(e||"#000"),this.blur=Math.min(t,20),this.offX=r,this.offY=a,this._sv_blurInfo1[0]=this._sv_blurInfo1[1]=this.blur,this._sv_blurInfo1[2]=r,this._sv_blurInfo1[3]=-a,this._glRender=new GlowFilterGLRender}get type(){return BlurFilter.GLOW}get typeDefine(){return ShaderDefines2D.FILTERGLOW}get offY(){return this._elements[6]}set offY(e){this._elements[6]=e,this._sv_blurInfo1[3]=-e}get offX(){return this._elements[5]}set offX(e){this._elements[5]=e,this._sv_blurInfo1[2]=e}get color(){return this._color.strColor}set color(e){this._color=new ColorUtils(e)}getColor(){return this._color.arrColor}get blur(){return this._elements[4]}set blur(e){this._elements[4]=e,this._sv_blurInfo1[0]=this._sv_blurInfo1[1]=e}getColorNative(){this._color_native||(this._color_native=new Float32Array(4));var e=this.getColor();return this._color_native[0]=e[0],this._color_native[1]=e[1],this._color_native[2]=e[2],this._color_native[3]=e[3],this._color_native}getBlurInfo1Native(){return this._blurInof1_native||(this._blurInof1_native=new Float32Array(4)),this._blurInof1_native[0]=this._blurInof1_native[1]=this.blur,this._blurInof1_native[2]=this.offX,this._blurInof1_native[3]=this.offY,this._blurInof1_native}getBlurInfo2Native(){return this._blurInof2_native||(this._blurInof2_native=new Float32Array(4)),this._blurInof2_native[2]=1,this._blurInof2_native}}class SoundChannel extends EventDispatcher{constructor(){super(...arguments),this.isStopped=!1}set volume(e){}get volume(){return 1}get position(){return 0}get duration(){return 0}play(){}stop(){this.completeHandler&&this.completeHandler.runWith(!1)}pause(){}resume(){}__runComplete(e){e&&e.runWith(!0)}}class AudioSoundChannel extends SoundChannel{constructor(e){super(),this._audio=null,this._onEnd=this.__onEnd.bind(this),this._resumePlay=this.__resumePlay.bind(this),e.addEventListener("ended",this._onEnd),this._audio=e,this._src=e.src}__onEnd(e){if(1==this.loops)return this.completeHandler&&(ILaya.systemTimer.once(10,this,this.__runComplete,[this.completeHandler],!1),this.completeHandler=null),this.stop(),void this.event(Event.COMPLETE);this.loops>0&&this.loops--,this.startTime=0,this.play()}__resumePlay(){if(this._audio&&this._audio.removeEventListener("canplay",this._resumePlay),!this.isStopped)try{this._audio.currentTime=this.startTime,Browser.container.appendChild(this._audio),this._audio.play()}catch(e){this.event(Event.ERROR)}}play(){this.isStopped=!1;try{this._audio.playbackRate=SoundManager.playbackRate,this._audio.currentTime=this.startTime}catch(e){return void this._audio.addEventListener("canplay",this._resumePlay)}if(SoundManager.addChannel(this),Browser.container.appendChild(this._audio),"play"in this._audio){let e=this._audio.play();e&&e.catch((e=>{}))}}get position(){return this._audio?this._audio.currentTime:0}get duration(){return this._audio?this._audio.duration:0}stop(){super.stop(),this.isStopped=!0,SoundManager.removeChannel(this),this.completeHandler=null,this._audio&&("pause"in this._audio&&LayaEnv.isConch&&this._audio.stop(),this._audio.pause(),this._audio.removeEventListener("ended",this._onEnd),this._audio.removeEventListener("canplay",this._resumePlay),ILaya.Browser.onIE||this._audio!=AudioSound._musicAudio&&Pool.recover("audio:"+this.url,this._audio),Browser.removeElement(this._audio),this._audio=null,SoundManager.autoReleaseSound&&SoundManager.disposeSoundLater(this.url))}pause(){this.isStopped=!0,SoundManager.removeChannel(this),this._audio&&("pause"in this._audio&&this._audio.pause(),SoundManager.autoReleaseSound&&SoundManager.disposeSoundLater(this.url))}resume(){var e=this._audio;e&&(this.isStopped=!1,0==e.readyState&&(e.src=this._src,e.addEventListener("canplay",this._resumePlay),e.load()),SoundManager.addChannel(this),"play"in e&&e.play())}set volume(e){this._audio&&(this._audio.volume=e)}get volume(){return this._audio?this._audio.volume:1}}class AudioSound extends EventDispatcher{constructor(){super(...arguments),this.loaded=!1}dispose(){var e=AudioSound._audioCache[this.url];Pool.clearBySign("audio:"+this.url),e&&(LayaEnv.isConch||(e.src=""),delete AudioSound._audioCache[this.url])}static _initMusicAudio(){AudioSound._musicAudio||(AudioSound._musicAudio||(AudioSound._musicAudio=Browser.createElement("audio")),LayaEnv.isConch||Browser.document.addEventListener("mousedown",AudioSound._makeMusicOK))}static _makeMusicOK(){Browser.document.removeEventListener("mousedown",AudioSound._makeMusicOK),AudioSound._musicAudio.src?AudioSound._musicAudio.play():(AudioSound._musicAudio.src="",AudioSound._musicAudio.load())}load(e){var t;if(this.url=e,e==SoundManager._bgMusic?(AudioSound._initMusicAudio(),(t=AudioSound._musicAudio).originalUrl!=e&&(delete AudioSound._audioCache[t.originalUrl],t=null)):t=AudioSound._audioCache[e],t&&t.readyState>=2)this.event(Event.COMPLETE);else{t||(e==SoundManager._bgMusic?(AudioSound._initMusicAudio(),t=AudioSound._musicAudio):t=Browser.createElement("audio"),AudioSound._audioCache[e]=t,AssetDb.inst.resolveURL(e,(e=>{t.src=URL.postFormatURL(URL.formatURL(e))}))),t.originalUrl=e,t.addEventListener("canplaythrough",onLoaded),t.addEventListener("error",onErr);var r=this;this.audio=t,t.load?t.load():onErr()}function onLoaded(){offs(),r.loaded=!0,r.event(Event.COMPLETE)}function onErr(){t.load=null,offs(),r.event(Event.ERROR)}function offs(){t.removeEventListener("canplaythrough",onLoaded),t.removeEventListener("error",onErr)}}play(e=0,t=0){if(!this.url)return null;var r,a;if(this.url==SoundManager._bgMusic?""!=(r=AudioSound._musicAudio).src&&r.originalUrl!=this.url&&(delete AudioSound._audioCache[r.originalUrl],AudioSound._audioCache[this.url]=r):r=AudioSound._audioCache[this.url],!r)return null;a=Pool.getItem("audio:"+this.url),LayaEnv.isConch?a||(a=Browser.createElement("audio"),AssetDb.inst.resolveURL(this.url,(e=>{a.src=URL.postFormatURL(URL.formatURL(e))}))):this.url==SoundManager._bgMusic?(AudioSound._initMusicAudio(),a=AudioSound._musicAudio,AssetDb.inst.resolveURL(this.url,(e=>{a.src=URL.postFormatURL(URL.formatURL(e))}))):a=a||r.cloneNode(!0),a.originalUrl=this.url;var i=new AudioSoundChannel(a);return i.url=this.url,i.loops=t,i.startTime=e,i.play(),SoundManager.addChannel(i),i}get duration(){var e;return(e=AudioSound._audioCache[this.url])?e.duration:0}}AudioSound._audioCache={};class WebAudioSoundChannel extends SoundChannel{constructor(){super(),this.bufferSource=null,this._currentTime=0,this._volume=1,this._startTime=0,this._pauseTime=0,this.context=WebAudioSound.ctx,this._onPlayEnd=this.__onPlayEnd.bind(this),this.context.createGain?this.gain=this.context.createGain():this.gain=this.context.createGainNode()}play(){if(SoundManager.addChannel(this),this.isStopped=!1,this._clearBufferSource(),this.audioBuffer){if(this.startTime>=this.duration)return this.stop();var e=this.context,t=this.gain,r=e.createBufferSource();this.bufferSource=r,r.buffer=this.audioBuffer,r.connect(t),t&&t.disconnect(),t.connect(e.destination),r.onended=this._onPlayEnd,this._startTime=Browser.now(),this.gain.gain.setTargetAtTime?this.gain.gain.setTargetAtTime(this._volume,this.context.currentTime,WebAudioSoundChannel.SetTargetDelay):this.gain.gain.value=this._volume,0==this.loops&&(r.loop=!0),r.playbackRate.setTargetAtTime?r.playbackRate.setTargetAtTime(SoundManager.playbackRate,this.context.currentTime,WebAudioSoundChannel.SetTargetDelay):r.playbackRate.value=SoundManager.playbackRate,r.start(0,this.startTime),this._currentTime=0}}__onPlayEnd(){if(1==this.loops)return this.completeHandler&&(ILaya.timer.once(10,this,this.__runComplete,[this.completeHandler],!1),this.completeHandler=null),this.stop(),void this.event(Event.COMPLETE);this.loops>0&&this.loops--,this.startTime=0,this.play()}get position(){return this.bufferSource?(Browser.now()-this._startTime)/1e3+this.startTime:0}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}_clearBufferSource(){if(this.bufferSource){var e=this.bufferSource;e.stop?e.stop(0):e.noteOff(0),e.disconnect(0),e.onended=null,WebAudioSoundChannel._tryCleanFailed||this._tryClearBuffer(e),this.bufferSource=null}}_tryClearBuffer(e){try{e.buffer=null}catch(e){WebAudioSoundChannel._tryCleanFailed=!0}}stop(){super.stop(),this._clearBufferSource(),this.audioBuffer=null,this.gain&&this.gain.disconnect(),this.isStopped=!0,SoundManager.removeChannel(this),this.completeHandler=null,SoundManager.autoReleaseSound&&SoundManager.disposeSoundLater(this.url)}pause(){this.isStopped||(this._pauseTime=this.position),this._clearBufferSource(),this.gain&&this.gain.disconnect(),this.isStopped=!0,SoundManager.removeChannel(this),SoundManager.autoReleaseSound&&SoundManager.disposeSoundLater(this.url)}resume(){this.startTime=this._pauseTime,this.play()}set volume(e){this._volume=e,this.isStopped||(this.gain.gain.setTargetAtTime?this.gain.gain.setTargetAtTime(e,this.context.currentTime,WebAudioSoundChannel.SetTargetDelay):this.gain.gain.value=e)}get volume(){return this._volume}}WebAudioSoundChannel._tryCleanFailed=!1,WebAudioSoundChannel.SetTargetDelay=.001;class WebAudioSound extends EventDispatcher{constructor(){super(...arguments),this.loaded=!1,this._disposed=!1}static _playEmptySound(){if(null!=WebAudioSound.ctx){var e=WebAudioSound.ctx.createBufferSource();e.buffer=WebAudioSound._miniBuffer,e.connect(WebAudioSound.ctx.destination),e.start(0,0,0)}}static _unlock(){WebAudioSound._unlocked||(WebAudioSound._playEmptySound(),"running"==WebAudioSound.ctx.state&&(window.document.removeEventListener("mousedown",WebAudioSound._unlock,!0),window.document.removeEventListener("touchend",WebAudioSound._unlock,!0),window.document.removeEventListener("touchstart",WebAudioSound._unlock,!0),WebAudioSound._unlocked=!0))}static initWebAudio(){WebAudioSound.ctx=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext),"running"!=WebAudioSound.ctx.state&&(WebAudioSound._unlock(),window.document.addEventListener("mousedown",WebAudioSound._unlock,!0),window.document.addEventListener("touchend",WebAudioSound._unlock,!0),window.document.addEventListener("touchstart",WebAudioSound._unlock,!0))}load(e){this.url=e,this.audioBuffer=ILaya.loader.getRes(e),this.audioBuffer?this._loaded(this.audioBuffer):ILaya.loader.load(e,Loader.SOUND).then((e=>this._loaded(e)))}_loaded(e){this._disposed||(this.audioBuffer=e,this.loaded=!0,this.event(Event.COMPLETE))}__playAfterLoaded(){if(this.__toPlays){var e,t,r,a;for(t=(r=this.__toPlays).length,e=0;e<t;e++)(a=r[e])[2]&&!a[2].isStopped&&this.play(a[0],a[1],a[2]);this.__toPlays.length=0}}play(e=0,t=0,r=null){return r=r||new WebAudioSoundChannel,this.audioBuffer||this.url&&(this.__toPlays||(this.__toPlays=[]),this.__toPlays.push([e,t,r]),this.once(Event.COMPLETE,this,this.__playAfterLoaded),this.load(this.url)),r.url=this.url,r.loops=t,r.audioBuffer=this.audioBuffer,r.startTime=e,r.play(),SoundManager.addChannel(r),r}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}dispose(){this._disposed=!0,this.audioBuffer&&(ILaya.loader.clearRes(this.url,this.audioBuffer),this.audioBuffer=null),this.__toPlays=[]}}WebAudioSound._miniBuffer=WebAudioSound.ctx?WebAudioSound.ctx.createBuffer(1,1,22050):void 0,WebAudioSound._unlocked=!1;class SoundManager{static __init__(){var e=ILaya.Browser.window,t=!!(e.AudioContext||e.webkitAudioContext||e.mozAudioContext);return t&&WebAudioSound.initWebAudio(),SoundManager._soundClass=t?WebAudioSound:AudioSound,Browser.onTBMiniGame||AudioSound._initMusicAudio(),SoundManager._musicClass=AudioSound,t}static addChannel(e){SoundManager._channels.indexOf(e)>=0||SoundManager._channels.push(e)}static removeChannel(e){for(let t=SoundManager._channels.length-1;t>=0;t--)SoundManager._channels[t]==e&&SoundManager._channels.splice(t,1)}static disposeSoundLater(e){SoundManager._lastSoundUsedTimeDic[e]=ILaya.Browser.now(),SoundManager._isCheckingDispose||(SoundManager._isCheckingDispose=!0,ILaya.timer.loop(5e3,null,SoundManager._checkDisposeSound))}static _checkDisposeSound(){let e=ILaya.Browser.now(),t=!1;for(let r in SoundManager._lastSoundUsedTimeDic)e-SoundManager._lastSoundUsedTimeDic[r]>3e4?(delete SoundManager._lastSoundUsedTimeDic[r],SoundManager.disposeSoundIfNotUsed(r)):t=!0;t||(SoundManager._isCheckingDispose=!1,ILaya.timer.clear(null,SoundManager._checkDisposeSound))}static disposeSoundIfNotUsed(e){for(let t=SoundManager._channels.length-1;t>=0;t--)if(SoundManager._channels[t].url==e)return;SoundManager.destroySound(e)}static set autoStopMusic(e){ILaya.stage.off(Event.BLUR,null,SoundManager._stageOnBlur),ILaya.stage.off(Event.FOCUS,null,SoundManager._stageOnFocus),ILaya.stage.off(Event.VISIBILITY_CHANGE,null,SoundManager._visibilityChange),SoundManager._autoStopMusic=e,e&&(ILaya.stage.on(Event.BLUR,null,SoundManager._stageOnBlur),ILaya.stage.on(Event.FOCUS,null,SoundManager._stageOnFocus),ILaya.stage.on(Event.VISIBILITY_CHANGE,null,SoundManager._visibilityChange))}static get autoStopMusic(){return SoundManager._autoStopMusic}static _visibilityChange(){ILaya.stage.isVisibility?SoundManager._stageOnFocus():SoundManager._stageOnBlur()}static _stageOnBlur(){SoundManager._isActive=!1,SoundManager._musicChannel&&(SoundManager._musicChannel.isStopped||(SoundManager._blurPaused=!0,SoundManager._musicChannel.pause())),SoundManager.stopAllSound(),ILaya.stage.once(Event.MOUSE_DOWN,null,SoundManager._stageOnFocus)}static _recoverWebAudio(){WebAudioSound.ctx&&"running"!=WebAudioSound.ctx.state&&WebAudioSound.ctx.resume&&WebAudioSound.ctx.resume()}static _stageOnFocus(){SoundManager._isActive=!0,SoundManager._recoverWebAudio(),ILaya.stage.off(Event.MOUSE_DOWN,null,SoundManager._stageOnFocus),SoundManager._blurPaused&&SoundManager._musicChannel&&SoundManager._musicChannel.isStopped&&(SoundManager._blurPaused=!1,SoundManager._musicChannel.resume())}static set muted(e){e!=SoundManager._muted&&(e&&SoundManager.stopAllSound(),SoundManager.musicMuted=e,SoundManager._muted=e)}static get muted(){return SoundManager._muted}static set soundMuted(e){SoundManager._soundMuted=e}static get soundMuted(){return SoundManager._soundMuted}static set musicMuted(e){e!=SoundManager._musicMuted&&(e?(SoundManager._bgMusic&&SoundManager._musicChannel&&!SoundManager._musicChannel.isStopped?LayaEnv.isConch?SoundManager._musicChannel._audio&&(SoundManager._musicChannel._audio.muted=!0):SoundManager._musicChannel.pause():SoundManager._musicChannel=null,SoundManager._musicMuted=e):(SoundManager._musicMuted=e,SoundManager._bgMusic&&SoundManager._musicChannel&&(LayaEnv.isConch?SoundManager._musicChannel._audio&&(SoundManager._musicChannel._audio.muted=!1):SoundManager._musicChannel.resume())))}static get musicMuted(){return SoundManager._musicMuted}static get useAudioMusic(){return SoundManager._useAudioMusic}static set useAudioMusic(e){SoundManager._useAudioMusic=e,SoundManager._musicClass=e?AudioSound:null}static playSound(e,t=1,r=null,a=null,i=0){if(!SoundManager._isActive||!e)return null;if(SoundManager._muted)return null;if(SoundManager._recoverWebAudio(),e==SoundManager._bgMusic){if(SoundManager._musicMuted)return null}else if(SoundManager._soundMuted)return null;let s;Browser._isMiniGame||(s=SoundManager._soundCache[e]),a||(a=SoundManager._soundClass),s||(s=new a,s.load(e),Browser._isMiniGame||(SoundManager._soundCache[e]=s));let n=s.play(i,t);return n?(n.url=e,n.volume=e==SoundManager._bgMusic?SoundManager.musicVolume:SoundManager.soundVolume,n.completeHandler=r,n):null}static destroySound(e){let t=SoundManager._soundCache[e];t&&(delete SoundManager._soundCache[e],t.dispose())}static playMusic(e,t=0,r=null,a=0){return SoundManager._bgMusic=e,SoundManager._musicChannel&&SoundManager._musicChannel.stop(),SoundManager._musicChannel=SoundManager.playSound(e,t,r,SoundManager._musicClass,a)}static stopSound(e){for(let t=SoundManager._channels.length-1;t>=0;t--){let r=SoundManager._channels[t];r.url==e&&r.stop()}}static stopAll(){var e;for(SoundManager._bgMusic=null,e=SoundManager._channels.length-1;e>=0;e--)SoundManager._channels[e].stop()}static stopAllSound(){for(let e=SoundManager._channels.length-1;e>=0;e--){let t=SoundManager._channels[e];t.url!=SoundManager._bgMusic&&t.stop()}}static stopMusic(){SoundManager._musicChannel&&SoundManager._musicChannel.stop(),SoundManager._bgMusic=null}static setSoundVolume(e,t=null){if(t)SoundManager._setVolume(t,e);else{SoundManager.soundVolume=e;for(let t=SoundManager._channels.length-1;t>=0;t--){let r=SoundManager._channels[t];r.url!=SoundManager._bgMusic&&(r.volume=e)}}}static setMusicVolume(e){SoundManager.musicVolume=e,SoundManager._setVolume(SoundManager._bgMusic,e)}static _setVolume(e,t){for(let r=SoundManager._channels.length-1;r>=0;r--){let a=SoundManager._channels[r];a.url==e&&(a.volume=t)}}}SoundManager.musicVolume=1,SoundManager.soundVolume=1,SoundManager.playbackRate=1,SoundManager._useAudioMusic=!0,SoundManager._muted=!1,SoundManager._soundMuted=!1,SoundManager._musicMuted=!1,SoundManager._bgMusic=null,SoundManager._musicChannel=null,SoundManager._channels=[],SoundManager._blurPaused=!1,SoundManager._isActive=!0,SoundManager._lastSoundUsedTimeDic={},SoundManager._isCheckingDispose=!1,SoundManager._soundCache={},SoundManager.autoReleaseSound=!0;class SoundNode extends Sprite{constructor(){super(),this._loop=1,this.on(Event.ADDED,this,this._onParentChange),this.on(Event.REMOVED,this,this._onParentChange)}get source(){return this._source}set source(e){this._source=e,e?this._autoPlay&&(!this._channel||this._channel.isStopped)&&LayaEnv.isPlaying&&this.play():this.stop()}get isMusic(){return this._isMusic}set isMusic(e){this._isMusic=e}get loop(){return this._loop}set loop(e){this._loop=e}get autoPlay(){return this._autoPlay}set autoPlay(e){this._autoPlay=e,e&&this._source&&(!this._channel||this._channel.isStopped)&&LayaEnv.isPlaying&&this.play()}_onParentChange(){this.target=this.parent}play(e,t){this._source&&((null==e||isNaN(e))&&(e=this._loop),this.stop(),this._isMusic?this._channel=SoundManager.playMusic(this._source,e,t):this._channel=SoundManager.playSound(this._source,e,t))}stop(){this._channel&&!this._channel.isStopped&&this._channel.stop(),this._channel=null}_setPlayAction(e,t,r,a=!0){this[r]&&e&&(a?e.on(t,this,this[r]):e.off(t,this,this[r]))}_setPlayActions(e,t,r,a=!0){if(!e)return;if(!t)return;let i=t.split(","),s=i.length;for(let t=0;t<s;t++)this._setPlayAction(e,i[t],r,a)}set playEvent(e){this._playEvents=e,e&&this._tar&&this._setPlayActions(this._tar,e,"play")}set target(e){this._tar&&(this._setPlayActions(this._tar,this._playEvents,"play",!1),this._setPlayActions(this._tar,this._stopEvents,"stop",!1)),this._tar=e,this._tar&&(this._setPlayActions(this._tar,this._playEvents,"play",!0),this._setPlayActions(this._tar,this._stopEvents,"stop",!0))}set stopEvent(e){this._stopEvents=e,e&&this._tar&&this._setPlayActions(this._tar,e,"stop")}}class VideoTexture extends BaseTexture{constructor(){let t=ILaya.Browser.createElement("video");super(t.videoWidth,t.videoHeight,e.RenderTargetFormat.R8G8B8),this._requestVideoFrame=!1,this._frameRender=!0,this._isLoaded=!1,this._needUpdate=!1,this.immediatelyPlay=!1,this.element=t,this._listeningEvents={},this._dimension=e.TextureDimension.Tex2D;var r=this.element.style;if(r.position="absolute",r.top="0px",r.left="0px",t.setAttribute("crossorigin","anonymous"),ILaya.Browser.onMobile&&(t["x5-playsInline"]=!0,t["x5-playsinline"]=!0,t.x5PlaysInline=!0,t.playsInline=!0,t["webkit-playsInline"]=!0,t["webkit-playsinline"]=!0,t.webkitPlaysInline=!0,t.playsinline=!0,t.style.playsInline=!0,t.crossOrigin="anonymous",t.setAttribute("playsinline","true"),t.setAttribute("x5-playsinline","true"),t.setAttribute("webkit-playsinline","true"),t.autoplay=!0),t.addEventListener("loadedmetadata",(()=>{this.loadedmetadata()})),"requestVideoFrameCallback"in t){const a=this;function updateVideo(){a._needUpdate=!0,t.requestVideoFrameCallback(updateVideo)}t.requestVideoFrameCallback(updateVideo),this._requestVideoFrame=!0}else this._needUpdate=!0}isNeedUpdate(){return!this._requestVideoFrame||this._needUpdate}loadedmetadata(){this._isLoaded||(this._width=this.element.videoWidth,this._height=this.element.videoHeight,Browser.onLayaRuntime?this._texture=LayaGL.textureContext.createTextureInternal(this._dimension,this.element.videoWidth,this.element.videoHeight,e.TextureFormat.R8G8B8A8,!1,!1,!1):this._texture=LayaGL.textureContext.createTextureInternal(this._dimension,this.element.videoWidth,this.element.videoHeight,e.TextureFormat.R8G8B8,!1,!1,!1),this.wrapModeU=e.WrapMode.Clamp,this.wrapModeV=e.WrapMode.Clamp,this.filterMode=e.FilterMode.Bilinear,LayaGL.textureContext.initVideoTextureData(this._texture),this._texture.gammaCorrection=2.2,this.immediatelyPlay&&this.play(),this._isLoaded=!0,this.event(Event.READY,this))}get source(){return this._source}get gammaCorrection(){return 2.2}set source(e){this._source=e,e&&AssetDb.inst.resolveURL(e,(e=>{for(;this.element.childElementCount;)this.element.firstChild.remove();e.startsWith("blob:")?this.element.src=e:this.appendSource(e)}))}appendSource(e){var t=ILaya.Browser.createElement("source");t.src=URL.postFormatURL(URL.formatURL(e));let r=Utils.getFileExtension(e);t.type="m3u8"==r?"application/vnd.apple.mpegurl":"video/"+r,this.element.appendChild(t)}render(){0!=this.element.readyState&&(this.isNeedUpdate()||Browser.onLayaRuntime)&&(LayaGL.textureContext.updateVideoTexture(this._texture,this.element,!1,!1),this._needUpdate=!1)}set frameRender(e){this._frameRender&&!e&&ILaya.timer.clear(this,this.render),!this._frameRender&&e&&ILaya.timer.frameLoop(1,this,this.render),this._frameRender=e}get frameRender(){return this._frameRender}play(){this._texture?(this.element.play().catch((()=>{this.event("NotAllowedError")})),this._frameRender&&ILaya.timer.frameLoop(1,this,this.render)):this.immediatelyPlay=!0}_getSource(){return this._texture?this._texture.resource:null}get defaultTexture(){return Texture2D.whiteTexture}pause(){this.element.pause(),this._frameRender&&ILaya.timer.clear(this,this.render)}load(){this.element.load()}canPlayType(e){return e="m3u8"==e?"application/vnd.apple.mpegurl":"video/"+e,this.element.canPlayType(e)}get buffered(){return this.element.buffered}get currentSrc(){return this.element.currentSrc}get currentTime(){return this.element.currentTime}set currentTime(e){this.element&&(this.element.currentTime=e,this.render())}set volume(e){this.element&&(this.element.volume=e)}get volume(){return this.element.volume}get readyState(){return this.element.readyState}get videoWidth(){return this.element.videoWidth}get videoHeight(){return this.element.videoHeight}get duration(){return this.element.duration}get ended(){return this.element.ended}get error(){return this.element.error}get loop(){return this.element.loop}set loop(e){this.element&&(this.element.loop=e)}get playbackRate(){return this.element.playbackRate}set playbackRate(e){this.element&&(this.element.playbackRate=e)}get muted(){return this.element.muted}set muted(e){this.element&&(this.element.muted=e)}get paused(){return this.element.paused}get preload(){return this.element.preload}set preload(e){this.element&&(this.element.preload=e)}get seekable(){return this.element.seekable}get seeking(){return this.element.seeking}onStartListeningToType(e){if(ht.has(e)){let t=this._listeningEvents[e];t||(t=this._listeningEvents[e]=()=>{this.event(e)}),this.element.addEventListener(e,t)}}destroy(){if(LayaEnv.isConch,this.element)if(LayaEnv.isConch)this.element._destroy();else for(this.element.pause(),this.element.src="";this.element.childElementCount;)this.element.firstChild.remove();ILaya.timer.clear(this,this.render),super.destroy()}}const ht=new Set(["abort","canplay","canplaythrough","durationchange","emptied","error","loadeddata","loadedmetadata","loadstart","pause","play","playing","progress","ratechange","seeked","seeking","stalled","suspend","timeupdate","volumechange","waiting","ended"]);class VideoNode extends Sprite{constructor(){if(super(),this.texture=this._internalTex=new Texture,LayaEnv.isPlaying&&ILaya.Browser.onMobile){let func=()=>{ILaya.Browser.document.removeEventListener("touchend",func),this._videoTexture&&(Browser.onIOS?this._videoTexture.load():(this._videoTexture.play(),this._videoTexture.pause()))};ILaya.Browser.document.addEventListener("touchend",func)}}get videoTexture(){return this._videoTexture}set videoTexture(e){this._videoTexture&&(this._videoTexture._removeReference(),this._videoTexture.off(Event.READY,this,this.onVideoMetaLoaded)),this._videoTexture=e,e?(this._videoTexture._addReference(),this._videoTexture.on(Event.READY,this,this.onVideoMetaLoaded),this._videoTexture._isLoaded&&this._internalTex.setTo(this._videoTexture)):this._internalTex.setTo(null)}get source(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.source}set source(e){e?(this._videoTexture||(this.videoTexture=new VideoTexture),this._videoTexture.source=e):this._videoTexture&&(this._videoTexture.source=e)}load(e){this.source=e}play(){this._videoTexture&&this._videoTexture.play()}pause(){this._videoTexture&&this._videoTexture.pause()}reload(){this._videoTexture&&this._videoTexture.load()}canPlayType(e){return this._videoTexture||(this.videoTexture=new VideoTexture),this._videoTexture.canPlayType(e)}onVideoMetaLoaded(){this._internalTex.setTo(this._videoTexture)}get buffered(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.buffered}get currentSrc(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.currentSrc}get currentTime(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.currentTime}set currentTime(e){this._videoTexture&&(this._videoTexture.currentTime=e)}set volume(e){this._videoTexture&&(this._videoTexture.volume=e)}get volume(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.volume}get readyState(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.readyState}get videoWidth(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.videoWidth}get videoHeight(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.videoHeight}get duration(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.duration}get ended(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.ended}get error(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.error}get loop(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.loop}set loop(e){this._videoTexture&&(this._videoTexture.loop=e)}get playbackRate(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.playbackRate}set playbackRate(e){this._videoTexture&&(this._videoTexture.playbackRate=e)}get muted(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.muted}set muted(e){this._videoTexture&&(this._videoTexture.muted=e)}get paused(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.paused}get preload(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.preload}set preload(e){this._videoTexture&&(this._videoTexture.preload=e)}get seekable(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.seekable}get seeking(){var e;return null===(e=this._videoTexture)||void 0===e?void 0:e.seeking}_setX(e){if(super._setX(e),this._videoTexture&&LayaEnv.isConch){var t=SpriteUtils.getTransformRelativeToWindow(this,0,0);this._videoTexture.element.style.left=t.x}}_setY(e){if(super._setY(e),this._videoTexture&&LayaEnv.isConch){var t=SpriteUtils.getTransformRelativeToWindow(this,0,0);this._videoTexture.element.style.top=t.y}}set_width(e){if(super.set_width(e),this._videoTexture)if(LayaEnv.isConch){var t=SpriteUtils.getTransformRelativeToWindow(this,0,0);this._videoTexture.element.width=e*t.scaleX}else this._videoTexture.element.width=this.width/ILaya.Browser.pixelRatio}set_height(e){if(super.set_height(e),this._videoTexture)if(LayaEnv.isConch){var t=SpriteUtils.getTransformRelativeToWindow(this,0,0);this._videoTexture.element.height=e*t.scaleY}else this._videoTexture.element.height=this.height/ILaya.Browser.pixelRatio}destroy(e=!0){this.videoTexture=null,super.destroy(e)}}class AnimatorPlayState2D{get duration(){return this._duration}get animatorState(){return this._currentState}constructor(){this._currentState=null,this._frontPlay=!0}_resetPlayState(e,t){this._finish=!1,this._startPlayTime=e,this._elapsedTime=e,this._lastIsFront=!0,this._parentPlayTime=null,this._playNum=0,this._playAllTime=0;var r=this._elapsedTime/t%1;this._normalizedPlayTime=r<0?r+1:r,this._frontPlay=!0}_cloneTo(e){e._finish=this._finish,e._startPlayTime=this._startPlayTime,e._elapsedTime=this._elapsedTime,e._playNum=this._playNum,e._parentPlayTime=this._parentPlayTime,e._normalizedPlayTime=this._normalizedPlayTime,e._lastIsFront=this._lastIsFront,e._frontPlay=this._frontPlay,e._playAllTime=this._playAllTime}}class AnimatorControllerLayer2D{constructor(e){this._referenceCount=0,this._playStateInfo=new AnimatorPlayState2D,this._crossPlayStateInfo=new AnimatorPlayState2D,this._crossMark=0,this._crossNodesOwnersCount=0,this._crossNodesOwnersIndicesMap={},this._srcCrossClipNodeIndices=[],this._destCrossClipNodeIndices=[],this.playOnWake=!0,this.defaultWeight=1,this.blendingMode=AnimatorControllerLayer2D.BLENDINGMODE_OVERRIDE,this.enable=!0,this._states=[],this._playType=-1,this.name=e}set states(e){if(this._states!==e){for(let e=this.states.length-1;e>=0;e--)this.removeState(this.states[e]);for(let t=e.length-1;t>=0;t--)this.addState(e[t])}}get states(){return this._states}set defaultStateName(e){if(this._defaultState=this.getStateByName(e),null==this._defaultState)if(0==this._states.length)this._defaultStateNameCatch=e;else for(var t=this._states.length-1;t>=0;t--)if(this._states[t].name==e){this._defaultState=this._states[t];break}}get defaultStateName(){return this._defaultState?this._defaultState.name:null}get defaultState(){return this._defaultState}set defaultState(e){this._defaultState=e}_removeClip(e,t,r){e.splice(t,1)}_getReferenceCount(){return this._referenceCount}_addReference(e){for(var t=0,r=this._states.length;t<r;t++)this._states[t]._addReference(e);this._referenceCount+=e}_removeReference(e=1){for(var t=0,r=this._states.length;t<r;t++)this._states[t]._removeReference(e);this._referenceCount-=e}_clearReference(){this._removeReference(-this._referenceCount)}getCurrentPlayState(){return this._playStateInfo}getStateByName(e){for(let t=this._states.length-1;t>=0;t--)if(this._states[t].name==e)return this._states[t];return null}addState(e){var t=e.name;if(this.getStateByName(t))throw"AnimatorControllerLayer:this stat's name has exist.";this._states.push(e),t==this._defaultStateNameCatch&&(this._defaultState=e,this._defaultStateNameCatch=null)}removeState(e){for(var t=this._states,r=-1,a=0,i=t.length;a<i;a++)if(t[a]===e){r=a;break}-1!=r&&this._removeClip(t,r,e)}clone(){var e=new AnimatorControllerLayer2D(this.name);return this.cloneTo(e),e}cloneTo(e){e.name=this.name}destroy(){this._removeReference();for(var e=0,t=this._states.length;e<t;e++)this._states[e].destroy();this._states.length=0}}var ut,dt,_t,ct,pt,mt;AnimatorControllerLayer2D.BLENDINGMODE_OVERRIDE=0,AnimatorControllerLayer2D.BLENDINGMODE_ADDTIVE=1,e.AniParmType=void 0,(ut=e.AniParmType||(e.AniParmType={}))[ut.Float=0]="Float",ut[ut.Bool=1]="Bool",ut[ut.Trigger=2]="Trigger",e.AniStateConditionType=void 0,(dt=e.AniStateConditionType||(e.AniStateConditionType={}))[dt.Number=0]="Number",dt[dt.Bool=1]="Bool",dt[dt.Trigger=2]="Trigger",e.AniStateConditionNumberCompressType=void 0,(_t=e.AniStateConditionNumberCompressType||(e.AniStateConditionNumberCompressType={}))[_t.Less=0]="Less",_t[_t.Greater=1]="Greater";class AnimatorControllerParse{static parse(e){let t=e,r=t.controllerLayers;null==r&&(r=[]);let a=[];for(let e=r.length-1;e>=0;e--){let i=r[e],s=i.states;s||(s=[],i.states=s),i.defaultStateName=null;let n=this.checkStates(s,a,t);n?i.defaultStateName=n.enterName:r.splice(e,1)}return{ret:t,clipsID:a}}static checkStates(e,t,r){let a=null,i=null;for(let s=e.length-1;s>=0;s--){let n=e[s];n.states?null==this.checkStates(n.states,t,r)?e.splice(s,1):(null==a&&(a=[]),a.push(n)):"-1"==n.id?i=n:"-2"==n.id||"-3"==n.id||(null==n.clip||null==n.clip._$uuid||""==n.clip._$uuid?e.splice(s,1):(0>t.indexOf(n.clip._$uuid)&&t.push(n.clip._$uuid),this.checkNext(n,e,r),null==a&&(a=[]),a.push(n)))}let s=null;if(a&&i){let e=this.checkDefault(i,a);null!=e&&(s={states:a,enterName:e})}return s}static checkNext(e,t,r){let a=e.soloTransitions;if(a)for(let e=a.length-1;e>=0;e--){let i=a[e],s=this.getStateByID(t,i.id);!s||null==s.clip&&"-3"!=s.id&&null==s.states?a.splice(e,1):(i.name=s.name,i.conditions=this.checkConditions(i.conditions,r))}}static checkConditions(t,r){if(!t||0==t.length||null==r.animatorParams||0==r.animatorParams.length)return[];let a=r.animatorParams;for(let r=t.length-1;r>=0;r--){let i=t[r],s=null;for(let e=a.length-1;e>=0;e--)if(a[e].id==i.id){s=a[e];break}if(null==s)t.splice(r,1);else if(i.name=s.name,s.type==e.AniParmType.Float){let e=Number(i.checkValue);isNaN(e)&&(i.checkValue=0),e=Number(i.type),isNaN(e)&&(i.type=0)}}return t}static checkDefault(e,t){let r=e.soloTransitions,a=null;r&&0<r.length&&(a=r[0].id);let i=null;if(null!=a&&(i=this.getStateByID(t,a)),null!=i&&(null!=i.clip||null!=i.states))return i.name;for(let e=t.length-1;e>=0;e--)if(t[e].clip)return t[e].name;return null}static getStateByID(e,t){if(e)for(let r=e.length-1;r>=0;r--)if(e[r].id==t)return e[r];return null}}e.AnimatorUpdateMode=void 0,(ct=e.AnimatorUpdateMode||(e.AnimatorUpdateMode={}))[ct.Normal=0]="Normal",ct[ct.LowFrame=1]="LowFrame",ct[ct.UnScaleTime=2]="UnScaleTime";class Animator2D extends Component{constructor(){super(),this._speed=1,this._updateMode=e.AnimatorUpdateMode.Normal,this._lowUpdateDelty=20,this._isPlaying=!0,this._controllerLayers=[],this._parameters={}}set controller(e){this._controller=e,e&&e.updateTo(this)}get controller(){return this._controller}set parameters(e){this._parameters=e}get parameters(){return this._parameters}set speed(e){this._speed=e}get speed(){return this._speed}get isPlaying(){return this._isPlaying}_updateStateFinish(e,t){t._finish&&e._eventExit()}_setClipDatasToNode(e,t,r,a=null){for(var i=e._realtimeDatas,s=e._clip._nodes,n=0,o=s.count;n<o;n++)if(null!=i[n]){var l=s.getNodeByIndex(n),h=this.getOwner(l);h&&this._applyFloat(h,t,r,i[n])}}_applyFloat(e,t,r,a){var i=e.pro;i&&i.ower&&(i.ower[i.key]=t&&"number"==typeof a?i.defVal+r*a:"number"==typeof a?r*a:a)}getOwner(e){var t;if(this._ownerMap&&(t=this._ownerMap.get(e)))return t;for(var r=this.owner,a=0,i=e.ownerPathCount;a<i;a++){var s=e.getOwnerPathByIndex(a);if(""!=s&&!(r=r.getChildByName(s)))break}if(t={ower:r},r){var n=r,o=e.propertyCount;if(1==o){var l=e.getPropertyByIndex(0);t.pro={ower:r,key:l,defVal:r[l]}}else for(var h=0;h<o;h++){l=e.getPropertyByIndex(h);if(h==o-1||null==n){t.pro={ower:n,key:l,defVal:n?n[l]:null};break}if(null==n[l]&&r==n){n=null;var u=ClassUtils.getClass(l);u&&(n=r.getComponent(u))}else n=n[l]}}return null==this._ownerMap&&(this._ownerMap=new Map),this._ownerMap.set(e,t),t}_updateClipDatas(e,t,r){var a=e._clip,i=a._duration,s=e.clipStart*i+r._normalizedPlayTime*r._duration,n=e._currentFrameIndices;a._evaluateClipDatasRealTime(s,n,t,!0,e._realtimeDatas)}_updatePlayer(e,t,r,a,i){let s=!1;var n=e._clip._duration*(e.clipEnd-e.clipStart),o=t._elapsedTime;let l=t._playAllTime;t._playAllTime+=Math.abs(r),r=o+r,t._lastElapsedTime=o,t._elapsedTime=r;var h=r/n;let u=1;e.yoyo&&(u=2);let d=t._playAllTime/(n*u);Math.floor(l/(n*u))<Math.floor(d)&&(s=!0);var _=h%1;let c=_<0?_+1:_;if(t._normalizedPlayTime=c,t._duration=n,1!=u&&(c=(_=(h=t._playAllTime/(n*u))%1)<0?_+1:_,e.yoyo&&(.5>c?t._frontPlay||(0>e.speed?(t._elapsedTime=e.clipEnd*l,t._normalizedPlayTime=e.clipEnd):(t._elapsedTime=e.clipStart*l,t._normalizedPlayTime=e.clipStart),t._frontPlay=!0):t._frontPlay&&(t._frontPlay=!1,0>e.speed?(t._elapsedTime=e.clipStart*l,t._normalizedPlayTime=e.clipStart):(t._elapsedTime=e.clipEnd*l,t._normalizedPlayTime=e.clipEnd)))),e._eventStateUpdate(c),!this._applyTransition(i,e._eventtransition(c,this.parameters,s))&&s){let r=t._playAllTime/(n*u);if(0<a&&a<=r)return t._finish=!0,void(0>e.speed?e.yoyo?(t._elapsedTime=e.clipEnd*l,t._normalizedPlayTime=e.clipEnd):(t._elapsedTime=e.clipStart*l,t._normalizedPlayTime=e.clipStart):e.yoyo?(t._elapsedTime=e.clipStart*l,t._normalizedPlayTime=e.clipStart):(t._elapsedTime=e.clipEnd*l,t._normalizedPlayTime=e.clipEnd));e._eventLoop()}}_updateEventScript(e,t){let r=e._clip,a=r._animationEvents;if(!a||0==a.length)return;let i=r._duration,s=t._normalizedPlayTime*i,n=t._frontPlay,o=t._parentPlayTime,l=t._parentPlayTime;null==l&&(l=n?i*t.animatorState.clipStart:i*t.animatorState.clipEnd),n?s<l&&(this._eventScript(a,l,i*t.animatorState.clipEnd,n),l=i*t.animatorState.clipStart):s>l&&(this._eventScript(a,l,i*t.animatorState.clipStart,n),l=i*t.animatorState.clipEnd),this._eventScript(a,l,s,n),o==t._parentPlayTime&&(t._parentPlayTime=s)}_eventScript(e,t,r,a){let i=this.owner.components;if(a)for(let a=0,s=e.length;a<s;a++){let s=e[a];if(s.time>t&&s.time<=r)for(let e=0,t=i.length;e<t;e++){let t=i[e];if(t._isScript()){let e=t[s.eventName];e&&e.apply(t,s.params)}}else if(s.time>r)break}else for(let a=e.length-1;a>=0;a--){let s=e[a];if(s.time<t&&s.time>=r)for(let e=0,t=i.length;e<t;e++){let t=i[e];if(t._isScript()){let e=t[s.eventName];e&&e.apply(t,s.params)}}else if(s.time<r)break}}_applyTransition(e,t){return!!t&&this.crossFade(t.destState.name,t.transduration,e,t.transstartoffset)}_applyUpdateMode(t){let r;switch(this._updateMode){case e.AnimatorUpdateMode.Normal:r=t;break;case e.AnimatorUpdateMode.LowFrame:r=Stat.loopCount%this._lowUpdateDelty==0?t*this._lowUpdateDelty:0;break;case e.AnimatorUpdateMode.UnScaleTime:r=0}return r}gotoAndStopByFrame(e,t,r){var a=this._controllerLayers[t];if(a){var i=a.getStateByName(e);if(!i||!i._clip)return;let s=r/(i._clip._duration*i._clip._frameRate);1<s&&(s=1),this.gotoAndStop(e,t,s)}}gotoAndStop(e,t,r){var a=this._controllerLayers[t];if(a){var i=a.getStateByName(e);if(!i||!i._clip)return;var s=a._playStateInfo,n=s._currentState,o=i._clip._duration,l=i._clip._duration*(i.clipEnd-i.clipStart);s._resetPlayState(o*r,l),s._normalizedPlayTime=r,a._playType=0,n!==i&&(s._currentState=i),i._eventStart(this,t);let h=a.blendingMode!=AnimatorControllerLayer2D.BLENDINGMODE_OVERRIDE;this._updateClipDatas(i,h,s),this._setClipDatasToNode(i,h,a.defaultWeight,a),this.stop()}}play(e,t=0,r=Number.NEGATIVE_INFINITY){if(this._checkEnterIndex){let e=this._checkEnterIndex.indexOf(t);0<=e&&this._checkEnterIndex.splice(e,1)}this._isPlaying=!0;var a=this._controllerLayers[t];if(a){var i=a.defaultState;if(!e&&!i)throw new Error("Animator:must have default clip value,please set clip property.");var s=a._playStateInfo,n=s._currentState,o=e?a.getStateByName(e):i;if(!o._clip)return;var l=o._clip._duration,h=o._clip._duration*(o.clipEnd-o.clipStart);n!==o?(r!==Number.NEGATIVE_INFINITY?s._resetPlayState(l*r,h):s._resetPlayState(0,h),a._playType=0,s._currentState=o):r!==Number.NEGATIVE_INFINITY&&(s._resetPlayState(l*r,h),a._playType=0),o._eventStart(this,t)}}stop(){this._isPlaying=!1}onUpdate(){if(this._isPlaying){if(this._checkEnterIndex)for(let t=this._checkEnterIndex.length-1;t>=0;t--){let r=this._checkEnterIndex[t];if(this._controllerLayers[r]._enterTransition.check(0,this.parameters,!0)){var e=this.getDefaultState(r);this.play(null,r,e.cycleOffset)}}var t=this.owner.timer._delta/1e3;if(t=this._applyUpdateMode(t),0!=this.speed&&0!=t)for(var r=0,a=this._controllerLayers.length;r<a;r++){var i=this._controllerLayers[r];if(i.enable){var s=i._playStateInfo,n=i.blendingMode!=AnimatorControllerLayer2D.BLENDINGMODE_OVERRIDE;if(0===i._playType){var o=s._currentState,l=this._speed*o.speed,h=s._finish,u=o.loop;-1>=u&&(u=o._clip.islooping?0:1);let e=1;s._frontPlay||(e=-1),h||this._updatePlayer(o,s,t*l*e,u,r),o=(s=i._playStateInfo)._currentState,this._updateClipDatas(o,n,s),h||(this._setClipDatasToNode(o,n,i.defaultWeight,i),this._updateEventScript(o,s)),h||this._updateStateFinish(o,s)}}}}}addControllerLayer(e){this._controllerLayers.push(e)}crossFade(e,t,r=0,a=Number.NEGATIVE_INFINITY){var i=this._controllerLayers[r];if(i){if(i.getStateByName(e))return this.play(e,r,a),!0;console.warn("Invalid layerIndex "+r+".")}return!1}onAfterDeserialize(){let e=this.controllerLayers;if(e&&null==this.controller){delete this.controllerLayers,this._controllerLayers.length=0;for(let t of e)this.addControllerLayer(t)}}onEnable(){if(this._checkEnterIndex?this._checkEnterIndex.length=0:this._checkEnterIndex=[],this._isPlaying)for(var e=0,t=this._controllerLayers.length;e<t;e++)if(this._controllerLayers[e].playOnWake){var r=this.getDefaultState(e);if(r){let t=this._controllerLayers[e]._enterTransition;t?(this._isPlaying=!0,t.check(0,this.parameters,!0)?this.play(null,e,r.cycleOffset):this._checkEnterIndex.push(e)):this.play(null,e,r.cycleOffset)}}}getDefaultState(e=0){return this._controllerLayers[e].defaultState}setParamsTrigger(t){this._parameters[t]={name:t,type:e.AniParmType.Trigger,value:!0}}setParamsNumber(t,r){this._parameters[t]={name:t,type:e.AniParmType.Float,value:r}}setParamsBool(t,r){this._parameters[t]={name:t,type:e.AniParmType.Float,value:r}}getParamsvalue(e){let t=this._parameters[e];return t?t.value:null}onDestroy(){for(var e=0,t=this._controllerLayers.length;e<t;e++)this._controllerLayers[e].destroy();this._controllerLayers.length=0,this._isPlaying=!1,this._parameters=null}}class AnimatorState2D extends EventDispatcher{constructor(){super(...arguments),this._referenceCount=0,this._clip=null,this._currentFrameIndices=null,this.cycleOffset=0,this.speed=1,this.clipStart=0,this.clipEnd=1,this.loop=-1,this.yoyo=!1,this.transitions=[],this.soloTransitions=[],this._scripts=null,this._realtimeDatas=[]}get clip(){return this._clip}set clip(e){if(this._clip!=e){if(this._clip&&this._referenceCount>0&&this._clip._removeReference(this._referenceCount),e){var t=e._nodes.count;this._currentFrameIndices=new Int16Array(t),this._resetFrameIndices(),this._referenceCount>0&&e._addReference(this._referenceCount),this._realtimeDatas.length=t}this._clip=e}}_eventStateUpdate(e){if(this.event(AnimatorState2D.EVENT_OnStateUpdate,e),this._scripts)for(var t=0,r=this._scripts.length;t<r;t++)this._scripts[t].onStateUpdate(e)}_eventStart(e,t){if(this.event(AnimatorState2D.EVENT_OnStateEnter),this._scripts)for(var r=0,a=this._scripts.length;r<a;r++)this._scripts[r].setPlayScriptInfo(e,t,this),this._scripts[r].onStateEnter()}_eventExit(){if(this.event(AnimatorState2D.EVENT_OnStateExit),this._scripts)for(let e=0,t=this._scripts.length;e<t;e++)this._scripts[e].onStateExit()}_eventLoop(){if(this.event(AnimatorState2D.EVENT_OnStateLoop),this._scripts)for(let e=0,t=this._scripts.length;e<t;e++)this._scripts[e].onStateLoop&&this._scripts[e].onStateLoop()}_eventtransition(e,t,r){let a=this.soloTransitions.length;if(a>0){for(var i=0;i<a;i++)if(this.soloTransitions[i].check(e,t,r))return this.soloTransitions[i];return null}let s=this.transitions.length;for(i=0;i<s;i++)if(this.transitions[i].check(e,t,r))return this.transitions[i];return null}_resetFrameIndices(){for(var e=0,t=this._currentFrameIndices.length;e<t;e++)this._currentFrameIndices[e]=-1}_getReferenceCount(){return this._referenceCount}_addReference(e){this._clip&&this._clip._addReference(e),this._referenceCount+=e}_removeReference(e){this._clip&&this._clip._removeReference(e),this._referenceCount-=e}_clearReference(){this._removeReference(-this._referenceCount)}addScript(e){var t=new e;return this._scripts=this._scripts||[],this._scripts.push(t),t}getScript(e){if(this._scripts)for(var t=0,r=this._scripts.length;t<r;t++){var a=this._scripts[t];if(a instanceof e)return a}return null}getScripts(e){var t=null;if(this._scripts)for(var r=0,a=this._scripts.length;r<a;r++){var i=this._scripts[r];i instanceof e&&(t=t||[]).push(i)}return t}clone(){var e=new AnimatorState2D;return this.cloneTo(e),e}cloneTo(e){var t=e;t.name=this.name,t.speed=this.speed,t.clip=this._clip}destroy(){this._clip=null,this._currentFrameIndices=null,this._scripts=null,this._realtimeDatas.length=0}}AnimatorState2D.EVENT_OnStateEnter="OnStartEnter",AnimatorState2D.EVENT_OnStateUpdate="OnStateUpdate",AnimatorState2D.EVENT_OnStateExit="OnStateExit",AnimatorState2D.EVENT_OnStateLoop="OnStateLoop";class KeyframeNode2D{constructor(){this._ownerPath=[],this._propertys=[],this._keyFrames=[]}get keyFramesCount(){return this._keyFrames.length}_setOwnerPathCount(e){this._ownerPath.length=e}_setOwnerPathByIndex(e,t){this._ownerPath[e]=t}_setPropertyCount(e){this._propertys.length=e}_setPropertyByIndex(e,t){this._propertys[e]=t}_setKeyframeCount(e){this._keyFrames.length=e}_joinOwnerPath(e){return this._ownerPath.join(e)}_joinProperty(e){return this._propertys.join(e)}getKeyframeByIndex(e){return this._keyFrames[e]}get ownerPathCount(){return this._ownerPath.length}get propertyCount(){return this._propertys.length}getOwnerPathByIndex(e){return this._ownerPath[e]}getPropertyByIndex(e){return this._propertys[e]}}class Keyframe2D{clone(){var e=new Keyframe2D;return this.cloneTo(e),e}cloneTo(e){e.time=this.time}}Keyframe2D.defaultWeight=.33333;class Animation2DEvent{constructor(){}}class AnimationClip2DParse01{static READ_DATA(){this._DATA.offset=this._reader.getUint32(),this._DATA.size=this._reader.getUint32()}static READ_BLOCK(){for(var e=this._BLOCK.count=this._reader.getUint16(),t=this._BLOCK.blockStarts=[],r=this._BLOCK.blockLengths=[],a=0;a<e;a++)t.push(this._reader.getUint32()),r.push(this._reader.getUint32())}static READ_STRINGS(){var e=this._reader.getUint32(),t=this._reader.getUint16(),r=this._reader.pos;this._reader.pos=e+this._DATA.offset;for(var a=0;a<t;a++)this._strings[a]=this._reader.readUTFString();this._reader.pos=r}static parse(e,t,r){this._clip=e,this._reader=t,this._version=r,this.READ_DATA(),this.READ_BLOCK(),this.READ_STRINGS();for(var a=0,i=this._BLOCK.count;a<i;a++){var s=t.getUint16(),n=this._strings[s],o=this["READ_"+n];if(!o)throw new Error("model file err,no this function:"+s+" "+n);o.call(this)}this._version=null,this._reader=null,this._clip=null,this._strings.length=0}static timeToFrame(e,t){return Math.round(e*t)}static READ_ANIMATIONS2D(){var e,t,r,a=this._reader,i=this._clip,s=[],n=a.getUint16();for(s.length=n,e=0;e<n;e++)s[e]=a.getFloat32();i._duration=s[a.getInt16()],i.islooping=!!a.getByte(),i._frameRate=a.getInt16();var o=a.getInt16(),l=i._nodes;l.count=o;var h=i._nodesMap={},u=i._nodesDic={};for(e=0;e<o;e++){r=new KeyframeNode2D,l.setNodeByIndex(e,r),r._indexInList=e;var d=a.getUint16();for(r._setOwnerPathCount(d),t=0;t<d;t++)r._setOwnerPathByIndex(t,this._strings[a.getUint16()]);var _=r._joinOwnerPath("/"),c=h[_];c||(h[_]=c=[]),c.push(r);var p=a.getUint16();for(r._setPropertyCount(p),t=0;t<p;t++)r._setPropertyByIndex(t,this._strings[a.getUint16()]);var m=_+"."+r._joinProperty(".");u[m]=r,r.fullPath=m,r.nodePath=_;var f=a.getUint16();for(t=0;t<f;t++){var g=new Keyframe2D;g.time=s[a.getUint16()],g.data={f:this.timeToFrame(g.time,i._frameRate),val:0},1==a.getByte()&&(g.data.tweenType=this._strings[a.getUint16()]),1==a.getByte()&&(g.data.tweenInfo={},g.data.tweenInfo.inTangent=s[a.getUint16()],g.data.tweenInfo.outTangent=s[a.getUint16()],1==a.getByte()&&(g.data.tweenInfo.inWeight=s[a.getUint16()]),1==a.getByte()&&(g.data.tweenInfo.outWeight=s[a.getUint16()]));var T=a.getByte();if(0==T?g.data.val=s[a.getUint16()]:1==T?g.data.val=this._strings[a.getUint16()]:2==T&&(g.data.val=!!a.getByte()),1==a.getByte())try{g.data.extend=JSON.parse(this._strings[a.getUint16()])}catch(e){}r._keyFrames.push(g)}}var S=a.getUint16();for(e=0;e<S;e++){var x=new Animation2DEvent;x.time=s[a.getUint16()],x.eventName=this._strings[a.getUint16()];var y=[],E=a.getUint16();for(E>0&&(x.params=y=[]),t=0;t<E;t++){switch(a.getByte()){case 0:y.push(!!a.getByte());break;case 1:y.push(a.getInt32());break;case 2:y.push(s[a.getUint16()]);break;case 3:y.push(this._strings[a.getUint16()]);break;default:throw new Error("unknown type.")}}i.addEvent(x)}}}AnimationClip2DParse01._strings=[],AnimationClip2DParse01._DATA={offset:0,size:0},AnimationClip2DParse01._BLOCK={count:0};class KeyframeNodeList2D{constructor(){this._nodes=[]}get count(){return this._nodes.length}set count(e){this._nodes.length=e}getNodeByIndex(e){return this._nodes[e]}setNodeByIndex(e,t){this._nodes[e]=t}}class AnimationClip2D extends Resource{static _parse(e){var t=new AnimationClip2D,r=new Byte(e),a=r.readUTFString();if("LAYAANIMATION2D:01"!==a)throw"unknown animationClip version.";return AnimationClip2DParse01.parse(t,r,a),t}constructor(){super(),this._nodes=new KeyframeNodeList2D,this._animationEvents=[]}duration(){return this._duration}_evaluateClipDatasRealTime(e,t,r,a,i){for(var s=this._nodes,n=0,o=s.count;n<o;n++){var l,h=s.getNodeByIndex(n)._keyFrames,u=h.length;if(0!=u){var d=t[n];if(a)for(-1!=d&&e<h[d].time&&(d=-1,t[n]=d),l=d+1;l<u&&!(h[l].time>e);)d++,l++,t[n]=d;else for((l=d+1)!=u&&e>h[l].time&&(d=u-1,t[n]=d),l=d+1;d>-1&&!(h[d].time<e);)d--,l--,t[n]=d;var _=l==u;if(-1!=d){var c=h[d];if(_)i[n]=c.data.val;else{var p,m=h[l],f=m.time-c.time;p=0!==f?(e-c.time)/f:0,i[n]=this._getTweenVal(c,m,p,f)}}else i[n]=h[0].data.val;r&&"number"==typeof h[0].data.val&&(i[n]=i[n]-h[0].data.val)}}}_getTweenVal(e,t,r,a){var i=e.data,s=t.data;if("number"!=typeof i.val||"number"!=typeof s.val)return i.val;var n=AnimationClip2D.tween[i.tweenType],o=i.val,l=s.val;if(null!=n)return n(r,o,l-o,1);var h=0,u=0,d=NaN,_=NaN;return null!=i.tweenInfo&&(h=i.tweenInfo.outTangent,d=i.tweenInfo.outWeight),null!=s.tweenInfo&&(u=s.tweenInfo.inTangent,_=s.tweenInfo.inWeight),(isNaN(d)||0>=d)&&(d=Keyframe2D.defaultWeight),(isNaN(_)||0>=_)&&(_=Keyframe2D.defaultWeight),isNaN(h)&&(h=0),isNaN(u)&&(u=0),Math.abs(h)==Number.MAX_VALUE&&(h=0>h?-1/0:1/0),Math.abs(u)==Number.MAX_VALUE&&(u=0>u?-1/0:1/0),!i.tweenInfo&&!s.tweenInfo||Keyframe2D.defaultWeight==_&&Keyframe2D.defaultWeight==d?AnimationClip2D.tween.hermiteInterpolate(h,u,o,l,r,a):this.hermiteCurveSplineWeight(o,e.time,d,h,l,t.time,_,u,r)}_binarySearchEventIndex(e){for(var t,r=0,a=this._animationEvents.length-1;r<=a;){t=r+a>>1;var i=this._animationEvents[t].time;if(i==e)return t;i>e?a=t-1:r=t+1}return r}hermiteCurveSplineWeight(e,t,r,a,i,s,n,o,l){let h=222e-18,u=l,d=e,_=r,c=n,p=s-t,m=i-d;m=Math.max(Math.abs(m),h)*(m<0?-1:1);let f=a,g=o;if(!Number.isFinite(f)||!Number.isFinite(g))return e;f=f*p/m,g=g*p/m;let T=1-c,S=.5,x=0;if(Math.abs(_-.33333334)<1e-4&&Math.abs(c-.33333334)<1e-4)S=u,x=1-S;else for(;;){x=1-S;let e=3*x*x*S*_+3*x*S*S*T+S*S*S-u;if(Math.abs(e)<=2.5*h)break;let t=3*x*x*_+6*x*S*(T-_)+3*S*S*(1-T),r=6*x*(T-2*_)+6*S*(1-2*T+_);S-=(6*e*t*t-3*e*e*r)/(6*t*t*t-6*e*t*r+e*e*(18*_-18*T+6))}return(3*x*x*S*_*f+3*x*S*S*(1-c*g)+S*S*S)*m+d}addEvent(e){var t=this._binarySearchEventIndex(e.time);this._animationEvents.splice(t,0,e)}}AnimationClip2D.tween={Linear:function(e,t,r,a){return r*e/a+t},Quad_EaseIn:function(e,t,r,a){return r*(e/=a)*e+t},Quad_EaseOut:function(e,t,r,a){return-r*(e/=a)*(e-2)+t},Quad_EaseInOut:function(e,t,r,a){return(e/=a/2)<1?r/2*e*e+t:-r/2*(--e*(e-2)-1)+t},Cubic_EaseIn:function(e,t,r,a){return r*(e/=a)*e*e+t},Cubic_EaseOut:function(e,t,r,a){return r*((e=e/a-1)*e*e+1)+t},Cubic_EaseInOut:function(e,t,r,a){return(e/=a/2)<1?r/2*e*e*e+t:r/2*((e-=2)*e*e+2)+t},Quart_EaseIn:function(e,t,r,a){return r*(e/=a)*e*e*e+t},Quart_EaseOut:function(e,t,r,a){return-r*((e=e/a-1)*e*e*e-1)+t},Quart_EaseInOut:function(e,t,r,a){return(e/=a/2)<1?r/2*e*e*e*e+t:-r/2*((e-=2)*e*e*e-2)+t},Quint_EaseIn:function(e,t,r,a){return r*(e/=a)*e*e*e*e+t},Quint_EaseOut:function(e,t,r,a){return r*((e=e/a-1)*e*e*e*e+1)+t},Quint_EaseInOut:function(e,t,r,a){return(e/=a/2)<1?r/2*e*e*e*e*e+t:r/2*((e-=2)*e*e*e*e+2)+t},Sine_EaseIn:function(e,t,r,a){return-r*Math.cos(e/a*(Math.PI/2))+r+t},Sine_EaseOut:function(e,t,r,a){return r*Math.sin(e/a*(Math.PI/2))+t},Sine_EaseInOut:function(e,t,r,a){return-r/2*(Math.cos(Math.PI*e/a)-1)+t},Expo_EaseIn:function(e,t,r,a){return 0==e?t:r*Math.pow(2,10*(e/a-1))+t},Expo_EaseOut:function(e,t,r,a){return e==a?t+r:r*(1-Math.pow(2,-10*e/a))+t},Expo_EaseInOut:function(e,t,r,a){return 0==e?t:e==a?t+r:(e/=a/2)<1?r/2*Math.pow(2,10*(e-1))+t:r/2*(2-Math.pow(2,-10*--e))+t},Circ_EaseIn:function(e,t,r,a){return-r*(Math.sqrt(1-(e/=a)*e)-1)+t},Circ_EaseOut:function(e,t,r,a){return r*Math.sqrt(1-(e=e/a-1)*e)+t},Circ_EaseInOut:function(e,t,r,a){return(e/=a/2)<1?-r/2*(Math.sqrt(1-e*e)-1)+t:r/2*(Math.sqrt(1-(e-=2)*e)+1)+t},Elastic_EaseIn:function(e,t,r,a,i,s){if(0==e)return t;if(1==(e/=a))return t+r;if(s||(s=.3*a),!i||i<Math.abs(r)){i=r;var n=s/4}else n=s/(2*Math.PI)*Math.asin(r/i);return-i*Math.pow(2,10*(e-=1))*Math.sin((e*a-n)*(2*Math.PI)/s)+t},Elastic_EaseOut:function(e,t,r,a,i,s){if(0==e)return t;if(1==(e/=a))return t+r;if(s||(s=.3*a),!i||i<Math.abs(r)){i=r;var n=s/4}else n=s/(2*Math.PI)*Math.asin(r/i);return i*Math.pow(2,-10*e)*Math.sin((e*a-n)*(2*Math.PI)/s)+r+t},Elastic_EaseInOut:function(e,t,r,a,i,s){if(0==e)return t;if(2==(e/=a/2))return t+r;if(s||(s=a*(.3*1.5)),!i||i<Math.abs(r)){i=r;var n=s/4}else n=s/(2*Math.PI)*Math.asin(r/i);return e<1?i*Math.pow(2,10*(e-=1))*Math.sin((e*a-n)*(2*Math.PI)/s)*-.5+t:i*Math.pow(2,-10*(e-=1))*Math.sin((e*a-n)*(2*Math.PI)/s)*.5+r+t},Back_EaseIn:function(e,t,r,a,i){return null==i&&(i=1.70158),r*(e/=a)*e*((i+1)*e-i)+t},Back_EaseOut:function(e,t,r,a,i){return null==i&&(i=1.70158),r*((e=e/a-1)*e*((i+1)*e+i)+1)+t},Back_EaseInOut:function(e,t,r,a,i){return null==i&&(i=1.70158),(e/=a/2)<1?r/2*(e*e*((1+(i*=1.525))*e-i))+t:r/2*((e-=2)*e*((1+(i*=1.525))*e+i)+2)+t},Bounce_EaseIn:function(e,t,r,a){return r-AnimationClip2D.tween.Bounce_EaseOut(a-e,0,r,a)+t},Bounce_EaseOut:function(e,t,r,a){return(e/=a)<1/2.75?r*(7.5625*e*e)+t:e<2/2.75?r*(7.5625*(e-=1.5/2.75)*e+.75)+t:e<2.5/2.75?r*(7.5625*(e-=2.25/2.75)*e+.9375)+t:r*(7.5625*(e-=2.625/2.75)*e+.984375)+t},Bounce_EaseInOut:function(e,t,r,a){return e<a/2?.5*AnimationClip2D.tween.Bounce_EaseIn(2*e,0,r,a)+t:.5*AnimationClip2D.tween.Bounce_EaseOut(2*e-a,0,r,a)+.5*r+t},hermiteInterpolate:function(e,t,r,a,i,s){if(Math.abs(e)==1/0||Math.abs(t)==1/0)return r;var n=i*i,o=n*i;return(2*o-3*n+1)*r+(o-2*n+i)*e*s+(o-n)*t*s+(-2*o+3*n)*a}};class Animation2DParm{}e.AniConditionType=void 0,(pt=e.AniConditionType||(e.AniConditionType={}))[pt.Greater=0]="Greater",pt[pt.Less=1]="Less",pt[pt.Equals=2]="Equals",pt[pt.NotEqual=3]="NotEqual";class Animation2DCondition{}class AnimatorStateCondition{static conditionNameToID(e){if(null!=AnimatorStateCondition._conditionNameMap[e])return AnimatorStateCondition._conditionNameMap[e];var t=this._propertyNameCounter++;return this._conditionNameMap[e]=t,this._conditionNameMap[t]=e,t}static conditionIDToName(e){return this._conditionNameMap[e]}constructor(e=null){e&&(this._id=AnimatorStateCondition.conditionNameToID(e),this._name=e)}get id(){return this._id}get name(){return this._name}set name(e){this._id=AnimatorStateCondition.conditionNameToID(e),this._name=e}get type(){return this._type}checkState(e){return!1}}AnimatorStateCondition._conditionNameMap={},AnimatorStateCondition._propertyNameCounter=0;class AnimatorStateNumberCondition extends AnimatorStateCondition{constructor(t){super(t),this._numberValue=0,this._numberCompareFlag=e.AniStateConditionNumberCompressType.Greater,this._type=e.AniStateConditionType.Number}get numberValue(){return this._numberValue}set numberValue(e){this._numberValue=e}get compareFlag(){return this._numberCompareFlag}set compareFlag(e){this._numberCompareFlag=e}checkState(t){return e.AniStateConditionNumberCompressType.Greater==this._numberCompareFlag?t>this._numberValue:t<this._numberValue}}class AnimatorStateBoolCondition extends AnimatorStateCondition{constructor(t){super(t),this._compareFlag=!0,this._type=e.AniStateConditionType.Bool}get compareFlag(){return this._compareFlag}set compareFlag(e){this._compareFlag=e}checkState(e){return this._compareFlag==e}}class AnimatorStateTriggerCondition extends AnimatorStateCondition{constructor(t){super(t),this._type=e.AniStateConditionType.Trigger}checkState(e){return e}}class AnimatorTransition2D{constructor(){this.conditions=[],this.exitByTime=!0,this.exitTime=1,this.transduration=0,this.transstartoffset=0,this.mute=!1}addCondition(e){-1==this.conditions.indexOf(e)&&this.conditions.push(e)}removeCondition(e){let t=this.conditions.indexOf(e);-1!=t&&this.conditions.splice(t,0)}check(t,r,a){if(this.mute)return!1;if(this.exitByTime&&t<this.exitTime&&!a)return!1;if(null==this.conditions||0==this.conditions.length)return!0;for(var i=0;i<this.conditions.length;i++){let t=this.conditions[i];if(t.checkState(r[t.name].value))return t.type==e.AniStateConditionType.Trigger&&(r[t.name].value=!1),!0}return!1}}class AnimatorController2D extends Resource{constructor(e){super();let t=AnimatorControllerParse.parse(e);this.data=t.ret,this.clipsID=t.clipsID}getLayers(){let e=this.data.controllerLayers,t=[];for(let r=e.length-1;r>=0;r--){let a=e[r],i=new AnimatorControllerLayer2D(a.name);t.unshift(i);for(let e in a)if("name"!=e&&"states"!=e&&null!=a[e])try{i[e]=a[e]}catch(e){}this.getState(a.states,i,this.data)}return t}createState(e,t,r){if(!e)return null;let a={},i=null;for(let s=e.length-1;s>=0;s--){let n=e[s],o=n.states;if(o){let e=this.createState(o,t,r);e&&(t[n.id]=e.states[e.id]);continue}if(0>Number(n.id)){if("-1"==n.id){let e=n.soloTransitions;e&&0<e.length&&(i=e[0].id)}continue}let l=new AnimatorState2D;t[n.id]=l,a[n.id]=l;for(let e in n)try{if("scripts"==e){let t=n[e];if(t&&Array.isArray(t))for(let e=t.length-1;e>=0;e--){let r=t[e];r&&0==r.indexOf("res://")&&(r=r.substring(6));let a=ClassUtils.getClass(r);a&&l.addScript(a)}continue}if("soloTransitions"==e)continue;null!=n[e]&&(l[e]=n[e])}catch(e){}r.addState(l)}return{id:i,states:a}}getState(e,t,r){if(e){let a={};this.createState(e,a,t),this.setTransitions(e,a,t,r)}}setExitTransition(e,t,r,a,i){for(let s in e){let n=r[s];if(n){let o=n.transitions,l=n.soloTransitions,h=e[s];for(let e=t.length-1;e>=0;e--){let n=t[e];if("-3"!=n.id)for(let e=h.length-1;e>=0;e--){let t=h[e],i=new AnimatorTransition2D;i.destState=r[n.id],n.conditions&&this.addConditions(n.conditions,i,a),t.conditions&&this.addConditions(t.conditions,i,a);for(let e in n)"solo"!=e&&"id"!=e&&"conditions"!=e&&(i[e]=n[e]);n.solo?l.unshift(i):o.unshift(i)}else null==i[s]&&(i[s]=[]),i[s].push(n)}}}}_getAnimatorTransition2D(e,t,r){let a=new AnimatorTransition2D;t[e.id]&&(a.destState=t[e.id]),e.conditions&&this.addConditions(e.conditions,a,r);for(let t in e)"solo"!=t&&"id"!=t&&"conditions"!=t&&(a[t]=e[t]);return a}setTransitions(e,t,r,a,i){if(!e)return null;let s={};for(let i=e.length-1;i>=0;i--){let n=e[i];if(n.states){let e=this.setTransitions(n.states,t,r,a,n);if(e){let r=n.soloTransitions;r&&this.setExitTransition(e,r,t,a,s)}}}for(let n=e.length-1;n>=0;n--){let o=e[n];if(o.states)continue;if("-1"==o.id){if(o.soloTransitions&&0<o.soloTransitions.length){null==i?(r.defaultState=t[o.soloTransitions[0].id],r._enterTransition=this._getAnimatorTransition2D(o.soloTransitions[0],t,a)):t[i.id]=t[o.soloTransitions[0].id];continue}}else{if("-2"==o.id){let e=o.soloTransitions;if(e)for(let r=e.length-1;r>=0;r--){let i=e[r];if(t[i.id])for(let e in t){let r=t[e],s=this._getAnimatorTransition2D(i,t,a);i.solo?r.soloTransitions.unshift(s):r.transitions.unshift(s)}}continue}if("-3"==o.id)continue}let l=o.soloTransitions;if(l&&t[o.id]){let e=t[o.id].transitions,r=t[o.id].soloTransitions;for(let i=l.length-1;i>=0;i--){let n=l[i];if("-3"==n.id){null==s[o.id]&&(s[o.id]=[]),s[o.id].push(n);continue}let h=this._getAnimatorTransition2D(n,t,a);n.solo?r.unshift(h):e.unshift(h)}}}return s}addConditions(t,r,a){let i=a.animatorParams;if(null!=i&&0!=i.length)for(let a=0,s=t.length;a<s;a++){let s,n=t[a],o=null;for(let e=i.length-1;e>=0;e--)if(i[e].id==n.id){o=i[e];break}if(null==o)return;if(o.type==e.AniParmType.Bool){let e=new AnimatorStateBoolCondition(o.name);e.compareFlag=Boolean(n.checkValue),s=e}else if(o.type==e.AniParmType.Float){let e=new AnimatorStateNumberCondition(o.name);e.numberValue=Number(n.checkValue),e.compareFlag=n.type,s=e}else if(o.type==e.AniParmType.Trigger){s=new AnimatorStateTriggerCondition(o.name)}r.addCondition(s)}}updateTo(e){let t=e._controllerLayers;for(let e=0,r=t.length;e<r;e++)t[e].destroy();t.length=0;let r=this.getLayers();for(let t=0,a=r.length;t<a;t++)e.addControllerLayer(r[t]);let a=this.data.animatorParams;if(a){let t={};for(let e=a.length-1;e>=0;e--){let r=a[e],i=new Animation2DParm;i.name=r.name,i.type=r.type,i.value=r.val,t[r.name]=i}e.parameters=t}}}class Script extends Component{_isScript(){return!0}setupScript(){let e,t=this.owner;this.onTriggerEnter!=Script.prototype.onTriggerEnter&&t.on(Event.TRIGGER_ENTER,this,this.onTriggerEnter),this.onTriggerStay!=Script.prototype.onTriggerStay&&t.on(Event.TRIGGER_STAY,this,this.onTriggerStay),this.onTriggerExit!=Script.prototype.onTriggerExit&&t.on(Event.TRIGGER_EXIT,this,this.onTriggerExit),this.onCollisionEnter!=Script.prototype.onCollisionEnter&&t.on(Event.COLLISION_ENTER,this,this.onCollisionEnter),this.onCollisionStay!=Script.prototype.onCollisionStay&&t.on(Event.COLLISION_STAY,this,this.onCollisionStay),this.onCollisionExit!=Script.prototype.onCollisionExit&&t.on(Event.COLLISION_EXIT,this,this.onCollisionExit),(e=this.onJointBreak)&&t.on(Event.JOINT_BREAK,this,e),(e=this.onMouseDown)&&t.on(Event.MOUSE_DOWN,this,e),(e=this.onMouseUp)&&t.on(Event.MOUSE_UP,this,e),(e=this.onRightMouseDown)&&t.on(Event.RIGHT_MOUSE_DOWN,this,e),(e=this.onRightMouseUp)&&t.on(Event.RIGHT_MOUSE_UP,this,e),(e=this.onMouseMove)&&t.on(Event.MOUSE_MOVE,this,e),(e=this.onMouseDrag)&&t.on(Event.MOUSE_DRAG,this,e),(e=this.onMouseDragEnd)&&t.on(Event.MOUSE_DRAG_END,this,e),(e=this.onMouseOver)&&t.on(Event.MOUSE_OVER,this,e),(e=this.onMouseOut)&&t.on(Event.MOUSE_OUT,this,e),(e=this.onMouseClick)&&t.on(Event.CLICK,this,e),(e=this.onMouseDoubleClick)&&t.on(Event.DOUBLE_CLICK,this,e),(e=this.onMouseRightClick)&&t.on(Event.RIGHT_CLICK,this,e),(e=this.onKeyDown)&&ILaya.stage.on(Event.KEY_DOWN,this,e),(e=this.onKeyPress)&&ILaya.stage.on(Event.KEY_PRESS,this,e),(e=this.onKeyUp)&&ILaya.stage.on(Event.KEY_UP,this,e),t.event(Event._Add_Script)}}e.TextResourceFormat=void 0,(mt=e.TextResourceFormat||(e.TextResourceFormat={}))[mt.Buffer=0]="Buffer",mt[mt.Plain=1]="Plain",mt[mt.JSON=2]="JSON",mt[mt.XML=3]="XML";class TextResource extends Resource{constructor(e,t){super(),this.data=e,this.format=t}}Loader.registerLoader(["txt","csv"],class{load(t){return t.loader.fetch(t.url,"text",t.progress.createCallback(),t.options).then((t=>t?new TextResource(t,e.TextResourceFormat.Plain):null))}},Loader.TEXT),Loader.registerLoader(["bin","bytes","fui"],class{load(t){return t.loader.fetch(t.url,"arraybuffer",t.progress.createCallback(),t.options).then((t=>t?new TextResource(t,e.TextResourceFormat.Buffer):null))}},Loader.BUFFER),Loader.registerLoader(["json"],class{load(t){return t.loader.fetch(t.url,"json",t.progress.createCallback(),t.options).then((t=>t?new TextResource(t,e.TextResourceFormat.JSON):null))}},Loader.JSON),Loader.registerLoader(["xml"],class{load(t){return t.loader.fetch(t.url,"xml",t.progress.createCallback(),t.options).then((t=>t?new TextResource(t,e.TextResourceFormat.XML):null))}},Loader.XML);Loader.registerLoader(["atlas"],class{load(e){return e.loader.fetch(e.url,"json",e.progress.createCallback(.2),e.options).then((t=>{if(!t)return null;let r=[];if(t.meta&&t.meta.image){let a="",i=e.url.lastIndexOf("/");-1!=i&&(a=e.url.substring(0,i+1));let s="";i=e.url.lastIndexOf("?"),-1!=i&&(s=e.url.substring(i));let n=t.meta.image.split(",");for(let t of n)r.push(e.loader.load(a+t+s,null,e.progress.createCallback()))}else r.push(e.loader.load(Utils.replaceFileExtension(e.url,"png"),null,e.progress.createCallback()));return Promise.all(r).then((r=>{let a=e.options.baseUrl||"",i=t.frames,s=t.meta&&null!=t.meta.prefix?t.meta.prefix:e.url.substring(0,e.url.lastIndexOf("."))+"/",n=[],o=1;t.meta&&t.meta.scale&&1!=t.meta.scale&&(o=parseFloat(t.meta.scale));for(let e of r)e&&(e._addReference(),e.scaleRate=o);for(let t in i){let o=i[t],l=r[o.frame.idx?o.frame.idx:0];if(!l)continue;let h=a+s+(o.filename||t),u=Texture.create(l,o.frame.x,o.frame.y,o.frame.w,o.frame.h,o.spriteSourceSize.x,o.spriteSourceSize.y,o.sourceSize.w,o.sourceSize.h);u.lock=!0,u._sizeGrid=o.sizeGrid,u._stateNum=o.stateNum,e.loader.cacheRes(h,u),u.url=h,n.push(u)}return new AtlasResource(s,r,n)}))}))}},Loader.ATLAS);const ft=[];class HierarchyParser{static parse(e,t,r){r=r||ft;let a,i,s,n,o,l,h,u={},d=[],_=[],c=[];function createChildren(e,t){for(let r of e._$child)if(r._$child){let e=createNode(r,t);createChildren(r,r._$prefab?e:t),d.push(r),_.push(e)}else{let e=createNode(r,t);d.push(r),_.push(e)}}function createNode(e,t,a){let i,n;if(n=e._$override){if(t&&s)if(Array.isArray(n)){i=t;for(let e=0,t=n.length;e<t;e++){let t=s.get(i);if(i=null==t?void 0:t[n[e]],!i)break}}else{let r=s.get(t);r&&(i=r[e._$override])}}else{if(n=e._$prefab){let t=Loader.getRes(URL.getResURLByUUID(n),Loader.HIERARCHY);if(t){s||(s=new Map);let a=[],n=e._$id;if(o)for(let e=0,t=o.length;e<t;e++){let r=o[e];r&&r.length>0?a[e]=r.filter((r=>{let a=r._$override||r._$parent;return Array.isArray(a)&&a.length>t-e&&a[t-e-1]==n})):a[e]=r}a.push(e._$child),i=t.create({inPrefab:!0,prefabNodeDict:s,overrideData:a},r)}}else if(n=e._$type){let e=ClassUtils.getClass(a||n);if(e)try{i=new e,null==a||i instanceof Node||(r.push(new Error(`runtime class invalid - '${a}', must derive from Node`)),i=null)}catch(e){r.push(e)}else r.push(new Error(`unknown type '${a||n}'`))}i&&(u[e._$id]=i)}return i}function findNodeInPrefab(e,t,r=0){if(!t)return e;let a=null==s?void 0:s.get(e);if(!a)return null;if(Array.isArray(t)){let e;for(let i=r,n=t.length;i<n;i++){if(!a)return null;if(e=a[t[i]],!e)break;a=s.get(e)}return e}return a[t]}if(t&&(i=t.inPrefab,i&&(s=t.prefabNodeDict),n=t.skinBaseUrl,o=t.overrideData),e._$type||e._$prefab){h=e._$runtime,h&&h.startsWith("res://")&&(h=h.substring(6));let t=createNode(e,null,h);t&&(e._$child&&createChildren(e,e._$prefab?t:null),d.push(e),_.push(t),t instanceof Scene&&(a=t))}else e._$child&&createChildren(e,null);let p=d.length,m=0,f=[];for(let e=0;e<p;e++){let t=d[e],r=_[e],i=t._$child;if(i){let e=i.length;if(r)if(t._$prefab)for(let t=0;t<e;t++){let a=m-e+t,i=c[a];if(i&&!i.parent){let e=f[a],t=findNodeInPrefab(r,e._$parent);if(t){let r=e._$index;null!=r&&r<t.numChildren?t.addChildAt(i,r):t.addChild(i)}else r.addChildAt(i,0)}}else for(let t=0;t<e;t++){let i=c[m-e+t];i&&(r===a&&i._is3D?a._scene3D=i:r.addChild(i))}m-=e}c[m]=r,f[m]=t,m++}c.length=m,c=c.filter((e=>null!=e));let g=c[0],T=[];for(let e=0;e<p;e++){let t=d[e]._$comp;if(!t)continue;let a=_[e];if(a)for(let e of t){let t;if(e._$override){let r=ClassUtils.getClass(e._$override);r&&(t=a.getComponent(r))}else{let i=ClassUtils.getClass(e._$type);if(i&&(t=a.getComponent(i),!t))try{t=a.addComponent(i)}catch(e){r.push(e)}}t&&T.push(e,t)}}const S={outErrors:r,getNodeByRef:function(e){if(Array.isArray(e)){let t=u[e[0]];return t&&e.length>1?findNodeInPrefab(t,e,1):t}return u[e]},getNodeData:function(e){e.visible=!1;let t=_.indexOf(e),r=d[t];return o?(void 0===l&&(l=SerializeUtil.bakeOverrideData(o)),l?SerializeUtil.applyOverrideData(r,l):r):r}};for(let e=0;e<p;e++){let t=d[e],a=_[e];if(a&&(null!=n&&a instanceof Sprite&&(a._skinBaseUrl=n),SerializeUtil.decodeObj(t,a,S),h&&t._$var&&a.name))try{g[a.name]=a}catch(e){r.push(e)}}p=T.length;for(let e=0;e<p;e+=2)SerializeUtil.decodeObj(T[e],T[e+1],S);return i&&s&&g&&s.set(g,u),r==ft&&(ft.length=0),c}static collectResourceLinks(e,t){let r={},a=[];function addInnerUrl(e,i){if(!e)return"";let s=r[e];if(void 0===s){let n;n=e.length>=36&&45===e.charCodeAt(8)&&45===e.charCodeAt(13)?"res://"+e:URL.join(t,e),a.push({url:n,type:i}),r[e]=s=[n,i]}else-1==s.indexOf(i,1)&&(s.push(i),a.push({url:s[0],type:i}));return s[0]}if(function check(e){for(let t in e){let r=e[t];if(null!=r)if(Array.isArray(r))for(let e of r)null!=e&&"object"==typeof e&&(null!=e._$uuid?e._$uuid=addInnerUrl(e._$uuid,SerializeUtil.getLoadTypeByEngineType(e._$type)):null!=e._$prefab?(e._$prefab=addInnerUrl(e._$prefab,Loader.HIERARCHY),check(e)):check(e));else"object"==typeof r&&(null!=r._$uuid?r._$uuid=addInnerUrl(r._$uuid,SerializeUtil.getLoadTypeByEngineType(r._$type)):null!=r._$prefab?(r._$prefab=addInnerUrl(r._$prefab,Loader.HIERARCHY),check(r)):check(r))}}(e),e._$preloads)for(let t of e._$preloads)a.push(t);return a}}class HierarchyLoader{load(e){let t=e.url;return("gltf"==e.ext||"fbx"==e.ext||"glb"==e.ext)&&(t=AssetDb.inst.getSubAssetURL(t,e.uuid,"0","lh")),e.loader.fetch(t,"json",e.progress.createCallback(.2),e.options).then((t=>t?null!=t._$ver?this._load(HierarchyLoader.v3,e,t,3):"ls"==e.ext||"lh"==e.ext?this._load(HierarchyLoader.v2,e,t,2):"scene"==e.ext||"prefab"==e.ext?this._load(HierarchyLoader.legacySceneOrPrefab,e,t,2):null:null))}_load(e,t,r,a){let i=URL.getPath(t.url),s=e.collectResourceLinks(r,i);return t.loader.load(s,{initiator:t},t.progress.createCallback()).then((t=>{let i=new PrefabImpl(e,r,a);return i.addDeps(t),i}))}}HierarchyLoader.v3=HierarchyParser,HierarchyLoader.v2=null,HierarchyLoader.legacySceneOrPrefab=LegacyUIParser,Loader.registerLoader(["lh","ls","scene","prefab"],HierarchyLoader,Loader.HIERARCHY);class HDRTextureInfo{static _parseHDRTexture(e,t=null,r=null){let a=HDRTextureInfo.getHDRInfo(e),i=new Texture2D(a.width,a.height,a.format,!1,!1,!1);return i.setHDRData(a),t&&(null!=t.wrapModeU&&(i.wrapModeU=t.wrapModeU),null!=t.wrapModeV&&(i.wrapModeV=t.wrapModeV),null!=t.filterMode&&(i.filterMode=t.filterMode),null!=t.anisoLevel&&(i.anisoLevel=t.anisoLevel)),i}static getHDRInfo(t){let r=new Uint8Array(t),a=0;const readLine=()=>{let e=HDRTextureInfo.getLineString(r,a);return a+=e.length+1,e};if("#?RADIANCE"!=readLine())throw"HDR image: identifier wrong.";let i=new Map,s="";do{if(s=readLine(),"#"!=s[0]){let e=s.split("=");i.set(e[0],e[1])}}while(""!=s);if("32-bit_rle_rgbe"!=i.get("FORMAT"))throw"HDR image: unsupported format.";let n=readLine().split(" "),o="-Y"==n[0],l="-X"==n[2],h=parseInt(n[1]),u=parseInt(n[3]);return new HDRTextureInfo(t,a,l,o,u,h,e.TextureFormat.R32G32B32A32)}static getLineString(e,t){let r=e.length,a=t,i="",s="";for(;a<r&&"\n"!=s;)i=`${i}${s}`,s=String.fromCharCode(e[a]),a++;return i}constructor(e,t,r,a,i,s,n){this.source=e,this.byteOffset=t,this.decreaseX=r,this.decreaseY=a,this.width=i,this.height=s,this.format=n}get_32_bit_rle_rgbe(){let e=this.width,t=this.height;this.decreaseX,this.decreaseY;let r=new Uint8Array(this.source,this.byteOffset),a=0,i=new ArrayBuffer(4*e),s=new Uint8Array(i),n=new ArrayBuffer(e*t*4*3),o=new Float32Array(n);for(let i=t;i>0;i--){r[a++],r[a++];let n=r[a++]<<8|r[a++];if(n!=e)throw"HDR info: scanlineLength wrong.";let l=0;for(let e=0;e<4;e++){let t=(e+1)*n;for(;l<t;){let e=r[a++],i=r[a++];if(e>128){let r=e-128;if(r>t-l)throw"HDR info: ??";for(;r-- >0;)s[l++]=i}else{let n=e;if(0==n||n>t-l)throw"HDR info: ??";if(s[l++]=i,--n>0)for(let e=0;e<n;e++)s[l++]=r[a++]}}}for(let e=0;e<n;e++){let r=s[e],a=s[e+n],l=s[e+2*n],h=s[e+3*n],u=(t-i)*n*3+3*e;const Ldexp=(e,t)=>t>1023?e*Math.pow(2,1023)*Math.pow(2,t-1023):t<-1074?e*Math.pow(2,-1074)*Math.pow(2,t+1074):e*Math.pow(2,t);if(h>0){let e=Ldexp(1,h-136);o[u]=r*e,o[u+1]=a*e,o[u+2]=l*e}else o[u]=0,o[u+1]=0,o[u+2]=0}}return o}readScanLine(){let t=this.width,r=this.height,a=this.decreaseX,i=this.decreaseY,s=3;this.format==e.TextureFormat.R32G32B32A32&&(s=4);let n=new Float32Array(t*r*s),o=new Uint8Array(4*t),l=new Uint8Array(this.source,this.byteOffset),h=l.length,u=0;const getc=()=>{if(u>=h)throw"HDR info: data wrong.";return l[u++]},wrong=()=>{throw"HDR info: data wrong."};for(let e=r-1;e>=0;e--){this.readcolors(o,getc,wrong);for(let l=0;l<t;l++){let h=4*l,u=o[h],d=o[h+1],_=o[h+2],c=o[h+3],p=e,m=l;i&&(p=r-1-e),a&&(m=t-1-l);let f=p*t*s+m*s;if(0==c)n[f]=0,n[f+1]=0,n[f+2]=0,4==s&&(n[f+3]=1);else{let e=ldexp(1,c-136);n[f]=(u+.5)*e,n[f+1]=(d+.5)*e,n[f+2]=(_+.5)*e,4==s&&(n[f+3]=1)}}}return n}readcolors(e,t,r){const setScanLineData=(t,r,a)=>{e[4*t+r]=a};let a=this.width,i=t(),s=t(),n=t(),o=t();if(a<8||a>32767)this.olddreadcolors(e,t,i,s,n,o);else if(2!=i||2!=s||128&n)this.olddreadcolors(e,t,i,s,n,o);else{(n<<8|o)!=a&&r();for(let e=0;e<4;e++)for(let i=0;i<a;){let s=t();if(s>128){s&=127;let n=t();for(i+s>a&&r();s--;)setScanLineData(i++,e,n)}else for(i+s>a&&r();s--;){setScanLineData(i++,e,t())}}}}olddreadcolors(e,t,r,a,i,s){let n=0,o=this.width;e[0]=r,e[1]=a,e[2]=i,e[3]=s;for(let r=1;r<o;r++){let a=t(),i=t(),s=t(),o=t(),l=4*r;if(e[l]=a,e[l+1]=i,e[l+2]=s,e[l+3]=o,1==a&&1==i&&1==s){let t=l-4;for(let r=o<<n;r>0;r--)e[l]=e[t],e[l+1]=e[t+1],e[l+2]=e[t+2],e[l+3]=e[t+3];n+=8}else n=0}}color_color(e,t){let r=0;0==t.w?e.x=e.y=e.z=0:(r=ldexp(1,t.w-136),e.x=t.x*r,e.y=t.y*r,e.z=t.z*r)}}function ldexp(e,t){return e*Math.pow(2,t)}var gt;HDRTextureInfo.HDRTEXTURE="HDRTEXTURE";const Tt={premultiplyAlpha:!0},St=[null,null,e.TextureFormat.R8G8B8A8,!1,!1,!0];const xt=["ktx","pvr","dds","hdr","lanit.ls"],yt=["mp4","webm"];Loader.registerLoader(["tga","tif","tiff","png","jpg","jpeg","rendertexture",...yt,...xt],class{wrapTex2D(e,t){if(!t)return null;let r=e.obsoluteInst;return r?(r.setTo(t),r.obsolute=!1,r._sizeGrid=t._sizeGrid,r._stateNum=t._stateNum,r.event("reload"),r._clipCache&&r._clipCache.forEach((e=>{e.event("reload"),e._sizeGrid=r._sizeGrid,e._stateNum=r._stateNum}))):(r=new Texture(t),r._sizeGrid=t._sizeGrid,r._stateNum=t._stateNum),r}load(e){let t=e.loader.getRes(e.url,Loader.TEXTURE2D);if(!t||t.obsolute){let t={url:e.url,type:Loader.TEXTURE2D};return e.options.propertyParams?null==e.options.propertyParams.premultiplyAlpha&&(t.propertyParams=Object.assign({},Tt,e.options.propertyParams)):t.propertyParams=Tt,e.options.constructParams?null==e.options.constructParams[5]&&(t.constructParams=Object.assign([],St,e.options.constructParams)):t.constructParams=St,e.loader.load(t,e.options,e.progress.createCallback()).then((t=>this.wrapTex2D(e,t)))}return Promise.resolve(this.wrapTex2D(e,t))}},Loader.IMAGE),Loader.registerLoader([],class{constructor(){gt||(gt={"WhiteTexture.png":Texture2D.whiteTexture,"BlackTexture.png":Texture2D.blackTexture,"GrayTexture.png":Texture2D.grayTexture,"NormalTexture.png":Texture2D.normalTexture})}load(e){if(-1!=e.url.indexOf("internal/")){let t=gt[Utils.getBaseName(e.url)];if(t)return Promise.resolve(t)}let t;return e.url.startsWith("data:")||(t=AssetDb.inst.metaMap[e.url],t||!LayaEnv.isPreview)?this.load2(e,t):AssetDb.inst.getMeta(e.url,e.uuid).then((t=>this.load2(e,t)))}load2(t,r){var a,i,s;let n,o,l=t.ext,h=t.url;if(r){let e=Browser.platform,u=(null===(a=r.platforms)||void 0===a?void 0:a[e])||0,d=(null===(i=r.files)||void 0===i?void 0:i[u])||{};d.file&&(h=AssetDb.inst.getSubAssetURL(h,t.uuid,d.file,d.ext),l=d.ext),n=[0,0,null!==(s=d.format)&&void 0!==s?s:1,r.mipmap,r.readWrite,r.sRGB],o={wrapModeU:r.wrapMode,wrapModeV:r.wrapMode,filterMode:r.filterMode,anisoLevel:r.anisoLevel,premultiplyAlpha:!!r.pma,hdrEncodeFormat:r.hdrEncodeFormat}}else n=t.options.constructParams,o=t.options.propertyParams;let u=-1!=xt.indexOf(l)?l:null;if(null!=u)return t.loader.fetch(h,"arraybuffer",t.progress.createCallback(),t.options).then((a=>{if(!a)return null;let i;switch(u){case"dds":i=Texture2D._parseDDS(a,o,n);break;case"ktx":let t=KTXTextureInfo.getKTXTextureInfo(a);if(t.dimension==e.TextureDimension.Cube){let e=ClassUtils.getClass("TextureCube");if(!e)return null;{let r=new e(t.width,t.format,t.mipmapCount>1,t.sRGB);r.setKTXData(t),i=r}}else t.dimension==e.TextureDimension.Tex2D&&(i=Texture2D._parseKTX(a,o,n));break;case"pvr":i=Texture2D._parsePVR(a,o,n);break;case"hdr":i=HDRTextureInfo._parseHDRTexture(a,o,n);break;case"lanit.ls":i=Texture2D._SimpleAnimatorTextureParse(a,o,n)}let s=t.obsoluteInst;return s&&Object.getPrototypeOf(s)==Object.getPrototypeOf(i)&&(i=this.move(s,i)),o&&o.hdrEncodeFormat&&(i.hdrEncodeFormat=o.hdrEncodeFormat),r&&(i._sizeGrid=r.sizeGrid,i._stateNum=r.stateNum),i}));{let e=t.options,a=o&&o.premultiplyAlpha?"premultiply":"none";return e.useWorkerLoader&&"none"===a&&(e=Object.assign({workerLoaderOptions:{premultiplyAlpha:a}},e)),t.loader.fetch(h,"image",t.progress.createCallback(),e).then((t=>LayaGL.textureContext.needBitmap?t instanceof ImageBitmap?t:createImageBitmap(t,e.workerLoaderOptions||{premultiplyAlpha:a}):t)).then((e=>{if(!e)return null;let a=Texture2D._parseImage(e,o,n),i=t.obsoluteInst;return i&&Object.getPrototypeOf(i)==Object.getPrototypeOf(a)&&(a=this.move(i,a)),r&&(a._sizeGrid=r.sizeGrid,a._stateNum=r.stateNum),a}))}}move(e,t){return e._texture=t._texture,e.width=t.width,e.height=t.height,e.obsolute=!1,delete Resource._idResourcesMap[t.id],e}},Loader.TEXTURE2D),Loader.registerLoader(["rendertexture"],class{load(e){return e.loader.fetch(e.url,"json",e.progress.createCallback(),e.options).then((t=>{if(!t)return null;let r=e.obsoluteInst;return r?r.recreate(t.width,t.height,t.colorFormat,t.depthFormat,t.generateMipmap,t.multiSamples,t.generateDepthTexture,t.sRGB):r=new RenderTexture(t.width,t.height,t.colorFormat,t.depthFormat,t.generateMipmap,t.multiSamples,t.generateDepthTexture,t.sRGB),null!=t.anisoLevel&&(r.anisoLevel=t.anisoLevel),null!=t.filterMode&&(r.filterMode=t.filterMode),null!=t.wrapModeU&&(r.wrapModeU=t.wrapModeU),null!=t.wrapModeV&&(r.wrapModeV=t.wrapModeV),r}))}},Loader.TEXTURE2D),Loader.registerLoader(yt,class{load(e){let t=e.obsoluteInst||new VideoTexture;return t.source=e.url,Promise.resolve(t)}},Loader.TEXTURE2D);Loader.registerLoader(["mc"],class{load(e){return e.loader.fetch(e.url,"arraybuffer",e.progress.createCallback(),e.options).then((e=>e?AnimationClip2D._parse(e):null))}});Loader.registerLoader(["mcc"],class{load(e){return e.loader.fetch(e.url,"json",e.progress.createCallback(.2),e.options).then((t=>{let r=new AnimatorController2D(t);if(r.data&&r.data.controllerLayers){let t=r.data.controllerLayers,a=[];for(let r=t.length-1;r>=0;r--){let i=t[r].states;this.loadStates(i,a,e)}return Promise.all(a).then((()=>r))}return r}))}loadStates(e,t,r){let a=URL.getPath(r.url);for(let i=e.length-1;i>=0;i--){if(e[i].clip&&e[i].clip._$uuid){let s=URL.getResURLByUUID(e[i].clip._$uuid);s.startsWith("res://")||(s=URL.join(a,s)),t.push(r.loader.load(s).then((t=>{e[i].clip=t})))}e[i].states&&this.loadStates(e[i].states,t,r)}}});class NullLoader{load(e){return Promise.resolve(null)}}Loader.registerLoader(["lighting"],NullLoader);Loader.registerLoader(["fnt"],class{load(e){let t=Utils.replaceFileExtension(e.url,"png");return Promise.all([e.loader.fetch(e.url,"xml",e.progress.createCallback(.2),e.options),e.loader.load(t,e.options,e.progress.createCallback(.8))]).then((([e,t])=>{if(!e||!t)return null;let r=new BitmapFont;return r.parseFont(e,t),r}))}},Loader.FONT);const Et="LayaTTFFont";Loader.registerLoader(["ttf","woff","woff2","otf"],class{load(e){let t=Utils.replaceFileExtension(Utils.getBaseName(e.url),"");if(LayaEnv.isConch)return e.loader.fetch(e.url,"arraybuffer").then((e=>(e&&window.conch.registerFont(t,e),{family:t})));if(window.FontFace){let r=new window.FontFace(t,"url('"+URL.postFormatURL(URL.formatURL(e.url))+"')");return document.fonts.add(r),r.load().then((()=>r))}{let r="40px "+t,a=Browser.measureText(Et,r).width,i=Browser.createElement("style");return i.type="text/css",document.body.appendChild(i),i.textContent="@font-face { font-family:'"+t+"'; src:url('"+URL.postFormatURL(URL.formatURL(e.url))+"');}",new Promise((e=>{let checkComplete=()=>{Browser.measureText(Et,r).width!=a&&complete()},complete=()=>{ILaya.systemTimer.clear(this,checkComplete),ILaya.systemTimer.clear(this,complete),e({family:t})};ILaya.systemTimer.once(1e4,this,complete),ILaya.systemTimer.loop(20,this,checkComplete)}))}}},Loader.TTF);class RenderState{constructor(){this.cull=RenderState.CULL_BACK,this.blend=RenderState.BLEND_DISABLE,this.srcBlend=RenderState.BLENDPARAM_ONE,this.dstBlend=RenderState.BLENDPARAM_ZERO,this.srcBlendRGB=RenderState.BLENDPARAM_ONE,this.dstBlendRGB=RenderState.BLENDPARAM_ZERO,this.srcBlendAlpha=RenderState.BLENDPARAM_ONE,this.dstBlendAlpha=RenderState.BLENDPARAM_ZERO,this.blendEquation=RenderState.BLENDEQUATION_ADD,this.blendEquationRGB=RenderState.BLENDEQUATION_ADD,this.blendEquationAlpha=RenderState.BLENDEQUATION_ADD,this.depthTest=RenderState.DEPTHTEST_LEQUAL,this.depthWrite=!0,this.stencilRef=1,this.stencilTest=RenderState.STENCILTEST_OFF,this.stencilWrite=!1,this.stencilOp=new Vector3(RenderState.STENCILOP_KEEP,RenderState.STENCILOP_KEEP,RenderState.STENCILOP_REPLACE)}setNull(){this.cull=null,this.blend=null,this.srcBlend=null,this.dstBlend=null,this.srcBlendRGB=null,this.dstBlendRGB=null,this.srcBlendAlpha=null,this.dstBlendAlpha=null,this.blendEquation=null,this.blendEquationRGB=null,this.blendEquationAlpha=null,this.depthTest=null,this.depthWrite=null,this.stencilRef=null,this.stencilTest=null,this.stencilWrite=null,this.stencilOp.set(null,null,null)}cloneTo(e){e.cull=this.cull,e.blend=this.blend,e.srcBlend=this.srcBlend,e.dstBlend=this.dstBlend,e.srcBlendRGB=this.srcBlendRGB,e.dstBlendRGB=this.dstBlendRGB,e.srcBlendAlpha=this.srcBlendAlpha,e.dstBlendAlpha=this.dstBlendAlpha,e.blendEquation=this.blendEquation,e.blendEquationRGB=this.blendEquationRGB,e.blendEquationAlpha=this.blendEquationAlpha,e.depthTest=this.depthTest,e.depthWrite=this.depthWrite,e.stencilRef=this.stencilRef,e.stencilTest=this.stencilTest,e.stencilWrite=this.stencilWrite,this.stencilOp.cloneTo(e.stencilOp)}clone(){var e=new RenderState;return this.cloneTo(e),e}}RenderState.CULL_NONE=e.CullMode.Off,RenderState.CULL_FRONT=e.CullMode.Front,RenderState.CULL_BACK=e.CullMode.Back,RenderState.BLEND_DISABLE=e.BlendType.BLEND_DISABLE,RenderState.BLEND_ENABLE_ALL=e.BlendType.BLEND_ENABLE_ALL,RenderState.BLEND_ENABLE_SEPERATE=e.BlendType.BLEND_ENABLE_SEPERATE,RenderState.BLENDPARAM_ZERO=e.BlendFactor.Zero,RenderState.BLENDPARAM_ONE=e.BlendFactor.One,RenderState.BLENDPARAM_SRC_COLOR=e.BlendFactor.SourceColor,RenderState.BLENDPARAM_ONE_MINUS_SRC_COLOR=e.BlendFactor.OneMinusSourceColor,RenderState.BLENDPARAM_DST_COLOR=e.BlendFactor.DestinationColor,RenderState.BLENDPARAM_ONE_MINUS_DST_COLOR=e.BlendFactor.OneMinusDestinationColor,RenderState.BLENDPARAM_SRC_ALPHA=e.BlendFactor.SourceAlpha,RenderState.BLENDPARAM_ONE_MINUS_SRC_ALPHA=e.BlendFactor.OneMinusSourceAlpha,RenderState.BLENDPARAM_DST_ALPHA=e.BlendFactor.DestinationAlpha,RenderState.BLENDPARAM_ONE_MINUS_DST_ALPHA=e.BlendFactor.OneMinusDestinationAlpha,RenderState.BLENDPARAM_SRC_ALPHA_SATURATE=e.BlendFactor.SourceAlphaSaturate,RenderState.BLENDPARAM_BLENDCOLOR=e.BlendFactor.BlendColor,RenderState.BLENDPARAM_BLEND_ONEMINUS_COLOR=e.BlendFactor.OneMinusBlendColor,RenderState.BLENDEQUATION_ADD=e.BlendEquationSeparate.ADD,RenderState.BLENDEQUATION_SUBTRACT=e.BlendEquationSeparate.SUBTRACT,RenderState.BLENDEQUATION_REVERSE_SUBTRACT=e.BlendEquationSeparate.REVERSE_SUBTRACT,RenderState.BLENDEQUATION_MIN=e.BlendEquationSeparate.MIN,RenderState.BLENDEQUATION_MAX=e.BlendEquationSeparate.MAX,RenderState.DEPTHTEST_OFF=e.CompareFunction.Off,RenderState.DEPTHTEST_NEVER=e.CompareFunction.Never,RenderState.DEPTHTEST_LESS=e.CompareFunction.Less,RenderState.DEPTHTEST_EQUAL=e.CompareFunction.Equal,RenderState.DEPTHTEST_LEQUAL=e.CompareFunction.LessEqual,RenderState.DEPTHTEST_GREATER=e.CompareFunction.Greater,RenderState.DEPTHTEST_NOTEQUAL=e.CompareFunction.NotEqual,RenderState.DEPTHTEST_GEQUAL=e.CompareFunction.GreaterEqual,RenderState.DEPTHTEST_ALWAYS=e.CompareFunction.Always,RenderState.STENCILTEST_OFF=e.CompareFunction.Off,RenderState.STENCILTEST_NEVER=e.CompareFunction.Never,RenderState.STENCILTEST_LESS=e.CompareFunction.Less,RenderState.STENCILTEST_EQUAL=e.CompareFunction.Equal,RenderState.STENCILTEST_LEQUAL=e.CompareFunction.LessEqual,RenderState.STENCILTEST_GREATER=e.CompareFunction.Greater,RenderState.STENCILTEST_NOTEQUAL=e.CompareFunction.NotEqual,RenderState.STENCILTEST_GEQUAL=e.CompareFunction.GreaterEqual,RenderState.STENCILTEST_ALWAYS=e.CompareFunction.Always,RenderState.STENCILOP_KEEP=e.StencilOperation.Keep,RenderState.STENCILOP_ZERO=e.StencilOperation.Zero,RenderState.STENCILOP_REPLACE=e.StencilOperation.Replace,RenderState.STENCILOP_INCR=e.StencilOperation.IncrementSaturate,RenderState.STENCILOP_INCR_WRAP=e.StencilOperation.IncrementWrap,RenderState.STENCILOP_DECR=e.StencilOperation.DecrementSaturate,RenderState.STENCILOP_DECR_WRAP=e.StencilOperation.DecrementWrap,RenderState.STENCILOP_INVERT=e.StencilOperation.Invert,RenderState.Default=new RenderState;class UniformBufferBase{constructor(e,t,r){this._mapArray=[],this._blockName=e,this._singgle=r,this._glPointerID=t}add(e){-1==this._mapArray.indexOf(e)&&this._mapArray.push(e)}splitBuffer(e){let t=this._mapArray.indexOf(e);-1!=t&&this._mapArray.splice(t,1)}}class UniformBufferObject extends Buffer{static create(e,t,r,a=!1){UniformBufferObject._Map.get(e)||UniformBufferObject._Map.set(e,new UniformBufferBase(e,LayaGL.renderEngine.getUBOPointer(e),a));let i=UniformBufferObject._Map.get(e);if(i._singgle&&i._mapArray.length>0)return null;{let s=LayaGL.renderOBJCreate.createUniformBufferObject(i._glPointerID,e,t,r,a);return i._singgle&&i.add(s),s}}static getBuffer(e,t){let r=UniformBufferObject._Map.get(e);return r?r._mapArray[t]:null}constructor(t,r,a,i,s){super(e.BufferTargetType.UNIFORM_BUFFER,a),this._isSingle=!1,this._glPointer=t,this.byteLength=i,this._name=r,this._isSingle=s,this.bind(),this._isSingle&&this._bindUniformBufferBase(),this._glBuffer.setDataLength(this.byteLength)}_bindUniformBufferBase(){this._glBuffer.bindBufferBase(this._glPointer)}_bindBufferRange(e,t){this.bind(),this._glBuffer.bindBufferRange(this._glPointer,e,t)}_reset(e){this._glBuffer&&(this._glBuffer.destroy(),this._glBuffer=null),this._byteLength=this.byteLength=e,this._glBuffer=LayaGL.renderEngine.createBuffer(this._bufferType,this._bufferUsage),this._isSingle&&this._bindUniformBufferBase(),this._glBuffer.setDataLength(this.byteLength)}bind(){return this._glBuffer.bindBuffer()}setData(e,t=0,r=Number.MAX_SAFE_INTEGER){if(!(r<0))if(this.bind(),!(0==t&&r==this.byteLength)){var a=new Uint8Array(e.buffer,t,r);this._glBuffer.setData(a,t)}else this._glBuffer.setDataEx(e,t,e.length)}setDataByUniformBufferData(e){this._updateDataInfo==e?(this.setData(e._buffer,4*e._updateFlag.x,4*(e._updateFlag.y-e._updateFlag.x)),e._resetUpdateFlag()):(this.setData(e._buffer,0,this.byteLength),e._resetUpdateFlag(),this._updateDataInfo=e)}setDataByByUniformBufferDataOffset(e,t){let r=e.getbyteLength(),a=e._realByte;e._resetUpdateFlag(),this.bind(),this._glBuffer.setDataEx(e._buffer,t*r,a/4)}destroy(){super.destroy()}}var Rt,bt;UniformBufferObject.UBONAME_SCENE="SceneUniformBlock",UniformBufferObject.UBONAME_CAMERA="CameraUniformBlock",UniformBufferObject.UBONAME_SPRITE3D="SpriteUniformBlock",UniformBufferObject.UBONAME_SHADOW="ShadowUniformBlock",UniformBufferObject.commonMap=["CameraUniformBlock","SceneUniformBlock","SpriteUniformBlock","ShadowUniformBlock"],UniformBufferObject._Map=new Map,e.MaterialRenderMode=void 0,(Rt=e.MaterialRenderMode||(e.MaterialRenderMode={}))[Rt.RENDERMODE_OPAQUE=0]="RENDERMODE_OPAQUE",Rt[Rt.RENDERMODE_CUTOUT=1]="RENDERMODE_CUTOUT",Rt[Rt.RENDERMODE_TRANSPARENT=2]="RENDERMODE_TRANSPARENT",Rt[Rt.RENDERMODE_ADDTIVE=3]="RENDERMODE_ADDTIVE",Rt[Rt.RENDERMODE_ALPHABLENDED=4]="RENDERMODE_ALPHABLENDED",Rt[Rt.RENDERMODE_CUSTOME=5]="RENDERMODE_CUSTOME";class Material extends Resource{static load(e,t){ILaya.loader.load(e,t,null,Loader.MATERIAL)}static __initDefine__(){Material.SHADERDEFINE_ALPHATEST=Shader3D.getDefineByName("ALPHATEST"),Material.SHADERDEFINE_MAINTEXTURE=Shader3D.getDefineByName("MAINTEXTURE"),Material.SHADERDEFINE_ADDTIVEFOG=Shader3D.getDefineByName("ADDTIVEFOG"),Material.ALPHATESTVALUE=Shader3D.propertyNameToID("u_AlphaTestValue"),Shader3D.CULL=Shader3D.propertyNameToID("s_Cull"),Shader3D.BLEND=Shader3D.propertyNameToID("s_Blend"),Shader3D.BLEND_SRC=Shader3D.propertyNameToID("s_BlendSrc"),Shader3D.BLEND_DST=Shader3D.propertyNameToID("s_BlendDst"),Shader3D.BLEND_SRC_RGB=Shader3D.propertyNameToID("s_BlendSrcRGB"),Shader3D.BLEND_DST_RGB=Shader3D.propertyNameToID("s_BlendDstRGB"),Shader3D.BLEND_SRC_ALPHA=Shader3D.propertyNameToID("s_BlendSrcAlpha"),Shader3D.BLEND_DST_ALPHA=Shader3D.propertyNameToID("s_BlendDstAlpha"),Shader3D.BLEND_EQUATION=Shader3D.propertyNameToID("s_BlendEquation"),Shader3D.BLEND_EQUATION_RGB=Shader3D.propertyNameToID("s_BlendEquationRGB"),Shader3D.BLEND_EQUATION_ALPHA=Shader3D.propertyNameToID("s_BlendEquationAlpha"),Shader3D.DEPTH_TEST=Shader3D.propertyNameToID("s_DepthTest"),Shader3D.DEPTH_WRITE=Shader3D.propertyNameToID("s_DepthWrite"),Shader3D.STENCIL_Ref=Shader3D.propertyNameToID("s_StencilRef"),Shader3D.STENCIL_TEST=Shader3D.propertyNameToID("s_StencilTest"),Shader3D.STENCIL_WRITE=Shader3D.propertyNameToID("s_StencilWrite"),Shader3D.STENCIL_Op=Shader3D.propertyNameToID("s_StencilOp")}get shaderData(){return this._shaderValues}get alphaTestValue(){return this._shaderValues.getNumber(Material.ALPHATESTVALUE)}set alphaTestValue(e){this._shaderValues.setNumber(Material.ALPHATESTVALUE,e)}get alphaTest(){return this.shaderData.hasDefine(Material.SHADERDEFINE_ALPHATEST)}set alphaTest(e){e?this._shaderValues.addDefine(Material.SHADERDEFINE_ALPHATEST):this._shaderValues.removeDefine(Material.SHADERDEFINE_ALPHATEST)}addDefine(e){this._shaderValues.addDefine(e)}removeDefine(e){this._shaderValues.removeDefine(e)}setDefine(e,t){t?this._shaderValues.addDefine(e):this._shaderValues.removeDefine(e)}hasDefine(e){return this._shaderValues.hasDefine(e)}get depthWrite(){return this._shaderValues.getBool(Shader3D.DEPTH_WRITE)}set depthWrite(e){this._shaderValues.setBool(Shader3D.DEPTH_WRITE,e)}get cull(){return this._shaderValues.getInt(Shader3D.CULL)}set cull(e){this._shaderValues.setInt(Shader3D.CULL,e)}get blend(){return this._shaderValues.getInt(Shader3D.BLEND)}set blend(e){this._shaderValues.setInt(Shader3D.BLEND,e)}get blendSrc(){return this._shaderValues.getInt(Shader3D.BLEND_SRC)}set blendSrc(e){this._shaderValues.setInt(Shader3D.BLEND_SRC,e)}get blendDst(){return this._shaderValues.getInt(Shader3D.BLEND_DST)}set blendDst(e){this._shaderValues.setInt(Shader3D.BLEND_DST,e)}get blendSrcAlpha(){return this._shaderValues.getInt(Shader3D.BLEND_SRC_ALPHA)}set blendSrcAlpha(e){this._shaderValues.setInt(Shader3D.BLEND_SRC_ALPHA,e)}get blendSrcRGB(){return this._shaderValues.getInt(Shader3D.BLEND_SRC_RGB)}set blendSrcRGB(e){this._shaderValues.setInt(Shader3D.BLEND_SRC_RGB,e)}get blendDstRGB(){return this._shaderValues.getInt(Shader3D.BLEND_DST_RGB)}set blendDstRGB(e){this._shaderValues.setInt(Shader3D.BLEND_DST_RGB,e)}get blendDstAlpha(){return this._shaderValues.getInt(Shader3D.BLEND_DST_ALPHA)}set blendDstAlpha(e){this._shaderValues.setInt(Shader3D.BLEND_DST_ALPHA,e)}get blendEquation(){return this._shaderValues.getInt(Shader3D.BLEND_EQUATION)}set blendEquation(e){this._shaderValues.setInt(Shader3D.BLEND_EQUATION,e)}get blendEquationRGB(){return this._shaderValues.getInt(Shader3D.BLEND_EQUATION_RGB)}set blendEquationRGB(e){this._shaderValues.setInt(Shader3D.BLEND_EQUATION_RGB,e)}get blendEquationAlpha(){return this._shaderValues.getInt(Shader3D.BLEND_EQUATION_ALPHA)}set blendEquationAlpha(e){this._shaderValues.setInt(Shader3D.BLEND_EQUATION_ALPHA,e)}get depthTest(){return this._shaderValues.getInt(Shader3D.DEPTH_TEST)}set depthTest(e){this._shaderValues.setInt(Shader3D.DEPTH_TEST,e)}get stencilTest(){return this._shaderValues.getInt(Shader3D.STENCIL_TEST)}set stencilTest(e){this._shaderValues.setInt(Shader3D.STENCIL_TEST,e)}get stencilWrite(){return this._shaderValues.getBool(Shader3D.STENCIL_WRITE)}set stencilWrite(e){this._shaderValues.setBool(Shader3D.STENCIL_WRITE,e)}set stencilRef(e){this._shaderValues.setInt(Shader3D.STENCIL_Ref,e)}get stencilRef(){return this._shaderValues.getInt(Shader3D.STENCIL_Ref)}set stencilOp(e){this._shaderValues.setVector3(Shader3D.STENCIL_Op,e)}get stencilOp(){return this._shaderValues.getVector3(Shader3D.STENCIL_Op)}get MaterialProperty(){let e={};var t=this._shaderValues.getData();for(let r in t)e[LayaGL.renderEngine.propertyIDToName(parseInt(r))]=t[r];return e}get MaterialDefine(){let e=new Array,t=this._shaderValues._defineDatas;return Shader3D._getNamesByDefineData(t,e),e}set materialRenderMode(t){switch(this._matRenderNode=t,t){case e.MaterialRenderMode.RENDERMODE_OPAQUE:this.alphaTest=!1,this.renderQueue=Material.RENDERQUEUE_OPAQUE,this.depthWrite=!0,this.blend=RenderState.BLEND_DISABLE,this.depthTest=RenderState.DEPTHTEST_LESS;break;case e.MaterialRenderMode.RENDERMODE_CUTOUT:this.renderQueue=Material.RENDERQUEUE_ALPHATEST,this.alphaTest=!0,this.depthWrite=!0,this.blend=RenderState.BLEND_DISABLE,this.depthTest=RenderState.DEPTHTEST_LESS;break;case e.MaterialRenderMode.RENDERMODE_TRANSPARENT:this.renderQueue=Material.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.blend=RenderState.BLEND_ENABLE_ALL,this.blendSrc=RenderState.BLENDPARAM_SRC_ALPHA,this.blendDst=RenderState.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=RenderState.DEPTHTEST_LESS;break;case e.MaterialRenderMode.RENDERMODE_ADDTIVE:this.renderQueue=Material.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.blend=RenderState.BLEND_ENABLE_ALL,this.blendSrc=RenderState.BLENDPARAM_SRC_ALPHA,this.blendDst=RenderState.BLENDPARAM_ONE,this.depthTest=RenderState.DEPTHTEST_LESS,this._shaderValues.addDefine(Material.SHADERDEFINE_ADDTIVEFOG);break;case e.MaterialRenderMode.RENDERMODE_ALPHABLENDED:this.renderQueue=Material.RENDERQUEUE_TRANSPARENT,this.alphaTest=!1,this.depthWrite=!1,this.blend=RenderState.BLEND_ENABLE_ALL,this.blendSrc=RenderState.BLENDPARAM_SRC_ALPHA,this.blendDst=RenderState.BLENDPARAM_ONE_MINUS_SRC_ALPHA,this.depthTest=RenderState.DEPTHTEST_LESS,this._shaderValues.removeDefine(Material.SHADERDEFINE_ADDTIVEFOG);break;case e.MaterialRenderMode.RENDERMODE_CUSTOME:break;default:console.warn(`Material : renderMode value error - (${t}).`)}}get materialRenderMode(){return this._matRenderNode}constructor(){super(),this._shaderValues=LayaGL.renderOBJCreate.createShaderData(this),this.renderQueue=Material.RENDERQUEUE_OPAQUE,this._matRenderNode=0,this.alphaTest=!1,this.cull=RenderState.CULL_BACK,this.blend=RenderState.BLEND_DISABLE,this.blendSrc=RenderState.BLENDPARAM_ONE,this.blendDst=RenderState.BLENDPARAM_ZERO,this.blendSrcRGB=RenderState.BLENDPARAM_ONE,this.blendDstRGB=RenderState.BLENDPARAM_ZERO,this.blendSrcAlpha=RenderState.BLENDPARAM_ONE,this.blendDstAlpha=RenderState.BLENDPARAM_ZERO,this.blendEquation=RenderState.BLENDEQUATION_ADD,this.blendEquationRGB=RenderState.BLENDEQUATION_ADD,this.blendEquationAlpha=RenderState.BLENDEQUATION_ADD,this.depthTest=RenderState.DEPTHTEST_LEQUAL,this.depthWrite=!0,this.stencilRef=1,this.stencilTest=RenderState.STENCILTEST_OFF,this.stencilWrite=!1,this.stencilOp=new Vector3(RenderState.STENCILOP_KEEP,RenderState.STENCILOP_KEEP,RenderState.STENCILOP_REPLACE),this.destroyedImmediately=Config.destroyResourceImmediatelyDefault}_bindShaderInfo(t){let r=t.getSubShaderAt(0)._uniformBufferDataMap;if(r)for(let t of r.keys()){let a=r.get(t).clone(),i=UniformBufferObject.create(t,e.BufferUsage.Dynamic,a.getbyteLength(),!1);this._shaderValues.setUniformBuffer(Shader3D.propertyNameToID(t),i),this._shaderValues._addCheckUBO(t,i,a)}}_releaseUBOData(){if(this._shaderValues.uniformBufferDatas){for(let e of this._shaderValues.uniformBufferDatas.values())e.ubo._updateDataInfo.destroy(),e.ubo.destroy(),e.ubo._updateDataInfo=null;this._shaderValues.uniformBufferDatas.clear(),this._shaderValues.uniformBuffersMap.clear()}}_disposeResource(){this._releaseUBOData(),this._shaderValues.destroy(),this._shaderValues=null}get shader(){return this._shader}effectiveProperty(){return this._shader.getSubShaderAt(0)._uniformTypeMap}setShaderName(e){this._shader=Shader3D.find(e),this._shader||(console.warn(`Material: unknown shader name '${e}'`),this._shader=Shader3D.find("BLINNPHONG")),Config3D._uniformBlock&&(this._releaseUBOData(),this._bindShaderInfo(this._shader));let t=this._shader.getSubShaderAt(0),r=t._uniformDefaultValue,a=t._uniformTypeMap;this.applyUniformDefaultValue(a,r)}applyUniformDefaultValue(e,t){e.forEach(((e,r)=>{if(t&&null!=t[r]){let a=t[r];this.setShaderData(r,e,a)}else this.setShaderData(r,e,ShaderDataDefaultValue(e))}))}getBoolByIndex(e){return this.shaderData.getBool(e)}setBoolByIndex(e,t){this.shaderData.setBool(e,t)}getBool(e){let t=Shader3D.propertyNameToID(e);return this.getBoolByIndex(t)}setBool(e,t){let r=Shader3D.propertyNameToID(e);this.setBoolByIndex(r,t)}getFloatByIndex(e){return this.shaderData.getNumber(e)}setFloatByIndex(e,t){this.shaderData.setNumber(e,t)}getFloat(e){let t=Shader3D.propertyNameToID(e);return this.getFloatByIndex(t)}setFloat(e,t){let r=Shader3D.propertyNameToID(e);this.setFloatByIndex(r,t)}getIntByIndex(e){return this.shaderData.getInt(e)}setIntByIndex(e,t){this.shaderData.setInt(e,t)}getInt(e){let t=Shader3D.propertyNameToID(e);return this.getIntByIndex(t)}setInt(e,t){let r=Shader3D.propertyNameToID(e);this.setIntByIndex(r,t)}getVector2ByIndex(e){return this.shaderData.getVector2(e)}setVector2ByIndex(e,t){this.shaderData.setVector2(e,t)}getVector2(e){let t=Shader3D.propertyNameToID(e);return this.getVector2ByIndex(t)}setVector2(e,t){let r=Shader3D.propertyNameToID(e);this.setVector2ByIndex(r,t)}getVector3ByIndex(e){return this.shaderData.getVector3(e)}setVector3ByIndex(e,t){this.shaderData.setVector3(e,t)}getVector3(e){let t=Shader3D.propertyNameToID(e);return this.getVector3ByIndex(t)}setVector3(e,t){let r=Shader3D.propertyNameToID(e);this.setVector3ByIndex(r,t)}setVector4ByIndex(e,t){this.shaderData.setVector(e,t)}getVector4ByIndex(e){return this.shaderData.getVector(e)}setVector4(e,t){let r=Shader3D.propertyNameToID(e);this.setVector4ByIndex(r,t)}getVector4(e){let t=Shader3D.propertyNameToID(e);return this.getVector4ByIndex(t)}getColorByIndex(e){return this.shaderData.getColor(e)}setColorByIndex(e,t){this.shaderData.setColor(e,t)}getColor(e){let t=Shader3D.propertyNameToID(e);return this.shaderData.getColor(t)}setColor(e,t){let r=Shader3D.propertyNameToID(e);this.setColorByIndex(r,t)}getMatrix4x4ByIndex(e){return this.shaderData.getMatrix4x4(e)}setMatrix4x4ByIndex(e,t){this.shaderData.setMatrix4x4(e,t)}getMatrix4x4(e){let t=Shader3D.propertyNameToID(e);return this.getMatrix4x4ByIndex(t)}setMatrix4x4(e,t){let r=Shader3D.propertyNameToID(e);this.setMatrix4x4ByIndex(r,t)}getMatrix3x3ByIndex(e){return this.shaderData.getMatrix3x3(e)}setMatrix3x3ByIndex(e,t){this.shaderData.setMatrix3x3(e,t)}getMatrix3x3(e){let t=Shader3D.propertyNameToID(e);return this.getMatrix3x3ByIndex(t)}setMatrix3x3(e,t){let r=Shader3D.propertyNameToID(e);this.setMatrix3x3ByIndex(r,t)}setTextureByIndex(e,t){this.shaderData.setTexture(e,t),t&&!t._texture&&t.once(Event.READY,this,this.reSetTexture)}reSetTexture(e){let t=this.shaderData.getSourceIndex(e);-1!=t&&this.setTextureByIndex(t,e)}getTextureByIndex(e){return this.shaderData.getTexture(e)}setTexture(e,t){let r=Shader3D.propertyNameToID(e);this.setTextureByIndex(r,t)}getTexture(e){let t=Shader3D.propertyNameToID(e);return this.getTextureByIndex(t)}getBufferByIndex(e){return this.shaderData.getBuffer(e)}setBufferByIndex(e,t){this.shaderData.setBuffer(e,t)}getBuffer(e){let t=Shader3D.propertyNameToID(e);return this.getBufferByIndex(t)}setBuffer(e,t){let r=Shader3D.propertyNameToID(e);this.setBufferByIndex(r,t)}setShaderDataByIndex(e,t,r){this.shaderData.setShaderData(e,t,r)}setShaderData(e,t,r){let a=Shader3D.propertyNameToID(e);this.setShaderDataByIndex(a,t,r)}getShaderData(e,t){let r=Shader3D.propertyNameToID(e);return this.getShaderDataByIndex(r,t)}getShaderDataByIndex(e,t){return this._shaderValues.getShaderData(e,t)}cloneTo(e){var t=e;t.name=this.name,t.renderQueue=this.renderQueue,t.setShaderName(this._shader._name),this._shaderValues.cloneTo(t._shaderValues)}clone(){var e=new Material;return this.cloneTo(e),e}setShaderPropertyValue(e,t){let r=Shader3D.propertyNameToID(e);this.shaderData.setValueData(r,t)}getShaderPropertyValue(e){return this.shaderData.getValueData(Shader3D.propertyNameToID(e))}get _defineDatas(){return this._shaderValues._defineDatas}oldparseEndEvent(){}}Material.RENDERQUEUE_OPAQUE=2e3,Material.RENDERQUEUE_ALPHATEST=2450,Material.RENDERQUEUE_TRANSPARENT=3e3;class MaterialParser{static parse(e){let t=e.props;switch(e.version){case"LAYAMATERIAL:01":case"LAYAMATERIAL:02":case"LAYAMATERIAL:03":let t=MaterialParser.parseLegacy(e);return t.oldparseEndEvent(),t;case"LAYAMATERIAL:04":break;default:throw new Error(`unkonwn material version: ${e.version}`)}let r,a=new Material;a.setShaderName(t.type);for(let e in t)switch(e){case"type":case"name":break;case"defines":let s=t[e];for(let e=0,t=s.length;e<t;e++){let t=Shader3D.getDefineByName(s[e]);a._shaderValues.addDefine(t)}break;case"textures":let n=t[e];for(let e=0,t=n.length;e<t;e++){let t=n[e],r=t.path;r&&a._shaderValues.setTexture(Shader3D.propertyNameToID(t.name),Loader.getBaseTexture(r))}break;case"renderQueue":r=t[e];break;case"alphaTest":a.alphaTest=t[e];break;case"materialRenderMode":a.materialRenderMode=t[e];break;default:let o=t[e],l=Shader3D.propertyNameToID(e);switch(l){case Shader3D.CULL:a.cull=o;break;case Shader3D.BLEND:a.blend=o;break;case Shader3D.BLEND_SRC:a.blendSrc=o;break;case Shader3D.BLEND_DST:a.blendDst=o;break;case Shader3D.BLEND_DST_ALPHA:a.blendDstAlpha=o;break;case Shader3D.BLEND_SRC_ALPHA:a.blendSrcAlpha=o;break;case Shader3D.BLEND_SRC_RGB:a.blendSrcRGB=o;break;case Shader3D.BLEND_SRC_RGB:a.blendDstRGB=o;break;case Shader3D.DEPTH_TEST:a.depthTest=o;break;case Shader3D.DEPTH_WRITE:a.depthWrite=!!t[e];break;case Shader3D.STENCIL_TEST:a.stencilTest=o;break;case Shader3D.STENCIL_Op:a.stencilOp=o;break;case Shader3D.STENCIL_Ref:a.stencilRef=o;break;case Shader3D.STENCIL_WRITE:a.stencilWrite=o;break;default:if(o.length){var i=o;switch(i.length){case 2:a._shaderValues.setVector2(l,new Vector2(i[0],i[1]));break;case 3:a._shaderValues.setVector3(l,new Vector3(i[0],i[1],i[2]));break;case 4:a._shaderValues.getColor(l)?a._shaderValues.setColor(l,new Color(i[0],i[1],i[2],i[3])):a._shaderValues.setVector(l,new Vector4(i[0],i[1],i[2],i[3]));break;case 9:let e=new Matrix3x3;e.elements=new Float32Array(i),a._shaderValues.setMatrix3x3(l,e);break;case 16:let t=new Matrix4x4;t.elements=new Float32Array(i),a._shaderValues.setMatrix4x4(l,t);break;default:a._shaderValues.setBuffer(l,i)}}else a._shaderValues.setNumber(l,t[e])}}return null!=r&&(a.renderQueue=r),a}static collectLinks(e,t){var r;let a=[],i=null===(r=e.props)||void 0===r?void 0:r.textures;if(i)for(let e=0,r=i.length;e<r;e++){let r=i[e],s=r.path;s&&(r.path=URL.join(t,s),a.push({url:r.path,type:Loader.TEXTURE2D,constructParams:r.constructParams,propertyParams:r.propertyParams}))}return a}static parseLegacy(e){let t,r=e,a=r.props,i=a.type,s=ClassUtils.getClass(i);switch(!s&&i&&i.startsWith("Laya.")&&(s=ClassUtils.getClass(i.substring(5))),s?t=new s:(t=new Material,t.setShaderName(i)),r.version){case"LAYAMATERIAL:01":case"LAYAMATERIAL:02":for(let e in a)switch(e){case"type":break;case"vectors":let r=a[e];for(let e=0,a=r.length;e<a;e++){let a=r[e],i=a.value;switch(i.length){case 2:t[a.name]=new Vector2(i[0],i[1]);break;case 3:t[a.name]instanceof Color?t[a.name]=new Color(i[0],i[1],i[2],1):t[a.name]=new Vector3(i[0],i[1],i[2]);break;case 4:t[a.name]instanceof Color?t[a.name]=new Color(i[0],i[1],i[2],i[3]):t[a.name]=new Vector4(i[0],i[1],i[2],i[3]);break;default:throw new Error("unkonwn material color length: "+i.length)}}break;case"colors":let i=a[e];for(let e=0,r=i.length;e<r;e++){let r=i[e],a=r.value;t[r.name]=new Color(a[0],a[1],a[2],a[3])}break;case"textures":let s=a[e];for(let e=0,r=s.length;e<r;e++){let r=s[e],a=r.path;a&&(t[r.name]=Loader.getBaseTexture(a))}break;case"defines":let n=a[e];for(let e=0,r=n.length;e<r;e++){let r=Shader3D.getDefineByName(n[e]);t._shaderValues.addDefine(r)}break;case"renderStates":let o=a[e][0];t.blend=o.blend,t.cull=this._getRenderStateParams(o.cull),t.depthTest=this._getRenderStateParams(o.depthTest),t.depthWrite=o.depthWrite,t.blendSrc=this._getRenderStateParams(o.srcBlend),t.blendDst=this._getRenderStateParams(o.dstBlend);break;case"cull":t.cull=this._getRenderStateParams(a[e]);break;case"blend":t.blend=this._getRenderStateParams(a[e]);break;case"depthWrite":t.depthWrite=!!a[e];break;case"srcBlend":case"blendSrc":t.blendSrc=this._getRenderStateParams(a[e]);break;case"dstBlend":case"blendDst":t.blendDst=this._getRenderStateParams(a[e]);break;case"depthTest":t.depthTest=this._getRenderStateParams(a[e]);break;default:t[e]=a[e]}break;case"LAYAMATERIAL:03":for(let e in a)switch(e){case"type":case"name":break;case"defines":let r=a[e];for(let e=0,a=r.length;e<a;e++){let a=Shader3D.getDefineByName(r[e]);t._shaderValues.addDefine(a)}break;case"textures":let i=a[e];for(let e=0,r=i.length;e<r;e++){let r=i[e],a=r.path;a&&t._shaderValues.setTexture(Shader3D.propertyNameToID(r.name),Loader.getBaseTexture(a))}break;case"renderQueue":t.renderQueue=a[e];break;default:let s=a[e],o=Shader3D.propertyNameToID(e);switch(o){case Shader3D.CULL:t.cull=this._getRenderStateParams(s);break;case Shader3D.BLEND:t.blend=this._getRenderStateParams(s);break;case Shader3D.BLEND_SRC:t.blendSrc=this._getRenderStateParams(s);break;case Shader3D.BLEND_DST:t.blendDst=this._getRenderStateParams(s);break;case Shader3D.DEPTH_TEST:t.depthTest=this._getRenderStateParams(s);break;case Shader3D.DEPTH_WRITE:t.depthWrite=!!a[e];break;default:if(s.length){var n=s;switch(n.length){case 2:t._shaderValues.setVector2(o,new Vector2(n[0],n[1]));break;case 3:t._shaderValues.setVector3(o,new Vector3(n[0],n[1],n[2]));break;case 4:t._shaderValues.getColor(o)?t._shaderValues.setColor(o,new Color(n[0],n[1],n[2],n[3])):t._shaderValues.setVector(o,new Vector4(n[0],n[1],n[2],n[3]));break;default:throw new Error("unkonwn material color length: "+n.length)}}else t._shaderValues.setNumber(o,a[e])}}break;default:throw new Error("unkonwn material version: "+r.version)}return t}static _getRenderStateParams(t){switch(t){case 768:return e.BlendFactor.SourceColor;case 769:return e.BlendFactor.OneMinusSourceColor;case 774:return e.BlendFactor.DestinationColor;case 775:return e.BlendFactor.OneMinusDestinationColor;case 770:return e.BlendFactor.SourceAlpha;case 771:return e.BlendFactor.OneMinusSourceAlpha;case 772:return e.BlendFactor.DestinationAlpha;case 773:return e.BlendFactor.OneMinusDestinationAlpha;case 776:return e.BlendFactor.SourceAlphaSaturate;case 32774:return e.BlendEquationSeparate.ADD;case 32778:return e.BlendEquationSeparate.SUBTRACT;case 32779:return e.BlendEquationSeparate.REVERSE_SUBTRACT;case 512:return e.CompareFunction.Never;case 513:return e.CompareFunction.Less;case 514:return e.CompareFunction.Equal;case 515:return e.CompareFunction.LessEqual;case 516:return e.CompareFunction.Greater;case 517:return e.CompareFunction.NotEqual;case 518:return e.CompareFunction.GreaterEqual;case 519:return e.CompareFunction.Always;default:return t}}}Loader.registerLoader(["lmat"],class{load(e){return e.loader.fetch(e.url,"json",e.progress.createCallback(.3),e.options).then((t=>{if(!t)return null;let r=URL.getPath(e.url),a=MaterialParser.collectLinks(t,r);if("LAYAMATERIAL:04"===t.version){let i=t.props.type;if(!Shader3D.find(i)){let s=AssetDb.inst.shaderName_to_URL(i);if(!s)return AssetDb.inst.shaderName_to_URL_async(i).then((s=>(s?a.push(s):t.props.shaderPath?a.push(URL.join(r,t.props.shaderPath)):Loader.warn(`unknown shaderName: ${i}`),this.load2(e,t,a))));a.push(s)}}return this.load2(e,t,a)}))}load2(e,t,r){if(0==r.length){let r=MaterialParser.parse(t),a=e.obsoluteInst;return a&&(r=this.move(a,r)),Promise.resolve(r)}return e.loader.load(r,e.options,e.progress.createCallback()).then((()=>{let r=MaterialParser.parse(t),a=e.obsoluteInst;return e.obsoluteInst&&(r=this.move(a,r)),r}))}move(e,t){return e._shaderValues.reset(),e.setShaderName(t._shader.name),t._shaderValues.cloneTo(e._shaderValues),e.renderQueue=t.renderQueue,e.materialRenderMode=t.materialRenderMode,e.obsolute=!1,t.destroy(),e}},Loader.MATERIAL);class ParseJSON{static parse(e){return this.parseStart(e)}static findIndex(e,t,r,a){var i=e.indexOf(r,t+1);return 0>i&&(i=a),{str:e.substring(t+1,i),i:i}}static finCurrObj(){if(this.type=1,null==this.cobj)return null;if(0==this.currArr.length)return this.cobj.k&&(this.ret[this.cobj.k]=this.cobj.val),null;var e=this.currArr.pop();if(this.cobj.k)if(Array.isArray(e.val)){if(null!=this.cobj.k){var t={};t[this.cobj.k]=this.cobj.val,e.val.push(t)}}else e.val[this.cobj.k]=this.cobj.val;else Array.isArray(this.cobj.val)&&(Array.isArray(e.val)?e.val.push(this.cobj.val):e.val=this.cobj.val);return e}static formatVal(e){if(null==e)return null;var t=Number(e);return isNaN(t)?"false"!=e.toLowerCase()&&("true"==e.toLowerCase()||("null"==e?null:e)):t}static finCurrStr(){null!=this.currStr&&(this.currStr=this.currStr.trim(),""!=this.currStr&&(null!=this.cobj&&(Array.isArray(this.cobj.val)?this.cobj.val.push(this.formatVal(this.currStr)):(this.cobj.val=this.formatVal(this.currStr),this.cobj=this.finCurrObj())),this.currStr=""))}static parseStart(e){this.len=e.length;var t=0;for(this.ret={},this.currStr=null,this.currArr=[],this.cobj=null,this.type=0;t<this.len;){var r=e.charAt(t);if("/"==r){if(t+1<this.len){t+=1;var a=e.charAt(t),i=null;if("/"==a?i="\n":"*"==a&&(i="*/"),null!=i){this.finCurrStr();var s=e.indexOf(i,t);0>s?(console.log("没有找到注释结尾，应该是一直注释到最后了"),t=this.len):t=s+i.length-1}}}else if("}"==r)null!=this.cobj&&(this.finCurrStr(),null!=this.cobj&&(this.cobj=this.finCurrObj())),this.currStr="",this.type=1;else if("{"==r)this.currStr="",this.type=1;else if("'"==r||'"'==r||"‘"==r||"“"==r){"‘"==r?r="’":"“"==r&&(r="”");var n=this.findIndex(e,t,r,this.len);2==this.type&&null!=this.cobj&&Array.isArray(this.cobj.val)?(null!=this.currStr&&(this.currStr=this.currStr.trim(),""!=this.currStr&&this.cobj.val.push(this.formatVal(this.currStr))),this.cobj.val.push(n.str),this.currStr=""):null!=this.currStr&&(this.currStr+=n.str),t=n.i}else if(";"==r||","==r||"\n"==r)this.finCurrStr();else if("]"==r)null!=this.currStr&&null!=this.cobj&&Array.isArray(this.cobj.val)&&(this.currStr=this.currStr.trim(),""!=this.currStr&&this.cobj.val.push(this.formatVal(this.currStr))),null!=this.cobj&&(this.cobj=this.finCurrObj(),this.cobj=this.finCurrObj()),this.currStr="";else if("["==r)2!=this.type?console.warn("没有key值，忽略掉一个数组"):(null!=this.cobj&&this.currArr.push(this.cobj),this.cobj={val:[]});else if(":"==r){if(null!=this.currStr&&1==this.type){if(this.type=2,null!=this.cobj&&this.currArr.push(this.cobj),null!=this.cobj&&Array.isArray(this.cobj.val)){var o=this.cobj;this.cobj={val:{}},o.val.push(this.cobj.val),this.currArr.push(this.cobj)}this.cobj={k:this.currStr.trim(),val:{}},this.currStr=""}}else null!=this.currStr&&(this.currStr+=r);t++}return this.ret}}e.TextureCubeFace=void 0,(bt=e.TextureCubeFace||(e.TextureCubeFace={}))[bt.PositiveX=0]="PositiveX",bt[bt.NegativeX=1]="NegativeX",bt[bt.PositiveY=2]="PositiveY",bt[bt.NegativeY=3]="NegativeY",bt[bt.PositiveZ=4]="PositiveZ",bt[bt.NegativeZ=5]="NegativeZ";const Ct=new Uint8Array(4);class TextureCube extends BaseTexture{static get blackTexture(){return TextureCube._blackTexture}static get grayTexture(){return TextureCube._grayTexture}static get whiteTexture(){return TextureCube._whiteTexture}static get errorTexture(){return TextureCube._errorTexture}static __init__(){var t=new TextureCube(1,e.TextureFormat.R8G8B8A8,!1),r=new TextureCube(1,e.TextureFormat.R8G8B8A8,!1),a=new TextureCube(1,e.TextureFormat.R8G8B8A8,!1),i=Ct;i[0]=0,i[1]=0,i[2]=0,i[3]=255,t.setPixelsData([i,i,i,i,i,i],!1,!1),t.lock=!0,i[0]=128,i[1]=128,i[2]=128,i[3]=255,r.setPixelsData([i,i,i,i,i,i],!1,!1),r.lock=!0,i[0]=255,i[1]=255,i[2]=255,i[3]=255,a.setPixelsData([i,i,i,i,i,i],!1,!1),a.lock=!0,TextureCube._grayTexture=r,TextureCube._blackTexture=t,TextureCube._whiteTexture=a,TextureCube._errorTexture=a}constructor(t,r,a=!0,i=!1,s=!1){super(t,t,r),this._dimension=e.TextureDimension.Cube,this._texture=LayaGL.textureContext.createTextureInternal(this._dimension,t,t,r,a,i,s)}setImageData(e,t,r){let a=!1,i=e.findIndex((e=>null!=e));if(-1!=i){let t=e[i];e.every((e=>null!=e&&e.width==t.width&&e.height==t.height))||(a=!0)}else a=!0;let s=this._texture;if(a){let e=Ct;LayaGL.textureContext.setCubePixelsData(s,[e,e,e,e,e,e],t,r)}else LayaGL.textureContext.setCubeImageData(s,e,t,r)}setPixelsData(e,t,r){let a=this._texture;LayaGL.textureContext.setCubePixelsData(a,e,t,r)}updateSubPixelsData(e,t,r,a,i,s,n,o,l){let h=this._texture;LayaGL.textureContext.setCubeSubPixelData(h,e,s,n,t,r,a,i,o,l)}setDDSData(e){let t=this._texture;LayaGL.textureContext.setCubeDDSData(t,e)}setKTXData(e){let t=this._texture;LayaGL.textureContext.setCubeKTXData(t,e)}get defaultTexture(){return TextureCube.grayTexture}}const vt=["GLSL Start","GLSL End"],Dt=["#defineGLSL","#endGLSL"],Mt=["Shader3D Start","Shader3D End"],At={Color:e.ShaderDataType.Color,Int:e.ShaderDataType.Int,Bool:e.ShaderDataType.Bool,Float:e.ShaderDataType.Float,Vector2:e.ShaderDataType.Vector2,Vector3:e.ShaderDataType.Vector3,Vector4:e.ShaderDataType.Vector4,Matrix4x4:e.ShaderDataType.Matrix4x4,Matrix3x3:e.ShaderDataType.Matrix3x3,Texture2D:e.ShaderDataType.Texture2D,TextureCube:e.ShaderDataType.TextureCube,Texture2DArray:e.ShaderDataType.Texture2DArray,Texture3D:e.ShaderDataType.Texture3D};class ShaderParser{static parse(e,t){let r=ShaderParser.getShaderBlock(e),a=ShaderParser.getCGBlock(e);return ShaderParser.bindCG(r,a),Shader3D.parse(r,t)}static compileToTree(e,t,r){if(r==e.length)return[t];let a=e[r],i=t.split(a);if(1==i.length)return i;let s=[];for(let t=0,n=i.length;t<n;t++)s=s.concat(ShaderParser.compileToTree(e,i[t],r+1)),t!=n-1&&s.push(a);return s}static getMapKey(e){let t=e.indexOf("\n");return e=(e=(e=e.slice(0,t).replace("\r","")).slice(0,t).replace(" ","")).trim()}static getShaderBlock(e){let t=null;try{let r=e.indexOf(Mt[0]);if(-1==r)throw new Error(`no '${Mt[0]}' tag`);let a=e.indexOf(Mt[1]);if(-1==a)throw new Error(`no '${Mt[1]}' tag`);let i=e.substring(r+Mt[0].length,a);t=ParseJSON.parse(i)}catch(t){console.error("Shader parse error: "+t+"\n"+e.substring(0,100)+"...")}return t}static getCGBlock(e){let t={};try{let r=e.indexOf(vt[0]);if(-1==r)throw new Error(`no '${Mt[0]}' tag`);let a=e.indexOf(vt[1]);if(-1==a)throw new Error(`no '${Mt[1]}' tag`);let i=e.substring(r,a),s=ShaderParser.compileToTree(Dt,i,0);for(let e=0,r=s.length;e<r;e++){if(s[e]==Dt[0]){e+=1;let r=s[e];t[ShaderParser.getMapKey(r)]=r.slice(r.indexOf("\n"),r.length-1)}}}catch(t){console.error("Shader parse error: "+t+"\n"+e.substring(0,100)+"...")}return t}static bindCG(e,t){let r=e.shaderPass;r&&r.forEach((e=>{e.VS&&(e.VS=t[e.VS]),e.FS&&(e.FS=t[e.FS])}));let a=e.attributeMap;if(a){let t=0;for(let r in a)if(a[r]instanceof Array){let t=a[r],i=ShaderParser.getShaderDataType(t[0]);if(null==i){console.warn(`${e.name}: unkown attribute type '${t[0]}'`);continue}a[r]=[t[1],i]}else{let i=ShaderParser.getShaderDataType(a[r]);if(null==i){console.warn(`${e.name}: unkown attribute type '${a[r]}'`);continue}a[r]=[t,i],t++}}let i=e.uniformMap;if(i){let t={};e.defaultValue=t;let r={};e.uniformMap=r;for(let a in i){let s=i[a];if(!1===s.serializable)continue;let n=ShaderParser.getShaderDataType(s.type);if(null!=n)if(null!=s.default&&(t[a]=ShaderParser.getDefaultData(n,s.default)),s.block){let e=r[s.block];e||(r[s.block]=e={}),e[a]=n}else r[a]=n;else console.warn(`${e.name}: unkown uniform type '${s.type}'`)}}}static getShaderDataType(e){return At[e]}static getDefaultData(t,r){switch(t){case e.ShaderDataType.Int:case e.ShaderDataType.Float:case e.ShaderDataType.Bool:return r;case e.ShaderDataType.Vector2:return new Vector2(r[0],r[1]);case e.ShaderDataType.Vector3:return new Vector3(r[0],r[1],r[2]);case e.ShaderDataType.Vector4:return new Vector4(r[0],r[1],r[2],r[3]);case e.ShaderDataType.Color:return new Color(r[0],r[1],r[2],r[3]);case e.ShaderDataType.Matrix4x4:let t=new Matrix4x4;return t.cloneByArray(r),t;case e.ShaderDataType.Matrix3x3:let a=new Matrix3x3;return a.cloneByArray(r),a;case e.ShaderDataType.Texture2D:let i=null;return"white"==r?i=Texture2D.whiteTexture:"black"==r?i=Texture2D.blackTexture:"gray"==r?i=Texture2D.grayTexture:"normal"==r&&(i=Texture2D.normalTexture),i;case e.ShaderDataType.TextureCube:let s=TextureCube.grayTexture;return"white"==r?s=TextureCube.whiteTexture:"black"==r?s=TextureCube.blackTexture:"gray"==r&&(s=TextureCube.grayTexture),s}}}Loader.registerLoader(["shader","bps"],class{load(e){let t=e.url;return"bps"===e.ext&&(t=AssetDb.inst.getSubAssetURL(t,e.uuid,"0","shader")),e.loader.fetch(t,"text",e.progress.createCallback(),e.options).then((t=>{if(!t)return null;let r=ShaderParser.getShaderBlock(t),a=ShaderParser.getCGBlock(t);if(ShaderParser.bindCG(r,a),!r.name||!r.uniformMap)return null;let i=URL.getPath(e.url),s=r.shaderPass;return Promise.all(s.map((e=>ShaderCompile.compileAsync(e.VS,e.FS,i)))).then((t=>{var a;if(-1!=t.findIndex((e=>null==e)))return Loader.warn("some pass null "+e.url),null;let i=Shader3D.add(r.name,r.enableInstancing,r.supportReflectionProbe);i._surportVolumetricGI=r.surportVolumetricGI;let n=new SubShader(r.attributeMap?r.attributeMap:SubShader.DefaultAttributeMap,r.uniformMap,r.defaultValue);i.addSubShader(n);for(let e in s){let r=n._addShaderPass(t[e],s[e].pipeline);r.statefirst=null!==(a=s[e].statefirst)&&void 0!==a&&a,ShaderCompile.getRenderState(s[e].renderState,r.renderState)}return i}))}))}});Loader.registerLoader(["mp3","wav","ogg"],class{load(e){return e.loader.fetch(e.url,"arraybuffer",e.progress.createCallback(),e.options).then((e=>e?WebAudioSound.ctx.decodeAudioData(e):null))}},Loader.SOUND);let Lt=ClassUtils.regClass;Lt("Record",Object),Lt("Node",Node),Lt("Sprite",Sprite),Lt("Widget",Widget),Lt("Text",Text),Lt("Input",Input),Lt("AnimationBase",AnimationBase),Lt("Animation",Animation),Lt("FrameAnimation",FrameAnimation),Lt("EffectAnimation",EffectAnimation),Lt("SoundNode",SoundNode),Lt("VideoNode",VideoNode),Lt("Scene",Scene),Lt("Stage",Stage),Lt("Component",Component),Lt("Script",Script),Lt("BitmapFont",BitmapFont),Lt("BlurFilter",BlurFilter),Lt("ColorFilter",ColorFilter),Lt("GlowFilter",GlowFilter),Lt("Point",Point),Lt("Rectangle",Rectangle),Lt("Texture",Texture),Lt("Texture2D",Texture2D),Lt("Prefab",Prefab),Lt("Animator2D",Animator2D),Lt("AnimatorControllerLayer2D",AnimatorControllerLayer2D),Lt("AnimatorState2D",AnimatorState2D),Lt("AnimationClip2D",AnimationClip2D),Lt("AnimatorController2D",AnimatorController2D),Lt("Animation2DParm",Animation2DParm),Lt("Animation2DCondition",Animation2DCondition),Lt("Vector2",Vector2),Lt("Vector3",Vector3),Lt("Vector4",Vector4),Lt("Quaternion",Quaternion),Lt("Color",Color),Lt("Matrix",Matrix),Lt("Matrix3x3",Matrix3x3),Lt("Matrix4x4",Matrix4x4);class LocalStorage{static __init__(){return LocalStorage._baseClass||(LocalStorage._baseClass=Storage,Storage.init()),LocalStorage.items=LocalStorage._baseClass.items,LocalStorage.support=LocalStorage._baseClass.support,LocalStorage.support}static setItem(e,t){LocalStorage._baseClass.setItem(e,t)}static getItem(e){return LocalStorage._baseClass.getItem(e)}static setJSON(e,t){LocalStorage._baseClass.setJSON(e,t)}static getJSON(e){return LocalStorage._baseClass.getJSON(e)}static removeItem(e){LocalStorage._baseClass.removeItem(e)}static clear(){LocalStorage._baseClass.clear()}}LocalStorage.support=!1;class Storage{static init(){try{Storage.support=!0,Storage.items=window.localStorage,Storage.setItem("laya","1"),Storage.removeItem("laya")}catch(e){Storage.support=!1}Storage.support||console.log("LocalStorage is not supprot or browser is private mode.")}static setItem(e,t){try{Storage.support&&Storage.items.setItem(e,t)}catch(e){console.warn("set localStorage failed",e)}}static getItem(e){return Storage.support?Storage.items.getItem(e):null}static setJSON(e,t){try{Storage.support&&Storage.items.setItem(e,JSON.stringify(t))}catch(e){console.warn("set localStorage failed",e)}}static getJSON(e){try{return JSON.parse(Storage.support?Storage.items.getItem(e):null)}catch(t){return Storage.items.getItem(e)}}static removeItem(e){Storage.support&&Storage.items.removeItem(e)}static clear(){Storage.support&&Storage.items.clear()}}Storage.support=!1;class PrimitiveSV extends Value2D{constructor(){super(e.RenderSpriteData.Primitive),this._defaultShader=Shader3D.find("Sprite2DPrimitive")}}class TextureSV extends Value2D{get blurInfo(){return this.defines.getVector2(ShaderDefines2D.UNIFORM_BLURINFO)}set blurInfo(e){this.defines.setVector2(ShaderDefines2D.UNIFORM_BLURINFO,e)}get u_blurInfo1(){return this.defines.getVector(ShaderDefines2D.UNIFORM_BLURINFO1)}set u_blurInfo1(e){this.defines.setVector(ShaderDefines2D.UNIFORM_BLURINFO1,e)}get u_blurInfo2(){return this.defines.getVector(ShaderDefines2D.UNIFORM_BLURINFO2)}set u_blurInfo2(e){this.defines.setVector(ShaderDefines2D.UNIFORM_BLURINFO2,e)}get u_TexRange(){return this.defines.getVector(ShaderDefines2D.UNIFORM_TEXRANGE)}set u_TexRange(e){this.defines.setVector(ShaderDefines2D.UNIFORM_TEXRANGE,e)}get colorMat(){return this.defines.getMatrix4x4(ShaderDefines2D.UNIFORM_COLORMAT)}set colorMat(e){this.defines.setMatrix4x4(ShaderDefines2D.UNIFORM_COLORMAT,e)}get colorAlpha(){return this.defines.getVector(ShaderDefines2D.UNIFORM_COLORALPHA)}set colorAlpha(e){this.defines.setVector(ShaderDefines2D.UNIFORM_COLORALPHA,e)}get strength_sig2_2sig2_gauss1(){return this.defines.getVector(ShaderDefines2D.UNIFORM_STRENGTH_SIG2_2SIG2_GAUSS1)}set strength_sig2_2sig2_gauss1(e){this.defines.setVector(ShaderDefines2D.UNIFORM_STRENGTH_SIG2_2SIG2_GAUSS1,e)}constructor(){super(e.RenderSpriteData.Texture2D),this.strength=0,this._blurInfo=new Vector2,this._u_blurInfo1=new Vector4,this._u_blurInfo2=new Vector4,this._u_TexRange=new Vector4,this._colorMat=new Matrix4x4,this._colorAlpha=new Vector4,this._strength_sig2_2sig2_gauss1=new Vector4,this._defaultShader=Shader3D.find("Sprite2DTexture"),this.blurInfo=this._blurInfo,this.u_blurInfo1=this._u_blurInfo1,this.u_blurInfo2=this._u_blurInfo2,this.u_TexRange=this._u_TexRange,this.colorMat=this._colorMat,this.colorAlpha=this._colorAlpha,this.strength_sig2_2sig2_gauss1=this._strength_sig2_2sig2_gauss1}clear(){this.texture=null,this.defines._defineDatas.clear()}}class Mouse{static set cursor(e){Mouse._style.cursor=e}static get cursor(){return Mouse._style.cursor}static __init__(){Mouse._style=Browser.document.body.style}static hide(){"none"!=Mouse.cursor&&(Mouse._preCursor=Mouse.cursor,Mouse.cursor="none")}static show(){"none"==Mouse.cursor&&(Mouse._preCursor?Mouse.cursor=Mouse._preCursor:Mouse.cursor="auto")}}class MeshParticle2D extends Mesh2D{static __init__(){const t=LayaGL.renderEngine.getParams(e.RenderParams.FLOAT);MeshParticle2D._fixattriInfo=[t,4,0,t,3,16,t,3,28,t,4,40,t,4,56,t,3,72,t,2,84,t,4,92,t,1,108,t,1,112]}constructor(e){super(MeshParticle2D.const_stride,4*e*MeshParticle2D.const_stride,4),this.canReuse=!0,this.setAttributes(MeshParticle2D._fixattriInfo),this.createQuadIB(e),this._quadNum=e,MeshParticle2D.vertexDeclaration||(MeshParticle2D.vertexDeclaration=new VertexDeclaration(116,[new VertexElement(0,VertexElementFormat.Vector4,0),new VertexElement(16,VertexElementFormat.Vector3,1),new VertexElement(28,VertexElementFormat.Vector3,2),new VertexElement(40,VertexElementFormat.Vector4,3),new VertexElement(56,VertexElementFormat.Vector4,4),new VertexElement(72,VertexElementFormat.Vector3,5),new VertexElement(84,VertexElementFormat.Vector2,6),new VertexElement(92,VertexElementFormat.Vector4,7),new VertexElement(108,VertexElementFormat.Single,8),new VertexElement(112,VertexElementFormat.Single,9)])),this._vb.vertexDeclaration=MeshParticle2D.vertexDeclaration}setMaxParticleNum(e){this._vb.buffer2D._resizeBuffer(4*e*MeshParticle2D.const_stride,!1),this.createQuadIB(e)}static getAMesh(e){if(MeshParticle2D._POOL.length){var t=MeshParticle2D._POOL.pop();return t.setMaxParticleNum(e),t}return new MeshParticle2D(e)}releaseMesh(){this._vb.buffer2D.setByteLength(0),this.vertNum=0,this.indexNum=0,MeshParticle2D._POOL.push(this)}destroy(){this._ib.destroy(),this._vb.destroy(),this._vb.deleteBuffer()}}MeshParticle2D.const_stride=116,MeshParticle2D._POOL=[],MeshParticle2D.vertexDeclaration=null;class Laya{static init(...t){if(Laya._inited)return Promise.resolve();if(Laya._inited=!0,!WebGL.enable())throw new Error("Must support webGL!");let r;r="number"==typeof t[0]?{designWidth:t[0],designHeight:t[1]}:t[0],Browser.__init__(),URL.__init__();let a=window.Laya3D;a&&(RunDriver.changeWebGLSize=a._changeWebGLSize,Render.is3DMode=!0);let i=Browser.mainCanvas=new HTMLCanvas(!0);Laya._setStyleInfo(i),Browser.onKGMiniGame||Browser.onAlipayMiniGame||Browser.onTBMiniGame||Browser.container.appendChild(i.source),Browser.canvas=new HTMLCanvas(!0),Browser.context=Browser.canvas.getContext("2d"),Browser.supportWebAudio=SoundManager.__init__(),Browser.supportLocalStorage=LocalStorage.__init__(),e.systemTimer=new Timer(!1),e.physicsTimer=new Timer(!1),e.timer=new Timer(!1),e.loader=new Loader,Laya.systemTimer=Timer.gSysTimer=e.systemTimer,Laya.timer=e.timer,Laya.physicsTimer=e.physicsTimer,Laya.loader=e.loader,ILaya.systemTimer=e.systemTimer,ILaya.physicsTimer=e.physicsTimer,ILaya.timer=e.timer,ILaya.loader=e.loader,WeakObject.__init__(),Mouse.__init__(),LayaEnv.isConch&&Laya.enableNative(),CacheManger.beginCheck();let s=[];LayaEnv.beforeInit&&s.push((()=>LayaEnv.beforeInit(r))),s.push((()=>Promise.all(Laya._beforeInitCallbacks.map((e=>e(r)))))),s.push((()=>LayaGL.renderOBJCreate.createEngine(null,Browser.mainCanvas))),s.push((()=>Laya.initRender2D(r))),a&&s.push((()=>a.__init__())),s.push((()=>Promise.all(Laya._initCallbacks.map((e=>e()))))),s.push((()=>Promise.all(Laya._afterInitCallbacks.map((e=>e()))))),LayaEnv.afterInit&&s.push((()=>LayaEnv.afterInit()));let n=Promise.resolve();for(let e of s)n=n.then(e);return n}static _setStyleInfo(e){let t=e.source.style;t.position="absolute",t.top=t.left="0px",t.background="#000000"}static initRender2D(t){e.stage=window.stage=ILaya.stage=Laya.stage=new Stage,Shader3D.init(),MeshQuadTexture.__int__(),MeshVG.__init__(),MeshTexture.__init__(),Laya.render=Laya.createRender(),e.render=Laya.render,e.stage.size(t.designWidth,t.designHeight),t.scaleMode&&(e.stage.scaleMode=t.scaleMode),t.screenMode&&(e.stage.screenMode=t.screenMode),t.alignV&&(e.stage.alignV=t.alignV),t.alignH&&(e.stage.alignH=t.alignH),Config.isAlpha?e.stage.bgColor=null:t.backgroundColor&&(e.stage.bgColor=t.backgroundColor),LayaEnv.isConch&&window.conch.setGlobalRepaint&&window.conch.setGlobalRepaint(e.stage.setGlobalRepaint.bind(e.stage)),RenderStateContext.__init__(),MeshParticle2D.__init__(),RenderSprite.__init__(),Material.__initDefine__(),InputManager.__init__(e.stage,Render.canvas),window.conch&&"conchUseWXAdapter"in Browser.window&&(Input.isAppUseNewInput=!0),Input.__init__(),SoundManager.autoStopMusic=!0,Value2D._initone(e.RenderSpriteData.Texture2D,TextureSV),Value2D._initone(e.RenderSpriteData.Primitive,PrimitiveSV)}static createRender(){return new Render(0,0,Browser.mainCanvas)}static alertGlobalError(e){var t=0;Browser.window.onerror=e?function(e,r,a,i,s){t++<5&&s&&this.alert("出错啦，请把此信息截图给研发商\n"+e+"\n"+s.stack)}:null}static _runScript(e){return Browser.window[Laya._evcode](e)}static enableDebugPanel(e="libs/laya.debugtool.js"){if(window.Laya.DebugPanel)window.Laya.DebugPanel.enable();else{var t=Browser.createElement("script");t.onload=function(){window.Laya.DebugPanel.enable()},t.src=e,Browser.document.body.appendChild(t)}}static enableNative(){Laya.isNativeRender_enable||(Laya.isNativeRender_enable=!0,RenderState2D.width=Browser.window.innerWidth,RenderState2D.height=Browser.window.innerHeight,Stage.clear=function(t){Context.set2DRenderConfig();var r=ColorUtils.create(t).arrColor;LayaGL.renderEngine.clearRenderTexture(e.RenderClearFlag.Color|e.RenderClearFlag.Depth,new Color(r[0],r[1],r[2],r[3]),1),RenderState2D.clear()},Sprite.drawToCanvas=function(e,t,r,a,i,s){i-=e.x,s-=e.y,i|=0,s|=0,r|=0,a|=0;var n=new HTMLCanvas(!1),o=n.getContext("2d");return n.size(r,a),o.asBitmap=!0,o._targets.start(),RenderSprite.renders[t]._fun(e,o,i,s),o.flush(),o._targets.end(),o._targets.restore(),n},Object.defineProperty(RenderTexture2D.prototype,"uv",{get:function(){return this._uv},set:function(e){this._uv=e}}),HTMLCanvas.prototype.getTexture=function(){return this._texture||(this._texture=this.context._targets,this._texture.uv=RenderTexture2D.flipyuv,this._texture.bitmap=this._texture),this._texture})}static addInitCallback(e){Laya._initCallbacks.push(e)}static addBeforeInitCallback(e){Laya._beforeInitCallbacks.push(e)}static addAfterInitCallback(e){Laya._afterInitCallbacks.push(e)}}Laya.stage=null,Laya.systemTimer=null,Laya.physicsTimer=null,Laya.timer=null,Laya.loader=null,Laya._inited=!1,Laya._initCallbacks=[],Laya._beforeInitCallbacks=[],Laya._afterInitCallbacks=[],Laya._evcode="eval",Laya.isNativeRender_enable=!1,ILaya.Laya=Laya,ILaya.Loader=Loader,ILaya.Context=Context,ILaya.Browser=Browser;var It=Laya.init;e.stage=void 0,e.systemTimer=void 0,e.physicsTimer=void 0,e.timer=void 0,e.loader=void 0,e.render=void 0;var wt,Bt,Pt,Ft,Nt,Ot=Laya.alertGlobalError,Ut=Laya.enableDebugPanel,Gt=Laya.addInitCallback,Vt=Laya.addBeforeInitCallback,kt=Laya.addAfterInitCallback;class BlendState{static create(e,t,r){}constructor(e){this.blendType=0}}BlendState._blend_All_pool={},BlendState._blend_seperate_pool={};class BlendComponent{static getHash(e,t,r){return e+(t<<3)+(r<<7)}static getBlendComponent(e,t,r){let a=BlendComponent.getHash(e,t,r);return BlendComponent._pool[a]||(BlendComponent._pool[a]=new BlendComponent(e,t,r,a)),BlendComponent._pool[a]}constructor(e,t,r,a){this._hashIndex=0,this._hashIndex=a,this._blendOperationGLData=e,this._sourceBlendFactor=t,this._destinationFactor=r}}BlendComponent._pool={};class CommandUniformMap{constructor(e){this._idata={},this._stateName=e}hasPtrID(e){return!(null==this._idata[e])}getMap(){return this._idata}addShaderUniform(e,t,r,a=null){this._idata[e]={uniformtype:r,propertyName:t,block:a}}addShaderBlockUniform(e,t,r){this._idata[e]={propertyName:t,blockProperty:r},r.forEach((e=>{this.addShaderUniform(e.id,e.propertyName,e.uniformtype,t)}))}}class RenderStateCommand{constructor(){this.cmdArray=new Map}addCMD(e,t){this.cmdArray.set(e,t)}applyCMD(){LayaGL.renderEngine.applyRenderStateCMD(this)}clear(){this.cmdArray.clear()}}class EffectBase extends Component{constructor(){super(...arguments),this.duration=1e3,this.delay=0,this.repeat=0,this.autoDestroyAtComplete=!0}_onAwake(){this.target=this.target||this.owner,this.autoDestroyAtComplete&&(this._comlete=Handler.create(this.target,this.target.destroy,null,!1)),this.eventName?this.owner.on(this.eventName,this,this._exeTween):this._exeTween()}_exeTween(){this._tween=this._doTween(),this._tween.repeat=this.repeat}_doTween(){return null}onReset(){this.duration=1e3,this.delay=0,this.repeat=0,this.ease=null,this.target=null,this.eventName&&(this.owner.off(this.eventName,this,this._exeTween),this.eventName=null),this._comlete&&(this._comlete.recover(),this._comlete=null),this._tween&&(this._tween.clear(),this._tween=null)}}class Keyboard{}Keyboard.NUMBER_0=48,Keyboard.NUMBER_1=49,Keyboard.NUMBER_2=50,Keyboard.NUMBER_3=51,Keyboard.NUMBER_4=52,Keyboard.NUMBER_5=53,Keyboard.NUMBER_6=54,Keyboard.NUMBER_7=55,Keyboard.NUMBER_8=56,Keyboard.NUMBER_9=57,Keyboard.A=65,Keyboard.B=66,Keyboard.C=67,Keyboard.D=68,Keyboard.E=69,Keyboard.F=70,Keyboard.G=71,Keyboard.H=72,Keyboard.I=73,Keyboard.J=74,Keyboard.K=75,Keyboard.L=76,Keyboard.M=77,Keyboard.N=78,Keyboard.O=79,Keyboard.P=80,Keyboard.Q=81,Keyboard.R=82,Keyboard.S=83,Keyboard.T=84,Keyboard.U=85,Keyboard.V=86,Keyboard.W=87,Keyboard.X=88,Keyboard.Y=89,Keyboard.Z=90,Keyboard.F1=112,Keyboard.F2=113,Keyboard.F3=114,Keyboard.F4=115,Keyboard.F5=116,Keyboard.F6=117,Keyboard.F7=118,Keyboard.F8=119,Keyboard.F9=120,Keyboard.F10=121,Keyboard.F11=122,Keyboard.F12=123,Keyboard.F13=124,Keyboard.F14=125,Keyboard.F15=126,Keyboard.NUMPAD=21,Keyboard.NUMPAD_0=96,Keyboard.NUMPAD_1=97,Keyboard.NUMPAD_2=98,Keyboard.NUMPAD_3=99,Keyboard.NUMPAD_4=100,Keyboard.NUMPAD_5=101,Keyboard.NUMPAD_6=102,Keyboard.NUMPAD_7=103,Keyboard.NUMPAD_8=104,Keyboard.NUMPAD_9=105,Keyboard.NUMPAD_ADD=107,Keyboard.NUMPAD_DECIMAL=110,Keyboard.NUMPAD_DIVIDE=111,Keyboard.NUMPAD_ENTER=108,Keyboard.NUMPAD_MULTIPLY=106,Keyboard.NUMPAD_SUBTRACT=109,Keyboard.SEMICOLON=186,Keyboard.EQUAL=187,Keyboard.COMMA=188,Keyboard.MINUS=189,Keyboard.PERIOD=190,Keyboard.SLASH=191,Keyboard.BACKQUOTE=192,Keyboard.LEFTBRACKET=219,Keyboard.BACKSLASH=220,Keyboard.RIGHTBRACKET=221,Keyboard.QUOTE=222,Keyboard.ALTERNATE=18,Keyboard.BACKSPACE=8,Keyboard.CAPS_LOCK=20,Keyboard.COMMAND=15,Keyboard.CONTROL=17,Keyboard.DELETE=46,Keyboard.ENTER=13,Keyboard.ESCAPE=27,Keyboard.PAGE_UP=33,Keyboard.PAGE_DOWN=34,Keyboard.END=35,Keyboard.HOME=36,Keyboard.LEFT=37,Keyboard.UP=38,Keyboard.RIGHT=39,Keyboard.DOWN=40,Keyboard.SHIFT=16,Keyboard.SPACE=32,Keyboard.TAB=9,Keyboard.INSERT=45;class KeyLocation{}KeyLocation.STANDARD=0,KeyLocation.LEFT=1,KeyLocation.RIGHT=2,KeyLocation.NUM_PAD=3;class CommandEncoder{constructor(){this._idata=[]}getArrayData(){return this._idata}getCount(){return this._idata.length}addShaderUniform(e){this._idata.push(e)}}class QuickTestTool{static getMCDName(e){return QuickTestTool._typeToNameDic[e]}static showRenderTypeInfo(e,t=!1){if(t||!QuickTestTool.showedDic[e]){if(QuickTestTool.showedDic[e]=!0,!QuickTestTool._rendertypeToStrDic[e]){var r,a=[];for(r=1;r<=e;)r&e&&a.push(QuickTestTool.getMCDName(r&e)),r<<=1;QuickTestTool._rendertypeToStrDic[e]=a.join(",")}console.log("cmd:",QuickTestTool._rendertypeToStrDic[e])}}static __init__(){QuickTestTool._typeToNameDic[SpriteConst.ALPHA]="ALPHA",QuickTestTool._typeToNameDic[SpriteConst.TRANSFORM]="TRANSFORM",QuickTestTool._typeToNameDic[SpriteConst.TEXTURE]="TEXTURE",QuickTestTool._typeToNameDic[SpriteConst.GRAPHICS]="GRAPHICS",QuickTestTool._typeToNameDic[SpriteConst.ONECHILD]="ONECHILD",QuickTestTool._typeToNameDic[SpriteConst.CHILDS]="CHILDS",QuickTestTool._typeToNameDic[SpriteConst.TRANSFORM|SpriteConst.ALPHA]="TRANSFORM|ALPHA",QuickTestTool._typeToNameDic[SpriteConst.CANVAS]="CANVAS",QuickTestTool._typeToNameDic[SpriteConst.BLEND]="BLEND",QuickTestTool._typeToNameDic[SpriteConst.FILTERS]="FILTERS",QuickTestTool._typeToNameDic[SpriteConst.MASK]="MASK",QuickTestTool._typeToNameDic[SpriteConst.CLIP]="CLIP",QuickTestTool._typeToNameDic[SpriteConst.LAYAGL3D]="LAYAGL3D"}constructor(){}render(e,t,r){QuickTestTool._addType(this._renderType),QuickTestTool.showRenderTypeInfo(this._renderType),RenderSprite.renders[this._renderType]._fun(this,e,t+this._x,r+this._y),this._repaint=0}_stageRender(e,t,r){QuickTestTool._countStart(),QuickTestTool._PreStageRender.call(ILaya.stage,e,t,r),QuickTestTool._countEnd()}static _countStart(){var e;for(e in QuickTestTool._countDic)QuickTestTool._countDic[e]=0}static _countEnd(){QuickTestTool._i++,QuickTestTool._i>60&&(QuickTestTool.showCountInfo(),QuickTestTool._i=0)}static _addType(e){QuickTestTool._countDic[e]?QuickTestTool._countDic[e]+=1:QuickTestTool._countDic[e]=1}static showCountInfo(){var e;for(e in console.log("==================="),QuickTestTool._countDic)console.log("count:"+QuickTestTool._countDic[e]),QuickTestTool.showRenderTypeInfo(e,!0)}static enableQuickTest(){QuickTestTool.__init__(),Sprite.prototype.render=QuickTestTool.prototype.render,QuickTestTool._PreStageRender=Stage.prototype.render,Stage.prototype.render=QuickTestTool.prototype._stageRender}}QuickTestTool.showedDic={},QuickTestTool._rendertypeToStrDic={},QuickTestTool._typeToNameDic={},QuickTestTool._countDic={},QuickTestTool._i=0;class Socket extends EventDispatcher{get input(){return this._input}get output(){return this._output}get connected(){return this._connected}get endian(){return this._endian}set endian(e){this._endian=e,null!=this._input&&(this._input.endian=e),null!=this._output&&(this._output.endian=e)}constructor(e=null,t=0,r=null,a=null,i=!1){super(),this.disableInput=!1,this.protocols=[],this._byteClass=r||Byte,this.protocols=a,this.endian=Socket.BIG_ENDIAN,e&&t>0&&t<65535&&this.connect(e,t,i)}connect(e,t,r=!1){this.connectByUrl(`${r?"wss":"ws"}://${e}:${t}`)}connectByUrl(e){null!=this._socket&&this.close(),this._socket&&this.cleanSocket(),this.protocols&&0!=this.protocols.length?this._socket=new Browser.window.WebSocket(e,this.protocols):this._socket=new Browser.window.WebSocket(e),this._socket.binaryType="arraybuffer",this._output=new this._byteClass,this._output.endian=this.endian,this._input=new this._byteClass,this._input.endian=this.endian,this._addInputPosition=0,this._socket.onopen=e=>{this._onOpen(e)},this._socket.onmessage=e=>{this._onMessage(e)},this._socket.onclose=e=>{this._onClose(e)},this._socket.onerror=e=>{this._onError(e)}}cleanSocket(){this.close(),this._connected=!1,this._socket.onopen=null,this._socket.onmessage=null,this._socket.onclose=null,this._socket.onerror=null,this._socket=null}close(){if(null!=this._socket)try{this._socket.close()}catch(e){}}_onOpen(e){this._connected=!0,this.event(Event.OPEN,e)}_onMessage(e){if(e&&e.data){var t=e.data;if(this.disableInput&&t)this.event(Event.MESSAGE,t);else{this._input.length>0&&this._input.bytesAvailable<1&&(this._input.clear(),this._addInputPosition=0);var r=this._input.pos;!this._addInputPosition&&(this._addInputPosition=0),this._input.pos=this._addInputPosition,t&&("string"==typeof t?this._input.writeUTFBytes(t):this._input.writeArrayBuffer(t),this._addInputPosition=this._input.pos,this._input.pos=r),this.event(Event.MESSAGE,t)}}}_onClose(e){this._connected=!1,this.event(Event.CLOSE,e)}_onError(e){this.event(Event.ERROR,e)}send(e){this._socket.send(e)}flush(){if(this._output&&this._output.length>0){var e;try{this._socket&&this._socket.send(this._output.__getBuffer().slice(0,this._output.length))}catch(t){e=t}this._output.endian=this.endian,this._output.clear(),e&&this.event(Event.ERROR,e)}}}Socket.LITTLE_ENDIAN="littleEndian",Socket.BIG_ENDIAN="bigEndian",e.DrawType=void 0,(wt=e.DrawType||(e.DrawType={}))[wt.DrawArray=0]="DrawArray",wt[wt.DrawArrayInstance=1]="DrawArrayInstance",wt[wt.DrawElement=2]="DrawElement",wt[wt.DrawElementInstance=3]="DrawElementInstance",e.RenderDrawMode=void 0,(Bt=e.RenderDrawMode||(e.RenderDrawMode={}))[Bt.TRIANGLES=0]="TRIANGLES",Bt[Bt.POINTS=1]="POINTS",Bt[Bt.LINES=2]="LINES",e.RenderIndexMode=void 0,(Pt=e.RenderIndexMode||(e.RenderIndexMode={}))[Pt.UNSIGNED_BYTE=0]="UNSIGNED_BYTE",Pt[Pt.UNSIGNED_SHORT=1]="UNSIGNED_SHORT",Pt[Pt.UNSIGNED_INT=2]="UNSIGNED_INT",e.TextureCompareMode=void 0,(Ft=e.TextureCompareMode||(e.TextureCompareMode={}))[Ft.None=0]="None",Ft[Ft.LEQUAL=1]="LEQUAL",Ft[Ft.GEQUAL=2]="GEQUAL",Ft[Ft.LESS=3]="LESS",Ft[Ft.GREATER=4]="GREATER",Ft[Ft.EQUAL=5]="EQUAL",Ft[Ft.NOTEQUAL=6]="NOTEQUAL",Ft[Ft.ALWAYS=7]="ALWAYS",Ft[Ft.NEVER=8]="NEVER",e.TextureDecodeFormat=void 0,(Nt=e.TextureDecodeFormat||(e.TextureDecodeFormat={}))[Nt.Normal=0]="Normal",Nt[Nt.RGBM=1]="RGBM";class GLSLCodeGenerator{static glslAttributeString(e){let t="";for(const r in e){let a=getAttributeType(e[r][1]);""!=a&&(t=`${t}attribute ${a} ${r};\n`)}return t}static glslUniformString(e,t){if(t){let t="",r="";for(const a in e)if("object"==typeof e[a]){let r=e[a];t+=`uniform ${a} {\n`;for(const e in r){let a=getAttributeType(r[e]);""!=a&&(t+=`${a} ${e};\n`)}t+="};\n"}else{let t=getAttributeType(e[a]);""!=t&&(r+=`uniform ${t} ${a};\n`)}return t+r}{let t="";for(const r in e)if("object"==typeof e[r]){let a=e[r];for(const e in a){let r=getAttributeType(a[e]);""!=r&&(t+=`uniform ${r} ${e};\n`)}}else{let a=getAttributeType(e[r]);""!=a&&(t+=`uniform ${a} ${r};\n`)}return t}}}function getAttributeType(t){switch(t){case e.ShaderDataType.Int:return"int";case e.ShaderDataType.Bool:return"bool";case e.ShaderDataType.Float:return"float";case e.ShaderDataType.Vector2:return"vec2";case e.ShaderDataType.Vector3:return"vec3";case e.ShaderDataType.Vector4:case e.ShaderDataType.Color:return"vec4";case e.ShaderDataType.Matrix4x4:return"mat4";case e.ShaderDataType.Matrix3x3:return"mat3";case e.ShaderDataType.Texture2D:return"sampler2D";case e.ShaderDataType.TextureCube:return"samplerCube";case e.ShaderDataType.Texture2DArray:return LayaGL.renderEngine.getCapable(e.RenderCapable.Texture3D)?"sampler2DArray":"";case e.ShaderDataType.Texture3D:return LayaGL.renderEngine.getCapable(e.RenderCapable.Texture3D)?"sampler3D":"";default:return""}}class ShaderInstance{constructor(e,t){this._customUniformParamsMap=[],this._uploadMark=-1,this._uploadRenderType=-1,this._webGLShaderLanguageProcess3D(e.defineString,e.attributeMap,e.uniformMap,e.vs,e.ps),this._renderShaderInstance._complete&&(this._shaderPass=t,e.is2D?this._create2D():this._create())}get complete(){return this._renderShaderInstance._complete}_webGLShaderLanguageProcess3D(t,r,a,i,s){var n,o,l=Config3D.lightClusterCount,h={},u="";let d=Config3D._uniformBlock,_=GLSLCodeGenerator.glslAttributeString(r),c=GLSLCodeGenerator.glslUniformString(a,d);LayaGL.renderEngine.isWebGL2?(t.push("GRAPHICS_API_GLES3"),n=`#version 300 es\n#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n    precision highp sampler2DArray;\n    precision highp sampler3D;\n#else\n    precision mediump float;\n    precision mediump int;\n    precision mediump sampler2DArray;\n    precision mediump sampler3D;\n#endif\nlayout(std140, column_major) uniform;\n#define attribute in\n#define varying out\n#define textureCube texture\n#define texture2D texture\n${_}\n${c}\n`,o=`#version 300 es\n#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n    precision highp sampler2DArray;\n\tprecision highp sampler3D;\n#else\n    precision mediump float;\n    precision mediump int;\n    precision mediump sampler2DArray;\n\tprecision mediump sampler3D;\n#endif\nlayout(std140, column_major) uniform;\n#define varying in\nout highp vec4 pc_fragColor;\n#define gl_FragColor pc_fragColor\n#define gl_FragDepthEXT gl_FragDepth\n#define texture2D texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLodEXT textureLod\n#define texture2DProjLodEXT textureProjLod\n#define textureCubeLodEXT textureLod\n#define texture2DGradEXT textureGrad\n#define texture2DProjGradEXT textureProjGrad\n#define textureCubeGradEXT textureGrad\n${c}`):(n=`#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n#else\n    precision mediump float;\n    precision mediump int;\n#endif\n${_}\n${c}`,o=`#ifdef GL_EXT_shader_texture_lod\n    #extension GL_EXT_shader_texture_lod : enable\n#endif\n\n#ifdef GL_OES_standard_derivatives\n\t#extension GL_OES_standard_derivatives : enable \n#endif\n\n#if defined(GL_FRAGMENT_PRECISION_HIGH)\n    precision highp float;\n    precision highp int;\n#else\n    precision mediump float;\n    precision mediump int;\n#endif\n\n#if !defined(GL_EXT_shader_texture_lod)\n    #define texture1DLodEXT texture1D\n    #define texture2DLodEXT texture2D\n    #define texture2DProjLodEXT texture2DProj\n    #define textureCubeLodEXT textureCube\n#endif\n${c}`),u+="#define MAX_LIGHT_COUNT "+Config3D.maxLightCount+"\n",u+="#define MAX_LIGHT_COUNT_PER_CLUSTER "+Config3D._maxAreaLightCountPerClusterAverage+"\n",u+="#define CLUSTER_X_COUNT "+l.x+"\n",u+="#define CLUSTER_Y_COUNT "+l.y+"\n",u+="#define CLUSTER_Z_COUNT "+l.z+"\n",u+="#define MORPH_MAX_COUNT "+Config3D.maxMorphTargetCount+"\n",u+="#define SHADER_CAPAILITY_LEVEL "+LayaGL.renderEngine.getParams(e.RenderParams.SHADER_CAPAILITY_LEVEL)+"\n";for(var p=0,m=t.length;p<m;p++){var f=t[p];u+="#define "+f+"\n",h[f]=!0}var g=i.toscript(h,[]),T="";0==g[0].indexOf("#version")&&(T=g[0]+"\n",g.shift());var S=s.toscript(h,[]),x="";0==S[0].indexOf("#version")&&(x=S[0]+"\n",S.shift());let y=T+n+u+g.join("\n"),E=x+o+u+S.join("\n");this._renderShaderInstance=LayaGL.renderEngine.createShaderInstance(y,E,r)}_webGLShaderLanguageProcess2D(e,t,r,a,i){var s,n,o={},l="";LayaGL.renderEngine.isWebGL2?(s="#version 300 es\n\n                #define attribute in\n                #define varying out\n                #define textureCube texture\n                #define texture2D texture\n",n="#version 300 es\n\n                #define varying in\n                out highp vec4 pc_fragColor;\n                #define gl_FragColor pc_fragColor\n                #define gl_FragDepthEXT gl_FragDepth\n                #define texture2D texture\n                #define textureCube texture\n                #define texture2DProj textureProj\n                #define texture2DLodEXT textureLod\n                #define texture2DProjLodEXT textureProjLod\n                #define textureCubeLodEXT textureLod\n                #define texture2DGradEXT textureGrad\n                #define texture2DProjGradEXT textureProjGrad\n                #define textureCubeGradEXT textureGrad\n"):(s="",n="#ifdef GL_EXT_shader_texture_lod\n                    #extension GL_EXT_shader_texture_lod : enable\n                #endif\n                #if !defined(GL_EXT_shader_texture_lod)\n                    #define texture1DLodEXT texture1D\n                    #define texture2DLodEXT texture2D\n                    #define texture2DProjLodEXT texture2DProj\n                    #define texture3DLodEXT texture3D\n                    #define textureCubeLodEXT textureCube\n                #endif\n");for(var h=0,u=e.length;h<u;h++){var d=e[h];l+="#define "+d+"\n",o[d]=!0}var _=a.toscript(o,[]),c="";0==_[0].indexOf("#version")&&(c=_[0]+"\n",_.shift());var p=i.toscript(o,[]),m="";0==p[0].indexOf("#version")&&(m=p[0]+"\n",p.shift());let f=c+s+l+_.join("\n"),g=m+n+l+p.join("\n");this._renderShaderInstance=LayaGL.renderEngine.createShaderInstance(f,g,t)}_create(){this._sceneUniformParamsMap=new CommandEncoder,this._cameraUniformParamsMap=new CommandEncoder,this._spriteUniformParamsMap=new CommandEncoder,this._materialUniformParamsMap=new CommandEncoder;const e=LayaGL.renderOBJCreate.createGlobalUniformMap("Scene3D"),t=LayaGL.renderOBJCreate.createGlobalUniformMap("BaseCamera"),r=LayaGL.renderOBJCreate.createGlobalUniformMap("Custom");let a,i,s=this._renderShaderInstance.getUniformMap();for(a=0,i=s.length;a<i;a++){let i=s[a];e.hasPtrID(i.dataOffset)?this._sceneUniformParamsMap.addShaderUniform(i):t.hasPtrID(i.dataOffset)?this._cameraUniformParamsMap.addShaderUniform(i):this.hasSpritePtrID(i.dataOffset)?this._spriteUniformParamsMap.addShaderUniform(i):r.hasPtrID(i.dataOffset)?(this._customUniformParamsMap||(this._customUniformParamsMap=[]),this._customUniformParamsMap[i.dataOffset]=i):this._materialUniformParamsMap.addShaderUniform(i)}}_create2D(){this._sprite2DUniformParamsMap=new CommandEncoder,this._materialUniformParamsMap=new CommandEncoder,this._sceneUniformParamsMap=new CommandEncoder;const e=LayaGL.renderOBJCreate.createGlobalUniformMap("Sprite2D"),t=LayaGL.renderOBJCreate.createGlobalUniformMap("Sprite2DGlobal");let r,a,i=this._renderShaderInstance.getUniformMap();for(r=0,a=i.length;r<a;r++){let a=i[r];e.hasPtrID(a.dataOffset)?this._sprite2DUniformParamsMap.addShaderUniform(a):t.hasPtrID(a.dataOffset)?this._sceneUniformParamsMap.addShaderUniform(a):this._materialUniformParamsMap.addShaderUniform(a)}}hasSpritePtrID(e){let t=this._shaderPass.nodeCommonMap;if(t){for(let r=0,a=t.length;r<a;r++)if(LayaGL.renderOBJCreate.createGlobalUniformMap(t[r]).hasPtrID(e))return!0;return!1}return!1}_disposeResource(){this._renderShaderInstance.destroy(),this._sceneUniformParamsMap=null,this._cameraUniformParamsMap=null,this._spriteUniformParamsMap=null,this._materialUniformParamsMap=null,this._customUniformParamsMap=null,this._uploadMaterial=null,this._uploadRender=null,this._uploadCameraShaderValue=null,this._uploadScene=null}bind(){return this._renderShaderInstance.bind()}uploadUniforms(e,t,r){Stat.uploadUniform+=LayaGL.renderEngine.uploadUniforms(this._renderShaderInstance,e,t,r)}uploadRenderStateBlendDepth(e){this._shaderPass.statefirst?this.uploadRenderStateBlendDepthByShader(e):this.uploadRenderStateBlendDepthByMaterial(e)}uploadRenderStateBlendDepthByShader(e){var t,r,a,i,s,n,o,l,h,u,d,_,c,p,m,f,g,T,S,x,y,E,R,b,C,v,D,M,A,L,I,w,B=e.getData(),P=this._shaderPass.renderState,F=null!==(r=null!==(t=P.depthWrite)&&void 0!==t?t:B[Shader3D.DEPTH_WRITE])&&void 0!==r?r:RenderState.Default.depthWrite;RenderStateContext.setDepthMask(F);var N=null!==(i=null!==(a=P.depthTest)&&void 0!==a?a:B[Shader3D.DEPTH_TEST])&&void 0!==i?i:RenderState.Default.depthTest;N==RenderState.DEPTHTEST_OFF?RenderStateContext.setDepthTest(!1):(RenderStateContext.setDepthTest(!0),RenderStateContext.setDepthFunc(N));var O=null!==(n=null!==(s=P.stencilWrite)&&void 0!==s?s:B[Shader3D.STENCIL_WRITE])&&void 0!==n?n:RenderState.Default.stencilWrite,U=null!==(l=null!==(o=P.stencilTest)&&void 0!==o?o:B[Shader3D.STENCIL_TEST])&&void 0!==l?l:RenderState.Default.stencilTest;if(RenderStateContext.setStencilMask(O),O){var G=null!==(u=null!==(h=P.stencilOp)&&void 0!==h?h:B[Shader3D.STENCIL_Op])&&void 0!==u?u:RenderState.Default.stencilOp;RenderStateContext.setstencilOp(G.x,G.y,G.z)}if(U==RenderState.STENCILTEST_OFF)RenderStateContext.setStencilTest(!1);else{var V=null!==(_=null!==(d=P.stencilRef)&&void 0!==d?d:B[Shader3D.STENCIL_Ref])&&void 0!==_?_:RenderState.Default.stencilRef;RenderStateContext.setStencilTest(!0),RenderStateContext.setStencilFunc(U,V)}switch(null!==(p=null!==(c=P.blend)&&void 0!==c?c:B[Shader3D.BLEND])&&void 0!==p?p:RenderState.Default.blend){case RenderState.BLEND_DISABLE:RenderStateContext.setBlend(!1);break;case RenderState.BLEND_ENABLE_ALL:var k=null!==(f=null!==(m=P.blendEquation)&&void 0!==m?m:B[Shader3D.BLEND_EQUATION])&&void 0!==f?f:RenderState.Default.blendEquation,H=null!==(T=null!==(g=P.srcBlend)&&void 0!==g?g:B[Shader3D.BLEND_SRC])&&void 0!==T?T:RenderState.Default.srcBlend,W=null!==(x=null!==(S=P.dstBlend)&&void 0!==S?S:B[Shader3D.BLEND_DST])&&void 0!==x?x:RenderState.Default.dstBlend;RenderStateContext.setBlend(!0),RenderStateContext.setBlendEquation(k),RenderStateContext.setBlendFunc(H,W);break;case RenderState.BLEND_ENABLE_SEPERATE:var X=null!==(E=null!==(y=P.blendEquationRGB)&&void 0!==y?y:B[Shader3D.BLEND_EQUATION_RGB])&&void 0!==E?E:RenderState.Default.blendEquationRGB,Y=null!==(b=null!==(R=P.blendEquationAlpha)&&void 0!==R?R:B[Shader3D.BLEND_EQUATION_ALPHA])&&void 0!==b?b:RenderState.Default.blendEquationAlpha,z=null!==(v=null!==(C=P.srcBlendRGB)&&void 0!==C?C:B[Shader3D.BLEND_SRC_RGB])&&void 0!==v?v:RenderState.Default.srcBlendRGB,j=null!==(M=null!==(D=P.dstBlendRGB)&&void 0!==D?D:B[Shader3D.BLEND_DST_RGB])&&void 0!==M?M:RenderState.Default.dstBlendRGB,K=null!==(L=null!==(A=P.srcBlendAlpha)&&void 0!==A?A:B[Shader3D.BLEND_SRC_ALPHA])&&void 0!==L?L:RenderState.Default.srcBlendAlpha,q=null!==(w=null!==(I=P.dstBlendAlpha)&&void 0!==I?I:B[Shader3D.BLEND_DST_ALPHA])&&void 0!==w?w:RenderState.Default.dstBlendAlpha;RenderStateContext.setBlend(!0),RenderStateContext.setBlendEquationSeparate(X,Y),RenderStateContext.setBlendFuncSeperate(z,j,K,q)}}uploadRenderStateBlendDepthByMaterial(e){var t=e.getData(),r=t[Shader3D.DEPTH_WRITE];r=null!=r?r:RenderState.Default.depthWrite,RenderStateContext.setDepthMask(r);var a=t[Shader3D.DEPTH_TEST];(a=null!=a?a:RenderState.Default.depthTest)===RenderState.DEPTHTEST_OFF?RenderStateContext.setDepthTest(!1):(RenderStateContext.setDepthTest(!0),RenderStateContext.setDepthFunc(a));var i=t[Shader3D.STENCIL_WRITE];if(i=null!=i?i:RenderState.Default.stencilWrite,RenderStateContext.setStencilMask(i),i){var s=t[Shader3D.STENCIL_Op];s=null!=s?s:RenderState.Default.stencilOp,RenderStateContext.setstencilOp(s.x,s.y,s.z)}var n=t[Shader3D.STENCIL_TEST];if((n=null!=n?n:RenderState.Default.stencilTest)==RenderState.STENCILTEST_OFF)RenderStateContext.setStencilTest(!1);else{var o=t[Shader3D.STENCIL_Ref];o=null!=o?o:RenderState.Default.stencilRef,RenderStateContext.setStencilTest(!0),RenderStateContext.setStencilFunc(n,o)}var l=t[Shader3D.BLEND];switch(l=null!=l?l:RenderState.Default.blend){case RenderState.BLEND_ENABLE_ALL:var h=t[Shader3D.BLEND_EQUATION];h=null!=h?h:RenderState.Default.blendEquation;var u=t[Shader3D.BLEND_SRC];u=null!=u?u:RenderState.Default.srcBlend;var d=t[Shader3D.BLEND_DST];d=null!=d?d:RenderState.Default.dstBlend,RenderStateContext.setBlend(!0),RenderStateContext.setBlendEquation(h),RenderStateContext.setBlendFunc(u,d);break;case RenderState.BLEND_ENABLE_SEPERATE:var _=t[Shader3D.BLEND_EQUATION_RGB];_=null!=_?_:RenderState.Default.blendEquationRGB;var c=t[Shader3D.BLEND_EQUATION_ALPHA];c=null!=c?c:RenderState.Default.blendEquationAlpha;var p=t[Shader3D.BLEND_SRC_RGB];p=null!=p?p:RenderState.Default.srcBlendRGB;var m=t[Shader3D.BLEND_DST_RGB];m=null!=m?m:RenderState.Default.dstBlendRGB;var f=t[Shader3D.BLEND_SRC_ALPHA];f=null!=f?f:RenderState.Default.srcBlendAlpha;var g=t[Shader3D.BLEND_DST_ALPHA];g=null!=g?g:RenderState.Default.dstBlendAlpha,RenderStateContext.setBlend(!0),RenderStateContext.setBlendEquationSeparate(_,c),RenderStateContext.setBlendFuncSeperate(p,m,f,g);break;case RenderState.BLEND_DISABLE:default:RenderStateContext.setBlend(!1)}}uploadRenderStateFrontFace(t,r,a){var i,s,n=this._shaderPass.renderState,o=t.getData()[Shader3D.CULL];switch(this._shaderPass.statefirst&&(o=null!==(i=n.cull)&&void 0!==i?i:o),o=null!=o?o:RenderState.Default.cull){case RenderState.CULL_NONE:RenderStateContext.setCullFace(!1),s=r!=a?e.CullMode.Front:e.CullMode.Back,RenderStateContext.setFrontFace(s);break;case RenderState.CULL_FRONT:RenderStateContext.setCullFace(!0),s=r==a?e.CullMode.Front:e.CullMode.Back,RenderStateContext.setFrontFace(s);break;case RenderState.CULL_BACK:default:RenderStateContext.setCullFace(!0),s=r!=a?e.CullMode.Front:e.CullMode.Back,RenderStateContext.setFrontFace(s)}}uploadCustomUniform(e,t){LayaGL.renderEngine.uploadCustomUniforms(this._renderShaderInstance,this._customUniformParamsMap,e,t)}}class ShaderVariable{constructor(){this.onID=ShaderVariable.pointID++,this.textureID=-1}}ShaderVariable.pointID=0;class Texture3D extends BaseTexture{static get defaultTexture(){return this._defaultTexture}static __init__(){LayaGL.renderEngine.getCapable(e.RenderCapable.Texture3D)&&(this._defaultTexture=new Texture3D(1,1,1,e.TextureFormat.R8G8B8A8,!1,!1),this._defaultTexture.lock=!0,this._defaultTexture.setPixelsData(new Uint8Array([255,255,255,255])))}constructor(t,r,a,i,s=!0,n=!1){super(t,r,i),this._dimension=e.TextureDimension.Tex3D,this.depth=a,this._gammaSpace=n;let o=LayaGL.textureContext;this._texture=o.createTexture3DInternal(this._dimension,t,r,a,i,s,n,!1)}setPixelsData(e){let t=this._texture;LayaGL.textureContext.setTexture3DPixelsData(t,e,this.depth,!1,!1)}setSubPixelsData(e,t,r,a,i,s,n,o,l){let h=this._texture;LayaGL.textureContext.setTexture3DSubPixelsData(h,n,o,l,e,t,r,a,i,s,!1,!1)}}class Base64Tool{static init(){if(!Base64Tool.lookup){Base64Tool.lookup=new Uint8Array(256);for(var e=0;e<Base64Tool.chars.length;e++)Base64Tool.lookup[Base64Tool.chars.charCodeAt(e)]=e}}static isBase64String(e){return Base64Tool.reg.test(e)}static encode(e){var t,r=new Uint8Array(e),a=r.length,i="";for(t=0;t<a;t+=3)i+=Base64Tool.chars[r[t]>>2],i+=Base64Tool.chars[(3&r[t])<<4|r[t+1]>>4],i+=Base64Tool.chars[(15&r[t+1])<<2|r[t+2]>>6],i+=Base64Tool.chars[63&r[t+2]];return a%3==2?i=i.substring(0,i.length-1)+"=":a%3==1&&(i=i.substring(0,i.length-2)+"=="),i}static decode(e){Base64Tool.init();var t,r,a,i,s,n=.75*e.length,o=e.length,l=0;"="===e[e.length-1]&&(n--,"="===e[e.length-2]&&n--);var h=new ArrayBuffer(n),u=new Uint8Array(h);for(t=0;t<o;t+=4)r=Base64Tool.lookup[e.charCodeAt(t)],a=Base64Tool.lookup[e.charCodeAt(t+1)],i=Base64Tool.lookup[e.charCodeAt(t+2)],s=Base64Tool.lookup[e.charCodeAt(t+3)],l+1>n||(u[l++]=r<<2|a>>4,l+1>n||(u[l++]=(15&a)<<4|i>>2,l+1>n||(u[l++]=(3&i)<<6|63&s)));return h}}Base64Tool.chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Base64Tool.reg=/^\s*data:([a-z]+\/[a-z0-9-+.]+(;[a-z-]+=[a-z0-9-]+)?)?(;base64)?,([a-z0-9!$&',()*+;=\-._~:@\/?%\s]*?)\s*$/i,Base64Tool.reghead=/^\s*data:([a-z]+\/[a-z0-9-+.]+(;[a-z-]+=[a-z0-9-]+)?)?(;base64)?,/i,Base64Tool.lookup=null,ArrayBuffer.prototype.slice||(ArrayBuffer.prototype.slice=function(e,t){var r=new Uint8Array(this,e,t-e),a=new Uint8Array(r.length);return a.set(r),a.buffer}),Float32Array.prototype.slice||(Float32Array.prototype.slice=function(){for(var e=this.length,t=new Float32Array(this.length),r=0;r<e;r++)t[r]=this[r];return t}),Uint16Array.prototype.slice||(Uint16Array.prototype.slice=function(...e){var t,r,a;if(0===e.length)for(t=this.length,r=new Uint16Array(t),a=0;a<t;a++)r[a]=this[a];else if(2===e.length){var i=e[0],s=e[1];if(s>i)for(t=s-i,r=new Uint16Array(t),a=i;a<s;a++)r[a-i]=this[a];else r=new Uint16Array(0)}return r}),Uint8Array.prototype.slice||(Uint8Array.prototype.slice=function(){for(var e=this.length,t=new Uint8Array(this.length),r=0;r<e;r++)t[r]=this[r];return t});class Log{static enable(){Log._logdiv||(Log._logdiv=Browser.createElement("div"),Log._logdiv.style.cssText="border:white;padding:4px;overflow-y:auto;z-index:1000000;background:rgba(100,100,100,0.6);color:white;position: absolute;left:0px;top:0px;width:50%;height:50%;",Browser.document.body.appendChild(Log._logdiv),Log._btn=Browser.createElement("button"),Log._btn.innerText="Hide",Log._btn.style.cssText="z-index:1000001;position: absolute;left:10px;top:10px;",Log._btn.onclick=Log.toggle,Browser.document.body.appendChild(Log._btn))}static toggle(){var e=Log._logdiv.style;""===e.display?(Log._btn.innerText="Show",e.display="none"):(Log._btn.innerText="Hide",e.display="")}static print(e){Log._logdiv&&(Log._count>=Log.maxCount&&Log.clear(),Log._count++,Log._logdiv.innerText+=e+"\n",Log.autoScrollToBottom&&Log._logdiv.scrollHeight-Log._logdiv.scrollTop-Log._logdiv.clientHeight<50&&(Log._logdiv.scrollTop=Log._logdiv.scrollHeight))}static clear(){Log._logdiv.innerText="",Log._count=0}}Log._count=0,Log.maxCount=50,Log.autoScrollToBottom=!0;class PerfData{constructor(e,t,r,a){this.scale=1,this.datas=new Array(300),this.datapos=0,this.id=e,this.color=t,this.name=r,this.scale=a}addData(e){this.datas[this.datapos]=e,this.datapos++,this.datapos%=300}}class PerfHUD extends Sprite{constructor(){super(),this.datas=[],this.xdata=new Array(PerfHUD.DATANUM),this.ydata=new Array(PerfHUD.DATANUM),this.hud_width=800,this.hud_height=200,this.gMinV=0,this.gMaxV=100,this.textSpace=40,this.sttm=0,PerfHUD.inst=this,this._renderType|=SpriteConst.CUSTOM,this._setCustomRender(),this.addDataDef(0,16777215,"frame",1),this.addDataDef(1,65280,"update",1),this.addDataDef(2,16711680,"flush",1),PerfHUD._now=performance?performance.now.bind(performance):Date.now}now(){return PerfHUD._now()}start(){this.sttm=PerfHUD._now()}end(e){var t=PerfHUD._now()-this.sttm;this.updateValue(e,t)}config(e,t){this.hud_width=e,this.hud_height=t}addDataDef(e,t,r,a){this.datas[e]=new PerfData(e,t,r,a)}updateValue(e,t){this.datas[e].addData(t)}v2y(e){return this._y,this.hud_height,this.gMinV,this.gMaxV,this._y+this.hud_height*(1-(e-this.gMinV)/this.gMaxV)}drawHLine(e,t,r,a){var i=this._x;this._x,this.hud_width;var s=this.v2y(t);e.fillText(a,i,s-6,null,"green",null),i+=this.textSpace,e.fillStyle=r,e.fillRect(i,s,this._x+this.hud_width,1,null)}customRender(e,t,r){var a=performance.now();PerfHUD._lastTm<=0&&(PerfHUD._lastTm=a),this.updateValue(0,a-PerfHUD._lastTm),PerfHUD._lastTm=a,e.save(),e.fillRect(this._x,this._y,this.hud_width,this.hud_height+4,"#000000cc"),e.globalAlpha=.9,this.drawHLine(e,0,"green","    0"),this.drawHLine(e,10,"green","  10"),this.drawHLine(e,16.667,"red"," "),this.drawHLine(e,20,"green","50|20"),this.drawHLine(e,33.334,"yellow",""),this.drawHLine(e,16.667*3,"yellow",""),this.drawHLine(e,66.668,"yellow",""),this.drawHLine(e,50,"green","20|50"),this.drawHLine(e,100,"green","10|100");for(var i=0,s=this.datas.length;i<s;i++){var n=this.datas[i];if(n){var o=n.datas.length,l=(this.hud_width-this.textSpace)/o,h=n.datapos,u=this._x+this.textSpace;e.fillStyle=n.color;for(var d=o;h<d;h++){var _=this.v2y(n.datas[h]*n.scale);e.fillRect(u,_,l,this.hud_height+this._y-_,null),u+=l}for(h=0;h<n.datapos;h++)_=this.v2y(n.datas[h]*n.scale),e.fillRect(u,_,l,this.hud_height+this._y-_,null),u+=l}}e.restore()}}PerfHUD._lastTm=0,PerfHUD._now=null,PerfHUD.DATANUM=300,PerfHUD.drawTexTm=0;class PoolCache{constructor(){this.maxCount=1e3}getCacheList(){return Pool.getPoolBySign(this.sign)}tryDispose(e){var t;(t=Pool.getPoolBySign(this.sign)).length>this.maxCount&&t.splice(this.maxCount,t.length-this.maxCount)}static addPoolCacheManager(e,t=100){var r;(r=new PoolCache).sign=e,r.maxCount=t,CacheManger.regCacheByFunction(r.tryDispose.bind(r),r.getCacheList.bind(r))}}class SingletonList{constructor(){this.elements=[],this.length=0}_add(e){this.length===this.elements.length?this.elements.push(e):this.elements[this.length]=e}add(e){let t=this.elements.indexOf(e);"number"!=typeof e&&-1!=t&&t<this.length||(this.length===this.elements.length?this.elements.push(e):this.elements[this.length]=e,this.length++)}indexof(e){let t=this.elements.indexOf(e);return-1!=t&&t<this.length?t:-1}remove(e){let t=this.elements.indexOf(e);-1!=t&&t<this.length&&(this.elements[t]=this.elements[this.length-1],this.length--)}clear(){this.elements=[],this.length=0}clean(){this.elements.length=this.length}destroy(){this.elements=null}}class TimeLine extends EventDispatcher{constructor(){super(...arguments),this._tweenDic={},this._tweenDataList=[],this._currTime=0,this._lastTime=0,this._startTime=0,this._index=0,this._gidIndex=0,this._firstTweenDic={},this._startTimeSort=!1,this._endTimeSort=!1,this._loopKey=!1,this.scale=1,this._frameRate=60,this._frameIndex=0,this._total=0}static to(e,t,r,a=null,i=0){return(new TimeLine).to(e,t,r,a,i)}static from(e,t,r,a=null,i=0){return(new TimeLine).from(e,t,r,a,i)}to(e,t,r,a=null,i=0){return this._create(e,t,r,a,i,!0)}from(e,t,r,a=null,i=0){return this._create(e,t,r,a,i,!1)}_create(e,t,r,a,i,s){var n=Pool.getItemByClass("tweenData",tweenData);return n.isTo=s,n.type=0,n.target=e,n.duration=r,n.data=t,n.startTime=this._startTime+i,n.endTime=n.startTime+n.duration,n.ease=a,this._startTime=Math.max(n.endTime,this._startTime),this._tweenDataList.push(n),this._startTimeSort=!0,this._endTimeSort=!0,this}addLabel(e,t){var r=Pool.getItemByClass("tweenData",tweenData);return r.type=1,r.data=e,r.endTime=r.startTime=this._startTime+t,this._labelDic||(this._labelDic={}),this._labelDic[e]=r,this._tweenDataList.push(r),this}removeLabel(e){if(this._labelDic&&this._labelDic[e]){var t=this._labelDic[e];if(t){var r=this._tweenDataList.indexOf(t);r>-1&&this._tweenDataList.splice(r,1)}delete this._labelDic[e]}}gotoTime(e){if(null!=this._tweenDataList&&0!=this._tweenDataList.length){var t,r,a,i;for(var s in this._firstTweenDic)if(r=this._firstTweenDic[s])for(var n in r)n in r.diyTarget&&(r.diyTarget[n]=r[n]);for(s in this._tweenDic)(t=this._tweenDic[s]).clear(),delete this._tweenDic[s];if(this._index=0,this._gidIndex=0,this._currTime=e,this._lastTime=Browser.now(),null==this._endTweenDataList||this._endTimeSort){function Compare(e,t){return e.endTime>t.endTime?1:e.endTime<t.endTime?-1:0}this._endTimeSort=!1,this._endTweenDataList=a=this._tweenDataList.concat(),a.sort(Compare)}else a=this._endTweenDataList;for(var o=0,l=a.length;o<l;o++)if(0==(i=a[o]).type){if(!(e>=i.endTime))break;this._index=Math.max(this._index,o+1);var h=i.data;if(i.isTo)for(var u in h)i.target[u]=h[u]}for(o=0,l=this._tweenDataList.length;o<l;o++)0==(i=this._tweenDataList[o]).type&&e>=i.startTime&&e<i.endTime&&(this._index=Math.max(this._index,o+1),this._gidIndex++,(t=Pool.getItemByClass("tween",Tween))._create(i.target,i.data,i.duration,i.ease,Handler.create(this,this._animComplete,[this._gidIndex]),0,!1,i.isTo,!0,!1),t.setStartTime(this._currTime-(e-i.startTime)),t._updateEase(this._currTime),t.gid=this._gidIndex,this._tweenDic[this._gidIndex]=t)}}gotoLabel(e){if(null!=this._labelDic){var t=this._labelDic[e];t&&this.gotoTime(t.startTime)}}pause(){ILaya.timer.clear(this,this._update)}resume(){this.play(this._currTime,this._loopKey)}play(e=0,t=!1){if(this._tweenDataList){if(this._startTimeSort){function Compare(e,t){return e.startTime>t.startTime?1:e.startTime<t.startTime?-1:0}this._startTimeSort=!1,this._tweenDataList.sort(Compare);for(var r=0,a=this._tweenDataList.length;r<a;r++){var i=this._tweenDataList[r];if(null!=i&&0==i.type){var s=i.target,n=s.$_GID||(s.$_GID=Utils.getGID()),o=null;for(var l in null==this._firstTweenDic[n]?((o={}).diyTarget=s,this._firstTweenDic[n]=o):o=this._firstTweenDic[n],i.data)null==o[l]&&(o[l]=s[l])}}}"string"==typeof e?this.gotoLabel(e):this.gotoTime(e),this._loopKey=t,this._lastTime=Browser.now(),ILaya.timer.frameLoop(1,this,this._update)}}_update(){if(this._currTime>=this._startTime){if(!this._loopKey){for(var e in this._tweenDic)(t=this._tweenDic[e]).complete();return this.pause(),void this._complete()}if(this._complete(),!this._tweenDataList)return;this.gotoTime(0)}var t,r=Browser.now(),a=r-this._lastTime,i=this._currTime+=a*this.scale;for(e in this._lastTime=r,this._tweenDic)(t=this._tweenDic[e])._updateEase(i);if(0!=this._tweenDataList.length&&this._index<this._tweenDataList.length){var s=this._tweenDataList[this._index];i>=s.startTime&&(this._index++,0==s.type?(this._gidIndex++,(t=Pool.getItemByClass("tween",Tween))._create(s.target,s.data,s.duration,s.ease,Handler.create(this,this._animComplete,[this._gidIndex]),0,!1,s.isTo,!0,!1),t.setStartTime(i),t.gid=this._gidIndex,this._tweenDic[this._gidIndex]=t,t._updateEase(i)):this.event(Event.LABEL,s.data))}}_animComplete(e){this._tweenDic[e]&&delete this._tweenDic[e]}_complete(){this.event(Event.COMPLETE)}get index(){return this._frameIndex}set index(e){this._frameIndex=e,this.gotoTime(this._frameIndex/this._frameRate*1e3)}get total(){return this._total=Math.floor(this._startTime/1e3*this._frameRate),this._total}reset(){var e,t,r;if(this._labelDic)for(e in this._labelDic)delete this._labelDic[e];for(e in this._tweenDic)this._tweenDic[e].clear(),delete this._tweenDic[e];for(e in this._firstTweenDic)delete this._firstTweenDic[e];if(this._endTweenDataList=null,this._tweenDataList&&this._tweenDataList.length)for(r=this._tweenDataList.length,t=0;t<r;t++)this._tweenDataList[t]&&this._tweenDataList[t].destroy();this._tweenDataList.length=0,this._currTime=0,this._lastTime=0,this._startTime=0,this._index=0,this._gidIndex=0,this.scale=1,ILaya.timer.clear(this,this._update)}destroy(){this.reset(),this._labelDic=null,this._tweenDic=null,this._tweenDataList=null,this._firstTweenDic=null}}class tweenData{constructor(){this.type=0,this.isTo=!0}destroy(){this.target=null,this.ease=null,this.data=null,this.isTo=!0,this.type=0,Pool.recover("tweenData",this)}}class DrawParticleCmd{static create(e){var t=Pool.getItemByClass("DrawParticleCmd",DrawParticleCmd);return t._templ=e,t}recover(){this._templ=null,Pool.recover("DrawParticleCmd",this)}run(e,t,r){e.drawParticle(t,r,this._templ)}get cmdID(){return DrawParticleCmd.ID}}DrawParticleCmd.ID="DrawParticleCmd";class NativeCommandUniformMap extends CommandUniformMap{constructor(e,t){super(t),this._nativeObj=e}hasPtrID(e){return this._nativeObj.hasPtrID(e)}getMap(){return this._idata}addShaderUniform(e,t){this._nativeObj.addShaderUniform(e,t)}}class NativeGLObject{constructor(e){this._destroyed=!1,this._engine=e,this._gl=this._engine.gl,this._id=this._engine._IDCounter++}get destroyed(){return this._destroyed}setResourceManager(){}destroy(){this._destroyed||(this._destroyed=!0)}}class NativeGLTextureContext extends NativeGLObject{constructor(e,t){super(e),this._native=t,this.needBitmap=!1}createTextureInternal(e,t,r,a,i,s){return this._native.createTextureInternal(e,t,r,a,i,s)}setTextureImageData(e,t,r,a){this._native.setTextureImageData(e,t._nativeObj.conchImgId,r,a)}setTexturePixelsData(e,t,r,a){this._native.setTexturePixelsData(e,t,r,a)}initVideoTextureData(e){this._native.initVideoTextureData(e)}setTextureSubPixelsData(e,t,r,a,i,s,n,o,l,h){this._native.setTextureSubPixelsData(e,t,r,a,i,s,n,o,l,h)}setTextureSubImageData(e,t,r,a,i,s){throw new Error("setTextureSubImageData Method not implemented.")}setTexture3DImageData(e,t,r,a,i){this._native.setTexture3DImageData(e,t.map((function(e){return e._nativeObj})),r,a,i)}setTexture3DPixlesData(e,t,r,a,i){this._native.setTexture3DPixlesData(e,t,r,a,i)}setTexture3DSubPixelsData(e,t,r,a,i,s,n,o,l,h,u,d){this._native.setTexture3DSubPixelsData(e,t,r,a,i,s,n,o,l,h,u,d)}setTextureHDRData(e,t){throw t.readScanLine(),new Error("setTextureHDRData Method not implemented.")}setTextureDDSData(e,t){this._native.setTextureKTXData(e,t)}setTextureKTXData(e,t){this._native.setTextureKTXData(e,t)}setCubeImageData(e,t,r,a){var i=[],s=t.length;for(let e=0;e<s;e++)i.push(t[e]._nativeObj);this._native.setCubeImageData(e,i,r,a)}setCubePixelsData(e,t,r,a){this._native.setCubePixelsData(e,t,r,a)}setCubeSubPixelData(e,t,r,a,i,s,n,o,l,h){this._native.setCubeSubPixelData(e,t,r,a,i,s,n,o,l,h)}setCubeDDSData(e,t){this._native.setCubeDDSData(e,t)}setCubeKTXData(e,t){this._native.setCubeKTXData(e,t)}setTextureCompareMode(e,t){return this._native.setTextureCompareMode(e,t)}bindRenderTarget(e,t=0){this._native.bindRenderTarget(e,t)}bindoutScreenTarget(){this._native.bindoutScreenTarget()}unbindRenderTarget(e){this._native.unbindRenderTarget(e)}createRenderTextureInternal(e,t,r,a,i,s){return this._native.createRenderTextureInternal(e,t,r,a,i,s)}createRenderTargetInternal(t,r,a,i,s,n,o){return this._native.createRenderTargetInternal(t,r,a,i||e.RenderTargetFormat.None,s,n,o)}createRenderTargetCubeInternal(e,t,r,a,i,s){return this._native.createRenderTargetCubeInternal(e,t,r,a,i,s)}createRenderTextureCubeInternal(e,t,r,a,i){throw new Error("createRenderTextureCubeInternal Method not implemented.")}setupRendertargetTextureAttachment(e,t){this._native.setupRendertargetTextureAttachment(e,t)}readRenderTargetPixelData(e,t,r,a,i,s){return this._native.readRenderTargetPixelData(e,t,r,a,i,s)}updateVideoTexture(e,t,r,a){this._native.updateVideoTexture(e,t._nativeObj.conchImgId,r,a)}getRenderTextureData(e,t,r,a,i){return this._native.getRenderTextureData(e,t,r,a,i)}}class NativeGL2TextureContext extends NativeGLTextureContext{constructor(e,t){super(e,t)}}class NativeGLRenderDrawContext extends NativeGLObject{constructor(e){super(e),this._nativeObj=new window.conchGLRenderDrawContext(e._nativeObj)}drawElementsInstanced(e,t,r,a,i){this._nativeObj.drawElementsInstanced(e,t,r,a,i)}drawArraysInstanced(e,t,r,a){this._nativeObj.drawArraysInstanced(e,t,r,a)}drawArrays(e,t,r){this._nativeObj.drawArrays(e,t,r)}drawElements(e,t,r,a){this._nativeObj.drawElements(e,t,r,a)}drawElements2DTemp(e,t,r,a){}drawGeometryElement(e){this._nativeObj.drawGeometryElement(e._nativeObj)}}class NativeRenderStateCommand extends RenderStateCommand{constructor(){super(),this._nativeObj=new window.conchRenderStateCommand}addCMD(t,r){switch(t){case e.RenderStateType.DepthTest:case e.RenderStateType.DepthMask:case e.RenderStateType.DepthFunc:case e.RenderStateType.StencilTest:case e.RenderStateType.StencilMask:case e.RenderStateType.BlendEquation:case e.RenderStateType.CullFace:case e.RenderStateType.FrontFace:this._nativeObj.addCMDInt1(t,r);break;case e.RenderStateType.StencilFunc:case e.RenderStateType.BlendFunc:case e.RenderStateType.BlendEquationSeparate:this._nativeObj.addCMDInt2(t,r[0],r[1]);break;case e.RenderStateType.StencilOp:this._nativeObj.addCMDInt3(t,r[0],r[1],r[2]);break;case e.RenderStateType.BlendType:this._nativeObj.addCMDInt1(t,r!=e.BlendType.BLEND_DISABLE?1:0);break;case e.RenderStateType.BlendFuncSeperate:this._nativeObj.addCMDInt4(t,r[0],r[1],r[2],r[3]);break;default:throw"unknow type of renderStateType"}}applyCMD(){LayaGL.renderEngine.applyRenderStateCMD(this)}clear(){this._nativeObj.clear()}}class NativeRenderState{set cull(e){this._nativeObj.cull=e}get cull(){return this._nativeObj.cull}set blend(e){this._nativeObj.blend=e}get blend(){return this._nativeObj.blend}set srcBlend(e){this._nativeObj.srcBlend=e}get srcBlend(){return this._nativeObj.srcBlend}set dstBlend(e){this._nativeObj.dstBlend=e}get dstBlend(){return this._nativeObj.dstBlend}set srcBlendRGB(e){this._nativeObj.srcBlendRGB=e}get srcBlendRGB(){return this._nativeObj.srcBlendRGB}set dstBlendRGB(e){this._nativeObj.dstBlendRGB=e}get dstBlendRGB(){return this._nativeObj.dstBlendRGB}set srcBlendAlpha(e){this._nativeObj.srcBlendAlpha=e}get srcBlendAlpha(){return this._nativeObj.srcBlendAlpha}set dstBlendAlpha(e){this._nativeObj.dstBlendAlpha=e}get dstBlendAlpha(){return this._nativeObj.dstBlendAlpha}set blendEquation(e){this._nativeObj.blendEquation=e}get blendEquation(){return this._nativeObj.blendEquation}set blendEquationRGB(e){this._nativeObj.blendEquationRGB=e}get blendEquationRGB(){return this._nativeObj.blendEquationRGB}set blendEquationAlpha(e){this._nativeObj.blendEquationAlpha=e}get blendEquationAlpha(){return this._nativeObj.blendEquationAlpha}set depthTest(e){this._nativeObj.depthTest=e}get depthTest(){return this._nativeObj.depthTest}set depthWrite(e){this._nativeObj.depthWrite=e}get depthWrite(){return this._nativeObj.depthWrite}set stencilWrite(e){this._nativeObj.stencilWrite=e}get stencilWrite(){return this._nativeObj.stencilWrite}set stencilTest(e){this._nativeObj.stencilTest=e}get stencilTest(){return this._nativeObj.stencilTest}set stencilRef(e){this._nativeObj.stencilRef=e}get stencilRef(){return this._nativeObj.stencilRef}set stencilOp(e){this._nativeObj.setStencilOp(e.x,e.y,e.z)}setNull(){this._nativeObj.setNull()}constructor(){this._nativeObj=new window.conchRenderState}}var Ht,Wt,Xt,Yt;e.MemoryDataType=void 0,(Ht=e.MemoryDataType||(e.MemoryDataType={}))[Ht.ShaderData=0]="ShaderData",Ht[Ht.TextureData=1]="TextureData",Ht[Ht.VertexData=2]="VertexData",Ht[Ht.IndexData=3]="IndexData",Ht[Ht.BaseRenderData=4]="BaseRenderData";class CommonMemoryAllocater{static creatBlock(e){return new ArrayBuffer(e)}static freeMemoryBlock(e){}}class NativeMemory{constructor(e,t){if(t){if(e>NativeMemory._sharedBuffer.byteLength)throw new Error("NativeMemory:shared buffer not enough");this._buffer=NativeMemory._sharedBuffer}else this._buffer=CommonMemoryAllocater.creatBlock(e);this._idata=new Int32Array(this._buffer),this._fdata=new Float32Array(this._buffer),this._f64data=new Float64Array(this._buffer),this._byteArray=new Uint8Array(this._buffer),this._byteLength=e}get float32Array(){return this._fdata}get float64Array(){return this._f64data}get uint8Array(){return this._byteArray}get int32Array(){return this._idata}destroy(){this._destroyed||(this.clear(),CommonMemoryAllocater.freeMemoryBlock(this._buffer),this._destroyed=!0)}clear(){this._idata=null,this._fdata=null,this._byteArray=null}}NativeMemory.NativeSourceID=0,NativeMemory._sharedBuffer=new ArrayBuffer(256);class UploadMemory extends NativeMemory{constructor(e){super(e,!1),this._currentOffsetInByte=0}addBlockCell(e,t){e.uploadDataTOShareMemory(this,this._currentOffsetInByte)&&(this._currentOffsetInByte+=t)}check(e){return this._currentOffsetInByte+e<this._byteLength}clear(){this._currentOffsetInByte=0}}class UploadMemoryManager{constructor(){this._dataNodeList=new SingletonList,this._commandNums=0,this._currentBlock=new UploadMemory(UploadMemoryManager.UploadMemorySize),this._conchUploadMemoryManager=new window.conchUploadMemoryManager}static getInstance(){return UploadMemoryManager._instance||(UploadMemoryManager._instance=new UploadMemoryManager),UploadMemoryManager._instance}_addNodeCommand(e,t){this._currentBlock.addBlockCell(e,t),this._commandNums++}static syncRenderMemory(){UploadMemoryManager.getInstance()._serialiseData(),UploadMemoryManager.getInstance().clear()}_serialiseData(){const e=this._dataNodeList.elements;for(let t=0;t<this._dataNodeList.length;t++){let r=e[t],a=r.getUploadMemoryLength();if(a>UploadMemoryManager.UploadMemorySize)throw"dataSize is too large, greater than UploadMemorySize,";this._currentBlock.check(a)?(this.uploadData(),this._addNodeCommand(r,a)):this._addNodeCommand(r,a)}this.uploadData()}uploadData(){this._commandNums>0&&(this._conchUploadMemoryManager.uploadData(this._currentBlock._buffer,this._commandNums),this._commandNums=0,this._currentBlock.clear())}clear(){this._dataNodeList.length=0}}UploadMemoryManager.UploadMemorySize=1048576,UploadMemoryManager._instance=null,e.NativeShaderDataType=void 0,(Wt=e.NativeShaderDataType||(e.NativeShaderDataType={}))[Wt.Number32=0]="Number32",Wt[Wt.Vector2=1]="Vector2",Wt[Wt.Vector3=2]="Vector3",Wt[Wt.Vector4=3]="Vector4",Wt[Wt.Matrix4x4=4]="Matrix4x4",Wt[Wt.Number32Array=5]="Number32Array",Wt[Wt.Texture=6]="Texture",Wt[Wt.ShaderDefine=7]="ShaderDefine",Wt[Wt.UBO=8]="UBO";class NativeShaderData extends ShaderData{constructor(t=null){super(t),this.inUploadList=!1,this.payload32bitNum=0,this._initData(),this._nativeObj=new window.conchShaderData,this._nativeObj.setApplyUBOData(this.applyUBOData.bind(this)),this.nativeObjID=this._nativeObj.nativeID,this._dataType=e.MemoryDataType.ShaderData,this.updateMap=new Map,this.updataSizeMap=new Map}getUploadMemoryLength(){return this.updataSizeMap.forEach((e=>{this.payload32bitNum+=e})),4*(this.payload32bitNum+4)}uploadDataTOShareMemory(t,r){if(!this._data)return!1;let a=t.int32Array,i=r/4;return a[i++]=e.MemoryDataType.ShaderData,a[i++]=this.nativeObjID,a[i++]=this.payload32bitNum,a[i++]=this.updateMap.size,this.updateMap.forEach(((e,r)=>{i+=e.call(this,r,t,i)})),this.clearUpload(),this.inUploadList=!1,!0}clearUpload(){this.payload32bitNum=0,this.updataSizeMap.clear(),this.updateMap.clear()}applyUBOData(){this._uniformBufferDatas&&super.applyUBOData()}compressNumber(t,r,a){return r.int32Array[a]=t,r.int32Array[a+1]=e.NativeShaderDataType.Number32,r.float32Array[a+2]=this._data[t],3}compressVector2(t,r,a){r.int32Array[a]=t,r.int32Array[a+1]=e.NativeShaderDataType.Vector2;var i=this._data[t];return r.float32Array[a+2]=i.x,r.float32Array[a+3]=i.y,4}compressVector3(t,r,a){r.int32Array[a]=t,r.int32Array[a+1]=e.NativeShaderDataType.Vector3;var i=this._data[t];return r.float32Array[a+2]=i.x,r.float32Array[a+3]=i.y,r.float32Array[a+4]=i.z,5}compressVector4(t,r,a){r.int32Array[a]=t,r.int32Array[a+1]=e.NativeShaderDataType.Vector4;var i=this._data[t];return r.float32Array[a+2]=i.x,r.float32Array[a+3]=i.y,r.float32Array[a+4]=i.z,r.float32Array[a+5]=i.w,6}compressMatrix4x4(t,r,a){r.int32Array[a]=t,r.int32Array[a+1]=e.NativeShaderDataType.Matrix4x4;var i=this._data[t];return r.float32Array.set(i.elements,a+2),18}compressNumberArray(t,r,a){r.int32Array[a]=t,r.int32Array[a+1]=e.NativeShaderDataType.Number32Array;var i=this._data[t];return r.int32Array[a+2]=i.length,r.float32Array.set(i,a+3),i.length+3}compressTexture(t,r,a){var i=this._data[t];return r.int32Array[a]=t,r.int32Array[a+1]=e.NativeShaderDataType.Texture,i&&i instanceof Texture?r.int32Array[a+2]=i.bitmap._texture.id:i&&i._texture?r.int32Array[a+2]=i._texture.id:r.int32Array[a+2]=Texture2D.errorTexture._texture.id,3}compressUBO(t,r,a){var i=this._data[t];return r.int32Array[a]=t,r.int32Array[a+1]=e.NativeShaderDataType.UBO,r.int32Array[a+2]=i._conchUniformBufferObject.nativeID,3}configMotionProperty(e,t,r){this.updateMap.set(e,r),this.updataSizeMap.set(e,t),this.inUploadList||(this.inUploadList=!0,UploadMemoryManager.getInstance()._dataNodeList.add(this))}setBool(e,t){super.setBool(e,t),this.configMotionProperty(e,3,this.compressNumber)}setInt(e,t){super.setInt(e,t),this.configMotionProperty(e,3,this.compressNumber)}setNumber(e,t){super.setNumber(e,t),this.configMotionProperty(e,3,this.compressNumber)}setVector2(e,t){super.setVector2(e,t),this.configMotionProperty(e,4,this.compressVector2)}setVector3(e,t){super.setVector3(e,t),this.configMotionProperty(e,5,this.compressVector3)}setVector(e,t){super.setVector(e,t),this.configMotionProperty(e,6,this.compressVector4)}setColor(e,t){super.setColor(e,t),this.configMotionProperty(e,6,this.compressVector4)}setMatrix4x4(e,t){super.setMatrix4x4(e,t),this.configMotionProperty(e,18,this.compressMatrix4x4)}setBuffer(e,t){super.setBuffer(e,t),this.configMotionProperty(e,3+t.length,this.compressNumberArray)}setTexture(e,t){super.setTexture(e,t),this.configMotionProperty(e,3,this.compressTexture)}setUniformBuffer(e,t){this._data[e]=t,this.configMotionProperty(e,3,this.compressUBO)}setValueData(e,t){"boolean"==typeof t?this.setBool(e,t):"number"==typeof t?this.setNumber(e,t):t instanceof Color?this.setColor(e,t):t instanceof Vector2?this.setVector2(e,t):t instanceof Vector3?this.setVector3(e,t):t instanceof Vector4||t instanceof Quaternion?this.setVector(e,t):t instanceof Matrix4x4?this.setMatrix4x4(e,t):null!=t.ArrayBuffer?this.setBuffer(e,t):null!=t._texture&&this.setTexture(e,t)}cloneTo(e){var t=e;for(var r in this._data){var a=this._data[r];null!=a&&("boolean"==typeof a?e.setBool(r,a):"number"==typeof a?e.setNumber(r,a):a instanceof Vector2?e.setVector2(r,a):a instanceof Vector3?e.setVector3(r,a):a instanceof Vector4?e.setVector(r,a):a instanceof Matrix4x4?e.setMatrix4x4(r,a):a instanceof BaseTexture&&e.setTexture(r,a))}this._defineDatas.cloneTo(t._defineDatas),this._gammaColorMap.forEach(((t,r)=>{e._gammaColorMap.set(r,t.clone())}))}clone(){var e=new NativeShaderData;return this.cloneTo(e),e}destroy(){super.destroy(),this._nativeObj.destroy(),this._nativeObj=null}}class NativeUniformBufferObject extends UniformBufferObject{constructor(e,t,r,a,i){super(e,t,r,a,i),this._conchUniformBufferObject=null,this._conchUniformBufferObject=new window.conchUniformBufferObject(LayaGL.renderEngine._nativeObj,e),this._conchUniformBufferObject.setGLBuffer(this._glBuffer)}}class NativeGLVertexState extends NativeGLObject{constructor(e){super(e),this._vertexDeclaration=[],this._nativeObj=new window.conchGLVertexState(e._nativeObj),this._nativeVertexBuffers=[]}bindVertexArray(){this._nativeObj.bindVertexArray()}unbindVertexArray(){this._nativeObj.unbindVertexArray()}applyVertexBuffer(e){this._vertexBuffers=e,this._nativeVertexBuffers.length=0,e.forEach((e=>{this._nativeVertexBuffers.push(e._conchVertexBuffer3D)})),this._nativeObj.applyVertexBuffer(this._nativeVertexBuffers)}applyIndexBuffer(e){null!=e&&(this._bindedIndexBuffer=e,this._nativeObj.applyIndexBuffer(e._conchIndexBuffer3D))}destroy(){this._vertexBuffers=null,this._nativeVertexBuffers=[],this._bindedIndexBuffer=null,super.destroy(),this._nativeObj.destroy()}}e.WebGLMode=void 0,(Xt=e.WebGLMode||(e.WebGLMode={}))[Xt.Auto=0]="Auto",Xt[Xt.WebGL2=1]="WebGL2",Xt[Xt.WebGL1=2]="WebGL1";e.WebGLExtension=void 0,(Yt=e.WebGLExtension||(e.WebGLExtension={}))[Yt.OES_vertex_array_object=0]="OES_vertex_array_object",Yt[Yt.ANGLE_instanced_arrays=1]="ANGLE_instanced_arrays",Yt[Yt.OES_texture_half_float=2]="OES_texture_half_float",Yt[Yt.OES_texture_half_float_linear=3]="OES_texture_half_float_linear",Yt[Yt.OES_texture_float=4]="OES_texture_float",Yt[Yt.OES_element_index_uint=5]="OES_element_index_uint",Yt[Yt.OES_texture_float_linear=6]="OES_texture_float_linear",Yt[Yt.EXT_color_buffer_half_float=7]="EXT_color_buffer_half_float",Yt[Yt.EXT_shader_texture_lod=8]="EXT_shader_texture_lod",Yt[Yt.WEBGL_depth_texture=9]="WEBGL_depth_texture",Yt[Yt.EXT_sRGB=10]="EXT_sRGB",Yt[Yt.EXT_color_buffer_float=11]="EXT_color_buffer_float",Yt[Yt.EXT_texture_filter_anisotropic=12]="EXT_texture_filter_anisotropic",Yt[Yt.WEBGL_compressed_texture_s3tc=13]="WEBGL_compressed_texture_s3tc",Yt[Yt.WEBGL_compressed_texture_s3tc_srgb=14]="WEBGL_compressed_texture_s3tc_srgb",Yt[Yt.WEBGL_compressed_texture_pvrtc=15]="WEBGL_compressed_texture_pvrtc",Yt[Yt.WEBGL_compressed_texture_etc1=16]="WEBGL_compressed_texture_etc1",Yt[Yt.WEBGL_compressed_texture_etc=17]="WEBGL_compressed_texture_etc",Yt[Yt.WEBGL_compressed_texture_astc=18]="WEBGL_compressed_texture_astc",Yt[Yt.OES_standard_derivatives=19]="OES_standard_derivatives";class GLObject{constructor(e){this._destroyed=!1,this._engine=e,this._gl=this._engine.gl,this._id=this._engine._IDCounter++}get destroyed(){return this._destroyed}destroy(){this._destroyed||(this._destroyed=!0)}}class WebGLInternalTex extends GLObject{get mipmap(){return this._mipmap}get mipmapCount(){return this._mipmapCount}get gpuMemory(){return this._gpuMemory}set gpuMemory(t){this._engine._addStatisticsInfo(e.RenderStatisticsInfo.GPUMemory,-this._gpuMemory),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.TextureMemeory,-this._gpuMemory),this._gpuMemory=t,this._engine._addStatisticsInfo(e.RenderStatisticsInfo.GPUMemory,this._gpuMemory),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.TextureMemeory,this._gpuMemory)}constructor(t,r,a,i,s,n,o,l,h){super(t),this._gpuMemory=0,this._baseMipmapLevel=0,this._maxMipmapLevel=0,this.resource=this._gl.createTexture(),this.width=a,this.height=i,this.depth=s;const isPot=e=>0==(e&e-1);this.isPotSize=isPot(a)&&isPot(i),n==e.TextureDimension.Tex3D&&(this.isPotSize=this.isPotSize&&isPot(this.depth)),this._mipmap=o&&this.isPotSize,this._mipmapCount=this._mipmap?Math.max(Math.ceil(Math.log2(a))+1,Math.ceil(Math.log2(i))+1):1,this._maxMipmapLevel=this._mipmapCount-1,this._baseMipmapLevel=0,this.useSRGBLoad=l,this.gammaCorrection=h,this.target=r,this.filterMode=e.FilterMode.Bilinear,this.wrapU=e.WrapMode.Repeat,this.wrapV=e.WrapMode.Repeat,this.wrapW=e.WrapMode.Repeat,this.anisoLevel=4,this.compareMode=e.TextureCompareMode.None}get filterMode(){return this._filterMode}set filterMode(e){if(this._filterMode!=e&&this.resource){let t=this._gl,r=this.mipmap,a=this.getFilteMinrParam(e,r);this._setTexParameteri(t.TEXTURE_MIN_FILTER,a);let i=this.getFilterMagParam(e);this._setTexParameteri(t.TEXTURE_MAG_FILTER,i),this._filterMode=e}}get wrapU(){return this._warpU}set wrapU(e){if(this._warpU!=e&&this.resource){let t=this._gl,r=this.getWrapParam(e);this._setWrapMode(t.TEXTURE_WRAP_S,r),this._warpU=e}}get wrapV(){return this._warpV}set wrapV(e){if(this._warpV!=e&&this.resource){let t=this._gl,r=this.getWrapParam(e);this._setWrapMode(t.TEXTURE_WRAP_T,r),this._warpV=e}}get wrapW(){return this._warpW}set wrapW(t){if(this._warpW!=t&&this.resource){if(this._engine.getCapable(e.RenderCapable.Texture3D)){let e=this._gl,r=this.getWrapParam(t);this._setWrapMode(e.TEXTURE_WRAP_R,r)}this._warpW=t}}get anisoLevel(){return this._anisoLevel}set anisoLevel(t){let r=this._engine._supportCapatable.getExtension(e.WebGLExtension.EXT_texture_filter_anisotropic);if(r){this._gl;let a=this._engine.getParams(e.RenderParams.Max_AnisoLevel_Count),i=Math.max(1,Math.min(a,t));this._setTexParametexf(r.TEXTURE_MAX_ANISOTROPY_EXT,i),this._anisoLevel=i}else this._anisoLevel=1}set baseMipmapLevel(e){this._engine.isWebGL2&&this._setTexParameteri(this._gl.TEXTURE_BASE_LEVEL,e),this._baseMipmapLevel=e}get baseMipmapLevel(){return this._baseMipmapLevel}set maxMipmapLevel(e){this._engine.isWebGL2&&this._setTexParameteri(this._gl.TEXTURE_MAX_LEVEL,e),this._maxMipmapLevel=e}get maxMipmapLevel(){return this._maxMipmapLevel}get compareMode(){return this._compareMode}set compareMode(e){this._compareMode=e}_setTexParameteri(e,t){let r=this._gl,a=this.target;this._engine._bindTexture(a,this.resource),r.texParameteri(a,e,t),this._engine._bindTexture(a,null)}_setTexParametexf(e,t){let r=this._gl,a=this.target;this._engine._bindTexture(a,this.resource),r.texParameterf(a,e,t),this._engine._bindTexture(a,null)}getFilteMinrParam(t,r){let a=this._gl;switch(t){case e.FilterMode.Point:return r?a.NEAREST_MIPMAP_NEAREST:a.NEAREST;case e.FilterMode.Bilinear:return r?a.LINEAR_MIPMAP_NEAREST:a.LINEAR;case e.FilterMode.Trilinear:return r?a.LINEAR_MIPMAP_LINEAR:a.LINEAR;default:return r?a.LINEAR_MIPMAP_NEAREST:a.LINEAR}}getFilterMagParam(t){let r=this._gl;switch(t){case e.FilterMode.Point:return r.NEAREST;case e.FilterMode.Bilinear:case e.FilterMode.Trilinear:default:return r.LINEAR}}getWrapParam(t){let r=this._gl;switch(t){case e.WrapMode.Repeat:return r.REPEAT;case e.WrapMode.Clamp:return r.CLAMP_TO_EDGE;case e.WrapMode.Mirrored:return r.MIRRORED_REPEAT;default:return r.REPEAT}}_setWrapMode(e,t){let r=this._gl;this.isPotSize||(t=r.CLAMP_TO_EDGE),this._setTexParameteri(e,t)}dispose(){this._gl.deleteTexture(this.resource),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.GPUMemory,-this._gpuMemory),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.TextureMemeory,-this._gpuMemory),this._gpuMemory=0}}class WebGLInternalRT extends GLObject{get gpuMemory(){return this._gpuMemory}set gpuMemory(t){this._gpuMemory=t,this._engine._addStatisticsInfo(e.RenderStatisticsInfo.GPUMemory,this._gpuMemory),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.RenderTextureMemory,this._gpuMemory)}constructor(e,t,r,a,i,s){super(e),this._gpuMemory=0,this.colorFormat=t,this.depthStencilFormat=r,this._isCube=a,this._generateMipmap=i,this._samples=s,this._textures=[],this._depthTexture=null,this._framebuffer=this._gl.createFramebuffer(),s>1&&(this._msaaFramebuffer=this._gl.createFramebuffer())}dispose(){this._textures.forEach((e=>{e&&e.dispose()})),this._textures=null,this._depthTexture&&this._depthTexture.dispose(),this._depthTexture=null,this._framebuffer&&this._gl.deleteFramebuffer(this._framebuffer),this._framebuffer=null,this._depthbuffer&&this._gl.deleteRenderbuffer(this._depthbuffer),this._depthbuffer=null,this._msaaFramebuffer&&this._gl.deleteFramebuffer(this._msaaFramebuffer),this._msaaFramebuffer=null,this._msaaRenderbuffer&&this._gl.deleteRenderbuffer(this._msaaRenderbuffer),this._msaaRenderbuffer=null,this._engine._addStatisticsInfo(e.RenderStatisticsInfo.GPUMemory,-this._gpuMemory),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.RenderTextureMemory,-this._gpuMemory),this._gpuMemory=0}}class GLTextureContext extends GLObject{constructor(t){super(t),this._glParam={internalFormat:0,format:0,type:0},this.needBitmap=!1,this._sRGB=this._engine._supportCapatable.getExtension(e.WebGLExtension.EXT_sRGB),this._oesTextureHalfFloat=this._engine._supportCapatable.getExtension(e.WebGLExtension.OES_texture_half_float),this._compressdTextureS3tc_srgb=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_compressed_texture_s3tc_srgb),this._compressedTextureEtc1=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_compressed_texture_etc1),this._compressedTextureS3tc=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_compressed_texture_s3tc),this._compressedTextureETC=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_compressed_texture_etc),this._compressedTextureASTC=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_compressed_texture_astc),this._webgl_depth_texture=this._engine._supportCapatable.getExtension(e.WebGLExtension.WEBGL_depth_texture)}glTextureParam(t,r){let a=this._gl;switch(this._glParam.internalFormat=null,this._glParam.format=null,this._glParam.type=null,t){case e.TextureFormat.R8G8B8:this._glParam.internalFormat=r?this._sRGB.SRGB_EXT:a.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case e.TextureFormat.R8G8B8A8:this._glParam.internalFormat=r?this._sRGB.SRGB_ALPHA_EXT:a.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case e.TextureFormat.R5G6B5:this._glParam.internalFormat=a.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_SHORT_5_6_5;break;case e.TextureFormat.R32G32B32A32:this._glParam.internalFormat=a.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.FLOAT;break;case e.TextureFormat.R32G32B32:this._glParam.internalFormat=a.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.FLOAT;break;case e.TextureFormat.R16G16B16A16:this._glParam.internalFormat=a.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._oesTextureHalfFloat.HALF_FLOAT_OES;break;case e.TextureFormat.R16G16B16:this._glParam.internalFormat=a.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._oesTextureHalfFloat.HALF_FLOAT_OES;break;case e.TextureFormat.DXT1:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT1_EXT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case e.TextureFormat.DXT3:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT3_EXT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case e.TextureFormat.DXT5:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT5_EXT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case e.TextureFormat.ETC1RGB:this._glParam.internalFormat=this._compressedTextureEtc1.COMPRESSED_RGB_ETC1_WEBGL,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case e.TextureFormat.ETC2RGBA:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGBA8_ETC2_EAC,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case e.TextureFormat.ETC2RGB:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGB8_ETC2,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case e.TextureFormat.ETC2SRGB:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_ETC2,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case e.TextureFormat.ETC2SRGB_Alpha8:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case e.TextureFormat.ASTC4x4:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_4x4_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case e.TextureFormat.ASTC6x6:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_6x6_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case e.TextureFormat.ASTC8x8:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_8x8_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case e.TextureFormat.ASTC10x10:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_10x10_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case e.TextureFormat.ASTC12x12:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_12x12_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case e.TextureFormat.ASTC4x4SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case e.TextureFormat.ASTC6x6SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case e.TextureFormat.ASTC8x8SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case e.TextureFormat.ASTC10x10SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case e.TextureFormat.ASTC12x12SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;default:throw"Unknown Texture Format."}return this._glParam}glRenderTextureParam(t,r){let a=this._gl;switch(this._glParam.internalFormat=null,this._glParam.format=null,this._glParam.type=null,t){case e.RenderTargetFormat.R8G8B8:this._glParam.internalFormat=r?this._sRGB.SRGB_EXT:a.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case e.RenderTargetFormat.R8G8B8A8:this._glParam.internalFormat=r?this._sRGB.SRGB_EXT:a.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_BYTE;break;case e.RenderTargetFormat.R16G16B16:this._glParam.internalFormat=a.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._oesTextureHalfFloat.HALF_FLOAT_OES;break;case e.RenderTargetFormat.R16G16B16A16:this._glParam.internalFormat=a.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._oesTextureHalfFloat.HALF_FLOAT_OES;break;case e.RenderTargetFormat.R32G32B32:this._glParam.internalFormat=a.RGB,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.FLOAT;break;case e.RenderTargetFormat.R32G32B32A32:this._glParam.internalFormat=a.RGBA,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.FLOAT;break;case e.RenderTargetFormat.DEPTH_16:this._glParam.internalFormat=a.DEPTH_COMPONENT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_SHORT;break;case e.RenderTargetFormat.DEPTHSTENCIL_24_8:this._glParam.internalFormat=a.DEPTH_STENCIL,this._glParam.format=this._glParam.internalFormat,this._glParam.type=this._webgl_depth_texture.UNSIGNED_INT_24_8_WEBGL;break;case e.RenderTargetFormat.DEPTH_32:this._glParam.internalFormat=a.DEPTH_COMPONENT,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_INT;break;case e.RenderTargetFormat.STENCIL_8:default:throw"render texture format wrong."}return this._glParam}glRenderBufferParam(t,r){let a=this._gl;switch(t){case e.RenderTargetFormat.DEPTH_16:return{internalFormat:a.DEPTH_COMPONENT16,attachment:a.DEPTH_ATTACHMENT};case e.RenderTargetFormat.DEPTHSTENCIL_24_8:return{internalFormat:a.DEPTH_STENCIL,attachment:a.DEPTH_STENCIL_ATTACHMENT};case e.RenderTargetFormat.DEPTH_32:return{internalFormat:a.DEPTH_STENCIL,attachment:a.DEPTH_ATTACHMENT};case e.RenderTargetFormat.STENCIL_8:return{internalFormat:a.STENCIL_INDEX8,attachment:a.STENCIL_ATTACHMENT};default:return null}}glRenderTargetAttachment(t){let r=this._gl;switch(t){case e.RenderTargetFormat.DEPTH_16:return r.DEPTH_ATTACHMENT;case e.RenderTargetFormat.DEPTHSTENCIL_24_8:return r.DEPTH_STENCIL_ATTACHMENT;case e.RenderTargetFormat.DEPTH_32:return r.DEPTH_ATTACHMENT;case e.RenderTargetFormat.STENCIL_8:return r.STENCIL_ATTACHMENT;case e.RenderTargetFormat.R8G8B8:case e.RenderTargetFormat.R8G8B8A8:case e.RenderTargetFormat.R16G16B16:case e.RenderTargetFormat.R16G16B16A16:case e.RenderTargetFormat.R32G32B32:case e.RenderTargetFormat.R32G32B32A32:return r.COLOR_ATTACHMENT0;default:throw"render format."}}getTarget(t){let r=this._gl;switch(t){case e.TextureDimension.Tex2D:return r.TEXTURE_2D;case e.TextureDimension.Cube:return r.TEXTURE_CUBE_MAP;default:throw"texture dimension wrong in WebGL1."}}getFormatPixelsParams(t){let r={channels:0,bytesPerPixel:0,dataTypedCons:Uint8Array,typedSize:1};switch(t){case e.TextureFormat.R8G8B8A8:return r.channels=4,r.bytesPerPixel=4,r.dataTypedCons=Uint8Array,r.typedSize=1,r;case e.TextureFormat.R8G8B8:return r.channels=3,r.bytesPerPixel=3,r.dataTypedCons=Uint8Array,r.typedSize=1,r;case e.TextureFormat.R5G6B5:return r.channels=3,r.bytesPerPixel=2,r.dataTypedCons=Uint16Array,r.typedSize=2,r;case e.TextureFormat.R16G16B16:return r.channels=3,r.bytesPerPixel=6,r.dataTypedCons=Uint16Array,r.typedSize=2,r;case e.TextureFormat.R16G16B16A16:return r.channels=4,r.bytesPerPixel=8,r.dataTypedCons=Uint16Array,r.typedSize=2,r;case e.TextureFormat.R32G32B32:return r.channels=3,r.bytesPerPixel=12,r.dataTypedCons=Float32Array,r.typedSize=4,r;case e.TextureFormat.R32G32B32A32:return r.channels=4,r.bytesPerPixel=16,r.dataTypedCons=Float32Array,r.typedSize=4,r;default:return r}}getGLtexMemory(e,t=1){let r=this._gl,a=0,i=0,s=0,n=this._sRGB?this._sRGB.SRGB_EXT:r.RGB,o=this._sRGB?this._sRGB.SRGB_ALPHA_EXT:r.RGBA;switch(e.internalFormat){case n:case r.RGB:a=3;break;case o:case r.RGBA:a=4;break;default:a=0}switch(e.type){case r.UNSIGNED_BYTE:i=1;break;case r.UNSIGNED_SHORT_5_6_5:i=2/3;break;case r.FLOAT:i=4;break;case this._oesTextureHalfFloat.HALF_FLOAT_OES:i=2;break;default:i=0}return s=a*i*e.width*e.height,e.mipmap&&(s*=1.333),e.target==r.TEXTURE_CUBE_MAP?s*=6:e.target==r.TEXTURE_2D&&(s*=1),s}getGLRTTexMemory(t,r,a,i,s,n,o){let getpixelbyte=t=>{let r=0;switch(t){case e.RenderTargetFormat.R8G8B8:r=3;break;case e.RenderTargetFormat.R8G8B8A8:r=4;break;case e.RenderTargetFormat.R16G16B16A16:r=8;break;case e.RenderTargetFormat.R32G32B32:r=12;break;case e.RenderTargetFormat.R32G32B32A32:r=16;break;case e.RenderTargetFormat.R16G16B16:r=6;break;case e.RenderTargetFormat.DEPTH_16:r=2;break;case e.RenderTargetFormat.STENCIL_8:r=1;break;case e.RenderTargetFormat.DEPTHSTENCIL_24_8:case e.RenderTargetFormat.DEPTH_32:r=4}return r},l=getpixelbyte(a);return n>1&&(l*=2),o&&(l*=6),s&&(l*=1.333),l*t*r+getpixelbyte(i)*t*r}supportSRGB(t,r){switch(t){case e.TextureFormat.R8G8B8:case e.TextureFormat.R8G8B8A8:return this._engine.getCapable(e.RenderCapable.Texture_SRGB)&&!r;case e.TextureFormat.DXT1:case e.TextureFormat.DXT3:case e.TextureFormat.DXT5:return this._engine.getCapable(e.RenderCapable.COMPRESS_TEXTURE_S3TC_SRGB)&&!r;default:return!1}}supportGenerateMipmap(t){switch(t){case e.RenderTargetFormat.DEPTH_16:case e.RenderTargetFormat.DEPTHSTENCIL_24_8:case e.RenderTargetFormat.DEPTH_32:case e.RenderTargetFormat.STENCIL_8:return!1;default:return!0}}isSRGBFormat(t){switch(t){case e.TextureFormat.ETC2SRGB:case e.TextureFormat.ETC2SRGB_Alpha8:case e.TextureFormat.ASTC4x4SRGB:case e.TextureFormat.ASTC6x6SRGB:case e.TextureFormat.ASTC8x8SRGB:case e.TextureFormat.ASTC10x10SRGB:case e.TextureFormat.ASTC12x12SRGB:return!0;default:return!1}}createTextureInternal(e,t,r,a,i,s,n){let o=this.isSRGBFormat(a)||s&&this.supportSRGB(a,i);n&&(o=!1);let l=1;!o&&s&&(l=2.2);let h=this.getTarget(e),u=new WebGLInternalTex(this._engine,h,t,r,1,e,i,o,l),d=this.glTextureParam(a,o);return u.internalFormat=d.internalFormat,u.format=d.format,u.type=d.type,u}setTextureImageData(e,t,r,a){e.width==t.width&&e.height==t.height||console.warn("setTextureImageData: size not match");let i=e.target,s=e.internalFormat,n=e.format,o=e.type;e.width,e.height;let l=e._gl;r&&l.pixelStorei(l.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),l.texImage2D(i,0,s,n,o,t),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&l.generateMipmap(e.target),this._engine._bindTexture(e.target,null),r&&l.pixelStorei(l.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&l.pixelStorei(l.UNPACK_FLIP_Y_WEBGL,!1)}setTextureSubImageData(e,t,r,a,i,s){let n=e.target;e.internalFormat;let o=e.format,l=e.type;t.width,t.height;let h=e._gl;i&&h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),s&&h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),h.texSubImage2D(n,0,r,a,o,l,t),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&h.generateMipmap(e.target),this._engine._bindTexture(e.target,null),i&&h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),s&&h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,!1)}initVideoTextureData(e){let t=e.target;e.internalFormat;let r=e.format,a=e.type,i=e.width,s=e.height,n=e._gl;this._engine._bindTexture(e.target,e.resource),n.texImage2D(t,0,e.internalFormat,i,s,0,r,a,null),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&n.generateMipmap(e.target),this._engine._bindTexture(e.target,null)}setTexturePixelsData(e,t,r,a){let i=e.target,s=e.internalFormat,n=e.format,o=e.type,l=e.width,h=e.height,u=l%4==0&&h%4==0,d=e._gl;r&&d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,!0),u||d.pixelStorei(d.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),d.texImage2D(i,0,s,l,h,0,n,o,t),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&d.generateMipmap(e.target),this._engine._bindTexture(e.target,null),r&&d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,!1),u||d.pixelStorei(d.UNPACK_ALIGNMENT,4)}setTextureSubPixelsData(e,t,r,a,i,s,n,o,l,h){a=a&&0==r;let u=e.target;e.internalFormat;let d=e.format,_=e.type,c=n%4==0&&o%4==0,p=e._gl;l&&p.pixelStorei(p.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),h&&p.pixelStorei(p.UNPACK_FLIP_Y_WEBGL,!0),c||p.pixelStorei(p.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),p.texSubImage2D(u,r,i,s,n,o,d,_,t),e.mipmap&&a&&p.generateMipmap(e.target),this._engine._bindTexture(e.target,null),l&&p.pixelStorei(p.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),h&&p.pixelStorei(p.UNPACK_FLIP_Y_WEBGL,!1),c||p.pixelStorei(p.UNPACK_ALIGNMENT,4)}setTextureDDSData(e,t){let r=e.target,a=e.internalFormat;e.format,e.type;let i=e.width,s=e.height,n=t.source,o=t.dataOffset,l=t.bpp,h=t.blockBytes,u=t.mipmapCount;e.maxMipmapLevel=u-1;let d=i%4==0&&s%4==0,_=e._gl;d||_.pixelStorei(_.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource);let c=i,p=s,m=0;for(let e=0;e<u;e++){let t=Math.max(4,c)/4*Math.max(4,p)/4*h,i=new Uint8Array(n,o,t);_.compressedTexImage2D(r,e,a,c,p,0,i),m+=i.length,o+=l?c*p*(l/8):t,c*=.5,p*=.5,c=Math.max(1,c),p=Math.max(1,p)}e.gpuMemory=m,this._engine._bindTexture(e.target,null),d||_.pixelStorei(_.UNPACK_ALIGNMENT,4)}setTextureKTXData(e,t){let r=t.source,a=t.compress,i=e.target,s=e.internalFormat,n=e.format,o=e.type,l=e.mipmapCount,h=e.width,u=e.height;e.maxMipmapLevel=l-1;let d=h%4==0&&u%4==0,_=e._gl;d||_.pixelStorei(_.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource);let c=h,p=u,m=t.headerOffset+t.bytesOfKeyValueData,f=0;for(let e=0;e<t.mipmapCount;e++){let l=new Int32Array(r,m,1)[0];if(m+=4,a){let t=new Uint8Array(r,m,l);_.compressedTexImage2D(i,e,s,c,p,0,t),f+=t.length}else{let a=this.getFormatPixelsParams(t.format),h=l/a.typedSize,u=new a.dataTypedCons(r,m,h);_.texImage2D(i,e,s,c,p,0,n,o,u),f+=u.byteLength}m+=l,m+=3-(l+3)%4,c=Math.max(1,.5*c),p=Math.max(1,.5*p)}for(let r=t.mipmapCount;r<e.mipmapCount;r++)a||_.texImage2D(i,r,s,c,p,0,n,o,null),c=Math.max(1,.5*c),p=Math.max(1,.5*p);e.gpuMemory=f,this._engine._bindTexture(e.target,null),d||_.pixelStorei(_.UNPACK_ALIGNMENT,4)}setTextureHDRData(e,t){let r=t.readScanLine();this.setTexturePixelsData(e,r,!1,!1)}setCubeImageData(e,t,r,a){let i=e._gl;const s=[i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z,i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y];let n=e.internalFormat,o=e.format,l=e.type;e.width,e.height,r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource);for(let e=0;e<s.length;e++){let r=s[e];i.texImage2D(r,0,n,o,l,t[e])}e.mipmap&&i.generateMipmap(e.target),this._engine._bindTexture(e.target,null),e.gpuMemory=this.getGLtexMemory(e),r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1)}setCubePixelsData(e,t,r,a){let i=e._gl;const s=[i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z,i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y];e.target;let n=e.internalFormat,o=e.format,l=e.type,h=e.width,u=e.height,d=h%4==0;if(r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!0),d||i.pixelStorei(i.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),t){for(let e=0;e<s.length;e++){let r=s[e];i.texImage2D(r,0,n,h,u,0,o,l,t[e])}e.mipmap&&i.generateMipmap(e.target)}else{for(let e=0;e<s.length;e++){let t=s[e];i.texImage2D(t,0,n,h,u,0,o,l,null)}e.mipmap&&i.generateMipmap(e.target)}this._engine._bindTexture(e.target,null),e.gpuMemory=this.getGLtexMemory(e),r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1),d||i.pixelStorei(i.UNPACK_ALIGNMENT,4)}setCubeSubPixelData(e,t,r,a,i,s,n,o,l,h){a=a&&0==r;let u=e._gl;const d=[u.TEXTURE_CUBE_MAP_POSITIVE_Z,u.TEXTURE_CUBE_MAP_NEGATIVE_Z,u.TEXTURE_CUBE_MAP_POSITIVE_X,u.TEXTURE_CUBE_MAP_NEGATIVE_X,u.TEXTURE_CUBE_MAP_POSITIVE_Y,u.TEXTURE_CUBE_MAP_NEGATIVE_Y];e.target,e.internalFormat;let _=e.format,c=e.type,p=n%4==0;l&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),h&&u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!0),p||u.pixelStorei(u.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource);for(let e=0;e<d.length;e++){let a=d[e];u.texSubImage2D(a,r,i,s,n,o,_,c,t[e])}e.mipmap&&a&&u.generateMipmap(e.target),this._engine._bindTexture(e.target,null),l&&u.pixelStorei(u.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),h&&u.pixelStorei(u.UNPACK_FLIP_Y_WEBGL,!1),p||u.pixelStorei(u.UNPACK_ALIGNMENT,4)}setCubeDDSData(t,r){let a=t.internalFormat,i=t.format,s=t.type,n=t.width,o=t.height,l=r.source,h=r.dataOffset,u=r.bpp,d=r.blockBytes,_=r.mipmapCount;t.maxMipmapLevel=_-1;let c=n%4==0&&o%4==0;c=!0;let p=t._gl;this._engine._bindTexture(t.target,t.resource);const m=[p.TEXTURE_CUBE_MAP_POSITIVE_X,p.TEXTURE_CUBE_MAP_NEGATIVE_X,p.TEXTURE_CUBE_MAP_POSITIVE_Y,p.TEXTURE_CUBE_MAP_NEGATIVE_Y,p.TEXTURE_CUBE_MAP_POSITIVE_Z,p.TEXTURE_CUBE_MAP_NEGATIVE_Z];let f=this.getFormatPixelsParams(r.format),g=f.bytesPerPixel/f.channels,T=r.format==e.TextureFormat.R32G32B32A32?Float32Array:Uint16Array,S=0;if(r.compressed)for(let e=0;e<6;e++){let r=m[e],i=n,s=o;for(let e=0;e<_;e++){let n=Math.max(4,i)/4*Math.max(4,s)/4*d,o=new Uint8Array(l,h,n);(t.mipmap||0==e)&&p.compressedTexImage2D(r,e,a,i,s,0,o),S+=o.byteLength,h+=u?i*s*(u/8):n,i*=.5,s*=.5,i=Math.max(1,i),s=Math.max(1,s)}}else for(let e=0;e<6;e++){let t=m[e],r=n,u=o;for(let e=0;e<_;e++){let n=r*u*f.channels,o=new T(l,h,n);p.texImage2D(t,e,a,r,u,0,i,s,o),S+=o.byteLength,h+=n*g,r*=.5,u*=.5,r=Math.max(1,r),u=Math.max(1,u)}}t.gpuMemory=S,this._engine._bindTexture(t.target,null)}setCubeKTXData(e,t){let r=t.source,a=t.compress,i=e.internalFormat,s=e.format,n=e.type,o=t.mipmapCount,l=e.width,h=e.height;e.maxMipmapLevel=o-1;let u=l%4==0&&h%4==0,d=e._gl;const _=[d.TEXTURE_CUBE_MAP_POSITIVE_X,d.TEXTURE_CUBE_MAP_NEGATIVE_X,d.TEXTURE_CUBE_MAP_POSITIVE_Y,d.TEXTURE_CUBE_MAP_NEGATIVE_Y,d.TEXTURE_CUBE_MAP_POSITIVE_Z,d.TEXTURE_CUBE_MAP_NEGATIVE_Z];u||d.pixelStorei(d.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource);let c=l,p=h,m=t.headerOffset+t.bytesOfKeyValueData,f=0;for(let e=0;e<t.mipmapCount;e++){let o=new Int32Array(r,m,1)[0];m+=4;for(let l=0;l<6;l++){let h=_[l];if(a){let t=new Uint8Array(r,m,o);d.compressedTexImage2D(h,e,i,c,p,0,t),f+=t.byteLength}else{let a=this.getFormatPixelsParams(t.format),l=o/a.typedSize,u=new a.dataTypedCons(r,m,l);d.texImage2D(h,e,i,c,p,0,s,n,u),f+=u.byteLength}m+=o,m+=3-(o+3)%4}c=Math.max(1,.5*c),p=Math.max(1,.5*p)}for(let r=t.mipmapCount;r<e.mipmapCount;r++){for(let e=0;e<6;e++){let t=_[e];a||d.texImage2D(t,r,i,c,p,0,s,n,null)}c=Math.max(1,.5*c),p=Math.max(1,.5*p)}this._engine._bindTexture(e.target,null),e.gpuMemory=f,u||d.pixelStorei(d.UNPACK_ALIGNMENT,4)}setTextureCompareMode(t,r){return e.TextureCompareMode.None}bindRenderTarget(e,t=0){let r=this._gl,a=e._framebuffer;if(r.bindFramebuffer(r.FRAMEBUFFER,a),e._isCube){let a=e._textures[0];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_CUBE_MAP_POSITIVE_X+t,a.resource,0)}}bindoutScreenTarget(){let e=this._gl;e.bindFramebuffer(e.FRAMEBUFFER,null)}unbindRenderTarget(e){let t=e._gl;e._generateMipmap&&e._textures.forEach((e=>{let r=e.target;this._engine._bindTexture(r,e.resource),t.generateMipmap(r),this._engine._bindTexture(r,null)})),t.bindFramebuffer(t.FRAMEBUFFER,null)}createRenderTextureInternal(t,r,a,i,s,n){s=s&&this.supportGenerateMipmap(i);let o=this.getTarget(t),l=new WebGLInternalTex(this._engine,o,r,a,1,t,s,false,1),h=this.glRenderTextureParam(i,false);l.internalFormat=h.internalFormat,l.format=h.format,l.type=h.type;let u=l.internalFormat,d=l.format,_=l.type,c=l._gl;return this._engine._bindTexture(l.target,l.resource),c.texImage2D(o,0,u,r,a,0,d,_,null),this._engine._bindTexture(l.target,null),i!=e.RenderTargetFormat.DEPTH_16&&i!=e.RenderTargetFormat.DEPTH_32&&i!=e.RenderTargetFormat.DEPTHSTENCIL_24_8||(l.filterMode=e.FilterMode.Point),l}createRenderTextureCubeInternal(t,r,a,i,s){i=i&&this.supportGenerateMipmap(a);let n=this.getTarget(t),o=new WebGLInternalTex(this._engine,n,r,r,1,t,i,false,1),l=this.glRenderTextureParam(a,false);o.internalFormat=l.internalFormat,o.format=l.format,o.type=l.type;let h=o.internalFormat,u=o.format,d=o.type,_=o._gl;const c=[_.TEXTURE_CUBE_MAP_POSITIVE_Z,_.TEXTURE_CUBE_MAP_NEGATIVE_Z,_.TEXTURE_CUBE_MAP_POSITIVE_X,_.TEXTURE_CUBE_MAP_NEGATIVE_X,_.TEXTURE_CUBE_MAP_POSITIVE_Y,_.TEXTURE_CUBE_MAP_NEGATIVE_Y];this._engine._bindTexture(o.target,o.resource);for(let e=0;e<c.length;e++){let t=c[e];_.texImage2D(t,0,h,r,r,0,u,d,null)}return this._engine._bindTexture(o.target,null),a!=e.RenderTargetFormat.DEPTH_16&&a!=e.RenderTargetFormat.DEPTH_32&&a!=e.RenderTargetFormat.DEPTHSTENCIL_24_8||(o.filterMode=e.FilterMode.Point),o}createRenderTargetInternal(t,r,a,i,s,n,o){let l=this.createRenderTextureInternal(e.TextureDimension.Tex2D,t,r,a,s,n),h=new WebGLInternalRT(this._engine,a,i,!1,l.mipmap,1);h.gpuMemory=this.getGLRTTexMemory(t,r,a,i,s,1,!1),h.colorFormat=a,h.depthStencilFormat=i,h._textures.push(l);let u=h._framebuffer,d=h._gl;d.bindFramebuffer(d.FRAMEBUFFER,u);let _=this.glRenderTargetAttachment(a);d.framebufferTexture2D(d.FRAMEBUFFER,_,d.TEXTURE_2D,l.resource,0);let c=this.glRenderBufferParam(i,!1);if(c){let e=this.createRenderbuffer(t,r,c.internalFormat,h._samples);h._depthbuffer=e,d.framebufferRenderbuffer(d.FRAMEBUFFER,c.attachment,d.RENDERBUFFER,e)}return d.bindFramebuffer(d.FRAMEBUFFER,null),h}createRenderTargetCubeInternal(t,r,a,i,s,n){let o=this.createRenderTextureCubeInternal(e.TextureDimension.Cube,t,r,i,s),l=new WebGLInternalRT(this._engine,r,a,!0,o.mipmap,1);l.gpuMemory=this.getGLRTTexMemory(t,t,r,a,i,1,!0),l._textures.push(o);let h=l._framebuffer,u=l._gl;u.bindFramebuffer(u.FRAMEBUFFER,h);let d=this.glRenderBufferParam(a,!1);if(d){let e=this.createRenderbuffer(t,t,d.internalFormat,l._samples);l._depthbuffer=e,u.framebufferRenderbuffer(u.FRAMEBUFFER,d.attachment,u.RENDERBUFFER,e)}return u.bindFramebuffer(u.FRAMEBUFFER,null),l}createRenderbuffer(e,t,r,a){let i=this._gl,s=i.createRenderbuffer();return i.bindRenderbuffer(i.RENDERBUFFER,s),i.renderbufferStorage(i.RENDERBUFFER,r,e,t),i.bindRenderbuffer(i.RENDERBUFFER,null),s}setupRendertargetTextureAttachment(e,t){let r=e._gl;e._depthTexture=t;let a=e._depthbuffer;a&&r.deleteRenderbuffer(a),e._depthbuffer=null;let i=this.glRenderTargetAttachment(e.depthStencilFormat),s=e._framebuffer;r.bindFramebuffer(r.FRAMEBUFFER,s),r.framebufferTexture2D(r.FRAMEBUFFER,i,r.TEXTURE_2D,t.resource,0),r.bindFramebuffer(r.FRAMEBUFFER,null)}readRenderTargetPixelData(t,r,a,i,s,n){let o=t._gl;if(this.bindRenderTarget(t),!(o.checkFramebufferStatus(o.FRAMEBUFFER)==o.FRAMEBUFFER_COMPLETE))return this.unbindRenderTarget(t),null;switch(t.colorFormat){case e.RenderTargetFormat.R8G8B8:o.readPixels(r,a,i,s,o.RGB,o.UNSIGNED_BYTE,n);break;case e.RenderTargetFormat.R8G8B8A8:o.readPixels(r,a,i,s,o.RGBA,o.UNSIGNED_BYTE,n);break;case e.RenderTargetFormat.R16G16B16:o.readPixels(r,a,i,s,o.RGB,o.FLOAT,n);break;case e.RenderTargetFormat.R16G16B16A16:o.readPixels(r,a,i,s,o.RGBA,o.FLOAT,n);break;case e.RenderTargetFormat.R32G32B32:o.readPixels(r,a,i,s,o.RGB,o.FLOAT,n);break;case e.RenderTargetFormat.R32G32B32A32:o.readPixels(r,a,i,s,o.RGBA,o.FLOAT,n)}return this.unbindRenderTarget(t),n}updateVideoTexture(e,t,r,a){let i=e._gl,s=e.target,n=e.internalFormat,o=e.format,l=e.type;e.width,e.height,r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!0),i.pixelStorei(i.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),i.texImage2D(s,0,n,o,l,t),this._engine._bindTexture(e.target,null),r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1),i.pixelStorei(i.UNPACK_ALIGNMENT,4)}getRenderTextureData(t,r,a,i,s){if(t.colorFormat==e.RenderTargetFormat.None)return null;let n=t._gl;if(n.bindFramebuffer(n.FRAMEBUFFER,t._framebuffer),!(n.checkFramebufferStatus(n.FRAMEBUFFER)===n.FRAMEBUFFER_COMPLETE))return n.bindFramebuffer(n.FRAMEBUFFER,null),null;let o,l,h=i*s;var u;switch(t.colorFormat){case e.RenderTargetFormat.R8G8B8:o=n.RGB,l=n.UNSIGNED_BYTE,u=new Uint8Array(3*h);break;case e.RenderTargetFormat.R8G8B8A8:o=n.RGBA,l=n.UNSIGNED_BYTE,u=new Uint8Array(4*h);break;case e.RenderTargetFormat.R16G16B16:o=n.RGB,l=n.UNSIGNED_SHORT_4_4_4_4,u=new Uint16Array(3*h);break;case e.RenderTargetFormat.R16G16B16A16:o=n.RGBA,l=n.UNSIGNED_SHORT_4_4_4_4,u=new Uint16Array(4*h);break;case e.RenderTargetFormat.R32G32B32:o=n.RGB,l=n.FLOAT,u=new Float32Array(3*h);break;case e.RenderTargetFormat.R32G32B32A32:o=n.RGBA,l=n.FLOAT,u=new Float32Array(4*h);break;default:return null}return n.readPixels(r,a,i,s,o,l,u),n.bindFramebuffer(n.FRAMEBUFFER,null),u}}class GL2TextureContext extends GLTextureContext{constructor(e){super(e)}getTarget(t){let r=-1;switch(t){case e.TextureDimension.Cube:r=this._gl.TEXTURE_CUBE_MAP;break;case e.TextureDimension.Tex2D:r=this._gl.TEXTURE_2D;break;case e.TextureDimension.Texture2DArray:r=this._gl.TEXTURE_2D_ARRAY;break;case e.TextureDimension.Tex3D:r=this._gl.TEXTURE_3D;break;default:throw"Unknow Texture Target"}return r}glTextureParam(t,r){let a=this._gl;switch(this._glParam.internalFormat=null,this._glParam.format=null,this._glParam.type=null,t){case e.TextureFormat.R8G8B8:this._glParam.internalFormat=r?a.SRGB8:a.RGB8,this._glParam.format=a.RGB,this._glParam.type=a.UNSIGNED_BYTE;break;case e.TextureFormat.R8G8B8A8:this._glParam.internalFormat=r?a.SRGB8_ALPHA8:a.RGBA8,this._glParam.format=a.RGBA,this._glParam.type=a.UNSIGNED_BYTE;break;case e.TextureFormat.R5G6B5:this._glParam.internalFormat=a.RGB565,this._glParam.format=a.RGB,this._glParam.type=a.UNSIGNED_SHORT_5_6_5;break;case e.TextureFormat.R32G32B32A32:this._glParam.internalFormat=a.RGBA32F,this._glParam.format=a.RGBA,this._glParam.type=a.FLOAT;break;case e.TextureFormat.R32G32B32:this._glParam.internalFormat=a.RGB32F,this._glParam.format=a.RGB,this._glParam.type=a.FLOAT;break;case e.TextureFormat.R16G16B16:this._glParam.internalFormat=a.RGB16F,this._glParam.format=a.RGB,this._glParam.type=a.HALF_FLOAT;break;case e.TextureFormat.R16G16B16A16:this._glParam.internalFormat=a.RGBA16F,this._glParam.format=a.RGBA,this._glParam.type=a.HALF_FLOAT;break;case e.TextureFormat.DXT1:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT1_EXT;break;case e.TextureFormat.DXT3:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case e.TextureFormat.DXT5:this._glParam.internalFormat=r?this._compressdTextureS3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT:this._compressedTextureS3tc.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case e.TextureFormat.ETC1RGB:this._glParam.internalFormat=this._compressedTextureEtc1.COMPRESSED_RGB_ETC1_WEBGL;break;case e.TextureFormat.ETC2RGBA:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGBA8_ETC2_EAC;break;case e.TextureFormat.ETC2RGB:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_RGB8_ETC2;break;case e.TextureFormat.ETC2SRGB:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_ETC2;break;case e.TextureFormat.ETC2SRGB_Alpha8:this._glParam.internalFormat=this._compressedTextureETC.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;break;case e.TextureFormat.ASTC4x4:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case e.TextureFormat.ASTC6x6:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_6x6_KHR;break;case e.TextureFormat.ASTC8x8:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_8x8_KHR;break;case e.TextureFormat.ASTC10x10:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_10x10_KHR;break;case e.TextureFormat.ASTC12x12:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_RGBA_ASTC_12x12_KHR;break;case e.TextureFormat.ASTC4x4SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;break;case e.TextureFormat.ASTC6x6SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;break;case e.TextureFormat.ASTC8x8SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;break;case e.TextureFormat.ASTC10x10SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;break;case e.TextureFormat.ASTC12x12SRGB:this._glParam.internalFormat=this._compressedTextureASTC.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;break;default:throw"Unknown Texture Format."}return this._glParam}glRenderBufferParam(t,r){let a=this._gl;switch(t){case e.RenderTargetFormat.DEPTH_16:return{internalFormat:a.DEPTH_COMPONENT16,attachment:a.DEPTH_ATTACHMENT};case e.RenderTargetFormat.DEPTHSTENCIL_24_8:return{internalFormat:a.DEPTH24_STENCIL8,attachment:a.DEPTH_STENCIL_ATTACHMENT};case e.RenderTargetFormat.DEPTH_32:return{internalFormat:a.DEPTH_COMPONENT32F,attachment:a.DEPTH_ATTACHMENT};case e.RenderTargetFormat.STENCIL_8:return{internalFormat:a.STENCIL_INDEX8,attachment:a.STENCIL_ATTACHMENT};case e.RenderTargetFormat.R8G8B8:return{internalFormat:r?a.SRGB8:a.RGB8,attachment:a.COLOR_ATTACHMENT0};case e.RenderTargetFormat.R8G8B8A8:return{internalFormat:r?a.SRGB8_ALPHA8:a.RGBA8,attachment:a.COLOR_ATTACHMENT0};case e.RenderTargetFormat.R16G16B16:return{internalFormat:a.RGB16F,attachment:a.COLOR_ATTACHMENT0};case e.RenderTargetFormat.R16G16B16A16:return{internalFormat:a.RGBA16F,attachment:a.COLOR_ATTACHMENT0};case e.RenderTargetFormat.R32G32B32:return{internalFormat:a.RGB32F,attachment:a.COLOR_ATTACHMENT0};case e.RenderTargetFormat.R32G32B32A32:return{internalFormat:a.RGBA32F,attachment:a.COLOR_ATTACHMENT0};default:return null}}glRenderTextureParam(t,r){let a=this._gl;switch(this._glParam.internalFormat=null,this._glParam.format=null,this._glParam.type=null,t){case e.RenderTargetFormat.R8G8B8:this._glParam.internalFormat=r?a.SRGB8:a.RGB8,this._glParam.format=a.RGB,this._glParam.type=a.UNSIGNED_BYTE;break;case e.RenderTargetFormat.R8G8B8A8:this._glParam.internalFormat=r?a.SRGB8_ALPHA8:a.RGBA8,this._glParam.format=a.RGBA,this._glParam.type=a.UNSIGNED_BYTE;break;case e.RenderTargetFormat.R16G16B16:this._glParam.internalFormat=a.RGB16F,this._glParam.format=a.RGB,this._glParam.type=a.HALF_FLOAT;break;case e.RenderTargetFormat.R16G16B16A16:this._glParam.internalFormat=a.RGBA16F,this._glParam.format=a.RGBA,this._glParam.type=a.HALF_FLOAT;break;case e.RenderTargetFormat.R32G32B32:this._glParam.internalFormat=a.RGB32F,this._glParam.format=a.RGB,this._glParam.type=a.FLOAT;break;case e.RenderTargetFormat.R32G32B32A32:this._glParam.internalFormat=a.RGBA32F,this._glParam.format=a.RGBA,this._glParam.type=a.FLOAT;break;case e.RenderTargetFormat.DEPTH_16:this._glParam.internalFormat=a.DEPTH_COMPONENT16,this._glParam.format=a.DEPTH_COMPONENT,this._glParam.type=a.UNSIGNED_INT;break;case e.RenderTargetFormat.DEPTHSTENCIL_24_8:this._glParam.internalFormat=a.DEPTH24_STENCIL8,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_INT_24_8;break;case e.RenderTargetFormat.DEPTH_32:this._glParam.internalFormat=a.DEPTH_COMPONENT32F,this._glParam.format=this._glParam.internalFormat,this._glParam.type=a.UNSIGNED_INT;break;case e.RenderTargetFormat.STENCIL_8:break;default:throw"depth texture format wrong."}return this._glParam}getGLtexMemory(e,t=1){let r=this._gl,a=0,i=0,s=0;switch(e.internalFormat){case r.SRGB8:case r.RGB8:case r.RGB565:case r.RGB32F:case r.RGB16F:a=3;break;case r.SRGB8_ALPHA8:case r.RGBA8:case r.RGBA32F:case r.RGBA16F:a=4;break;default:a=0}switch(e.type){case r.UNSIGNED_BYTE:i=1;break;case r.UNSIGNED_SHORT_5_6_5:i=2/3;break;case r.FLOAT:i=4;break;case r.HALF_FLOAT:i=2;break;default:i=0}return s=a*i*e.width*e.height,e.mipmap&&(s*=1.333),e.target==r.TEXTURE_CUBE_MAP?s*=6:e.target==r.TEXTURE_2D?s*=1:e.target==r.TEXTURE_2D_ARRAY&&(s*=t),s}supportSRGB(t,r){switch(t){case e.TextureFormat.R8G8B8:return this._engine.getCapable(e.RenderCapable.Texture_SRGB)&&!r;case e.TextureFormat.R8G8B8A8:return this._engine.getCapable(e.RenderCapable.Texture_SRGB);case e.TextureFormat.DXT1:case e.TextureFormat.DXT3:case e.TextureFormat.DXT5:return this._engine.getCapable(e.RenderCapable.COMPRESS_TEXTURE_S3TC_SRGB)&&!r;default:return!1}}setTextureImageData(e,t,r,a){e.width==t.width&&e.height==t.height||console.warn("setTextureImageData: size not match");let i=e.target,s=e.internalFormat,n=e.format,o=e.type,l=e.width,h=e.height,u=e.mipmapCount,d=this._gl;r&&d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),d.texStorage2D(i,u,s,l,h),d.texSubImage2D(i,0,0,0,l,h,n,o,t),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&d.generateMipmap(e.target),this._engine._bindTexture(e.target,null),r&&d.pixelStorei(d.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,!1)}setTextureSubImageData(e,t,r,a,i,s){let n=e.target;e.internalFormat;let o=e.format,l=e.type;e.width,e.height,e.mipmapCount;let h=this._gl;i&&h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),s&&h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),h.texSubImage2D(n,0,r,a,t.width,t.height,o,l,t),e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&h.generateMipmap(e.target),this._engine._bindTexture(e.target,null),i&&h.pixelStorei(h.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),s&&h.pixelStorei(h.UNPACK_FLIP_Y_WEBGL,!1)}setTexturePixelsData(e,t,r,a){let i=e.target,s=e.internalFormat,n=e.format,o=e.type,l=e.width,h=e.height,u=e.mipmapCount,d=l%4==0&&h%4==0,_=this._gl;r&&_.pixelStorei(_.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&_.pixelStorei(_.UNPACK_FLIP_Y_WEBGL,!0),d||_.pixelStorei(_.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),_.texStorage2D(i,u,s,l,h),e.gpuMemory=this.getGLtexMemory(e),t&&(_.texSubImage2D(i,0,0,0,l,h,n,o,t),e.mipmap&&_.generateMipmap(e.target)),this._engine._bindTexture(e.target,null),r&&_.pixelStorei(_.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&_.pixelStorei(_.UNPACK_FLIP_Y_WEBGL,!1),d||_.pixelStorei(_.UNPACK_ALIGNMENT,4)}createTexture3DInternal(e,t,r,a,i,s,n,o){let l=this.isSRGBFormat(i)||n&&this.supportSRGB(i,s);o&&(l=!1);let h=1;!l&&n&&(h=2.2);let u=this.getTarget(e),d=new WebGLInternalTex(this._engine,u,t,r,a,e,s,l,h),_=this.glTextureParam(i,l);return d.internalFormat=_.internalFormat,d.format=_.format,d.type=_.type,d}setTexture3DImageData(e,t,r,a,i){let s=e.target,n=e.internalFormat,o=e.format,l=e.type,h=e.width,u=e.height,d=e.mipmapCount,_=this._gl;a&&_.pixelStorei(_.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),i&&_.pixelStorei(_.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),_.texStorage3D(s,d,n,h,u,r),e.gpuMemory=this.getGLtexMemory(e,r);for(let e=0;e<r;e++)_.texSubImage3D(s,0,0,0,e,h,u,1,o,l,t[e]);e.gpuMemory=this.getGLtexMemory(e),e.mipmap&&_.generateMipmap(e.target),this._engine._bindTexture(e.target,null),a&&_.pixelStorei(_.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),i&&_.pixelStorei(_.UNPACK_FLIP_Y_WEBGL,!1)}setTexture3DPixelsData(e,t,r,a,i){let s=e.target,n=e.internalFormat,o=e.format,l=e.type,h=e.width,u=e.height,d=e.mipmapCount,_=h%4==0&&u%4==0,c=this._gl;a&&c.pixelStorei(c.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),i&&c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!0),_||c.pixelStorei(c.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),c.texStorage3D(s,d,n,h,u,r),e.gpuMemory=this.getGLtexMemory(e,r),t&&(c.texSubImage3D(s,0,0,0,0,h,u,r,o,l,t),e.mipmap&&c.generateMipmap(e.target)),this._engine._bindTexture(e.target,null),a&&c.pixelStorei(c.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),i&&c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!1),_||c.pixelStorei(c.UNPACK_ALIGNMENT,4)}setTexture3DSubPixelsData(e,t,r,a,i,s,n,o,l,h,u,d){a=a&&0==r;let _=e.target;e.internalFormat;let c=e.format,p=e.type,m=o%4==0&&l%4==0,f=this._gl;u&&f.pixelStorei(f.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),d&&f.pixelStorei(f.UNPACK_FLIP_Y_WEBGL,!0),m||f.pixelStorei(f.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),f.texSubImage3D(_,r,i,s,n,o,l,h,c,p,t),e.mipmap&&a&&f.generateMipmap(e.target),this._engine._bindTexture(e.target,null),u&&f.pixelStorei(f.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),d&&f.pixelStorei(f.UNPACK_FLIP_Y_WEBGL,!1),m||f.pixelStorei(f.UNPACK_ALIGNMENT,4)}setTextureHDRData(e,t){let r=t.readScanLine();this.setTexturePixelsData(e,r,!1,!1)}setTextureKTXData(e,t){let r=e.target,a=e.internalFormat,i=e.format,s=e.type,n=e.mipmapCount,o=e.width,l=e.height;e.maxMipmapLevel=n-1;let h=t.source,u=t.compress,d=o%4==0&&l%4==0,_=this._gl;d||_.pixelStorei(_.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),u||_.texStorage2D(r,t.mipmapCount,a,o,l);let c=o,p=l,m=t.headerOffset+t.bytesOfKeyValueData,f=0;for(let e=0;e<t.mipmapCount;e++){let n=new Int32Array(h,m,1)[0];if(m+=4,u){let t=new Uint8Array(h,m,n);_.compressedTexImage2D(r,e,a,c,p,0,t),f+=t.length}else{let a=this.getFormatPixelsParams(t.format),o=n/a.typedSize,l=new a.dataTypedCons(h,m,o);_.texSubImage2D(r,e,0,0,c,p,i,s,l),f+=l.length}m+=n,m+=3-(n+3)%4,c=Math.max(1,.5*c),p=Math.max(1,.5*p)}this._engine._bindTexture(e.target,null),e.gpuMemory=f,d||_.pixelStorei(_.UNPACK_ALIGNMENT,4)}setCubeImageData(e,t,r,a){let i=this._gl;const s=[i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z,i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y];let n=e.target,o=e.internalFormat,l=e.format,h=e.type,u=e.width,d=e.height,_=e.mipmapCount;r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!0),this._engine._bindTexture(e.target,e.resource),i.texStorage2D(n,_,o,u,d),e.gpuMemory=this.getGLtexMemory(e);for(let e=0;e<s.length;e++){let r=s[e];i.texSubImage2D(r,0,0,0,l,h,t[e])}e.mipmap&&i.generateMipmap(e.target),this._engine._bindTexture(e.target,null),r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1)}setCubePixelsData(e,t,r,a){let i=this._gl;const s=[i.TEXTURE_CUBE_MAP_POSITIVE_Z,i.TEXTURE_CUBE_MAP_NEGATIVE_Z,i.TEXTURE_CUBE_MAP_POSITIVE_X,i.TEXTURE_CUBE_MAP_NEGATIVE_X,i.TEXTURE_CUBE_MAP_POSITIVE_Y,i.TEXTURE_CUBE_MAP_NEGATIVE_Y];let n=e.target,o=e.internalFormat,l=e.format,h=e.type,u=e.width,d=e.height,_=e.mipmapCount,c=u%4==0;if(r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!0),c||i.pixelStorei(i.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),i.texStorage2D(n,_,o,u,d),t){for(let e=0;e<s.length;e++){let r=s[e];i.texSubImage2D(r,0,0,0,u,d,l,h,t[e])}e.mipmap&&i.generateMipmap(e.target)}this._engine._bindTexture(e.target,null),e.gpuMemory=this.getGLtexMemory(e),r&&i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a&&i.pixelStorei(i.UNPACK_FLIP_Y_WEBGL,!1),c||i.pixelStorei(i.UNPACK_ALIGNMENT,4)}setCubeKTXData(e,t){let r=this._gl;const a=[r.TEXTURE_CUBE_MAP_POSITIVE_X,r.TEXTURE_CUBE_MAP_NEGATIVE_X,r.TEXTURE_CUBE_MAP_POSITIVE_Y,r.TEXTURE_CUBE_MAP_NEGATIVE_Y,r.TEXTURE_CUBE_MAP_POSITIVE_Z,r.TEXTURE_CUBE_MAP_NEGATIVE_Z];let i=e.target,s=e.internalFormat,n=e.format,o=e.type;e.mipmapCount;let l=e.width,h=e.height;e.maxMipmapLevel=t.mipmapCount-1;let u=t.source,d=t.compress,_=l,c=h,p=t.headerOffset+t.bytesOfKeyValueData,m=l%4==0&&h%4==0;m||r.pixelStorei(r.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),d||r.texStorage2D(i,t.mipmapCount,s,l,h);let f=0;for(let e=0;e<t.mipmapCount;e++){let i=new Int32Array(u,p,1)[0];p+=4;for(let l=0;l<6;l++){let h=a[l];if(d){let t=new Uint8Array(u,p,i);r.compressedTexImage2D(h,e,s,_,c,0,t),f+=t.byteLength}else{let a=this.getFormatPixelsParams(t.format),s=i/a.typedSize,l=new a.dataTypedCons(u,p,s);r.texSubImage2D(h,e,0,0,_,c,n,o,l),f+=l.byteLength}p+=i,p+=3-(i+3)%4}_=Math.max(1,.5*_),c=Math.max(1,.5*c)}e.gpuMemory=f,this._engine._bindTexture(e.target,null),m||r.pixelStorei(r.UNPACK_ALIGNMENT,4)}getCubeKTXRGBMData(e,t){let r=this._gl;const a=[r.TEXTURE_CUBE_MAP_POSITIVE_X,r.TEXTURE_CUBE_MAP_NEGATIVE_X,r.TEXTURE_CUBE_MAP_POSITIVE_Y,r.TEXTURE_CUBE_MAP_NEGATIVE_Y,r.TEXTURE_CUBE_MAP_POSITIVE_Z,r.TEXTURE_CUBE_MAP_NEGATIVE_Z];let i=e.target,s=e.internalFormat,n=e.format,o=e.type,l=e.mipmapCount,h=e.width,u=e.height;e.maxMipmapLevel=l-1;let d=t.source,_=t.compress,c=h,p=u,m=t.headerOffset+t.bytesOfKeyValueData,f=h%4==0&&u%4==0;f||r.pixelStorei(r.UNPACK_ALIGNMENT,1),this._engine._bindTexture(e.target,e.resource),_||r.texStorage2D(i,t.mipmapCount,s,h,u);let g=0;for(let e=0;e<t.mipmapCount;e++){let i=new Int32Array(d,m,1)[0];m+=4;for(let s=0;s<6;s++){let l=a[s],h=this.getFormatPixelsParams(t.format),u=i/h.typedSize,_=new h.dataTypedCons(d,m,u);r.texSubImage2D(l,e,0,0,c,p,n,o,_),g+=_.byteLength}m+=i,m+=3-(i+3)%4}c=Math.max(1,.5*c),p=Math.max(1,.5*p),e.gpuMemory=g,this._engine._bindTexture(e.target,null),f||r.pixelStorei(r.UNPACK_ALIGNMENT,4)}setTextureCompareMode(t,r){let a=this._gl;switch(r){case e.TextureCompareMode.LEQUAL:t._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.LEQUAL),t._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case e.TextureCompareMode.GEQUAL:t._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.GEQUAL),t._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case e.TextureCompareMode.LESS:t._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.LESS),t._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case e.TextureCompareMode.GREATER:t._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.GREATER),t._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case e.TextureCompareMode.EQUAL:t._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.EQUAL),t._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case e.TextureCompareMode.NOTEQUAL:t._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.NOTEQUAL),t._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case e.TextureCompareMode.ALWAYS:t._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.ALWAYS),t._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case e.TextureCompareMode.NEVER:t._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.NEVER),t._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.COMPARE_REF_TO_TEXTURE);break;case e.TextureCompareMode.None:default:t._setTexParameteri(a.TEXTURE_COMPARE_FUNC,a.LEQUAL),t._setTexParameteri(a.TEXTURE_COMPARE_MODE,a.NONE)}return r}createRenderbuffer(e,t,r,a){let i=this._gl,s=i.createRenderbuffer();return i.bindRenderbuffer(i.RENDERBUFFER,s),a>1?i.renderbufferStorageMultisample(i.RENDERBUFFER,a,r,e,t):i.renderbufferStorage(i.RENDERBUFFER,r,e,t),i.bindRenderbuffer(i.RENDERBUFFER,null),s}createRenderTextureInternal(t,r,a,i,s,n){s=s&&this.supportGenerateMipmap(i);let o=this.isSRGBFormat(i)||n&&this.supportSRGB(i,s),l=this.getTarget(t),h=new WebGLInternalTex(this._engine,l,r,a,1,t,s,o,1),u=this.glRenderTextureParam(i,o);h.internalFormat=u.internalFormat,h.format=u.format,h.type=u.type;let d=h.internalFormat;h.format,h.type;let _=this._gl;return this._engine._bindTexture(h.target,h.resource),_.texStorage2D(l,h.mipmapCount,d,r,a),this._engine._bindTexture(h.target,null),i!=e.RenderTargetFormat.DEPTH_16&&i!=e.RenderTargetFormat.DEPTH_32&&i!=e.RenderTargetFormat.DEPTHSTENCIL_24_8||(h.filterMode=e.FilterMode.Point),h}createRenderTargetInternal(t,r,a,i,s,n,o){let l=this.createRenderTextureInternal(e.TextureDimension.Tex2D,t,r,a,s,n),h=new WebGLInternalRT(this._engine,a,i,!1,l.mipmap,o);h.gpuMemory=this.getGLRTTexMemory(t,r,a,i,s,o,!1),h._textures.push(l);let u=h._gl;if(h._samples>1){let e=h._msaaFramebuffer,s=this.glRenderBufferParam(a,n),o=h._msaaRenderbuffer=this.createRenderbuffer(t,r,s.internalFormat,h._samples);u.bindFramebuffer(u.FRAMEBUFFER,e),u.framebufferRenderbuffer(u.FRAMEBUFFER,s.attachment,u.RENDERBUFFER,o);let d=this.glRenderBufferParam(i,!1);if(d){let e=this.createRenderbuffer(t,r,d.internalFormat,h._samples);h._depthbuffer=e,u.framebufferRenderbuffer(u.FRAMEBUFFER,d.attachment,u.RENDERBUFFER,e)}u.bindFramebuffer(u.FRAMEBUFFER,null);let _=h._framebuffer;u.bindFramebuffer(u.FRAMEBUFFER,_);let c=this.glRenderTargetAttachment(a);u.framebufferTexture2D(u.FRAMEBUFFER,c,u.TEXTURE_2D,l.resource,0),u.bindFramebuffer(u.FRAMEBUFFER,null)}else{let e=h._framebuffer;u.bindFramebuffer(u.FRAMEBUFFER,e);let s=this.glRenderTargetAttachment(a);u.framebufferTexture2D(u.FRAMEBUFFER,s,u.TEXTURE_2D,l.resource,0);let n=this.glRenderBufferParam(i,!1);if(n){let e=this.createRenderbuffer(t,r,n.internalFormat,h._samples);h._depthbuffer=e,u.framebufferRenderbuffer(u.FRAMEBUFFER,n.attachment,u.RENDERBUFFER,e)}u.bindFramebuffer(u.FRAMEBUFFER,null)}return h}createRenderTargetCubeInternal(t,r,a,i,s,n){let o=this.createRenderTextureCubeInternal(e.TextureDimension.Cube,t,r,i,s),l=new WebGLInternalRT(this._engine,r,a,!0,o.mipmap,n);l.gpuMemory=this.getGLRTTexMemory(t,t,r,a,i,n,!0),l.colorFormat=r,l.depthStencilFormat=a,l._textures.push(o),l.isSRGB=s;let h=l._gl;if(l._samples>1){let e=l._msaaFramebuffer,i=this.glRenderBufferParam(r,!1),s=l._msaaRenderbuffer=this.createRenderbuffer(t,t,i.internalFormat,l._samples);h.bindFramebuffer(h.FRAMEBUFFER,e),h.framebufferRenderbuffer(h.FRAMEBUFFER,i.attachment,h.RENDERBUFFER,s);let n=this.glRenderBufferParam(a,!1);if(n){let e=this.createRenderbuffer(t,t,n.internalFormat,l._samples);l._depthbuffer=e,h.framebufferRenderbuffer(h.FRAMEBUFFER,n.attachment,h.RENDERBUFFER,e)}h.bindFramebuffer(h.FRAMEBUFFER,null)}else{let e=l._framebuffer;h.bindFramebuffer(h.FRAMEBUFFER,e);let r=this.glRenderBufferParam(a,!1);if(r){let e=this.createRenderbuffer(t,t,r.internalFormat,l._samples);l._depthbuffer=e,h.framebufferRenderbuffer(h.FRAMEBUFFER,r.attachment,h.RENDERBUFFER,e)}h.bindFramebuffer(h.FRAMEBUFFER,null)}return l}createRenderTextureCubeInternal(e,t,r,a,i){a=a&&this.supportGenerateMipmap(r);let s=this.isSRGBFormat(r)||i&&this.supportSRGB(r,a),n=this.getTarget(e),o=new WebGLInternalTex(this._engine,n,t,t,1,e,a,s,1),l=this.glRenderTextureParam(r,s);o.internalFormat=l.internalFormat,o.format=l.format,o.type=l.type;let h=o.internalFormat;o.format,o.type;let u=this._gl;return this._engine._bindTexture(o.target,o.resource),u.texStorage2D(n,o.mipmapCount,h,t,t),this._engine._bindTexture(o.target,null),o}bindRenderTarget(e,t=0){let r=this._gl;if(e._isCube){let a=e._framebuffer;r.bindFramebuffer(r.FRAMEBUFFER,a);let i=e._textures[0];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_CUBE_MAP_POSITIVE_X+t,i.resource,0)}if(e._samples>1)r.bindFramebuffer(r.FRAMEBUFFER,e._msaaFramebuffer);else{let t=e._framebuffer;r.bindFramebuffer(r.FRAMEBUFFER,t)}}unbindRenderTarget(e){let t=this._gl;if(e._samples>1){t.bindFramebuffer(t.READ_FRAMEBUFFER,e._msaaFramebuffer),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,e._framebuffer);let r=e._textures[0],a=t.COLOR_BUFFER_BIT;e._depthTexture&&(a|=t.DEPTH_BUFFER_BIT),t.blitFramebuffer(0,0,r.width,r.height,0,0,r.width,r.height,a,t.NEAREST)}e._generateMipmap&&e._textures.forEach((e=>{let r=e.target;this._engine._bindTexture(r,e.resource),t.generateMipmap(r),this._engine._bindTexture(r,null)})),t.bindFramebuffer(t.FRAMEBUFFER,null)}}class GLBuffer extends GLObject{constructor(e,t,r){super(e),this._byteLength=0,this._glTargetType=t,this._glBufferUsageType=r,this._getGLTarget(this._glTargetType),this._getGLUsage(this._glBufferUsageType),this._glBuffer=this._gl.createBuffer()}_getGLUsage(t){switch(t){case e.BufferUsage.Static:this._glUsage=this._gl.STATIC_DRAW;break;case e.BufferUsage.Dynamic:this._glUsage=this._gl.DYNAMIC_DRAW;break;case e.BufferUsage.Stream:this._glUsage=this._gl.STREAM_DRAW;break;default:console.error("usage is not standard")}}_getGLTarget(t){switch(t){case e.BufferTargetType.ARRAY_BUFFER:this._glTarget=this._gl.ARRAY_BUFFER;break;case e.BufferTargetType.UNIFORM_BUFFER:this._glTarget=this._gl.UNIFORM_BUFFER;break;case e.BufferTargetType.ELEMENT_ARRAY_BUFFER:this._glTarget=this._gl.ELEMENT_ARRAY_BUFFER}}_memorychange(t){this._engine._addStatisticsInfo(e.RenderStatisticsInfo.BufferMemory,t),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.GPUMemory,t)}bindBuffer(){return this._engine._getbindBuffer(this._glTargetType)!=this&&(this._gl.bindBuffer(this._glTarget,this._glBuffer),this._engine._setbindBuffer(this._glTargetType,this),!0)}unbindBuffer(){this._engine._getbindBuffer(this._glTargetType)==this&&(this._gl.bindBuffer(this._glTarget,null),this._engine._setbindBuffer(this._glTargetType,null))}orphanStorage(){this.bindBuffer(),this.setDataLength(this._byteLength)}setDataLength(e){let t=this._gl;this.bindBuffer(),this._memorychange(-this._byteLength),this._byteLength=e,t.bufferData(this._glTarget,this._byteLength,this._glUsage),this.unbindBuffer(),this._memorychange(this._byteLength)}setData(e,t){let r=this._gl;this.bindBuffer(),r.bufferSubData(this._glTarget,t,e),this.unbindBuffer()}setDataEx(e,t,r){let a=this._gl;this.bindBuffer(),a.bufferSubData(this._glTarget,t,e,0,r),this.unbindBuffer()}bindBufferBase(e){if(this._engine._getBindUBOBuffer(e)!=this){this._gl.bindBufferBase(this._glTarget,e,this._glBuffer),this._engine._setBindUBOBuffer(e,this)}}bindBufferRange(e,t,r){this._gl.bindBufferRange(this._glTarget,e,this._glBuffer,t,r)}resizeBuffer(e){this.bindBuffer();const t=this._gl;this._byteLength=e,t.bufferData(this._glTarget,this._byteLength,this._glUsage)}destroy(){super.destroy();this._gl.deleteBuffer(this._glBuffer),this._memorychange(-this._byteLength),this._byteLength=0,this._engine=null,this._glBuffer=null,this._glTarget=null,this._glUsage=null,this._gl=null}}!function(){var e={};function synthesizeGLError(t,r){var a;e[t]=!0,void 0!==r&&(a=r,window.console&&window.console.error&&window.console.error(a))}var t=function WebGLVertexArrayObjectOES(e){var t=e.gl;this.ext=e,this.isAlive=!0,this.hasBeenBound=!1,this.elementArrayBuffer=null,this.attribs=new Array(e.maxVertexAttribs);for(var r=0;r<this.attribs.length;r++){var a=new WebGLVertexArrayObjectOES.VertexAttrib(t);this.attribs[r]=a}this.maxAttrib=0};(t.VertexAttrib=function(e){this.enabled=!1,this.buffer=null,this.size=4,this.type=e.FLOAT,this.normalized=!1,this.stride=16,this.offset=0,this.cached="",this.recache()}).prototype.recache=function(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};var OESVertexArrayObject=function(t){var r=this;this.gl=t,function(t){var r=t.getError;t.getError=function(){var a;do{(a=r.apply(t))!=t.NO_ERROR&&(e[a]=!0)}while(a!=t.NO_ERROR);for(var i in e)if(e[i])return delete e[i],parseInt(i);return t.NO_ERROR}}(t);var a=this.original={getParameter:t.getParameter,enableVertexAttribArray:t.enableVertexAttribArray,disableVertexAttribArray:t.disableVertexAttribArray,bindBuffer:t.bindBuffer,getVertexAttrib:t.getVertexAttrib,vertexAttribPointer:t.vertexAttribPointer};t.getParameter=function(e){return e==r.VERTEX_ARRAY_BINDING_OES?r.currentVertexArrayObject==r.defaultVertexArrayObject?null:r.currentVertexArrayObject:a.getParameter.apply(this,arguments)},t.enableVertexAttribArray=function(e){var t=r.currentVertexArrayObject;t.maxAttrib=Math.max(t.maxAttrib,e);var i=t.attribs[e];return i.enabled=!0,a.enableVertexAttribArray.apply(this,arguments)},t.disableVertexAttribArray=function(e){var t=r.currentVertexArrayObject;t.maxAttrib=Math.max(t.maxAttrib,e);var i=t.attribs[e];return i.enabled=!1,a.disableVertexAttribArray.apply(this,arguments)},t.bindBuffer=function(e,i){switch(e){case t.ARRAY_BUFFER:r.currentArrayBuffer=i;break;case t.ELEMENT_ARRAY_BUFFER:r.currentVertexArrayObject.elementArrayBuffer=i}return a.bindBuffer.apply(this,arguments)},t.getVertexAttrib=function(e,i){var s=r.currentVertexArrayObject,n=s.attribs[e];switch(i){case t.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:return n.buffer;case t.VERTEX_ATTRIB_ARRAY_ENABLED:return n.enabled;case t.VERTEX_ATTRIB_ARRAY_SIZE:return n.size;case t.VERTEX_ATTRIB_ARRAY_STRIDE:return n.stride;case t.VERTEX_ATTRIB_ARRAY_TYPE:return n.type;case t.VERTEX_ATTRIB_ARRAY_NORMALIZED:return n.normalized;default:return a.getVertexAttrib.apply(this,arguments)}},t.vertexAttribPointer=function(e,t,i,s,n,o){var l=r.currentVertexArrayObject;l.maxAttrib=Math.max(l.maxAttrib,e);var h=l.attribs[e];return h.buffer=r.currentArrayBuffer,h.size=t,h.type=i,h.normalized=s,h.stride=n,h.offset=o,h.recache(),a.vertexAttribPointer.apply(this,arguments)},t.instrumentExtension&&t.instrumentExtension(this,"OES_vertex_array_object"),t.canvas.addEventListener("webglcontextrestored",(function(){var e;e="OESVertexArrayObject emulation library context restored",window.console&&window.console.log&&window.console.log(e),r.reset_()}),!0),this.reset_()};OESVertexArrayObject.prototype.VERTEX_ARRAY_BINDING_OES=34229,OESVertexArrayObject.prototype.reset_=function(){if(void 0!==this.vertexArrayObjects)for(var e=0;e<this.vertexArrayObjects.length;++e)this.vertexArrayObjects.isAlive=!1;var r=this.gl;this.maxVertexAttribs=r.getParameter(r.MAX_VERTEX_ATTRIBS),this.defaultVertexArrayObject=new t(this),this.currentVertexArrayObject=null,this.currentArrayBuffer=null,this.vertexArrayObjects=[this.defaultVertexArrayObject],this.bindVertexArrayOES(null)},OESVertexArrayObject.prototype.createVertexArrayOES=function(){var e=new t(this);return this.vertexArrayObjects.push(e),e},OESVertexArrayObject.prototype.deleteVertexArrayOES=function(e){e.isAlive=!1,this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(e),1),this.currentVertexArrayObject==e&&this.bindVertexArrayOES(null)},OESVertexArrayObject.prototype.isVertexArrayOES=function(e){return!!(e&&e instanceof t&&e.hasBeenBound&&e.ext==this)},OESVertexArrayObject.prototype.bindVertexArrayOES=function(e){var t=this.gl;if(!e||e.isAlive){var r=this.original,a=this.currentVertexArrayObject;this.currentVertexArrayObject=e||this.defaultVertexArrayObject,this.currentVertexArrayObject.hasBeenBound=!0;var i=this.currentVertexArrayObject;if(a!=i){a&&i.elementArrayBuffer==a.elementArrayBuffer||r.bindBuffer.call(t,t.ELEMENT_ARRAY_BUFFER,i.elementArrayBuffer);for(var s=this.currentArrayBuffer,n=Math.max(a?a.maxAttrib:0,i.maxAttrib),o=0;o<=n;o++){var l=i.attribs[o],h=a?a.attribs[o]:null;if(a&&l.enabled==h.enabled||(l.enabled?r.enableVertexAttribArray.call(t,o):r.disableVertexAttribArray.call(t,o)),l.enabled){var u=!1;a&&l.buffer==h.buffer||(s!=l.buffer&&(r.bindBuffer.call(t,t.ARRAY_BUFFER,l.buffer),s=l.buffer),u=!0),(u||l.cached!=h.cached)&&r.vertexAttribPointer.call(t,o,l.size,l.type,l.normalized,l.stride,l.offset)}}this.currentArrayBuffer!=s&&r.bindBuffer.call(t,t.ARRAY_BUFFER,this.currentArrayBuffer)}}else synthesizeGLError(t.INVALID_OPERATION,"bindVertexArrayOES: attempt to bind deleted arrayObject")},window._setupVertexArrayObject=function(e){var t=e.getSupportedExtensions;e.getSupportedExtensions=function(){var e=t.call(this)||[];return e.indexOf("OES_vertex_array_object")<0&&e.push("OES_vertex_array_object"),e};var r=e.getExtension;e.getExtension=function(e){var t=r.call(this,e);return t||("OES_vertex_array_object"!==e?null:(this.__OESVertexArrayObject||(console.log("Setup OES_vertex_array_object polyfill"),this.__OESVertexArrayObject=new OESVertexArrayObject(this)),this.__OESVertexArrayObject))}}}();class GlCapable{constructor(e){this._extentionVendorPrefixes=["","WEBKIT_","MOZ_"],this._gl=e.gl,this.initExtension(e.isWebGL2),this.initCapable(e.isWebGL2)}initCapable(t){this._capabilityMap=new Map;let r=t||!!this.getExtension(e.WebGLExtension.OES_element_index_uint);this._capabilityMap.set(e.RenderCapable.Element_Index_Uint32,r),r=t||!!this.getExtension(e.WebGLExtension.OES_texture_float),this._capabilityMap.set(e.RenderCapable.TextureFormat_R32G32B32A32,r),r=t||!!this.getExtension(e.WebGLExtension.OES_texture_half_float),this._capabilityMap.set(e.RenderCapable.TextureFormat_R16G16B16A16,r),r=!!this.getExtension(e.WebGLExtension.EXT_texture_filter_anisotropic),this._capabilityMap.set(e.RenderCapable.Texture_anisotropic,r),r=t?!!this.getExtension(e.WebGLExtension.EXT_color_buffer_float)||!!this.getExtension(e.WebGLExtension.EXT_color_buffer_half_float):!(!this.getExtension(e.WebGLExtension.OES_texture_half_float)&&!this.getExtension(e.WebGLExtension.EXT_color_buffer_half_float)||!this.getExtension(e.WebGLExtension.OES_texture_half_float_linear)),this._capabilityMap.set(e.RenderCapable.RenderTextureFormat_R16G16B16A16,r),r=t?!!this.getExtension(e.WebGLExtension.EXT_color_buffer_float)&&!!this.getExtension(e.WebGLExtension.OES_texture_float_linear):!!this.getExtension(e.WebGLExtension.OES_texture_float)&&!!this.getExtension(e.WebGLExtension.OES_texture_float_linear),this._capabilityMap.set(e.RenderCapable.RenderTextureFormat_R32G32B32A32,r),r=t||!!this.getExtension(e.WebGLExtension.WEBGL_depth_texture),this._capabilityMap.set(e.RenderCapable.RenderTextureFormat_Depth,r),r=t,this._capabilityMap.set(e.RenderCapable.RenderTextureFormat_ShadowMap,r),r=t||!!this.getExtension(e.WebGLExtension.OES_vertex_array_object),this._capabilityMap.set(e.RenderCapable.Vertex_VAO,r),r=t||!!this.getExtension(e.WebGLExtension.ANGLE_instanced_arrays),this._capabilityMap.set(e.RenderCapable.DrawElement_Instance,r),r=t||!!this.getExtension(e.WebGLExtension.EXT_shader_texture_lod),this._capabilityMap.set(e.RenderCapable.Shader_TextureLod,r),r=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_s3tc),this._capabilityMap.set(e.RenderCapable.COMPRESS_TEXTURE_S3TC,r),r=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_s3tc_srgb),this._capabilityMap.set(e.RenderCapable.COMPRESS_TEXTURE_S3TC_SRGB,r),r=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_pvrtc),this._capabilityMap.set(e.RenderCapable.COMPRESS_TEXTURE_PVRTC,r),r=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_etc1),this._capabilityMap.set(e.RenderCapable.COMPRESS_TEXTURE_ETC1,r),r=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_etc),this._capabilityMap.set(e.RenderCapable.COMPRESS_TEXTURE_ETC,r),r=!!this.getExtension(e.WebGLExtension.WEBGL_compressed_texture_astc),this._capabilityMap.set(e.RenderCapable.COMPRESS_TEXTURE_ASTC,r),r=t||!!this.getExtension(e.WebGLExtension.EXT_sRGB),this._capabilityMap.set(e.RenderCapable.Texture_SRGB,r),r=!!this.getExtension(e.WebGLExtension.OES_texture_float_linear),this._capabilityMap.set(e.RenderCapable.Texture_FloatLinearFiltering,r),r=t||!!this.getExtension(e.WebGLExtension.OES_texture_half_float_linear),this._capabilityMap.set(e.RenderCapable.Texture_HalfFloatLinearFiltering,r),r=t,this._capabilityMap.set(e.RenderCapable.MSAA,r),this._capabilityMap.set(e.RenderCapable.UnifromBufferObject,r),this._capabilityMap.set(e.RenderCapable.Texture3D,r)}initExtension(t){this._extensionMap=new Map;const setExtensionMap=(e,t,r)=>{t&&r.set(e,t)},r=this._getExtension("EXT_texture_filter_anisotropic");setExtensionMap(e.WebGLExtension.EXT_texture_filter_anisotropic,r,this._extensionMap);const a=this._getExtension("WEBGL_compressed_texture_s3tc");setExtensionMap(e.WebGLExtension.WEBGL_compressed_texture_s3tc,a,this._extensionMap);const i=this._getExtension("WEBGL_compressed_texture_s3tc_srgb");setExtensionMap(e.WebGLExtension.WEBGL_compressed_texture_s3tc_srgb,i,this._extensionMap);const s=this._getExtension("WEBGL_compressed_texture_pvrtc");setExtensionMap(e.WebGLExtension.WEBGL_compressed_texture_pvrtc,s,this._extensionMap);const n=this._getExtension("WEBGL_compressed_texture_etc1");setExtensionMap(e.WebGLExtension.WEBGL_compressed_texture_etc1,n,this._extensionMap);const o=this._getExtension("WEBGL_compressed_texture_etc");setExtensionMap(e.WebGLExtension.WEBGL_compressed_texture_etc,o,this._extensionMap);const l=this._getExtension("WEBGL_compressed_texture_astc");setExtensionMap(e.WebGLExtension.WEBGL_compressed_texture_astc,l,this._extensionMap);const h=this._getExtension("OES_texture_float_linear");setExtensionMap(e.WebGLExtension.OES_texture_float_linear,h,this._extensionMap);const u=this._getExtension("EXT_color_buffer_half_float");if(setExtensionMap(e.WebGLExtension.EXT_color_buffer_half_float,u,this._extensionMap),t){const t=this._getExtension("EXT_color_buffer_float");setExtensionMap(e.WebGLExtension.EXT_color_buffer_float,t,this._extensionMap)}else{window._setupVertexArrayObject&&window._setupVertexArrayObject(this._gl);const t=this._getExtension("OES_vertex_array_object");setExtensionMap(e.WebGLExtension.OES_vertex_array_object,t,this._extensionMap);const r=this._getExtension("ANGLE_instanced_arrays");setExtensionMap(e.WebGLExtension.ANGLE_instanced_arrays,r,this._extensionMap);const a=this._getExtension("OES_texture_half_float");setExtensionMap(e.WebGLExtension.OES_texture_half_float,a,this._extensionMap);const i=this._getExtension("OES_texture_half_float_linear");setExtensionMap(e.WebGLExtension.OES_texture_half_float_linear,i,this._extensionMap);const s=this._getExtension("OES_texture_float");setExtensionMap(e.WebGLExtension.OES_texture_float,s,this._extensionMap);const n=this._getExtension("OES_element_index_uint");setExtensionMap(e.WebGLExtension.OES_element_index_uint,n,this._extensionMap);const o=this._getExtension("EXT_shader_texture_lod");setExtensionMap(e.WebGLExtension.EXT_shader_texture_lod,o,this._extensionMap);const l=this._getExtension("WEBGL_depth_texture");setExtensionMap(e.WebGLExtension.WEBGL_depth_texture,l,this._extensionMap);const h=this._getExtension("EXT_sRGB");setExtensionMap(e.WebGLExtension.EXT_sRGB,h,this._extensionMap);const u=this._getExtension("OES_standard_derivatives");setExtensionMap(e.WebGLExtension.OES_standard_derivatives,u,this._extensionMap)}}getCapable(e){return this._capabilityMap.get(e)}getExtension(e){return this._extensionMap.has(e)?this._extensionMap.get(e):null}_getExtension(e){const t=this._extentionVendorPrefixes;for(const a in t){var r=this._gl.getExtension(t[a]+e);if(r)return r}return null}}class GLParams{constructor(e){this._engine=e,this._gl=this._engine.gl,this._initParams()}_initParams(){const t=this._gl;this._glParamsData=new Map,this._glParamsData.set(e.RenderParams.Max_Active_Texture_Count,t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS));const r=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),a=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS);if(this._glParamsData.set(e.RenderParams.Max_Uniform_Count,Math.min(r,a)),this._glParamsData.set(e.RenderParams.MAX_Texture_Size,t.getParameter(t.MAX_TEXTURE_SIZE)),this._glParamsData.set(e.RenderParams.MAX_Texture_Image_Uint,t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS)),this._engine.getCapable(e.RenderCapable.Texture_anisotropic)){const r=this._engine._supportCapatable.getExtension(e.WebGLExtension.EXT_texture_filter_anisotropic);this._glParamsData.set(e.RenderParams.Max_AnisoLevel_Count,t.getParameter(r.MAX_TEXTURE_MAX_ANISOTROPY_EXT))}this._engine.isWebGL2?this._glParamsData.set(e.RenderParams.SHADER_CAPAILITY_LEVEL,35):this._glParamsData.set(e.RenderParams.SHADER_CAPAILITY_LEVEL,30),this._glParamsData.set(e.RenderParams.FLOAT,t.FLOAT),this._glParamsData.set(e.RenderParams.UNSIGNED_BYTE,t.UNSIGNED_BYTE),this._glParamsData.set(e.RenderParams.UNSIGNED_SHORT,t.UNSIGNED_SHORT),this._glParamsData.set(e.RenderParams.BYTE,t.BYTE)}getParams(e){return this._glParamsData.get(e)}}class GLRender2DContext extends GLObject{constructor(e){super(e)}activeTexture(e){this._engine._activedTextureID!==e&&(this._gl.activeTexture(e),this._engine._activedTextureID=e)}bindTexture(e,t){this._engine._bindTexture(e,t)}bindUseProgram(e){return this.cacheShaderProgram!=e&&(this._gl.useProgram(e),this._engine._glUseProgram=null,!0)}}class GLRenderDrawContext extends GLObject{constructor(t){super(t),this._engine.isWebGL2||(this._angleInstancedArrays=this._engine._supportCapatable.getExtension(e.WebGLExtension.ANGLE_instanced_arrays))}getMeshTopology(t){switch(t){case e.MeshTopology.Points:return this._gl.POINTS;case e.MeshTopology.Lines:return this._gl.LINES;case e.MeshTopology.LineLoop:return this._gl.LINE_LOOP;case e.MeshTopology.LineStrip:return this._gl.LINE_STRIP;case e.MeshTopology.Triangles:return this._gl.TRIANGLES;case e.MeshTopology.TriangleStrip:return this._gl.TRIANGLE_STRIP;case e.MeshTopology.TriangleFan:return this._gl.TRIANGLE_FAN}}getIndexType(t){switch(t){case e.IndexFormat.UInt8:return this._gl.UNSIGNED_BYTE;case e.IndexFormat.UInt16:return this._gl.UNSIGNED_SHORT;case e.IndexFormat.UInt32:return this._gl.UNSIGNED_INT}}drawElementsInstanced(t,r,a,i,s){this._engine.isWebGL2?this._gl.drawElementsInstanced(t,r,a,i,s):this._angleInstancedArrays.drawElementsInstancedANGLE(t,r,a,i,s),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.DrawCall,1),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.InstanceDrawCall,1),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.Triangle,r/3*s)}drawArraysInstanced(t,r,a,i){this._engine.isWebGL2?this._gl.drawArraysInstanced(t,r,a,i):this._angleInstancedArrays.drawArraysInstancedANGLE(t,r,a,i),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.DrawCall,1),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.InstanceDrawCall,1),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.Triangle,(a-2)*i)}drawArrays(t,r,a){this._gl.drawArrays(t,r,a),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.DrawCall,1),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.Triangle,a-2)}drawElements(t,r,a,i){this._gl.drawElements(t,r,a,i),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.DrawCall,1),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.Triangle,r/3)}drawElements2DTemp(t,r,a,i){t=this.getMeshTopology(t),a=this.getIndexType(a),this._gl.drawElements(t,r,a,i),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.DrawCall,1),this._engine._addStatisticsInfo(e.RenderStatisticsInfo.Triangle,r/3)}drawGeometryElement(t){t.bufferState.bind();let r=t.drawParams.elements,a=t.drawParams.length;switch(t.drawType){case e.DrawType.DrawArray:for(let e=0;e<a;e+=2)this.drawArrays(t._glmode,r[e],r[e+1]);break;case e.DrawType.DrawElement:for(let e=0;e<a;e+=2)this.drawElements(t._glmode,r[e+1],t._glindexFormat,r[e]);break;case e.DrawType.DrawArrayInstance:for(let e=0;e<a;e+=2)this.drawArraysInstanced(t._glmode,r[e],r[e+1],t.instanceCount);break;case e.DrawType.DrawElementInstance:for(let e=0;e<a;e+=2)this.drawElementsInstanced(t._glmode,r[e+1],t._glindexFormat,r[e],t.instanceCount)}}}class GLRenderState{constructor(e){this._depthTest=!0,this._depthMask=!0,this._stencilTest=!1,this._blend=!1,this._cullFace=!1,this._engine=e,this._gl=this._engine.gl,this._initState()}_initState(){this._gl,this.setDepthFunc(e.CompareFunction.Less),this.setBlendEquationSeparate(e.BlendEquationSeparate.ADD,e.BlendEquationSeparate.ADD),this._blendEquation=e.BlendEquationSeparate.ADD,this._sFactor=e.BlendFactor.One,this._dFactor=e.BlendFactor.Zero,this._sFactorAlpha=e.BlendFactor.One,this._dFactorAlpha=e.BlendFactor.One}_getBlendFactor(t){const r=this._gl;switch(t){case e.BlendFactor.Zero:return r.ZERO;case e.BlendFactor.One:return r.ONE;case e.BlendFactor.SourceColor:return r.SRC_COLOR;case e.BlendFactor.OneMinusSourceColor:return r.ONE_MINUS_SRC_COLOR;case e.BlendFactor.DestinationColor:return r.DST_COLOR;case e.BlendFactor.OneMinusDestinationColor:return r.ONE_MINUS_DST_COLOR;case e.BlendFactor.SourceAlpha:return r.SRC_ALPHA;case e.BlendFactor.OneMinusSourceAlpha:return r.ONE_MINUS_SRC_ALPHA;case e.BlendFactor.DestinationAlpha:return r.DST_ALPHA;case e.BlendFactor.OneMinusDestinationAlpha:return r.ONE_MINUS_DST_ALPHA;case e.BlendFactor.SourceAlphaSaturate:return r.SRC_ALPHA_SATURATE;case e.BlendFactor.BlendColor:return r.CONSTANT_COLOR;case e.BlendFactor.OneMinusBlendColor:return r.ONE_MINUS_CONSTANT_COLOR}}_getBlendOperation(t){const r=this._gl;switch(t){case e.BlendEquationSeparate.ADD:return r.FUNC_ADD;case e.BlendEquationSeparate.SUBTRACT:return r.FUNC_SUBTRACT;case e.BlendEquationSeparate.REVERSE_SUBTRACT:return r.FUNC_REVERSE_SUBTRACT;default:throw"Unknow type"}}_getGLCompareFunction(t){const r=this._gl;switch(t){case e.CompareFunction.Never:return r.NEVER;case e.CompareFunction.Less:return r.LESS;case e.CompareFunction.Equal:return r.EQUAL;case e.CompareFunction.LessEqual:return r.LEQUAL;case e.CompareFunction.Greater:return r.GREATER;case e.CompareFunction.NotEqual:return r.NOTEQUAL;case e.CompareFunction.GreaterEqual:return r.GEQUAL;case e.CompareFunction.Always:return r.ALWAYS;default:return r.LEQUAL}}_getGLStencilOperation(t){const r=this._gl;switch(t){case e.StencilOperation.Keep:return r.KEEP;case e.StencilOperation.Zero:return r.ZERO;case e.StencilOperation.Replace:return r.REPLACE;case e.StencilOperation.IncrementSaturate:return r.INCR;case e.StencilOperation.DecrementSaturate:return r.DECR;case e.StencilOperation.Invert:return r.INVERT;case e.StencilOperation.IncrementWrap:return r.INCR_WRAP;case e.StencilOperation.DecrementWrap:return r.DECR_WRAP}}_getGLFrontfaceFactor(t){return t==e.CullMode.Front?this._gl.CCW:this._gl.CW}setDepthTest(e){e!==this._depthTest&&(this._depthTest=e,e?this._gl.enable(this._gl.DEPTH_TEST):this._gl.disable(this._gl.DEPTH_TEST))}setDepthMask(e){e!==this._depthMask&&(this._depthMask=e,this._gl.depthMask(e))}setDepthFunc(e){e!==this._depthFunc&&(this._depthFunc=e,this._gl.depthFunc(this._getGLCompareFunction(e)))}setStencilTest(e){e!==this._stencilTest&&(this._stencilTest=e,e?this._gl.enable(this._gl.STENCIL_TEST):this._gl.disable(this._gl.STENCIL_TEST))}setStencilMask(e){e!==this._stencilMask&&(this._stencilMask=e,e?this._gl.stencilMask(255):this._gl.stencilMask(0))}setStencilFunc(e,t){e==this._stencilFunc&&t==this._stencilRef||(this._stencilFunc=e,this._stencilRef=t,this._gl.stencilFunc(this._getGLCompareFunction(e),t,255))}setstencilOp(e,t,r){this._stencilOp_fail==e&&this._stencilOp_zfail==t&&this._stencilOp_zpass==r||(this._stencilOp_fail=e,this._stencilOp_zfail=t,this._stencilOp_zpass=r,this._gl.stencilOp(this._getGLStencilOperation(e),this._getGLStencilOperation(t),this._getGLStencilOperation(r)))}setBlend(e){e!==this._blend&&(this._blend=e,e?this._gl.enable(this._gl.BLEND):this._gl.disable(this._gl.BLEND))}setBlendEquation(e){e!==this._blendEquation&&(this._blendEquation=e,this._blendEquationRGB=this._blendEquationAlpha=null,this._gl.blendEquation(this._getBlendOperation(e)))}setBlendEquationSeparate(e,t){e===this._blendEquationRGB&&t===this._blendEquationAlpha||(this._blendEquationRGB=e,this._blendEquationAlpha=t,this._blendEquation=null,this._gl.blendEquationSeparate(this._getBlendOperation(e),this._getBlendOperation(t)))}setBlendFunc(e,t,r=!1){(r||e!==this._sFactor||t!==this._dFactor)&&(this._sFactor=e,this._dFactor=t,this._sFactorRGB=null,this._dFactorRGB=null,this._sFactorAlpha=null,this._dFactorAlpha=null,this._gl.blendFunc(this._getBlendFactor(e),this._getBlendFactor(t)))}setBlendFuncSeperate(e,t,r,a){e===this._sFactorRGB&&t===this._dFactorRGB&&r===this._sFactorAlpha&&a===this._dFactorAlpha||(this._sFactorRGB=e,this._dFactorRGB=t,this._sFactorAlpha=r,this._dFactorAlpha=a,this._sFactor=null,this._dFactor=null,this._gl.blendFuncSeparate(this._getBlendFactor(e),this._getBlendFactor(t),this._getBlendFactor(r),this._getBlendFactor(a)))}setCullFace(e){e!==this._cullFace&&(this._cullFace=e,e?this._gl.enable(this._gl.CULL_FACE):this._gl.disable(this._gl.CULL_FACE))}setFrontFace(e){e!==this._frontFace&&(this._frontFace=e,this._gl.frontFace(this._getGLFrontfaceFactor(e)))}applyRenderStateCommand(t){t.cmdArray.forEach(((t,r)=>{switch(r){case e.RenderStateType.DepthTest:this.setDepthTest(t);break;case e.RenderStateType.DepthMask:this.setDepthMask(t);break;case e.RenderStateType.DepthFunc:this.setDepthFunc(t);break;case e.RenderStateType.StencilTest:this.setStencilTest(t);break;case e.RenderStateType.StencilMask:this.setStencilMask(t);break;case e.RenderStateType.StencilFunc:this.setStencilFunc(t[0],t[1]);break;case e.RenderStateType.StencilOp:this.setstencilOp(t[0],t[1],t[2]);break;case e.RenderStateType.BlendType:this.setBlend(t!=e.BlendType.BLEND_DISABLE);break;case e.RenderStateType.BlendEquation:this.setBlendEquation(t);break;case e.RenderStateType.BlendEquationSeparate:this.setBlendEquationSeparate(t[0],t[1]);break;case e.RenderStateType.BlendFunc:this.setBlendFunc(t[0],t[1]);break;case e.RenderStateType.BlendFuncSeperate:this.setBlendFuncSeperate(t[0],t[1],t[2],t[3]);break;case e.RenderStateType.CullFace:this.setCullFace(t);break;case e.RenderStateType.FrontFace:this.setFrontFace(t);break;default:throw"unknow type of renderStateType"}}))}}class GLShaderInstance extends GLObject{constructor(e,t,r,a){super(e),this._complete=!0,this._vs=t,this._ps=r,this._attributeMap=a,this._uniformMap=[],this._create()}_create(){const e=this._gl;for(var t in this._program=e.createProgram(),this._vshader=this._createShader(e,this._vs,e.VERTEX_SHADER),this._pshader=this._createShader(e,this._ps,e.FRAGMENT_SHADER),e.attachShader(this._program,this._vshader),e.attachShader(this._program,this._pshader),this._attributeMap)e.bindAttribLocation(this._program,this._attributeMap[t][0],t);e.linkProgram(this._program);if(!e.getProgramParameter(this._program,e.LINK_STATUS)){var r=e.getProgramInfoLog(this._program);return console.error(new Error("Could not compile WebGL program. \n\n"+r)),void(this._complete=!1)}const a=e.getProgramParameter(this._program,e.ACTIVE_UNIFORMS);let i,s;for(this.useProgram(),this._curActTexIndex=0,s=0;s<a;s++){var n=e.getActiveUniform(this._program,s),o=n.name;let t=e.getUniformLocation(this._program,o);(t||0==t)&&(i=new ShaderVariable,i.location=t,o.indexOf("[0]")>0?(i.name=o=o.substr(0,o.length-3),i.isArray=!0):(i.name=o,i.isArray=!1),i.type=n.type,this._addShaderUnifiormFun(i),this._uniformMap.push(i),i.dataOffset=this._engine.propertyNameToID(o))}if(this._engine.isWebGL2){this._uniformObjectMap={};var l=e.getProgramParameter(this._program,e.ACTIVE_UNIFORM_BLOCKS);for(s=0;s<l;s++){let t=e;var h=t.getActiveUniformBlockName(this._program,s);i=new ShaderVariable,i.name=h,i.isArray=!1,i.type=e.UNIFORM_BUFFER,i.dataOffset=this._engine.propertyNameToID(h);let r=i.location=t.getUniformBlockIndex(this._program,h);t.uniformBlockBinding(this._program,r,this._engine.getUBOPointer(h)),this._uniformObjectMap[i.name]=i,this._uniformMap.push(i),this._addShaderUnifiormFun(i)}}}_legalUBObyteLength(e){return 16*Math.ceil(e/16)}_createShader(e,t,r){var a=e.createShader(r);return e.shaderSource(a,t),e.compileShader(a),this._engine._isShaderDebugMode&&!e.getShaderParameter(a,e.COMPILE_STATUS)&&(LayaEnv.isPlaying?console.error(e.getShaderInfoLog(a)):console.warn(e.getShaderInfoLog(a))),a}_addShaderUnifiormFun(e){var t=this._gl;e.caller=this;var r=e.isArray;switch(e.type){case t.BOOL:e.fun=this._uniform1i,e.uploadedValue=new Array(1);break;case t.INT:e.fun=r?this._uniform1iv:this._uniform1i,e.uploadedValue=new Array(1);break;case t.FLOAT:e.fun=r?this._uniform1fv:this._uniform1f,e.uploadedValue=new Array(1);break;case t.FLOAT_VEC2:e.fun=r?this._uniform_vec2v:this._uniform_vec2,e.uploadedValue=new Array(2);break;case t.FLOAT_VEC3:e.fun=r?this._uniform_vec3v:this._uniform_vec3,e.uploadedValue=new Array(3);break;case t.FLOAT_VEC4:e.fun=r?this._uniform_vec4v:this._uniform_vec4,e.uploadedValue=new Array(4);break;case t.FLOAT_MAT2:e.fun=this._uniformMatrix2fv;break;case t.FLOAT_MAT3:e.fun=this._uniformMatrix3fv;break;case t.FLOAT_MAT4:e.fun=r?this._uniformMatrix4fv:this._uniformMatrix4f;break;case t.SAMPLER_2D:case t.SAMPLER_2D_SHADOW:t.uniform1i(e.location,this._curActTexIndex),e.textureID=this._engine._glTextureIDParams[this._curActTexIndex++],e.fun=this._uniform_sampler2D;break;case t.SAMPLER_2D_ARRAY:t.uniform1i(e.location,this._curActTexIndex),e.textureID=this._engine._glTextureIDParams[this._curActTexIndex++],e.fun=this._uniform_sampler2DArray;break;case 35679:t.uniform1i(e.location,this._curActTexIndex),e.textureID=this._engine._glTextureIDParams[this._curActTexIndex++],e.fun=this._uniform_sampler3D;break;case t.SAMPLER_CUBE:t.uniform1i(e.location,this._curActTexIndex),e.textureID=this._engine._glTextureIDParams[this._curActTexIndex++],e.fun=this._uniform_samplerCube;break;case t.UNIFORM_BUFFER:e.fun=this._uniform_UniformBuffer;break;default:throw new Error("compile shader err!")}}getUniformMap(){return this._uniformMap}bind(){return this.useProgram()}useProgram(){return this._engine._glUseProgram!==this&&(this._gl.useProgram(this._program),this._engine._glUseProgram=this,!0)}_uniform1f(e,t){var r=e.uploadedValue;return r[0]!==t?(this._gl.uniform1f(e.location,r[0]=t),1):0}_uniform1fv(e,t){if(t.length<4){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]||r[2]!==t[2]||r[3]!==t[3]?(this._gl.uniform1fv(e.location,t),r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],1):0}return this._gl.uniform1fv(e.location,t),1}_uniform_vec2(e,t){var r=e.uploadedValue;return r[0]!==t.x||r[1]!==t.y?(this._gl.uniform2f(e.location,r[0]=t.x,r[1]=t.y),1):0}_uniform_vec2v(e,t){if(t.length<2){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]||r[2]!==t[2]||r[3]!==t[3]?(this._gl.uniform2fv(e.location,t),r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],1):0}return this._gl.uniform2fv(e.location,t),1}_uniform_vec3(e,t){var r=e.uploadedValue;return r[0]!==t.x||r[1]!==t.y||r[2]!==t.z?(this._gl.uniform3f(e.location,r[0]=t.x,r[1]=t.y,r[2]=t.z),1):0}_uniform_vec3v(e,t){return this._gl.uniform3fv(e.location,t),1}_uniform_vec4(e,t){var r=e.uploadedValue;return r[0]!==t.x||r[1]!==t.y||r[2]!==t.z||r[3]!==t.w?(this._gl.uniform4f(e.location,r[0]=t.x,r[1]=t.y,r[2]=t.z,r[3]=t.w),1):0}_uniform_vec4v(e,t){return this._gl.uniform4fv(e.location,t),1}_uniformMatrix2fv(e,t){return this._gl.uniformMatrix2fv(e.location,!1,t),1}_uniformMatrix3fv(e,t){let r=t.elements;return this._gl.uniformMatrix3fv(e.location,!1,r),1}_uniformMatrix4f(e,t){var r=t.elements;return this._gl.uniformMatrix4fv(e.location,!1,r),1}_uniformMatrix4fv(e,t){return this._gl.uniformMatrix4fv(e.location,!1,t),1}_uniform1i(e,t){var r=e.uploadedValue;return r[0]!==t?(this._gl.uniform1i(e.location,r[0]=t),1):0}_uniform1iv(e,t){return this._gl.uniform1iv(e.location,t),1}_uniform_ivec2(e,t){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]?(this._gl.uniform2i(e.location,r[0]=t[0],r[1]=t[1]),1):0}_uniform_ivec2v(e,t){return this._gl.uniform2iv(e.location,t),1}_uniform_vec3i(e,t){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]||r[2]!==t[2]?(this._gl.uniform3i(e.location,r[0]=t[0],r[1]=t[1],r[2]=t[2]),1):0}_uniform_vec3vi(e,t){return this._gl.uniform3iv(e.location,t),1}_uniform_vec4i(e,t){var r=e.uploadedValue;return r[0]!==t[0]||r[1]!==t[1]||r[2]!==t[2]||r[3]!==t[3]?(this._gl.uniform4i(e.location,r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3]),1):0}_uniform_vec4vi(e,t){return this._gl.uniform4iv(e.location,t),1}_uniform_sampler2D(e,t){var r=t?t._getSource():Texture2D.errorTexture._getSource(),a=this._gl;return this._bindTexture(e.textureID,a.TEXTURE_2D,r),0}_uniform_sampler2DArray(e,t){var r=t?t._getSource():Texture2D.errorTexture._getSource(),a=this._gl;return this._bindTexture(e.textureID,a.TEXTURE_2D_ARRAY,r),0}_uniform_sampler3D(e,t){var r=t?t._getSource():Texture2D.errorTexture._getSource(),a=this._gl;return this._bindTexture(e.textureID,a.TEXTURE_3D,r),0}_uniform_samplerCube(e,t){var r=t?t._getSource():TextureCube.errorTexture._getSource(),a=this._gl;return this._bindTexture(e.textureID,a.TEXTURE_CUBE_MAP,r),0}_uniform_UniformBuffer(e,t){return t._bindUniformBufferBase(),1}_bindTexture(e,t,r){const a=this._gl;this._engine._activedTextureID!==e&&(a.activeTexture(e),this._engine._activedTextureID=e);const i=this._engine._activedTextureID-this._gl.TEXTURE0;this._engine._activeTextures[i]!==r&&(a.bindTexture(t,r),this._engine._activeTextures[i]=r)}destroy(){super.destroy();const e=this._gl;e.deleteShader(this._vshader),e.deleteShader(this._pshader),e.deleteProgram(this._program),this._vshader=null,this._pshader=null,this._program=null,this._attributeMap=null,this._uniformMap=null,this._uniformObjectMap=null,this._gl=null,this._engine=null}}class GLVertexState extends GLObject{constructor(t){super(t),this._vertexDeclaration=[],t.isWebGL2||(this._vaoExt=t._supportCapatable.getExtension(e.WebGLExtension.OES_vertex_array_object)),this._vao=this.createVertexArray(),this._angleInstancedArrays=this._engine._supportCapatable.getExtension(e.WebGLExtension.ANGLE_instanced_arrays)}createVertexArray(){return this._engine.isWebGL2?this._gl.createVertexArray():this._vaoExt.createVertexArrayOES()}deleteVertexArray(){this._engine.isWebGL2?this._gl.deleteVertexArray(this._vao):this._vaoExt.deleteVertexArrayOES(this._vao)}bindVertexArray(){this._engine._GLBindVertexArray!=this&&(this._engine.isWebGL2?this._gl.bindVertexArray(this._vao):this._vaoExt.bindVertexArrayOES(this._vao),this._engine._GLBindVertexArray=this)}unbindVertexArray(){this._engine.isWebGL2?this._gl.bindVertexArray(null):this._vaoExt.bindVertexArrayOES(null),this._engine._GLBindVertexArray=null}isVertexArray(){this._engine.isWebGL2?this._gl.isVertexArray(this._vao):this._vaoExt.isVertexArrayOES(this._vao)}applyVertexBuffer(e){if(this.clearVAO(),this._vertexBuffers=e,this._engine._GLBindVertexArray!=this)throw"BufferState: must call bind() function first.";this._vertexDeclaration.length=e.length;var t=0;e.forEach((e=>{var r=e.vertexDeclaration;this._vertexDeclaration[t++]=e.vertexDeclaration;var a=r._shaderValues;for(var i in e.bind(),a){var s=parseInt(i),n=a[i];this._gl.enableVertexAttribArray(s),this._gl.vertexAttribPointer(s,n[0],n[1],!!n[2],n[3],n[4]),e.instanceBuffer&&this.vertexAttribDivisor(s,1)}}))}clearVAO(){for(let a=0,i=this._vertexDeclaration.length;a<i;a++){var e=this._vertexDeclaration[a]._shaderValues;for(var t in e){var r=parseInt(t);this._gl.disableVertexAttribArray(r)}}}applyIndexBuffer(e){if(null!=e){if(this._engine._GLBindVertexArray!=this)throw"BufferState: must call bind() function first.";this._bindedIndexBuffer!==e&&(e.bind(),this._bindedIndexBuffer=e)}}vertexAttribDivisor(e,t){this._engine.isWebGL2?this._gl.vertexAttribDivisor(e,t):this._angleInstancedArrays.vertexAttribDivisorANGLE(e,t)}destroy(){super.destroy(),this._gl,this.deleteVertexArray(),this._gl=null,this._engine=null}}class WebGLEngine{constructor(t,r=e.WebGLMode.Auto){this._propertyNameMap={},this._propertyNameCounter=0,this._IDCounter=0,this._isShaderDebugMode=!0,this._curUBOPointer=0,this._GLUBOPointerMap=new Map,this._GLBindPointerUBOMap=new Map,this._lastClearColor=new Color,this._lastClearDepth=1,this._GLStatisticsInfo=new Map,this._config=t,this._isWebGL2=!1,this._lastViewport=new Vector4(0,0,0,0),this._lastClearColor=new Color(0,0,0,0),this._lastScissor=new Vector4(0,0,0,0),this._webglMode=r,this._initStatisticsInfo()}get gl(){return this._context}get isWebGL2(){return this._isWebGL2}get webglConfig(){return this._config}_initStatisticsInfo(){this._GLStatisticsInfo.set(e.RenderStatisticsInfo.DrawCall,0),this._GLStatisticsInfo.set(e.RenderStatisticsInfo.InstanceDrawCall,0),this._GLStatisticsInfo.set(e.RenderStatisticsInfo.Triangle,0),this._GLStatisticsInfo.set(e.RenderStatisticsInfo.UniformUpload,0),this._GLStatisticsInfo.set(e.RenderStatisticsInfo.TextureMemeory,0),this._GLStatisticsInfo.set(e.RenderStatisticsInfo.GPUMemory,0),this._GLStatisticsInfo.set(e.RenderStatisticsInfo.RenderTextureMemory,0),this._GLStatisticsInfo.set(e.RenderStatisticsInfo.BufferMemory,0)}_addStatisticsInfo(e,t){this._GLStatisticsInfo.set(e,this._GLStatisticsInfo.get(e)+t)}clearStatisticsInfo(e){this._GLStatisticsInfo.set(e,0)}getStatisticsInfo(e){return this._GLStatisticsInfo.get(e)}_getBindUBOBuffer(e){return this._GLBindPointerUBOMap.get(e)}_setBindUBOBuffer(e,t){this._GLBindPointerUBOMap.set(e,t)}initRenderEngine(t){let r,a;switch(this._webglMode){case e.WebGLMode.Auto:r=["webgl2","experimental-webgl2","webgl","experimental-webgl"];break;case e.WebGLMode.WebGL1:r=["webgl","experimental-webgl"];break;case e.WebGLMode.WebGL2:r=["webgl2","experimental-webgl2"]}for(var i=0;i<r.length;i++){try{a=t.getContext(r[i],this._config)}catch(e){}if(a){"webgl2"!==r[i]&&"experimental-webgl2"!==r[i]||(this._isWebGL2=!0);break}}this._context=a,this._initBindBufferMap(),this._supportCapatable=new GlCapable(this),this._GLParams=new GLParams(this),this._GLRenderState=new GLRenderState(this),this._glTextureIDParams=[a.TEXTURE0,a.TEXTURE1,a.TEXTURE2,a.TEXTURE3,a.TEXTURE4,a.TEXTURE5,a.TEXTURE6,a.TEXTURE7,a.TEXTURE8,a.TEXTURE9,a.TEXTURE10,a.TEXTURE11,a.TEXTURE12,a.TEXTURE13,a.TEXTURE14,a.TEXTURE15,a.TEXTURE16,a.TEXTURE17,a.TEXTURE18,a.TEXTURE19,a.TEXTURE20,a.TEXTURE21,a.TEXTURE22,a.TEXTURE23,a.TEXTURE24,a.TEXTURE25,a.TEXTURE26,a.TEXTURE27,a.TEXTURE28,a.TEXTURE29,a.TEXTURE30,a.TEXTURE31],this._activedTextureID=a.TEXTURE0,this._activeTextures=[],this._GLTextureContext=this.isWebGL2?new GL2TextureContext(this):new GLTextureContext(this),this._GLRenderDrawContext=new GLRenderDrawContext(this),this._GL2DRenderContext=new GLRender2DContext(this)}_initBindBufferMap(){this._GLBufferBindMap={},this._GLBufferBindMap[e.BufferTargetType.ARRAY_BUFFER]=null,this._GLBufferBindMap[e.BufferTargetType.ELEMENT_ARRAY_BUFFER]=null,this._GLBufferBindMap[e.BufferTargetType.UNIFORM_BUFFER]=null}_getbindBuffer(e){return this._GLBufferBindMap[e]}_setbindBuffer(e,t){this._GLBufferBindMap[e]=t}_bindTexture(e,t){const r=this._activedTextureID-this._context.TEXTURE0;this._activeTextures[r]!==t&&(this._context.bindTexture(e,t),this._activeTextures[r]=t)}bindTexture(e){this._bindTexture(e._texture.target,e._getSource())}applyRenderStateCMD(e){this._GLRenderState.applyRenderStateCommand(e)}getCapable(e){return this._supportCapatable.getCapable(e)}viewport(e,t,r,a){const i=this._context,s=this._lastViewport;LayaEnv.isConch?i.viewport(e,t,r,a):e===s.x&&t===s.y&&r===s.z&&a===s.w||(i.viewport(e,t,r,a),s.setValue(e,t,r,a))}scissor(e,t,r,a){const i=this._context,s=this._lastScissor;LayaEnv.isConch?i.scissor(e,t,r,a):e===s.x&&t===s.y&&r===s.z&&a===s.w||(i.scissor(e,t,r,a),s.setValue(e,t,r,a))}scissorTest(e){e?this._context.enable(this._context.SCISSOR_TEST):this._context.disable(this._context.SCISSOR_TEST)}clearRenderTexture(t,r=null,a=1){var i;t&e.RenderClearFlag.Color&&(r&&!this._lastClearColor.equal(r)&&(this._context.clearColor(r.r,r.g,r.b,r.a),r.cloneTo(this._lastClearColor)),i|=this.gl.COLOR_BUFFER_BIT),t&e.RenderClearFlag.Depth&&(this._lastClearDepth!=a&&(this._context.clearDepth(a),this._lastClearDepth=a),this._GLRenderState.setDepthMask(!0),i|=this._context.DEPTH_BUFFER_BIT),t&e.RenderClearFlag.Stencil&&(this._context.clearStencil(0),this._GLRenderState.setStencilMask(!0),i|=this._context.STENCIL_BUFFER_BIT),i&&this._context.clear(i)}copySubFrameBuffertoTex(e,t,r,a,i,s,n,o){this._bindTexture(e._texture.target,e._getSource()),this._context.copyTexSubImage2D(e._texture.target,t,r,a,i,s,n,o)}colorMask(e,t,r,a){this._context.colorMask(e,t,r,a)}getParams(e){return this._GLParams.getParams(e)}createBuffer(e,t){return new GLBuffer(this,e,t)}createShaderInstance(e,t,r){return new GLShaderInstance(this,e,t,r)}createVertexState(){return new GLVertexState(this)}getUBOPointer(e){return this._GLUBOPointerMap.has(e)||this._GLUBOPointerMap.set(e,this._curUBOPointer++),this._GLUBOPointerMap.get(e)}getTextureContext(){return this._GLTextureContext}getDrawContext(){return this._GLRenderDrawContext}get2DRenderContext(){return this._GL2DRenderContext}getCreateRenderOBJContext(){return this._renderOBJCreateContext}propertyNameToID(e){if(null!=this._propertyNameMap[e])return this._propertyNameMap[e];var t=this._propertyNameCounter++;return this._propertyNameMap[e]=t,this._propertyNameMap[t]=e,t}propertyIDToName(e){return this._propertyNameMap[e]}uploadUniforms(e,t,r,a){r.applyUBO&&r.applyUBOData();for(var i=r._data,s=t.getArrayData(),n=0,o=0,l=s.length;o<l;o++){var h=s[o];if(a||-1!==h.textureID){var u=i[h.dataOffset];null!=u&&(n+=h.fun.call(h.caller,h,u))}}return n}uploadCustomUniforms(e,t,r,a){e.bind();var i=0,s=t[r];return s&&null!=a&&(i+=s.fun.call(s.caller,s,a)),i}createRenderStateComand(){return new RenderStateCommand}unbindVertexState(){this.isWebGL2?this._context.bindVertexArray(null):this._supportCapatable.getExtension(e.WebGLExtension.OES_vertex_array_object).bindVertexArrayOES(null),this._GLBindVertexArray=null}}class ArabicReshaper{characterMapContains(e){for(var t=0;t<ArabicReshaper.charsMap.length;++t)if(ArabicReshaper.charsMap[t][0]===e)return!0;return!1}getCharRep(e){for(var t=0;t<ArabicReshaper.charsMap.length;++t)if(ArabicReshaper.charsMap[t][0]===e)return ArabicReshaper.charsMap[t];return!1}getCombCharRep(e,t){for(var r=0;r<ArabicReshaper.combCharsMap.length;++r)if(ArabicReshaper.combCharsMap[r][0][0]===e&&ArabicReshaper.combCharsMap[r][0][1]===t)return ArabicReshaper.combCharsMap[r];return!1}isTransparent(e){for(var t=0;t<ArabicReshaper.transChars.length;++t)if(ArabicReshaper.transChars[t]===e)return!0;return!1}getOriginalCharsFromCode(e){var t;for(t=0;t<ArabicReshaper.charsMap.length;++t)if(ArabicReshaper.charsMap[t].indexOf(e)>-1)return String.fromCharCode(ArabicReshaper.charsMap[t][0]);for(t=0;t<ArabicReshaper.combCharsMap.length;++t)if(ArabicReshaper.combCharsMap[t].indexOf(e)>-1)return String.fromCharCode(ArabicReshaper.combCharsMap[t][0][0])+String.fromCharCode(ArabicReshaper.combCharsMap[t][0][1]);return String.fromCharCode(e)}convertArabic(e){for(var t,r,a="",i=0;i<e.length;++i){var s=e.charCodeAt(i);if(this.characterMapContains(s)){for(var n=null,o=null,l=i-1,h=i+1;l>=0&&this.isTransparent(e.charCodeAt(l));--l);for((!(t=!!(n=l>=0?e.charCodeAt(l):null)&&this.getCharRep(n))||null==t[2]&&null==t[3])&&(n=null);h<e.length&&this.isTransparent(e.charCodeAt(h));++h);if((!(t=!!(o=h<e.length?e.charCodeAt(h):null)&&this.getCharRep(o))||null==t[3]&&null==t[4])&&(o=null),1604===s&&null!=o&&(1570===o||1571===o||1573===o||1575===o)){r=this.getCombCharRep(s,o),a+=null!=n?String.fromCharCode(r[4]):String.fromCharCode(r[1]),++i;continue}if(t=this.getCharRep(s),null!=n&&null!=o&&null!=t[3]){a+=String.fromCharCode(t[3]);continue}if(null!=n&&null!=t[4]){a+=String.fromCharCode(t[4]);continue}if(null!=o&&null!=t[2]){a+=String.fromCharCode(t[2]);continue}a+=String.fromCharCode(t[1])}else a+=String.fromCharCode(s)}return a}convertArabicBack(e){var t,r,a="";for(r=0;r<e.length;++r)t=e.charCodeAt(r),a+=this.getOriginalCharsFromCode(t);return a}}ArabicReshaper.charsMap=[[1569,65152,null,null,null],[1570,65153,null,null,65154],[1571,65155,null,null,65156],[1572,65157,null,null,65158],[1573,65159,null,null,65160],[1574,65161,65163,65164,65162],[1575,65165,null,null,65166],[1576,65167,65169,65170,65168],[1577,65171,null,null,65172],[1578,65173,65175,65176,65174],[1579,65177,65179,65180,65178],[1580,65181,65183,65184,65182],[1581,65185,65187,65188,65186],[1582,65189,65191,65192,65190],[1583,65193,null,null,65194],[1584,65195,null,null,65196],[1585,65197,null,null,65198],[1586,65199,null,null,65200],[1587,65201,65203,65204,65202],[1588,65205,65207,65208,65206],[1589,65209,65211,65212,65210],[1590,65213,65215,65216,65214],[1591,65217,65219,65220,65218],[1592,65221,65223,65224,65222],[1593,65225,65227,65228,65226],[1594,65229,65231,65232,65230],[1600,1600,1600,1600,1600],[1601,65233,65235,65236,65234],[1602,65237,65239,65240,65238],[1603,65241,65243,65244,65242],[1604,65245,65247,65248,65246],[1605,65249,65251,65252,65250],[1606,65253,65255,65256,65254],[1607,65257,65259,65260,65258],[1608,65261,null,null,65262],[1609,65263,null,null,65264],[1610,65265,65267,65268,65266],[1662,64342,64344,64345,64343],[1740,64508,64510,64511,64509],[1670,64378,64380,64381,64379],[1705,64398,64400,64401,64399],[1711,64402,64404,64405,64403],[1688,64394,null,null,64395]],ArabicReshaper.combCharsMap=[[[1604,1570],65269,null,null,65270],[[1604,1571],65271,null,null,65272],[[1604,1573],65273,null,null,65274],[[1604,1575],65275,null,null,65276]],ArabicReshaper.transChars=[1552,1554,1555,1556,1557,1611,1612,1613,1614,1615,1616,1617,1618,1619,1620,1621,1622,1623,1624,1648,1750,1751,1752,1753,1754,1755,1756,1759,1760,1761,1762,1763,1764,1767,1768,1770,1771,1772,1773];class MatirxArray{static ArrayMul(e,t,r){if(e)if(t)for(var a,i,s,n,o=0;o<4;o++)a=e[o],i=e[o+4],s=e[o+8],n=e[o+12],r[o]=a*t[0]+i*t[1]+s*t[2]+n*t[3],r[o+4]=a*t[4]+i*t[5]+s*t[6]+n*t[7],r[o+8]=a*t[8]+i*t[9]+s*t[10]+n*t[11],r[o+12]=a*t[12]+i*t[13]+s*t[14]+n*t[15];else MatirxArray.copyArray(e,r);else MatirxArray.copyArray(t,r)}static copyArray(e,t){if(e&&t)for(var r=0;r<e.length;r++)t[r]=e[r]}}return e.AlphaCmd=AlphaCmd,e.Animation=Animation,e.Animation2DCondition=Animation2DCondition,e.Animation2DEvent=Animation2DEvent,e.Animation2DParm=Animation2DParm,e.AnimationBase=AnimationBase,e.AnimationClip2D=AnimationClip2D,e.AnimationClip2DParse01=AnimationClip2DParse01,e.Animator2D=Animator2D,e.AnimatorController2D=AnimatorController2D,e.AnimatorControllerLayer2D=AnimatorControllerLayer2D,e.AnimatorControllerParse=AnimatorControllerParse,e.AnimatorPlayState2D=AnimatorPlayState2D,e.AnimatorState2D=AnimatorState2D,e.AnimatorState2DScript=class{setPlayScriptInfo(e,t,r){this.playStateInfo.animator=e,this.playStateInfo.layerindex=t,this.playStateInfo.playState=r}constructor(){this.playStateInfo={animator:null,layerindex:-1,playState:null}}onStateEnter(){}onStateUpdate(e){}onStateExit(){}onStateLoop(){}},e.AnimatorStateBoolCondition=AnimatorStateBoolCondition,e.AnimatorStateCondition=AnimatorStateCondition,e.AnimatorStateNumberCondition=AnimatorStateNumberCondition,e.AnimatorStateTriggerCondition=AnimatorStateTriggerCondition,e.AnimatorTransition2D=AnimatorTransition2D,e.ArabicReshaper=ArabicReshaper,e.AssetDb=AssetDb,e.AtlasGrid=AtlasGrid,e.AtlasInfoManager=AtlasInfoManager,e.AtlasResource=AtlasResource,e.AudioSound=AudioSound,e.AudioSoundChannel=AudioSoundChannel,e.Base64Tool=Base64Tool,e.BasePoly=BasePoly,e.BaseShader=BaseShader,e.BaseTexture=BaseTexture,e.BatchProgress=BatchProgress,e.Bezier=Bezier,e.BitmapFont=BitmapFont,e.BlendComponent=BlendComponent,e.BlendMode=BlendMode,e.BlendState=BlendState,e.BlurFilter=BlurFilter,e.BlurFilterGLRender=BlurFilterGLRender,e.BoundsStyle=BoundsStyle,e.Browser=Browser,e.Buffer=Buffer,e.Buffer2D=Buffer2D,e.BufferState=BufferState,e.ButtonEffect=class{constructor(){this._curState=0,this.effectScale=1.5,this.tweenTime=300}set target(e){this._tar=e,e.on(Event.MOUSE_DOWN,this,this.toChangedState),e.on(Event.MOUSE_UP,this,this.toInitState),e.on(Event.MOUSE_OUT,this,this.toInitState)}toChangedState(){this._curState=1,this._curTween&&Tween.clear(this._curTween),this._curTween=Tween.to(this._tar,{scaleX:this.effectScale,scaleY:this.effectScale},this.tweenTime,Ease[this.effectEase],Handler.create(this,this.tweenComplete))}toInitState(){2!=this._curState&&(this._curTween&&Tween.clear(this._curTween),this._curState=2,this._curTween=Tween.to(this._tar,{scaleX:1,scaleY:1},this.tweenTime,Ease[this.backEase],Handler.create(this,this.tweenComplete)))}tweenComplete(){this._curState=0,this._curTween=null}},e.Byte=Byte,e.CacheManger=CacheManger,e.CacheStyle=CacheStyle,e.CallLater=CallLater,e.CharRenderInfo=CharRenderInfo,e.CharRender_Canvas=CharRender_Canvas,e.CharSubmitCache=CharSubmitCache,e.ClassUtils=ClassUtils,e.ClipRectCmd=ClipRectCmd,e.Color=Color,e.ColorFilter=ColorFilter,e.ColorUtils=ColorUtils,e.CommandEncoder=CommandEncoder,e.CommandUniformMap=CommandUniformMap,e.CommonMemoryAllocater=CommonMemoryAllocater,e.Component=Component,e.ComponentDriver=ComponentDriver,e.Config=Config,e.Config3D=Config3D,e.Const=Const,e.Context=Context,e.DDSTextureInfo=DDSTextureInfo,e.DefineDatas=DefineDatas,e.Delegate=Delegate,e.DepthState=class{},e.Downloader=Downloader,e.Dragging=Dragging,e.Draw9GridTextureCmd=Draw9GridTextureCmd,e.DrawCircleCmd=DrawCircleCmd,e.DrawCurvesCmd=DrawCurvesCmd,e.DrawEllipseCmd=DrawEllipseCmd,e.DrawImageCmd=DrawImageCmd,e.DrawLineCmd=DrawLineCmd,e.DrawLinesCmd=DrawLinesCmd,e.DrawParticleCmd=DrawParticleCmd,e.DrawPathCmd=DrawPathCmd,e.DrawPieCmd=DrawPieCmd,e.DrawPolyCmd=DrawPolyCmd,e.DrawRectCmd=DrawRectCmd,e.DrawRoundRectCmd=DrawRoundRectCmd,e.DrawStyle=DrawStyle,e.DrawTextureCmd=DrawTextureCmd,e.DrawTexturesCmd=DrawTexturesCmd,e.DrawTrianglesCmd=DrawTrianglesCmd,e.Earcut=Earcut,e.EarcutNode=EarcutNode,e.Ease=Ease,e.EffectAnimation=EffectAnimation,e.EffectBase=EffectBase,e.Event=Event,e.EventDispatcher=EventDispatcher,e.FadeIn=class extends EffectBase{_doTween(){return this.target.alpha=0,Tween.to(this.target,{alpha:1},this.duration,Ease[this.ease],this._comlete,this.delay)}},e.FadeOut=class extends EffectBase{_doTween(){return this.target.alpha=1,Tween.to(this.target,{alpha:0},this.duration,Ease[this.ease],this._comlete,this.delay)}},e.FillTextCmd=FillTextCmd,e.FillTextureCmd=FillTextureCmd,e.Filter=Filter,e.FontInfo=FontInfo,e.FrameAnimation=FrameAnimation,e.GL2TextureContext=GL2TextureContext,e.GLBuffer=GLBuffer,e.GLObject=GLObject,e.GLParams=GLParams,e.GLRender2DContext=GLRender2DContext,e.GLRenderDrawContext=GLRenderDrawContext,e.GLRenderState=GLRenderState,e.GLSLCodeGenerator=GLSLCodeGenerator,e.GLShaderInstance=GLShaderInstance,e.GLTextureContext=GLTextureContext,e.GLVertexState=GLVertexState,e.GlCapable=GlCapable,e.GlowFilter=GlowFilter,e.GlowFilterGLRender=GlowFilterGLRender,e.GrahamScan=GrahamScan,e.GraphicAnimation=GraphicAnimation,e.Graphics=Graphics,e.GraphicsBounds=GraphicsBounds,e.HDRTextureInfo=HDRTextureInfo,e.HTMLCanvas=HTMLCanvas,e.HalfFloatUtils=HalfFloatUtils,e.Handler=Handler,e.HideFlags=HideFlags,e.HierarchyLoader=HierarchyLoader,e.HierarchyParser=HierarchyParser,e.HierarchyResource=lt,e.HitArea=HitArea,e.HtmlElement=HtmlElement,e.HtmlImage=HtmlImage,e.HtmlLink=HtmlLink,e.HtmlParseOptions=HtmlParseOptions,e.HtmlParser=HtmlParser,e.HttpRequest=HttpRequest,e.ICharRender=ICharRender,e.ILaya=ILaya,e.ImgUtils=ImgUtils,e.IncludeFile=IncludeFile,e.IndexBuffer=IndexBuffer,e.IndexBuffer2D=IndexBuffer2D,e.Input=Input,e.InputManager=InputManager,e.KTXTextureInfo=KTXTextureInfo,e.KeyLocation=KeyLocation,e.Keyboard=Keyboard,e.Keyframe2D=Keyframe2D,e.KeyframeNode2D=KeyframeNode2D,e.KeyframeNodeList2D=KeyframeNodeList2D,e.Laya=Laya,e.LayaEnv=LayaEnv,e.LayaGL=LayaGL,e.LayaGLQuickRunner=LayaGLQuickRunner,e.LegacyUIParser=LegacyUIParser,e.Loader=Loader,e.LocalStorage=LocalStorage,e.Log=Log,e.Material=Material,e.MaterialParser=MaterialParser,e.MathUtil=MathUtil,e.MathUtils3D=MathUtils3D,e.MatirxArray=MatirxArray,e.Matrix=Matrix,e.Matrix3x3=Matrix3x3,e.Matrix4x4=Matrix4x4,e.Mesh2D=Mesh2D,e.MeshParticle2D=MeshParticle2D,e.MeshQuadTexture=MeshQuadTexture,e.MeshTexture=MeshTexture,e.MeshVG=MeshVG,e.Mouse=Mouse,e.NativeCommandUniformMap=NativeCommandUniformMap,e.NativeContext=NativeContext,e.NativeFilter=NativeFilter,e.NativeGL2TextureContext=NativeGL2TextureContext,e.NativeGLObject=NativeGLObject,e.NativeGLRender2DContext=class extends NativeGLObject{constructor(e){super(e)}activeTexture(e){}bindTexture(e,t){}bindUseProgram(e){return!0}},e.NativeGLRenderDrawContext=NativeGLRenderDrawContext,e.NativeGLRenderEngineFactory=class{createShaderData(){return new NativeShaderData}createShaderInstance(e,t){return null}createRenderStateComand(){return new NativeRenderStateCommand}createRenderState(){return new NativeRenderState}createUniformBufferObject(e,t,r,a,i){return new NativeUniformBufferObject(e,t,r,a,i)}createGlobalUniformMap(e){return new NativeCommandUniformMap(window.conchCommandUniformMap.createGlobalUniformMap(e),e)}createEngine(e,t){return Promise.resolve()}},e.NativeGLTextureContext=NativeGLTextureContext,e.NativeGLVertexState=NativeGLVertexState,e.NativeMemory=NativeMemory,e.NativeRenderState=NativeRenderState,e.NativeRenderStateCommand=NativeRenderStateCommand,e.NativeRenderTexture2D=NativeRenderTexture2D,e.NativeShaderData=NativeShaderData,e.NativeUniformBufferObject=NativeUniformBufferObject,e.NativeWebGLCacheAsNormalCanvas=NativeWebGLCacheAsNormalCanvas,e.NativeWebGLEngine=class{constructor(t,r=e.WebGLMode.Auto){this._isShaderDebugMode=!0,this._nativeObj=new window.conchWebGLEngine(r)}createRenderStateComand(){return new NativeRenderStateCommand}getUBOPointer(e){return this._nativeObj.getUBOPointer(e)}_addStatisticsInfo(e,t){this._nativeObj.addStatisticsInfo(e,t)}clearStatisticsInfo(e){this._nativeObj.clearStatisticsInfo(e)}getStatisticsInfo(e){return this._nativeObj.getStatisticsInfo(e)}get gl(){return this._context}get isWebGL2(){return this._nativeObj.isWebGL2}get webglConfig(){return this._config}initRenderEngine(e){this._nativeObj.initRenderEngine(),this._GLRenderDrawContext=new NativeGLRenderDrawContext(this),this.isWebGL2?this._GLTextureContext=new NativeGL2TextureContext(this,new window.conchGL2TextureContext(this._nativeObj)):this._GLTextureContext=new NativeGLTextureContext(this,new window.conchGLTextureContext(this._nativeObj))}bindTexture(e){throw new Error("Method not implemented.")}applyRenderStateCMD(e){this._nativeObj.applyRenderStateCommand(e._nativeObj)}getCapable(e){return this._nativeObj.getCapable(e)}viewport(e,t,r,a){this._nativeObj.viewport(e,t,r,a)}scissor(e,t,r,a){this._nativeObj.scissor(e,t,r,a)}scissorTest(e){this._nativeObj.scissorTest(e)}clearRenderTexture(e,t=null,r=1){t?this._nativeObj.clearRenderTexture(e,!0,t.r,t.g,t.b,t.a,r):this._nativeObj.clearRenderTexture(e,!1,Color.BLACK.r,Color.BLACK.g,Color.BLACK.b,Color.BLACK.a,r)}copySubFrameBuffertoTex(e,t,r,a,i,s,n,o){this._nativeObj.copySubFrameBuffertoTex(e._texture,t,r,a,i,s,n,o)}colorMask(e,t,r,a){this._nativeObj.colorMask(e,t,r,a)}getParams(e){return this._nativeObj.getParams(e)}createBuffer(e,t){return new window.conchGLBuffer(this._nativeObj,e,t)}createShaderInstance(e,t,r){throw new Error("Method not implemented.")}createVertexState(){return new NativeGLVertexState(this)}getTextureContext(){return this._GLTextureContext}getDrawContext(){return this._GLRenderDrawContext}get2DRenderContext(){return this._GL2DRenderContext}getCreateRenderOBJContext(){return this._renderOBJCreateContext}propertyNameToID(e){return this._nativeObj.propertyNameToID(e)}propertyIDToName(e){throw new Error("Method not implemented.")}uploadUniforms(e,t,r,a){throw new Error("Method not implemented.")}uploadCustomUniforms(e,t,r,a){throw new Error("Method not implemented.")}unbindVertexState(){this._nativeObj.unbindVertexState&&this._nativeObj.unbindVertexState()}},e.Node=Node,e.NodeFlags=NodeFlags,e.NullLoader=NullLoader,e.ParseJSON=ParseJSON,e.Path=Path,e.PerfData=PerfData,e.PerfHUD=PerfHUD,e.Point=Point,e.Pool=Pool,e.PoolCache=PoolCache,e.Prefab=Prefab,e.PrefabImpl=PrefabImpl,e.PrimitiveSV=PrimitiveSV,e.Quaternion=Quaternion,e.QuickTestTool=QuickTestTool,e.Rectangle=Rectangle,e.Render=Render,e.RenderInfo=RenderInfo,e.RenderSprite=RenderSprite,e.RenderState=RenderState,e.RenderState2D=RenderState2D,e.RenderStateCommand=RenderStateCommand,e.RenderStateContext=RenderStateContext,e.RenderTexture=RenderTexture,e.RenderTexture2D=RenderTexture2D,e.RenderTextureCube=class extends RenderTexture{constructor(e,t,r,a,i){super(e,e,t,r,a,i),this.faceIndex=0}_createRenderTarget(){this._dimension=e.TextureDimension.Cube,this._renderTarget=LayaGL.textureContext.createRenderTargetCubeInternal(this.width,this._format,this._depthStencilFormat,this._generateMipmap,this._gammaSpace,this._multiSamples),this._texture=this._renderTarget._textures[0]}_start(){RenderTexture._configInstance.invertY=this._isCameraTarget,RenderTexture._currentActive!=this&&(RenderTexture._currentActive&&RenderTexture._currentActive._end(),RenderTexture._currentActive=this,LayaGL.textureContext.bindRenderTarget(this._renderTarget,this.faceIndex))}},e.Resource=Resource,e.RestoreCmd=RestoreCmd,e.RotateCmd=RotateCmd,e.RunDriver=RunDriver,e.SaveBase=SaveBase,e.SaveClipRect=SaveClipRect,e.SaveCmd=SaveCmd,e.SaveMark=SaveMark,e.SaveTransform=SaveTransform,e.SaveTranslate=SaveTranslate,e.ScaleCmd=ScaleCmd,e.Scene=Scene,e.Script=Script,e.SerializeUtil=SerializeUtil,e.Shader2D=Shader2D,e.Shader3D=Shader3D,e.ShaderCompile=ShaderCompile,e.ShaderCompileDefineBase=ShaderCompileDefineBase,e.ShaderData=ShaderData,e.ShaderDataDefaultValue=ShaderDataDefaultValue,e.ShaderDefine=ShaderDefine,e.ShaderDefines2D=ShaderDefines2D,e.ShaderInstance=ShaderInstance,e.ShaderNode=ShaderNode,e.ShaderParser=ShaderParser,e.ShaderPass=ShaderPass,e.ShaderProcessInfo=ShaderProcessInfo,e.ShaderVariable=ShaderVariable,e.ShaderVariant=ShaderVariant,e.ShaderVariantCollection=ShaderVariantCollection,e.SingletonList=SingletonList,e.SkinMeshBuffer=SkinMeshBuffer,e.Socket=Socket,e.Sound=class extends EventDispatcher{load(e){}play(e=0,t=0){return null}get duration(){return 0}dispose(){}},e.SoundChannel=SoundChannel,e.SoundManager=SoundManager,e.SoundNode=SoundNode,e.Sprite=Sprite,e.SpriteConst=SpriteConst,e.SpriteStyle=SpriteStyle,e.SpriteUtils=SpriteUtils,e.Stage=Stage,e.Stat=Stat,e.StencilState=class{},e.StringKey=class{constructor(){this._strsToID={},this._idToStrs=[],this._length=0}add(e){var t=this._strsToID[e];return null!=t?t:(this._idToStrs[this._length]=e,this._strsToID[e]=this._length++)}getID(e){var t=this._strsToID[e];return null==t?-1:t}getName(e){var t=this._idToStrs[e];return null==t?void 0:t}},e.SubShader=SubShader,e.SubUniformBufferData=class extends UnifromBufferData{constructor(e,t){super(e),this._isInPool=!1,this._needUpdate=!1,this._realByte=0,this._offset=t,this._realByte=this._bytelength,this._bytelength=256*Math.ceil(this._bytelength/256)}},e.Submit=Submit,e.SubmitBase=SubmitBase,e.SubmitCMD=SubmitCMD,e.SubmitCanvas=SubmitCanvas,e.SubmitKey=SubmitKey,e.SubmitTarget=SubmitTarget,e.SubmitTexture=SubmitTexture,e.System=class{static changeDefinition(e,t){window.Laya[e]=t;var r=e+"=classObj";window.eval(r)}},e.Text=Text,e.TextAtlas=TextAtlas,e.TextRender=TextRender,e.TextResource=TextResource,e.TextStyle=TextStyle,e.TextTexture=TextTexture,e.Texture=Texture,e.Texture2D=Texture2D,e.Texture2DArray=Texture2DArray,e.Texture3D=Texture3D,e.TextureCube=TextureCube,e.TextureSV=TextureSV,e.TimeLine=TimeLine,e.Timer=Timer,e.TransformCmd=TransformCmd,e.TranslateCmd=TranslateCmd,e.Tween=Tween,e.TypedArrayClasses=et,e.UBBParser=UBBParser,e.URL=URL,e.UniformBufferBase=UniformBufferBase,e.UniformBufferObject=UniformBufferObject,e.UnifromBufferData=UnifromBufferData,e.UploadMemory=UploadMemory,e.UploadMemoryManager=UploadMemoryManager,e.Utils=Utils,e.Value2D=Value2D,e.Vector2=Vector2,e.Vector3=Vector3,e.Vector4=Vector4,e.VectorGraphManager=VectorGraphManager,e.VertexArrayObject=class{constructor(){}},e.VertexAttributeLayout=VertexAttributeLayout,e.VertexBuffer=VertexBuffer,e.VertexBuffer2D=VertexBuffer2D,e.VertexDeclaration=VertexDeclaration,e.VertexElement=VertexElement,e.VertexElementFormat=VertexElementFormat,e.VertexMesh=VertexMesh,e.VideoNode=VideoNode,e.VideoTexture=VideoTexture,e.WeakObject=WeakObject,e.WebAudioSound=WebAudioSound,e.WebAudioSoundChannel=WebAudioSoundChannel,e.WebGL=WebGL,e.WebGLCacheAsNormalCanvas=WebGLCacheAsNormalCanvas,e.WebGLEngine=WebGLEngine,e.WebGLInternalRT=WebGLInternalRT,e.WebGLInternalTex=WebGLInternalTex,e.WebGLRTMgr=WebGLRTMgr,e.WebGLRenderEngineFactory=class{constructor(){this.globalBlockMap={}}createShaderData(){return new ShaderData}createShaderInstance(e,t){return new ShaderInstance(e,t)}createRenderStateComand(){return new RenderStateCommand}createRenderState(){return new RenderState}createUniformBufferObject(e,t,r,a,i){return new UniformBufferObject(e,t,r,a,i)}createGlobalUniformMap(e){let t=this.globalBlockMap[e];return t||(t=this.globalBlockMap[e]=new CommandUniformMap(e)),t}createEngine(t,r){let a,i={stencil:Config.isStencil,alpha:Config.isAlpha,antialias:Config.isAntialias,premultipliedAlpha:Config.premultipliedAlpha,preserveDrawingBuffer:Config.preserveDrawingBuffer,depth:Config.isDepth,failIfMajorPerformanceCaveat:Config.isfailIfMajorPerformanceCaveat,powerPreference:Config.powerPreference};const s=Config.useWebGL2?e.WebGLMode.Auto:e.WebGLMode.WebGL1;a=new WebGLEngine(i,s),a.initRenderEngine(r._source);var n=a._context;return Config.printWebglOrder&&this._replaceWebglcall(n),LayaGL.renderEngine=a,LayaGL.textureContext=a.getTextureContext(),LayaGL.renderDrawContext=a.getDrawContext(),LayaGL.render2DContext=a.get2DRenderContext(),Promise.resolve()}_replaceWebglcall(e){var t={};for(const r in e)"function"==typeof e[r]&&"getError"!=r&&"__SPECTOR_Origin_getError"!=r&&"__proto__"!=r&&(t[r]=e[r],e[r]=function(){let a=[];for(let e=0;e<arguments.length;e++)a.push(arguments[e]);let i=t[r].apply(e,a);e.getError();return i})}},e.WebGlConfig=class{},e.Widget=Widget,e.WordText=WordText,e.WorkerLoader=WorkerLoader,e.XML=XML,e.XMLIterator=XMLIterator,e.XMLUtils=XMLUtils,e.addAfterInitCallback=kt,e.addBeforeInitCallback=Vt,e.addInitCallback=Gt,e.alertGlobalError=Ot,e.classInfo=function(e){return dummy},e.enableDebugPanel=Ut,e.init=It,e.property=function(e){return dummy},e.regClass=function(e){return function(t){ClassUtils.regClass(e,t)}},e.runInEditor=function(e){},e}({});
//# sourceMappingURL=laya.core.js.map