!function(t,e){"use strict";class IAniLib{}IAniLib.Skeleton=null,IAniLib.AnimationTemplet=null,IAniLib.Templet=null;class AnimationContent{}class AnimationNodeContent{}class KeyFramesContent{}class AnimationParser01{static parse(t,i){var a,r,s,n,h,l,o,u=i.__getBuffer(),p=i.readUTFString();t._aniClassName=p;var _,d=i.readUTFString().split("\n"),c=i.getUint8(),m=i.getUint32(),x=i.getUint32();m>0&&(_=u.slice(m,x));var y=new e.Byte(_);for(x>0&&(t._publicExtData=u.slice(x,u.byteLength)),t._useParent=!!i.getUint8(),t._anis.length=c,a=0;a<c;a++){var g=t._anis[a]=new AnimationContent;g.nodes=[];var f=g.name=d[i.getUint16()];t._aniMap[f]=a,g.bone3DMap={},g.playTime=i.getFloat32();var D=g.nodes.length=i.getUint8();for(g.totalKeyframeDatasLength=0,r=0;r<D;r++){var M=g.nodes[r]=new AnimationNodeContent;M.childs=[];var A=i.getInt16();A>=0&&(M.name=d[A],g.bone3DMap[M.name]=r),M.keyFrame=[],M.parentIndex=i.getInt16(),-1==M.parentIndex?M.parent=null:M.parent=g.nodes[M.parentIndex],M.lerpType=i.getUint8();var v=i.getUint32();y.pos=v;var I=M.keyframeWidth=y.getUint16();if(g.totalKeyframeDatasLength+=I,0===M.lerpType||1===M.lerpType)for(M.interpolationMethod=[],M.interpolationMethod.length=I,s=0;s<I;s++)M.interpolationMethod[s]=IAniLib.AnimationTemplet.interpolation[y.getUint8()];null!=M.parent&&M.parent.childs.push(M);var S=i.getUint16();S>0&&(M.extenData=u.slice(i.pos,i.pos+S),i.pos+=S);var T=i.getUint16();M.keyFrame.length=T;var C,b=0;for(s=0,n=T;s<n;s++){if((C=M.keyFrame[s]=new KeyFramesContent).duration=i.getFloat32(),C.startTime=b,2===M.lerpType){C.interpolationData=[];var k,F=i.getUint8();switch(k=i.getFloat32()){case 254:for(C.interpolationData.length=I,o=0;o<I;o++)C.interpolationData[o]=0;break;case 255:for(C.interpolationData.length=I,o=0;o<I;o++)C.interpolationData[o]=5;break;default:for(C.interpolationData.push(k),l=1;l<F;l++)C.interpolationData.push(i.getFloat32())}}for(C.data=new Float32Array(I),C.dData=new Float32Array(I),C.nextData=new Float32Array(I),h=0;h<I;h++)C.data[h]=i.getFloat32(),C.data[h]>-1e-8&&C.data[h]<1e-8&&(C.data[h]=0);b+=C.duration}C.startTime=g.playTime,M.playTime=g.playTime,t._calculateKeyFrame(M,T,I)}}}}class AnimationParser02{static READ_DATA(){AnimationParser02._DATA.offset=AnimationParser02._reader.getUint32(),AnimationParser02._DATA.size=AnimationParser02._reader.getUint32()}static READ_BLOCK(){for(var t=AnimationParser02._BLOCK.count=AnimationParser02._reader.getUint16(),e=AnimationParser02._BLOCK.blockStarts=[],i=AnimationParser02._BLOCK.blockLengths=[],a=0;a<t;a++)e.push(AnimationParser02._reader.getUint32()),i.push(AnimationParser02._reader.getUint32())}static READ_STRINGS(){var t=AnimationParser02._reader.getUint32(),e=AnimationParser02._reader.getUint16(),i=AnimationParser02._reader.pos;AnimationParser02._reader.pos=t+AnimationParser02._DATA.offset;for(var a=0;a<e;a++)AnimationParser02._strings[a]=AnimationParser02._reader.readUTFString();AnimationParser02._reader.pos=i}static parse(t,e){AnimationParser02._templet=t,AnimationParser02._reader=e,e.__getBuffer(),AnimationParser02.READ_DATA(),AnimationParser02.READ_BLOCK(),AnimationParser02.READ_STRINGS();for(var i=0,a=AnimationParser02._BLOCK.count;i<a;i++){var r=e.getUint16(),s=AnimationParser02._strings[r],n=AnimationParser02["READ_"+s];if(null==n)throw new Error("model file err,no this function:"+r+" "+s);n.call(null)}}static READ_ANIMATIONS(){var t,e,i,a,r=AnimationParser02._reader,s=r.__getBuffer(),n=r.getUint16(),h=[];for(h.length=n,t=0;t<n;t++)h[t]=IAniLib.AnimationTemplet.interpolation[r.getByte()];var l=r.getUint8();for(AnimationParser02._templet._anis.length=l,t=0;t<l;t++){var o=AnimationParser02._templet._anis[t]=new AnimationContent;o.nodes=[];var u=o.name=AnimationParser02._strings[r.getUint16()];AnimationParser02._templet._aniMap[u]=t,o.bone3DMap={},o.playTime=r.getFloat32();var p=o.nodes.length=r.getInt16();for(o.totalKeyframeDatasLength=0,e=0;e<p;e++){var _=o.nodes[e]=new AnimationNodeContent;_.keyframeWidth=n,_.childs=[];var d=r.getUint16();d>=0&&(_.name=AnimationParser02._strings[d],o.bone3DMap[_.name]=e),_.keyFrame=[],_.parentIndex=r.getInt16(),-1==_.parentIndex?_.parent=null:_.parent=o.nodes[_.parentIndex],o.totalKeyframeDatasLength+=n,_.interpolationMethod=h,null!=_.parent&&_.parent.childs.push(_);var c=r.getUint16();_.keyFrame.length=c;var m=null,x=null;for(i=0,a=c;i<a;i++){(m=_.keyFrame[i]=new KeyFramesContent).startTime=r.getFloat32(),x&&(x.duration=m.startTime-x.startTime),m.dData=new Float32Array(n),m.nextData=new Float32Array(n);var y=AnimationParser02._DATA.offset,g=r.getUint32(),f=4*n,D=s.slice(y+g,y+g+f);m.data=new Float32Array(D),x=m}m.duration=0,_.playTime=o.playTime,AnimationParser02._templet._calculateKeyFrame(_,c,n)}}}}AnimationParser02._strings=[],AnimationParser02._BLOCK={count:0},AnimationParser02._DATA={offset:0,size:0};class AnimationState{constructor(){}}AnimationState.stopped=0,AnimationState.paused=1,AnimationState.playing=2;class AnimationPlayer extends e.EventDispatcher{get templet(){return this._templet}set templet(t){this.state!==AnimationState.stopped&&this.stop(!0),this._templet!==t&&(this._templet=t,this._computeFullKeyframeIndices())}get playStart(){return this._playStart}get playEnd(){return this._playEnd}get playDuration(){return this._playDuration}get overallDuration(){return this._overallDuration}get currentAnimationClipIndex(){return this._currentAnimationClipIndex}get currentKeyframeIndex(){return this._currentKeyframeIndex}get currentPlayTime(){return this._currentTime+this._playStart}get currentFrameTime(){return this._currentFrameTime}get cachePlayRate(){return this._cachePlayRate}set cachePlayRate(t){this._cachePlayRate!==t&&(this._cachePlayRate=t,this._templet&&this._computeFullKeyframeIndices())}get cacheFrameRate(){return this._cacheFrameRate}set cacheFrameRate(t){this._cacheFrameRate!==t&&(this._cacheFrameRate=t,this._cacheFrameRateInterval=1e3/this._cacheFrameRate,this._templet&&this._computeFullKeyframeIndices())}set currentTime(t){if(-1!==this._currentAnimationClipIndex&&this._templet){if(t<this._playStart||t>this._playEnd)throw new Error("AnimationPlayer:value must large than playStartTime,small than playEndTime.");this._startUpdateLoopCount=e.Stat.loopCount;var i=this._cacheFrameRateInterval*this._cachePlayRate;this._currentTime=t,this._currentKeyframeIndex=Math.floor(this.currentPlayTime/i),this._currentFrameTime=this._currentKeyframeIndex*i}}get paused(){return this._paused}set paused(t){this._paused=t,t&&this.event(e.Event.PAUSED)}get cacheFrameRateInterval(){return this._cacheFrameRateInterval}get state(){return-1===this._currentAnimationClipIndex?AnimationState.stopped:this._paused?AnimationState.paused:AnimationState.playing}get destroyed(){return this._destroyed}constructor(){super(),this.isCache=!0,this.playbackRate=1,this._destroyed=!1,this._currentAnimationClipIndex=-1,this._currentKeyframeIndex=-1,this._currentTime=0,this._overallDuration=Number.MAX_VALUE,this._stopWhenCircleFinish=!1,this._elapsedPlaybackTime=0,this._startUpdateLoopCount=-1,this._cachePlayRate=1,this.cacheFrameRate=60,this.returnToZeroStopped=!1}_onTempletLoadedComputeFullKeyframeIndices(t,e,i){this._templet===i&&this._cachePlayRate===t&&this._cacheFrameRate===e&&this._computeFullKeyframeIndices()}_computeFullKeyframeIndices(){}_onAnimationTempletLoaded(){this.destroyed||this._calculatePlayDuration()}_calculatePlayDuration(){if(this.state!==AnimationState.stopped){var t=this._templet.getAniDuration(this._currentAnimationClipIndex);0===this._playEnd&&(this._playEnd=t),this._playEnd>t&&(this._playEnd=t),this._playDuration=this._playEnd-this._playStart}}_setPlayParams(t,e){this._currentTime=t,this._currentKeyframeIndex=Math.floor(this.currentPlayTime/e+.01),this._currentFrameTime=this._currentKeyframeIndex*e}_setPlayParamsWhenStop(t,e,i=-1){this._currentTime=t;var a=i>0?i:t;this._currentKeyframeIndex=Math.floor(a/e+.01),this._currentKeyframeIndex=Math.floor(t/e+.01),this._currentFrameTime=this._currentKeyframeIndex*e,this._currentAnimationClipIndex=-1}_update(t){if(-1!==this._currentAnimationClipIndex&&!this._paused&&this._templet){var i=this._cacheFrameRateInterval*this._cachePlayRate,a=0;this._startUpdateLoopCount!==e.Stat.loopCount&&(a=t*this.playbackRate,this._elapsedPlaybackTime+=a);var r=this.playDuration;if(a+=this._currentTime,0!==this._overallDuration&&this._elapsedPlaybackTime>=this._overallDuration||0===this._overallDuration&&this._elapsedPlaybackTime>=r||0===this._overallDuration&&a>=this.playEnd)return this._setPlayParamsWhenStop(r,i,this.playEnd),void this.event(e.Event.STOPPED);if(r>0){if(a>=r)return this._stopWhenCircleFinish?(this._setPlayParamsWhenStop(r,i),this._stopWhenCircleFinish=!1,void this.event(e.Event.STOPPED)):(a%=r,this._setPlayParams(a,i),void this.event(e.Event.COMPLETE));this._setPlayParams(a,i)}else{if(this._stopWhenCircleFinish)return this._setPlayParamsWhenStop(r,i),this._stopWhenCircleFinish=!1,void this.event(e.Event.STOPPED);this._currentTime=this._currentFrameTime=this._currentKeyframeIndex=0,this.event(e.Event.COMPLETE)}}}_destroy(){this.offAll(),this._templet=null,this._destroyed=!0}play(t=0,i=1,a=2147483647,r=0,s=0){if(!this._templet)throw new Error("AnimationPlayer:templet must not be null,maybe you need to set url.");if(a<0||r<0||s<0)throw new Error("AnimationPlayer:overallDuration,playStart and playEnd must large than zero.");if(0!==s&&r>s)throw new Error("AnimationPlayer:start must less than end.");this._currentTime=0,this._currentFrameTime=0,this._elapsedPlaybackTime=0,this.playbackRate=i,this._overallDuration=a,this._playStart=r,this._playEnd=s,this._paused=!1,this._currentAnimationClipIndex=t,this._currentKeyframeIndex=0,this._startUpdateLoopCount=e.Stat.loopCount,this.event(e.Event.PLAYED),this._calculatePlayDuration(),this._update(0)}playByFrame(t=0,e=1,i=2147483647,a=0,r=0,s=30){var n=1e3/s;this.play(t,e,i,a*n,r*n)}stop(t=!0){t?(this._currentTime=this._currentFrameTime=this._currentKeyframeIndex=0,this._currentAnimationClipIndex=-1,this.event(e.Event.STOPPED)):this._stopWhenCircleFinish=!0}destroy(){}}class BezierLerp{constructor(){}static getBezierRate(t,e,i,a,r){var s=BezierLerp._getBezierParamKey(e,i,a,r),n=100*s+t;if(BezierLerp._bezierResultCache[n])return BezierLerp._bezierResultCache[n];var h,l,o=BezierLerp._getBezierPoints(e,i,a,r,s);for(l=o.length,h=0;h<l;h+=2)if(t<=o[h])return BezierLerp._bezierResultCache[n]=o[h+1],o[h+1];return BezierLerp._bezierResultCache[n]=1,1}static _getBezierParamKey(t,e,i,a){return 100*(100*(100*(100*t+e)+i)+a)}static _getBezierPoints(t,i,a,r,s){return BezierLerp._bezierPointsCache[s]?BezierLerp._bezierPointsCache[s]:(n=[0,0,t,i,a,r,1,1],h=(new e.Bezier).getBezierPoints(n,100,3),BezierLerp._bezierPointsCache[s]=h,h);var n,h}}BezierLerp._bezierResultCache={},BezierLerp._bezierPointsCache={};class AnimationTemplet extends e.Resource{static _LinearInterpolation_0(t,e,i,a,r,s,n,h,l,o=null){return i[a]=r[e]+s*n[e],1}static _QuaternionInterpolation_1(t,i,a,r,s,n,h,l,o,u=null){var p=0===l?0:n/l;return e.MathUtil.slerpQuaternionArray(s,i,o,i,p,a,r),4}static _AngleInterpolation_2(t,e,i,a,r,s,n,h,l,o=null){return 0}static _RadiansInterpolation_3(t,e,i,a,r,s,n,h,l,o=null){return 0}static _Matrix4x4Interpolation_4(t,e,i,a,r,s,n,h,l,o=null){for(let t=0;t<16;t++,e++)i[a+t]=r[e]+s*n[e];return 16}static _NoInterpolation_5(t,e,i,a,r,s,n,h,l,o=null){return i[a]=r[e],1}static _BezierInterpolation_6(t,e,i,a,r,s,n,h,l,o=null,u=0){return i[a]=r[e]+(l[e]-r[e])*BezierLerp.getBezierRate(s/h,o[u],o[u+1],o[u+2],o[u+3]),5}static _BezierInterpolation_7(t,e,i,a,r,s,n,h,l,o=null,u=0){return i[a]=o[u+4]+o[u+5]*BezierLerp.getBezierRate((.001*s+o[u+6])/o[u+7],o[u],o[u+1],o[u+2],o[u+3]),9}constructor(){super(),this._anis=[],this._aniMap={},this.unfixedLastAniIndex=-1,this._fullFrames=null,this._boneCurKeyFrm=[]}_calculateKeyFrame(t,e,i){var a=t.keyFrame;a[e]=a[0];for(var r=0;r<e;r++)for(var s=a[r],n=0;n<i;n++)s.dData[n]=0===s.duration?0:(a[r+1].data[n]-s.data[n])/s.duration,s.nextData[n]=a[r+1].data[n];a.length--}_onAsynLoaded(t,i=null){var a=new e.Byte(t);if(this._aniVersion=a.readUTFString(),"LAYAANIMATION:02"===this._aniVersion)AnimationParser02.parse(this,a);else AnimationParser01.parse(this,a)}getAnimationCount(){return this._anis.length}getAnimation(t){return this._anis[t]}getAniDuration(t){return this._anis[t].playTime}getNodes(t){return this._anis[t].nodes}getNodeIndexWithName(t,e){return this._anis[t].bone3DMap[e]}getNodeCount(t){return this._anis[t].nodes.length}getTotalkeyframesLength(t){return this._anis[t].totalKeyframeDatasLength}getPublicExtData(){return this._publicExtData}getAnimationDataWithCache(t,e,i,a){var r=e[i];if(r){var s=r[t];return s?s[a]:null}return null}setAnimationDataWithCache(t,e,i,a,r){var s=e[i]||(e[i]={});(s[t]||(s[t]=[]))[a]=r}getNodeKeyFrame(t,e,i){var a=this._boneCurKeyFrm[e],r=t.length;(null==a||a>=r)&&(a=this._boneCurKeyFrm[e]=0);var s=t[a],n=i-s.startTime;if(0==n||n>0&&s.duration>n)return a;var h=0;if(n>0){for(i+=.01,h=a+1;h<r;h++)if((s=t[h]).startTime<=i&&s.startTime+s.duration>i)return this._boneCurKeyFrm[e]=h,h;return r-1}for(h=0;h<a;h++)if((s=t[h]).startTime<=i&&s.startTime+s.duration>i)return this._boneCurKeyFrm[e]=h,h;return a}getOriginalData(t,e,i,a,r){var s=this._anis[t].nodes,n=this._boneCurKeyFrm;n.length<s.length&&(n.length=s.length);for(var h=0,l=0,o=s.length,u=0;l<o;l++){var p,_=s[l],d=_.keyFrame;p=d[this.getNodeKeyFrame(d,l,r)],_.dataOffset=u;var c=r-p.startTime,m=_.lerpType;if(m)switch(m){case 0:case 1:for(h=0;h<_.keyframeWidth;)h+=_.interpolationMethod[h](_,h,e,u+h,p.data,c,p.dData,p.duration,p.nextData);break;case 2:var x=p.interpolationData,y=x.length,g=0;for(h=0;h<y;){var f=x[h];switch(f){case 6:case 7:h+=AnimationTemplet.interpolation[f](_,g,e,u+g,p.data,c,p.dData,p.duration,p.nextData,x,h+1);break;default:h+=AnimationTemplet.interpolation[f](_,g,e,u+g,p.data,c,p.dData,p.duration,p.nextData)}g++}}else for(h=0;h<_.keyframeWidth;)h+=_.interpolationMethod[h](_,h,e,u+h,p.data,c,p.dData,p.duration,p.nextData);u+=_.keyframeWidth}}getNodesCurrentFrameIndex(t,e){var i=this._anis[t].nodes;t!==this.unfixedLastAniIndex&&(this.unfixedCurrentFrameIndexes=new Uint32Array(i.length),this.unfixedCurrentTimes=new Float32Array(i.length),this.unfixedLastAniIndex=t);for(var a=0,r=i.length;a<r;a++){var s=i[a];for(e<this.unfixedCurrentTimes[a]&&(this.unfixedCurrentFrameIndexes[a]=0),this.unfixedCurrentTimes[a]=e;this.unfixedCurrentFrameIndexes[a]<s.keyFrame.length&&!(s.keyFrame[this.unfixedCurrentFrameIndexes[a]].startTime>this.unfixedCurrentTimes[a]);)this.unfixedCurrentFrameIndexes[a]++;this.unfixedCurrentFrameIndexes[a]--}return this.unfixedCurrentFrameIndexes}getOriginalDataUnfixedRate(t,e,i){var a=this._anis[t].nodes;t!==this.unfixedLastAniIndex&&(this.unfixedCurrentFrameIndexes=new Uint32Array(a.length),this.unfixedCurrentTimes=new Float32Array(a.length),this.unfixedKeyframes=[],this.unfixedLastAniIndex=t);for(var r=0,s=0,n=a.length,h=0;s<n;s++){var l=a[s];for(i<this.unfixedCurrentTimes[s]&&(this.unfixedCurrentFrameIndexes[s]=0),this.unfixedCurrentTimes[s]=i;this.unfixedCurrentFrameIndexes[s]<l.keyFrame.length&&!(l.keyFrame[this.unfixedCurrentFrameIndexes[s]].startTime>this.unfixedCurrentTimes[s]);)this.unfixedKeyframes[s]=l.keyFrame[this.unfixedCurrentFrameIndexes[s]],this.unfixedCurrentFrameIndexes[s]++;var o=this.unfixedKeyframes[s];l.dataOffset=h;var u=i-o.startTime;if(l.lerpType)switch(l.lerpType){case 0:case 1:for(r=0;r<l.keyframeWidth;)r+=l.interpolationMethod[r](l,r,e,h+r,o.data,u,o.dData,o.duration,o.nextData);break;case 2:var p=o.interpolationData,_=p.length,d=0;for(r=0;r<_;){var c=p[r];switch(c){case 6:case 7:r+=AnimationTemplet.interpolation[c](l,d,e,h+d,o.data,u,o.dData,o.duration,o.nextData,p,r+1);break;default:r+=AnimationTemplet.interpolation[c](l,d,e,h+d,o.data,u,o.dData,o.duration,o.nextData)}d++}}else for(r=0;r<l.keyframeWidth;)r+=l.interpolationMethod[r](l,r,e,h+r,o.data,u,o.dData,o.duration,o.nextData);h+=l.keyframeWidth}}}AnimationTemplet.interpolation=[AnimationTemplet._LinearInterpolation_0,AnimationTemplet._QuaternionInterpolation_1,AnimationTemplet._AngleInterpolation_2,AnimationTemplet._RadiansInterpolation_3,AnimationTemplet._Matrix4x4Interpolation_4,AnimationTemplet._NoInterpolation_5,AnimationTemplet._BezierInterpolation_6,AnimationTemplet._BezierInterpolation_7],IAniLib.AnimationTemplet=AnimationTemplet;class GraphicsAni extends e.Graphics{drawSkin(t,i){this.drawTriangles(t.texture,0,0,t.vertices,t.uvs,t.indexes,t.transform||e.Matrix.EMPTY,i)}static create(){return GraphicsAni._caches.pop()||new GraphicsAni}static recycle(t){t.clear(),GraphicsAni._caches.push(t)}}GraphicsAni._caches=[];class IkConstraint{constructor(t,e){this.isSpine=!0,this.isDebug=!1,this._targetBone=e[t.targetBoneIndex],this.isSpine=t.isSpine,null==this._bones&&(this._bones=[]),this._bones.length=0;for(var i=0,a=t.boneIndexs.length;i<a;i++)this._bones.push(e[t.boneIndexs[i]]);this.name=t.name,this.mix=t.mix,this.bendDirection=t.bendDirection}apply(){switch(this._bones.length){case 1:this._applyIk1(this._bones[0],this._targetBone.resultMatrix.tx,this._targetBone.resultMatrix.ty,this.mix);break;case 2:this.isSpine?this._applyIk2(this._bones[0],this._bones[1],this._targetBone.resultMatrix.tx,this._targetBone.resultMatrix.ty,this.bendDirection,this.mix):this._applyIk3(this._bones[0],this._bones[1],this._targetBone.resultMatrix.tx,this._targetBone.resultMatrix.ty,this.bendDirection,this.mix)}}_applyIk1(t,e,i,a){var r=t.parentBone,s=1/(r.resultMatrix.a*r.resultMatrix.d-r.resultMatrix.b*r.resultMatrix.c),n=e-r.resultMatrix.tx,h=i-r.resultMatrix.ty,l=(n*r.resultMatrix.d-h*r.resultMatrix.c)*s-t.transform.x,o=(h*r.resultMatrix.a-n*r.resultMatrix.b)*s-t.transform.y,u=Math.atan2(o,l)*IkConstraint.radDeg-0-t.transform.skX;t.transform.scX<0&&(u+=180),u>180?u-=360:u<-180&&(u+=360),t.transform.skX=t.transform.skY=t.transform.skX+u*a,t.update()}updatePos(t,e){this._sp&&this._sp.pos(t,e)}_applyIk2(t,i,a,r,s,n){if(0!=n){var h,l,o,u=t.resultTransform.x,p=t.resultTransform.y,_=t.transform.scX,d=t.transform.scY,c=i.transform.scX;_<0?(_=-_,h=180,o=-1):(h=0,o=1),d<0&&(d=-d,o=-o),c<0?(c=-c,l=180):l=0;var m,x,y,g=i.resultTransform.x,f=t.resultMatrix.a,D=t.resultMatrix.c,M=t.resultMatrix.b,A=t.resultMatrix.d,v=Math.abs(_-d)<=1e-4;v?(x=f*g+D*(m=i.resultTransform.y)+t.resultMatrix.tx,y=M*g+A*m+t.resultMatrix.ty):(m=0,x=f*g+t.resultMatrix.tx,y=M*g+t.resultMatrix.ty),this.isDebug&&(this._sp||(this._sp=new e.Sprite,e.ILaya.stage.addChild(this._sp)),this._sp.graphics.clear(),this._sp.graphics.drawCircle(a,r,15,"#ffff00"),this._sp.graphics.drawCircle(x,y,15,"#ff00ff")),t.setRotation(Math.atan2(y-t.resultMatrix.ty,x-t.resultMatrix.tx));var I=t.parentBone;f=I.resultMatrix.a,D=I.resultMatrix.c,M=I.resultMatrix.b;var S,T,C=1/(f*(A=I.resultMatrix.d)-D*M),b=a-I.resultMatrix.tx,k=r-I.resultMatrix.ty,F=(b*A-k*D)*C-u,w=(k*f-b*M)*C-p,P=((b=x-I.resultMatrix.tx)*A-(k=y-I.resultMatrix.ty)*D)*C-u,B=(k*f-b*M)*C-p,U=Math.sqrt(P*P+B*B),L=i.length*c;if(v){var N=(F*F+w*w-U*U-(L*=_)*L)/(2*U*L);N<-1?N=-1:N>1&&(N=1),T=Math.acos(N)*s,f=U+L*N,D=L*Math.sin(T),S=Math.atan2(w*f-F*D,F*f+w*D)}else{var E=(f=_*L)*f,R=(D=d*L)*D,V=F*F+w*w,O=Math.atan2(w,F),K=-2*R*U,Y=R-E;if((A=K*K-4*Y*(M=R*U*U+E*V-E*R))>0){var X=Math.sqrt(A);K<0&&(X=-X);var z=(X=-(K+X)/2)/Y,W=M/X,G=Math.abs(z)<Math.abs(W)?z:W;G*G<=V&&(k=Math.sqrt(V-G*G)*s,S=O-Math.atan2(k,G),T=Math.atan2(k/d,(G-U)/_))}var q=0,H=Number.MAX_VALUE,Q=0,Z=0,j=0,J=0,$=0,tt=0;(A=(b=U+f)*b)>J&&(j=0,J=A,$=b),(A=(b=U-f)*b)<H&&(q=Math.PI,H=A,Q=b);var et=Math.acos(-f*U/(E-R));(A=(b=f*Math.cos(et)+U)*b+(k=D*Math.sin(et))*k)<H&&(q=et,H=A,Q=b,Z=k),A>J&&(j=et,J=A,$=b,tt=k),V<=(H+J)/2?(S=O-Math.atan2(Z*s,Q),T=q*s):(S=O-Math.atan2(tt*s,$),T=j*s)}var it=Math.atan2(m,g)*o,at=t.resultTransform.skX;(S=(S-it)*IkConstraint.radDeg+h-at)>180?S-=360:S<-180&&(S+=360),t.resultTransform.x=u,t.resultTransform.y=p,t.resultTransform.skX=t.resultTransform.skY=at+S*n,at=i.resultTransform.skX,at%=360,(T=((T+it)*IkConstraint.radDeg-0)*o+l-at)>180?T-=360:T<-180&&(T+=360),i.resultTransform.x=g,i.resultTransform.y=m,i.resultTransform.skX=i.resultTransform.skY=i.resultTransform.skY+T*n,t.update()}}_applyIk3(t,i,a,r,s,n){if(0==n)return;var h,l;const o=i.resultMatrix.a*i.length,u=i.resultMatrix.b*i.length,p=o*o+u*u,_=Math.sqrt(p);var d=t.resultMatrix.tx,c=t.resultMatrix.ty,m=i.resultMatrix.tx,x=i.resultMatrix.ty,y=m-d,g=x-c;const f=y*y+g*g,D=Math.sqrt(f),M=(y=a-t.resultMatrix.tx)*y+(g=r-t.resultMatrix.ty)*g,A=Math.sqrt(M);if(_+D<=A||A+_<=D||A+D<=_){var v;m=d+(v=_+D<=A?1:-1)*(a-d)*D/A,x=c+v*(r-c)*D/A}else{const t=(f-p+M)/(2*M),e=Math.sqrt(f-t*t*M)/A,i=d+y*t,a=c+g*t,r=-g*e,n=y*e;s>0?(m=i-r,x=a-n):(m=i+r,x=a+n)}var I,S,T,C;h=m,l=x,this.isDebug&&(this._sp||(this._sp=new e.Sprite,e.ILaya.stage.addChild(this._sp)),this._sp.graphics.clear(),this._sp.graphics.drawCircle(d,c,15,"#ff00ff"),this._sp.graphics.drawCircle(a,r,15,"#ffff00"),this._sp.graphics.drawCircle(h,l,15,"#ff00ff")),I=Math.atan2(l-t.resultMatrix.ty,h-t.resultMatrix.tx),t.setRotation(I),(S=IkConstraint._tempMatrix).identity(),S.rotate(I),S.scale(t.resultMatrix.getScaleX(),t.resultMatrix.getScaleY()),S.translate(t.resultMatrix.tx,t.resultMatrix.ty),S.copyTo(t.resultMatrix),t.updateChild(),T=Math.atan2(r-l,a-h),i.setRotation(T),(C=IkConstraint._tempMatrix).identity(),C.rotate(T),C.scale(i.resultMatrix.getScaleX(),i.resultMatrix.getScaleY()),C.translate(h,l),S.copyTo(i.resultMatrix),i.updateChild()}}IkConstraint.radDeg=180/Math.PI,IkConstraint.degRad=Math.PI/180,IkConstraint._tempMatrix=new e.Matrix;class PathConstraint{constructor(t,e){this._debugKey=!1,this._segments=[],this._curves=[],this.data=t,this.position=t.position,this.spacing=t.spacing,this.rotateMix=t.rotateMix,this.translateMix=t.translateMix,this.bones=[];for(var i=this.data.bones,a=0,r=i.length;a<r;a++)this.bones.push(e[i[a]])}apply(t,e){if(this.target){var i=this.translateMix,a=this.translateMix,r=a>0,s=this.data.spacingMode,n="length"==s,h=this.data.rotateMode,l="tangent"==h,o="chainScale"==h,u=[],p=this.bones.length,_=l?p:p+1,d=[];this._spaces=d,d[0]=this.position;var c=this.spacing;if(o||n)for(var m=0,x=_-1;m<x;){var y=this.bones[m],g=y.length,f=g*y.resultMatrix.a,D=g*y.resultMatrix.b;g=Math.sqrt(f*f+D*D),o&&(u[m]=g),d[++m]=n?Math.max(0,g+c):c}else for(m=1;m<_;m++)d[m]=c;var M=this.computeWorldPositions(this.target,t,e,_,l,"percent"==this.data.positionMode,"percent"==s);if(this._debugKey){for(m=0;m<M.length;m++)e.drawCircle(M[m++],M[m++],5,"#00ff00");var A=[];for(m=0;m<M.length;m++)A.push(M[m++],M[m++]);e.drawLines(0,0,A,"#ff0000")}var v,I=M[0],S=M[1],T=this.data.offsetRotation,C="chain"==h&&0==T;for(m=0,v=3;m<p;m++,v+=3){(y=this.bones[m]).resultMatrix.tx+=(I-y.resultMatrix.tx)*i,y.resultMatrix.ty+=(S-y.resultMatrix.ty)*i;var b=(f=M[v])-I,k=(D=M[v+1])-S;if(o&&0!=(g=u[m])){var F=(Math.sqrt(b*b+k*k)/g-1)*a+1;y.resultMatrix.a*=F,y.resultMatrix.c*=F}if(I=f,S=D,r){var w,P,B,U=y.resultMatrix.a,L=y.resultMatrix.c,N=y.resultMatrix.b,E=y.resultMatrix.d;w=l?M[v-1]:0==d[m+1]?M[v+2]:Math.atan2(k,b),w-=Math.atan2(N,U)-T/180*Math.PI,C&&(P=Math.cos(w),B=Math.sin(w),I+=((g=y.length)*(P*U-B*N)-b)*a,S+=(g*(B*U+P*N)-k)*a),w>Math.PI?w-=2*Math.PI:w<-Math.PI&&(w+=2*Math.PI),w*=a,P=Math.cos(w),B=Math.sin(w),y.resultMatrix.a=P*U-B*N,y.resultMatrix.c=P*L-B*E,y.resultMatrix.b=B*U+P*N,y.resultMatrix.d=B*L+P*E}}}}computeWorldVertices2(t,e,i,a,r,s){var n,h,l,o=t.currDisplayData.bones,u=t.currDisplayData.weights,p=t.currDisplayData.triangles,_=0,d=0,c=0,m=0,x=0,y=0,g=0,f=0,D=0,M=0;if(null!=o){for(_=0;_<i;_+=2)d+=(m=o[d])+1,c+=m;var A=e;for(x=s,y=3*c;x<a;x+=2){for(g=0,f=0,m=o[d++],m+=d;d<m;d++,y+=3){n=A[o[d]].resultMatrix,D=u[y],M=u[y+1];var v=u[y+2];g+=(D*n.a+M*n.c+n.tx)*v,f+=(D*n.b+M*n.d+n.ty)*v}r[x]=g,r[x+1]=f}}else{var I,S;if(p||(p=u),t.deformData&&(p=t.deformData),I=t.parent,e)for(l=e.length,_=0;_<l;_++)if(e[_].name==I){h=e[_];break}h&&(S=h.resultMatrix),S||(S=PathConstraint._tempMt);var T=S.tx,C=S.ty,b=S.a,k=S.b,F=S.c,w=S.d;for(h&&(w*=h.d),d=i,x=s;x<a;d+=2,x+=2)D=p[d],M=p[d+1],r[x]=D*b+M*k+T,r[x+1]=-(D*F+M*w+C)}}computeWorldPositions(t,e,i,a,r,s,n){t.currDisplayData.bones,t.currDisplayData.weights,t.currDisplayData.triangles;var h,l,o,u,p,_,d,c,m=[],x=0,y=t.currDisplayData.verLen,g=this.position,f=this._spaces,D=[],M=y/6,A=-1;if(M--,y-=4,this.computeWorldVertices2(t,e,2,y,m,0),this._debugKey)for(x=0;x<m.length;)i.drawCircle(m[x++],m[x++],10,"#ff0000");h=m,this._curves.length=M;var v=this._curves;l=0;var I,S,T,C,b,k,F,w,P,B=h[0],U=h[1],L=0,N=0,E=0,R=0,V=0,O=0;for(x=0,P=2;x<M;x++,P+=6)b=2*(I=.1875*(B-2*(L=h[P])+(E=h[P+2])))+(T=.09375*(3*(L-E)-B+(V=h[P+4]))),k=2*(S=.1875*(U-2*(N=h[P+1])+(R=h[P+3])))+(C=.09375*(3*(N-R)-U+(O=h[P+5]))),F=.75*(L-B)+I+.16666667*T,w=.75*(N-U)+S+.16666667*C,l+=Math.sqrt(F*F+w*w),F+=b,w+=k,b+=T,k+=C,l+=Math.sqrt(F*F+w*w),F+=b,w+=k,l+=Math.sqrt(F*F+w*w),F+=b+T,w+=k+C,l+=Math.sqrt(F*F+w*w),v[x]=l,B=V,U=O;if(s&&(g*=l),n)for(x=0;x<a;x++)f[x]*=l;var K,Y=this._segments,X=0;for(x=0,o=0,u=0,K=0;x<a;x++,o+=3)if((p=g+=_=f[x])<0)this.addBeforePosition(p,h,0,D,o);else if(p>l)this.addAfterPosition(p-l,h,y-4,D,o);else{for(;;u++)if(!(p>(c=v[u]))){0==u?p/=c:p=(p-(d=v[u-1]))/(c-d);break}if(u!=A){A=u;var z=6*u;for(b=2*(I=.03*((B=h[z])-2*(L=h[z+2])+(E=h[z+4])))+(T=.006*(3*(L-E)-B+(V=h[z+6]))),k=2*(S=.03*((U=h[z+1])-2*(N=h[z+3])+(R=h[z+5])))+(C=.006*(3*(N-R)-U+(O=h[z+7]))),F=.3*(L-B)+I+.16666667*T,w=.3*(N-U)+S+.16666667*C,X=Math.sqrt(F*F+w*w),Y[0]=X,z=1;z<8;z++)F+=b,w+=k,b+=T,k+=C,X+=Math.sqrt(F*F+w*w),Y[z]=X;F+=b,w+=k,X+=Math.sqrt(F*F+w*w),Y[8]=X,F+=b+T,w+=k+C,X+=Math.sqrt(F*F+w*w),Y[9]=X,K=0}for(p*=X;;K++)if(!(p>(c=Y[K]))){0==K?p/=c:p=K+(p-(d=Y[K-1]))/(c-d);break}this.addCurvePosition(.1*p,B,U,L,N,E,R,V,O,D,o,r||x>0&&0==_)}return D}addBeforePosition(t,e,i,a,r){var s=e[i],n=e[i+1],h=e[i+2]-s,l=e[i+3]-n,o=Math.atan2(l,h);a[r]=s+t*Math.cos(o),a[r+1]=n+t*Math.sin(o),a[r+2]=o}addAfterPosition(t,e,i,a,r){var s=e[i+2],n=e[i+3],h=s-e[i],l=n-e[i+1],o=Math.atan2(l,h);a[r]=s+t*Math.cos(o),a[r+1]=n+t*Math.sin(o),a[r+2]=o}addCurvePosition(t,e,i,a,r,s,n,h,l,o,u,p){0==t&&(t=1e-4);var _=t*t,d=_*t,c=1-t,m=c*c,x=m*c,y=c*t,g=3*y,f=c*g,D=g*t,M=e*x+a*f+s*D+h*d,A=i*x+r*f+n*D+l*d;o[u]=M,o[u+1]=A,o[u+2]=p?Math.atan2(A-(i*m+r*y*2+n*_),M-(e*m+a*y*2+s*_)):0}}PathConstraint.BEFORE=-2,PathConstraint.AFTER=-3,PathConstraint._tempMt=new e.Matrix;class TfConstraint{constructor(t,e){var i,a;for(this._temp=[],this._data=t,null==this._bones&&(this._bones=[]),this.target=e[t.targetIndex],i=0,a=t.boneIndexs.length;i<a;i++)this._bones.push(e[t.boneIndexs[i]]);this.rotateMix=t.rotateMix,this.translateMix=t.translateMix,this.scaleMix=t.scaleMix,this.shearMix=t.shearMix}apply(){for(var t,e=this.target.resultMatrix.a,i=this.target.resultMatrix.b,a=this.target.resultMatrix.c,r=this.target.resultMatrix.d,s=0,n=this._bones.length;s<n;s++){if(t=this._bones[s],this.rotateMix>0){var h=t.resultMatrix.a,l=t.resultMatrix.b,o=t.resultMatrix.c,u=t.resultMatrix.d,p=Math.atan2(a,e)-Math.atan2(o,h)+this._data.offsetRotation*Math.PI/180;p>Math.PI?p-=2*Math.PI:p<-Math.PI&&(p+=2*Math.PI),p*=this.rotateMix;var _=Math.cos(p),d=Math.sin(p);t.resultMatrix.a=_*h-d*o,t.resultMatrix.b=_*l-d*u,t.resultMatrix.c=d*h+_*o,t.resultMatrix.d=d*l+_*u}if(this.translateMix&&(this._temp[0]=this._data.offsetX,this._temp[1]=this._data.offsetY,this.target.localToWorld(this._temp),t.resultMatrix.tx+=(this._temp[0]-t.resultMatrix.tx)*this.translateMix,t.resultMatrix.ty+=(this._temp[1]-t.resultMatrix.ty)*this.translateMix,t.updateChild()),this.scaleMix>0){var c=Math.sqrt(t.resultMatrix.a*t.resultMatrix.a+t.resultMatrix.c*t.resultMatrix.c),m=Math.sqrt(e*e+a*a),x=c>1e-5?(c+(m-c+this._data.offsetScaleX)*this.scaleMix)/c:0;t.resultMatrix.a*=x,t.resultMatrix.c*=x,c=Math.sqrt(t.resultMatrix.b*t.resultMatrix.b+t.resultMatrix.d*t.resultMatrix.d),m=Math.sqrt(i*i+r*r),x=c>1e-5?(c+(m-c+this._data.offsetScaleY)*this.scaleMix)/c:0,t.resultMatrix.b*=x,t.resultMatrix.d*=x}if(this.shearMix>0){l=t.resultMatrix.b,u=t.resultMatrix.d;var y=Math.atan2(u,l);(p=Math.atan2(r,i)-Math.atan2(a,e)-(y-Math.atan2(t.resultMatrix.c,t.resultMatrix.a)))>Math.PI?p-=2*Math.PI:p<-Math.PI&&(p+=2*Math.PI),p=y+(p+this._data.offsetShearY*Math.PI/180)*this.shearMix,x=Math.sqrt(l*l+u*u),t.resultMatrix.b=Math.cos(p)*x,t.resultMatrix.d=Math.sin(p)*x}}}}class Skeleton extends e.Sprite{constructor(t=0){super(),this._boneMatrixArray=[],this._lastTime=0,this._currAniIndex=-1,this._pause=!0,this._aniClipIndex=-1,this._clipIndex=-1,this._skinIndex=0,this._skinName="default",this._aniMode=0,this._index=-1,this._total=-1,this._indexControl=!1,this._eventIndex=0,this._drawOrderIndex=0,this._drawOrder=null,this._lastAniClipIndex=-1,this._lastUpdateAniClipIndex=-1,this._playAudio=!0,this._soundChannelArr=[],this._animationName="",this._loop=!0,this._aniMode=t}get index(){return this._index}set index(t){this.player&&(this._index=t,this._player.currentTime=1e3*this._index/this._player.cacheFrameRate,this._indexControl=!0,(this._aniClipIndex<0||this._aniClipIndex>=this.getAnimNum())&&(this._aniClipIndex=0,this._currAniIndex=0,this._curOriginalData=new Float32Array(this._templet.getTotalkeyframesLength(this._currAniIndex)),this._drawOrder=null,this._eventIndex=0),this._update(!1))}get total(){return this._templet&&this._player?this._total=Math.floor(this._templet.getAniDuration(this._player.currentAnimationClipIndex)/1e3*this._player.cacheFrameRate):this._total=-1,this._total}get player(){return this._player}get skinName(){return this._skinName}set skinName(t){this._skinName=t,this._templet&&this.showSkinByName(t)}get animationName(){return this._animationName}set animationName(t){this._animationName=t,this._templet&&this.play(t,this._loop,!0)}get loop(){return this._loop}set loop(t){this._loop=t,this._templet&&this.play(this._animationName,this._loop,!0)}get templet(){return this._templet}set templet(t){this.init(t)}get source(){return this._source}set source(t){this._source=t,t?e.ILaya.loader.load(t).then((t=>{!this._source||t&&!t.isCreateFromURL(this._source)||(this.templet=t)})):this.templet=null}get aniMode(){return this._aniMode}set aniMode(t){this._aniMode=t}init(t){if(this._templet&&(this.reset(),this.graphics.clear()),this._templet=t,this._templet){if(1==this._aniMode){this._graphicsCache=[];for(let e=0,i=t.getAnimationCount();e<i;e++)this._graphicsCache.push([])}if(this._yReverseMatrix=t.yReverseMatrix,this._templet._addReference(1),this._player=new AnimationPlayer,this._player.templet=t,this._player.play(),this._parseSrcBoneMatrix(),this._boneList=t.mBoneArr,this._rootBone=t.mRootBone,this._aniSectionDic=t.aniSectionDic,t.ikArr.length>0){this._ikArr=[];for(let e=0,i=t.ikArr.length;e<i;e++)this._ikArr.push(new IkConstraint(t.ikArr[e],this._boneList))}if(t.pathArr.length>0){this._pathDic={};for(let e=0,i=t.pathArr.length;e<i;e++){let i=t.pathArr[e],a=new PathConstraint(i,this._boneList),r=this._boneSlotDic[i.name];r&&(a=new PathConstraint(i,this._boneList),a.target=r),this._pathDic[i.name]=a}}if(t.tfArr.length>0){this._tfArr=[];for(let e=0,i=t.tfArr.length;e<i;e++)this._tfArr.push(new TfConstraint(t.tfArr[e],this._boneList))}t.skinDataArray.length>0&&(this._skinIndex=this._templet.getSkinIndexByName(this._skinName),-1==this._skinIndex&&(this._skinIndex=0)),this._player.on(e.Event.PLAYED,this,this._onPlay),this._player.on(e.Event.STOPPED,this,this._onStop),this._player.on(e.Event.PAUSED,this,this._onPause),e.LayaEnv.isPlaying&&this._animationName&&this.play(this._animationName,this._loop,!0)}}load(t,i){e.ILaya.loader.load(t).then((e=>{null!=e&&e.isCreateFromURL(t)&&(this.init(e),this.play(0,!0),i&&i.runWith(this))}))}_onPlay(){this.event(e.Event.PLAYED)}_onStop(){let t=this._templet.eventAniArr[this._aniClipIndex];if(t&&this._eventIndex<t.length)for(;this._eventIndex<t.length;this._eventIndex++){let i=t[this._eventIndex];i.time>=this._player.playStart&&i.time<=this._player.playEnd&&this.event(e.Event.LABEL,i)}this._drawOrder=null,this.event(e.Event.STOPPED)}_onPause(){this.event(e.Event.PAUSED)}_parseSrcBoneMatrix(){let t=this._templet.srcBoneMatrixArr.length;for(let i=0;i<t;i++)this._boneMatrixArray.push(new e.Matrix);if(0==this._aniMode)this._boneSlotDic=this._templet.boneSlotDic,this._bindBoneBoneSlotDic=this._templet.bindBoneBoneSlotDic,this._boneSlotArray=this._templet.boneSlotArray;else{this._boneSlotDic={},this._bindBoneBoneSlotDic={},this._boneSlotArray=[];let t=this._templet.boneSlotArray;for(let e=0,i=t.length;e<i;e++){let i=t[e],a=this._bindBoneBoneSlotDic[i.parent];null==a&&(this._bindBoneBoneSlotDic[i.parent]=a=[]),this._boneSlotDic[i.name]=i=i.copy(),a.push(i),this._boneSlotArray.push(i)}}}_emitMissedEvents(t,i,a=0){let r=this._templet.eventAniArr[this._player.currentAnimationClipIndex];if(r){let t=r.length;for(let i=a;i<t;i++){let t=r[i];t.time>=this._player.playStart&&t.time<=this._player.playEnd&&this.event(e.Event.LABEL,t)}}}_update(t=!0){if(t&&this._pause)return;if(t&&this._indexControl)return;let i=this.timer.currTimer,a=this._player.currentKeyframeIndex,r=i-this._lastTime;if(t?this._player._update(r):a=-1,this._lastTime=i,this._index=this._clipIndex=this._player.currentKeyframeIndex,this._index<0)return;if(r>0&&this._clipIndex==a&&this._lastUpdateAniClipIndex==this._aniClipIndex)return;this._lastUpdateAniClipIndex=this._aniClipIndex,a>this._clipIndex&&0!=this._eventIndex&&(this._emitMissedEvents(this._player.playStart,this._player.playEnd,this._eventIndex),this._eventIndex=0);let s=this._templet.eventAniArr[this._aniClipIndex];if(s&&this._eventIndex<s.length){let t=s[this._eventIndex];if(t.time>=this._player.playStart&&t.time<=this._player.playEnd){if(this._player.currentPlayTime>=t.time&&(this.event(e.Event.LABEL,t),this._eventIndex++,this._playAudio&&t.audioValue&&"null"!==t.audioValue&&"undefined"!==t.audioValue)){let i=e.SoundManager.playSound(this._player.templet._path+t.audioValue,1,e.Handler.create(this,this._onAniSoundStoped));e.SoundManager.playbackRate=this._player.playbackRate,i&&this._soundChannelArr.push(i)}}else if(t.time<this._player.playStart&&this._playAudio&&t.audioValue&&"null"!==t.audioValue&&"undefined"!==t.audioValue){this._eventIndex++;let i=e.SoundManager.playSound(this._player.templet._path+t.audioValue,1,e.Handler.create(this,this._onAniSoundStoped),null,(this._player.currentPlayTime-t.time)/1e3);e.SoundManager.playbackRate=this._player.playbackRate,i&&this._soundChannelArr.push(i)}else this._eventIndex++}if(0==this._aniMode){let t=this._templet.getGrahicsDataWithCache(this._aniClipIndex,this._clipIndex)||this._createGraphics();t&&this.graphics!=t&&(this.graphics=t)}else if(1==this._aniMode){let t=this._getGrahicsDataWithCache(this._aniClipIndex,this._clipIndex)||this._createGraphics();t&&this.graphics!=t&&(this.graphics=t)}else this._createGraphics()}_onAniSoundStoped(t){for(let e=this._soundChannelArr.length-1;e>=0;e--){let i=this._soundChannelArr[e];(i.isStopped||t)&&(!i.isStopped&&i.stop(),this._soundChannelArr.splice(e,1))}}_createGraphics(t=-1){-1==t&&(t=this._clipIndex);let i=t*this._player.cacheFrameRateInterval,a=this._templet.drawOrderAniArr[this._aniClipIndex];if(a&&a.length>0){this._drawOrderIndex=0;let t=a[this._drawOrderIndex];for(;i>=t.time&&(this._drawOrder=t.drawOrder,this._drawOrderIndex++,!(this._drawOrderIndex>=a.length));)t=a[this._drawOrderIndex]}0==this._aniMode||1==this._aniMode?this.graphics=GraphicsAni.create():this.graphics instanceof GraphicsAni?this.graphics.clear():this.graphics=GraphicsAni.create();let r=this.graphics,s=this._templet.getNodes(this._aniClipIndex),n=0==this._player.state;this._templet.getOriginalData(this._aniClipIndex,this._curOriginalData,null,t,n?i+this._player.cacheFrameRateInterval:i);let h=this._aniSectionDic[this._aniClipIndex],l=0,o=0,u=0,p=0,_=0,d=this._templet.srcBoneMatrixArr.length,c=this._curOriginalData;for(o=0,_=h[0];o<d;o++){let t=this._boneList[o].resultTransform,e=this._templet.srcBoneMatrixArr[o];t.scX=e.scX*c[l++],t.skX=e.skX+c[l++],t.skY=e.skY+c[l++],t.scY=e.scY*c[l++],t.x=e.x+c[l++],t.y=e.y+c[l++],8===this._templet.tMatrixDataLen&&(t.skewX=e.skewX+c[l++],t.skewY=e.skewY+c[l++])}let m={},x={};for(_+=h[1];o<_;o++){let t=s[o];m[t.name]=c[l++],x[t.name]=c[l++],l+=4}let y={},g={};for(_+=h[2];o<_;o++){let t=s[o];y[t.name]=c[l++],g[t.name]=c[l++],l+=4}if(this._pathDic)for(_+=h[3];o<_;o++){let t=s[o],i=this._pathDic[t.name];if(i){switch(new e.Byte(t.extenData).getByte()){case 1:i.position=c[l++];break;case 2:i.spacing=c[l++];break;case 3:i.rotateMix=c[l++],i.translateMix=c[l++]}}}if(this._rootBone.update(this._yReverseMatrix||e.Matrix.TEMP.identity()),this._ikArr){let t;for(o=0,_=this._ikArr.length;o<_;o++)t=this._ikArr[o],t.name in y&&(t.bendDirection=y[t.name]),t.name in g&&(t.mix=g[t.name]),t.apply()}if(this._pathDic)for(let t in this._pathDic){this._pathDic[t].apply(this._boneList,r)}if(this._tfArr)for(o=0,p=this._tfArr.length;o<p;o++){this._tfArr[o].apply()}for(o=0,p=this._boneList.length;o<p;o++){let t=this._boneList[o],e=this._bindBoneBoneSlotDic[t.name];if(t.resultMatrix.copyTo(this._boneMatrixArray[o]),e)for(u=0,_=e.length;u<_;u++){let i=e[u];i&&i.setParentMatrix(t.resultMatrix)}}let f={},D=this._templet.deformAniArr;if(D&&D.length>0){if(this._lastAniClipIndex!=this._aniClipIndex)for(this._lastAniClipIndex=this._aniClipIndex,o=0,_=this._boneSlotArray.length;o<_;o++){this._boneSlotArray[o].deformData=null}let t,e=D[this._aniClipIndex],a=e.default;for(t in this._setDeform(a,f,this._boneSlotArray,i),e)"default"!=t&&t!=this._skinName&&(a=e[t],this._setDeform(a,f,this._boneSlotArray,i));a=e[this._skinName],this._setDeform(a,f,this._boneSlotArray,i)}if(this._drawOrder)for(o=0,_=this._drawOrder.length;o<_;o++){let t=this._boneSlotArray[this._drawOrder[o]],e=m[t.name],i=x[t.name];if(isNaN(e)||-2==e||(this._templet.attachmentNames?t.showDisplayByName(this._templet.attachmentNames[e]):t.showDisplayByIndex(e)),f[this._drawOrder[o]]){let e=f[this._drawOrder[o]];t.currDisplayData&&e[t.currDisplayData.attachmentName]?t.deformData=e[t.currDisplayData.attachmentName]:t.deformData=null}else t.deformData=null;isNaN(i)?t.draw(r,this._boneMatrixArray,2==this._aniMode):t.draw(r,this._boneMatrixArray,2==this._aniMode,i)}else for(o=0,_=this._boneSlotArray.length;o<_;o++){let t=this._boneSlotArray[o],e=m[t.name],i=x[t.name];if(isNaN(e)||-2==e||(this._templet.attachmentNames?t.showDisplayByName(this._templet.attachmentNames[e]):t.showDisplayByIndex(e)),f[o]){let e=f[o];t.currDisplayData&&e[t.currDisplayData.attachmentName]?t.deformData=e[t.currDisplayData.attachmentName]:t.deformData=null}else t.deformData=null;isNaN(i)?t.draw(r,this._boneMatrixArray,2==this._aniMode):t.draw(r,this._boneMatrixArray,2==this._aniMode,i)}return 0==this._aniMode?(this._templet.setGrahicsDataWithCache(this._aniClipIndex,t,r),this._checkIsAllParsed(this._aniClipIndex)):1==this._aniMode&&this._setGrahicsDataWithCache(this._aniClipIndex,t,r),r}_checkIsAllParsed(t){let e=Math.floor(.01+this._templet.getAniDuration(t)/1e3*this._player.cacheFrameRate);for(let i=0;i<e;i++)if(!this._templet.getGrahicsDataWithCache(t,i))return;this._templet.getGrahicsDataWithCache(t,e)?this._templet.deleteAniData(t):this._createGraphics(e)}_setDeform(t,e,i,a){if(!t)return;let r,s,n;if(t)for(let h=0,l=t.deformSlotDataList.length;h<l;h++){r=t.deformSlotDataList[h];for(let t=0;t<r.deformSlotDisplayList.length;t++)s=r.deformSlotDisplayList[t],n=i[s.slotIndex],s.apply(a,n),e[s.slotIndex]||(e[s.slotIndex]={}),e[s.slotIndex][s.attachment]=s.deformData}}getAnimNum(){return this._templet.getAnimationCount()}getAniNameByIndex(t){return this._templet.getAniNameByIndex(t)}getSlotByName(t){return this._boneSlotDic[t]}showSkinByName(t,e=!0){this.showSkinByIndex(this._templet.getSkinIndexByName(t),e)}showSkinByIndex(t,e=!0){for(let t=0;t<this._boneSlotArray.length;t++)this._boneSlotArray[t].showSlotData(null,e);if(this._templet.showSkinByIndex(this._boneSlotDic,t,e)){let e=this._templet.skinDataArray[t];this._skinName=e.name}this._clearCache()}showSlotSkinByIndex(t,e){if(0==this._aniMode)return;let i=this.getSlotByName(t);i&&i.showDisplayByIndex(e),this._clearCache()}showSlotSkinByName(t,e){if(0==this._aniMode)return;let i=this.getSlotByName(t);i&&i.showDisplayByName(e),this._clearCache()}replaceSlotSkinName(t,e,i){if(0==this._aniMode)return;let a=this.getSlotByName(t);a&&a.replaceDisplayByName(e,i),this._clearCache()}replaceSlotSkinByIndex(t,e,i){if(0==this._aniMode)return;let a=this.getSlotByName(t);a&&a.replaceDisplayByIndex(e,i),this._clearCache()}setSlotSkin(t,e){if(0==this._aniMode)return;let i=this.getSlotByName(t);i&&i.replaceSkin(e),this._clearCache()}_clearCache(){if(1==this._aniMode)for(let e=0,i=this._graphicsCache.length;e<i;e++){for(let i=0,a=this._graphicsCache[e].length;i<a;i++){var t=this._graphicsCache[e][i];t&&t!=this.graphics&&GraphicsAni.recycle(t)}this._graphicsCache[e].length=0}}play(t,i,a=!0,r=0,s=0,n=!0,h=!0){this._playAudio=h,this._indexControl=!1;let l=-1;var o;if(o=i?2147483647:0,"string"==typeof t)for(let e=0,i=this._templet.getAnimationCount();e<i;e++){let i=this._templet.getAnimation(e);if(i&&t==i.name){l=e;break}}else l=t;l>-1&&l<this.getAnimNum()&&(this._aniClipIndex=l,(a||this._pause||this._currAniIndex!=l)&&(this._currAniIndex=l,this._curOriginalData=new Float32Array(this._templet.getTotalkeyframesLength(l)),this._drawOrder=null,this._eventIndex=0,this._player.play(l,this._player.playbackRate,o,r,s),n&&this._templet.showSkinByIndex(this._boneSlotDic,this._skinIndex),this._pause&&(this._pause=!1,this._lastTime=e.ILaya.Browser.now(),this.timer.frameLoop(1,this,this._update,null,!0)),this._update()))}stop(){this._pause||(this._pause=!0,this._player&&this._player.stop(!0),this._soundChannelArr.length>0&&this._onAniSoundStoped(!0),this.timer.clear(this,this._update))}playbackRate(t){this._player&&(this._player.playbackRate=t)}paused(){if(!this._pause){if(this._pause=!0,this._player&&(this._player.paused=!0),this._soundChannelArr.length>0)for(let t=this._soundChannelArr.length,e=0;e<t;e++){let t=this._soundChannelArr[e];t.isStopped||t.pause()}this.timer.clear(this,this._update)}}resume(){if(this._indexControl=!1,this._pause){if(this._pause=!1,this._player&&(this._player.paused=!1),this._soundChannelArr.length>0)for(let t=this._soundChannelArr.length,e=0;e<t;e++){let t=this._soundChannelArr[e];t.audioBuffer&&t.resume()}this._lastTime=e.ILaya.Browser.now(),this.timer.frameLoop(1,this,this._update,null,!0)}}_getGrahicsDataWithCache(t,e){return this._graphicsCache[t][e]}_setGrahicsDataWithCache(t,e,i){this._graphicsCache[t][e]=i}reset(){this._templet._removeReference(),this._templet=null,this._player.offAll(),this._player=null,this._curOriginalData=null,this._boneMatrixArray.length=0,this._ikArr=null,this._pathDic=null,this._tfArr=null,this._lastTime=0,this._currAniIndex=-1,this._clipIndex=-1,this._indexControl=!1,this._eventIndex=0,this._drawOrderIndex=0,this._drawOrder=null,this._lastAniClipIndex=-1,this._lastUpdateAniClipIndex=-1,this._pause=!0,this.timer.clear(this,this._update),this._soundChannelArr.length>0&&this._onAniSoundStoped(!0)}destroy(t=!0){super.destroy(t),this._templet&&this.reset()}}IAniLib.Skeleton=Skeleton;class Transform{constructor(){this.skX=0,this.skY=0,this.scX=1,this.scY=1,this.x=0,this.y=0,this.skewX=0,this.skewY=0}initData(t){null!=t.x&&(this.x=t.x),null!=t.y&&(this.y=t.y),null!=t.skX&&(this.skX=t.skX),null!=t.skY&&(this.skY=t.skY),null!=t.scX&&(this.scX=t.scX),null!=t.scY&&(this.scY=t.scY)}getMatrix(){var t;return(t=this.mMatrix?this.mMatrix:this.mMatrix=new e.Matrix).identity(),t.scale(this.scX,this.scY),(this.skewX||this.skewY)&&this.skew(t,this.skewX*Math.PI/180,this.skewY*Math.PI/180),t.rotate(this.skX*Math.PI/180),t.translate(this.x,this.y),t}skew(t,e,i){var a=Math.sin(i),r=Math.cos(i),s=Math.sin(e),n=Math.cos(e);return t.setTo(t.a*n-t.b*a,t.a*s+t.b*r,t.c*n-t.d*a,t.c*s+t.d*r,t.tx*n-t.ty*a,t.tx*s+t.ty*r),t}}class Bone{constructor(){this.length=10,this.resultTransform=new Transform,this.resultMatrix=new e.Matrix,this.inheritScale=!0,this.inheritRotation=!0,this.d=-1,this._children=[]}setTempMatrix(t){this._tempMatrix=t;var e,i=0;for(i=0,e=this._children.length;i<e;i++)this._children[i].setTempMatrix(this._tempMatrix)}update(t=null){var i;if(this.rotation=this.transform.skX,t)i=this.resultTransform.getMatrix(),e.Matrix.mul(i,t,this.resultMatrix),this.resultRotation=this.rotation;else if(this.resultRotation=this.rotation+this.parentBone.resultRotation,this.parentBone)if(this.inheritRotation&&this.inheritScale)i=this.resultTransform.getMatrix(),e.Matrix.mul(i,this.parentBone.resultMatrix,this.resultMatrix);else{var a,r,s,n=this.parentBone,h=this.parentBone.resultMatrix;i=this.resultTransform.getMatrix();var l=h.a*i.tx+h.c*i.ty+h.tx,o=h.b*i.tx+h.d*i.ty+h.ty,u=new e.Matrix;this.inheritRotation?(a=Math.atan2(n.resultMatrix.b,n.resultMatrix.a),r=Math.cos(a),s=Math.sin(a),u.setTo(r,s,-s,r,0,0),e.Matrix.mul(this._tempMatrix,u,e.Matrix.TEMP),e.Matrix.TEMP.copyTo(u),i=this.resultTransform.getMatrix(),e.Matrix.mul(i,u,this.resultMatrix),this.resultTransform.scX*this.resultTransform.scY<0&&this.resultMatrix.rotate(.5*Math.PI),this.resultMatrix.tx=l,this.resultMatrix.ty=o):(this.inheritScale,i=this.resultTransform.getMatrix(),e.Matrix.TEMP.identity(),e.Matrix.TEMP.d=this.d,e.Matrix.mul(i,e.Matrix.TEMP,this.resultMatrix),this.resultMatrix.tx=l,this.resultMatrix.ty=o)}else(i=this.resultTransform.getMatrix()).copyTo(this.resultMatrix);var p,_=0;for(_=0,p=this._children.length;_<p;_++)this._children[_].update()}updateChild(){var t,e=0;for(e=0,t=this._children.length;e<t;e++)this._children[e].update()}setRotation(t){this._sprite&&(this._sprite.rotation=180*t/Math.PI)}updateDraw(t,i){Bone.ShowBones&&!Bone.ShowBones[this.name]||(this._sprite?(this._sprite.x=t+this.resultMatrix.tx,this._sprite.y=i+this.resultMatrix.ty):(this._sprite=new e.Sprite,this._sprite.graphics.drawCircle(0,0,5,"#ff0000"),this._sprite.graphics.drawLine(0,0,this.length,0,"#00ff00"),this._sprite.graphics.fillText(this.name,0,0,"20px Arial","#00ff00","center"),e.ILaya.stage.addChild(this._sprite),this._sprite.x=t+this.resultMatrix.tx,this._sprite.y=i+this.resultMatrix.ty));var a,r=0;for(r=0,a=this._children.length;r<a;r++)this._children[r].updateDraw(t,i)}addChild(t){this._children.push(t),t.parentBone=this}findBone(t){if(this.name==t)return this;var e,i,a;for(e=0,i=this._children.length;e<i;e++)if(a=this._children[e].findBone(t))return a;return null}localToWorld(t){var e=t[0],i=t[1];t[0]=e*this.resultMatrix.a+i*this.resultMatrix.c+this.resultMatrix.tx,t[1]=e*this.resultMatrix.b+i*this.resultMatrix.d+this.resultMatrix.ty}}Bone.ShowBones={};class TfConstraintData{constructor(){this.boneIndexs=[]}}class PathConstraintData{constructor(){this.bones=[]}}class DeformAniData{constructor(){this.deformSlotDataList=[]}}class DeformSlotData{constructor(){this.deformSlotDisplayList=[]}}class DeformSlotDisplayData{constructor(){this.slotIndex=-1,this.timeList=[],this.vectices=[],this.tweenKeyList=[],this.frameIndex=0}binarySearch1(t,e){var i=0,a=t.length-2;if(0==a)return 1;for(var r=a>>>1;;){if(t[Math.floor(r+1)]<=e?i=r+1:a=r,i==a)return i+1;r=i+a>>>1}return 0}apply(t,e,i=1){if(t+=.05,!(this.timeList.length<=0)){var a=0;if(!(t<this.timeList[0])){var r=this.vectices[0].length,s=[],n=this.binarySearch1(this.timeList,t);if(this.frameIndex=n,t>=this.timeList[this.timeList.length-1]){var h=this.vectices[this.vectices.length-1];if(i<1)for(a=0;a<r;a++)s[a]+=(h[a]-s[a])*i;else for(a=0;a<r;a++)s[a]=h[a];this.deformData=s}else{var l,o=this.vectices[this.frameIndex-1],u=this.vectices[this.frameIndex],p=this.timeList[this.frameIndex-1],_=this.timeList[this.frameIndex];for(i=this.tweenKeyList[n-1]?(t-p)/(_-p):0,a=0;a<r;a++)l=o[a],s[a]=l+(u[a]-l)*i;this.deformData=s}}}}}class DrawOrderData{constructor(){this.drawOrder=[]}}class EventData{constructor(){}}class UVTools{constructor(){}static getRelativeUV(t,e,i=null){var a,r,s=t[0],n=t[2]-t[0],h=t[1],l=t[5]-t[1];i||(i=[]),i.length=e.length,r=i.length;var o=1/n,u=1/l;for(a=0;a<r;a+=2)i[a]=(e[a]-s)*o,i[a+1]=(e[a+1]-h)*u;return i}static getAbsoluteUV(t,i,a=null){if(0==t[0]&&0==t[1]&&1==t[4]&&1==t[5])return a?(e.Utils.copyArray(a,i),a):i;var r,s,n=t[0],h=t[2]-t[0],l=t[1],o=t[5]-t[1];for(a||(a=[]),a.length=i.length,s=a.length,r=0;r<s;r+=2)a[r]=i[r]*h+n,a[r+1]=i[r+1]*o+l;return a}}class MeshData{constructor(){this.uvs=new Float32Array([0,0,1,0,1,1,0,1]),this.vertices=new Float32Array([0,0,100,0,100,100,0,100]),this.indexes=new Uint16Array([0,1,3,3,1,2]),this.useUvTransform=!1,this.canvasPadding=1}getBounds(){return e.Rectangle._getWrapRec(this.vertices)}}class SkinMeshForGraphic extends MeshData{constructor(){super()}init2(t,e,i,a){this.transform&&(this.transform=null);var r=e||[0,1,3,3,1,2];this.texture=t,this.indexes=new Uint16Array(r),this.vertices=new Float32Array(i),this.uvs=new Float32Array(a)}}class BoneSlot{constructor(){this.srcDisplayIndex=-1,this.type="src",this.displayIndex=-1,this.originalIndex=-1,this._replaceDic={}}showSlotData(t,e=!0){this.currSlotData=t,e&&(this.displayIndex=this.srcDisplayIndex),this.currDisplayData=null,this.currTexture=null}showDisplayByName(t){this.currSlotData&&this.showDisplayByIndex(this.currSlotData.getDisplayByName(t))}replaceDisplayByName(t,e){var i,a;this.currSlotData&&(i=this.currSlotData.getDisplayByName(t),a=this.currSlotData.getDisplayByName(e),this.replaceDisplayByIndex(i,a))}replaceDisplayByIndex(t,e){this.currSlotData&&(this._replaceDic[t]=e,this.originalIndex==t&&this.showDisplayByIndex(t))}showDisplayByIndex(t){if(this.originalIndex=t,null!=this._replaceDic[t]&&(t=this._replaceDic[t]),this.currSlotData&&t>-1&&t<this.currSlotData.displayArr.length){if(this.displayIndex=t,this.currDisplayData=this.currSlotData.displayArr[t],this.currDisplayData){var e=this.currDisplayData.name;this.currTexture=this.templet.getTexture(e),this.currTexture&&0==this.currDisplayData.type&&this.currDisplayData.uvs&&(this.currTexture=this.currDisplayData.createTexture(this.currTexture))}}else this.displayIndex=-1,this.currDisplayData=null,this.currTexture=null}replaceSkin(t){this._diyTexture=t,this._curDiyUV&&(this._curDiyUV.length=0),this.currDisplayData&&this._diyTexture==this.currDisplayData.texture&&(this._diyTexture=null)}setParentMatrix(t){this._parentMatrix=t}static createSkinMesh(){return new SkinMeshForGraphic}static isSameArr(t,e){if(t.length!=e.length)return!1;var i,a;for(a=t.length,i=0;i<a;i++)if(t[i]!=e[i])return!1;return!0}getSaveVerticle(t){return BoneSlot.useSameMatrixAndVerticle&&this._preGraphicVerticle&&BoneSlot.isSameArr(t,this._preGraphicVerticle)?t=this._preGraphicVerticle:(t=e.Utils.copyArray([],t),this._preGraphicVerticle=t),t}static isSameMatrix(t,e){return t.a==e.a&&t.b==e.b&&t.c==e.c&&t.d==e.d&&Math.abs(t.tx-e.tx)<1e-5&&Math.abs(t.ty-e.ty)<1e-5}getSaveMatrix(t){if(BoneSlot.useSameMatrixAndVerticle&&this._preGraphicMatrix&&BoneSlot.isSameMatrix(t,this._preGraphicMatrix))t=this._preGraphicMatrix;else{var e=t.clone();t=e,this._preGraphicMatrix=t}return t}draw(t,i,a=!1,r=1){if((null!=this._diyTexture||null!=this.currTexture)&&null!=this.currDisplayData||this.currDisplayData&&3==this.currDisplayData.type){var s,n=this.currTexture;switch(this._diyTexture&&(n=this._diyTexture),this.currDisplayData.type){case 0:if(t){var h=this.getDisplayMatrix();if(this._parentMatrix){var l=!1;if(h){var o;if(e.Matrix.mul(h,this._parentMatrix,e.Matrix.TEMP),a?(null==this._resultMatrix&&(this._resultMatrix=new e.Matrix),o=this._resultMatrix):o=BoneSlot._tempResultMatrix,this._diyTexture&&this.currDisplayData.uvs){var u=BoneSlot._tempMatrix;u.identity(),this.currDisplayData.uvs[1]>this.currDisplayData.uvs[5]&&(u.d=-1),this.currDisplayData.uvs[0]>this.currDisplayData.uvs[4]&&this.currDisplayData.uvs[1]>this.currDisplayData.uvs[5]&&(l=!0,u.rotate(-Math.PI/2)),e.Matrix.mul(u,e.Matrix.TEMP,o)}else e.Matrix.TEMP.copyTo(o);a||(o=this.getSaveMatrix(o)),o._checkTransform(),l?t.drawTexture(n,-this.currDisplayData.height/2,-this.currDisplayData.width/2,this.currDisplayData.height,this.currDisplayData.width,o,r):t.drawTexture(n,-this.currDisplayData.width/2,-this.currDisplayData.height/2,this.currDisplayData.width,this.currDisplayData.height,o,r)}}}break;case 1:if(a?(null==this._skinSprite&&(this._skinSprite=BoneSlot.createSkinMesh()),s=this._skinSprite):s=BoneSlot.createSkinMesh(),null==s)return;var p;if(null==this.currDisplayData.bones){var _,d=this.currDisplayData.weights;this.deformData&&(d=this.deformData),this._diyTexture?(this._curDiyUV||(this._curDiyUV=[]),0==this._curDiyUV.length&&(this._curDiyUV=UVTools.getRelativeUV(this.currTexture.uv,this.currDisplayData.uvs,this._curDiyUV),this._curDiyUV=UVTools.getAbsoluteUV(this._diyTexture.uv,this._curDiyUV,this._curDiyUV)),_=this._curDiyUV):_=this.currDisplayData.uvs,this._mVerticleArr=d,this.currDisplayData.triangles.length,p=this.currDisplayData.triangles,this.deformData&&(a||(this._mVerticleArr=this.getSaveVerticle(this._mVerticleArr))),s.init2(n,p,this._mVerticleArr,_);var c,m=this.getDisplayMatrix();if(this._parentMatrix)if(m)e.Matrix.mul(m,this._parentMatrix,e.Matrix.TEMP),a?(null==this._resultMatrix&&(this._resultMatrix=new e.Matrix),c=this._resultMatrix):c=BoneSlot._tempResultMatrix,e.Matrix.TEMP.copyTo(c),a||(c=this.getSaveMatrix(c)),s.transform=c}else this.skinMesh(i,s);t.drawSkin(s,r);break;case 2:if(a?(null==this._skinSprite&&(this._skinSprite=BoneSlot.createSkinMesh()),s=this._skinSprite):s=BoneSlot.createSkinMesh(),null==s)return;this.skinMesh(i,s),t.drawSkin(s,r)}}}skinMesh(t,e){var i,a=this.currTexture,r=this.currDisplayData.bones;this._diyTexture?(a=this._diyTexture,this._curDiyUV||(this._curDiyUV=[]),0==this._curDiyUV.length&&(this._curDiyUV=UVTools.getRelativeUV(this.currTexture.uv,this.currDisplayData.uvs,this._curDiyUV),this._curDiyUV=UVTools.getAbsoluteUV(this._diyTexture.uv,this._curDiyUV,this._curDiyUV)),i=this._curDiyUV):i=this.currDisplayData.uvs;var s,n,h,l,o,u=this.currDisplayData.weights,p=this.currDisplayData.triangles,_=0,d=0,c=0,m=0,x=0,y=0,g=0;if(BoneSlot._tempVerticleArr.length=0,o=BoneSlot._tempVerticleArr,this.deformData&&this.deformData.length>0){var f=0;for(y=0,g=r.length;y<g;){for(c=r[y++]+y,_=0,d=0;y<c;y++)n=t[r[y]],h=u[m]+this.deformData[f++],l=u[m+1]+this.deformData[f++],x=u[m+2],_+=(h*n.a+l*n.c+n.tx)*x,d+=(h*n.b+l*n.d+n.ty)*x,m+=3;o.push(_,d)}}else for(y=0,g=r.length;y<g;){for(c=r[y++]+y,_=0,d=0;y<c;y++)n=t[r[y]],h=u[m],l=u[m+1],x=u[m+2],_+=(h*n.a+l*n.c+n.tx)*x,d+=(h*n.b+l*n.d+n.ty)*x,m+=3;o.push(_,d)}this._mVerticleArr=o,s=p,this._mVerticleArr=this.getSaveVerticle(this._mVerticleArr),e.init2(a,s,this._mVerticleArr,i)}drawBonePoint(t){t&&this._parentMatrix&&t.drawCircle(this._parentMatrix.tx,this._parentMatrix.ty,5,"#ff0000")}getDisplayMatrix(){return this.currDisplayData?this.currDisplayData.transform.getMatrix():null}getMatrix(){return this._resultMatrix}copy(){var t=new BoneSlot;return t.type="copy",t.name=this.name,t.attachmentName=this.attachmentName,t.srcDisplayIndex=this.srcDisplayIndex,t.parent=this.parent,t.displayIndex=this.displayIndex,t.templet=this.templet,t.currSlotData=this.currSlotData,t.currTexture=this.currTexture,t.currDisplayData=this.currDisplayData,t}}BoneSlot._tempMatrix=new e.Matrix,BoneSlot._tempResultMatrix=new e.Matrix,BoneSlot.useSameMatrixAndVerticle=!0,BoneSlot._tempVerticleArr=[];class SkinData{constructor(){this.slotArr=[]}}class SkinSlotDisplayData{createTexture(t){return this.texture||(this.texture=new e.Texture(t.bitmap,this.uvs),this.uvs[0]>this.uvs[4]&&this.uvs[1]>this.uvs[5]?(this.texture.width=t.height,this.texture.height=t.width,this.texture.offsetX=-t.offsetX,this.texture.offsetY=-t.offsetY,this.texture.sourceWidth=t.sourceHeight,this.texture.sourceHeight=t.sourceWidth):(this.texture.width=t.width,this.texture.height=t.height,this.texture.offsetX=-t.offsetX,this.texture.offsetY=-t.offsetY,this.texture.sourceWidth=t.sourceWidth,this.texture.sourceHeight=t.sourceHeight)),this.texture}destory(){this.texture&&this.texture.destroy()}}class SlotData{constructor(){this.displayArr=[]}getDisplayByName(t){for(var e=0,i=this.displayArr.length;e<i;e++)if(this.displayArr[e].attachmentName==t)return e;return-1}}class IkConstraintData{constructor(){this.boneNames=[],this.bendDirection=1,this.mix=1,this.isSpine=!0,this.targetBoneIndex=-1,this.boneIndexs=[]}}const i="LAYAANIMATION:1.7.0";class Templet extends AnimationTemplet{constructor(){super(...arguments),this.rate=30,this._graphicsCache=[],this.srcBoneMatrixArr=[],this.ikArr=[],this.tfArr=[],this.pathArr=[],this.boneSlotDic={},this.bindBoneBoneSlotDic={},this.boneSlotArray=[],this.skinDataArray=[],this.skinDic={},this.subTextureDic={},this.isParseFail=!1,this.drawOrderAniArr=[],this.eventAniArr=[],this.attachmentNames=null,this.deformAniArr=[],this.skinSlotDisplayDataArr=[],this._isParseAudio=!1,this.aniSectionDic={},this.mBoneArr=[]}buildArmature(t=0){let e=new Skeleton(t);return e.templet=this,e}_parse(t,a,r){this._path=a.slice(0,a.lastIndexOf("/"))+"/",t._addReference(),this._mainTexture=t;var s=new e.Byte(r);this._aniVersion=s.readUTFString(),AnimationParser01.parse(this,s),this._aniVersion===i?this._isParseAudio=!0:"LAYAANIMATION:1.6.0"!=this._aniVersion&&console.log("[Error] IDE"+this._aniVersion+"->"+i);for(let t=0,e=this.getAnimationCount();t<e;t++)this._graphicsCache.push([]);var n,h=new e.Byte(this.getPublicExtData()),l=0,o=0,u=0,p=0,_=0,d=0,c=0,m=0,x=0,y=h.getInt32(),g=h.readUTFString(),f=g.split("\n");for(let t=0;t<y;t++)this._path,f[2*t],g=f[2*t+1],l=h.getFloat32(),o=h.getFloat32(),u=h.getFloat32(),p=h.getFloat32(),x=h.getFloat32(),_=isNaN(x)?0:x,x=h.getFloat32(),d=isNaN(x)?0:x,x=h.getFloat32(),c=isNaN(x)?u:x,x=h.getFloat32(),m=isNaN(x)?p:x,this.subTextureDic[g]=e.Texture.create(this._mainTexture,l,o,u,p,-_,-d,c,m);n="Dragon"!=this._aniClassName;var D,M,A,v,I,S=h.getUint16();for(let t=0;t<S;t++)(D=[]).push(h.getUint16()),D.push(h.getUint16()),D.push(h.getUint16()),D.push(h.getUint16()),this.aniSectionDic[t]=D;var T,C=h.getInt16(),b={};for(let t=0;t<C;t++)M=new Bone,0==t?T=M:M.root=T,M.d=n?-1:1,v=h.readUTFString(),I=h.readUTFString(),M.length=h.getFloat32(),1==h.getByte()&&(M.inheritRotation=!1),1==h.getByte()&&(M.inheritScale=!1),M.name=v,I&&((A=b[I])?A.addChild(M):this.mRootBone=M),b[v]=M,this.mBoneArr.push(M);this.tMatrixDataLen=h.getUint16();var k,F,w=h.getUint16(),P=Math.floor(w/this.tMatrixDataLen),B=this.srcBoneMatrixArr;for(let t=0;t<P;t++)(k=new Transform).scX=h.getFloat32(),k.skX=h.getFloat32(),k.skY=h.getFloat32(),k.scY=h.getFloat32(),k.x=h.getFloat32(),k.y=h.getFloat32(),8===this.tMatrixDataLen&&(k.skewX=h.getFloat32(),k.skewY=h.getFloat32()),B.push(k),(M=this.mBoneArr[t]).transform=k;var U,L,N=h.getUint16();for(let t=0;t<N;t++){F=new IkConstraintData,U=h.getUint16();for(let t=0;t<U;t++)F.boneNames.push(h.readUTFString()),F.boneIndexs.push(h.getInt16());F.name=h.readUTFString(),F.targetBoneName=h.readUTFString(),F.targetBoneIndex=h.getInt16(),F.bendDirection=h.getFloat32(),F.mix=h.getFloat32(),F.isSpine=n,this.ikArr.push(F)}var E,R,V=h.getUint16();for(let t=0;t<V;t++){L=new TfConstraintData,E=h.getUint16();for(let t=0;t<E;t++)L.boneIndexs.push(h.getInt16());L.name=h.getUTFString(),L.targetIndex=h.getInt16(),L.rotateMix=h.getFloat32(),L.translateMix=h.getFloat32(),L.scaleMix=h.getFloat32(),L.shearMix=h.getFloat32(),L.offsetRotation=h.getFloat32(),L.offsetX=h.getFloat32(),L.offsetY=h.getFloat32(),L.offsetScaleX=h.getFloat32(),L.offsetScaleY=h.getFloat32(),L.offsetShearY=h.getFloat32(),this.tfArr.push(L)}var O,K,Y,X,z,W,G,q,H,Q,Z=h.getUint16();for(let t=0;t<Z;t++){(R=new PathConstraintData).name=h.readUTFString(),O=h.getUint16();for(let t=0;t<O;t++)R.bones.push(h.getInt16());R.target=h.readUTFString(),R.positionMode=h.readUTFString(),R.spacingMode=h.readUTFString(),R.rotateMode=h.readUTFString(),R.offsetRotation=h.getFloat32(),R.position=h.getFloat32(),R.spacing=h.getFloat32(),R.rotateMix=h.getFloat32(),R.translateMix=h.getFloat32(),this.pathArr.push(R)}var j,J=h.getInt16();for(let t=0;t<J;t++){var $=h.getUint8(),tt={};this.deformAniArr.push(tt);for(let t=0;t<$;t++){(G=new DeformAniData).skinName=h.getUTFString(),tt[G.skinName]=G,K=h.getInt16();for(let t=0;t<K;t++){q=new DeformSlotData,G.deformSlotDataList.push(q),Y=h.getInt16();for(let t=0;t<Y;t++){H=new DeformSlotDisplayData,q.deformSlotDisplayList.push(H),H.slotIndex=h.getInt16(),H.attachment=h.getUTFString(),X=h.getInt16();for(let t=0;t<X;t++){1==h.getByte()?H.tweenKeyList.push(!0):H.tweenKeyList.push(!1),z=h.getFloat32(),H.timeList.push(z),Q=[],H.vectices.push(Q),W=h.getInt16();for(let t=0;t<W;t++)Q.push(h.getFloat32())}}}}}var et,it,at,rt,st=h.getInt16();for(let t=0;t<st;t++){et=h.getInt16(),j=[];for(let t=0;t<et;t++){(it=new DrawOrderData).time=h.getFloat32(),at=h.getInt16();for(let t=0;t<at;t++)it.drawOrder.push(h.getInt16());j.push(it)}this.drawOrderAniArr.push(j)}var nt,ht,lt=h.getInt16();for(let t=0;t<lt;t++){nt=h.getInt16(),rt=[];for(let t=0;t<nt;t++)(ht=new EventData).name=h.getUTFString(),this._isParseAudio&&(ht.audioValue=h.getUTFString()),ht.intValue=h.getInt32(),ht.floatValue=h.getFloat32(),ht.stringValue=h.getUTFString(),ht.time=h.getFloat32(),rt.push(ht);this.eventAniArr.push(rt)}var ot=h.getInt16();if(ot>0){this.attachmentNames=[];for(let t=0;t<ot;t++)this.attachmentNames.push(h.getUTFString())}var ut,pt,_t=h.getInt16();for(let t=0;t<_t;t++)(ut=new BoneSlot).name=h.readUTFString(),ut.parent=h.readUTFString(),ut.attachmentName=h.readUTFString(),ut.srcDisplayIndex=ut.displayIndex=h.getInt16(),ut.templet=this,this.boneSlotDic[ut.name]=ut,null==(pt=this.bindBoneBoneSlotDic[ut.parent])&&(this.bindBoneBoneSlotDic[ut.parent]=pt=[]),pt.push(ut),this.boneSlotArray.push(ut);var dt,ct,mt,xt,yt,gt,ft,Dt,Mt,At,vt=h.readUTFString().split("\n"),It=0,St=h.getUint8();for(let t=0;t<St;t++){(dt=new SkinData).name=vt[It++],xt=h.getUint8();for(let t=0;t<xt;t++){(ct=new SlotData).name=vt[It++],ut=this.boneSlotDic[ct.name],yt=h.getUint8();for(let t=0;t<yt;t++){if(mt=new SkinSlotDisplayData,this.skinSlotDisplayDataArr.push(mt),mt.name=vt[It++],mt.attachmentName=vt[It++],mt.transform=new Transform,mt.transform.scX=h.getFloat32(),mt.transform.skX=h.getFloat32(),mt.transform.skY=h.getFloat32(),mt.transform.scY=h.getFloat32(),mt.transform.x=h.getFloat32(),mt.transform.y=h.getFloat32(),ct.displayArr.push(mt),mt.width=h.getFloat32(),mt.height=h.getFloat32(),mt.type=h.getUint8(),mt.verLen=h.getUint16(),(C=h.getUint16())>0){mt.bones=[];for(let t=0;t<C;t++){let t=h.getUint16();mt.bones.push(t)}}if((gt=h.getUint16())>0){mt.uvs=[];for(let t=0;t<gt;t++)mt.uvs.push(h.getFloat32())}if((ft=h.getUint16())>0){mt.weights=[];for(let t=0;t<ft;t++)mt.weights.push(h.getFloat32())}if((Dt=h.getUint16())>0){mt.triangles=[];for(let t=0;t<Dt;t++)mt.triangles.push(h.getUint16())}if((Mt=h.getUint16())>0){mt.vertices=[];for(let t=0;t<Mt;t++)mt.vertices.push(h.getFloat32())}if((At=h.getUint16())>0){mt.lengths=[];for(let t=0;t<At;t++)mt.lengths.push(h.getFloat32())}}dt.slotArr.push(ct)}this.skinDic[dt.name]=dt,this.skinDataArray.push(dt)}1==h.getUint8()?(this.yReverseMatrix=new e.Matrix(1,0,0,-1,0,0),T&&T.setTempMatrix(this.yReverseMatrix)):T&&T.setTempMatrix(new e.Matrix),this.showSkinByIndex(this.boneSlotDic,0)}getTexture(t){let e=this.subTextureDic[t];return e||(e=this.subTextureDic[t.substring(0,t.length-1)]),null==e?this._mainTexture:e}showSkinByIndex(t,e,i=!0){if(e<0&&e>=this.skinDataArray.length)return!1;var a,r,s,n,h=this.skinDataArray[e];if(h){for(a=0,r=h.slotArr.length;a<r;a++)(n=h.slotArr[a])&&(s=t[n.name])&&(s.showSlotData(n,i),i&&"undefined"!=s.attachmentName&&"null"!=s.attachmentName?s.showDisplayByName(s.attachmentName):s.showDisplayByIndex(s.displayIndex));return!0}return!1}getSkinIndexByName(t){for(let e=0,i=this.skinDataArray.length;e<i;e++){if(this.skinDataArray[e].name==t)return e}return-1}getGrahicsDataWithCache(t,e){return this._graphicsCache[t]&&this._graphicsCache[t][e]?this._graphicsCache[t][e]:null}setGrahicsDataWithCache(t,e,i){this._graphicsCache[t][e]=i}deleteAniData(t){if(this._anis[t]){var e=this._anis[t];e.bone3DMap=null,e.nodes=null}}_disposeResource(){var t;for(let e in this.subTextureDic)null===(t=this.subTextureDic[e])||void 0===t||t.destroy();this._mainTexture._removeReference();for(var e=0,i=this.skinSlotDisplayDataArr.length;e<i;e++)this.skinSlotDisplayDataArr[e].destory();this.skinSlotDisplayDataArr.length=0}getAniNameByIndex(t){var e=this.getAnimation(t);return e?e.name:null}}IAniLib.Templet=Templet;e.Loader.registerLoader(["sk"],class{load(t){return Promise.all([t.loader.fetch(t.url,"arraybuffer",t.progress.createCallback(),t.options),t.loader.load(e.Utils.replaceFileExtension(t.url,"png"),null,t.progress.createCallback())]).then((e=>{if(!e[0]||!e[1])return null;let i=new Templet;return i._parse(e[1],t.url,e[0]),i}))}}),(0,e.ClassUtils.regClass)("Skeleton",Skeleton);class MovieClip extends e.Sprite{constructor(t=null){super(),this._start=0,this._Pos=0,this._ended=!0,this._loadedImage={},this._endFrame=-1,this.interval=30,this._ids={},this._idOfSprite=[],this._reset(),this._playing=!1,this._parentMovieClip=t,t?(this._isRoot=!1,this._movieClipList=t._movieClipList,this._movieClipList.push(this)):(this._movieClipList=[this],this._isRoot=!0,this._setBitUp(e.NodeFlags.DISPLAY))}destroy(t=!0){this._clear(),super.destroy(t)}_setDisplay(t){super._setDisplay(t),this._isRoot&&this._onDisplay(t)}_onDisplay(t){t?this.timer.loop(this.interval,this,this.updates,null,!0):this.timer.clear(this,this.updates)}updates(){var t,e;if(!this._parentMovieClip)for(e=this._movieClipList.length,t=0;t<e;t++)this._movieClipList[t]&&this._movieClipList[t]._update()}get index(){return this._playIndex}set index(t){this._playIndex=t,this._data&&this._displayFrame(this._playIndex),this._labels&&this._labels[t]&&this.event(e.Event.LABEL,this._labels[t])}addLabel(t,e){this._labels||(this._labels={}),this._labels[e]=t}removeLabel(t){if(t){if(!this._labels)for(var e in this._labels)if(this._labels[e]===t){delete this._labels[e];break}}else this._labels=null}get count(){return this._count}get playing(){return this._playing}_update(){if(this._data&&this._playing){if(this._playIndex++,this._playIndex>=this._count){if(!this.loop)return this._playIndex--,void this.stop();this._playIndex=0}if(this._parseFrame(this._playIndex),this._labels&&this._labels[this._playIndex]&&this.event(e.Event.LABEL,this._labels[this._playIndex]),-1!=this._endFrame&&this._endFrame==this._playIndex){if(this._endFrame=-1,null!=this._completeHandler){var t=this._completeHandler;this._completeHandler=null,t.run()}this.stop()}}}stop(){this._playing=!1}gotoAndStop(t){this.index=t,this.stop()}_clear(){if(this.stop(),this._idOfSprite.length=0,!this._parentMovieClip){var t,i;for(this.timer.clear(this,this.updates),i=this._movieClipList.length,t=0;t<i;t++)this._movieClipList[t]!=this&&this._movieClipList[t]._clear();this._movieClipList.length=0}var a;for(a in this._loadedImage){let t=this._loadedImage[a];t&&(e.ILaya.Loader.clearRes(a,t),this._loadedImage[a]=!1)}this.removeChildren(),this.graphics=null,this._parentMovieClip=null}play(t=0,e=!0){this.loop=e,this._playing=!0,this._data&&this._displayFrame(t)}_displayFrame(t=-1){-1!=t&&(this._curIndex>t&&this._reset(),this._parseFrame(t))}_reset(t=!0){t&&1!=this._curIndex&&this.removeChildren(),this._preIndex=this._curIndex=-1,this._Pos=this._start}_parseFrame(t){var i,a,r,s,n,h,l=!1,o=this._idOfSprite,u=this._data;for(this._ended&&this._reset(),u.pos=this._Pos,this._ended=!1,this._playIndex=t,this._curIndex>t&&t<this._preIndex&&(this._reset(!0),u.pos=this._Pos);this._curIndex<=t&&!this._ended;)switch(u.getUint16()){case 12:if(r=u.getUint16(),s=this._ids[u.getUint16()],this._Pos=u.pos,u.pos=s,0==(n=u.getUint8())){var p=u.getUint16();if(!(a=o[r])){a=o[r]=new e.Sprite;var _=new e.Sprite;_.loadImage(this.basePath+p+".png"),this._loadedImage[this.basePath+p+".png"]=!0,a.addChild(_),_.size(u.getFloat32(),u.getFloat32());var d=u._getMatrix();_.transform=d}a.alpha=1}else 1==n&&((i=o[r])||(o[r]=i=new MovieClip(this),i.interval=this.interval,i._ids=this._ids,i.basePath=this.basePath,i._setData(u,s),i._initState(),i.play(0)),i.alpha=1);u.pos=this._Pos;break;case 3:var c=o[u.getUint16()];c&&(this.addChild(c),c.zOrder=u.getUint16(),l=!0);break;case 4:(c=o[u.getUint16()])&&c.removeSelf();break;case 5:o[u.getUint16()][MovieClip._ValueList[u.getUint16()]]=u.getFloat32();break;case 6:o[u.getUint16()].visible=u.getUint8()>0;break;case 7:var m=(a=o[u.getUint16()]).transform||e.Matrix.create();m.setTo(u.getFloat32(),u.getFloat32(),u.getFloat32(),u.getFloat32(),u.getFloat32(),u.getFloat32()),a.transform=m;break;case 8:o[u.getUint16()].setPos(u.getFloat32(),u.getFloat32());break;case 9:o[u.getUint16()].setSize(u.getFloat32(),u.getFloat32());break;case 10:o[u.getUint16()].alpha=u.getFloat32();break;case 11:o[u.getUint16()].setScale(u.getFloat32(),u.getFloat32());break;case 98:h=u.getString(),this.event(h),"stop"==h&&this.stop();break;case 99:this._curIndex=u.getUint16(),l&&this.updateZOrder();break;case 100:this._count=this._curIndex+1,this._ended=!0,this._playing&&(this.event(e.Event.FRAME),this.event(e.Event.END),this.event(e.Event.COMPLETE)),this._reset(!1)}this._playing&&!this._ended&&this.event(e.Event.FRAME),this._Pos=u.pos}_setData(t,e){this._data=t,this._start=e+3}get source(){return this._source}set source(t){this.load(t)}load(t,i=!1,a=null){this.stop(),this._clear(),this._movieClipList=[this],this._source=t,i&&(a=a||t.split(".swf")[0]+".json"),e.ILaya.loader.load(a?[t,a]:[t],e.Loader.BUFFER).then((a=>{var r;if(!a)return void this.event(e.Event.ERROR,"file not find");let s=i?null===(r=a[1])||void 0===r?void 0:r.dir:t.split(".swf")[0]+"/image/";this._initData(new e.Byte(a[0].data),s)}))}_initState(){this._reset(),this._ended=!1;var t=this._playing;for(this._playing=!1,this._curIndex=0;!this._ended;)this._parseFrame(++this._curIndex);this._playing=t}_initData(t,i){this.basePath=i;let a=t.getUint16();for(let e=0;e<a;e++)this._ids[t.getInt16()]=t.getInt32();this.interval=1e3/t.getUint16(),this._setData(t,this._ids[32767]),this._initState(),this.play(0),this.event(e.Event.READY),this._parentMovieClip||this.timer.loop(this.interval,this,this.updates,null,!0)}playTo(t,e,i=null){this._completeHandler=i,this._endFrame=e,this.play(t,!1)}}MovieClip._ValueList=["x","y","width","height","scaleX","scaleY","rotation","alpha"],t.AnimationContent=AnimationContent,t.AnimationNodeContent=AnimationNodeContent,t.AnimationParser01=AnimationParser01,t.AnimationParser02=AnimationParser02,t.AnimationPlayer=AnimationPlayer,t.AnimationState=AnimationState,t.AnimationTemplet=AnimationTemplet,t.BezierLerp=BezierLerp,t.Bone=Bone,t.BoneSlot=BoneSlot,t.DeformAniData=DeformAniData,t.DeformSlotData=DeformSlotData,t.DeformSlotDisplayData=DeformSlotDisplayData,t.DrawOrderData=DrawOrderData,t.EventData=EventData,t.GraphicsAni=GraphicsAni,t.IAniLib=IAniLib,t.IkConstraint=IkConstraint,t.IkConstraintData=IkConstraintData,t.KeyFramesContent=KeyFramesContent,t.MeshData=MeshData,t.MovieClip=MovieClip,t.PathConstraint=PathConstraint,t.PathConstraintData=PathConstraintData,t.Skeleton=Skeleton,t.SkinData=SkinData,t.SkinMeshForGraphic=SkinMeshForGraphic,t.SkinSlotDisplayData=SkinSlotDisplayData,t.SlotData=SlotData,t.Templet=Templet,t.TfConstraint=TfConstraint,t.TfConstraintData=TfConstraintData,t.Transform=Transform,t.UVTools=UVTools}(window.Laya=window.Laya||{},Laya);
//# sourceMappingURL=laya.ani.js.map